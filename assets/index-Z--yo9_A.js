(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Vc=!1;var tg=Array.isArray,k0=Array.prototype.indexOf,xl=Array.from,rg=Object.defineProperty,qs=Object.getOwnPropertyDescriptor,ng=Object.getOwnPropertyDescriptors,C0=Object.prototype,T0=Array.prototype,Gu=Object.getPrototypeOf,Pf=Object.isExtensible;function P0(r){return typeof r=="function"}const Kt=()=>{};function D0(r){return r()}function Sa(r){for(var e=0;e<r.length;e++)r[e]()}function sg(){var r,e,t=new Promise((n,s)=>{r=n,e=s});return{promise:t,resolve:r,reject:e}}const _t=2,Ea=4,Ao=8,ig=1<<24,Mr=16,dn=32,xs=64,Yu=128,dr=512,Pt=1024,Mt=2048,fn=4096,er=8192,en=16384,Al=32768,Mn=65536,Df=1<<17,og=1<<18,bi=1<<19,ag=1<<20,Zr=1<<25,ps=32768,Kc=1<<21,Xu=1<<22,Cn=1<<23,os=Symbol("$state"),L0=Symbol("legacy props"),R0=Symbol(""),Os=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function B0(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function N0(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function M0(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function O0(r){throw new Error("https://svelte.dev/e/effect_orphan")}function $0(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function F0(r){throw new Error("https://svelte.dev/e/props_invalid_value")}function U0(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function V0(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function K0(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function q0(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const H0=1,z0=2,lg=4,W0=8,G0=16,Y0=1,X0=2,Z0=4,j0=8,Q0=16,J0=1,e_=2,t_=4,r_=1,n_=2,yt=Symbol(),s_="http://www.w3.org/1999/xhtml";function i_(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function cg(r){return r===this.v}function ug(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function dg(r){return!ug(r,this.v)}let Io=!1,o_=!1;function a_(){Io=!0}let ut=null;function js(r){ut=r}function ft(r,e=!1,t){ut={p:ut,i:!1,c:null,e:null,s:r,x:null,l:Io&&!e?{s:null,u:null,$:[]}:null}}function ht(r){var e=ut,t=e.e;if(t!==null){e.e=null;for(var n of t)Tg(n)}return r!==void 0&&(e.x=r),e.i=!0,ut=e.p,r??{}}function vi(){return!Io||ut!==null&&ut.l===null}let Qn=[];function fg(){var r=Qn;Qn=[],Sa(r)}function As(r){if(Qn.length===0&&!Wi){var e=Qn;queueMicrotask(()=>{e===Qn&&fg()})}Qn.push(r)}function l_(){for(;Qn.length>0;)fg()}function hg(r){var e=_e;if(e===null)return me.f|=Cn,r;if((e.f&Al)===0){if((e.f&Yu)===0)throw r;e.b.error(r)}else Qs(r,e)}function Qs(r,e){for(;e!==null;){if((e.f&Yu)!==0)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r}const c_=-7169;function dt(r,e){r.f=r.f&c_|e}function Zu(r){(r.f&dr)!==0||r.deps===null?dt(r,Pt):dt(r,fn)}function pg(r){if(r!==null)for(const e of r)(e.f&_t)===0||(e.f&ps)===0||(e.f^=ps,pg(e.deps))}function gg(r,e,t){(r.f&Mt)!==0?e.add(r):(r.f&fn)!==0&&t.add(r),pg(r.deps),dt(r,Pt)}const Go=new Set;let We=null,vr=null,or=[],Il=null,qc=!1,Wi=!1;class Pr{committed=!1;current=new Map;previous=new Map;#e=new Set;#r=new Set;#t=0;#n=0;#i=null;#a=new Set;#s=new Set;skipped_effects=new Set;is_fork=!1;is_deferred(){return this.is_fork||this.#n>0}process(e){or=[],this.apply();var t=[],n=[];for(const s of e)this.#h(s,t,n);this.is_fork||this.#d(),this.is_deferred()?(this.#p(n),this.#p(t)):(We=null,Lf(n),Lf(t),this.#i?.resolve()),vr=null}#h(e,t,n){e.f^=Pt;for(var s=e.first,i=null;s!==null;){var o=s.f,l=(o&(dn|xs))!==0,c=l&&(o&Pt)!==0,d=c||(o&er)!==0||this.skipped_effects.has(s);if(!d&&s.fn!==null){l?s.f^=Pt:i!==null&&(o&(Ea|Ao|ig))!==0?i.b.defer_effect(s):(o&Ea)!==0?t.push(s):Po(s)&&((o&Mr)!==0&&this.#a.add(s),so(s));var f=s.first;if(f!==null){s=f;continue}}var a=s.parent;for(s=s.next;s===null&&a!==null;)a===i&&(i=null),s=a.next,a=a.parent}}#p(e){for(var t=0;t<e.length;t+=1)gg(e[t],this.#a,this.#s)}capture(e,t){t!==yt&&!this.previous.has(e)&&this.previous.set(e,t),(e.f&Cn)===0&&(this.current.set(e,e.v),vr?.set(e,e.v))}activate(){We=this,this.apply()}deactivate(){We===this&&(We=null,vr=null)}flush(){if(this.activate(),or.length>0){if(mg(),We!==null&&We!==this)return}else this.#t===0&&this.process([]);this.deactivate()}discard(){for(const e of this.#r)e(this);this.#r.clear()}#d(){if(this.#n===0){for(const e of this.#e)e();this.#e.clear()}this.#t===0&&this.#g()}#g(){if(Go.size>1){this.previous.clear();var e=vr,t=!0;for(const s of Go){if(s===this){t=!1;continue}const i=[];for(const[l,c]of this.current){if(s.current.has(l))if(t&&c!==s.current.get(l))s.current.set(l,c);else continue;i.push(l)}if(i.length===0)continue;const o=[...s.current.keys()].filter(l=>!this.current.has(l));if(o.length>0){var n=or;or=[];const l=new Set,c=new Map;for(const d of i)yg(d,o,l,c);if(or.length>0){We=s,s.apply();for(const d of or)s.#h(d,[],[]);s.deactivate()}or=n}}We=null,vr=e}this.committed=!0,Go.delete(this)}increment(e){this.#t+=1,e&&(this.#n+=1)}decrement(e){this.#t-=1,e&&(this.#n-=1),this.revive()}revive(){for(const e of this.#a)this.#s.delete(e),dt(e,Mt),sn(e);for(const e of this.#s)dt(e,fn),sn(e);this.flush()}oncommit(e){this.#e.add(e)}ondiscard(e){this.#r.add(e)}settled(){return(this.#i??=sg()).promise}static ensure(){if(We===null){const e=We=new Pr;Go.add(We),Wi||Pr.enqueue(()=>{We===e&&e.flush()})}return We}static enqueue(e){As(e)}apply(){}}function u_(r){var e=Wi;Wi=!0;try{for(var t;;){if(l_(),or.length===0&&(We?.flush(),or.length===0))return Il=null,t;mg()}}finally{Wi=e}}function mg(){var r=ls;qc=!0;var e=null;try{var t=0;for(Ia(!0);or.length>0;){var n=Pr.ensure();if(t++>1e3){var s,i;d_()}n.process(or),Tn.clear()}}finally{qc=!1,Ia(r),Il=null}}function d_(){try{$0()}catch(r){Qs(r,Il)}}let Hr=null;function Lf(r){var e=r.length;if(e!==0){for(var t=0;t<e;){var n=r[t++];if((n.f&(en|er))===0&&Po(n)&&(Hr=new Set,so(n),n.deps===null&&n.first===null&&n.nodes===null&&(n.teardown===null&&n.ac===null?Lg(n):n.fn=null),Hr?.size>0)){Tn.clear();for(const s of Hr){if((s.f&(en|er))!==0)continue;const i=[s];let o=s.parent;for(;o!==null;)Hr.has(o)&&(Hr.delete(o),i.push(o)),o=o.parent;for(let l=i.length-1;l>=0;l--){const c=i[l];(c.f&(en|er))===0&&so(c)}}Hr.clear()}}Hr=null}}function yg(r,e,t,n){if(!t.has(r)&&(t.add(r),r.reactions!==null))for(const s of r.reactions){const i=s.f;(i&_t)!==0?yg(s,e,t,n):(i&(Xu|Mr))!==0&&(i&Mt)===0&&bg(s,e,n)&&(dt(s,Mt),sn(s))}}function bg(r,e,t){const n=t.get(r);if(n!==void 0)return n;if(r.deps!==null)for(const s of r.deps){if(e.includes(s))return!0;if((s.f&_t)!==0&&bg(s,e,t))return t.set(s,!0),!0}return t.set(r,!1),!1}function sn(r){for(var e=Il=r;e.parent!==null;){e=e.parent;var t=e.f;if(qc&&e===_e&&(t&Mr)!==0&&(t&og)===0)return;if((t&(xs|dn))!==0){if((t&Pt)===0)return;e.f^=Pt}}or.push(e)}function f_(r){let e=0,t=gs(0),n;return()=>{Qu()&&(b(t),ed(()=>(e===0&&(n=ct(()=>r(()=>Gi(t)))),e+=1,()=>{As(()=>{e-=1,e===0&&(n?.(),n=void 0,Gi(t))})})))}}var h_=Mn|bi|Yu;function p_(r,e,t){new g_(r,e,t)}class g_{parent;is_pending=!1;#e;#r=null;#t;#n;#i;#a=null;#s=null;#h=null;#p=null;#d=null;#g=0;#f=0;#l=!1;#c=new Set;#o=new Set;#m=null;#u=f_(()=>(this.#m=gs(this.#g),()=>{this.#m=null}));constructor(e,t,n){this.#e=e,this.#t=t,this.#n=n,this.parent=_e.b,this.is_pending=!!this.#t.pending,this.#i=To(()=>{_e.b=this;{var s=this.#E();try{this.#a=ar(()=>n(s))}catch(i){this.error(i)}this.#f>0?this.#v():this.is_pending=!1}return()=>{this.#d?.remove()}},h_)}#_(){try{this.#a=ar(()=>this.#n(this.#e))}catch(e){this.error(e)}}#b(){const e=this.#t.pending;e&&(this.#s=ar(()=>e(this.#e)),Pr.enqueue(()=>{var t=this.#E();this.#a=this.#y(()=>(Pr.ensure(),ar(()=>this.#n(t)))),this.#f>0?this.#v():(as(this.#s,()=>{this.#s=null}),this.is_pending=!1)}))}#E(){var e=this.#e;return this.is_pending&&(this.#d=Pn(),this.#e.before(this.#d),e=this.#d),e}defer_effect(e){gg(e,this.#c,this.#o)}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!this.#t.pending}#y(e){var t=_e,n=me,s=ut;Br(this.#i),qt(this.#i),js(this.#i.ctx);try{return e()}catch(i){return hg(i),null}finally{Br(t),qt(n),js(s)}}#v(){const e=this.#t.pending;this.#a!==null&&(this.#p=document.createDocumentFragment(),this.#p.append(this.#d),Ng(this.#a,this.#p)),this.#s===null&&(this.#s=ar(()=>e(this.#e)))}#x(e){if(!this.has_pending_snippet()){this.parent&&this.parent.#x(e);return}if(this.#f+=e,this.#f===0){this.is_pending=!1;for(const t of this.#c)dt(t,Mt),sn(t);for(const t of this.#o)dt(t,fn),sn(t);this.#c.clear(),this.#o.clear(),this.#s&&as(this.#s,()=>{this.#s=null}),this.#p&&(this.#e.before(this.#p),this.#p=null)}}update_pending_count(e){this.#x(e),this.#g+=e,this.#m&&Js(this.#m,this.#g)}get_effect_pending(){return this.#u(),b(this.#m)}error(e){var t=this.#t.onerror;let n=this.#t.failed;if(this.#l||!t&&!n)throw e;this.#a&&(Wt(this.#a),this.#a=null),this.#s&&(Wt(this.#s),this.#s=null),this.#h&&(Wt(this.#h),this.#h=null);var s=!1,i=!1;const o=()=>{if(s){i_();return}s=!0,i&&q0(),Pr.ensure(),this.#g=0,this.#h!==null&&as(this.#h,()=>{this.#h=null}),this.is_pending=this.has_pending_snippet(),this.#a=this.#y(()=>(this.#l=!1,ar(()=>this.#n(this.#e)))),this.#f>0?this.#v():this.is_pending=!1};var l=me;try{qt(null),i=!0,t?.(e,o),i=!1}catch(c){Qs(c,this.#i&&this.#i.parent)}finally{qt(l)}n&&As(()=>{this.#h=this.#y(()=>{Pr.ensure(),this.#l=!0;try{return ar(()=>{n(this.#e,()=>e,()=>o)})}catch(c){return Qs(c,this.#i.parent),null}finally{this.#l=!1}})})}}function m_(r,e,t,n){const s=vi()?ko:ro;if(t.length===0&&r.length===0){n(e.map(s));return}var i=We,o=_e,l=y_();function c(){Promise.all(t.map(d=>b_(d))).then(d=>{l();try{n([...e.map(s),...d])}catch(f){(o.f&en)===0&&Qs(f,o)}i?.deactivate(),xa()}).catch(d=>{Qs(d,o)})}r.length>0?Promise.all(r).then(()=>{l();try{return c()}finally{i?.deactivate(),xa()}}):c()}function y_(){var r=_e,e=me,t=ut,n=We;return function(i=!0){Br(r),qt(e),js(t),i&&n?.activate()}}function xa(){Br(null),qt(null),js(null)}function ko(r){var e=_t|Mt,t=me!==null&&(me.f&_t)!==0?me:null;return _e!==null&&(_e.f|=bi),{ctx:ut,deps:null,effects:null,equals:cg,f:e,fn:r,reactions:null,rv:0,v:yt,wv:0,parent:t??_e,ac:null}}function b_(r,e,t){let n=_e;n===null&&B0();var s=n.b,i=void 0,o=gs(yt),l=!me,c=new Map;return C_(()=>{var d=sg();i=d.promise;try{Promise.resolve(r()).then(d.resolve,d.reject).then(()=>{f===We&&f.committed&&f.deactivate(),xa()})}catch(h){d.reject(h),xa()}var f=We;if(l){var a=s.is_rendered();s.update_pending_count(1),f.increment(a),c.get(f)?.reject(Os),c.delete(f),c.set(f,d)}const u=(h,p=void 0)=>{if(f.activate(),p)p!==Os&&(o.f|=Cn,Js(o,p));else{(o.f&Cn)!==0&&(o.f^=Cn),Js(o,h);for(const[y,g]of c){if(c.delete(y),y===f)break;g.reject(Os)}}l&&(s.update_pending_count(-1),f.decrement(a))};d.promise.then(u,h=>u(null,h||"unknown"))}),Ju(()=>{for(const d of c.values())d.reject(Os)}),new Promise(d=>{function f(a){function u(){a===i?d(o):f(i)}a.then(u,u)}f(i)})}function ie(r){const e=ko(r);return Mg(e),e}function ro(r){const e=ko(r);return e.equals=dg,e}function vg(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)Wt(e[t])}}function v_(r){for(var e=r.parent;e!==null;){if((e.f&_t)===0)return(e.f&en)===0?e:null;e=e.parent}return null}function ju(r){var e,t=_e;Br(v_(r));try{r.f&=~ps,vg(r),e=Ug(r)}finally{Br(t)}return e}function wg(r){var e=ju(r);if(!r.equals(e)&&(r.wv=$g(),(!We?.is_fork||r.deps===null)&&(r.v=e,r.deps===null))){dt(r,Pt);return}On||(vr!==null?(Qu()||We?.is_fork)&&vr.set(r,e):Zu(r))}let Hc=new Set;const Tn=new Map;let _g=!1;function gs(r,e){var t={f:0,v:r,reactions:null,equals:cg,rv:0,wv:0};return t}function le(r,e){const t=gs(r);return Mg(t),t}function Sg(r,e=!1,t=!0){const n=gs(r);return e||(n.equals=dg),Io&&t&&ut!==null&&ut.l!==null&&(ut.l.s??=[]).push(n),n}function X(r,e,t=!1){me!==null&&(!wr||(me.f&Df)!==0)&&vi()&&(me.f&(_t|Mr|Xu|Df))!==0&&!tn?.includes(r)&&K0();let n=t?jr(e):e;return Js(r,n)}function Js(r,e){if(!r.equals(e)){var t=r.v;On?Tn.set(r,e):Tn.set(r,t),r.v=e;var n=Pr.ensure();if(n.capture(r,t),(r.f&_t)!==0){const s=r;(r.f&Mt)!==0&&ju(s),Zu(s)}r.wv=$g(),Eg(r,Mt),vi()&&_e!==null&&(_e.f&Pt)!==0&&(_e.f&(dn|xs))===0&&(sr===null?D_([r]):sr.push(r)),!n.is_fork&&Hc.size>0&&!_g&&w_()}return e}function w_(){_g=!1;var r=ls;Ia(!0);const e=Array.from(Hc);try{for(const t of e)(t.f&Pt)!==0&&dt(t,fn),Po(t)&&so(t)}finally{Ia(r)}Hc.clear()}function Gi(r){X(r,r.v+1)}function Eg(r,e){var t=r.reactions;if(t!==null)for(var n=vi(),s=t.length,i=0;i<s;i++){var o=t[i],l=o.f;if(!(!n&&o===_e)){var c=(l&Mt)===0;if(c&&dt(o,e),(l&_t)!==0){var d=o;vr?.delete(d),(l&ps)===0&&(l&dr&&(o.f|=ps),Eg(d,fn))}else c&&((l&Mr)!==0&&Hr!==null&&Hr.add(o),sn(o))}}}function jr(r){if(typeof r!="object"||r===null||os in r)return r;const e=Gu(r);if(e!==C0&&e!==T0)return r;var t=new Map,n=tg(r),s=le(0),i=cs,o=l=>{if(cs===i)return l();var c=me,d=cs;qt(null),Nf(i);var f=l();return qt(c),Nf(d),f};return n&&t.set("length",le(r.length)),new Proxy(r,{defineProperty(l,c,d){(!("value"in d)||d.configurable===!1||d.enumerable===!1||d.writable===!1)&&U0();var f=t.get(c);return f===void 0?f=o(()=>{var a=le(d.value);return t.set(c,a),a}):X(f,d.value,!0),!0},deleteProperty(l,c){var d=t.get(c);if(d===void 0){if(c in l){const f=o(()=>le(yt));t.set(c,f),Gi(s)}}else X(d,yt),Gi(s);return!0},get(l,c,d){if(c===os)return r;var f=t.get(c),a=c in l;if(f===void 0&&(!a||qs(l,c)?.writable)&&(f=o(()=>{var h=jr(a?l[c]:yt),p=le(h);return p}),t.set(c,f)),f!==void 0){var u=b(f);return u===yt?void 0:u}return Reflect.get(l,c,d)},getOwnPropertyDescriptor(l,c){var d=Reflect.getOwnPropertyDescriptor(l,c);if(d&&"value"in d){var f=t.get(c);f&&(d.value=b(f))}else if(d===void 0){var a=t.get(c),u=a?.v;if(a!==void 0&&u!==yt)return{enumerable:!0,configurable:!0,value:u,writable:!0}}return d},has(l,c){if(c===os)return!0;var d=t.get(c),f=d!==void 0&&d.v!==yt||Reflect.has(l,c);if(d!==void 0||_e!==null&&(!f||qs(l,c)?.writable)){d===void 0&&(d=o(()=>{var u=f?jr(l[c]):yt,h=le(u);return h}),t.set(c,d));var a=b(d);if(a===yt)return!1}return f},set(l,c,d,f){var a=t.get(c),u=c in l;if(n&&c==="length")for(var h=d;h<a.v;h+=1){var p=t.get(h+"");p!==void 0?X(p,yt):h in l&&(p=o(()=>le(yt)),t.set(h+"",p))}if(a===void 0)(!u||qs(l,c)?.writable)&&(a=o(()=>le(void 0)),X(a,jr(d)),t.set(c,a));else{u=a.v!==yt;var y=o(()=>jr(d));X(a,y)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g?.set&&g.set.call(f,d),!u){if(n&&typeof c=="string"){var m=t.get("length"),w=Number(c);Number.isInteger(w)&&w>=m.v&&X(m,w+1)}Gi(s)}return!0},ownKeys(l){b(s);var c=Reflect.ownKeys(l).filter(a=>{var u=t.get(a);return u===void 0||u.v!==yt});for(var[d,f]of t)f.v!==yt&&!(d in l)&&c.push(d);return c},setPrototypeOf(){V0()}})}var Zn,xg,Ag,Ig;function __(){if(Zn===void 0){Zn=window,xg=/Firefox/.test(navigator.userAgent);var r=Element.prototype,e=Node.prototype,t=Text.prototype;Ag=qs(e,"firstChild").get,Ig=qs(e,"nextSibling").get,Pf(r)&&(r.__click=void 0,r.__className=void 0,r.__attributes=null,r.__style=void 0,r.__e=void 0),Pf(t)&&(t.__t=void 0)}}function Pn(r=""){return document.createTextNode(r)}function Aa(r){return Ag.call(r)}function Co(r){return Ig.call(r)}function O(r,e){return Aa(r)}function rt(r,e=!1){{var t=Aa(r);return t instanceof Comment&&t.data===""?Co(t):t}}function z(r,e=1,t=!1){let n=r;for(;e--;)n=Co(n);return n}function S_(r){r.textContent=""}function kg(){return!1}let Rf=!1;function E_(){Rf||(Rf=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function wi(r){var e=me,t=_e;qt(null),Br(null);try{return r()}finally{qt(e),Br(t)}}function x_(r,e,t,n=t){r.addEventListener(e,()=>wi(t));const s=r.__on_r;s?r.__on_r=()=>{s(),n(!0)}:r.__on_r=()=>n(!0),E_()}function Cg(r){_e===null&&(me===null&&O0(),M0()),On&&N0()}function A_(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function Or(r,e,t){var n=_e;n!==null&&(n.f&er)!==0&&(r|=er);var s={ctx:ut,deps:null,nodes:null,f:r|Mt|dr,first:null,fn:e,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{so(s),s.f|=Al}catch(l){throw Wt(s),l}else e!==null&&sn(s);var i=s;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&(i.f&bi)===0&&(i=i.first,(r&Mr)!==0&&(r&Mn)!==0&&i!==null&&(i.f|=Mn)),i!==null&&(i.parent=n,n!==null&&A_(i,n),me!==null&&(me.f&_t)!==0&&(r&xs)===0)){var o=me;(o.effects??=[]).push(i)}return s}function Qu(){return me!==null&&!wr}function Ju(r){const e=Or(Ao,null,!1);return dt(e,Pt),e.teardown=r,e}function st(r){Cg();var e=_e.f,t=!me&&(e&dn)!==0&&(e&Al)===0;if(t){var n=ut;(n.e??=[]).push(r)}else return Tg(r)}function Tg(r){return Or(Ea|ag,r,!1)}function I_(r){return Cg(),Or(Ao|ag,r,!0)}function k_(r){Pr.ensure();const e=Or(xs|bi,r,!0);return(t={})=>new Promise(n=>{t.outro?as(e,()=>{Wt(e),n(void 0)}):(Wt(e),n(void 0))})}function kl(r){return Or(Ea,r,!1)}function C_(r){return Or(Xu|bi,r,!0)}function ed(r,e=0){return Or(Ao|e,r,!0)}function Pe(r,e=[],t=[],n=[]){m_(n,e,t,s=>{Or(Ao,()=>r(...s.map(b)),!0)})}function To(r,e=0){var t=Or(Mr|e,r,!0);return t}function ar(r){return Or(dn|bi,r,!0)}function Pg(r){var e=r.teardown;if(e!==null){const t=On,n=me;Bf(!0),qt(null);try{e.call(null)}finally{Bf(t),qt(n)}}}function Dg(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){const s=t.ac;s!==null&&wi(()=>{s.abort(Os)});var n=t.next;(t.f&xs)!==0?t.parent=null:Wt(t,e),t=n}}function T_(r){for(var e=r.first;e!==null;){var t=e.next;(e.f&dn)===0&&Wt(e),e=t}}function Wt(r,e=!0){var t=!1;(e||(r.f&og)!==0)&&r.nodes!==null&&r.nodes.end!==null&&(P_(r.nodes.start,r.nodes.end),t=!0),Dg(r,e&&!t),ka(r,0),dt(r,en);var n=r.nodes&&r.nodes.t;if(n!==null)for(const i of n)i.stop();Pg(r);var s=r.parent;s!==null&&s.first!==null&&Lg(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes=r.ac=null}function P_(r,e){for(;r!==null;){var t=r===e?null:Co(r);r.remove(),r=t}}function Lg(r){var e=r.parent,t=r.prev,n=r.next;t!==null&&(t.next=n),n!==null&&(n.prev=t),e!==null&&(e.first===r&&(e.first=n),e.last===r&&(e.last=t))}function as(r,e,t=!0){var n=[];Rg(r,n,!0);var s=()=>{t&&Wt(r),e&&e()},i=n.length;if(i>0){var o=()=>--i||s();for(var l of n)l.out(o)}else s()}function Rg(r,e,t){if((r.f&er)===0){r.f^=er;var n=r.nodes&&r.nodes.t;if(n!==null)for(const l of n)(l.is_global||t)&&e.push(l);for(var s=r.first;s!==null;){var i=s.next,o=(s.f&Mn)!==0||(s.f&dn)!==0&&(r.f&Mr)!==0;Rg(s,e,o?t:!1),s=i}}}function td(r){Bg(r,!0)}function Bg(r,e){if((r.f&er)!==0){r.f^=er,(r.f&Pt)===0&&(dt(r,Mt),sn(r));for(var t=r.first;t!==null;){var n=t.next,s=(t.f&Mn)!==0||(t.f&dn)!==0;Bg(t,s?e:!1),t=n}var i=r.nodes&&r.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Ng(r,e){if(r.nodes)for(var t=r.nodes.start,n=r.nodes.end;t!==null;){var s=t===n?null:Co(t);e.append(t),t=s}}let ls=!1;function Ia(r){ls=r}let On=!1;function Bf(r){On=r}let me=null,wr=!1;function qt(r){me=r}let _e=null;function Br(r){_e=r}let tn=null;function Mg(r){me!==null&&(tn===null?tn=[r]:tn.push(r))}let Rt=null,Yt=0,sr=null;function D_(r){sr=r}let Og=1,no=0,cs=no;function Nf(r){cs=r}function $g(){return++Og}function Po(r){var e=r.f;if((e&Mt)!==0)return!0;if(e&_t&&(r.f&=~ps),(e&fn)!==0){for(var t=r.deps,n=t.length,s=0;s<n;s++){var i=t[s];if(Po(i)&&wg(i),i.wv>r.wv)return!0}(e&dr)!==0&&vr===null&&dt(r,Pt)}return!1}function Fg(r,e,t=!0){var n=r.reactions;if(n!==null&&!tn?.includes(r))for(var s=0;s<n.length;s++){var i=n[s];(i.f&_t)!==0?Fg(i,e,!1):e===i&&(t?dt(i,Mt):(i.f&Pt)!==0&&dt(i,fn),sn(i))}}function Ug(r){var e=Rt,t=Yt,n=sr,s=me,i=tn,o=ut,l=wr,c=cs,d=r.f;Rt=null,Yt=0,sr=null,me=(d&(dn|xs))===0?r:null,tn=null,js(r.ctx),wr=!1,cs=++no,r.ac!==null&&(wi(()=>{r.ac.abort(Os)}),r.ac=null);try{r.f|=Kc;var f=r.fn,a=f(),u=r.deps;if(Rt!==null){var h;if(ka(r,Yt),u!==null&&Yt>0)for(u.length=Yt+Rt.length,h=0;h<Rt.length;h++)u[Yt+h]=Rt[h];else r.deps=u=Rt;if(Qu()&&(r.f&dr)!==0)for(h=Yt;h<u.length;h++)(u[h].reactions??=[]).push(r)}else u!==null&&Yt<u.length&&(ka(r,Yt),u.length=Yt);if(vi()&&sr!==null&&!wr&&u!==null&&(r.f&(_t|fn|Mt))===0)for(h=0;h<sr.length;h++)Fg(sr[h],r);return s!==null&&s!==r&&(no++,sr!==null&&(n===null?n=sr:n.push(...sr))),(r.f&Cn)!==0&&(r.f^=Cn),a}catch(p){return hg(p)}finally{r.f^=Kc,Rt=e,Yt=t,sr=n,me=s,tn=i,js(o),wr=l,cs=c}}function L_(r,e){let t=e.reactions;if(t!==null){var n=k0.call(t,r);if(n!==-1){var s=t.length-1;s===0?t=e.reactions=null:(t[n]=t[s],t.pop())}}if(t===null&&(e.f&_t)!==0&&(Rt===null||!Rt.includes(e))){var i=e;(i.f&dr)!==0&&(i.f^=dr,i.f&=~ps),Zu(i),vg(i),ka(i,0)}}function ka(r,e){var t=r.deps;if(t!==null)for(var n=e;n<t.length;n++)L_(r,t[n])}function so(r){var e=r.f;if((e&en)===0){dt(r,Pt);var t=_e,n=ls;_e=r,ls=!0;try{(e&(Mr|ig))!==0?T_(r):Dg(r),Pg(r);var s=Ug(r);r.teardown=typeof s=="function"?s:null,r.wv=Og;var i;Vc&&o_&&(r.f&Mt)!==0&&r.deps}finally{ls=n,_e=t}}}async function R_(){await Promise.resolve(),u_()}function b(r){var e=r.f,t=(e&_t)!==0;if(me!==null&&!wr){var n=_e!==null&&(_e.f&en)!==0;if(!n&&!tn?.includes(r)){var s=me.deps;if((me.f&Kc)!==0)r.rv<no&&(r.rv=no,Rt===null&&s!==null&&s[Yt]===r?Yt++:Rt===null?Rt=[r]:Rt.includes(r)||Rt.push(r));else{(me.deps??=[]).push(r);var i=r.reactions;i===null?r.reactions=[me]:i.includes(me)||i.push(me)}}}if(On&&Tn.has(r))return Tn.get(r);if(t){var o=r;if(On){var l=o.v;return((o.f&Pt)===0&&o.reactions!==null||Kg(o))&&(l=ju(o)),Tn.set(o,l),l}var c=(o.f&dr)===0&&!wr&&me!==null&&(ls||(me.f&dr)!==0),d=o.deps===null;Po(o)&&(c&&(o.f|=dr),wg(o)),c&&!d&&Vg(o)}if(vr?.has(r))return vr.get(r);if((r.f&Cn)!==0)throw r.v;return r.v}function Vg(r){if(r.deps!==null){r.f|=dr;for(const e of r.deps)(e.reactions??=[]).push(r),(e.f&_t)!==0&&(e.f&dr)===0&&Vg(e)}}function Kg(r){if(r.v===yt)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(Tn.has(e)||(e.f&_t)!==0&&Kg(e))return!0;return!1}function ct(r){var e=wr;try{return wr=!0,r()}finally{wr=e}}function B_(r,e){var t={};for(var n in r)e.includes(n)||(t[n]=r[n]);for(var s of Object.getOwnPropertySymbols(r))Object.propertyIsEnumerable.call(r,s)&&!e.includes(s)&&(t[s]=r[s]);return t}function N_(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(os in r)zc(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&os in t&&zc(t)}}}function zc(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let n in r)try{zc(r[n],e)}catch{}const t=Gu(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const n=ng(t);for(let s in n){const i=n[s].get;if(i)try{i.call(r)}catch{}}}}}const M_=["touchstart","touchmove"];function O_(r){return M_.includes(r)}const qg=new Set,Wc=new Set;function $_(r,e,t,n={}){function s(i){if(n.capture||Fi.call(e,i),!i.cancelBubble)return wi(()=>t?.call(this,i))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?As(()=>{e.addEventListener(r,s,n)}):e.addEventListener(r,s,n),s}function _r(r,e,t,n,s){var i={capture:n,passive:s},o=$_(r,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Ju(()=>{e.removeEventListener(r,o,i)})}function $r(r){for(var e=0;e<r.length;e++)qg.add(r[e]);for(var t of Wc)t(r)}let Mf=null;function Fi(r){var e=this,t=e.ownerDocument,n=r.type,s=r.composedPath?.()||[],i=s[0]||r.target;Mf=r;var o=0,l=Mf===r&&r.__root;if(l){var c=s.indexOf(l);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var d=s.indexOf(e);if(d===-1)return;c<=d&&(o=c)}if(i=s[o]||r.target,i!==e){rg(r,"currentTarget",{configurable:!0,get(){return i||t}});var f=me,a=_e;qt(null),Br(null);try{for(var u,h=[];i!==null;){var p=i.assignedSlot||i.parentNode||i.host||null;try{var y=i["__"+n];y!=null&&(!i.disabled||r.target===i)&&y.call(i,r)}catch(g){u?h.push(g):u=g}if(r.cancelBubble||p===e||p===null)break;i=p}if(u){for(let g of h)queueMicrotask(()=>{throw g});throw u}}finally{r.__root=e,delete r.currentTarget,qt(f),Br(a)}}}function F_(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function Gc(r,e){var t=_e;t.nodes===null&&(t.nodes={start:r,end:e,a:null,t:null})}function se(r,e){var t=(e&r_)!==0,n=(e&n_)!==0,s,i=!r.startsWith("<!>");return()=>{s===void 0&&(s=F_(i?r:"<!>"+r),t||(s=Aa(s)));var o=n||xg?document.importNode(s,!0):s.cloneNode(!0);if(t){var l=Aa(o),c=o.lastChild;Gc(l,c)}else Gc(o,o);return o}}function Yr(){var r=document.createDocumentFragment(),e=document.createComment(""),t=Pn();return r.append(e,t),Gc(e,t),r}function J(r,e){r!==null&&r.before(e)}let Yc=!0;function He(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??=r.nodeValue)&&(r.__t=t,r.nodeValue=t+"")}function U_(r,e){return V_(r,e)}const Ts=new Map;function V_(r,{target:e,anchor:t,props:n={},events:s,context:i,intro:o=!0}){__();var l=new Set,c=a=>{for(var u=0;u<a.length;u++){var h=a[u];if(!l.has(h)){l.add(h);var p=O_(h);e.addEventListener(h,Fi,{passive:p});var y=Ts.get(h);y===void 0?(document.addEventListener(h,Fi,{passive:p}),Ts.set(h,1)):Ts.set(h,y+1)}}};c(xl(qg)),Wc.add(c);var d=void 0,f=k_(()=>{var a=t??e.appendChild(Pn());return p_(a,{pending:()=>{}},u=>{if(i){ft({});var h=ut;h.c=i}s&&(n.$$events=s),Yc=o,d=r(u,n)||{},Yc=!0,i&&ht()}),()=>{for(var u of l){e.removeEventListener(u,Fi);var h=Ts.get(u);--h===0?(document.removeEventListener(u,Fi),Ts.delete(u)):Ts.set(u,h)}Wc.delete(c),a!==t&&a.parentNode?.removeChild(a)}});return K_.set(d,f),d}let K_=new WeakMap;class rd{anchor;#e=new Map;#r=new Map;#t=new Map;#n=new Set;#i=!0;constructor(e,t=!0){this.anchor=e,this.#i=t}#a=()=>{var e=We;if(this.#e.has(e)){var t=this.#e.get(e),n=this.#r.get(t);if(n)td(n),this.#n.delete(t);else{var s=this.#t.get(t);s&&(this.#r.set(t,s.effect),this.#t.delete(t),s.fragment.lastChild.remove(),this.anchor.before(s.fragment),n=s.effect)}for(const[i,o]of this.#e){if(this.#e.delete(i),i===e)break;const l=this.#t.get(o);l&&(Wt(l.effect),this.#t.delete(o))}for(const[i,o]of this.#r){if(i===t||this.#n.has(i))continue;const l=()=>{if(Array.from(this.#e.values()).includes(i)){var d=document.createDocumentFragment();Ng(o,d),d.append(Pn()),this.#t.set(i,{effect:o,fragment:d})}else Wt(o);this.#n.delete(i),this.#r.delete(i)};this.#i||!n?(this.#n.add(i),as(o,l,!1)):l()}}};#s=e=>{this.#e.delete(e);const t=Array.from(this.#e.values());for(const[n,s]of this.#t)t.includes(n)||(Wt(s.effect),this.#t.delete(n))};ensure(e,t){var n=We,s=kg();if(t&&!this.#r.has(e)&&!this.#t.has(e))if(s){var i=document.createDocumentFragment(),o=Pn();i.append(o),this.#t.set(e,{effect:ar(()=>t(o)),fragment:i})}else this.#r.set(e,ar(()=>t(this.anchor)));if(this.#e.set(n,e),s){for(const[l,c]of this.#r)l===e?n.skipped_effects.delete(c):n.skipped_effects.add(c);for(const[l,c]of this.#t)l===e?n.skipped_effects.delete(c.effect):n.skipped_effects.add(c.effect);n.oncommit(this.#a),n.ondiscard(this.#s)}else this.#a()}}function we(r,e,t=!1){var n=new rd(r),s=t?Mn:0;function i(o,l){n.ensure(o,l)}To(()=>{var o=!1;e((l,c=!0)=>{o=!0,i(c,l)}),o||i(!1,null)},s)}function q_(r,e,t){var n=new rd(r),s=!vi();To(()=>{var i=e();s&&i!==null&&typeof i=="object"&&(i={}),n.ensure(i,t)})}function ei(r,e){return e}function H_(r,e,t){for(var n=[],s=e.length,i,o=e.length,l=0;l<s;l++){let a=e[l];as(a,()=>{if(i){if(i.pending.delete(a),i.done.add(a),i.pending.size===0){var u=r.outrogroups;Xc(xl(i.done)),u.delete(i),u.size===0&&(r.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=n.length===0&&t!==null;if(c){var d=t,f=d.parentNode;S_(f),f.append(d),r.items.clear()}Xc(e,!c)}else i={pending:new Set(e),done:new Set},(r.outrogroups??=new Set).add(i)}function Xc(r,e=!0){for(var t=0;t<r.length;t++)Wt(r[t],e)}var Of;function Dn(r,e,t,n,s,i=null){var o=r,l=new Map,c=(e&lg)!==0;if(c){var d=r;o=d.appendChild(Pn())}var f=null,a=ro(()=>{var m=t();return tg(m)?m:m==null?[]:xl(m)}),u,h=!0;function p(){g.fallback=f,z_(g,u,o,e,n),f!==null&&(u.length===0?(f.f&Zr)===0?td(f):(f.f^=Zr,Ui(f,null,o)):as(f,()=>{f=null}))}var y=To(()=>{u=b(a);for(var m=u.length,w=new Set,v=We,_=kg(),k=0;k<m;k+=1){var P=u[k],D=n(P,k),I=h?null:l.get(D);I?(I.v&&Js(I.v,P),I.i&&Js(I.i,k),_&&v.skipped_effects.delete(I.e)):(I=W_(l,h?o:Of??=Pn(),P,D,k,s,e,t),h||(I.e.f|=Zr),l.set(D,I)),w.add(D)}if(m===0&&i&&!f&&(h?f=ar(()=>i(o)):(f=ar(()=>i(Of??=Pn())),f.f|=Zr)),!h)if(_){for(const[x,B]of l)w.has(x)||v.skipped_effects.add(B.e);v.oncommit(p),v.ondiscard(()=>{})}else p();b(a)}),g={effect:y,items:l,outrogroups:null,fallback:f};h=!1}function z_(r,e,t,n,s){var i=(n&W0)!==0,o=e.length,l=r.items,c=r.effect.first,d,f=null,a,u=[],h=[],p,y,g,m;if(i)for(m=0;m<o;m+=1)p=e[m],y=s(p,m),g=l.get(y).e,(g.f&Zr)===0&&(g.nodes?.a?.measure(),(a??=new Set).add(g));for(m=0;m<o;m+=1){if(p=e[m],y=s(p,m),g=l.get(y).e,r.outrogroups!==null)for(const B of r.outrogroups)B.pending.delete(g),B.done.delete(g);if((g.f&Zr)!==0)if(g.f^=Zr,g===c)Ui(g,null,t);else{var w=f?f.next:c;g===r.effect.last&&(r.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),yn(r,f,g),yn(r,g,w),Ui(g,w,t),f=g,u=[],h=[],c=f.next;continue}if((g.f&er)!==0&&(td(g),i&&(g.nodes?.a?.unfix(),(a??=new Set).delete(g))),g!==c){if(d!==void 0&&d.has(g)){if(u.length<h.length){var v=h[0],_;f=v.prev;var k=u[0],P=u[u.length-1];for(_=0;_<u.length;_+=1)Ui(u[_],v,t);for(_=0;_<h.length;_+=1)d.delete(h[_]);yn(r,k.prev,P.next),yn(r,f,k),yn(r,P,v),c=v,f=P,m-=1,u=[],h=[]}else d.delete(g),Ui(g,c,t),yn(r,g.prev,g.next),yn(r,g,f===null?r.effect.first:f.next),yn(r,f,g),f=g;continue}for(u=[],h=[];c!==null&&c!==g;)(d??=new Set).add(c),h.push(c),c=c.next;if(c===null)continue}(g.f&Zr)===0&&u.push(g),f=g,c=g.next}if(r.outrogroups!==null){for(const B of r.outrogroups)B.pending.size===0&&(Xc(xl(B.done)),r.outrogroups?.delete(B));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||d!==void 0){var D=[];if(d!==void 0)for(g of d)(g.f&er)===0&&D.push(g);for(;c!==null;)(c.f&er)===0&&c!==r.fallback&&D.push(c),c=c.next;var I=D.length;if(I>0){var x=(n&lg)!==0&&o===0?t:null;if(i){for(m=0;m<I;m+=1)D[m].nodes?.a?.measure();for(m=0;m<I;m+=1)D[m].nodes?.a?.fix()}H_(r,D,x)}}i&&As(()=>{if(a!==void 0)for(g of a)g.nodes?.a?.apply()})}function W_(r,e,t,n,s,i,o,l){var c=(o&H0)!==0?(o&G0)===0?Sg(t,!1,!1):gs(t):null,d=(o&z0)!==0?gs(s):null;return{v:c,i:d,e:ar(()=>(i(e,c??t,d??s,l),()=>{r.delete(n)}))}}function Ui(r,e,t){if(r.nodes)for(var n=r.nodes.start,s=r.nodes.end,i=e&&(e.f&Zr)===0?e.nodes.start:t;n!==null;){var o=Co(n);if(i.before(n),n===s)return;n=o}}function yn(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function Hg(r,e,...t){var n=new rd(r);To(()=>{const s=e()??null;n.ensure(s,s&&(i=>s(i,...t)))},Mn)}const G_=()=>performance.now(),Xr={tick:r=>requestAnimationFrame(r),now:()=>G_(),tasks:new Set};function zg(){const r=Xr.now();Xr.tasks.forEach(e=>{e.c(r)||(Xr.tasks.delete(e),e.f())}),Xr.tasks.size!==0&&Xr.tick(zg)}function Y_(r){let e;return Xr.tasks.size===0&&Xr.tick(zg),{promise:new Promise(t=>{Xr.tasks.add(e={c:r,f:t})}),abort(){Xr.tasks.delete(e)}}}function Yo(r,e){wi(()=>{r.dispatchEvent(new CustomEvent(e))})}function X_(r){if(r==="float")return"cssFloat";if(r==="offset")return"cssOffset";if(r.startsWith("--"))return r;const e=r.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function $f(r){const e={},t=r.split(";");for(const n of t){const[s,i]=n.split(":");if(!s||i===void 0)break;const o=X_(s.trim());e[o]=i.trim()}return e}const Z_=r=>r;function xe(r,e,t,n){var s=(r&J0)!==0,i=(r&e_)!==0,o=s&&i,l=(r&t_)!==0,c=o?"both":s?"in":"out",d,f=e.inert,a=e.style.overflow,u,h;function p(){return wi(()=>d??=t()(e,n?.()??{},{direction:c}))}var y={is_global:l,in(){if(e.inert=f,!s){h?.abort(),h?.reset?.();return}i||u?.abort(),Yo(e,"introstart"),u=Zc(e,p(),h,1,()=>{Yo(e,"introend"),u?.abort(),u=d=void 0,e.style.overflow=a})},out(v){if(!i){v?.(),d=void 0;return}e.inert=!0,Yo(e,"outrostart"),h=Zc(e,p(),u,0,()=>{Yo(e,"outroend"),v?.()})},stop:()=>{u?.abort(),h?.abort()}},g=_e;if((g.nodes.t??=[]).push(y),s&&Yc){var m=l;if(!m){for(var w=g.parent;w&&(w.f&Mn)!==0;)for(;(w=w.parent)&&(w.f&Mr)===0;);m=!w||(w.f&Al)!==0}m&&kl(()=>{ct(()=>y.in())})}}function Zc(r,e,t,n,s){var i=n===1;if(P0(e)){var o,l=!1;return As(()=>{if(!l){var g=e({direction:i?"in":"out"});o=Zc(r,g,t,n,s)}}),{abort:()=>{l=!0,o?.abort()},deactivate:()=>o.deactivate(),reset:()=>o.reset(),t:()=>o.t()}}if(t?.deactivate(),!e?.duration)return s(),{abort:Kt,deactivate:Kt,reset:Kt,t:()=>n};const{delay:c=0,css:d,tick:f,easing:a=Z_}=e;var u=[];if(i&&t===void 0&&(f&&f(0,1),d)){var h=$f(d(0,1));u.push(h,h)}var p=()=>1-n,y=r.animate(u,{duration:c,fill:"forwards"});return y.onfinish=()=>{y.cancel();var g=t?.t()??1-n;t?.abort();var m=n-g,w=e.duration*Math.abs(m),v=[];if(w>0){var _=!1;if(d)for(var k=Math.ceil(w/16.666666666666668),P=0;P<=k;P+=1){var D=g+m*a(P/k),I=$f(d(D,1-D));v.push(I),_||=I.overflow==="hidden"}_&&(r.style.overflow="hidden"),p=()=>{var x=y.currentTime;return g+m*a(x/w)},f&&Y_(()=>{if(y.playState!=="running")return!1;var x=p();return f(x,1-x),!0})}y=r.animate(v,{duration:w,fill:"forwards"}),y.onfinish=()=>{p=()=>n,f?.(n,1-n),s()}},{abort:()=>{y&&(y.cancel(),y.effect=null,y.onfinish=Kt)},deactivate:()=>{s=Kt},reset:()=>{n===0&&f?.(1,0)},t:()=>p()}}function Wg(r,e,t){kl(()=>{var n=ct(()=>e(r,t?.())||{});if(n?.destroy)return()=>n.destroy()})}function Gg(r){var e,t,n="";if(typeof r=="string"||typeof r=="number")n+=r;else if(typeof r=="object")if(Array.isArray(r)){var s=r.length;for(e=0;e<s;e++)r[e]&&(t=Gg(r[e]))&&(n&&(n+=" "),n+=t)}else for(t in r)r[t]&&(n&&(n+=" "),n+=t);return n}function j_(){for(var r,e,t=0,n="",s=arguments.length;t<s;t++)(r=arguments[t])&&(e=Gg(r))&&(n&&(n+=" "),n+=e);return n}function Yg(r){return typeof r=="object"?j_(r):r??""}const Ff=[...` 	
\r\fÂ \v\uFEFF`];function Q_(r,e,t){var n=r==null?"":""+r;if(e&&(n=n?n+" "+e:e),t){for(var s in t)if(t[s])n=n?n+" "+s:s;else if(n.length)for(var i=s.length,o=0;(o=n.indexOf(s,o))>=0;){var l=o+i;(o===0||Ff.includes(n[o-1]))&&(l===n.length||Ff.includes(n[l]))?n=(o===0?"":n.substring(0,o))+n.substring(l+1):o=l}}return n===""?null:n}function Uf(r,e=!1){var t=e?" !important;":";",n="";for(var s in r){var i=r[s];i!=null&&i!==""&&(n+=" "+s+": "+i+t)}return n}function ec(r){return r[0]!=="-"||r[1]!=="-"?r.toLowerCase():r}function J_(r,e){if(e){var t="",n,s;if(Array.isArray(e)?(n=e[0],s=e[1]):n=e,r){r=String(r).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var i=!1,o=0,l=!1,c=[];n&&c.push(...Object.keys(n).map(ec)),s&&c.push(...Object.keys(s).map(ec));var d=0,f=-1;const y=r.length;for(var a=0;a<y;a++){var u=r[a];if(l?u==="/"&&r[a-1]==="*"&&(l=!1):i?i===u&&(i=!1):u==="/"&&r[a+1]==="*"?l=!0:u==='"'||u==="'"?i=u:u==="("?o++:u===")"&&o--,!l&&i===!1&&o===0){if(u===":"&&f===-1)f=a;else if(u===";"||a===y-1){if(f!==-1){var h=ec(r.substring(d,f).trim());if(!c.includes(h)){u!==";"&&a++;var p=r.substring(d,a).trim();t+=" "+p+";"}}d=a+1,f=-1}}}}return n&&(t+=Uf(n)),s&&(t+=Uf(s,!0)),t=t.trim(),t===""?null:t}return r==null?null:String(r)}function Ue(r,e,t,n,s,i){var o=r.__className;if(o!==t||o===void 0){var l=Q_(t,n,i);l==null?r.removeAttribute("class"):r.className=l,r.__className=t}else if(i&&s!==i)for(var c in i){var d=!!i[c];(s==null||d!==!!s[c])&&r.classList.toggle(c,d)}return i}function tc(r,e={},t,n){for(var s in t){var i=t[s];e[s]!==i&&(t[s]==null?r.style.removeProperty(s):r.style.setProperty(s,i,n))}}function Ct(r,e,t,n){var s=r.__style;if(s!==e){var i=J_(e,n);i==null?r.removeAttribute("style"):r.style.cssText=i,r.__style=e}else n&&(Array.isArray(n)?(tc(r,t?.[0],n[0]),tc(r,t?.[1],n[1],"important")):tc(r,t,n));return n}const e1=Symbol("is custom element"),t1=Symbol("is html");function jc(r,e){var t=nd(r);t.value===(t.value=e??void 0)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e??"")}function r1(r,e){var t=nd(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function Ln(r,e,t,n){var s=nd(r);s[e]!==(s[e]=t)&&(e==="loading"&&(r[R0]=t),t==null?r.removeAttribute(e):typeof t!="string"&&n1(r).includes(e)?r[e]=t:r.setAttribute(e,t))}function nd(r){return r.__attributes??={[e1]:r.nodeName.includes("-"),[t1]:r.namespaceURI===s_}}var Vf=new Map;function n1(r){var e=r.getAttribute("is")||r.nodeName,t=Vf.get(e);if(t)return t;Vf.set(e,t=[]);for(var n,s=r,i=Element.prototype;i!==s;){n=ng(s);for(var o in n)n[o].set&&t.push(o);s=Gu(s)}return t}function Kf(r,e,t=e){x_(r,"change",n=>{var s=n?r.defaultChecked:r.checked;t(s)}),ct(e)==null&&t(r.checked),ed(()=>{var n=e();r.checked=!!n})}class sd{#e=new WeakMap;#r;#t;static entries=new WeakMap;constructor(e){this.#t=e}observe(e,t){var n=this.#e.get(e)||new Set;return n.add(t),this.#e.set(e,n),this.#n().observe(e,this.#t),()=>{var s=this.#e.get(e);s.delete(t),s.size===0&&(this.#e.delete(e),this.#r.unobserve(e))}}#n(){return this.#r??(this.#r=new ResizeObserver(e=>{for(var t of e){sd.entries.set(t.target,t);for(var n of this.#e.get(t.target)||[])n(t)}}))}}var s1=new sd({box:"border-box"});function qf(r,e,t){var n=s1.observe(r,()=>t(r[e]));kl(()=>(ct(()=>t(r[e])),n))}function Hf(r,e){return r===e||r?.[os]===e}function Ze(r={},e,t,n){return kl(()=>{var s,i;return ed(()=>{s=i,i=[],ct(()=>{r!==t(...i)&&(e(r,...i),s&&Hf(t(...s),r)&&e(null,...s))})}),()=>{As(()=>{i&&Hf(t(...i),r)&&e(null,...i)})}}),r}function i1(r=!1){const e=ut,t=e.l.u;if(!t)return;let n=()=>N_(e.s);if(r){let s=0,i={};const o=ko(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==i[d]&&(i[d]=c[d],l=!0);return l&&s++,s});n=()=>b(o)}t.b.length&&I_(()=>{zf(e,n),Sa(t.b)}),st(()=>{const s=ct(()=>t.m.map(D0));return()=>{for(const i of s)typeof i=="function"&&i()}}),t.a.length&&st(()=>{zf(e,n),Sa(t.a)})}function zf(r,e){if(r.l.s)for(const t of r.l.s)b(t);e()}function id(r,e,t){if(r==null)return e(void 0),t&&t(void 0),Kt;const n=ct(()=>r.subscribe(e,t));return n.unsubscribe?()=>n.unsubscribe():n}const Ps=[];function Vi(r,e){return{subscribe:ir(r,e).subscribe}}function ir(r,e=Kt){let t=null;const n=new Set;function s(l){if(ug(r,l)&&(r=l,t)){const c=!Ps.length;for(const d of n)d[1](),Ps.push(d,r);if(c){for(let d=0;d<Ps.length;d+=2)Ps[d][0](Ps[d+1]);Ps.length=0}}}function i(l){s(l(r))}function o(l,c=Kt){const d=[l,c];return n.add(d),n.size===1&&(t=e(s,i)||Kt),l(r),()=>{n.delete(d),n.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:o}}function o1(r,e,t){const n=!Array.isArray(r),s=n?[r]:r;if(!s.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const i=e.length<2;return Vi(t,(o,l)=>{let c=!1;const d=[];let f=0,a=Kt;const u=()=>{if(f)return;a();const p=e(n?d[0]:d,o,l);i?o(p):a=typeof p=="function"?p:Kt},h=s.map((p,y)=>id(p,g=>{d[y]=g,f&=~(1<<y),c&&u()},()=>{f|=1<<y}));return c=!0,u(),function(){Sa(h),a(),c=!1}})}function _i(r){let e;return id(r,t=>e=t)(),e}let Xo=!1,Qc=Symbol();function fe(r,e,t){const n=t[e]??={store:null,source:Sg(void 0),unsubscribe:Kt};if(n.store!==r&&!(Qc in t))if(n.unsubscribe(),n.store=r??null,r==null)n.source.v=void 0,n.unsubscribe=Kt;else{var s=!0;n.unsubscribe=id(r,i=>{s?n.source.v=i:X(n.source,i)}),s=!1}return r&&Qc in t?_i(r):b(n.source)}function Nt(r,e){return r.set(e),e}function tr(){const r={};function e(){Ju(()=>{for(var t in r)r[t].unsubscribe();rg(r,Qc,{enumerable:!1,value:!0})})}return[r,e]}function pa(r,e,t){return r.set(t),e}function a1(r){var e=Xo;try{return Xo=!1,[r(),Xo]}finally{Xo=e}}function Qr(r,e,t,n){var s=!Io||(t&X0)!==0,i=(t&j0)!==0,o=(t&Q0)!==0,l=n,c=!0,d=()=>(c&&(c=!1,l=o?ct(n):n),l),f;if(i){var a=os in r||L0 in r;f=qs(r,e)?.set??(a&&e in r?v=>r[e]=v:void 0)}var u,h=!1;i?[u,h]=a1(()=>r[e]):u=r[e],u===void 0&&n!==void 0&&(u=d(),f&&(s&&F0(),f(u)));var p;if(s?p=()=>{var v=r[e];return v===void 0?d():(c=!0,v)}:p=()=>{var v=r[e];return v!==void 0&&(l=void 0),v===void 0?l:v},s&&(t&Z0)===0)return p;if(f){var y=r.$$legacy;return(function(v,_){return arguments.length>0?((!s||!_||y||h)&&f(_?p():v),v):p()})}var g=!1,m=((t&Y0)!==0?ko:ro)(()=>(g=!1,p()));i&&b(m);var w=_e;return(function(v,_){if(arguments.length>0){const k=_?b(m):s&&i?jr(v):v;return X(m,k),g=!0,l!==void 0&&(l=k),v}return On&&g||(w.f&en)!==0?m.v:b(m)})}const l1="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(l1);class c1{data;indexes;#e;#r;#t;constructor({data:e=[],maxSize:t=1/0,compare:n=(i,o)=>i<o?-1:i>o?1:0,extractKey:s=i=>i}={}){if(this.data=e,this.indexes=new Map(e.map((i,o)=>[s(i),o])),this.#e=t,this.#r=n,this.#t=s,e.length>0)for(let i=(e.length>>>1)-1;i>=0;i--)this.#i(i)}#n(e){const{data:t,indexes:n}=this,s=this.#r,i=this.#t,o=t[e];for(;e>0;){const l=e-1>>>1,c=t[l];if(s(o,c)>=0)break;n.set(i(c),e),t[e]=c,e=l}n.set(i(o),e),t[e]=o}#i(e){const{data:t,indexes:n}=this,s=this.#r,i=this.#t,o=t[e],l=t.length>>>1;for(;e<l;){let c=(e<<1)+1,d=t[c];const f=c+1;if(f<t.length){const a=t[f];s(a,d)<0&&(c=f,d=a)}if(s(d,o)>=0)break;n.set(i(d),e),t[e]=d,e=c}n.set(i(o),e),t[e]=o}push(e){const t=this.#t(e),n=this.indexes.get(t);if(n===void 0)return this.data.push(e),this.#n(this.data.length-1),this.data.length<=this.#e?void 0:this.pop();const s=this.data[n];this.data[n]=e;const i=this.#r(s,e);i<0?this.#i(n):i>0&&this.#n(n)}pop(){if(this.data.length===0)return;const e=this.data[0];this.indexes.delete(this.#t(e));const t=this.data.pop();return this.data.length>0&&t!==void 0&&(this.indexes.set(this.#t(t),0),this.data[0]=t,this.#i(0)),e}peek(){return this.data[0]}remove(e){const t=this.indexes.get(e);if(t===void 0)return!1;const n=this.data.length-1;if(t===n)return this.indexes.delete(e),this.data.pop(),!0;const s=this.data.pop();this.indexes.delete(e),this.indexes.set(this.#t(s),t),this.data[t]=s;const i=t-1>>>1;return t>0&&this.#r(s,this.data[i])<0?this.#n(t):this.#i(t),!0}has(e){return this.indexes.has(e)}get(e){const t=this.indexes.get(e);return t!==void 0?this.data[t]:void 0}clear(){this.data=[],this.indexes.clear()}get size(){return this.data.length}*[Symbol.iterator](){yield*this.data}}function u1(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Cl(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function d1(r){return new TextEncoder().encode(r)}function f1(r){return new TextDecoder().decode(r)}function h1(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var l=r.length,c=r.charAt(0),d=Math.log(l)/Math.log(256),f=Math.log(256)/Math.log(l);function a(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var y=0,g=0,m=0,w=p.length;m!==w&&p[m]===0;)m++,y++;for(var v=(w-m)*f+1>>>0,_=new Uint8Array(v);m!==w;){for(var k=p[m],P=0,D=v-1;(k!==0||P<g)&&D!==-1;D--,P++)k+=256*_[D]>>>0,_[D]=k%l>>>0,k=k/l>>>0;if(k!==0)throw new Error("Non-zero carry");g=P,m++}for(var I=v-g;I!==v&&_[I]===0;)I++;for(var x=c.repeat(y);I<v;++I)x+=r.charAt(_[I]);return x}function u(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var y=0;if(p[y]!==" "){for(var g=0,m=0;p[y]===c;)g++,y++;for(var w=(p.length-y)*d+1>>>0,v=new Uint8Array(w);p[y];){var _=t[p.charCodeAt(y)];if(_===255)return;for(var k=0,P=w-1;(_!==0||k<m)&&P!==-1;P--,k++)_+=l*v[P]>>>0,v[P]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");m=k,y++}if(p[y]!==" "){for(var D=w-m;D!==w&&v[D]===0;)D++;for(var I=new Uint8Array(g+(w-D)),x=g;D!==w;)I[x++]=v[D++];return I}}}function h(p){var y=u(p);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:a,decodeUnsafe:u,decode:h}}var p1=h1,g1=p1;class m1{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}let y1=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Xg(this,e)}};class b1{decoders;constructor(e){this.decoders=e}or(e){return Xg(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function Xg(r,e){return new b1({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class v1{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new m1(e,t,n),this.decoder=new y1(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function Tl({name:r,prefix:e,encode:t,decode:n}){return new v1(r,e,t,n)}function Do({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=g1(t,r);return Tl({prefix:e,name:r,encode:n,decode:i=>Cl(s(i))})}function w1(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,l=0,c=0;for(let d=0;d<s;++d){const f=e[r[d]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);l=l<<t|f,o+=t,o>=8&&(o-=8,i[c++]=255&l>>o)}if(o>=t||(255&l<<8-o)!==0)throw new SyntaxError("Unexpected end of data");return i}function _1(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,l=0;for(let c=0;c<r.length;++c)for(l=l<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&l>>o];if(o!==0&&(i+=e[s&l<<t-o]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function S1(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function St({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=S1(n);return Tl({prefix:e,name:r,encode(i){return _1(i,n,t)},decode(i){return w1(i,s,t,r)}})}const E1=Do({prefix:"9",name:"base10",alphabet:"0123456789"}),x1=Object.freeze(Object.defineProperty({__proto__:null,base10:E1},Symbol.toStringTag,{value:"Module"})),A1=St({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),I1=St({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),k1=Object.freeze(Object.defineProperty({__proto__:null,base16:A1,base16upper:I1},Symbol.toStringTag,{value:"Module"})),C1=St({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),T1=Object.freeze(Object.defineProperty({__proto__:null,base2:C1},Symbol.toStringTag,{value:"Module"})),Zg=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),P1=Zg.reduce((r,e,t)=>(r[t]=e,r),[]),D1=Zg.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function L1(r){return r.reduce((e,t)=>(e+=P1[t],e),"")}function R1(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=D1[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const B1=Tl({prefix:"ðŸš€",name:"base256emoji",encode:L1,decode:R1}),N1=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:B1},Symbol.toStringTag,{value:"Module"})),Rn=St({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),M1=St({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),O1=St({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),$1=St({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),F1=St({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),U1=St({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),V1=St({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),K1=St({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),q1=St({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),H1=Object.freeze(Object.defineProperty({__proto__:null,base32:Rn,base32hex:F1,base32hexpad:V1,base32hexpadupper:K1,base32hexupper:U1,base32pad:O1,base32padupper:$1,base32upper:M1,base32z:q1},Symbol.toStringTag,{value:"Module"})),ga=Do({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),z1=Do({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),W1=Object.freeze(Object.defineProperty({__proto__:null,base36:ga,base36upper:z1},Symbol.toStringTag,{value:"Module"})),De=Do({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),G1=Do({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Y1=Object.freeze(Object.defineProperty({__proto__:null,base58btc:De,base58flickr:G1},Symbol.toStringTag,{value:"Module"})),Lo=St({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),X1=St({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),jg=St({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Z1=St({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),j1=Object.freeze(Object.defineProperty({__proto__:null,base64:Lo,base64pad:X1,base64url:jg,base64urlpad:Z1},Symbol.toStringTag,{value:"Module"})),Q1=St({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),J1=Object.freeze(Object.defineProperty({__proto__:null,base8:Q1},Symbol.toStringTag,{value:"Module"})),eS=Tl({prefix:"\0",name:"identity",encode:r=>f1(r),decode:r=>d1(r)}),tS=Object.freeze(Object.defineProperty({__proto__:null,identity:eS},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;var rS=Qg,Wf=128,nS=-128,sS=Math.pow(2,31);function Qg(r,e,t){e=e||[],t=t||0;for(var n=t;r>=sS;)e[t++]=r&255|Wf,r/=128;for(;r&nS;)e[t++]=r&255|Wf,r>>>=7;return e[t]=r|0,Qg.bytes=t-n+1,e}var iS=Jc,oS=128,Gf=127;function Jc(r,n){var t=0,n=n||0,s=0,i=n,o,l=r.length;do{if(i>=l)throw Jc.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Gf)<<s:(o&Gf)*Math.pow(2,s),s+=7}while(o>=oS);return Jc.bytes=i-n,t}var aS=Math.pow(2,7),lS=Math.pow(2,14),cS=Math.pow(2,21),uS=Math.pow(2,28),dS=Math.pow(2,35),fS=Math.pow(2,42),hS=Math.pow(2,49),pS=Math.pow(2,56),gS=Math.pow(2,63),mS=function(r){return r<aS?1:r<lS?2:r<cS?3:r<uS?4:r<dS?5:r<fS?6:r<hS?7:r<pS?8:r<gS?9:10},yS={encode:rS,decode:iS,encodingLength:mS},Ca=yS;function eu(r,e=0){return[Ca.decode(r,e),Ca.decode.bytes]}function Ta(r,e,t=0){return Ca.encode(r,e,t),e}function Pa(r){return Ca.encodingLength(r)}function Si(r,e){const t=e.byteLength,n=Pa(r),s=n+Pa(t),i=new Uint8Array(s+t);return Ta(r,i,0),Ta(t,i,n),i.set(e,s),new od(r,t,e,i)}function hn(r){const e=Cl(r),[t,n]=eu(e),[s,i]=eu(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new od(t,s,o,e)}function bS(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&u1(r.bytes,t.bytes)}}class od{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}const Jg=0,vS="identity",em=Cl;function wS(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return Si(Jg,em(r))}const it={code:Jg,name:vS,encode:em,digest:wS},_S=20;function SS({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:s}){return new ES(r,e,t,n,s)}class ES{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,s,i){this.name=e,this.code=t,this.encode=n,this.minDigestLength=s??_S,this.maxDigestLength=i}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?Yf(n,this.code,t?.truncate):n.then(s=>Yf(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}}function Yf(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return Si(e,r)}function xS(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const pr=SS({name:"sha2-256",code:18,encode:xS("SHA-256")});function Xf(r,e){const{bytes:t,version:n}=r;return n===0?IS(t,tu(r),e??De.encoder):kS(t,tu(r),e??Rn.encoder)}const Zf=new WeakMap;function tu(r){const e=Zf.get(r);if(e==null){const t=new Map;return Zf.set(r,t),t}return e}class ue{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ci)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==CS)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ue.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Si(e,t);return ue.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ue.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&bS(e.multihash,n.multihash)}toString(e){return Xf(this,e)}toJSON(){return{"/":Xf(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ue)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ue(n,s,i,o??jf(n,s,i.bytes))}else if(t[TS]===!0){const{version:n,multihash:s,code:i}=t,o=hn(s);return ue.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ci)throw new Error(`Version 0 CID must use dag-pb (code: ${Ci}) block encoding`);return new ue(e,t,n,n.bytes)}case 1:{const s=jf(e,t,n.bytes);return new ue(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ue.create(0,Ci,e)}static createV1(e,t){return ue.create(1,e,t)}static decode(e){const[t,n]=ue.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ue.inspectBytes(e),n=t.size-t.multihashSize,s=Cl(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new od(t.multihashCode,t.digestSize,i,s);return[t.version===0?ue.createV0(o):ue.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[a,u]=eu(e.subarray(t));return t+=u,a};let s=n(),i=Ci;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,l=n(),c=n(),d=t+c,f=d-o;return{version:s,codec:i,multihashCode:l,digestSize:c,multihashSize:f,size:d}}static parse(e,t){const[n,s]=AS(e,t),i=ue.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return tu(i).set(n,e),i}}function AS(r,e){switch(r[0]){case"Q":{const t=e??De;return[De.prefix,t.decode(`${De.prefix}${r}`)]}case De.prefix:{const t=e??De;return[De.prefix,t.decode(r)]}case Rn.prefix:{const t=e??Rn;return[Rn.prefix,t.decode(r)]}case ga.prefix:{const t=e??ga;return[ga.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function IS(r,e,t){const{prefix:n}=t;if(n!==De.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function kS(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const Ci=112,CS=18;function jf(r,e,t){const n=Pa(r),s=n+Pa(e),i=new Uint8Array(s+t.byteLength);return Ta(r,i,0),Ta(e,i,n),i.set(t,s),i}const TS=Symbol.for("@ipld/js-cid/CID"),ru={...tS,...T1,...J1,...x1,...k1,...H1,...W1,...Y1,...j1,...N1};function Ke(r=0){return new Uint8Array(r)}function on(r=0){return new Uint8Array(r)}function tm(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const Qf=tm("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),rc=tm("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=on(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),rm={utf8:Qf,"utf-8":Qf,hex:ru.base16,latin1:rc,ascii:rc,binary:rc,...ru};function j(r,e="utf8"){const t=rm[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function W(r,e="utf8"){const t=rm[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const ti=Object.freeze(["/dns4/r2.digifall.app/tcp/443/wss/p2p/12D3KooWPN8DqXM1ytrTs9bxpWt3ZnMLEWxHc3AEX2kKg62qhesv","/dns4/r3.digifall.app/tcp/443/wss/p2p/12D3KooWHUFx2bdvULtrXugaX8T3RX8A8KzoPmRbSMPKDqNNbLUw"]),$s=Object.freeze({root:"/digifall/root/1.0",preview:"/digifall/preview/1.0"}),PS=Object.freeze(["highCombo","highScore"]);function ad(r,e){return r.value>e.value?1:r.value<e.value||r.timestamp<e.timestamp?-1:r.timestamp>e.timestamp?1:0}function DS(r){return r?.playerName??""}function nu(r){return JSON.parse(W(r.subarray()))}function Ds(r){return j(JSON.stringify(r))}function Jf(r){let e=0;for(const t of r)e=e*31+t|0;return e}function LS({playerName:r="",timestamp:e=0}){let t=e|0;for(let n=0;n<r.length;n++)t=t*31+r.charCodeAt(n)|0;return t}function RS(r){return r.length===0?0:Jf(r.slice().sort(ad).map(e=>Jf([LS(e),e.value])))}class BS{recordTypes;maxRecords;debug;validateRecord;onUpdate;queues;roots;constructor(e={}){this.recordTypes=e.recordTypes??[...PS],this.maxRecords=e.maxRecords??1e3,this.debug=e.debug??!1,this.validateRecord=e.validateRecord??null,this.onUpdate=e.onUpdate??null,this.queues=Object.fromEntries(this.recordTypes.map(t=>[t,new c1({maxSize:this.maxRecords,compare:ad,extractKey:DS})])),this.roots=Object.fromEntries(this.recordTypes.map(t=>[t,0]))}updateRoot(e){const t=this.queues[e];this.roots[e]=t?RS(t.data):0}getQueue(e){return this.queues[e]}getRoots(){return{...this.roots}}getData(e){return this.queues[e]?.data??[]}getAllData(){return Object.fromEntries(this.recordTypes.map(e=>[e,this.getData(e)]))}loadData(e,t){const n=this.queues[e];if(n){for(const s of t)n.push(s);this.updateRoot(e)}}handleRecord(e){const{type:t,playerName:n,value:s}=e,i=this.queues[t];if(!i)return!1;const{data:o,indexes:l}=i,c=l.get(n);return c in o&&o[c].value>=s?!1:(i.push(e),this.updateRoot(t),this.debug&&console.log("LEADERBOARD UPDATED:",t,n,s),this.onUpdate?.(t,i.data),!0)}async handleRecordWithValidation(e){const{type:t,playerName:n,value:s}=e,i=this.queues[t];if(!i)return!1;const{data:o,indexes:l}=i,c=l.get(n);if(c in o&&o[c].value>=s)return!1;if(this.validateRecord)try{const d=await this.validateRecord(e);return d?this.handleRecord(d):!1}catch(d){return this.debug&&console.error(d),!1}return this.handleRecord(e)}createRootHandler(e){return async(t,n)=>{this.debug&&console.log("handleRoot");const s=new Set;t.addEventListener("message",i=>{const o=i.detail??i.data;try{const l=nu(o);if(l===null){if(t.close(),s.size===0||n.status!=="open")return;e(n,Array.from(s));return}if(Array.isArray(l)){const[c,d]=l;if(!(c in this.roots))return;if(d===0){for(const f of this.queues[c].data)t.send(Ds(f));return}d!==this.roots[c]&&s.add(c)}else this.handleRecordWithValidation(l)}catch(l){this.debug&&console.error(l)}})}}createPreviewHandler(){return async(e,t)=>{this.debug&&console.log("handlePreview");const n=new Set,s=Object.fromEntries(this.recordTypes.map(i=>[i,new Set]));e.addEventListener("message",i=>{const o=i.detail??i.data;try{const l=nu(o);if(l===null){Array.from(n).flatMap(u=>this.queues[u].data.filter(h=>!s[u].has(h.playerName))).forEach(u=>e.send(Ds(u))),e.close();return}const{type:c,playerName:d,value:f}=l;if(!(c in this.queues))return;n.add(c);const a=this.queues[c].indexes.get(d);if(a===void 0||this.queues[c].data[a].value>f)return;s[c].add(d)}catch(l){this.debug&&console.error(l)}})}}createPushRoot(e){return async t=>(this.debug&&console.log($s.root),t.newStream($s.root,{runOnLimitedConnection:!0}).then(async n=>{n.addEventListener("message",s=>{const i=s.detail??s.data;e(i)}),Object.entries(this.roots).forEach(([s,i])=>n.send(Ds([s,i]))),n.send(Ds(null))}).catch(n=>(this.debug&&console.error(n),{error:n})))}createPushPreview(e){return async(t,n)=>(this.debug&&console.log($s.preview),t.newStream($s.preview,{runOnLimitedConnection:!0}).then(async s=>{s.addEventListener("message",i=>{const o=i.detail??i.data;e(o)}),n.forEach(i=>this.queues[i].data.forEach(({playerName:o,value:l})=>s.send(Ds({type:i,playerName:o,value:l})))),s.send(Ds(null))}).catch(s=>{this.debug&&console.error(s)}))}}const Ei=!!localStorage.getItem("debug"),eh=Number(localStorage.getItem("reload")),NS=!!localStorage.getItem("use-all-relays"),at=1e3,MS=4e4,Re=Object.freeze({columns:6,rows:6,maxValue:9}),U=Object.freeze({digifall:"digifall",highCombo:"highCombo",highComboPrev:"highComboPrev",highScore:"highScore",highScorePrev:"highScorePrev",leaderboard:"leaderboard",local:"local",moves:"moves",options:"options",peerId:"peerId",playerName:"playerName",records:"records",relays:"relays",score:"score",timestamp:"timestamp",type:"type",value:"value"}),de=Object.freeze({gameOver:"gameOver",leaderboard:"leaderboard",menu:"menu",options:"options",relays:"relays",wellcome:"wellcome"}),te=Object.freeze({blink:"blink",combo:"combo",extra:"extra",fall:"fall",gameOver:"gameOver",idle:"idle",initial:"initial",match:"match",plus:"plus",score:"score"}),Ro=Object.freeze([U.highCombo,U.highScore]),Le=Object.freeze({cards:[],energy:{buffer:0,value:100},[U.leaderboard]:{highCombo:[],highScore:[]},log:[],matchedIndexes:new Set,[U.moves]:"",[U.options]:{[U.playerName]:"",[U.leaderboard]:!0,cluster:!0,rapid:!1,sound:!0},[U.relays]:{active:[...ti],applied:[...ti]},overlay:de.menu,phase:te.initial,plusIndex:null,[U.records]:Ro.reduce((r,e)=>(r[e]={[U.playerName]:"",[U.timestamp]:0,[U.moves]:"",[U.value]:0},r),{}),[U.score]:{buffer:0,value:0}}),{abs:nm,sign:ld,trunc:sm}=Math;function Da(r=0){return(r*16807+19487171)%2147483647}function OS(r){return btoa(String.fromCodePoint(...r))}function im(r){return Array.from(atob(r)).map(e=>e.charCodeAt())}function $S(r){const e=BigInt(Number.MAX_SAFE_INTEGER),t=r.reduce((n,s)=>(n=BigInt(`${n}${s}`),n>e&&(n=n%e),n),0);return Number(t)}function hr(r,e,t=0){const{rapid:n}=r.optionsStore.get(),s=!n&&r.movesInitial===null&&t>0;switch(typeof e){case"undefined":return{duration:s?0:400};case"function":return s?setTimeout(()=>e(r),t):e(r);case"object":return s?{duration:0}:e;default:return s?0:e}}function Nr(r,e,{muteRapid:t=!1}={}){if(!e)return;const{sound:n,rapid:s}=r.optionsStore.get();if(!(t&&s)&&!(!n||r.movesInitial!==null||!r.ready)){if(Array.isArray(e)){e.forEach(i=>i&&i());return}e()}}function La(r,e,t){const n=r.recordsStore.get();n[e][U.value]>=t||(n[e]={[U.moves]:r.movesStore.get(),[U.playerName]:r.optionsStore.get().playerName,[U.timestamp]:r.timestampStore.get(),[U.value]:t},r.recordsStore.set(n))}function io(r){return r<Re.maxValue?r+1:0}function Pl(r){const e=Array.from({length:Re.columns},()=>Array.from({length:2*Re.rows}));return r.forEach(({x:t,y:n},s)=>e[t][n]=s),e}function om(r,e){const t=r.phaseStore.get(),{rapid:n}=r.optionsStore.get(),s=Pl(e),i=[],o=new Set;return s.forEach(l=>{let c=0;l.forEach((d,f)=>{if(d===void 0)return++c;const{x:a,value:u}=e[d],h=n||r.movesInitial||t!==te.fall?0:100*(2*c)**.5;i[d]={x:a,y:f-c,value:u,nextValue:io(u),duration:h},c>0&&h>0&&!o.has(h)&&o.add(h)})}),Nr(r,()=>o.forEach(l=>setTimeout(r.sounds.playKick,l)),{muteRapid:!0}),i}function am(r){const e=Pl(r),t=new Set,n=[],s=(i,o,l)=>{if(t.has(o))return;const{x:c,y:d,value:f}=r[o];l!==void 0&&l!==f||(n[i]||(n[i]={value:f,indexes:new Set}),n[i].indexes.add(o),t.add(o),d<Re.rows-1&&s(i,e[c][d+1],f),c<Re.columns-1&&s(i,e[c+1][d],f),d>0&&s(i,e[c][d-1],f),c>0&&s(i,e[c-1][d],f))};return r.forEach((i,o)=>s(o,o)),n.reduce((i,o)=>(o.value===o.indexes.size&&(i.counts++,i.digits.add(o.value),o.indexes.forEach(i.indexes.add,i.indexes)),i),{counts:0,digits:new Set,indexes:new Set})}function lm(r,e,t){const n=Array.from({length:Re.columns},()=>0),s=i=>n[i]+e.filter(({x:o})=>o===i).sort(({y:o},{y:l})=>l-o)[0].y;return e.map((i,o)=>i.y<Re.rows&&t.has(o)?(++n[i.x],{x:i.x,y:s(i.x),value:r.getNextCardValue(i.x),duration:0}):i)}function Dl(r,e){if(!r.optionsStore.get().cluster)return e;const t=Pl(e);return e.map(n=>({...n,cluster:FS(e,t,n)}))}function FS(r,e,{x:t,y:n,value:s}){const i=n===Re.rows-1?-1:e[t][n+1],o=t===Re.columns-1?-1:e[t+1][n],l=n===0?-1:e[t][n-1],c=t===0?-1:e[t-1][n],d=i>-1?r[i].value:NaN,f=o>-1?r[o].value:NaN,a=l>-1?r[l].value:NaN,u=c>-1?r[c].value:NaN;return{top:d===s,right:f===s,bottom:a===s,left:u===s}}function cm(r){return ld(r)*sm(nm(r)**.5)}function US(r,{buffer:e,value:t}){const n=r.phaseStore.get(),{rapid:s}=r.optionsStore.get(),i=s||r.movesInitial?e:n===te.gameOver?ld(e):cm(e);if(n===te.extra){if(e===0){hr(r,()=>r.phaseStore.set(te.combo),800);return}r.logStore.update(o=>{const l=o.length-1,{extra:c}=o[l];return o[l]={extra:c-i},o})}if(e===0){n===te.gameOver&&Nr(r,()=>setTimeout(r.sounds.playGameOver,600));return}hr(r,()=>{r.energyStore.set({buffer:e-i,value:t+i})},n===te.gameOver?200:32)}function VS(r){setTimeout(()=>r.phaseStore.set(te.idle),0)}function KS(r){if(r.movesInitial!==null){if(r.moveCount<r.movesInitial.length){r.plusIndexStore.set(r.movesInitial[r.moveCount++]),r.energyStore.update(({buffer:e,value:t})=>({buffer:e,value:t-10})),r.phaseStore.set(te.plus);return}r.movesInitial=null,La(r,U.highScore,r.scoreStore.get().value);return}r.cardsStore.update(e=>e.map(t=>({...t,duration:0}))),La(r,U.highScore,r.scoreStore.get().value),Nr(r,r.sounds.reset)}function qS(r){r.plusIndexStore.update(e=>(r.cardsStore.update(t=>Dl(r,t.map((n,s)=>{if(s!==e)return n;const i=io(n.value);return{...n,value:i,nextValue:io(i),duration:0}}))),null)),r.phaseStore.set(te.blink)}function HS(r){const e=r.cardsStore.get();let{counts:t,digits:n,indexes:s}=am(e);r.matchedIndexesStore.set(s);const{value:i}=r.energyStore.get();if(s.size>0){const o=Array.from(s);r.logStore.update(c=>c.concat(o.reduce((d,f)=>{const a=e[f];return d[a.value]=(d[a.value]||0)+a.value,d.sum=(d.sum||0)+a.value,d.counts=t,d.digits=Array.from(n),d},{})));const l=o.reduce((c,d)=>c+e[d].value,0);hr(r,()=>r.energyStore.set({buffer:l,value:i}),400),hr(r,()=>r.phaseStore.set(te.match),800),Nr(r,[r.sounds.playWordUp,r.sounds.playBlink],{muteRapid:!0});return}if(i>100){r.phaseStore.set(te.extra);return}if(r.logStore.get().length>0){r.phaseStore.set(te.combo);return}if(i<10){r.phaseStore.set(te.gameOver);return}r.phaseStore.set(te.idle)}function zS(r){r.matchedIndexesStore.update(e=>(r.cardsStore.update(t=>Dl(r,lm(r,t,e))),new Set)),hr(r,()=>r.phaseStore.set(te.fall),400)}function WS(r){r.cardsStore.update(e=>Dl(r,om(r,e))),hr(r,()=>r.phaseStore.set(te.blink),400)}function GS(r){r.energyStore.update(({value:e})=>({buffer:100-e,value:e})),r.logStore.update(e=>e.concat({extra:100})),Nr(r,r.sounds.playWordUp,{muteRapid:!0})}function um(r){return r.reduce((e,{counts:t,extra:n,sum:s},i)=>e+(i+1)*(s||n)*(t||1),0)}function YS(r){const e=r.logStore.get(),t=um(e);r.scoreStore.update(({value:n})=>({buffer:t,value:n})),La(r,U.highCombo,t),hr(r,()=>r.phaseStore.set(te.score),e.length>1?800:0),Nr(r,r.sounds.playWordUp,{muteRapid:!0})}function XS(r){r.logStore.get().length<2||r.scoreStore.update(e=>({...e}))}function ZS(r){hr(r,()=>{r.energyStore.update(({value:e})=>({buffer:-e,value:e})),r.scoreStore.update(({value:e})=>({buffer:r.energyStore.get().value,value:e}))},400)}const jS={[te.initial]:VS,[te.idle]:KS,[te.plus]:qS,[te.blink]:HS,[te.match]:zS,[te.fall]:WS,[te.extra]:GS,[te.combo]:YS,[te.score]:XS,[te.gameOver]:ZS};function QS(r,e){jS[e](r)}function JS(r,e){if(e===null||r.movesInitial!==null)return;let t=r.movesStore.get();t=Array.isArray(t)?t:im(t),t.push(e),r.movesStore.set(OS(t)),r.energyStore.update(n=>({...n,buffer:-10})),hr(r,()=>r.phaseStore.set(te.plus),400)}function eE(r){switch(nm(r)){case 1:return 130;case 2:case 3:return 80;case 4:case 5:case 6:return 50;case 7:case 8:case 9:case 10:case 11:return 30;default:return 20}}function tE(r,{buffer:e,value:t}){const n=r.phaseStore.get();if(n!==te.gameOver&&n!==te.score)return;if(e===0){if(n===te.gameOver){La(r,U.highScore,t);return}hr(r,()=>{r.logStore.set([]),r.phaseStore.set(r.energyStore.get().value<10?te.gameOver:te.idle),Nr(r,r.sounds.playTurnOn)},200);return}const{rapid:s}=r.optionsStore.get(),i=s||r.movesInitial?e:n===te.gameOver?ld(e):cm(e);hr(r,()=>{r.scoreStore.set({buffer:e-i,value:t+i})},n===te.gameOver?200:eE(i)),Nr(r,r.sounds.playBleep,{muteRapid:!0})}function dm({playerName:r,timestamp:e}){return r&&typeof r=="string"&&e&&typeof e=="number"&&e<1/0&&$S([e,...Array.from(r).map(t=>t.charCodeAt())])}function rE(r){let e=0;const t=[Da(r)];for(;e<Re.columns-1;)t.push(Da(2*t[e++]));return t}function nE(r){let e=rE(r);return t=>{if(t<0||Re.columns-1<t)return;let n=e[t];return e[t]=Da(n),n%10}}function sE(r){return Array.from({length:Re.columns*Re.rows},(e,t,n,s)=>(n=sm(t/Re.columns),s=r.getNextCardValue(n),{x:n,y:t%Re.rows,value:s,nextValue:io(s),duration:0}))}function iE(r,e){for(;;){const t=am(e).indexes;if(t.size===0)return e;const n=lm(r,e,t);e=om(r,n)}}function oE(r,e){if(e==null)return;r.getNextCardValue=nE(e),r.cardsStore.set(Dl(r,iE(r,sE(r))));let t=r.movesStore.get();if(t){if(t=Array.isArray(t)?t:im(t),t.length>0){r.moveCount=0,r.movesInitial=t;return}r.movesInitial=null}}function fm(r){const e=r.recordsStore.get();r[U.highComboPrev]=e[U.highCombo][U.value],r[U.highScorePrev]=e[U.highScore][U.value]}function hm(r,e){return fm(r),r.sounds=e||{},r.getNextCardValue=()=>0,r.moveCount=0,r.movesInitial=null,r.energyStore.subscribe(t=>{US(r,t)}),r.phaseStore.subscribe(t=>{QS(r,t)}),r.plusIndexStore.subscribe(t=>{JS(r,t)}),r.scoreStore.subscribe(t=>{tE(r,t)}),r.seedStore.subscribe(t=>{oE(r,t)}),r}function pm(r,e,t){if(e<0)return r.ready=!0;setTimeout(()=>{r.logStore.set(Le.log),r.plusIndexStore.set(Le.plusIndex),r.matchedIndexesStore.set(Le.matchedIndexes),r.movesStore.set(Le.moves),r.scoreStore.set(Le.score),r.energyStore.set(Le.energy),r.phaseStore.set(Le.phase),r.timestampStore.set(Date.now()),pm(r,--e),t&&r.optionsStore.update(n=>({...n,playerName:t}))},64)}function aE(r,e){fm(r),Nr(r,r.sounds.playGenerate),r.ready=!1,pm(r,8,e)}var lE=se('<div><div class="value"><div> </div> <div> </div></div></div>');function cE(r,e){ft(e,!0);let t=ie(()=>io(e.card.value));var n=lE();let s,i;var o=O(n),l=O(o);let c,d;var f=O(l),a=z(l,2);let u,h;var p=O(a);Pe(()=>{s=Ue(n,1,"card",null,s,{blink:e.blink,focus:e.focus,longpress:e.longpress,plus:e.plus}),Ln(n,"data-index",e.index),i=Ct(n,"",i,{"--card-x":e.card.x,"--card-y":e.card.y,"--card-duration":e.card.duration}),c=Ue(l,1,"current",null,c,{"cluster-top":e.card.cluster&&e.card.cluster.top,"cluster-right":e.card.cluster&&e.card.cluster.right,"cluster-bottom":e.card.cluster&&e.card.cluster.bottom,"cluster-left":e.card.cluster&&e.card.cluster.left,"only-shadow":e.card.y===5}),d=Ct(l,"",d,{"--color":`var(--color-${e.card.value??""})`}),He(f,e.card.value),u=Ue(a,1,"next",null,u,{"only-shadow":e.card.y===5}),h=Ct(a,"",h,{"--color":`var(--color-${b(t)??""})`}),He(p,b(t))}),J(r,n),ht()}var Ti=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function cd(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var nc={};var th;function uE(){return th||(th=1,(function(r){(function(){var e=function(){this.init()};e.prototype={init:function(){var a=this||t;return a._counter=1e3,a._html5AudioPool=[],a.html5PoolSize=10,a._codecs={},a._howls=[],a._muted=!1,a._volume=1,a._canPlayEvent="canplaythrough",a._navigator=typeof window<"u"&&window.navigator?window.navigator:null,a.masterGain=null,a.noAudio=!1,a.usingWebAudio=!0,a.autoSuspend=!0,a.ctx=null,a.autoUnlock=!0,a._setup(),a},volume:function(a){var u=this||t;if(a=parseFloat(a),u.ctx||f(),typeof a<"u"&&a>=0&&a<=1){if(u._volume=a,u._muted)return u;u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a,t.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.volume=g._volume*a)}return u}return u._volume},mute:function(a){var u=this||t;u.ctx||f(),u._muted=a,u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a?0:u._volume,t.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.muted=a?!0:g._muted)}return u},stop:function(){for(var a=this||t,u=0;u<a._howls.length;u++)a._howls[u].stop();return a},unload:function(){for(var a=this||t,u=a._howls.length-1;u>=0;u--)a._howls[u].unload();return a.usingWebAudio&&a.ctx&&typeof a.ctx.close<"u"&&(a.ctx.close(),a.ctx=null,f()),a},codecs:function(a){return(this||t)._codecs[a.replace(/^x-/,"")]},_setup:function(){var a=this||t;if(a.state=a.ctx&&a.ctx.state||"suspended",a._autoSuspend(),!a.usingWebAudio)if(typeof Audio<"u")try{var u=new Audio;typeof u.oncanplaythrough>"u"&&(a._canPlayEvent="canplay")}catch{a.noAudio=!0}else a.noAudio=!0;try{var u=new Audio;u.muted&&(a.noAudio=!0)}catch{}return a.noAudio||a._setupCodecs(),a},_setupCodecs:function(){var a=this||t,u=null;try{u=typeof Audio<"u"?new Audio:null}catch{return a}if(!u||typeof u.canPlayType!="function")return a;var h=u.canPlayType("audio/mpeg;").replace(/^no$/,""),p=a._navigator?a._navigator.userAgent:"",y=p.match(/OPR\/(\d+)/g),g=y&&parseInt(y[0].split("/")[1],10)<33,m=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,w=p.match(/Version\/(.*?) /),v=m&&w&&parseInt(w[1],10)<15;return a._codecs={mp3:!!(!g&&(h||u.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!h,opus:!!u.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(u.canPlayType('audio/wav; codecs="1"')||u.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!u.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!u.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(u.canPlayType("audio/x-m4a;")||u.canPlayType("audio/m4a;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(u.canPlayType("audio/x-m4b;")||u.canPlayType("audio/m4b;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(u.canPlayType("audio/x-mp4;")||u.canPlayType("audio/mp4;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!v&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!v&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!u.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(u.canPlayType("audio/x-flac;")||u.canPlayType("audio/flac;")).replace(/^no$/,"")},a},_unlockAudio:function(){var a=this||t;if(!(a._audioUnlocked||!a.ctx)){a._audioUnlocked=!1,a.autoUnlock=!1,!a._mobileUnloaded&&a.ctx.sampleRate!==44100&&(a._mobileUnloaded=!0,a.unload()),a._scratchBuffer=a.ctx.createBuffer(1,1,22050);var u=function(h){for(;a._html5AudioPool.length<a.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,a._releaseHtml5Audio(p)}catch{a.noAudio=!0;break}for(var y=0;y<a._howls.length;y++)if(!a._howls[y]._webAudio)for(var g=a._howls[y]._getSoundIds(),m=0;m<g.length;m++){var w=a._howls[y]._soundById(g[m]);w&&w._node&&!w._node._unlocked&&(w._node._unlocked=!0,w._node.load())}a._autoResume();var v=a.ctx.createBufferSource();v.buffer=a._scratchBuffer,v.connect(a.ctx.destination),typeof v.start>"u"?v.noteOn(0):v.start(0),typeof a.ctx.resume=="function"&&a.ctx.resume(),v.onended=function(){v.disconnect(0),a._audioUnlocked=!0,document.removeEventListener("touchstart",u,!0),document.removeEventListener("touchend",u,!0),document.removeEventListener("click",u,!0),document.removeEventListener("keydown",u,!0);for(var _=0;_<a._howls.length;_++)a._howls[_]._emit("unlock")}};return document.addEventListener("touchstart",u,!0),document.addEventListener("touchend",u,!0),document.addEventListener("click",u,!0),document.addEventListener("keydown",u,!0),a}},_obtainHtml5Audio:function(){var a=this||t;if(a._html5AudioPool.length)return a._html5AudioPool.pop();var u=new Audio().play();return u&&typeof Promise<"u"&&(u instanceof Promise||typeof u.then=="function")&&u.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(a){var u=this||t;return a._unlocked&&u._html5AudioPool.push(a),u},_autoSuspend:function(){var a=this;if(!(!a.autoSuspend||!a.ctx||typeof a.ctx.suspend>"u"||!t.usingWebAudio)){for(var u=0;u<a._howls.length;u++)if(a._howls[u]._webAudio){for(var h=0;h<a._howls[u]._sounds.length;h++)if(!a._howls[u]._sounds[h]._paused)return a}return a._suspendTimer&&clearTimeout(a._suspendTimer),a._suspendTimer=setTimeout(function(){if(a.autoSuspend){a._suspendTimer=null,a.state="suspending";var p=function(){a.state="suspended",a._resumeAfterSuspend&&(delete a._resumeAfterSuspend,a._autoResume())};a.ctx.suspend().then(p,p)}},3e4),a}},_autoResume:function(){var a=this;if(!(!a.ctx||typeof a.ctx.resume>"u"||!t.usingWebAudio))return a.state==="running"&&a.ctx.state!=="interrupted"&&a._suspendTimer?(clearTimeout(a._suspendTimer),a._suspendTimer=null):a.state==="suspended"||a.state==="running"&&a.ctx.state==="interrupted"?(a.ctx.resume().then(function(){a.state="running";for(var u=0;u<a._howls.length;u++)a._howls[u]._emit("resume")}),a._suspendTimer&&(clearTimeout(a._suspendTimer),a._suspendTimer=null)):a.state==="suspending"&&(a._resumeAfterSuspend=!0),a}};var t=new e,n=function(a){var u=this;if(!a.src||a.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}u.init(a)};n.prototype={init:function(a){var u=this;return t.ctx||f(),u._autoplay=a.autoplay||!1,u._format=typeof a.format!="string"?a.format:[a.format],u._html5=a.html5||!1,u._muted=a.mute||!1,u._loop=a.loop||!1,u._pool=a.pool||5,u._preload=typeof a.preload=="boolean"||a.preload==="metadata"?a.preload:!0,u._rate=a.rate||1,u._sprite=a.sprite||{},u._src=typeof a.src!="string"?a.src:[a.src],u._volume=a.volume!==void 0?a.volume:1,u._xhr={method:a.xhr&&a.xhr.method?a.xhr.method:"GET",headers:a.xhr&&a.xhr.headers?a.xhr.headers:null,withCredentials:a.xhr&&a.xhr.withCredentials?a.xhr.withCredentials:!1},u._duration=0,u._state="unloaded",u._sounds=[],u._endTimers={},u._queue=[],u._playLock=!1,u._onend=a.onend?[{fn:a.onend}]:[],u._onfade=a.onfade?[{fn:a.onfade}]:[],u._onload=a.onload?[{fn:a.onload}]:[],u._onloaderror=a.onloaderror?[{fn:a.onloaderror}]:[],u._onplayerror=a.onplayerror?[{fn:a.onplayerror}]:[],u._onpause=a.onpause?[{fn:a.onpause}]:[],u._onplay=a.onplay?[{fn:a.onplay}]:[],u._onstop=a.onstop?[{fn:a.onstop}]:[],u._onmute=a.onmute?[{fn:a.onmute}]:[],u._onvolume=a.onvolume?[{fn:a.onvolume}]:[],u._onrate=a.onrate?[{fn:a.onrate}]:[],u._onseek=a.onseek?[{fn:a.onseek}]:[],u._onunlock=a.onunlock?[{fn:a.onunlock}]:[],u._onresume=[],u._webAudio=t.usingWebAudio&&!u._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(u),u._autoplay&&u._queue.push({event:"play",action:function(){u.play()}}),u._preload&&u._preload!=="none"&&u.load(),u},load:function(){var a=this,u=null;if(t.noAudio){a._emit("loaderror",null,"No audio support.");return}typeof a._src=="string"&&(a._src=[a._src]);for(var h=0;h<a._src.length;h++){var p,y;if(a._format&&a._format[h])p=a._format[h];else{if(y=a._src[h],typeof y!="string"){a._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(y),p||(p=/\.([^.]+)$/.exec(y.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&t.codecs(p)){u=a._src[h];break}}if(!u){a._emit("loaderror",null,"No codec support for selected audio sources.");return}return a._src=u,a._state="loading",window.location.protocol==="https:"&&u.slice(0,5)==="http:"&&(a._html5=!0,a._webAudio=!1),new s(a),a._webAudio&&o(a),a},play:function(a,u){var h=this,p=null;if(typeof a=="number")p=a,a=null;else{if(typeof a=="string"&&h._state==="loaded"&&!h._sprite[a])return null;if(typeof a>"u"&&(a="__default",!h._playLock)){for(var y=0,g=0;g<h._sounds.length;g++)h._sounds[g]._paused&&!h._sounds[g]._ended&&(y++,p=h._sounds[g]._id);y===1?a=null:p=null}}var m=p?h._soundById(p):h._inactiveSound();if(!m)return null;if(p&&!a&&(a=m._sprite||"__default"),h._state!=="loaded"){m._sprite=a,m._ended=!1;var w=m._id;return h._queue.push({event:"play",action:function(){h.play(w)}}),w}if(p&&!m._paused)return u||h._loadQueue("play"),m._id;h._webAudio&&t._autoResume();var v=Math.max(0,m._seek>0?m._seek:h._sprite[a][0]/1e3),_=Math.max(0,(h._sprite[a][0]+h._sprite[a][1])/1e3-v),k=_*1e3/Math.abs(m._rate),P=h._sprite[a][0]/1e3,D=(h._sprite[a][0]+h._sprite[a][1])/1e3;m._sprite=a,m._ended=!1;var I=function(){m._paused=!1,m._seek=v,m._start=P,m._stop=D,m._loop=!!(m._loop||h._sprite[a][2])};if(v>=D){h._ended(m);return}var x=m._node;if(h._webAudio){var B=function(){h._playLock=!1,I(),h._refreshBuffer(m);var E=m._muted||h._muted?0:m._volume;x.gain.setValueAtTime(E,t.ctx.currentTime),m._playStart=t.ctx.currentTime,typeof x.bufferSource.start>"u"?m._loop?x.bufferSource.noteGrainOn(0,v,86400):x.bufferSource.noteGrainOn(0,v,_):m._loop?x.bufferSource.start(0,v,86400):x.bufferSource.start(0,v,_),k!==1/0&&(h._endTimers[m._id]=setTimeout(h._ended.bind(h,m),k)),u||setTimeout(function(){h._emit("play",m._id),h._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?B():(h._playLock=!0,h.once("resume",B),h._clearTimer(m._id))}else{var Q=function(){x.currentTime=v,x.muted=m._muted||h._muted||t._muted||x.muted,x.volume=m._volume*t.volume(),x.playbackRate=m._rate;try{var E=x.play();if(E&&typeof Promise<"u"&&(E instanceof Promise||typeof E.then=="function")?(h._playLock=!0,I(),E.then(function(){h._playLock=!1,x._unlocked=!0,u?h._loadQueue():h._emit("play",m._id)}).catch(function(){h._playLock=!1,h._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),m._ended=!0,m._paused=!0})):u||(h._playLock=!1,I(),h._emit("play",m._id)),x.playbackRate=m._rate,x.paused){h._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}a!=="__default"||m._loop?h._endTimers[m._id]=setTimeout(h._ended.bind(h,m),k):(h._endTimers[m._id]=function(){h._ended(m),x.removeEventListener("ended",h._endTimers[m._id],!1)},x.addEventListener("ended",h._endTimers[m._id],!1))}catch(S){h._emit("playerror",m._id,S)}};x.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(x.src=h._src,x.load());var M=window&&window.ejecta||!x.readyState&&t._navigator.isCocoonJS;if(x.readyState>=3||M)Q();else{h._playLock=!0,h._state="loading";var A=function(){h._state="loaded",Q(),x.removeEventListener(t._canPlayEvent,A,!1)};x.addEventListener(t._canPlayEvent,A,!1),h._clearTimer(m._id)}}return m._id},pause:function(a){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"pause",action:function(){u.pause(a)}}),u;for(var h=u._getSoundIds(a),p=0;p<h.length;p++){u._clearTimer(h[p]);var y=u._soundById(h[p]);if(y&&!y._paused&&(y._seek=u.seek(h[p]),y._rateSeek=0,y._paused=!0,u._stopFade(h[p]),y._node))if(u._webAudio){if(!y._node.bufferSource)continue;typeof y._node.bufferSource.stop>"u"?y._node.bufferSource.noteOff(0):y._node.bufferSource.stop(0),u._cleanBuffer(y._node)}else(!isNaN(y._node.duration)||y._node.duration===1/0)&&y._node.pause();arguments[1]||u._emit("pause",y?y._id:null)}return u},stop:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"stop",action:function(){h.stop(a)}}),h;for(var p=h._getSoundIds(a),y=0;y<p.length;y++){h._clearTimer(p[y]);var g=h._soundById(p[y]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,h._stopFade(p[y]),g._node&&(h._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),h._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&h._clearSound(g._node))),u||h._emit("stop",g._id))}return h},mute:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"mute",action:function(){h.mute(a,u)}}),h;if(typeof u>"u")if(typeof a=="boolean")h._muted=a;else return h._muted;for(var p=h._getSoundIds(u),y=0;y<p.length;y++){var g=h._soundById(p[y]);g&&(g._muted=a,g._interval&&h._stopFade(g._id),h._webAudio&&g._node?g._node.gain.setValueAtTime(a?0:g._volume,t.ctx.currentTime):g._node&&(g._node.muted=t._muted?!0:a),h._emit("mute",g._id))}return h},volume:function(){var a=this,u=arguments,h,p;if(u.length===0)return a._volume;if(u.length===1||u.length===2&&typeof u[1]>"u"){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length>=2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var m;if(typeof h<"u"&&h>=0&&h<=1){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"volume",action:function(){a.volume.apply(a,u)}}),a;typeof p>"u"&&(a._volume=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)m=a._soundById(p[w]),m&&(m._volume=h,u[2]||a._stopFade(p[w]),a._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(h,t.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=h*t.volume()),a._emit("volume",m._id))}else return m=p?a._soundById(p):a._sounds[0],m?m._volume:0;return a},fade:function(a,u,h,p){var y=this;if(y._state!=="loaded"||y._playLock)return y._queue.push({event:"fade",action:function(){y.fade(a,u,h,p)}}),y;a=Math.min(Math.max(0,parseFloat(a)),1),u=Math.min(Math.max(0,parseFloat(u)),1),h=parseFloat(h),y.volume(a,p);for(var g=y._getSoundIds(p),m=0;m<g.length;m++){var w=y._soundById(g[m]);if(w){if(p||y._stopFade(g[m]),y._webAudio&&!w._muted){var v=t.ctx.currentTime,_=v+h/1e3;w._volume=a,w._node.gain.setValueAtTime(a,v),w._node.gain.linearRampToValueAtTime(u,_)}y._startFadeInterval(w,a,u,h,g[m],typeof p>"u")}}return y},_startFadeInterval:function(a,u,h,p,y,g){var m=this,w=u,v=h-u,_=Math.abs(v/.01),k=Math.max(4,_>0?p/_:p),P=Date.now();a._fadeTo=h,a._interval=setInterval(function(){var D=(Date.now()-P)/p;P=Date.now(),w+=v*D,w=Math.round(w*100)/100,v<0?w=Math.max(h,w):w=Math.min(h,w),m._webAudio?a._volume=w:m.volume(w,a._id,!0),g&&(m._volume=w),(h<u&&w<=h||h>u&&w>=h)&&(clearInterval(a._interval),a._interval=null,a._fadeTo=null,m.volume(h,a._id),m._emit("fade",a._id))},k)},_stopFade:function(a){var u=this,h=u._soundById(a);return h&&h._interval&&(u._webAudio&&h._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(h._interval),h._interval=null,u.volume(h._fadeTo,a),h._fadeTo=null,u._emit("fade",a)),u},loop:function(){var a=this,u=arguments,h,p,y;if(u.length===0)return a._loop;if(u.length===1)if(typeof u[0]=="boolean")h=u[0],a._loop=h;else return y=a._soundById(parseInt(u[0],10)),y?y._loop:!1;else u.length===2&&(h=u[0],p=parseInt(u[1],10));for(var g=a._getSoundIds(p),m=0;m<g.length;m++)y=a._soundById(g[m]),y&&(y._loop=h,a._webAudio&&y._node&&y._node.bufferSource&&(y._node.bufferSource.loop=h,h&&(y._node.bufferSource.loopStart=y._start||0,y._node.bufferSource.loopEnd=y._stop,a.playing(g[m])&&(a.pause(g[m],!0),a.play(g[m],!0)))));return a},rate:function(){var a=this,u=arguments,h,p;if(u.length===0)p=a._sounds[0]._id;else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var m;if(typeof h=="number"){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"rate",action:function(){a.rate.apply(a,u)}}),a;typeof p>"u"&&(a._rate=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)if(m=a._soundById(p[w]),m){a.playing(p[w])&&(m._rateSeek=a.seek(p[w]),m._playStart=a._webAudio?t.ctx.currentTime:m._playStart),m._rate=h,a._webAudio&&m._node&&m._node.bufferSource?m._node.bufferSource.playbackRate.setValueAtTime(h,t.ctx.currentTime):m._node&&(m._node.playbackRate=h);var v=a.seek(p[w]),_=(a._sprite[m._sprite][0]+a._sprite[m._sprite][1])/1e3-v,k=_*1e3/Math.abs(m._rate);(a._endTimers[p[w]]||!m._paused)&&(a._clearTimer(p[w]),a._endTimers[p[w]]=setTimeout(a._ended.bind(a,m),k)),a._emit("rate",m._id)}}else return m=a._soundById(p),m?m._rate:a._rate;return a},seek:function(){var a=this,u=arguments,h,p;if(u.length===0)a._sounds.length&&(p=a._sounds[0]._id);else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):a._sounds.length&&(p=a._sounds[0]._id,h=parseFloat(u[0]))}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));if(typeof p>"u")return 0;if(typeof h=="number"&&(a._state!=="loaded"||a._playLock))return a._queue.push({event:"seek",action:function(){a.seek.apply(a,u)}}),a;var m=a._soundById(p);if(m)if(typeof h=="number"&&h>=0){var w=a.playing(p);w&&a.pause(p,!0),m._seek=h,m._ended=!1,a._clearTimer(p),!a._webAudio&&m._node&&!isNaN(m._node.duration)&&(m._node.currentTime=h);var v=function(){w&&a.play(p,!0),a._emit("seek",p)};if(w&&!a._webAudio){var _=function(){a._playLock?setTimeout(_,0):v()};setTimeout(_,0)}else v()}else if(a._webAudio){var k=a.playing(p)?t.ctx.currentTime-m._playStart:0,P=m._rateSeek?m._rateSeek-m._seek:0;return m._seek+(P+k*Math.abs(m._rate))}else return m._node.currentTime;return a},playing:function(a){var u=this;if(typeof a=="number"){var h=u._soundById(a);return h?!h._paused:!1}for(var p=0;p<u._sounds.length;p++)if(!u._sounds[p]._paused)return!0;return!1},duration:function(a){var u=this,h=u._duration,p=u._soundById(a);return p&&(h=u._sprite[p._sprite][1]/1e3),h},state:function(){return this._state},unload:function(){for(var a=this,u=a._sounds,h=0;h<u.length;h++)u[h]._paused||a.stop(u[h]._id),a._webAudio||(a._clearSound(u[h]._node),u[h]._node.removeEventListener("error",u[h]._errorFn,!1),u[h]._node.removeEventListener(t._canPlayEvent,u[h]._loadFn,!1),u[h]._node.removeEventListener("ended",u[h]._endFn,!1),t._releaseHtml5Audio(u[h]._node)),delete u[h]._node,a._clearTimer(u[h]._id);var p=t._howls.indexOf(a);p>=0&&t._howls.splice(p,1);var y=!0;for(h=0;h<t._howls.length;h++)if(t._howls[h]._src===a._src||a._src.indexOf(t._howls[h]._src)>=0){y=!1;break}return i&&y&&delete i[a._src],t.noAudio=!1,a._state="unloaded",a._sounds=[],a=null,null},on:function(a,u,h,p){var y=this,g=y["_on"+a];return typeof u=="function"&&g.push(p?{id:h,fn:u,once:p}:{id:h,fn:u}),y},off:function(a,u,h){var p=this,y=p["_on"+a],g=0;if(typeof u=="number"&&(h=u,u=null),u||h)for(g=0;g<y.length;g++){var m=h===y[g].id;if(u===y[g].fn&&m||!u&&m){y.splice(g,1);break}}else if(a)p["_on"+a]=[];else{var w=Object.keys(p);for(g=0;g<w.length;g++)w[g].indexOf("_on")===0&&Array.isArray(p[w[g]])&&(p[w[g]]=[])}return p},once:function(a,u,h){var p=this;return p.on(a,u,h,1),p},_emit:function(a,u,h){for(var p=this,y=p["_on"+a],g=y.length-1;g>=0;g--)(!y[g].id||y[g].id===u||a==="load")&&(setTimeout(function(m){m.call(this,u,h)}.bind(p,y[g].fn),0),y[g].once&&p.off(a,y[g].fn,y[g].id));return p._loadQueue(a),p},_loadQueue:function(a){var u=this;if(u._queue.length>0){var h=u._queue[0];h.event===a&&(u._queue.shift(),u._loadQueue()),a||h.action()}return u},_ended:function(a){var u=this,h=a._sprite;if(!u._webAudio&&a._node&&!a._node.paused&&!a._node.ended&&a._node.currentTime<a._stop)return setTimeout(u._ended.bind(u,a),100),u;var p=!!(a._loop||u._sprite[h][2]);if(u._emit("end",a._id),!u._webAudio&&p&&u.stop(a._id,!0).play(a._id),u._webAudio&&p){u._emit("play",a._id),a._seek=a._start||0,a._rateSeek=0,a._playStart=t.ctx.currentTime;var y=(a._stop-a._start)*1e3/Math.abs(a._rate);u._endTimers[a._id]=setTimeout(u._ended.bind(u,a),y)}return u._webAudio&&!p&&(a._paused=!0,a._ended=!0,a._seek=a._start||0,a._rateSeek=0,u._clearTimer(a._id),u._cleanBuffer(a._node),t._autoSuspend()),!u._webAudio&&!p&&u.stop(a._id,!0),u},_clearTimer:function(a){var u=this;if(u._endTimers[a]){if(typeof u._endTimers[a]!="function")clearTimeout(u._endTimers[a]);else{var h=u._soundById(a);h&&h._node&&h._node.removeEventListener("ended",u._endTimers[a],!1)}delete u._endTimers[a]}return u},_soundById:function(a){for(var u=this,h=0;h<u._sounds.length;h++)if(a===u._sounds[h]._id)return u._sounds[h];return null},_inactiveSound:function(){var a=this;a._drain();for(var u=0;u<a._sounds.length;u++)if(a._sounds[u]._ended)return a._sounds[u].reset();return new s(a)},_drain:function(){var a=this,u=a._pool,h=0,p=0;if(!(a._sounds.length<u)){for(p=0;p<a._sounds.length;p++)a._sounds[p]._ended&&h++;for(p=a._sounds.length-1;p>=0;p--){if(h<=u)return;a._sounds[p]._ended&&(a._webAudio&&a._sounds[p]._node&&a._sounds[p]._node.disconnect(0),a._sounds.splice(p,1),h--)}}},_getSoundIds:function(a){var u=this;if(typeof a>"u"){for(var h=[],p=0;p<u._sounds.length;p++)h.push(u._sounds[p]._id);return h}else return[a]},_refreshBuffer:function(a){var u=this;return a._node.bufferSource=t.ctx.createBufferSource(),a._node.bufferSource.buffer=i[u._src],a._panner?a._node.bufferSource.connect(a._panner):a._node.bufferSource.connect(a._node),a._node.bufferSource.loop=a._loop,a._loop&&(a._node.bufferSource.loopStart=a._start||0,a._node.bufferSource.loopEnd=a._stop||0),a._node.bufferSource.playbackRate.setValueAtTime(a._rate,t.ctx.currentTime),u},_cleanBuffer:function(a){var u=this,h=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!a.bufferSource)return u;if(t._scratchBuffer&&a.bufferSource&&(a.bufferSource.onended=null,a.bufferSource.disconnect(0),h))try{a.bufferSource.buffer=t._scratchBuffer}catch{}return a.bufferSource=null,u},_clearSound:function(a){var u=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);u||(a.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(a){this._parent=a,this.init()};s.prototype={init:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++t._counter,u._sounds.push(a),a.create(),a},create:function(){var a=this,u=a._parent,h=t._muted||a._muted||a._parent._muted?0:a._volume;return u._webAudio?(a._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),a._node.gain.setValueAtTime(h,t.ctx.currentTime),a._node.paused=!0,a._node.connect(t.masterGain)):t.noAudio||(a._node=t._obtainHtml5Audio(),a._errorFn=a._errorListener.bind(a),a._node.addEventListener("error",a._errorFn,!1),a._loadFn=a._loadListener.bind(a),a._node.addEventListener(t._canPlayEvent,a._loadFn,!1),a._endFn=a._endListener.bind(a),a._node.addEventListener("ended",a._endFn,!1),a._node.src=u._src,a._node.preload=u._preload===!0?"auto":u._preload,a._node.volume=h*t.volume(),a._node.load()),a},reset:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._rateSeek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++t._counter,a},_errorListener:function(){var a=this;a._parent._emit("loaderror",a._id,a._node.error?a._node.error.code:0),a._node.removeEventListener("error",a._errorFn,!1)},_loadListener:function(){var a=this,u=a._parent;u._duration=Math.ceil(a._node.duration*10)/10,Object.keys(u._sprite).length===0&&(u._sprite={__default:[0,u._duration*1e3]}),u._state!=="loaded"&&(u._state="loaded",u._emit("load"),u._loadQueue()),a._node.removeEventListener(t._canPlayEvent,a._loadFn,!1)},_endListener:function(){var a=this,u=a._parent;u._duration===1/0&&(u._duration=Math.ceil(a._node.duration*10)/10,u._sprite.__default[1]===1/0&&(u._sprite.__default[1]=u._duration*1e3),u._ended(a)),a._node.removeEventListener("ended",a._endFn,!1)}};var i={},o=function(a){var u=a._src;if(i[u]){a._duration=i[u].duration,d(a);return}if(/^data:[^;]+;base64,/.test(u)){for(var h=atob(u.split(",")[1]),p=new Uint8Array(h.length),y=0;y<h.length;++y)p[y]=h.charCodeAt(y);c(p.buffer,a)}else{var g=new XMLHttpRequest;g.open(a._xhr.method,u,!0),g.withCredentials=a._xhr.withCredentials,g.responseType="arraybuffer",a._xhr.headers&&Object.keys(a._xhr.headers).forEach(function(m){g.setRequestHeader(m,a._xhr.headers[m])}),g.onload=function(){var m=(g.status+"")[0];if(m!=="0"&&m!=="2"&&m!=="3"){a._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}c(g.response,a)},g.onerror=function(){a._webAudio&&(a._html5=!0,a._webAudio=!1,a._sounds=[],delete i[u],a.load())},l(g)}},l=function(a){try{a.send()}catch{a.onerror()}},c=function(a,u){var h=function(){u._emit("loaderror",null,"Decoding audio data failed.")},p=function(y){y&&u._sounds.length>0?(i[u._src]=y,d(u,y)):h()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(a).then(p).catch(h):t.ctx.decodeAudioData(a,p,h)},d=function(a,u){u&&!a._duration&&(a._duration=u.duration),Object.keys(a._sprite).length===0&&(a._sprite={__default:[0,a._duration*1e3]}),a._state!=="loaded"&&(a._state="loaded",a._emit("load"),a._loadQueue())},f=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var a=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),u=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),h=u?parseInt(u[1],10):null;if(a&&h&&h<9){var p=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!p&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};r.Howler=t,r.Howl=n,typeof Ti<"u"?(Ti.HowlerGlobal=e,Ti.Howler=t,Ti.Howl=n,Ti.Sound=s):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=n,window.Sound=s)})();(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var s=n._howls.length-1;s>=0;s--)n._howls[s].stereo(t);return n},HowlerGlobal.prototype.pos=function(t,n,s){var i=this;if(!i.ctx||!i.ctx.listener)return i;if(n=typeof n!="number"?i._pos[1]:n,s=typeof s!="number"?i._pos[2]:s,typeof t=="number")i._pos=[t,n,s],typeof i.ctx.listener.positionX<"u"?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]);else return i._pos;return i},HowlerGlobal.prototype.orientation=function(t,n,s,i,o,l){var c=this;if(!c.ctx||!c.ctx.listener)return c;var d=c._orientation;if(n=typeof n!="number"?d[1]:n,s=typeof s!="number"?d[2]:s,i=typeof i!="number"?d[3]:i,o=typeof o!="number"?d[4]:o,l=typeof l!="number"?d[5]:l,typeof t=="number")c._orientation=[t,n,s,i,o,l],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(l,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(t,n,s,i,o,l);else return d;return c},Howl.prototype.init=(function(t){return function(n){var s=this;return s._orientation=n.orientation||[1,0,0],s._stereo=n.stereo||null,s._pos=n.pos||null,s._pannerAttr={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:360,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:360,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:0,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:"inverse",maxDistance:typeof n.maxDistance<"u"?n.maxDistance:1e4,panningModel:typeof n.panningModel<"u"?n.panningModel:"HRTF",refDistance:typeof n.refDistance<"u"?n.refDistance:1,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:1},s._onstereo=n.onstereo?[{fn:n.onstereo}]:[],s._onpos=n.onpos?[{fn:n.onpos}]:[],s._onorientation=n.onorientation?[{fn:n.onorientation}]:[],t.call(this,n)}})(Howl.prototype.init),Howl.prototype.stereo=function(t,n){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(t,n)}}),s;var i=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof n>"u")if(typeof t=="number")s._stereo=t,s._pos=[t,0,0];else return s._stereo;for(var o=s._getSoundIds(n),l=0;l<o.length;l++){var c=s._soundById(o[l]);if(c)if(typeof t=="number")c._stereo=t,c._pos=[t,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&e(c,i),i==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(t,0,0):c._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",c._id);else return c._stereo}return s},Howl.prototype.pos=function(t,n,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(t,n,s,i)}}),o;if(n=typeof n!="number"?0:n,s=typeof s!="number"?-.5:s,typeof i>"u")if(typeof t=="number")o._pos=[t,n,s];else return o._pos;for(var l=o._getSoundIds(i),c=0;c<l.length;c++){var d=o._soundById(l[c]);if(d)if(typeof t=="number")d._pos=[t,n,s],d._node&&((!d._panner||d._panner.pan)&&e(d,"spatial"),typeof d._panner.positionX<"u"?(d._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),d._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setPosition(t,n,s)),o._emit("pos",d._id);else return d._pos}return o},Howl.prototype.orientation=function(t,n,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(t,n,s,i)}}),o;if(n=typeof n!="number"?o._orientation[1]:n,s=typeof s!="number"?o._orientation[2]:s,typeof i>"u")if(typeof t=="number")o._orientation=[t,n,s];else return o._orientation;for(var l=o._getSoundIds(i),c=0;c<l.length;c++){var d=o._soundById(l[c]);if(d)if(typeof t=="number")d._orientation=[t,n,s],d._node&&(d._panner||(d._pos||(d._pos=o._pos||[0,0,-.5]),e(d,"spatial")),typeof d._panner.orientationX<"u"?(d._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),d._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setOrientation(t,n,s)),o._emit("orientation",d._id);else return d._orientation}return o},Howl.prototype.pannerAttr=function(){var t=this,n=arguments,s,i,o;if(!t._webAudio)return t;if(n.length===0)return t._pannerAttr;if(n.length===1)if(typeof n[0]=="object")s=n[0],typeof i>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),t._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:t._panningModel});else return o=t._soundById(parseInt(n[0],10)),o?o._pannerAttr:t._pannerAttr;else n.length===2&&(s=n[0],i=parseInt(n[1],10));for(var l=t._getSoundIds(i),c=0;c<l.length;c++)if(o=t._soundById(l[c]),o){var d=o._pannerAttr;d={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:d.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:d.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:d.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:d.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:d.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:d.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:d.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:d.panningModel};var f=o._panner;f||(o._pos||(o._pos=t._pos||[0,0,-.5]),e(o,"spatial"),f=o._panner),f.coneInnerAngle=d.coneInnerAngle,f.coneOuterAngle=d.coneOuterAngle,f.coneOuterGain=d.coneOuterGain,f.distanceModel=d.distanceModel,f.maxDistance=d.maxDistance,f.refDistance=d.refDistance,f.rolloffFactor=d.rolloffFactor,f.panningModel=d.panningModel}return t},Sound.prototype.init=(function(t){return function(){var n=this,s=n._parent;n._orientation=s._orientation,n._stereo=s._stereo,n._pos=s._pos,n._pannerAttr=s._pannerAttr,t.call(this),n._stereo?s.stereo(n._stereo):n._pos&&s.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(t){return function(){var n=this,s=n._parent;return n._orientation=s._orientation,n._stereo=s._stereo,n._pos=s._pos,n._pannerAttr=s._pannerAttr,n._stereo?s.stereo(n._stereo):n._pos?s.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,s._refreshBuffer(n)),t.call(this)}})(Sound.prototype.reset);var e=function(t,n){n=n||"spatial",n==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(nc)),nc}var Ut=uE();const{random:su,round:dE}=Math,gm=.6,et={bleep:new Ut.Howl({src:"/sounds/bleep.wav"}),blink:new Ut.Howl({src:"/sounds/blink.wav",rate:gm}),gameOver:new Ut.Howl({src:"/sounds/game-over.wav"}),generate:new Ut.Howl({src:"/sounds/generate.wav"}),hit:new Ut.Howl({src:"/sounds/hit.wav"}),kicks:[new Ut.Howl({src:"/sounds/kick-1.wav"}),new Ut.Howl({src:"/sounds/kick-2.wav"})],lowEnergy:new Ut.Howl({src:"/sounds/low-energy.wav"}),plus:new Ut.Howl({src:"/sounds/plus.wav"}),slideIn:new Ut.Howl({src:"/sounds/slide-in.wav"}),slideMove:new Ut.Howl({src:"/sounds/slide-move.wav"}),slideOut:new Ut.Howl({src:"/sounds/slide-out.wav"}),turnOn:new Ut.Howl({src:"/sounds/turn-on.wav"}),wordUp:new Ut.Howl({src:"/sounds/word-up.wav"})};function fE(){et.bleep.play()}function hE(){const r=(e=.02)=>{et.blink.rate(et.blink.rate()+e),et.blink.play()};r(),setTimeout(r,200),setTimeout(()=>r(.04),400)}function mm(){et.lowEnergy.play()}function ym(){et.plus.play()}function pE(){et.gameOver.play()}function gE(){et.generate.play()}function bm(r=0){et.hit.rate(1-(r||10)/36),et.hit.play()}function mE(){const r=et.kicks[dE(su())];r.rate(1-(su()-.5)/2),r.play()}function yE(){et.newRecord.play()}function iu(){et.slideIn.play()}function ou(r=0){et.slideMove.rate(1+r/27),et.slideMove.play()}function vm(){et.slideOut.play()}function bE(){et.turnOn.rate(1-(su()-.5)/10),et.turnOn.play()}function wm(){et.wordUp.play()}function vE(){et.blink.rate(gm)}const wE=Object.freeze(Object.defineProperty({__proto__:null,playBleep:fE,playBlink:hE,playGameOver:pE,playGenerate:gE,playHit:bm,playKick:mE,playLowEnergy:mm,playNewRecord:yE,playPlus:ym,playSlideIn:iu,playSlideMove:ou,playSlideOut:vm,playTurnOn:bE,playWordUp:wm,reset:vE},Symbol.toStringTag,{value:"Module"})),qr="/",_m=new TextEncoder().encode(qr),Zo=_m[0];class je{_buf;constructor(e,t){if(typeof e=="string")this._buf=j(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Zo)throw new Error("Invalid key")}toString(e="utf8"){return W(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new je(e.join(qr))}static random(){return new je(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new je(e):typeof e.uint8Array=="function"?new je(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=_m),this._buf[0]!==Zo){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Zo,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Zo;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return je.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(qr).slice(1)}type(){return _E(this.baseNamespace())}name(){return SE(this.baseNamespace())}instance(e){return new je(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(qr)||(e+=qr),e+=this.type(),new je(e)}parent(){const e=this.list();return e.length===1?new je(qr):new je(e.slice(0,-1).join(qr))}child(e){return this.toString()===qr?e:e.toString()===qr?this:new je(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return je.withNamespaces([...this.namespaces(),...EE(e.map(t=>t.namespaces()))])}}function _E(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function SE(r){const e=r.split(":");return e[e.length-1]}function EE(r){return[].concat(...r)}const xE="SHARDING";function AE(r){return r[Symbol.asyncIterator]!=null}function rh(r){if(AE(r))return(async()=>{for await(const e of r);})();for(const e of r);}function IE(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function kE(r){return r[Symbol.asyncIterator]!=null}function xn(r,e){let t=0;if(kE(r))return(async function*(){for await(const c of r)await e(c,t++)&&(yield c)})();const n=IE(r),{value:s,done:i}=n.next();if(i===!0)return(function*(){})();const o=e(s,t++);if(typeof o.then=="function")return(async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)})();const l=e;return(function*(){o===!0&&(yield s);for(const c of n)l(c,t++)&&(yield c)})()}function CE(r){return r[Symbol.asyncIterator]!=null}function au(r){if(CE(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}function TE(r){return r[Symbol.asyncIterator]!=null}function Ra(r,e){return TE(r)?(async function*(){yield*(await au(r)).sort(e)})():(function*(){yield*au(r).sort(e)})()}function PE(r){return r[Symbol.asyncIterator]!=null}function nh(r,e){return PE(r)?(async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}})()}class Sm{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await rh(this.putMany(e,n)),e=[],await rh(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=xn(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=xn(n,()=>s++>=i)}return e.limit!=null&&(n=nh(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=xn(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=xn(n,()=>i++>=s)}return e.limit!=null&&(n=nh(n,e.limit)),n}}class Ba extends Error{static name="OpenFailedError";static code="ERR_OPEN_FAILED";name=Ba.name;code=Ba.code;constructor(e="Open failed"){super(e)}}class Na extends Error{static name="PutFailedError";static code="ERR_PUT_FAILED";name=Na.name;code=Na.code;constructor(e="Put failed"){super(e)}}class oo extends Error{static name="GetFailedError";static code="ERR_GET_FAILED";name=oo.name;code=oo.code;constructor(e="Get failed"){super(e)}}class Ma extends Error{static name="DeleteFailedError";static code="ERR_DELETE_FAILED";name=Ma.name;code=Ma.code;constructor(e="Delete failed"){super(e)}}let Em=class lu extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=lu.name;code=lu.code;constructor(e="Not Found"){super(e)}};class DE extends Sm{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new Em;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new je(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new je(n),t?.signal?.throwIfAborted()}}function lr(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class sh{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class sc{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new sh(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new sh(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let LE=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ud(r={}){return RE(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function RE(r,e){e=e??{};let t=e.onEnd,n=new sc,s,i,o,l=lr();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((g,m)=>{i=w=>{i=null,n.push(w);try{g(r(n))}catch(v){m(v)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{l.resolve(),l=lr()})}},d=g=>i!=null?i(g):(n.push(g),s),f=g=>(n=new sc,i!=null?i({error:g}):(n.push({error:g}),s)),a=g=>{if(o)return s;if(e?.objectMode!==!0&&g?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return d({done:!1,value:g})},u=g=>o?s:(o=!0,g!=null?f(g):d({done:!0})),h=()=>(n=new sc,u(),{done:!0}),p=g=>(u(g),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:h,throw:p,push:a,end:u,get readableLength(){return n.size},onEmpty:async g=>{const m=g?.signal;if(m?.throwIfAborted(),n.isEmpty())return;let w,v;m!=null&&(w=new Promise((_,k)=>{v=()=>{k(new LE)},m.addEventListener("abort",v)}));try{await Promise.race([l.promise,w])}finally{v!=null&&m!=null&&m?.removeEventListener("abort",v)}}},t==null)return s;const y=s;return s={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(g){return y.throw(g),t!=null&&(t(g),t=void 0),{done:!0}},return(){return y.return(),t!=null&&(t(),t=void 0),{done:!0}},push:a,end(g){return y.end(g),t!=null&&(t(g),t=void 0),s},get readableLength(){return y.readableLength},onEmpty:g=>y.onEmpty(g)},s}function BE(r){return r.reason}async function Tt(r,e,t){if(e==null)return r;const n=t?.translateError??BE;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((i,o)=>{s=()=>{o(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}class NE{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=lr(),this.haveNext=lr()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=lr(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=lr(),await Tt(this.readNext.promise,t?.signal,t)}}function ME(){return new NE}function OE(r){return r[Symbol.asyncIterator]!=null}async function $E(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*FE(r){const e=new AbortController,t=ME();$E(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*UE(r){for(const e of r)yield*e}function cu(...r){const e=[];for(const t of r)OE(t)||e.push(t);return e.length===r.length?UE(e):FE(r)}new je(xE);const ri=1e3,ni=ri*60,si=ni*60,ms=si*24,ao=ms*7,ii=ms*365.25,lo=ii/12;function VE(r,e){if(typeof r=="string")return KE(r);if(typeof r=="number")return zE(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var xm=VE;function KE(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,s=parseFloat(t),i=n.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return s*ii;case"months":case"month":case"mo":return s*lo;case"weeks":case"week":case"w":return s*ao;case"days":case"day":case"d":return s*ms;case"hours":case"hour":case"hrs":case"hr":case"h":return s*si;case"minutes":case"minute":case"mins":case"min":case"m":return s*ni;case"seconds":case"second":case"secs":case"sec":case"s":return s*ri;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function qE(r){let e=Math.abs(r);return e>=ii?`${Math.round(r/ii)}y`:e>=lo?`${Math.round(r/lo)}mo`:e>=ao?`${Math.round(r/ao)}w`:e>=ms?`${Math.round(r/ms)}d`:e>=si?`${Math.round(r/si)}h`:e>=ni?`${Math.round(r/ni)}m`:e>=ri?`${Math.round(r/ri)}s`:`${r}ms`}function HE(r){let e=Math.abs(r);return e>=ii?Gn(r,e,ii,"year"):e>=lo?Gn(r,e,lo,"month"):e>=ao?Gn(r,e,ao,"week"):e>=ms?Gn(r,e,ms,"day"):e>=si?Gn(r,e,si,"hour"):e>=ni?Gn(r,e,ni,"minute"):e>=ri?Gn(r,e,ri,"second"):`${r} ms`}function zE(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?HE(r):qE(r)}function Gn(r,e,t,n){let s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function WE(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=xm,t.destroy=d,Object.keys(r).forEach(f=>{t[f]=r[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let a=0;for(let u=0;u<f.length;u++)a=(a<<5)-a+f.charCodeAt(u),a|=0;return t.colors[Math.abs(a)%t.colors.length]}t.selectColor=e;function t(f,a){let u,h=null,p,y;function g(...m){if(!g.enabled)return;const w=g,v=Number(new Date),_=v-(u||v);w.diff=_,w.prev=u,w.curr=v,u=v,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let k=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(D,I)=>{if(D==="%%")return"%";k++;const x=t.formatters[I];if(typeof x=="function"){const B=m[k];D=x.call(w,B),m.splice(k,1),k--}return D}),t.formatArgs.call(w,m),a?.onLog!=null&&a.onLog(...m),(w.log||t.log).apply(w,m)}return g.namespace=f,g.useColors=t.useColors(),g.color=t.selectColor(f),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(p!==t.namespaces&&(p=t.namespaces,y=t.enabled(f)),y),set:m=>{h=m}}),typeof t.init=="function"&&t.init(g),g}function n(f,a){const u=t(this.namespace+(typeof a>"u"?":":a)+f);return u.log=this.log,u}function s(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];let a;const u=(typeof f=="string"?f:"").split(/[\s,]+/),h=u.length;for(a=0;a<h;a++)u[a]&&(f=u[a].replace(/\*/g,".*?"),f[0]==="-"?t.skips.push(new RegExp("^"+f.substr(1)+"$")):t.names.push(new RegExp("^"+f+"$")))}function i(){const f=[...t.names.map(l),...t.skips.map(l).map(a=>"-"+a)].join(",");return t.enable(""),f}function o(f){if(f[f.length-1]==="*")return!0;let a,u;for(a=0,u=t.skips.length;a<u;a++)if(t.skips[a].test(f))return!1;for(a=0,u=t.names.length;a<u;a++)if(t.names[a].test(f))return!0;return!1}function l(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function c(f){return f instanceof Error?f.stack??f.message:f}function d(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var GE={};const Oa=ex(),YE=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function XE(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function ZE(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+xm(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const jE=console.debug??console.log??(()=>{});function QE(r){try{r?Oa?.setItem("debug",r):Oa?.removeItem("debug")}catch{}}function JE(){let r;try{r=Oa?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=GE.DEBUG),r}function ex(){try{return localStorage}catch{}}function tx(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Jt=WE({formatArgs:ZE,save:QE,load:JE,useColors:XE,setupFormatters:tx,colors:YE,storage:Oa,log:jE});Jt.formatters.b=r=>r==null?"undefined":De.baseEncode(r);Jt.formatters.t=r=>r==null?"undefined":Rn.baseEncode(r);Jt.formatters.m=r=>r==null?"undefined":Lo.baseEncode(r);Jt.formatters.p=r=>r==null?"undefined":r.toString();Jt.formatters.c=r=>r==null?"undefined":r.toString();Jt.formatters.k=r=>r==null?"undefined":r.toString();Jt.formatters.a=r=>r==null?"undefined":r.toString();function ih(r,e=""){const t=oh(r.message),n=oh(r.stack);return t!=null&&n!=null?n.includes(t)?`${n.split(`
`).join(`
${e}`)}`:`${t}
${e}${n.split(`
`).join(`
${e}`)}`:n!=null?`${n.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${r.toString()}`}function rx(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}function Am(r,e=""){if(rx(r)){let t=ih(r,e);return r.errors.length>0?(e=`${e}    `,t+=`
${e}${r.errors.map(n=>`${Am(n,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return ih(r,e)}Jt.formatters.e=r=>r==null?"undefined":Am(r);function nx(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function dd(r){return{forComponent(e){return fd(e,r)}}}function fd(r,e){let t=nx(`${r}:trace`);return Jt.enabled(`${r}:trace`)&&Jt.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=Jt(`${r}:trace`,e)),Object.assign(Jt(r,e),{error:Jt(`${r}:error`,e),trace:t,newScope:n=>fd(`${r}:${n}`,e)})}function oh(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}fd("datastore:core:tiered");const uu=(r,e)=>e.some(t=>r instanceof t);let ah,lh;function sx(){return ah||(ah=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ix(){return lh||(lh=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const du=new WeakMap,ic=new WeakMap,Ll=new WeakMap;function ox(r){const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("success",i),r.removeEventListener("error",o)},i=()=>{t(Bn(r.result)),s()},o=()=>{n(r.error),s()};r.addEventListener("success",i),r.addEventListener("error",o)});return Ll.set(e,r),e}function ax(r){if(du.has(r))return;const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)});du.set(r,e)}let fu={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return du.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Bn(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function Im(r){fu=r(fu)}function lx(r){return ix().includes(r)?function(...e){return r.apply(hu(this),e),Bn(this.request)}:function(...e){return Bn(r.apply(hu(this),e))}}function cx(r){return typeof r=="function"?lx(r):(r instanceof IDBTransaction&&ax(r),uu(r,sx())?new Proxy(r,fu):r)}function Bn(r){if(r instanceof IDBRequest)return ox(r);if(ic.has(r))return ic.get(r);const e=cx(r);return e!==r&&(ic.set(r,e),Ll.set(e,r)),e}const hu=r=>Ll.get(r);function ux(r,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){const o=indexedDB.open(r,e),l=Bn(o);return n&&o.addEventListener("upgradeneeded",c=>{n(Bn(o.result),c.oldVersion,c.newVersion,Bn(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),l.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}function dx(r,{blocked:e}={}){const t=indexedDB.deleteDatabase(r);return e&&t.addEventListener("blocked",n=>e(n.oldVersion,n)),Bn(t).then(()=>{})}const fx=["get","getKey","getAll","getAllKeys","count"],hx=["put","add","delete","clear"],oc=new Map;function ch(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(oc.get(e))return oc.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,s=hx.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||fx.includes(t)))return;const i=async function(o,...l){const c=this.transaction(o,s?"readwrite":"readonly");let d=c.store;return n&&(d=d.index(l.shift())),(await Promise.all([d[t](...l),s&&c.done]))[0]};return oc.set(e,i),i}Im(r=>({...r,get:(e,t,n)=>ch(e,t)||r.get(e,t,n),has:(e,t)=>!!ch(e,t)||r.has(e,t)}));const px=["continue","continuePrimaryKey","advance"],uh={},pu=new WeakMap,km=new WeakMap,gx={get(r,e){if(!px.includes(e))return r[e];let t=uh[e];return t||(t=uh[e]=function(...n){pu.set(this,km.get(this)[e](...n))}),t}};async function*mx(...r){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...r)),!e)return;e=e;const t=new Proxy(e,gx);for(km.set(t,e),Ll.set(t,hu(e));e;)yield t,e=await(pu.get(t)||e.continue()),pu.delete(t)}function dh(r,e){return e===Symbol.asyncIterator&&uu(r,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&uu(r,[IDBIndex,IDBObjectStore])}Im(r=>({...r,get(e,t,n){return dh(e,t)?mx:r.get(e,t,n)},has(e,t){return dh(e,t)||r.has(e,t)}}));class Cm extends Sm{location;version;db;constructor(e,t={}){super(),this.location=`${t.prefix??""}${e}`,this.version=t.version??1}async open(){try{const e=this.location;this.db=await ux(e,this.version,{upgrade(t){t.createObjectStore(e)}})}catch(e){throw new Ba(String(e))}}async close(){this.db?.close()}async put(e,t,n){if(this.db==null)throw new Error("Datastore needs to be opened.");try{n?.signal?.throwIfAborted(),await Tt(this.db.put(this.location,t,e.toString()),n?.signal)}catch(s){throw new Na(String(s))}return e}async get(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");let n;try{t?.signal?.throwIfAborted(),n=await Tt(this.db.get(this.location,e.toString()),t?.signal)}catch(s){throw new oo(String(s))}if(n===void 0)throw new Em;return n}async has(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return t?.signal?.throwIfAborted(),!!await Tt(this.db.getKey(this.location,e.toString()))}catch(n){throw new oo(String(n))}}async delete(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");try{t?.signal?.throwIfAborted(),await Tt(this.db.delete(this.location,e.toString()),t?.signal)}catch(n){throw new Ma(String(n))}}batch(){const e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{if(this.db==null)throw new Error("Datastore needs to be opened.");n?.signal?.throwIfAborted();const s=this.db.transaction(this.location,"readwrite");try{const i=e.filter(({key:o})=>t.find(l=>l.toString()===o.toString())==null).map(o=>async()=>{await s.store.put(o.value,o.key.toString())}).concat(t.map(o=>async()=>{await s.store.delete(o.toString())})).concat(async()=>{await s.done});n?.signal?.throwIfAborted(),await Tt(Promise.all(i.map(async o=>{await o()})),n?.signal)}catch{s.abort()}}}}async*query(e,t){let n=this.#e(e,(s,i)=>({key:s,value:i}),t);Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),yield*n}async*queryKeys(e,t){let n=this.#e(e,s=>s,t);Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),yield*n}async*#e(e,t,n){if(this.db==null)throw new Error("Datastore needs to be opened.");let s=0,i=-1;n?.signal?.throwIfAborted();for(const o of await this.db.getAllKeys(this.location)){if(n?.signal?.throwIfAborted(),e.prefix!=null&&!o.toString().startsWith(e.prefix))continue;if(e.limit!=null&&s===e.limit)return;if(i++,e.offset!=null&&i<e.offset)continue;const l=new je(o.toString());let c;try{c=await this.get(l,n)}catch(d){if(d.name!=="NotFoundError")throw d;continue}c!=null&&(yield t(l,c),n?.signal?.throwIfAborted(),s++)}}async destroy(){await dx(this.location)}}function Bo(r,e,t=s=>{const i=localStorage.getItem(r);return i?JSON.parse(i):s},n=s=>{localStorage.setItem(r,JSON.stringify(s))}){const s=ir(t(e)||e);return{get(){return _i(s)},set(i){n(i),s.set(i)},update(i){this.set(i(this.get()))},subscribe:s.subscribe}}async function yx(r){const e=new Cm(r);return await e.open().catch(()=>{}),async function(n,s,i=async l=>{const c=await e.get(n).catch(()=>l);return c===void 0&&l!==void 0?(await e.put(n,l),l):c},o=async l=>{await e.put(n,l).catch(()=>{})}){const l=ir(await i(s).catch(()=>s));return{get(){return _i(l)},set(c){o(c).then(()=>l.set(c))},update(c){this.set(c(this.get()))},subscribe:l.subscribe}}}function Vn(r){let e=ir(r);return e.get=()=>_i(e),e}function Rl(r=[],e=()=>{}){let t=o1(r,e);return t.get=()=>_i(t),t}const Tm=Vn(Le.cards),Bl=Vn(Le.energy),No=Vn(Le.log),Pm=Vn(Le.matchedIndexes),bx=Bo(U.moves,Le.moves),bt=Bo(U.options,Le.options),pn=Vn(Le.phase),gu=Vn(Le.plusIndex),Mo=Bo(U.records,Le.records),Nl=Vn(Le.score),hd=Bo(U.timestamp,Date.now()),Oo=Rl([bt,hd],([{playerName:r},e])=>dm({playerName:r,timestamp:e})),Lt=Rl([No,bt,Oo],([r,{rapid:e},t])=>{if(!e)return[];if(t!==Lt.seed&&(Lt.seed=t,Lt.prev=[],Lt.rows=[]),r.length===0){const n=um(Lt.prev);n&&(Lt.rows=[...Lt.rows,{combo:n,key:performance.now()}],zr(wm),Lt.rows.length>7&&(Lt.rows=Lt.rows.slice(-7)),Lt.prev=[])}else Lt.prev=r;return Lt.rows}),mu=Bo(U.relays,Le.relays,function(e){const t=localStorage.getItem(U.relays),n=t?JSON.parse(t):null;if(!n)return e;const s=new Set(n.active??[]),i=new Set(n.applied??[]),o=new Set(ti);for(const l of ti)i.has(l)||(s.add(l),i.add(l));for(const l of[...i])o.has(l)||(s.delete(l),i.delete(l));return{active:[...s],applied:[...i]}}),xi=Rl([mu],([{active:r}])=>r),co=Rl([xi],([r])=>r.map(e=>{const t=e.match(/\/p2p\/([a-zA-Z0-9]+)$/);return t?t[1]:null}).filter(Boolean)),Xe=Vn(Le.overlay),ys={cardsStore:Tm,energyStore:Bl,logStore:No,matchedIndexesStore:Pm,movesStore:bx,optionsStore:bt,phaseStore:pn,plusIndexStore:gu,recordsStore:Mo,scoreStore:Nl,seedStore:Oo,timestampStore:hd,ready:!0};function Pi(r,e=0){return hr(ys,r,e)}function zr(r,{muteRapid:e=!1}={}){return Nr(ys,r,{muteRapid:e})}function pd(r){Xe.set(null),aE(ys,r)}var vx=se('<div tabindex="0" role="button"><!> <div></div> <div></div></div>');function wx(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",d),n=()=>fe(pn,"$phaseStore",d),s=()=>fe(Pm,"$matchedIndexesStore",d),i=()=>fe(No,"$logStore",d),o=()=>fe(gu,"$plusIndexStore",d),l=()=>fe(Tm,"$cardsStore",d),c=()=>fe(Oo,"$seedStore",d),[d,f]=tr();let a=null,u=null,h=null,p=le(null),y=null,g=le(null),m=le(null),w=ie(()=>t().rapid),v=ie(()=>n()===te.idle),_=ie(()=>s().size>0&&i().length===1),k=ie(()=>!b(v)&&!b(_)),P=ie(()=>!b(v)||o()!==null),D=ie(()=>l()[o()]),I=ie(()=>!!(b(D)||b(p)||b(_))),x=ie(()=>Pl(l()));st(()=>{const Y=b(D)||b(p);Y&&X(g,Y,!0)}),st(()=>{s().size>0&&E({muteSound:!0})}),st(()=>{c()&&ct(()=>E({muteSound:!0}))});function B(){return!!b(p)}function Q({x:Y=0,y:oe=0}={}){if(!b(v))return{};if(S(),b(p)){y=b(p),Y+=b(p).x,oe+=b(p).y;const be=Y<0?Re.columns-1:Y%Re.columns,gt=oe<0?Re.rows-1:oe%Re.rows;return A({x:be,y:gt,topEdge:gt===0&&y&&y.y===Re.rows-1,bottomEdge:gt===Re.rows-1&&y&&y.y===0})}if(Y!==0)return y?(newValue={x:Y>0?0:Re.columns-1,y:y.y},y=null,A(newValue)):A({x:Math.round(Re.columns/2)+Y+(Y>0?-1:0),y:Math.round(Re.rows/2)+(Y>0?0:-1)});if(oe!==0){if(y){const be={x:y.x,y:oe>0?0:Re.rows-1};return y=null,A(be)}return A({x:Math.round(Re.columns/2)+(oe>0?-1:0),y:Math.round(Re.rows/2)+oe+(oe>0?-1:0)})}return b(p)||{}}function M(){if(!B())return;y=null;const Y=l().findIndex(({x:oe,y:be})=>oe===b(p).x&&be===b(p).y);Y!==-1&&(Nt(gu,Y),!b(P)&&zr(ym,{muteRapid:!0}))}function A(Y){B()||zr(iu);const oe=b(x)[Y.x][Y.y];return zr(()=>ou(l()[oe].value)),X(p,Y,!0)}function E({savePrev:Y=!1,muteSound:oe=!1}={}){B()&&(y=Y?b(p):null,X(p,null),oe||zr(vm))}function S(){u.style.animation="none",u.offsetHeight,u.style.animation=null,h.style.animation="none",h.offsetHeight,h.style.animation=null}function T(Y){if(b(P)||b(m)!==null)return;B()||zr(iu);const oe=l()[Y];oe&&(b(p)&&b(p).x===oe.x&&b(p).y===oe.y||(S(),zr(()=>ou(oe.value)),y=b(p),X(p,oe,!0)))}function C(Y){if(Y===a)return null;if(Y.classList.contains("card"))return Y;const oe=Y.querySelector(".card");if(oe)return oe;let be=Y.parentElement;for(;be;){if(be.classList.contains("card"))return be;be=be.parentElement}return null}function L(Y){const oe=C(Y.target);if(!oe||!oe.dataset.index)return null;const be=Number(oe.dataset.index);return isNaN(be)?null:be}function R(Y){if(!ys.ready)return;const oe=L(Y);oe!==null&&oe>=0&&T(oe)}function N(Y){E({muteSound:n()!==te.idle})}function $(Y){if(b(P))return;const oe=L(Y.detail);oe!==null&&(T(oe),b(w)||X(m,oe,!0),Y.detail.type==="mousedown"&&(zr(()=>bm(l()[oe].value),{}),b(w)&&M()))}function q(Y){b(w)||L(Y.detail)!==b(m)||(X(m,null),M(),E())}function F(Y){b(w)||X(m,null)}function H(Y){Y.preventDefault()}function G(Y,{duration:oe=400}={}){let be;st(()=>{const gt=(gr={})=>{Y.dispatchEvent(new CustomEvent("longpressstart",{bubbles:!0,detail:gr})),be=window.setTimeout(()=>{Y.dispatchEvent(new CustomEvent("longpressfire",{bubbles:!0,detail:gr}))},oe)},nr=(gr={})=>{clearTimeout(be),Y.dispatchEvent(new CustomEvent("longpressend",{bubbles:!0,detail:gr}))};return Y.addEventListener("mousedown",gt,{passive:!0}),Y.addEventListener("touchstart",gt,{passive:!0}),Y.addEventListener("touchend",nr,{passive:!0}),window.addEventListener("mouseup",nr,{passive:!0}),()=>{clearTimeout(be),Y.removeEventListener("mousedown",gt),Y.removeEventListener("touchstart",gt),Y.removeEventListener("touchend",nr),window.removeEventListener("mouseup",nr)}})}var re={isFocused:B,shiftFocus:Q,plusFocusedCard:M,focusCard:A,blur:E,longpress:G},ne=vx();let K;ne.__mousemove=R,ne.__dblclick=H;let ee;var ge=O(ne);Dn(ge,1,l,ei,(Y,oe,be)=>{const gt=ie(()=>b(oe).x===(b(p)&&b(p).x)&&b(oe).y===(b(p)&&b(p).y));{let nr=ie(()=>s().has(be)),gr=ie(()=>be===b(m)),Wn=ie(()=>be===o());cE(Y,{get card(){return b(oe)},index:be,get focus(){return b(gt)},get blink(){return b(nr)},get longpress(){return b(gr)},get plus(){return b(Wn)}})}});var Me=z(ge,2);let tt;Ze(Me,Y=>u=Y,()=>u);var Oe=z(Me,2);let pt;Ze(Oe,Y=>h=Y,()=>h),Ze(ne,Y=>a=Y,()=>a),Wg(ne,Y=>G?.(Y)),Pe(()=>{K=Ue(ne,1,"board svelte-nytrg3",null,K,{overflow:b(k),progress:b(P)}),ee=Ct(ne,"",ee,{"--focus-x":b(g)&&b(g).x,"--focus-y":b(g)&&b(g).y}),tt=Ue(Me,1,"slider horizontal svelte-nytrg3",null,tt,{blink:b(_),focus:b(I)}),pt=Ue(Oe,1,"slider vertical svelte-nytrg3",null,pt,{blink:b(_),focus:b(I)})}),_r("mouseleave",ne,N),_r("longpressstart",ne,$),_r("longpressfire",ne,q),_r("longpressend",ne,F),J(r,ne);var Ur=ht(re);return f(),Ur}$r(["mousemove","dblclick"]);var _x=se('<span class="back svelte-5x6s5r">O</span>'),Sx=se("<span> </span>"),Ex=se('<span class="energy-out svelte-5x6s5r"></span>'),xx=se('<div class="energy svelte-5x6s5r"><div><span> </span></div> <div><span><span class="front svelte-5x6s5r"> </span> <!></span></div> <!></div>');function Dm(r,e){ft(e,!0);const t=()=>fe(Bl,"$energyStore",s),n=()=>fe(pn,"$phaseStore",s),[s,i]=tr();let o=Qr(e,"gameOver",3,!1),l=le(!1),c=ie(()=>t().value),d=ie(()=>b(c)>100),f=ie(()=>b(c)<20&&n()===te.idle),a=ie(()=>`
    z-index: ${b(d)?0:1};
    flex: ${(b(d)?200-b(c):b(c))/100};
  `),u=ie(()=>`
    position: ${b(d)?"absolute":"relative"};
  `),h=ie(()=>`
    z-index: ${b(d)?1:0};
    flex: ${b(d)?(b(c)-100)/100:0};
  `),p=ie(()=>`
    position: ${b(d)?"relative":"absolute"};
    left: ${b(d)?`calc(${b(c)>119?0:(b(c)-120)/100} * 128rem)`:0};
  `);st(()=>{b(f)&&zr(mm)}),st(()=>{o()&&!b(l)&&setTimeout(()=>X(l,!0))});var y=xx(),g=O(y);let m;var w=O(g);let v;var _=O(w),k=z(g,2);let P;var D=O(k);let I;var x=O(D),B=O(x),Q=z(x,2);{var M=S=>{var T=_x();J(S,T)};we(Q,S=>{o()&&S(M)})}var A=z(k,2);{var E=S=>{var T=Ex();Dn(T,20,()=>"ut of energy",ei,(C,L,R)=>{var N=Sx();Ct(N,"",{},{"animation-delay":`${400+R*100}ms`});var $=O(N);Pe(()=>{Ue(N,1,Yg(L===" "?"space":"letter"),"svelte-5x6s5r"),He($,L)}),J(C,N)}),J(S,T)};we(A,S=>{o()&&S(E)})}Pe(()=>{m=Ue(g,1,"left-bar svelte-5x6s5r",null,m,{warning:b(f)}),Ct(g,b(a)),v=Ue(w,1,"left-value svelte-5x6s5r",null,v,{warning:b(f)}),Ct(w,b(u)),He(_,b(c)),P=Ue(k,1,"right-bar svelte-5x6s5r",null,P,{extra:b(d)}),Ct(k,b(h)),I=Ue(D,1,"right-value svelte-5x6s5r",null,I,{warning:b(f),flip:b(l)}),Ct(D,b(p)),He(B,b(c))}),J(r,y),ht(),i()}a_();const Ax=r=>r;function Lm(r){const e=r-1;return e*e*e+1}function Ix(r){return r<.5?4*r*r*r:.5*Math.pow(2*r-2,3)+1}function yu(r){const e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}function Lr(r,{delay:e=0,duration:t=400,easing:n=Ix,amount:s=5,opacity:i=0}={}){const o=getComputedStyle(r),l=+o.opacity,c=o.filter==="none"?"":o.filter,d=l*(1-i),[f,a]=yu(s);return{delay:e,duration:t,easing:n,css:(u,h)=>`opacity: ${l-d*h}; filter: ${c} blur(${h*f}${a});`}}function ma(r,{delay:e=0,duration:t=400,easing:n=Ax}={}){const s=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:n,css:i=>`opacity: ${i*s}`}}function Ht(r,{delay:e=0,duration:t=400,easing:n=Lm,x:s=0,y:i=0,opacity:o=0}={}){const l=getComputedStyle(r),c=+l.opacity,d=l.transform==="none"?"":l.transform,f=c*(1-o),[a,u]=yu(s),[h,p]=yu(i);return{delay:e,duration:t,easing:n,css:(y,g)=>`
			transform: ${d} translate(${(1-y)*a}${u}, ${(1-y)*h}${p});
			opacity: ${c-f*g}`}}function fh(r,{delay:e=0,duration:t=400,easing:n=Lm,axis:s="y"}={}){const i=getComputedStyle(r),o=+i.opacity,l=s==="y"?"height":"width",c=parseFloat(i[l]),d=s==="y"?["top","bottom"]:["left","right"],f=d.map(m=>`${m[0].toUpperCase()}${m.slice(1)}`),a=parseFloat(i[`padding${f[0]}`]),u=parseFloat(i[`padding${f[1]}`]),h=parseFloat(i[`margin${f[0]}`]),p=parseFloat(i[`margin${f[1]}`]),y=parseFloat(i[`border${f[0]}Width`]),g=parseFloat(i[`border${f[1]}Width`]);return{delay:e,duration:t,easing:n,css:m=>`overflow: hidden;opacity: ${Math.min(m*20,1)*o};${l}: ${m*c}px;padding-${d[0]}: ${m*a}px;padding-${d[1]}: ${m*u}px;margin-${d[0]}: ${m*h}px;margin-${d[1]}: ${m*p}px;border-${d[0]}-width: ${m*y}px;border-${d[1]}-width: ${m*g}px;min-${l}: 0`}}var kx=se('<span class="plus svelte-zkpbwt">+</span>'),Cx=se('<span class="value svelte-zkpbwt"> </span> <!>',1),Tx=se('<span class="counts svelte-zkpbwt"> </span>'),Px=se('<span class="svelte-zkpbwt">]</span> <!> <span class="svelte-zkpbwt">=</span> <span class="sum svelte-zkpbwt"> </span>',1),Dx=se('<span class="extra svelte-zkpbwt"> </span> <span class="svelte-zkpbwt">]=</span> <span class="sum svelte-zkpbwt"> </span>',1),Lx=se('<li class="row svelte-zkpbwt"><span class="svelte-zkpbwt"></span> <span class="svelte-zkpbwt">[</span> <!> <!></li>'),Rx=se('<span class="svelte-zkpbwt"> </span>'),Bx=se('<li><!> <span class="sum svelte-zkpbwt"> </span></li>'),Nx=se('<span class="combo svelte-zkpbwt"> </span>'),Mx=se('<ol class="log svelte-zkpbwt"><!> <!> <!></ol>');function Ox(r,e){ft(e,!1);const t=()=>fe(pn,"$phaseStore",o),n=()=>fe(No,"$logStore",o),s=()=>fe(Nl,"$scoreStore",o),i=()=>fe(Lt,"$combosStore",o),[o,l]=tr();function c(y=[]){let{length:g}=y;return g<1?"":(g>4&&(g=4),y.reduce((m,w,v)=>m+`--clr-${v+1}: var(--color-${w});`,`animation: colors-${g} ${200+200*g}ms steps(2, end) infinite;`))}i1();var d=Mx(),f=O(d);{var a=y=>{var g=Yr(),m=rt(g);Dn(m,1,n,ei,(w,v,_)=>{let k=()=>b(v).digits,P=()=>b(v).counts,D=()=>b(v).extra,I=()=>b(v).sum,x=()=>B_(b(v),["digits","counts","extra","sum"]);const B=ro(()=>Object.keys(x()));var Q=Lx(),M=O(Q);M.textContent=_+1;var A=z(M,4);Dn(A,1,()=>b(B),ei,(C,L,R)=>{var N=Cx(),$=rt(N);let q;var F=O($),H=z($,2);{var G=re=>{var ne=kx();J(re,ne)};we(H,re=>{R<b(B).length-1&&re(G)})}Pe(()=>{q=Ct($,"",q,{color:`var(--color-${b(L)??""})`}),He(F,x()[b(L)])}),J(C,N)});var E=z(A,2);{var S=C=>{var L=Px(),R=z(rt(L),2);{var N=F=>{var H=Tx(),G=O(H);Pe(re=>{Ct(H,re),He(G,P())},[()=>c(k())]),J(F,H)};we(R,F=>{P()>1&&F(N)})}var $=z(R,4),q=O($);Pe(()=>He(q,(_+1)*I()*P())),J(C,L)},T=C=>{var L=Dx(),R=rt(L),N=O(R),$=z(R,4),q=O($);Pe(()=>{He(N,D()),He(q,(_+1)*D())}),J(C,L)};we(E,C=>{D()===void 0?C(S):C(T,!1)})}xe(1,Q,()=>fh,()=>Pi({duration:100})),xe(2,Q,()=>ma,()=>Pi({duration:200})),J(w,Q)}),J(y,g)};we(f,y=>{t()!==te.score&&y(a)})}var u=z(f,2);{var h=y=>{const g=ro(()=>n().length===1);var m=Bx();let w;var v=O(m);{var _=D=>{var I=Rx(),x=O(I);Pe(()=>He(x,b(g)?"":"combo:")),xe(2,I,()=>ma,()=>Pi({duration:200})),J(D,I)};we(v,D=>{t()===te.combo&&D(_)})}var k=z(v,2),P=O(k);Pe(()=>{w=Ue(m,1,"svelte-zkpbwt",null,w,{collapse:b(g)}),He(P,`${t()===te.score&&s().buffer>0?"+":""}${s().buffer??""}`)}),xe(1,m,()=>fh,()=>Pi({duration:b(g)?0:100})),xe(2,m,()=>ma,()=>Pi({duration:200})),J(y,m)};we(u,y=>{(t()===te.combo||t()===te.score)&&y(h)})}var p=z(u,2);Dn(p,1,i,({combo:y,key:g})=>g,(y,g)=>{let m=()=>b(g).combo;var w=Nx(),v=O(w);Pe(()=>He(v,`+${m()??""}`)),J(y,w)}),J(r,d),ht(),l()}var $x=se('<span class="value"> </span>'),Fx=se('<span tabindex="0" role="button"><span> </span> <!></span>');function Rm(r,e){ft(e,!0);const t=()=>fe(Nl,"$scoreStore",i),n=()=>fe(Mo,"$recordsStore",i),s=()=>fe(pn,"$phaseStore",i),[i,o]=tr(),l={[U.highCombo]:"hi-combo",[U.highScore]:"hi-score",[U.score]:"score"};let c=le(jr(U.score)),d=le(null),f=le(!1),a=le(!1),u=ie(()=>b(c)===U.score?t().value:n()[b(c)][U.value]),h=ie(()=>"score: "+b(u)+`
high score: `+n()[U.highScore][U.value]+`
high combo: `+n()[U.highCombo][U.value]);st(()=>{e.newRecord&&(X(c,e.newRecordHighScore?U.highScore:U.highCombo,!0),X(f,!0))});function p(){return b(a)}function y(){X(a,!0)}function g(){X(a,!1)}function m(x){x.preventDefault(),X(c,v(b(c)),!0),_()}function w(){X(c,v(b(c),!0),!0),_()}function v(x,B=!1){return e.newRecord?{[U.highScore]:e.newRecordHighCombo?U.highCombo:U.highScore,[U.highCombo]:e.newRecordHighScore?U.highScore:U.highCombo}[x]:B?{[U.score]:U.highCombo,[U.highScore]:U.score,[U.highCombo]:U.highScore}[x]:{[U.score]:U.highScore,[U.highScore]:U.highCombo,[U.highCombo]:U.score}[x]}function _(){X(f,!0),clearTimeout(b(d)),!e.newRecord&&X(d,setTimeout(()=>{X(c,U.score,!0),X(f,e.newRecord,!0)},3200),!0)}var k={isFocused:p,focus:y,blur:g,nextType:m,prevType:w},P=Yr(),D=rt(P);q_(D,()=>b(c),x=>{var B=Fx();let Q;B.__click=m;var M=O(B);let A;var E=O(M),S=z(M,2);{var T=C=>{var L=$x(),R=O(L);Pe(()=>He(R,b(u))),J(C,L)};we(S,C=>{(e.overlaid||s()!==te.gameOver)&&C(T)})}Pe(()=>{Q=Ue(B,1,"score",null,Q,{focus:b(a)}),Ln(B,"title",b(h)),A=Ue(M,1,"type",null,A,{visible:b(f)}),He(E,`${l[b(c)]??""}:`)}),xe(1,B,()=>Lr),J(x,B)}),J(r,P);var I=ht(k);return o(),I}$r(["click"]);var Ux=se('<span class="rapid">rapid</span>'),Vx=se('<div class="section-1"><button title="[open menu]"><h1>digifall <!></h1> <!></button></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div>',1),Kx=se('<div><div class="seedground"></div> <div class="content"><!></div></div>');function qx(r,e){ft(e,!0);const t=()=>fe(No,"$logStore",l),n=()=>fe(Lt,"$combosStore",l),s=()=>fe(Xe,"$overlayStore",l),i=()=>fe(Oo,"$seedStore",l),o=()=>fe(bt,"$optionsStore",l),[l,c]=tr();let d=le(null),f=le(null),a=le(null),u=ie(()=>t().length>0||n().length>0);st(()=>{b(d)&&(b(d).isFocused=()=>b(d).classList.contains("focus"),b(d).focus=()=>b(d).classList.add("focus"),b(d).blur=()=>b(d).classList.remove("focus"))});function h(){b(d).isFocused()?(b(d).blur(),b(a).shiftFocus({y:1})):b(f).isFocused()?(b(f).blur(),b(d).focus()):b(a).shiftFocus({y:1}).topEdge&&(b(a).blur({savePrev:!0}),b(f).focus())}function p(){b(d).isFocused()?(b(d).blur(),b(f).focus()):b(f).isFocused()?(b(f).blur(),b(a).shiftFocus({y:-1})):b(a).shiftFocus({y:-1}).bottomEdge&&(b(a).blur({savePrev:!0}),b(d).focus())}function y(){b(d).isFocused()||(b(f).isFocused()?b(f).prevType():b(a).shiftFocus({x:-1}))}function g(){b(d).isFocused()||(b(f).isFocused()?b(f).nextType():b(a).shiftFocus({x:1}))}function m(){b(d).isFocused()?(b(d).click(),b(d).blur(),b(a).blur({savePrev:!0})):b(f).isFocused()?b(f).nextType():b(a).plusFocusedCard()}function w(){b(d).blur(),b(f).blur(),b(a).blur()}function v(M){if(!M)return;const A=()=>M=Da(M),E=(q=13)=>`hsl(${A()%360},50%,${q}%)`,S=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149];let T=4;const C=[];for(;T--;){const[q]=S.splice(A()%S.length,1);C.push(q)}const[L,R,N,$]=C;return`
      background-color: var(--color-dark);
      background-image:
        linear-gradient(90deg, ${E()} 50%, transparent 50%),
        linear-gradient(90deg, ${E()} 50%, transparent 50%),
        linear-gradient(90deg, transparent 50%, ${E()} 50%),
        linear-gradient(90deg, transparent 50%, ${E()} 50%);
      background-size: ${L}rem, ${R}rem, ${N}rem, ${$}rem;`}var _={moveUp:h,moveDown:p,moveLeft:y,moveRight:g,perfomAction:m,blur:w},k=Kx();let P;var D=O(k),I=z(D,2),x=O(I);{var B=M=>{var A=Vx(),E=rt(A),S=O(E);let T;S.__click=()=>Nt(Xe,de.menu);var C=O(S),L=z(O(C));{var R=ne=>{var K=Ux();J(ne,K)};we(L,ne=>{o().rapid&&ne(R)})}var N=z(C,2);Ox(N,{}),Ze(S,ne=>X(d,ne),()=>b(d));var $=z(E,2),q=O($);Ze(Rm(q,{}),ne=>X(f,ne,!0),()=>b(f));var F=z($,2),H=O(F);Ze(wx(H,{}),ne=>X(a,ne,!0),()=>b(a));var G=z(F,2),re=O(G);Dm(re,{}),Pe(()=>T=Ue(S,1,"digifall",null,T,{screen:b(u)})),J(M,A)};we(x,M=>{i()&&M(B)})}Pe(M=>{P=Ue(k,1,"game",null,P,{blur:s()}),Ct(D,M)},[()=>v(i())]),J(r,k);var Q=ht(_);return c(),Q}$r(["click"]);var Hx=se("<h1> </h1>"),zx=se("<button>p2p leaderboard</button>"),Wx=se('<div class="col"><button>new game</button> <!> <button>options</button></div>'),Gx=se('<div><div class="section-1"><!></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div></div>');function Yx(r,e){ft(e,!0);const t=()=>fe(Bl,"$energyStore",o),n=()=>fe(Mo,"$recordsStore",o),s=()=>fe(Nl,"$scoreStore",o),i=()=>fe(bt,"$optionsStore",o),[o,l]=tr();let c=Qr(e,"scoreComponent",15,null),d=ie(()=>t().value===0),f=ie(()=>b(d)&&t().buffer===0),a=ie(()=>n()[U.highCombo][U.value]),u=ie(()=>b(f)&&b(a)>ys[U.highComboPrev]),h=ie(()=>b(f)&&s().value>ys[U.highScorePrev]),p=ie(()=>b(u)||b(h));function y(){pd()}function g(){Xe.set(de.leaderboard)}function m(){Xe.set(de.options)}var w=Gx();let v;var _=O(w),k=O(_);{var P=E=>{var S=Hx(),T=O(S);Pe(()=>He(T,b(p)?"new record!":"game over")),xe(5,S,()=>Ht,()=>({delay:600,y:-48})),J(E,S)};we(k,E=>{b(f)&&E(P)})}var D=z(_,2),I=O(D);Ze(Rm(I,{get newRecordHighCombo(){return b(u)},get newRecordHighScore(){return b(h)},get newRecord(){return b(p)},overlaid:!0}),E=>c(E),()=>c());var x=z(D,2),B=O(x);{var Q=E=>{var S=Wx(),T=O(S);T.__click=y;var C=z(T,2);{var L=N=>{var $=zx();$.__click=g,J(N,$)};we(C,N=>{i()[U.leaderboard]&&N(L)})}var R=z(C,2);R.__click=m,xe(5,S,()=>Ht,()=>({delay:600,y:24})),J(E,S)};we(B,E=>{b(f)&&E(Q)})}var M=z(x,2),A=O(M);Dm(A,{get gameOver(){return b(f)}}),Pe(()=>v=Ue(w,1,"game-over content",null,v,{"new-record":b(p)})),xe(1,w,()=>Lr),J(r,w),ht(),l()}$r(["click"]);var Xx=se('<div class="virtual-item svelte-a5i8l1"><!></div>'),Zx=se('<div class="virtual-scroll svelte-a5i8l1"><div class="virtual-list"></div></div>');function jx(r,e){ft(e,!0);let t=Qr(e,"bufferSize",3,16),n=Qr(e,"startIndex",15,0),s=Qr(e,"endIndex",15,0),i=Qr(e,"keyFn",3,(k,P)=>P),o=le(null),l=le(0),c=le(0),d=le(0),f=ie(()=>Math.max(0,n()-t())),a=ie(()=>Math.min(s()+t(),e.items.length)),u=ie(()=>e.items.slice(b(f),b(a))),h=ie(()=>b(f)*b(c)),p=ie(()=>e.items.length*b(c));st(()=>{b(c)&&(n(Math.floor(b(d)/b(c))),s(n()+Math.ceil(b(l)/b(c))))});function y(k){X(d,k.target.scrollTop)}function g(k,P=!1){k<0||k>=e.items.length||requestAnimationFrame(()=>{b(o)?.scrollTo({top:k*b(c),behavior:P?"smooth":"instant"})})}var m={scrollToIndex:g},w=Zx(),v=O(w);let _;return Dn(v,23,()=>b(u),(k,P)=>i()(k,b(f)+P),(k,P,D)=>{var I=Xx(),x=O(I);Hg(x,()=>e.children??Kt,()=>b(P),()=>b(f)+b(D)),qf(I,"offsetHeight",B=>X(c,B)),J(k,I)}),Ze(w,k=>X(o,k),()=>b(o)),Pe(()=>_=Ct(v,"",_,{height:`${b(p)??""}px`,"padding-top":`${b(h)??""}px`})),_r("scroll",w,y),qf(w,"offsetHeight",k=>X(l,k)),J(r,w),ht(m)}const Qx=Symbol.for("@libp2p/connection"),hh=Symbol.for("@libp2p/content-routing");let uo=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class Jx extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}class ph extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}}let V=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class Bm extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class Nm extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class bu extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class eA extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Ki extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class tA extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class Di extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}class gh extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}}class $a extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}}class Mm extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let gd=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class $o extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class Kn extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class rA extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class $e extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}let ac=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},nA=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class fo extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class ya extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class vu extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class mh extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class sA extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class Om extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class Ir extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class iA extends Event{data;constructor(e,t){super("message",t),this.data=e}}class Ml extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}}class oA extends Ml{constructor(e,t){super(!0,e,t)}}class aA extends Ml{constructor(e,t){super(!1,e,t)}}const Fa=Symbol.for("@libp2p/peer-discovery"),ot=Symbol.for("@libp2p/peer-id");function Yi(r){return!!r?.[ot]}const yh=Symbol.for("@libp2p/peer-routing"),md="keep-alive";function yd(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function $m(...r){const e=[];for(const t of r)yd(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Fm(...r){const e=[];for(const t of r)yd(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const Um=Symbol.for("@libp2p/transport");var Ua;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Ua||(Ua={}));class Dt extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}const xr=Symbol.for("@libp2p/service-capabilities"),Va=Symbol.for("@libp2p/service-dependencies");class bh extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class vh extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class lA extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Ot={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new lA("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};function pe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function an(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=on(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const Vm=Symbol.for("@achingbrain/uint8arraylist");function wh(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function jo(r){return!!r?.[Vm]}class Ne{bufs;length;[Vm]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(jo(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(jo(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=wh(this.bufs,e);return t.buf[t.index]}set(e,t){const n=wh(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(jo(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return an(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:an(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Ne;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],l=s,c=l+o.byteLength;if(s=c,e>=c)continue;const d=e>=l&&e<c,f=t>l&&t<=c;if(d&&f){if(e===l&&t===c){n.push(o);break}const a=e-l;n.push(o.subarray(a,a+(t-e)));break}if(d){if(e===0){n.push(o);continue}n.push(o.subarray(e-l));continue}if(f){if(t===c){n.push(o);break}n.push(o.subarray(0,t-l));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!jo(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let a=0;a<i;a++)o[a]=-1;for(let a=0;a<s;a++)o[n[a]]=a;const l=o,c=this.byteLength-n.byteLength,d=n.byteLength-1;let f;for(let a=t;a<=c;a+=f){f=0;for(let u=d;u>=0;u--){const h=this.get(a+u);if(n[u]!==h){f=Math.max(1,u-l[h]);break}}if(f===0)return a}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=on(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=on(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Ne)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!pe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Ne;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const cA=parseInt("11111",2),wu=parseInt("10000000",2),uA=parseInt("01111111",2),_h={0:Li,1:Li,2:dA,3:pA,4:gA,5:hA,6:fA,16:Li,22:Li,48:Li};function qn(r,e={offset:0}){const t=r[e.offset]&cA;if(e.offset++,_h[t]!=null)return _h[t](r,e);throw new Error("No decoder for tag "+t)}function Fo(r,e){let t=0;if((r[e.offset]&wu)===wu){const n=r[e.offset]&uA;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Li(r,e){Fo(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=qn(r,e);if(n===null)break;t.push(n)}return t}function dA(r,e){const t=Fo(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function fA(r,e){const t=Fo(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let l=`${i}.${o}`,c=[];for(;e.offset<n;){const d=r[e.offset];if(e.offset++,c.push(d&127),d<128){c.reverse();let f=0;for(let a=0;a<c.length;a++)f+=c[a]<<a*7;l+=`.${f}`,c=[]}}return l}function hA(r,e){return e.offset++,null}function pA(r,e){const t=Fo(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function gA(r,e){const t=Fo(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function mA(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ne;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Ol(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=mA(r.byteLength);return new Ne(Uint8Array.from([e.byteLength|wu]),e)}function Xt(r){const e=new Ne,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ne(Uint8Array.from([2]),Ol(e),e)}function bd(r){const e=Uint8Array.from([0]),t=new Ne(e,r);return new Ne(Uint8Array.from([3]),Ol(t),t)}function yA(r){return new Ne(Uint8Array.from([4]),Ol(r),r)}function rn(r,e=48){const t=new Ne;for(const n of r)t.append(n);return new Ne(Uint8Array.from([e]),Ol(t),t)}const Km="1.2.840.10045.3.1.7",qm="1.3.132.0.34",Hm="1.3.132.0.35";async function bA(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function vA(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function wA(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const _A=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),SA=Uint8Array.from([6,5,43,129,4,0,34]),EA=Uint8Array.from([6,5,43,129,4,0,35]),zm={ext:!0,kty:"EC",crv:"P-256"},Wm={ext:!0,kty:"EC",crv:"P-384"},Gm={ext:!0,kty:"EC",crv:"P-521"},Hs=32,zs=48,Ws=66;function xA(r){const e=qn(r);return Ym(e)}function Ym(r){const e=r[1],t=W(e,"base64url"),n=r[2][1][0],s=1;let i,o;if(e.byteLength===Hs)return i=W(n.subarray(s,s+Hs),"base64url"),o=W(n.subarray(s+Hs),"base64url"),new va({...zm,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===zs)return i=W(n.subarray(s,s+zs),"base64url"),o=W(n.subarray(s+zs),"base64url"),new va({...Wm,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Ws)return i=W(n.subarray(s,s+Ws),"base64url"),o=W(n.subarray(s+Ws),"base64url"),new va({...Gm,key_ops:["sign"],d:t,x:i,y:o});throw new V(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function Xm(r){const e=qn(r);return Zm(e)}function Zm(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===Hs*2+1)return n=W(e.subarray(t,t+Hs),"base64url"),s=W(e.subarray(t+Hs),"base64url"),new ba({...zm,key_ops:["verify"],x:n,y:s});if(e.byteLength===zs*2+1)return n=W(e.subarray(t,t+zs),"base64url"),s=W(e.subarray(t+zs),"base64url"),new ba({...Wm,key_ops:["verify"],x:n,y:s});if(e.byteLength===Ws*2+1)return n=W(e.subarray(t,t+Ws),"base64url"),s=W(e.subarray(t+Ws),"base64url"),new ba({...Gm,key_ops:["verify"],x:n,y:s});throw new V(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function AA(r){return rn([Xt(Uint8Array.from([1])),yA(j(r.d??"","base64url")),rn([jm(r.crv)],160),rn([bd(new Ne(Uint8Array.from([4]),j(r.x??"","base64url"),j(r.y??"","base64url")))],161)]).subarray()}function IA(r){return rn([Xt(Uint8Array.from([1])),rn([jm(r.crv)],160),rn([bd(new Ne(Uint8Array.from([4]),j(r.x??"","base64url"),j(r.y??"","base64url")))],161)]).subarray()}function jm(r){if(r==="P-256")return _A;if(r==="P-384")return SA;if(r==="P-521")return EA;throw new V(`Invalid curve ${r}`)}async function kA(r="P-256"){const e=await bA(r);return new va(e.privateKey)}class ba{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=IA(this.jwk)),this._raw}toMultihash(){return it.digest(Sr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return De.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async verify(e,t,n){return wA(this.jwk,t,e,n)}}class va{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new ba({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=AA(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async sign(e,t){return vA(this.jwk,e,t)}}function $l(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Rr(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function ve(r,e,t=""){const n=$l(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,l=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+l+", got "+c)}return r}function vd(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Rr(r.outputLen),Rr(r.blockLen)}function Ka(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function CA(r,e){ve(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function ln(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Xi(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function kr(r,e){return r<<32-e|r>>>e}function lc(r,e){return r<<e|r>>>32-e>>>0}const Qm=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",TA=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Uo(r){if(ve(r),Qm)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=TA[r[t]];return e}const Vr={_0:48,_9:57,A:65,F:70,a:97,f:102};function Sh(r){if(r>=Vr._0&&r<=Vr._9)return r-Vr._0;if(r>=Vr.A&&r<=Vr.F)return r-(Vr.A-10);if(r>=Vr.a&&r<=Vr.f)return r-(Vr.a-10)}function ho(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(Qm)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=Sh(r.charCodeAt(i)),l=Sh(r.charCodeAt(i+1));if(o===void 0||l===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+l}return n}const PA=async()=>{};async function DA(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);const i=Date.now()-n;i>=0&&i<e||(await PA(),n+=i)}}function LA(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Eh(r,e=""){return typeof r=="string"?LA(r):ve(r,void 0,e)}function Dr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];ve(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function RA(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(r,e)}function wd(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Fl(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const Jm=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function ey(r,e,t){return r&e^~r&t}function ty(r,e,t){return r&e^r&t^e&t}class _d{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Xi(this.buffer)}update(e){Ka(this),ve(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const l=Math.min(s-this.pos,i-o);if(l===s){const c=Xi(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+l),this.pos),this.pos+=l,o+=l,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ka(this),CA(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,ln(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let a=o;a<s;a++)t[a]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const l=Xi(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const d=c/4,f=this.get();if(d>f.length)throw new Error("_sha2: outputLen bigger than state");for(let a=0;a<d;a++)l.setUint32(4*a,f[a],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:l}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=l,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const bn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Et=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Qo=BigInt(2**32-1),xh=BigInt(32);function BA(r,e=!1){return e?{h:Number(r&Qo),l:Number(r>>xh&Qo)}:{h:Number(r>>xh&Qo)|0,l:Number(r&Qo)|0}}function NA(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l}=BA(r[i],e);[n[i],s[i]]=[o,l]}return[n,s]}const Ah=(r,e,t)=>r>>>t,Ih=(r,e,t)=>r<<32-t|e>>>t,Ls=(r,e,t)=>r>>>t|e<<32-t,Rs=(r,e,t)=>r<<32-t|e>>>t,Jo=(r,e,t)=>r<<64-t|e>>>t-32,ea=(r,e,t)=>r>>>t-32|e<<64-t;function Kr(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const MA=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),OA=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,$A=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),FA=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,UA=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),VA=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,KA=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),vn=new Uint32Array(64);class qA extends _d{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:l,H:c}=this;return[e,t,n,s,i,o,l,c]}set(e,t,n,s,i,o,l,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=l|0,this.H=c|0}process(e,t){for(let a=0;a<16;a++,t+=4)vn[a]=e.getUint32(t,!1);for(let a=16;a<64;a++){const u=vn[a-15],h=vn[a-2],p=kr(u,7)^kr(u,18)^u>>>3,y=kr(h,17)^kr(h,19)^h>>>10;vn[a]=y+vn[a-7]+p+vn[a-16]|0}let{A:n,B:s,C:i,D:o,E:l,F:c,G:d,H:f}=this;for(let a=0;a<64;a++){const u=kr(l,6)^kr(l,11)^kr(l,25),h=f+u+ey(l,c,d)+KA[a]+vn[a]|0,y=(kr(n,2)^kr(n,13)^kr(n,22))+ty(n,s,i)|0;f=d,d=c,c=l,l=o+h|0,o=i,i=s,s=n,n=h+y|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,l=l+this.E|0,c=c+this.F|0,d=d+this.G|0,f=f+this.H|0,this.set(n,s,i,o,l,c,d,f)}roundClean(){ln(vn)}destroy(){this.set(0,0,0,0,0,0,0,0),ln(this.buffer)}}class HA extends qA{A=bn[0]|0;B=bn[1]|0;C=bn[2]|0;D=bn[3]|0;E=bn[4]|0;F=bn[5]|0;G=bn[6]|0;H=bn[7]|0;constructor(){super(32)}}const ry=NA(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),zA=ry[0],WA=ry[1],wn=new Uint32Array(80),_n=new Uint32Array(80);class GA extends _d{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:l,Dl:c,Eh:d,El:f,Fh:a,Fl:u,Gh:h,Gl:p,Hh:y,Hl:g}=this;return[e,t,n,s,i,o,l,c,d,f,a,u,h,p,y,g]}set(e,t,n,s,i,o,l,c,d,f,a,u,h,p,y,g){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=l|0,this.Dl=c|0,this.Eh=d|0,this.El=f|0,this.Fh=a|0,this.Fl=u|0,this.Gh=h|0,this.Gl=p|0,this.Hh=y|0,this.Hl=g|0}process(e,t){for(let v=0;v<16;v++,t+=4)wn[v]=e.getUint32(t),_n[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const _=wn[v-15]|0,k=_n[v-15]|0,P=Ls(_,k,1)^Ls(_,k,8)^Ah(_,k,7),D=Rs(_,k,1)^Rs(_,k,8)^Ih(_,k,7),I=wn[v-2]|0,x=_n[v-2]|0,B=Ls(I,x,19)^Jo(I,x,61)^Ah(I,x,6),Q=Rs(I,x,19)^ea(I,x,61)^Ih(I,x,6),M=$A(D,Q,_n[v-7],_n[v-16]),A=FA(M,P,B,wn[v-7],wn[v-16]);wn[v]=A|0,_n[v]=M|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:l,Cl:c,Dh:d,Dl:f,Eh:a,El:u,Fh:h,Fl:p,Gh:y,Gl:g,Hh:m,Hl:w}=this;for(let v=0;v<80;v++){const _=Ls(a,u,14)^Ls(a,u,18)^Jo(a,u,41),k=Rs(a,u,14)^Rs(a,u,18)^ea(a,u,41),P=a&h^~a&y,D=u&p^~u&g,I=UA(w,k,D,WA[v],_n[v]),x=VA(I,m,_,P,zA[v],wn[v]),B=I|0,Q=Ls(n,s,28)^Jo(n,s,34)^Jo(n,s,39),M=Rs(n,s,28)^ea(n,s,34)^ea(n,s,39),A=n&i^n&l^i&l,E=s&o^s&c^o&c;m=y|0,w=g|0,y=h|0,g=p|0,h=a|0,p=u|0,{h:a,l:u}=Kr(d|0,f|0,x|0,B|0),d=l|0,f=c|0,l=i|0,c=o|0,i=n|0,o=s|0;const S=MA(B,M,E);n=OA(S,x,Q,A),s=S|0}({h:n,l:s}=Kr(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=Kr(this.Bh|0,this.Bl|0,i|0,o|0),{h:l,l:c}=Kr(this.Ch|0,this.Cl|0,l|0,c|0),{h:d,l:f}=Kr(this.Dh|0,this.Dl|0,d|0,f|0),{h:a,l:u}=Kr(this.Eh|0,this.El|0,a|0,u|0),{h,l:p}=Kr(this.Fh|0,this.Fl|0,h|0,p|0),{h:y,l:g}=Kr(this.Gh|0,this.Gl|0,y|0,g|0),{h:m,l:w}=Kr(this.Hh|0,this.Hl|0,m|0,w|0),this.set(n,s,i,o,l,c,d,f,a,u,h,p,y,g,m,w)}roundClean(){ln(wn,_n)}destroy(){ln(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class YA extends GA{Ah=Et[0]|0;Al=Et[1]|0;Bh=Et[2]|0;Bl=Et[3]|0;Ch=Et[4]|0;Cl=Et[5]|0;Dh=Et[6]|0;Dl=Et[7]|0;Eh=Et[8]|0;El=Et[9]|0;Fh=Et[10]|0;Fl=Et[11]|0;Gh=Et[12]|0;Gl=Et[13]|0;Hh=Et[14]|0;Hl=Et[15]|0;constructor(){super(64)}}const Vo=wd(()=>new HA,Jm(1)),Ul=wd(()=>new YA,Jm(3));const Sd=BigInt(0),_u=BigInt(1);function bs(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function ny(r){if(typeof r=="bigint"){if(!wa(r))throw new Error("positive bigint expected, got "+r)}else Rr(r);return r}function ta(r){const e=ny(r).toString(16);return e.length&1?"0"+e:e}function sy(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Sd:BigInt("0x"+r)}function Vl(r){return sy(Uo(r))}function po(r){return sy(Uo(Su(ve(r)).reverse()))}function Ed(r,e){Rr(e),r=ny(r);const t=ho(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function iy(r,e){return Ed(r,e).reverse()}function Su(r){return Uint8Array.from(r)}const wa=r=>typeof r=="bigint"&&Sd<=r;function XA(r,e,t){return wa(r)&&wa(e)&&wa(t)&&e<=r&&r<t}function Eu(r,e,t,n){if(!XA(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function ZA(r){let e;for(e=0;r>Sd;r>>=_u,e+=1);return e}const xd=r=>(_u<<BigInt(r))-_u;function jA(r,e,t){if(Rr(r,"hashLen"),Rr(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=g=>new Uint8Array(g),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),l=1e3;let c=n(r),d=n(r),f=0;const a=()=>{c.fill(1),d.fill(0),f=0},u=(...g)=>t(d,Dr(c,...g)),h=(g=s)=>{d=u(i,g),c=u(),g.length!==0&&(d=u(o,g),c=u())},p=()=>{if(f++>=l)throw new Error("drbg: tried max amount of iterations");let g=0;const m=[];for(;g<e;){c=u();const w=c.slice();m.push(w),g+=c.length}return Dr(...m)};return(g,m)=>{a(),h(g);let w;for(;!(w=m(p()));)h();return a(),w}}function Ko(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,l){const c=r[i];if(l&&c===void 0)return;const d=typeof c;if(d!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${d}`)}const s=(i,o)=>Object.entries(i).forEach(([l,c])=>n(l,c,o));s(e,!1),s(t,!0)}function qa(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const zt=BigInt(0),wt=BigInt(1),Jn=BigInt(2),oy=BigInt(3),ay=BigInt(4),ly=BigInt(5),QA=BigInt(7),cy=BigInt(8),JA=BigInt(9),uy=BigInt(16);function Je(r,e){const t=r%e;return t>=zt?t:e+t}function Ge(r,e,t){let n=r;for(;e-- >zt;)n*=n,n%=t;return n}function kh(r,e){if(r===zt)throw new Error("invert: expected non-zero number");if(e<=zt)throw new Error("invert: expected positive modulus, got "+e);let t=Je(r,e),n=e,s=zt,i=wt;for(;t!==zt;){const l=n/t,c=n%t,d=s-i*l;n=t,t=c,s=i,i=d}if(n!==wt)throw new Error("invert: does not exist");return Je(s,e)}function Ad(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function dy(r,e){const t=(r.ORDER+wt)/ay,n=r.pow(e,t);return Ad(r,n,e),n}function e2(r,e){const t=(r.ORDER-ly)/cy,n=r.mul(e,Jn),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,Jn),s),l=r.mul(i,r.sub(o,r.ONE));return Ad(r,l,e),l}function t2(r){const e=Kl(r),t=fy(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+QA)/uy;return(l,c)=>{let d=l.pow(c,o),f=l.mul(d,n);const a=l.mul(d,s),u=l.mul(d,i),h=l.eql(l.sqr(f),c),p=l.eql(l.sqr(a),c);d=l.cmov(d,f,h),f=l.cmov(u,a,p);const y=l.eql(l.sqr(f),c),g=l.cmov(d,f,y);return Ad(l,g,c),g}}function fy(r){if(r<oy)throw new Error("sqrt is not defined for small field");let e=r-wt,t=0;for(;e%Jn===zt;)e/=Jn,t++;let n=Jn;const s=Kl(r);for(;Ch(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return dy;let i=s.pow(n,e);const o=(e+wt)/Jn;return function(c,d){if(c.is0(d))return d;if(Ch(c,d)!==1)throw new Error("Cannot find square root");let f=t,a=c.mul(c.ONE,i),u=c.pow(d,e),h=c.pow(d,o);for(;!c.eql(u,c.ONE);){if(c.is0(u))return c.ZERO;let p=1,y=c.sqr(u);for(;!c.eql(y,c.ONE);)if(p++,y=c.sqr(y),p===f)throw new Error("Cannot find square root");const g=wt<<BigInt(f-p-1),m=c.pow(a,g);f=p,a=c.sqr(m),u=c.mul(u,a),h=c.mul(h,m)}return h}}function r2(r){return r%ay===oy?dy:r%cy===ly?e2:r%uy===JA?t2(r):fy(r)}const n2=(r,e)=>(Je(r,e)&wt)===wt,s2=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function i2(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=s2.reduce((n,s)=>(n[s]="function",n),e);return Ko(r,t),r}function o2(r,e,t){if(t<zt)throw new Error("invalid exponent, negatives unsupported");if(t===zt)return r.ONE;if(t===wt)return e;let n=r.ONE,s=e;for(;t>zt;)t&wt&&(n=r.mul(n,s)),s=r.sqr(s),t>>=wt;return n}function hy(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,l,c)=>r.is0(l)?o:(n[c]=o,r.mul(o,l)),r.ONE),i=r.inv(s);return e.reduceRight((o,l,c)=>r.is0(l)?o:(n[c]=r.mul(o,n[c]),r.mul(o,l)),i),n}function Ch(r,e){const t=(r.ORDER-wt)/Jn,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function a2(r,e){e!==void 0&&Rr(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}class l2{ORDER;BITS;BYTES;isLE;ZERO=zt;ONE=wt;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=zt)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=a2(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Je(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return zt<=e&&e<this.ORDER}is0(e){return e===zt}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&wt)===wt}neg(e){return Je(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Je(e*e,this.ORDER)}add(e,t){return Je(e+t,this.ORDER)}sub(e,t){return Je(e-t,this.ORDER)}mul(e,t){return Je(e*t,this.ORDER)}pow(e,t){return o2(this,e,t)}div(e,t){return Je(e*kh(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return kh(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=r2(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?iy(e,this.BYTES):Ed(e,this.BYTES)}fromBytes(e,t=!1){ve(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:l}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const d=new Uint8Array(s);d.set(e,i?0:d.length-e.length),e=d}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?po(e):Vl(e);if(l&&(c=Je(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return hy(this,e)}cmov(e,t,n){return n?t:e}}function Kl(r,e={}){return new l2(r,e)}function py(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function gy(r){const e=py(r);return e+Math.ceil(e/2)}function c2(r,e,t=!1){ve(r);const n=r.length,s=py(e),i=gy(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?po(r):Vl(r),l=Je(o,e-wt)+wt;return t?iy(l,s):Ed(l,s)}const oi=BigInt(0),es=BigInt(1);function Ha(r,e){const t=e.negate();return r?t:e}function Zi(r,e){const t=hy(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function my(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function cc(r,e){my(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=xd(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function Th(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let l=Number(r&s),c=r>>o;l>n&&(l-=i,c+=es);const d=e*n,f=d+Math.abs(l)-1,a=l===0,u=l<0,h=e%2!==0;return{nextN:c,offset:f,isZero:a,isNeg:u,isNegF:h,offsetF:d}}const uc=new WeakMap,yy=new WeakMap;function dc(r){return yy.get(r)||1}function Ph(r){if(r!==oi)throw new Error("invalid wNAF")}class by{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>oi;)t&es&&(n=n.add(s)),s=s.double(),t>>=es;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=cc(t,this.bits),i=[];let o=e,l=o;for(let c=0;c<n;c++){l=o,i.push(l);for(let d=1;d<s;d++)l=l.add(o),i.push(l);o=l.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=cc(e,this.bits);for(let l=0;l<o.windows;l++){const{nextN:c,offset:d,isZero:f,isNeg:a,isNegF:u,offsetF:h}=Th(n,l,o);n=c,f?i=i.add(Ha(u,t[h])):s=s.add(Ha(a,t[d]))}return Ph(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=cc(e,this.bits);for(let o=0;o<i.windows&&n!==oi;o++){const{nextN:l,offset:c,isZero:d,isNeg:f}=Th(n,o,i);if(n=l,!d){const a=t[c];s=s.add(f?a.negate():a)}}return Ph(n),s}getPrecomputes(e,t,n){let s=uc.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),uc.set(t,s))),s}cached(e,t,n){const s=dc(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=dc(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){my(t,this.bits),yy.set(e,t),uc.delete(e)}hasCache(e){return dc(e)!==1}}function u2(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>oi||n>oi;)t&es&&(i=i.add(s)),n&es&&(o=o.add(s)),s=s.double(),t>>=es,n>>=es;return{p1:i,p2:o}}function Dh(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return i2(e),e}else return Kl(r,{isLE:t})}function vy(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const d=e[c];if(!(typeof d=="bigint"&&d>oi))throw new Error(`CURVE.${c} must be positive bigint`)}const s=Dh(e.p,t.Fp,n),i=Dh(e.n,t.Fn,n),l=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of l)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function wy(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const Sn=BigInt(0),lt=BigInt(1),fc=BigInt(2),d2=BigInt(8);function f2(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),l=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,l)}function h2(r,e={}){const t=vy("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;Ko(e,{},{uvRatio:"function"});const l=fc<<BigInt(s.BYTES*8)-lt,c=g=>n.create(g),d=e.uvRatio||((g,m)=>{try{return{isValid:!0,value:n.sqrt(n.div(g,m))}}catch{return{isValid:!1,value:Sn}}});if(!f2(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function f(g,m,w=!1){const v=w?lt:Sn;return Eu("coordinate "+g,m,v,l),m}function a(g){if(!(g instanceof p))throw new Error("EdwardsPoint expected")}const u=qa((g,m)=>{const{X:w,Y:v,Z:_}=g,k=g.is0();m==null&&(m=k?d2:n.inv(_));const P=c(w*m),D=c(v*m),I=n.mul(_,m);if(k)return{x:Sn,y:lt};if(I!==lt)throw new Error("invZ was invalid");return{x:P,y:D}}),h=qa(g=>{const{a:m,d:w}=i;if(g.is0())throw new Error("bad point: ZERO");const{X:v,Y:_,Z:k,T:P}=g,D=c(v*v),I=c(_*_),x=c(k*k),B=c(x*x),Q=c(D*m),M=c(x*c(Q+I)),A=c(B+c(w*c(D*I)));if(M!==A)throw new Error("bad point: equation left != right (1)");const E=c(v*_),S=c(k*P);if(E!==S)throw new Error("bad point: equation left != right (2)");return!0});class p{static BASE=new p(i.Gx,i.Gy,lt,c(i.Gx*i.Gy));static ZERO=new p(Sn,lt,lt,Sn);static Fp=n;static Fn=s;X;Y;Z;T;constructor(m,w,v,_){this.X=f("x",m),this.Y=f("y",w),this.Z=f("z",v,!0),this.T=f("t",_),Object.freeze(this)}static CURVE(){return i}static fromAffine(m){if(m instanceof p)throw new Error("extended point not allowed");const{x:w,y:v}=m||{};return f("x",w),f("y",v),new p(w,v,lt,c(w*v))}static fromBytes(m,w=!1){const v=n.BYTES,{a:_,d:k}=i;m=Su(ve(m,v,"point")),bs(w,"zip215");const P=Su(m),D=m[v-1];P[v-1]=D&-129;const I=po(P),x=w?l:n.ORDER;Eu("point.y",I,Sn,x);const B=c(I*I),Q=c(B-lt),M=c(k*B-_);let{isValid:A,value:E}=d(Q,M);if(!A)throw new Error("bad point: invalid y coordinate");const S=(E&lt)===lt,T=(D&128)!==0;if(!w&&E===Sn&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(E=c(-E)),p.fromAffine({x:E,y:I})}static fromHex(m,w=!1){return p.fromBytes(ho(m),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(m=8,w=!0){return y.createCache(this,m),w||this.multiply(fc),this}assertValidity(){h(this)}equals(m){a(m);const{X:w,Y:v,Z:_}=this,{X:k,Y:P,Z:D}=m,I=c(w*D),x=c(k*_),B=c(v*D),Q=c(P*_);return I===x&&B===Q}is0(){return this.equals(p.ZERO)}negate(){return new p(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:m}=i,{X:w,Y:v,Z:_}=this,k=c(w*w),P=c(v*v),D=c(fc*c(_*_)),I=c(m*k),x=w+v,B=c(c(x*x)-k-P),Q=I+P,M=Q-D,A=I-P,E=c(B*M),S=c(Q*A),T=c(B*A),C=c(M*Q);return new p(E,S,C,T)}add(m){a(m);const{a:w,d:v}=i,{X:_,Y:k,Z:P,T:D}=this,{X:I,Y:x,Z:B,T:Q}=m,M=c(_*I),A=c(k*x),E=c(D*v*Q),S=c(P*B),T=c((_+k)*(I+x)-M-A),C=S-E,L=S+E,R=c(A-w*M),N=c(T*C),$=c(L*R),q=c(T*R),F=c(C*L);return new p(N,$,F,q)}subtract(m){return this.add(m.negate())}multiply(m){if(!s.isValidNot0(m))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:w,f:v}=y.cached(this,m,_=>Zi(p,_));return Zi(p,[w,v])[0]}multiplyUnsafe(m,w=p.ZERO){if(!s.isValid(m))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return m===Sn?p.ZERO:this.is0()||m===lt?this:y.unsafe(this,m,v=>Zi(p,v),w)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return y.unsafe(this,i.n).is0()}toAffine(m){return u(this,m)}clearCofactor(){return o===lt?this:this.multiplyUnsafe(o)}toBytes(){const{x:m,y:w}=this.toAffine(),v=n.toBytes(w);return v[v.length-1]|=m&lt?128:0,v}toHex(){return Uo(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const y=new by(p,s.BITS);return p.BASE.precompute(8),p}function p2(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Ko(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,l=t.randomBytes||Fl,c=t.adjustScalarBytes||(I=>I),d=t.domain||((I,x,B)=>{if(bs(B,"phflag"),x.length||B)throw new Error("Contexts/pre-hash are not supported");return I});function f(I){return o.create(po(I))}function a(I){const x=v.secretKey;ve(I,v.secretKey,"secretKey");const B=ve(e(I),2*x,"hashedSecretKey"),Q=c(B.slice(0,x)),M=B.slice(x,2*x),A=f(Q);return{head:Q,prefix:M,scalar:A}}function u(I){const{head:x,prefix:B,scalar:Q}=a(I),M=s.multiply(Q),A=M.toBytes();return{head:x,prefix:B,scalar:Q,point:M,pointBytes:A}}function h(I){return u(I).pointBytes}function p(I=Uint8Array.of(),...x){const B=Dr(...x);return f(e(d(B,ve(I,void 0,"context"),!!n)))}function y(I,x,B={}){I=ve(I,void 0,"message"),n&&(I=n(I));const{prefix:Q,scalar:M,pointBytes:A}=u(x),E=p(B.context,Q,I),S=s.multiply(E).toBytes(),T=p(B.context,S,A,I),C=o.create(E+T*M);if(!o.isValid(C))throw new Error("sign failed: invalid s");const L=Dr(S,o.toBytes(C));return ve(L,v.signature,"result")}const g={zip215:!0};function m(I,x,B,Q=g){const{context:M,zip215:A}=Q,E=v.signature;I=ve(I,E,"signature"),x=ve(x,void 0,"message"),B=ve(B,v.publicKey,"publicKey"),A!==void 0&&bs(A,"zip215"),n&&(x=n(x));const S=E/2,T=I.subarray(0,S),C=po(I.subarray(S,E));let L,R,N;try{L=r.fromBytes(B,A),R=r.fromBytes(T,A),N=s.multiplyUnsafe(C)}catch{return!1}if(!A&&L.isSmallOrder())return!1;const $=p(M,R.toBytes(),L.toBytes(),x);return R.add(L.multiplyUnsafe($)).subtract(N).clearCofactor().is0()}const w=i.BYTES,v={secretKey:w,publicKey:w,signature:2*w,seed:w};function _(I=l(v.seed)){return ve(I,v.seed,"seed")}function k(I){return $l(I)&&I.length===o.BYTES}function P(I,x){try{return!!r.fromBytes(I,x)}catch{return!1}}const D={getExtendedPublicKey:u,randomSecretKey:_,isValidSecretKey:k,isValidPublicKey:P,toMontgomery(I){const{y:x}=r.fromBytes(I),B=v.publicKey,Q=B===32;if(!Q&&B!==57)throw new Error("only defined for 25519 and 448");const M=Q?i.div(lt+x,lt-x):i.div(x-lt,x+lt);return i.toBytes(M)},toMontgomerySecret(I){const x=v.secretKey;ve(I,x);const B=e(I.subarray(0,x));return c(B).subarray(0,x)}};return Object.freeze({keygen:wy(_,h),getPublicKey:h,sign:y,verify:m,utils:D,Point:r,lengths:v})}const g2=BigInt(1),Lh=BigInt(2),m2=BigInt(5),y2=BigInt(8),Id=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),b2={p:Id,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:y2,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function v2(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Id,l=r*r%i*r%i,c=Ge(l,Lh,i)*l%i,d=Ge(c,g2,i)*r%i,f=Ge(d,m2,i)*d%i,a=Ge(f,e,i)*f%i,u=Ge(a,t,i)*a%i,h=Ge(u,n,i)*u%i,p=Ge(h,s,i)*h%i,y=Ge(p,s,i)*h%i,g=Ge(y,e,i)*f%i;return{pow_p_5_8:Ge(g,Lh,i)*r%i,b2:l}}function w2(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const Rh=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function _2(r,e){const t=Id,n=Je(e*e*e,t),s=Je(n*n*e,t),i=v2(r*s).pow_p_5_8;let o=Je(r*n*i,t);const l=Je(e*o*o,t),c=o,d=Je(o*Rh,t),f=l===r,a=l===Je(-r,t),u=l===Je(-r*Rh,t);return f&&(o=c),(a||u)&&(o=d),n2(o,t)&&(o=Je(-o,t)),{isValid:f||a,value:o}}const S2=h2(b2,{uvRatio:_2});function E2(r){return p2(S2,Ul,Object.assign({adjustScalarBytes:w2},r))}const za=E2({}),go=32,Tr=64,xu=32;let Gs;const _y=(async()=>{try{return await Ot.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function x2(){const r=za.utils.randomSecretKey(),e=za.getPublicKey(r);return{privateKey:D2(r,e),publicKey:e}}async function A2(r,e){let t;r.length===Tr?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:W(r.subarray(32),"base64url"),d:W(t,"base64url"),ext:!0,key_ops:["sign"]},s=await Ot.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Ot.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function I2(r,e){const t=r.subarray(0,xu);return za.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function k2(r,e){return Gs==null&&(Gs=await _y),Gs?A2(r,e):I2(r,e)}async function C2(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Ot.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Ot.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function T2(r,e,t){return za.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function P2(r,e,t){return Gs==null&&(Gs=await _y),Gs?C2(r,e,t):T2(r,e,t)}function D2(r,e){const t=new Uint8Array(Tr);for(let n=0;n<xu;n++)t[n]=r[n],t[xu+n]=e[n];return t}function ql(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class Sy{type="Ed25519";raw;constructor(e){this.raw=mo(e,go)}toMultihash(){return it.digest(Sr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return De.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=P2(this.raw,t,e);return ql(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}class Au{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=mo(e,Tr),this.publicKey=new Sy(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=k2(this.raw,e);return ql(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function Ey(r){if(r.length>Tr){r=mo(r,Tr+go);const n=r.subarray(0,Tr),s=r.subarray(Tr,r.length);return new Au(n,s)}r=mo(r,Tr);const e=r.subarray(0,Tr),t=r.subarray(go);return new Au(e,t)}function kd(r){return r=mo(r,go),new Sy(r)}async function L2(){const{privateKey:r,publicKey:e}=x2();return new Au(r,e)}function mo(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new V(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const R2=Math.pow(2,7),B2=Math.pow(2,14),N2=Math.pow(2,21),Cd=Math.pow(2,28),Td=Math.pow(2,35),Pd=Math.pow(2,42),Dd=Math.pow(2,49),Ee=128,At=127;function Ar(r){if(r<R2)return 1;if(r<B2)return 2;if(r<N2)return 3;if(r<Cd)return 4;if(r<Td)return 5;if(r<Pd)return 6;if(r<Dd)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Wa(r,e,t=0){switch(Ar(r)){case 8:e[t++]=r&255|Ee,r/=128;case 7:e[t++]=r&255|Ee,r/=128;case 6:e[t++]=r&255|Ee,r/=128;case 5:e[t++]=r&255|Ee,r/=128;case 4:e[t++]=r&255|Ee,r>>>=7;case 3:e[t++]=r&255|Ee,r>>>=7;case 2:e[t++]=r&255|Ee,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function M2(r,e,t=0){switch(Ar(r)){case 8:e.set(t++,r&255|Ee),r/=128;case 7:e.set(t++,r&255|Ee),r/=128;case 6:e.set(t++,r&255|Ee),r/=128;case 5:e.set(t++,r&255|Ee),r/=128;case 4:e.set(t++,r&255|Ee),r>>>=7;case 3:e.set(t++,r&255|Ee),r>>>=7;case 2:e.set(t++,r&255|Ee),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function xy(r,e){let t=r[e],n=0;if(n+=t&At,t<Ee||(t=r[e+1],n+=(t&At)<<7,t<Ee)||(t=r[e+2],n+=(t&At)<<14,t<Ee)||(t=r[e+3],n+=(t&At)<<21,t<Ee)||(t=r[e+4],n+=(t&At)*Cd,t<Ee)||(t=r[e+5],n+=(t&At)*Td,t<Ee)||(t=r[e+6],n+=(t&At)*Pd,t<Ee)||(t=r[e+7],n+=(t&At)*Dd,t<Ee))return n;throw new RangeError("Could not decode varint")}function O2(r,e){let t=r.get(e),n=0;if(n+=t&At,t<Ee||(t=r.get(e+1),n+=(t&At)<<7,t<Ee)||(t=r.get(e+2),n+=(t&At)<<14,t<Ee)||(t=r.get(e+3),n+=(t&At)<<21,t<Ee)||(t=r.get(e+4),n+=(t&At)*Cd,t<Ee)||(t=r.get(e+5),n+=(t&At)*Td,t<Ee)||(t=r.get(e+6),n+=(t&At)*Pd,t<Ee)||(t=r.get(e+7),n+=(t&At)*Dd,t<Ee))return n;throw new RangeError("Could not decode varint")}function ji(r,e,t=0){return e==null&&(e=on(Ar(r))),e instanceof Uint8Array?Wa(r,e,t):M2(r,e,t)}function Ld(r,e=0){return r instanceof Uint8Array?xy(r,e):O2(r,e)}const Rd=new Float32Array([-0]),In=new Uint8Array(Rd.buffer);function $2(r,e,t){Rd[0]=r,e[t]=In[0],e[t+1]=In[1],e[t+2]=In[2],e[t+3]=In[3]}function F2(r,e){return In[0]=r[e],In[1]=r[e+1],In[2]=r[e+2],In[3]=r[e+3],Rd[0]}const Bd=new Float64Array([-0]),It=new Uint8Array(Bd.buffer);function U2(r,e,t){Bd[0]=r,e[t]=It[0],e[t+1]=It[1],e[t+2]=It[2],e[t+3]=It[3],e[t+4]=It[4],e[t+5]=It[5],e[t+6]=It[6],e[t+7]=It[7]}function V2(r,e){return It[0]=r[e],It[1]=r[e+1],It[2]=r[e+2],It[3]=r[e+3],It[4]=r[e+4],It[5]=r[e+5],It[6]=r[e+6],It[7]=r[e+7],Bd[0]}const K2=BigInt(Number.MAX_SAFE_INTEGER),q2=BigInt(Number.MIN_SAFE_INTEGER);class kt{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return us;if(e<K2&&e>q2)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>Bh&&(s=0n,++n>Bh&&(n=0n))),new kt(Number(s),Number(n))}static fromNumber(e){if(e===0)return us;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new kt(n,s)}static from(e){return typeof e=="number"?kt.fromNumber(e):typeof e=="bigint"?kt.fromBigInt(e):typeof e=="string"?kt.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new kt(e.low>>>0,e.high>>>0):us}}const us=new kt(0,0);us.toBigInt=function(){return 0n};us.zzEncode=us.zzDecode=function(){return this};us.length=function(){return 1};const Bh=4294967296n;function H2(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function z2(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,l;for(;e<t;)l=r[e++],l<128?i[o++]=l:l>191&&l<224?i[o++]=(l&31)<<6|r[e++]&63:l>239&&l<365?(l=((l&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(l>>10),i[o++]=56320+(l&1023)):i[o++]=(l&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function Ay(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function mr(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function ra(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class W2{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,mr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw mr(this,4);return ra(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw mr(this,4);return ra(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw mr(this,4);const e=F2(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw mr(this,4);const e=V2(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw mr(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return z2(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw mr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw mr(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new kt(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw mr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw mr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw mr(this,8);const e=ra(this.buf,this.pos+=4),t=ra(this.buf,this.pos+=4);return new kt(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=xy(this.buf,this.pos);return this.pos+=Ar(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function G2(r){return new W2(r instanceof Uint8Array?r:r.subarray())}function Ie(r,e,t){const n=G2(r);return e.decode(n,void 0,t)}function Y2(r){let n,s=8192;return function(o){if(o<1||o>4096)return on(o);s+o>8192&&(n=on(8192),s=0);const l=n.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),l}}class qi{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function hc(){}class X2{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const Z2=Y2();function j2(r){return globalThis.Buffer!=null?on(r):Z2(r)}class Iu{len;head;tail;states;constructor(){this.len=0,this.head=new qi(hc,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new qi(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new J2((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(na,10,kt.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=kt.fromBigInt(e);return this._push(na,t.length(),t)}uint64Number(e){return this._push(Wa,Ar(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=kt.fromBigInt(e).zzEncode();return this._push(na,t.length(),t)}sint64Number(e){const t=kt.fromNumber(e).zzEncode();return this._push(na,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(pc,1,e?1:0)}fixed32(e){return this._push(Ri,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=kt.fromBigInt(e);return this._push(Ri,4,t.lo)._push(Ri,4,t.hi)}fixed64Number(e){const t=kt.fromNumber(e);return this._push(Ri,4,t.lo)._push(Ri,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push($2,4,e)}double(e){return this._push(U2,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(pc,1,0):this.uint32(t)._push(eI,t,e)}string(e){const t=H2(e);return t!==0?this.uint32(t)._push(Ay,t,e):this._push(pc,1,0)}fork(){return this.states=new X2(this),this.head=this.tail=new qi(hc,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new qi(hc,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=j2(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function pc(r,e,t){e[t]=r&255}function Q2(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class J2 extends qi{next;constructor(e,t){super(Q2,e,t),this.next=void 0}}function na(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Ri(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function eI(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Iu.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(tI,e,r),this},Iu.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(rI,e,r),this});function tI(r,e,t){e.set(r,t)}function rI(r,e,t){r.length<40?Ay(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(j(r),t)}function nI(){return new Iu}function ke(r,e){const t=nI();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Ga;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Ga||(Ga={}));function Iy(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function qo(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const l=e(i);o.int32(l)},n=function(i){const o=i.int32();return e(o)};return Iy("enum",Ga.VARINT,t,n)}function Ce(r,e){return Iy("message",Ga.LENGTH_DELIMITED,r,e)}class vt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class Nh extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var ze;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(ze||(ze={}));var ku;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(ku||(ku={}));(function(r){r.codec=()=>qo(ku)})(ze||(ze={}));var $n;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ze.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=ze.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})($n||($n={}));var Ya;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ze.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=ze.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Ya||(Ya={}));function ai(r){if(isNaN(r)||r<=0)throw new V("random bytes length must be a Number bigger than 0");return Fl(r)}class Nd{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Od(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return ue.createV1(114,this._multihash)}toString(){return De.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return yI(this.jwk,t,e,n)}}class ky{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=aI(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return mI(this.jwk,e,t)}}const Cy=8192,Md=18,sI=1062,iI=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function oI(r){return{n:W(r[1],"base64url"),e:W(r[2],"base64url"),d:W(r[3],"base64url"),p:W(r[4],"base64url"),q:W(r[5],"base64url"),dp:W(r[6],"base64url"),dq:W(r[7],"base64url"),qi:W(r[8],"base64url"),kty:"RSA"}}function aI(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new V("JWK was missing components");return rn([Xt(Uint8Array.from([0])),Xt(j(r.n,"base64url")),Xt(j(r.e,"base64url")),Xt(j(r.d,"base64url")),Xt(j(r.p,"base64url")),Xt(j(r.q,"base64url")),Xt(j(r.dp,"base64url")),Xt(j(r.dq,"base64url")),Xt(j(r.qi,"base64url"))]).subarray()}function lI(r){const e=qn(r[1],{offset:0});return{kty:"RSA",n:W(e[0],"base64url"),e:W(e[1],"base64url")}}function Od(r){if(r.n==null||r.e==null)throw new V("JWK was missing components");return rn([iI,bd(rn([Xt(j(r.n,"base64url")),Xt(j(r.e,"base64url"))]))]).subarray()}function cI(r){const e=qn(r);return Ty(e)}function Ty(r){const e=oI(r);return dI(e)}function uI(r,e){if(r.byteLength>=sI)throw new Bm("Key size is too large");const t=qn(r,{offset:0});return Py(t,r,e)}function Py(r,e,t){const n=lI(r);if(t==null){const s=Vo($n.encode({Type:ze.RSA,Data:e}));t=Si(Md,s)}return new Nd(n,t)}function dI(r){if(vI(r)>Cy)throw new V("Key size is too large");const e=hI(r),t=Vo($n.encode({Type:ze.RSA,Data:Od(e.publicKey)})),n=Si(Md,t);return new ky(e.privateKey,new Nd(e.publicKey,n))}async function fI(r){if(r>Cy)throw new V("Key size is too large");const e=await gI(r),t=Vo($n.encode({Type:ze.RSA,Data:Od(e.publicKey)})),n=Si(Md,t);return new ky(e.privateKey,new Nd(e.publicKey,n))}function hI(r){if(r==null)throw new V("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const pI="1.2.840.113549.1.1.1";async function gI(r,e){const t=await Ot.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await bI(t);return{privateKey:n[0],publicKey:n[1]}}async function mI(r,e,t){const n=await Ot.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const s=await Ot.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function yI(r,e,t,n){const s=await Ot.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Ot.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function bI(r,e){if(r.privateKey==null||r.publicKey==null)throw new V("Private and public key are required");return await Promise.all([Ot.get().subtle.exportKey("jwk",r.privateKey),Ot.get().subtle.exportKey("jwk",r.publicKey)])}function vI(r){if(r.kty!=="RSA")throw new V("invalid key type");if(r.n==null)throw new V("invalid key modulus");return j(r.n,"base64url").length*8}class Dy{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(vd(e),ve(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),ln(s)}update(e){return Ka(this),this.iHash.update(e),this}digestInto(e){Ka(this),ve(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:l}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=l,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const $d=(r,e,t)=>new Dy(r,e).update(t).digest();$d.create=(r,e)=>new Dy(r,e);const Mh=(r,e)=>(r+(r>=0?e:-e)/Ly)/e;function wI(r,e,t){const[[n,s],[i,o]]=e,l=Mh(o*r,t),c=Mh(-s*r,t);let d=r-l*n-c*i,f=-l*s-c*o;const a=d<Jr,u=f<Jr;a&&(d=-d),u&&(f=-f);const h=xd(Math.ceil(ZA(t)/2))+Ys;if(d<Jr||d>=h||f<Jr||f>=h)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:a,k1:d,k2neg:u,k2:f}}function Cu(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function gc(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return bs(t.lowS,"lowS"),bs(t.prehash,"prehash"),t.format!==void 0&&Cu(t.format),t}class _I extends Error{constructor(e=""){super(e)}}const An={Err:_I,_tlv:{encode:(r,e)=>{const{Err:t}=An;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=ta(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?ta(s.length/2|128):"";return ta(r)+i+s+e},decode(r,e){const{Err:t}=An;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const d=e.subarray(n,n+c);if(d.length!==c)throw new t("tlv.decode: length bytes not complete");if(d[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const f of d)o=o<<8|f;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const l=e.subarray(n,n+o);if(l.length!==o)throw new t("tlv.decode: wrong value length");return{v:l,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=An;if(r<Jr)throw new e("integer: negative integers are not allowed");let t=ta(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=An;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Vl(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=An,s=ve(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:l,l:c}=n.decode(2,i),{v:d,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(l),s:t.decode(d)}},hexFromSig(r){const{_tlv:e,_int:t}=An,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Jr=BigInt(0),Ys=BigInt(1),Ly=BigInt(2),sa=BigInt(3),SI=BigInt(4);function EI(r,e={}){const t=vy("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:l}=i;Ko(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const d=By(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function a(M,A,E){const{x:S,y:T}=A.toAffine(),C=n.toBytes(S);if(bs(E,"isCompressed"),E){f();const L=!n.isOdd(T);return Dr(Ry(L),C)}else return Dr(Uint8Array.of(4),C,n.toBytes(T))}function u(M){ve(M,void 0,"Point");const{publicKey:A,publicKeyUncompressed:E}=d,S=M.length,T=M[0],C=M.subarray(1);if(S===A&&(T===2||T===3)){const L=n.fromBytes(C);if(!n.isValid(L))throw new Error("bad point: is not on curve, wrong x");const R=y(L);let N;try{N=n.sqrt(R)}catch(F){const H=F instanceof Error?": "+F.message:"";throw new Error("bad point: is not on curve, sqrt error"+H)}f();const $=n.isOdd(N);return(T&1)===1!==$&&(N=n.neg(N)),{x:L,y:N}}else if(S===E&&T===4){const L=n.BYTES,R=n.fromBytes(C.subarray(0,L)),N=n.fromBytes(C.subarray(L,L*2));if(!g(R,N))throw new Error("bad point: is not on curve");return{x:R,y:N}}else throw new Error(`bad point: got length ${S}, expected compressed=${A} or uncompressed=${E}`)}const h=e.toBytes||a,p=e.fromBytes||u;function y(M){const A=n.sqr(M),E=n.mul(A,M);return n.add(n.add(E,n.mul(M,i.a)),i.b)}function g(M,A){const E=n.sqr(A),S=y(M);return n.eql(E,S)}if(!g(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const m=n.mul(n.pow(i.a,sa),SI),w=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(m,w)))throw new Error("bad curve params: a or b");function v(M,A,E=!1){if(!n.isValid(A)||E&&n.is0(A))throw new Error(`bad point coordinate ${M}`);return A}function _(M){if(!(M instanceof x))throw new Error("Weierstrass Point expected")}function k(M){if(!c||!c.basises)throw new Error("no endo");return wI(M,c.basises,s.ORDER)}const P=qa((M,A)=>{const{X:E,Y:S,Z:T}=M;if(n.eql(T,n.ONE))return{x:E,y:S};const C=M.is0();A==null&&(A=C?n.ONE:n.inv(T));const L=n.mul(E,A),R=n.mul(S,A),N=n.mul(T,A);if(C)return{x:n.ZERO,y:n.ZERO};if(!n.eql(N,n.ONE))throw new Error("invZ was invalid");return{x:L,y:R}}),D=qa(M=>{if(M.is0()){if(e.allowInfinityPoint&&!n.is0(M.Y))return;throw new Error("bad point: ZERO")}const{x:A,y:E}=M.toAffine();if(!n.isValid(A)||!n.isValid(E))throw new Error("bad point: x or y not field elements");if(!g(A,E))throw new Error("bad point: equation left != right");if(!M.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function I(M,A,E,S,T){return E=new x(n.mul(E.X,M),E.Y,E.Z),A=Ha(S,A),E=Ha(T,E),A.add(E)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(A,E,S){this.X=v("x",A),this.Y=v("y",E,!0),this.Z=v("z",S),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){const{x:E,y:S}=A||{};if(!A||!n.isValid(E)||!n.isValid(S))throw new Error("invalid affine point");if(A instanceof x)throw new Error("projective point not allowed");return n.is0(E)&&n.is0(S)?x.ZERO:new x(E,S,n.ONE)}static fromBytes(A){const E=x.fromAffine(p(ve(A,void 0,"point")));return E.assertValidity(),E}static fromHex(A){return x.fromBytes(ho(A))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,E=!0){return Q.createCache(this,A),E||this.multiply(sa),this}assertValidity(){D(this)}hasEvenY(){const{y:A}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(A)}equals(A){_(A);const{X:E,Y:S,Z:T}=this,{X:C,Y:L,Z:R}=A,N=n.eql(n.mul(E,R),n.mul(C,T)),$=n.eql(n.mul(S,R),n.mul(L,T));return N&&$}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:A,b:E}=i,S=n.mul(E,sa),{X:T,Y:C,Z:L}=this;let R=n.ZERO,N=n.ZERO,$=n.ZERO,q=n.mul(T,T),F=n.mul(C,C),H=n.mul(L,L),G=n.mul(T,C);return G=n.add(G,G),$=n.mul(T,L),$=n.add($,$),R=n.mul(A,$),N=n.mul(S,H),N=n.add(R,N),R=n.sub(F,N),N=n.add(F,N),N=n.mul(R,N),R=n.mul(G,R),$=n.mul(S,$),H=n.mul(A,H),G=n.sub(q,H),G=n.mul(A,G),G=n.add(G,$),$=n.add(q,q),q=n.add($,q),q=n.add(q,H),q=n.mul(q,G),N=n.add(N,q),H=n.mul(C,L),H=n.add(H,H),q=n.mul(H,G),R=n.sub(R,q),$=n.mul(H,F),$=n.add($,$),$=n.add($,$),new x(R,N,$)}add(A){_(A);const{X:E,Y:S,Z:T}=this,{X:C,Y:L,Z:R}=A;let N=n.ZERO,$=n.ZERO,q=n.ZERO;const F=i.a,H=n.mul(i.b,sa);let G=n.mul(E,C),re=n.mul(S,L),ne=n.mul(T,R),K=n.add(E,S),ee=n.add(C,L);K=n.mul(K,ee),ee=n.add(G,re),K=n.sub(K,ee),ee=n.add(E,T);let ge=n.add(C,R);return ee=n.mul(ee,ge),ge=n.add(G,ne),ee=n.sub(ee,ge),ge=n.add(S,T),N=n.add(L,R),ge=n.mul(ge,N),N=n.add(re,ne),ge=n.sub(ge,N),q=n.mul(F,ee),N=n.mul(H,ne),q=n.add(N,q),N=n.sub(re,q),q=n.add(re,q),$=n.mul(N,q),re=n.add(G,G),re=n.add(re,G),ne=n.mul(F,ne),ee=n.mul(H,ee),re=n.add(re,ne),ne=n.sub(G,ne),ne=n.mul(F,ne),ee=n.add(ee,ne),G=n.mul(re,ee),$=n.add($,G),G=n.mul(ge,ee),N=n.mul(K,N),N=n.sub(N,G),G=n.mul(K,re),q=n.mul(ge,q),q=n.add(q,G),new x(N,$,q)}subtract(A){return this.add(A.negate())}is0(){return this.equals(x.ZERO)}multiply(A){const{endo:E}=e;if(!s.isValidNot0(A))throw new Error("invalid scalar: out of range");let S,T;const C=L=>Q.cached(this,L,R=>Zi(x,R));if(E){const{k1neg:L,k1:R,k2neg:N,k2:$}=k(A),{p:q,f:F}=C(R),{p:H,f:G}=C($);T=F.add(G),S=I(E.beta,q,H,L,N)}else{const{p:L,f:R}=C(A);S=L,T=R}return Zi(x,[S,T])[0]}multiplyUnsafe(A){const{endo:E}=e,S=this;if(!s.isValid(A))throw new Error("invalid scalar: out of range");if(A===Jr||S.is0())return x.ZERO;if(A===Ys)return S;if(Q.hasCache(this))return this.multiply(A);if(E){const{k1neg:T,k1:C,k2neg:L,k2:R}=k(A),{p1:N,p2:$}=u2(x,S,C,R);return I(E.beta,N,$,T,L)}else return Q.unsafe(S,A)}toAffine(A){return P(this,A)}isTorsionFree(){const{isTorsionFree:A}=e;return o===Ys?!0:A?A(x,this):Q.unsafe(this,l).is0()}clearCofactor(){const{clearCofactor:A}=e;return o===Ys?this:A?A(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(A=!0){return bs(A,"isCompressed"),this.assertValidity(),h(x,this,A)}toHex(A=!0){return Uo(this.toBytes(A))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const B=s.BITS,Q=new by(x,e.endo?Math.ceil(B/2):B);return x.BASE.precompute(8),x}function Ry(r){return Uint8Array.of(r?2:3)}function By(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function xI(r,e={}){const{Fn:t}=r,n=e.randomBytes||Fl,s=Object.assign(By(r.Fp,t),{seed:gy(t.ORDER)});function i(h){try{const p=t.fromBytes(h);return t.isValidNot0(p)}catch{return!1}}function o(h,p){const{publicKey:y,publicKeyUncompressed:g}=s;try{const m=h.length;return p===!0&&m!==y||p===!1&&m!==g?!1:!!r.fromBytes(h)}catch{return!1}}function l(h=n(s.seed)){return c2(ve(h,s.seed,"seed"),t.ORDER)}function c(h,p=!0){return r.BASE.multiply(t.fromBytes(h)).toBytes(p)}function d(h){const{secretKey:p,publicKey:y,publicKeyUncompressed:g}=s;if(!$l(h)||"_lengths"in t&&t._lengths||p===y)return;const m=ve(h,void 0,"key").length;return m===y||m===g}function f(h,p,y=!0){if(d(h)===!0)throw new Error("first arg must be private key");if(d(p)===!1)throw new Error("second arg must be public key");const g=t.fromBytes(h);return r.fromBytes(p).multiply(g).toBytes(y)}const a={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:l},u=wy(l,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:u,Point:r,utils:a,lengths:s})}function AI(r,e,t={}){vd(e),Ko(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||Fl,s=t.hmac||((E,S)=>$d(e,E,S)),{Fp:i,Fn:o}=r,{ORDER:l,BITS:c}=o,{keygen:d,getPublicKey:f,getSharedSecret:a,utils:u,lengths:h}=xI(r,t),p={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},y=l*Ly<i.ORDER;function g(E){const S=l>>Ys;return E>S}function m(E,S){if(!o.isValidNot0(S))throw new Error(`invalid signature ${E}: out of range 1..Point.Fn.ORDER`);return S}function w(){if(y)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function v(E,S){Cu(S);const T=h.signature,C=S==="compact"?T:S==="recovered"?T+1:void 0;return ve(E,C)}class _{r;s;recovery;constructor(S,T,C){if(this.r=m("r",S),this.s=m("s",T),C!=null){if(w(),![0,1,2,3].includes(C))throw new Error("invalid recovery id");this.recovery=C}Object.freeze(this)}static fromBytes(S,T=p.format){v(S,T);let C;if(T==="der"){const{r:$,s:q}=An.toSig(ve(S));return new _($,q)}T==="recovered"&&(C=S[0],T="compact",S=S.subarray(1));const L=h.signature/2,R=S.subarray(0,L),N=S.subarray(L,L*2);return new _(o.fromBytes(R),o.fromBytes(N),C)}static fromHex(S,T){return this.fromBytes(ho(S),T)}assertRecovery(){const{recovery:S}=this;if(S==null)throw new Error("invalid recovery id: must be present");return S}addRecoveryBit(S){return new _(this.r,this.s,S)}recoverPublicKey(S){const{r:T,s:C}=this,L=this.assertRecovery(),R=L===2||L===3?T+l:T;if(!i.isValid(R))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const N=i.toBytes(R),$=r.fromBytes(Dr(Ry((L&1)===0),N)),q=o.inv(R),F=P(ve(S,void 0,"msgHash")),H=o.create(-F*q),G=o.create(C*q),re=r.BASE.multiplyUnsafe(H).add($.multiplyUnsafe(G));if(re.is0())throw new Error("invalid recovery: point at infinify");return re.assertValidity(),re}hasHighS(){return g(this.s)}toBytes(S=p.format){if(Cu(S),S==="der")return ho(An.hexFromSig(this));const{r:T,s:C}=this,L=o.toBytes(T),R=o.toBytes(C);return S==="recovered"?(w(),Dr(Uint8Array.of(this.assertRecovery()),L,R)):Dr(L,R)}toHex(S){return Uo(this.toBytes(S))}}const k=t.bits2int||function(S){if(S.length>8192)throw new Error("input is too large");const T=Vl(S),C=S.length*8-c;return C>0?T>>BigInt(C):T},P=t.bits2int_modN||function(S){return o.create(k(S))},D=xd(c);function I(E){return Eu("num < 2^"+c,E,Jr,D),o.toBytes(E)}function x(E,S){return ve(E,void 0,"message"),S?ve(e(E),void 0,"prehashed message"):E}function B(E,S,T){const{lowS:C,prehash:L,extraEntropy:R}=gc(T,p);E=x(E,L);const N=P(E),$=o.fromBytes(S);if(!o.isValidNot0($))throw new Error("invalid private key");const q=[I($),I(N)];if(R!=null&&R!==!1){const re=R===!0?n(h.secretKey):R;q.push(ve(re,void 0,"extraEntropy"))}const F=Dr(...q),H=N;function G(re){const ne=k(re);if(!o.isValidNot0(ne))return;const K=o.inv(ne),ee=r.BASE.multiply(ne).toAffine(),ge=o.create(ee.x);if(ge===Jr)return;const Me=o.create(K*o.create(H+ge*$));if(Me===Jr)return;let tt=(ee.x===ge?0:2)|Number(ee.y&Ys),Oe=Me;return C&&g(Me)&&(Oe=o.neg(Me),tt^=1),new _(ge,Oe,y?void 0:tt)}return{seed:F,k2sig:G}}function Q(E,S,T={}){const{seed:C,k2sig:L}=B(E,S,T);return jA(e.outputLen,o.BYTES,s)(C,L).toBytes(T.format)}function M(E,S,T,C={}){const{lowS:L,prehash:R,format:N}=gc(C,p);if(T=ve(T,void 0,"publicKey"),S=x(S,R),!$l(E)){const $=E instanceof _?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+$)}v(E,N);try{const $=_.fromBytes(E,N),q=r.fromBytes(T);if(L&&$.hasHighS())return!1;const{r:F,s:H}=$,G=P(S),re=o.inv(H),ne=o.create(G*re),K=o.create(F*re),ee=r.BASE.multiplyUnsafe(ne).add(q.multiplyUnsafe(K));return ee.is0()?!1:o.create(ee.x)===F}catch{return!1}}function A(E,S,T={}){const{prehash:C}=gc(T,p);return S=x(S,C),_.fromBytes(E,"recovered").recoverPublicKey(S).toBytes()}return Object.freeze({keygen:d,getPublicKey:f,getSharedSecret:a,utils:u,lengths:h,Point:r,sign:Q,verify:M,recoverPublicKey:A,Signature:_,hash:e})}const Fd={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},II={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Oh=BigInt(2);function kI(r){const e=Fd.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),l=BigInt(44),c=BigInt(88),d=r*r*r%e,f=d*d*r%e,a=Ge(f,t,e)*f%e,u=Ge(a,t,e)*f%e,h=Ge(u,Oh,e)*d%e,p=Ge(h,s,e)*h%e,y=Ge(p,i,e)*p%e,g=Ge(y,l,e)*y%e,m=Ge(g,c,e)*g%e,w=Ge(m,l,e)*y%e,v=Ge(w,t,e)*f%e,_=Ge(v,o,e)*p%e,k=Ge(_,n,e)*d%e,P=Ge(k,Oh,e);if(!Tu.eql(Tu.sqr(P),r))throw new Error("Cannot find square root");return P}const Tu=Kl(Fd.p,{sqrt:kI}),CI=EI(Fd,{Fp:Tu,endo:II}),cn=AI(CI,Vo),TI=33,PI=32;function DI(r,e,t){const n=pr.digest(e instanceof Uint8Array?e:e.subarray());if(ql(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),cn.sign(s,r,{prehash:!1,format:"der"}))).catch(s=>{throw s.name==="AbortError"?s:new bh(String(s))});try{return cn.sign(n.digest,r,{prehash:!1,format:"der"})}catch(s){throw new bh(String(s))}}function LI(r,e,t,n){const s=pr.digest(t instanceof Uint8Array?t:t.subarray());if(ql(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),cn.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new vh(String(i))});try{return n?.signal?.throwIfAborted(),cn.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new vh(String(i))}}class Ny{type="secp256k1";raw;_key;constructor(e){this._key=MI(e),this.raw=BI(this._key)}toMultihash(){return it.digest(Sr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return De.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return LI(this._key,t,e,n)}}class My{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=NI(e),this.publicKey=new Ny(t??OI(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return DI(this.raw,e,t)}}function Oy(r){return new My(r)}function Ud(r){return new Ny(r)}async function RI(){const r=$I();return new My(r)}function BI(r){return cn.Point.fromBytes(r).toBytes()}function NI(r){try{return cn.getPublicKey(r,!0),r}catch(e){throw new Nm(String(e))}}function MI(r){try{return cn.Point.fromBytes(r),r}catch(e){throw new Bm(String(e))}}function OI(r){try{return cn.getPublicKey(r,!0)}catch(e){throw new Nm(String(e))}}function $I(){return cn.utils.randomSecretKey()}async function $y(r,e){if(r==="Ed25519")return L2();if(r==="secp256k1")return RI();if(r==="RSA")return fI(KI());if(r==="ECDSA")return kA(qI());throw new Ir}function Hn(r,e){const{Type:t,Data:n}=$n.decode(r),s=n??new Uint8Array;switch(t){case ze.RSA:return uI(s,e);case ze.Ed25519:return kd(s);case ze.secp256k1:return Ud(s);case ze.ECDSA:return Xm(s);default:throw new Ir}}function FI(r){if(r.byteLength===go)return kd(r);if(r.byteLength===TI)return Ud(r);const e=qn(r),t=e[1]?.[0];if(t===Km||t===qm||t===Hm)return Zm(e);if(e[0]?.[0]===pI)return Py(e,r);throw new V("Could not extract public key from raw bytes")}function zn(r){const{Type:e,Data:t}=$n.decode(r.digest),n=t??new Uint8Array;switch(e){case ze.Ed25519:return kd(n);case ze.secp256k1:return Ud(n);case ze.ECDSA:return Xm(n);default:throw new Ir}}function Sr(r){return $n.encode({Type:ze[r.type],Data:r.raw})}function UI(r){const e=Ya.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case ze.RSA:return cI(t);case ze.Ed25519:return Ey(t);case ze.secp256k1:return Oy(t);case ze.ECDSA:return xA(t);default:throw new Ir}}function VI(r){if(r.byteLength===Tr)return Ey(r);if(r.byteLength===PI)return Oy(r);const e=qn(r),t=e[2]?.[0];if(t===Km||t===qm||t===Hm)return Ym(e);if(e.length>8)return Ty(e);throw new V("Could not extract private key from raw bytes")}function Ho(r){return Ya.encode({Type:ze[r.type],Data:r.raw})}function KI(r){return 2048}function qI(r){return"P-256"}const Bi=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),En=new Uint32Array(80);class HI extends _d{A=Bi[0]|0;B=Bi[1]|0;C=Bi[2]|0;D=Bi[3]|0;E=Bi[4]|0;constructor(){super(64,20,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i}=this;return[e,t,n,s,i]}set(e,t,n,s,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)En[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)En[c]=lc(En[c-3]^En[c-8]^En[c-14]^En[c-16],1);let{A:n,B:s,C:i,D:o,E:l}=this;for(let c=0;c<80;c++){let d,f;c<20?(d=ey(s,i,o),f=1518500249):c<40?(d=s^i^o,f=1859775393):c<60?(d=ty(s,i,o),f=2400959708):(d=s^i^o,f=3395469782);const a=lc(n,5)+d+l+f+En[c]|0;l=o,o=i,i=lc(s,30),s=n,n=a}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,l=l+this.E|0,this.set(n,s,i,o,l)}roundClean(){ln(En)}destroy(){this.set(0,0,0,0,0),ln(this.buffer)}}const zI=wd(()=>new HI);function Fy(r,e,t,n){vd(r);const s=RA({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:l}=s;if(Rr(i,"c"),Rr(o,"dkLen"),Rr(l,"asyncTick"),i<1)throw new Error("iterations (c) must be >= 1");const c=Eh(e,"password"),d=Eh(t,"salt"),f=new Uint8Array(o),a=$d.create(r,c),u=a._cloneInto().update(d);return{c:i,dkLen:o,asyncTick:l,DK:f,PRF:a,PRFSalt:u}}function Uy(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),ln(s),t}function WI(r,e,t,n){const{c:s,dkLen:i,DK:o,PRF:l,PRFSalt:c}=Fy(r,e,t,n);let d;const f=new Uint8Array(4),a=Xi(f),u=new Uint8Array(l.outputLen);for(let h=1,p=0;p<i;h++,p+=l.outputLen){const y=o.subarray(p,p+l.outputLen);a.setInt32(0,h,!1),(d=c._cloneInto(d)).update(f).digestInto(u),y.set(u.subarray(0,y.length));for(let g=1;g<s;g++){l._cloneInto(d).update(u).digestInto(u);for(let m=0;m<y.length;m++)y[m]^=u[m]}}return Uy(l,c,o,d,u)}async function Vy(r,e,t,n){const{c:s,dkLen:i,asyncTick:o,DK:l,PRF:c,PRFSalt:d}=Fy(r,e,t,n);let f;const a=new Uint8Array(4),u=Xi(a),h=new Uint8Array(c.outputLen);for(let p=1,y=0;y<i;p++,y+=c.outputLen){const g=l.subarray(y,y+c.outputLen);u.setInt32(0,p,!1),(f=d._cloneInto(f)).update(a).digestInto(h),g.set(h.subarray(0,g.length)),await DA(s-1,o,()=>{c._cloneInto(f).update(h).digestInto(h);for(let m=0;m<g.length;m++)g[m]^=h[m]})}return Uy(c,d,l,f,h)}const $h={sha1:zI,"sha2-256":Vo,"sha2-512":Ul};function Fh(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const l=Object.keys($h).join(" / ");throw new V(`Hash '${s}' is unknown or not supported. Must be ${l}`)}const i=$h[s],o=WI(i,r,e,{c:t,dkLen:n});return Lo.encode(o).substring(1)}const Vd={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Ky={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},qy=new globalThis.TextEncoder;function GI(r,e){const t=Vd[e];let n=Ky[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function YI(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=Vd[e];let s=Ky[e],i=r;for(;i.length>0;){const o=qy.encodeInto(i,t);i=i.slice(o.read);for(let l=0;l<o.written;l++)s^=BigInt(t[l]),s=BigInt.asUintN(e,s*n)}return s}function XI(r,{size:e=32,utf8Buffer:t}={}){if(!Vd[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return YI(r,e,t);r=qy.encode(r)}return GI(r,e)}const Kd={hash:r=>Number(XI(r,{size:32})),hashV:(r,e)=>ZI(Kd.hash(r,e))};function ZI(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),j(e,"base16")}const Hy=64;class ts{fp;h;seed;constructor(e,t,n,s=2){if(s>Hy)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=Ke(s);for(let l=0;l<o.length;l++)o[l]=i[l];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?pe(this.fp,e.fp):!1}}function Xa(r,e){return Math.floor(Math.random()*(e-r))+r}class ia{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof ts))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof ts))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof ts))throw new TypeError("Invalid Fingerprint");const t=Xa(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof ts))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const jI=500;class Uh{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Kd,this.seed=e.seed??Xa(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=j(e));const t=new ts(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new ia(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new ia(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[Xa(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new ia(this.bucketSize));for(let l=0;l<jI;l++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new ia(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=j(e));const t=new ts(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=j(e));const t=new ts(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const QI={1:.5,2:.84,4:.95,8:.98};function JI(r=.001){return r>.002?2:r>1e-5?4:8}function ek(r,e=.001){const t=JI(e),n=QI[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),Hy);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class tk{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Kd,this.seed=e.seed??Xa(0,Math.pow(2,10)),this.filterSeries=[new Uh({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=j(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Uh({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=j(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=j(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function yo(r,e=.001,t){return new tk({...ek(r,e)})}function qe(r){const e=r.getComponents(),t={};let n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new V(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}class rk{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const l=this.peekChar();if(l===void 0)return;const c=l==="0",d=2**(8*s)-1;for(;;){const f=this.readAtomically(()=>{const a=this.readChar();if(a===void 0)return;const u=Number.parseInt(a,e);if(!Number.isNaN(u))return u});if(f===void 0)break;if(i*=e,i+=f,i>d||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[l]=e(i.subarray(0,o));return t.set(i.subarray(0,l),16-l),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const zy=45,nk=15,li=new rk;function Wy(r){if(!(r.length>nk))return li.new(r).parseWith(()=>li.readIPv4Addr())}function Gy(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>zy))return li.new(r).parseWith(()=>li.readIPv6Addr())}function Pu(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>zy)return;const t=li.new(r).parseWith(()=>li.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function sk(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function ik(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function ok(r){switch(r.length){case bo:return r.join(".");case vo:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function ak(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function lk(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const bo=4,vo=16,ck=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Yy(r,e){e.length===vo&&r.length===bo&&sk(e,0,11)&&(e=e.slice(12)),e.length===bo&&r.length===vo&&ik(r,ck,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function uk(r,e){if(typeof e=="string"&&(e=Pu(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function dk(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=bo,s=Wy(e);if(s==null&&(n=vo,s=Gy(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=Xy(i,8*n);return{network:Yy(s,o),mask:o}}function Xy(r,e){if(e!==8*bo&&e!==8*vo)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class Zy{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=dk(e));else{const n=Pu(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=Pu(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=Xy(s,8*n.length);this.network=Yy(n,this.mask)}}contains(e){return uk({network:this.network,mask:this.mask},e)}toString(){const e=ak(this.mask),t=e!==-1?String(e):lk(this.mask);return ok(this.network)+"/"+t}}function fk(r,e){return new Zy(r).contains(e)}function hk(r){try{const e=qe(r);return e.type==="ip6"?fk("2000::/3",e.host):!1}catch{return!1}}function pk(r){try{const e=qe(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function gk(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Du(r){try{const e=qe(r);switch(e.type){case"ip4":case"ip6":return gk(e.host);default:return!1}}catch{return!1}}function Er(r){try{return qe(r),!0}catch{return!1}}function ci(r){return!!Wy(r)}function jy(r){return!!Gy(r)}var Bs={},Vh;function mk(){return Vh||(Vh=1,(function(){var r,e,t,n,s,i,o,l;l=function(c){var d,f,a,u;return d=(c&255<<24)>>>24,f=(c&255<<16)>>>16,a=(c&65280)>>>8,u=c&255,[d,f,a,u].join(".")},o=function(c){var d,f,a,u,h,p;for(d=[],a=u=0;u<=3&&c.length!==0;a=++u){if(a>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),h=p[0],f=p[1],c=c.substring(f),d.push(h)}if(c.length!==0)throw new Error("Invalid IP");switch(d.length){case 1:if(d[0]>4294967295)throw new Error("Invalid IP");return d[0]>>>0;case 2:if(d[0]>255||d[1]>16777215)throw new Error("Invalid IP");return(d[0]<<24|d[1])>>>0;case 3:if(d[0]>255||d[1]>255||d[2]>65535)throw new Error("Invalid IP");return(d[0]<<24|d[1]<<16|d[2])>>>0;case 4:if(d[0]>255||d[1]>255||d[2]>255||d[3]>255)throw new Error("Invalid IP");return(d[0]<<24|d[1]<<16|d[2]<<8|d[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var d,f,a,u,h;for(u=0,d=10,f="9",a=0,c.length>1&&c[a]==="0"&&(c[a+1]==="x"||c[a+1]==="X"?(a+=2,d=16):"0"<=c[a+1]&&c[a+1]<="9"&&(a++,d=8,f="7")),h=a;a<c.length;){if("0"<=c[a]&&c[a]<=f)u=u*d+(t(c[a])-n)>>>0;else if(d===16)if("a"<=c[a]&&c[a]<="f")u=u*d+(10+t(c[a])-i)>>>0;else if("A"<=c[a]&&c[a]<="F")u=u*d+(10+t(c[a])-s)>>>0;else break;else break;if(u>4294967295)throw new Error("too large");a++}if(a===h)throw new Error("empty octet");return[u,a]},r=(function(){function c(d,f){var a,u,h;if(typeof d!="string")throw new Error("Missing `net' parameter");if(f||(h=d.split("/",2),d=h[0],f=h[1]),f||(f=32),typeof f=="string"&&f.indexOf(".")>-1){try{this.maskLong=o(f)}catch{throw new Error("Invalid mask: "+f)}for(a=u=32;u>=0;a=--u)if(this.maskLong===4294967295<<32-a>>>0){this.bitmask=a;break}}else if(f||f===0)this.bitmask=parseInt(f,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(d)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+d)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+f);this.size=Math.pow(2,32-this.bitmask),this.base=l(this.netLong),this.mask=l(this.maskLong),this.hostmask=l(~this.maskLong),this.first=this.bitmask<=30?l(this.netLong+1):this.base,this.last=this.bitmask<=30?l(this.netLong+this.size-2):l(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?l(this.netLong+this.size-1):void 0}return c.prototype.contains=function(d){return typeof d=="string"&&(d.indexOf("/")>0||d.split(".").length!==4)&&(d=new c(d)),d instanceof c?this.contains(d.base)&&this.contains(d.broadcast||d.last):(o(d)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(d){return d==null&&(d=1),new c(l(this.netLong+this.size*d),this.mask)},c.prototype.forEach=function(d){var f,a,u;for(u=o(this.first),a=o(this.last),f=0;u<=a;)d(l(u),u,f),f++,u++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),Bs.ip2long=o,Bs.long2ip=l,Bs.Netmask=r}).call(Bs)),Bs}var yk=mk();const bk=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],vk=bk.map(r=>new yk.Netmask(r));function qd(r){for(const e of vk)if(e.contains(r))return!0;return!1}function wk(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function _k(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return qd(s)}function Sk(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function Ek(r){const e=r.split(":"),t=e[e.length-1];return qd(t)}function xk(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Hd(r){if(ci(r))return qd(r);if(wk(r))return _k(r);if(Sk(r))return Ek(r);if(jy(r))return xk(r)}function ui(r){try{const e=qe(r);switch(e.type){case"ip4":case"ip6":return Hd(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}let Ak=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Ik=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const Kh=r=>globalThis.DOMException===void 0?new Ik(r):new DOMException(r),qh=r=>{const e=r.reason===void 0?Kh("This operation was aborted."):r.reason;return e instanceof Error?e:Kh(e)};function kk(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,l;const d=new Promise((f,a)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:h}=e;h.aborted&&a(qh(h)),l=()=>{a(qh(h))},h.addEventListener("abort",l,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,a);return}const u=new Ak;o=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){a(h)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?f():s instanceof Error?a(s):(u.message=s??`Promise timed out after ${t} milliseconds`,a(u))},t),(async()=>{try{f(await r)}catch(h){a(h)}})()}).finally(()=>{d.clear(),l&&e.signal&&e.signal.removeEventListener("abort",l)});return d.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},d}const Ck=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Tk(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const l=[e].flat(),c=[],{addListener:d,removeListener:f}=Ck(r),a=async(...h)=>{const p=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(p))return}catch(y){n(),o(y);return}c.push(p),t.count===c.length&&(n(),i(c))},u=(...h)=>{n(),o(t.rejectionMultiArgs?h:h[0])};n=()=>{for(const h of l)f(h,a);for(const h of t.rejectionEvents)l.includes(h)||f(h,u)};for(const h of l)d(h,a);for(const h of t.rejectionEvents)l.includes(h)||d(h,u);t.signal&&t.signal.addEventListener("abort",()=>{u(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=kk(s,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return s}function fr(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=Tk(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}function Za(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Pk extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let Dk=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};class ja extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"}class Lk extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"}class Rk extends Error{static name="StreamClosedError";name="StreamClosedError"}let Bk=class{deferred;signal;constructor(e){this.signal=e,this.deferred=lr(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new uo)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Nk(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let Mk=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Nk(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new uo),this.cleanup())}async join(e={}){const t=new Bk(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Tt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},Qy=class extends Dt{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Za(this.emitEmpty.bind(this),1),this.emitIdle=Za(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Dk;const n=new Mk(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new uo)}),this.clear()}async onEmpty(e){this.size!==0&&await fr(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await fr(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await fr(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ud({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail.error)},o=()=>{n()},l=()=>{n(new uo("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",l),n()}}};const Ok=Math.pow(2,20)*4;class Jy extends Dt{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??Ok,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new Ne,this.writeBuffer=new Ne,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);const t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);const n=s=>{this.onDrainPromise?.reject(s.error??new Rk)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),Tt(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;const e=ud(),t=i=>{e.push(i.data)};this.addEventListener("message",t);const n=i=>{e.end(i.error)};this.addEventListener("close",n);const s=()=>{e.end()};this.addEventListener("remoteCloseWrite",s);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",s)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new Di(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new oA(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");const e=new tA;this.dispatchEvent(new aA(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Ml))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let n=0;for(;this.writeBuffer.byteLength>0;){const s=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(s===0){e=!1;break}const i=this.writeBuffer.sublist(0,s),o=new Ne(i);this.writeBuffer.consume(i.byteLength);const l=this.sendData(i);if(e=l.canSendMore,n+=l.sentBytes,l.sentBytes!==o.byteLength&&(o.consume(l.sentBytes),this.writeBuffer.prepend(o)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new iA(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new gh(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new gh(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}}class eb extends Jy{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}}function $k(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class Fk extends Dt{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;const n=o=>{try{this.onData(o.data)}catch(l){this.abort(l),this.maConn.abort(l)}};this.maConn.addEventListener("message",n);const s=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(o=>{o.onMuxerDrain()})};this.maConn.addEventListener("drain",s);const i=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",i)}send(e){const t=this.maConn.send(e);return t===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),t}async close(e){this.status==="closed"||this.status==="closing"||(this.status="closing",await Tt(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(t){this.abort(t)}this.status="closed"}async createStream(e){if(this.status!=="open")throw new Ki;let t=this.onCreateStream({...this.streamOptions,...e});return $k(t)&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),this.listenerCount("stream")===0){this.earlyStreams.push(e),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new Lk(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){const t=n=>{const s=this.streams.findIndex(i=>i===e);s!==-1&&this.streams.splice(s,1),n.error!=null?n.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})};e.addEventListener("close",t),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(t=>{this.safeDispatchEvent("stream",{detail:t})}),this.earlyStreams=[]})}}class Uk extends Jy{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await fr(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(e){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}}function vs(r){const e=new globalThis.AbortController;function t(){const i=r.filter(o=>o?.aborted===!0).map(o=>o?.reason).pop();e.abort(i);for(const o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}class mc{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const Vk=1.2,Kk=2,qk=5e3,Hk=6e4,zk=5e3;class Wk{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??zk;this.success=new mc(t),this.failure=new mc(t),this.next=new mc(t),this.failureMultiplier=e.failureMultiplier??Kk,this.timeoutMultiplier=e.timeoutMultiplier??Vk,this.minTimeout=e.minTimeout??qk,this.maxTimeout=e.maxTimeout??Hk,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=vs([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class cr extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class wo extends Error{static name="ValidationError";name="ValidationError"}class Gk extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class Yk extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}const Qa=4,ds=6,tb=273,Xk=33,ws=41,zd=42,Wd=43,Gd=53,Yd=54,Xd=55,Zd=56,Zk=132,jk=301,Qk=302,rb=400,ce=421,Jk=444,eC=445,tC=446,rC=447,fs=448,Ja=449,nC=454,nb=460,sb=461,ib=465,_o=466,Xs=480,sC=481,Lu=443,jd=477,ob=478,iC=479,oC=277,aC=275,lC=276,ab=280,Qi=281,zo=290,lb=777;function Hh(r){return e=>W(e,r)}function zh(r){return e=>j(e,r)}function Hi(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Fs(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function cC(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=j(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Fs(n);return an([t,s],t.length+s.length)}function uC(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Rn.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Fs(n);return an([t,s],t.length+s.length)}function Wh(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=W(e,"base32"),s=Hi(t);return`${n}:${s}`}const cb=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new cr("Invalid byte value in IP address");e[n]=s}),e},dC=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=ci(t[n]);let o;i&&(o=cb(t[n]),t[n]=W(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,W(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new cr("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},fC=function(r){if(r.byteLength!==4)throw new cr("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},hC=function(r){if(r.byteLength!==16)throw new cr("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new cr(`Invalid IPv6 address "${t}"`)}};function pC(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new cr(`Invalid IPv6 address "${r}"`)}}const yc=Object.values(ru).map(r=>r.decoder),gC=(function(){let r=yc[0].or(yc[1]);return yc.slice(2).forEach(e=>r=r.or(e)),r})();function mC(r){return gC.decode(r)}function yC(r){return e=>r.encoder.encode(e)}function bC(r){if(parseInt(r).toString()!==r)throw new wo("Value must be an integer")}function vC(r){if(r<0)throw new wo("Value must be a positive integer, or zero")}function wC(r){return e=>{if(e>r)throw new wo(`Value must be smaller than or equal to ${r}`)}}function _C(...r){return e=>{for(const t of r)t(e)}}const oa=_C(bC,vC,wC(65535)),xt=-1;class SC{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new Yk(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}}const Ai=new SC,EC=[{code:Qa,name:"ip4",size:32,valueToBytes:cb,bytesToValue:fC,validate:r=>{if(!ci(r))throw new wo(`Invalid IPv4 address "${r}"`)}},{code:ds,name:"tcp",size:16,valueToBytes:Fs,bytesToValue:Hi,validate:oa},{code:tb,name:"udp",size:16,valueToBytes:Fs,bytesToValue:Hi,validate:oa},{code:Xk,name:"dccp",size:16,valueToBytes:Fs,bytesToValue:Hi,validate:oa},{code:ws,name:"ip6",size:128,valueToBytes:dC,bytesToValue:hC,stringToValue:pC,validate:r=>{if(!jy(r))throw new wo(`Invalid IPv6 address "${r}"`)}},{code:zd,name:"ip6zone",size:xt},{code:Wd,name:"ipcidr",size:8,bytesToValue:Hh("base10"),valueToBytes:zh("base10")},{code:Gd,name:"dns",size:xt},{code:Yd,name:"dns4",size:xt},{code:Xd,name:"dns6",size:xt},{code:Zd,name:"dnsaddr",size:xt},{code:Zk,name:"sctp",size:16,valueToBytes:Fs,bytesToValue:Hi,validate:oa},{code:jk,name:"udt"},{code:Qk,name:"utp"},{code:rb,name:"unix",size:xt,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:ce,name:"p2p",aliases:["ipfs"],size:xt,bytesToValue:Hh("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?zh("base58btc")(r):ue.parse(r).multihash.bytes},{code:Jk,name:"onion",size:96,bytesToValue:Wh,valueToBytes:cC},{code:eC,name:"onion3",size:296,bytesToValue:Wh,valueToBytes:uC},{code:tC,name:"garlic64",size:xt},{code:rC,name:"garlic32",size:xt},{code:fs,name:"tls"},{code:Ja,name:"sni",size:xt},{code:nC,name:"noise"},{code:nb,name:"quic"},{code:sb,name:"quic-v1"},{code:ib,name:"webtransport"},{code:_o,name:"certhash",size:xt,bytesToValue:yC(jg),valueToBytes:mC},{code:Xs,name:"http"},{code:sC,name:"http-path",size:xt,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:Lu,name:"https"},{code:jd,name:"ws"},{code:ob,name:"wss"},{code:iC,name:"p2p-websocket-star"},{code:oC,name:"p2p-stardust"},{code:aC,name:"p2p-webrtc-star"},{code:lC,name:"p2p-webrtc-direct"},{code:ab,name:"webrtc-direct"},{code:Qi,name:"webrtc"},{code:zo,name:"p2p-circuit"},{code:lb,name:"memory",size:xt}];EC.forEach(r=>{Ai.addProtocol(r)});function xC(r){const e=[];let t=0;for(;t<r.length;){const n=Ld(r,t),s=Ai.getProtocol(n),i=Ar(n),o=CC(s,r,t+i);let l=0;o>0&&s.size===xt&&(l=Ar(o));const c=i+l+o,d={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const f=t+i+l,a=r.subarray(f,f+o);d.value=s.bytesToValue?.(a)??W(a)}e.push(d),t+=c}return e}function AC(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=Ai.getProtocol(n.code),i=Ar(n.code);let o,l=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??j(n.value),l=o.byteLength,s.size===xt&&(c=Ar(l)));const d=new Uint8Array(i+c+l);let f=0;Wa(n.code,d,f),f+=i,o!=null&&(s.size===xt&&(Wa(l,d,f),f+=c),d.set(o,f)),n.bytes=d}t.push(n.bytes),e+=n.bytes.byteLength}return an(t,e)}function IC(r){if(r.charAt(0)!=="/")throw new cr('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const l=i===r.length-1;if(o==="/"||l){const c=Ai.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(l)throw new cr(`Component ${s} was missing value`);t="value"}else if(t==="value"){const d={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new cr(`Component ${s} was missing value`);d.value=c.stringToValue?.(n)??n}e.push(d),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new cr("Incomplete multiaddr");return e}function kC(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=Ai.getProtocol(e.code);if(t==null)throw new cr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function CC(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Ld(e,t)}const TC=Symbol.for("nodejs.util.inspect.custom"),ub=Symbol.for("@multiformats/multiaddr");function PC(r){if(r==null&&(r="/"),Hl(r))return r.getComponents();if(r instanceof Uint8Array)return xC(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),IC(r);if(Array.isArray(r))return r;throw new cr("Must be a string, Uint8Array, Component[], or another Multiaddr")}class Us{[ub]=!0;#e;#r;#t;constructor(e="/",t={}){this.#e=PC(e),t.validate!==!1&&DC(this)}get bytes(){return this.#t==null&&(this.#t=AC(this.#e)),this.#t}toString(){return this.#r==null&&(this.#r=kC(this.#e)),this.#r}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){const t=new Us(e);return new Us([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Gk(`Address ${this.toString()} does not contain subaddress: ${t}`);return new Us(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new Us(this.#e.slice(0,t),{validate:!1})}equals(e){return pe(this.bytes,e.bytes)}[TC](){return`Multiaddr(${this.toString()})`}}function DC(r){r.getComponents().forEach(e=>{const t=Ai.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function Hl(r){return!!r?.[ub]}function he(r){return new Us(r)}const LC=4194304;class Gh extends Error{static name="UnwrappedError";name="UnwrappedError"}class RC extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}let BC=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"};class NC extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function MC(r){return typeof r?.closeRead=="function"}function OC(r){return typeof r?.close=="function"}function bc(r){return MC(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:OC(r)?r.status!=="open":!1}function $C(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function db(r,e){const t=e?.maxBufferSize??LC,n=new Ne;let s,i=!1;if(!$C(r))throw new V("Argument should be a Stream or a Multiaddr");const o=f=>{if(n.append(f.data),n.byteLength>t){const a=n.byteLength;n.consume(n.byteLength),s?.reject(new Error(`Read buffer overflow - ${a} > ${t}`))}s?.resolve()};r.addEventListener("message",o);const l=f=>{f.error!=null?s?.reject(f.error):s?.resolve()};r.addEventListener("close",l);const c=()=>{s?.resolve()};r.addEventListener("remoteCloseWrite",c);const d={readBuffer:n,async read(f){if(i===!0)throw new Gh("Stream was unwrapped");if(bc(r)){if(f?.bytes==null)return null;if(n.byteLength<f.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,f.bytes),new ja(`Unexpected EOF - stream closed after reading ${n.byteLength}/${f.bytes} bytes`)}const a=f?.bytes??1;for(s=Promise.withResolvers();;){if(n.byteLength>=a){s.resolve();break}if(await Tt(s.promise,f?.signal),bc(r)){if(n.byteLength===0&&f?.bytes==null)return null;break}s=Promise.withResolvers()}const u=f?.bytes??n.byteLength;if(n.byteLength<u){if(bc(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,u),new ja(`Unexpected EOF - stream closed while reading ${n.byteLength}/${u} bytes`);return d.read(f)}const h=n.sublist(0,u);return n.consume(u),h},async write(f,a){if(i===!0)throw new Gh("Stream was unwrapped");r.send(f)||await fr(r,"drain",{signal:a?.signal,rejectionEvents:["close"]})},unwrap(){return i||(i=!0,r.removeEventListener("message",o),r.removeEventListener("close",l),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return d}function Qd(r,e={}){const t=db(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ar(e.maxDataLength));const n=e?.lengthDecoder??Ld,s=e?.lengthEncoder??ji;return{async read(o){let l=-1;const c=new Ne;for(;;){const f=await t.read({...o,bytes:1});if(f==null)break;c.append(f);try{l=n(c)}catch(a){if(a instanceof RangeError)continue;throw a}if(l<0)throw new RC("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new NC(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(l>-1)break}if(e?.maxDataLength!=null&&l>e.maxDataLength)throw new BC(`Message length too long - ${l} > ${e.maxDataLength}`);const d=await t.read({...o,bytes:l});if(d==null)throw r.log.error("tried to read %d bytes but the stream closed",l),new ja(`Unexpected EOF - tried to read ${l} bytes but the stream closed`);if(d.byteLength!==l)throw r.log.error("read %d/%d bytes before the stream closed",d.byteLength,l),new ja(`Unexpected EOF - read ${d.byteLength}/${l} bytes before the stream closed`);return d},async write(o,l){await t.write(new Ne(s(o.byteLength),o),l)},async writeV(o,l){const c=new Ne(...o.flatMap(d=>[s(d.byteLength),d]));await t.write(c,l)},unwrap(){return t.unwrap()}}}function Fn(r,e){const t=Qd(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(l=>i.encode(l)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class Jd extends Qy{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}let FC=class extends Qy{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};class UC{memoryStorage;points;duration;blockDuration;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new VC}consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new Pk("Rate limit exceeded",o);return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class VC{storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function fb(r,e,t){let n,s,i=!1;function o(){const d={signal:s.signal};if(t?.timeout!=null){const f=vs([s.signal,AbortSignal.timeout(t.timeout)]);d.signal=f}i=!0,Promise.resolve().then(async()=>{await r(d)}).catch(()=>{}).finally(()=>{i=!1,!s.signal.aborted&&(n=setTimeout(o,e))})}const l=Za(o,t?.debounce??100);let c=!1;return{setInterval:d=>{e!==d&&(e=d,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:d=>{t??={},t.timeout=d},run:()=>{i||(clearTimeout(n),l())},start:()=>{c||(c=!0,s=new AbortController,s.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),s?.abort(),c=!1}}}class KC extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function un(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new KC({name:e,metrics:t}):n=new Map,n}var Qe;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Qe||(Qe={}));var Se;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Se||(Se={}));Object.values(Se).filter(r=>typeof r!="string");const qC=0;var Zt;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Zt||(Zt={}));const rs=12;class zl extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}}function HC(r){return r?.reason!==null}class Vs extends zl{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,Zt.ProtocolError),this.name="InvalidFrameError"}}class zC extends zl{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,Zt.ProtocolError),this.name="UnRequestedPingError"}}class WC extends zl{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,Zt.ProtocolError),this.name="NotMatchingPingError"}}class GC extends zl{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,Zt.ProtocolError),this.name="ReceiveWindowExceededError"}}const hb=256*1024,YC=16*1024*1024,aa={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3};function XC(r){if(r.keepAliveInterval!=null&&r.keepAliveInterval<=0)throw new V("keep-alive interval must be positive");if(r.maxInboundStreams!=null&&r.maxInboundStreams<0)throw new V("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams!=null&&r.maxOutboundStreams<0)throw new V("max outbound streams must be larger or equal 0");if(r.maxMessageSize!=null&&r.maxMessageSize<1024)throw new V("MaxMessageSize must be greater than a kilobyte");if(r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize<hb)throw new V("InitialStreamWindowSize must be larger or equal 256 kB");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize<r.streamOptions?.initialStreamWindowSize)throw new V("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize>2**32-1)throw new V("MaxStreamWindowSize must be less than equal MAX_UINT32")}function ZC(r){return r.header.type===Qe.Data&&r.data!==null}const Yh=2**24;function jC(r){if(r[0]!==qC)throw new Vs("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*Yh+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*Yh+(r[9]<<16)+(r[10]<<8)+r[11]}}class QC{buffer;constructor(){this.buffer=new Ne}*emitFrames(e){for(this.buffer.append(e);;){const t=this.readFrame();if(t===void 0)break;yield t}}readFrame(){let e=rs;if(this.buffer.byteLength<rs)return;const t=jC(this.buffer.subarray(0,rs));if(t.type===Qe.Data){if(e+=t.length,this.buffer.byteLength<e)return;const n=this.buffer.sublist(rs,e);return this.buffer.consume(e),{header:t,data:n}}return this.buffer.consume(e),{header:t}}}function Xh(r){const e=new Uint8Array(rs);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var Vt;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished",r[r.Paused=5]="Paused"})(Vt||(Vt={}));class JC extends Uk{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){const t=e.initialStreamWindowSize??hb;super({...e,maxMessageSize:t-rs}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??YC,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;const n=()=>{this.state=Vt.Finished};this.addEventListener("close",n)}sendData(e){const t=e.byteLength;let n=0,s=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(this.sendWindowCapacity===0){s=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",n,t);break}const i=Math.min(this.sendWindowCapacity,e.byteLength),o=this.getSendFlags(),l=e.sublist(0,i);e.consume(i);const c=this.sendFrame({type:Qe.Data,flag:o,streamID:this.streamId,length:i},l);if(this.sendWindowCapacity-=i,n+=i,!c){s=c,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",n,t);break}}return{sentBytes:n,canSendMore:s}}sendReset(){this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Se.FIN;this.sendFrame({type:Qe.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=Vt.Paused}sendResume(){this.state=Vt.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-rs,this.maxMessageSize<0&&(this.maxMessageSize=0),this.maxMessageSize!==0&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!ZC(e))throw new Vs("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new GC("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&Se.ACK)===Se.ACK&&this.state===Vt.SYNSent&&(this.state=Vt.Established),(e&Se.FIN)===Se.FIN&&this.onRemoteCloseWrite(),(e&Se.RST)===Se.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case Vt.Init:return this.state=Vt.SYNSent,Se.SYN;case Vt.SYNReceived:return this.state=Vt.Established,Se.ACK;default:return 0}}sendWindowUpdate(){if(this.state===Vt.Paused){this.epochStart=Date.now();return}const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<=n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Qe.WindowUpdate,flag:e,streamID:this.streamId,length:s})}}function Zh(r){return{type:Qe[r.type],flags:[(r.flag&Se.SYN)===Se.SYN?"SYN":void 0,(r.flag&Se.ACK)===Se.ACK?"ACK":void 0,(r.flag&Se.FIN)===Se.FIN?"FIN":void 0,(r.flag&Se.RST)===Se.RST?"RST":void 0].filter(Boolean),streamID:r.streamID,length:r.length}}const pb="/yamux/1.0.0";class eT{protocol=pb;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[xr]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new tT(e,{...this._init})}}class tT extends Fk{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:pb,name:"yamux"}),this.client=e.direction==="outbound",XC(t),this.enableKeepAlive=t.enableKeepAlive??aa.enableKeepAlive,this.keepAliveInterval=t.keepAliveInterval??aa.keepAliveInterval,this.maxInboundStreams=t.maxInboundStreams??aa.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??aa.maxOutboundStreams,this.decoder=new QC,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=fb(async n=>{try{await this.ping(n)}catch(s){this.log.error("ping error: %s",s)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(const t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(this.remoteGoAway!==void 0)throw new Ki("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Ki("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new Om("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);const t=this._newStream(e,Vt.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(this.remoteGoAway!==void 0)throw new Ki("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Ki("Muxer closed locally");if(this.activePing!=null)return Tt(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await Tt(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.status==="open")try{const t=e?.reason??Zt.NormalTermination;this.log.trace("muxer close reason=%s",Zt[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if(this.status==="open")try{super.abort(e);let t=Zt.InternalError;HC(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,n){if(this.streams.find(i=>i.streamId===e)!=null)throw new V("Stream already exists with that id");const s=new JC({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:n,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${n}:${e}`),getRTT:this.getRTT.bind(this)});return s.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){const{streamID:t,type:n,length:s}=e.header;if(this.log.trace("received frame %o",Zh(e.header)),t===0)switch(n){case Qe.Ping:{this.handlePing(e.header);return}case Qe.GoAway:{this.handleGoAway(s);return}default:throw new Vs("Invalid frame type")}else switch(e.header.type){case Qe.Data:case Qe.WindowUpdate:{this.handleStreamMessage(e);return}default:throw new Vs("Invalid frame type")}}handlePing(e){if(e.flag===Se.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Se.ACK);else if(e.flag===Se.ACK)this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Vs("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new zC("ping not requested");if(this.activePing.id!==e)throw new WC("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",Zt[e]??"unknown"),this.remoteGoAway=e,e===Zt.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){const{streamID:t,flag:n,type:s}=e.header;(n&Se.SYN)===Se.SYN&&this.incomingStream(t);const i=this.streams.find(o=>o.streamId===t);if(i===void 0){this.log.trace("frame for missing stream id=%s",t);return}switch(s){case Qe.WindowUpdate:{i.handleWindowUpdate(e);return}case Qe.Data:{i.handleData(e);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new V("Both endpoints are clients");if(this.streams.find(n=>n.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.maxInboundStreams){this.log("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}const t=this._newStream(e,Vt.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let n;if(e.type===Qe.Data){if(t==null)throw new Vs("Invalid frame");n=new Ne(Xh(e),t)}else n=Xh(e);return this.log.trace("sending frame %o",Zh(e)),this.send(n)}sendPing(e,t=Se.SYN){t===Se.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:Qe.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Zt.NormalTermination){this.log("sending GoAway reason=%s",Zt[e]),this.localGoAway=e,this.sendFrame({type:Qe.GoAway,flag:0,streamID:0,length:e})}}function rT(r={}){return()=>new eT(r)}const gb=Symbol.for("nodejs.util.inspect.custom"),nT=114;let ef=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(nT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[gb](){return`PeerId(${this.toString()})`}},sT=class extends ef{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},iT=class extends ef{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},oT=class extends ef{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const aT=2336;let mb=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[gb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(aT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const lT=114,jh=2336;function cT(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=hn(De.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return uT(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return yb(t)}function yb(r){if(fT(r))return new sT({multihash:r});if(dT(r))try{const e=zn(r);if(e.type==="Ed25519")return new iT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new oT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new mb(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function uT(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==lT&&r.code!==jh)throw new $o("Supplied PeerID CID is invalid");if(r.code===jh){const e=W(r.multihash.digest);return new mb(new URL(e))}return yb(r.multihash)}function dT(r){return r.code===it.code}function fT(r){return r.code===pr.code}const Fe=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),ae=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),hT=r=>({match:e=>r.match(e)===!1?e:!1}),ye=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),$t=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),Ae=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function Ve(...r){function e(s){if(s==null)return!1;let i=s.getComponents();for(const o of r){const l=o.match(i);if(l===!1)return!1;i=l}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const pT=ae(ce),gT=Ve(pT),Wl=ae(Yd),Gl=ae(Xd),Yl=ae(Zd),tf=ae(Gd);Ve(Wl,ye(ae(ce)));Ve(Gl,ye(ae(ce)));Ve(Yl,ye(ae(ce)));Ve($t(tf,Yl,Wl,Gl),ye(ae(ce)));const bb=Ae(ae(Qa),ye(ae(Wd))),vb=Ae(ye(ae(zd)),ae(ws),ye(ae(Wd))),rf=$t(bb,vb),_s=$t(rf,tf,Wl,Gl,Yl),mT=Ve($t(rf,Ae($t(tf,Yl,Wl,Gl),ye(ae(ce))))),Qh=Ve(bb),Jh=Ve(vb);Ve(rf);const nf=Ae(_s,ae(ds)),Wo=Ae(_s,ae(tb)),el=Ve(Ae(nf,ye(ae(ce))));Ve(Wo);const sf=Ae(Wo,Fe(nb),ye(ae(ce))),Xl=Ae(Wo,Fe(sb),ye(ae(ce))),yT=$t(sf,Xl);Ve(sf);const bT=Ve(Xl),Ru=$t(_s,nf,Wo,sf,Xl),wb=$t(Ae(Ru,Fe(jd),ye(ae(ce)))),So=Ve(wb),_b=$t(Ae(Ru,Fe(ob),ye(ae(ce))),Ae(Ru,Fe(fs),ye(ae(Ja)),Fe(jd),ye(ae(ce)))),tl=Ve(_b),Sb=Ae(Wo,Fe(ab),ye(ae(_o)),ye(ae(_o)),ye(ae(ce))),ep=Ve(Sb),Eb=Ae(Xl,Fe(ib),ye(ae(_o)),ye(ae(_o)),ye(ae(ce))),tp=Ve(Eb),rl=$t(wb,_b,Ae(nf,ye(ae(ce))),Ae(yT,ye(ae(ce))),Ae(_s,ye(ae(ce))),Sb,Eb,ae(ce)),xb=Ve(rl),vT=Ae(ye(rl),Fe(zo),hT(Fe(Qi)),ye(ae(ce))),di=Ve(vT),wT=$t(Ae(rl,Fe(zo),Fe(Qi),ye(ae(ce))),Ae(rl,Fe(Qi),ye(ae(ce))),Ae(Fe(Qi),ye(ae(ce)))),rp=Ve(wT),_T=$t(Ae(_s,ae(ds),Fe(Xs),ye(ae(ce))),Ae(_s,Fe(Xs),ye(ae(ce))));Ve(_T);const ST=Ae(_s,$t(Ae(ae(ds,"443"),Fe(Xs)),Ae(ae(ds),Fe(Lu)),Ae(ae(ds),Fe(fs),Fe(Xs)),Ae(Fe(fs),Fe(Xs)),Fe(fs),Fe(Lu)),ye(ae(ce)));Ve(ST);const ET=$t(Ae(ae(lb),ye(ae(ce))));Ve(ET);const xT=$t(Ae(ae(rb),ye(ae(ce))));Ve(xT);const AT="bootstrap",IT=50,kT=1e3;class CT extends Dt{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??kT,this.list=t.list.map(n=>he(n)).filter(n=>xb.matches(n)?n.getComponents().findLast(i=>i.code===ce)?.value==null?(this.log.error("invalid bootstrap multiaddr without peer id"),!1):!0:(this.log.error("invalid multiaddr %a",n),!1)).map(n=>({id:cT(n.getComponents().findLast(s=>s.code===ce)?.value??""),multiaddrs:[n]})),this._init=t}[Fa]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[xr]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??AT]:{value:this._init.tagValue??IT,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function TT(r){return e=>new CT(e,r)}const Ab=Symbol.for("nodejs.util.inspect.custom"),PT=114;let of=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(PT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Ab](){return`PeerId(${this.toString()})`}},DT=class extends of{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},LT=class extends of{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},RT=class extends of{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const BT=2336;let Ib=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Ab](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(BT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const NT=114,np=2336;function sp(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=hn(De.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return MT(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return af(t)}function af(r){if($T(r))return new DT({multihash:r});if(OT(r))try{const e=zn(r);if(e.type==="Ed25519")return new LT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new RT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new Ib(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function MT(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==NT&&r.code!==np)throw new $o("Supplied PeerID CID is invalid");if(r.code===np){const e=W(r.multihash.digest);return new Ib(new URL(e))}return af(r.multihash)}function OT(r){return r.code===it.code}function $T(r){return r.code===pr.code}var nl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),payload:Ke(0),signature:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(nl||(nl={}));class FT extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class nn{static createFromProtobuf=e=>{const t=nl.decode(e),n=Hn(t.publicKey);return new nn({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),l=ip(s,i,o),c=await t.sign(l.subarray(),n);return new nn({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=nn.createFromProtobuf(e);if(!await s.validate(t,n))throw new FT("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=nl.encode({publicKey:Sr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:pe(this.marshal(),e.marshal())}async validate(e,t){const n=ip(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const ip=(r,e,t)=>{const n=j(r),s=ji(n.byteLength),i=ji(e.length),o=ji(t.length);return new Ne(s,n,i,e,o,t)},kb=Symbol.for("nodejs.util.inspect.custom"),UT=114;let lf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(UT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[kb](){return`PeerId(${this.toString()})`}},VT=class extends lf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},KT=class extends lf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},qT=class extends lf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const HT=2336;let zT=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[kb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(HT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function WT(r){if(YT(r))return new VT({multihash:r});if(GT(r))try{const e=zn(r);if(e.type==="Ed25519")return new KT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new qT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new zT(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function GT(r){return r.code===it.code}function YT(r){return r.code===pr.code}const XT="libp2p-peer-record",ZT=Uint8Array.from([3,1]);var sl;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={multiaddr:Ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();d>>>3===1?l.multiaddr=s.bytes():s.skipType(d&7)}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:Ke(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new vt('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(sl||(sl={}));function jT(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}class ur{static createFromProtobuf=e=>{const t=sl.decode(e),n=WT(hn(t.peerId)),s=(t.addresses??[]).map(o=>he(o.multiaddr)),i=t.seq;return new ur({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=XT;static CODEC=ZT;peerId;multiaddrs;seqNumber;domain=ur.DOMAIN;codec=ur.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=sl.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof ur)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!jT(this.multiaddrs,e.multiaddrs))}}const QT=1,Cb=5e3,JT=100,la=`${md}-circuit-relay`;BigInt(1<<17);const il="/libp2p/circuit/relay/0.2.0/hop",op="/libp2p/circuit/relay/0.2.0/stop",ap=300,eP=4096,tP=.001;var fi;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),(function(n){n.codec=()=>qo(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),hi.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),ol.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),pi.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),Bt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},l=s==null?n.len:n.pos+s;for(;n.pos<l;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=hi.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=ol.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=pi.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Bt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,s)=>Ie(n,r.codec(),s)})(fi||(fi={}));var Wr;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),(function(n){n.codec=()=>qo(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),hi.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),pi.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),Bt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},l=s==null?n.len:n.pos+s;for(;n.pos<l;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=hi.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=pi.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Bt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,s)=>Ie(n,r.codec(),s)})(Wr||(Wr={}));var hi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:Ke(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new vt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(hi||(hi={}));var ol;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),ll.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new vt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=ll.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ol||(ol={}));var pi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(pi||(pi={}));var Bt;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Bt||(Bt={}));var Bu;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Bu||(Bu={}));(function(r){r.codec=()=>qo(Bu)})(Bt||(Bt={}));var al;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:Ke(0),peer:Ke(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(al||(al={}));var ll;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),al.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),signature:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=al.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ll||(ll={}));class lp extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class rP extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class nP extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function cp(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class up{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const Tb=Ve(Ae(xb.matchers[0],Fe(zo))),Pb=Ve(Fe(zo)),Db=Symbol.for("nodejs.util.inspect.custom"),sP=114;let cf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(sP,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Db](){return`PeerId(${this.toString()})`}},iP=class extends cf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},oP=class extends cf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},aP=class extends cf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const lP=2336;let cP=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Db](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(lP,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function uP(r){if(fP(r))return new iP({multihash:r});if(dP(r))try{const e=zn(r);if(e.type==="Ed25519")return new oP({multihash:r,publicKey:e});if(e.type==="secp256k1")return new aP({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new cP(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function dP(r){return r.code===it.code}function fP(r){return r.code===pr.code}function Ji(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function vc(r){const e=hn(De.decode(`z${r}`));return uP(e)}class Is{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Ji(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Ji(this.map.values(),e=>e.key)}values(){return Ji(this.map.values(),e=>e.value)}get size(){return this.map.size}}class hs{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Ji(this.set.entries(),e=>{const t=vc(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=vc(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Ji(this.set.values(),e=>vc(e))}intersection(e){const t=new hs;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new hs;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new hs;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}class hP{filter;constructor(e,t){this.filter=yo(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function pP(r,e=.001){return new hP(r,e)}class gP extends Is{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function mP(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new gP({name:e,metrics:t}):n=new Is,n}class nt extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class yP extends Dt{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(il,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(il)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=dp(n),o=dp(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new Jd({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p - %e",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=vs([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function dp(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(W(e)).getTime()}class bP extends Dt{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Cb,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(Pb.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Tb.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new vu(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>he(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function vP(r){return new bP(r)}const wP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let _P=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=wP[t[r]&63];return e};const SP=60*1e3*10,EP=60*1e3*5,xP=30*1e3;class AP extends Dt{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Is,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??JT,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Cb,this.started=!1,this.relayFilter=yo(100),this.reserveQueue=new Jd({concurrency:t?.reservationConcurrency??QT,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#r(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(la)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[la]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#t()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=_P();return this.pendingReservations.push(e),this.#t(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new vu("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new nP("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new vu("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const p=this.connectionManager.getConnections(e);let y=!1;if(p.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),p.map(g=>g.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),y=!0),y&&cp(i.reservation.expire)>SP)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#r(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new lp("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const l=await this.connectionManager.openConnection(e,{signal:o});if(di.matches(l.remoteAddr))throw new rP("not creating reservation over relayed connection");const c=await this.#e(l,{signal:o}),d=cp(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+d).toString());const f=Math.min(Math.max(d-EP,xP),Math.pow(2,31)-1),a=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async p=>{this.log.error("could not refresh reservation to relay %p - %e",e,p),await this.#r(e)}).catch(p=>{this.log.error("could not remove expired reservation to relay %p - %e",e,p)})},f);let u;if(t==="discovered"){const p=this.pendingReservations.pop();if(p==null)throw new lp("Made reservation on relay but did not need any more discovered relays");u={timeout:a,reservation:c,type:t,connection:l.id,id:p}}else u={timeout:a,reservation:c,type:t,connection:l.id};this.reservations.set(e,u),await this.peerStore.merge(e,{tags:{[la]:{value:1,ttl:d}}}),this.#t();const h={relay:e,details:u};return this.safeDispatchEvent("relay:created-reservation",{detail:h}),h}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#r(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(il,t),i=Fn(n).pb(fi);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:fi.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",o.status),o.status===Bt.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const d of o.reservation.addrs){let f=he(d);f.getComponents().find(a=>a.code===ce)==null&&(f=f.encapsulate(`/p2p/${e.remotePeer}`)),f=he(f.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(f.toString())}return o.reservation.addrs=[...c].map(d=>he(d).bytes),o.reservation}const l=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(l),new Error(l)}async#r(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[la]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#t())}#t(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=yo(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}class IP extends eb{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}}function fp(r){return new IP(r)}const kP=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(he)}catch{return!1}return!0},hp={maxInboundStopStreams:ap,maxOutboundStopStreams:ap};class CP{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??hp.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??hp.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new yP(e,{filter:t.discoveryFilter??pP(eP,tP)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,s)})}),this.reservationStore=new AP(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[xr]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Va](){return this.discovery!=null?["@libp2p/identify"]:[]}[Um]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(op,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await $m(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Fm(this.discovery,this.reservationStore),await this.components.registrar.unhandle(op),this.started=!1}async dial(e,t){const n=e.toString().split("/p2p-circuit"),s=he(n[0]),i=he(n[n.length-1]),o=s.getComponents().find(h=>h.code===ce)?.value,l=i.getComponents().find(h=>h.code===ce)?.value;if(o==null||l==null){const h=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${h}`),new ya(`C${h}`)}const c=sp(o),d=sp(l);let a=this.components.connectionManager.getConnections(c)[0];a==null?(await this.components.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new nt("circuit-relay:open-connection")),a=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new nt("circuit-relay:reuse-connection"));let u;try{t.onProgress?.(new nt("circuit-relay:open-hop-stream")),u=await a.newStream(il,t);const h=Fn(u).pb(fi);t.onProgress?.(new nt("circuit-relay:write-connect-message")),await h.write({type:fi.Type.CONNECT,peer:{id:d.toMultihash().bytes,addrs:[he(i).bytes]}},t),t.onProgress?.(new nt("circuit-relay:read-connect-response"));const p=await h.read(t);if(p.status!==Bt.OK)throw new $e(`failed to connect via relay with status ${p?.status?.toString()??"undefined"}`);const y=new up(p.limit),g=fp({stream:h.unwrap().unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:y.onData,onDataWrite:y.onData,log:u.log.newScope("circuit-relay:connection")}),m=await this.components.upgrader.upgradeOutbound(g,{...t,limits:y.getLimits()});return m.log("outbound relayed connection established to %p with limits %o, over connection %s",m.remotePeer,p.limit??"none",a.id),m}catch(h){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",d,c,h),u?.abort(h),h}}createListener(e){return vP({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Tb.exactMatch(t)||Pb.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>di.exactMatch(t))}async onStop(e,t){const n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(a){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",a)}const s=Fn(e).pb(Wr),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(i.type!==Wr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!kP(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}const o=af(hn(i.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.OK},{signal:n});const l=new up(i.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),d=this.components.addressManager.getAddresses()[0],f=fp({stream:s.unwrap().unwrap(),remoteAddr:c,localAddr:d,onDataRead:l.onData,onDataWrite:l.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(f,{limits:l.getLimits(),signal:n}),f.log("inbound relayed connection established to %p with limits %o, over connection %s",o,i.limit??"none",t.id)}finally{n?.clear()}}}function TP(r={}){return e=>new CP(e,r)}var wc,pp;function PP(){if(pp)return wc;pp=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return wc=function(n,s,i){if(typeof s!="string")throw new Error("Input must be string");for(var o=s.length,l=0,c,d,f=0;f<o;f+=1){if(c=s.charCodeAt(f),d=s[f],r(c)&&e(s.charCodeAt(f+1))&&(f+=1,d+=s[f]),l+=n(d),l===i)return s.slice(0,f+1);if(l>i)return s.slice(0,f-d.length+1)}return s},wc}var _c,gp;function DP(){if(gp)return _c;gp=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return _c=function(n){if(typeof n!="string")throw new Error("Input must be string");for(var s=n.length,i=0,o=null,l=null,c=0;c<s;c++)o=n.charCodeAt(c),e(o)?l!=null&&r(l)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),l=o;return i},_c}var Sc,mp;function LP(){if(mp)return Sc;mp=1;var r=PP(),e=DP();return Sc=r.bind(null,e),Sc}var Ec,yp;function RP(){if(yp)return Ec;yp=1;var r=LP(),e=/[\/\?<>\\:\*\|"]/g,t=/[\x00-\x1f\x80-\x9f]/g,n=/^\.+$/,s=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=/[\. ]+$/;function o(l,c){if(typeof l!="string")throw new Error("Input must be string");var d=l.replace(e,c).replace(t,c).replace(n,c).replace(s,c).replace(i,c);return r(d,255)}return Ec=function(l,c){var d=c&&c.replacement||"",f=o(l,d);return d===""?f:o(f,"")},Ec}var BP=RP();const NP=cd(BP),bp={keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"},xc={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Lb(r){const e="AES-GCM";let t=16;const n=12,s="SHA-256",i=16,o=32767,l=Ot.get();t*=8;async function c(a,u){const h=l.getRandomValues(new Uint8Array(i)),p=l.getRandomValues(new Uint8Array(n)),y={name:e,iv:p};typeof u=="string"&&(u=j(u));let g;if(u.length===0){g=await l.subtle.importKey("jwk",xc,{name:"AES-GCM"},!0,["encrypt"]);try{const w={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},v=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);g=await l.subtle.deriveKey(w,v,{name:e,length:t},!0,["encrypt"])}catch{g=await l.subtle.importKey("jwk",xc,{name:"AES-GCM"},!0,["encrypt"])}}else{const w={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},v=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);g=await l.subtle.deriveKey(w,v,{name:e,length:t},!0,["encrypt"])}const m=await l.subtle.encrypt(y,g,a);return an([h,y.iv,new Uint8Array(m)])}async function d(a,u){const h=a.subarray(0,i),p=a.subarray(i,i+n),y=a.subarray(i+n),g={name:e,iv:p};typeof u=="string"&&(u=j(u));let m;if(u.length===0)try{const v={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},_=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);m=await l.subtle.deriveKey(v,_,{name:e,length:t},!0,["decrypt"])}catch{m=await l.subtle.importKey("jwk",xc,{name:"AES-GCM"},!0,["decrypt"])}else{const v={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},_=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);m=await l.subtle.deriveKey(v,_,{name:e,length:t},!0,["decrypt"])}const w=await l.subtle.decrypt(g,m,y);return new Uint8Array(w)}return{encrypt:c,decrypt:d}}const MP="[object ArrayBuffer]";class Be{static isArrayBuffer(e){return Object.prototype.toString.call(e)===MP}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=Be.toUint8Array(e),s=Be.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const s=new Uint8Array(n);let i=0;for(const o of t){const l=this.toUint8Array(o);s.set(l,i),i+=l.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Ac="string",OP=/^[0-9a-f\s]+$/i,$P=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,FP=/^[a-zA-Z0-9-_]+$/;class vp{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){const t=Be.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}}class Cr{static toString(e,t=!1){const n=Be.toArrayBuffer(e),s=new DataView(n);let i="";for(let o=0;o<n.byteLength;o+=2){const l=s.getUint16(o,t);i+=String.fromCharCode(l)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return n}}class Ye{static isHex(e){return typeof e===Ac&&OP.test(e)}static isBase64(e){return typeof e===Ac&&$P.test(e)}static isBase64Url(e){return typeof e===Ac&&FP.test(e)}static ToString(e,t="utf8"){const n=Be.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Cr.toString(n,!0);case"utf16":case"utf16be":return Cr.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Cr.fromString(e,!0);case"utf16":case"utf16be":return Cr.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=Be.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=Ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return vp.fromString(e);case"utf16":case"utf16be":return Cr.fromString(e);case"utf16le":case"usc2":return Cr.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=Ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return vp.toString(e);case"utf16":case"utf16be":return Cr.toString(e);case"utf16le":case"usc2":return Cr.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){const t=Be.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){const t=Be.toUint8Array(e);let n="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);n[s/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return Cr.toString(e,t)}static FromUtf16String(e,t=!1){return Cr.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}Ye.DEFAULT_UTF8_ENCODING="utf8";function gi(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Ss(r,e,t=-1){const n=t;let s=r,i=0,o=Math.pow(2,e);for(let l=1;l<8;l++){if(r<o){let c;if(n<0)c=new ArrayBuffer(l),i=l;else{if(n<l)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}const d=new Uint8Array(c);for(let f=l-1;f>=0;f--){const a=Math.pow(2,f*e);d[i-f-1]=Math.floor(s/a),s-=d[i-f-1]*a}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function Nu(...r){let e=0,t=0;for(const i of r)e+=i.length;const n=new ArrayBuffer(e),s=new Uint8Array(n);for(const i of r)s.set(i,t),t+=i.length;return s}function Rb(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const l=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(l||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let l=0;l<this.valueHex.byteLength;l++)t[l]=0;t[0]=r[0]&128;const n=gi(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let l=0;l<this.valueHex.byteLength;l++)i[l]=r[l];return i[0]&=127,gi(i,8)-n}function UP(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,l=Ss(o,8,n),c=new Uint8Array(l);return c[0]|=128,l}let s=Ss(e,8,n),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),l=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=l[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function VP(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function jt(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,s=new Array(n);for(let o=0;o<n;o++)s[o]="0";return s.join("").concat(t)}function cl(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function uf(r){let e=0,t=0;for(let s=0;s<r.length;s++){const i=r[s];e+=i.byteLength}const n=new Uint8Array(e);for(let s=0;s<r.length;s++){const i=r[s];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function gn(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class df{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return uf(this.items)}}const Ni=[new Uint8Array([1])],wp="0123456789",Ii="",Fr=new ArrayBuffer(0),ff=new Uint8Array(0),Eo="EndOfContent",Bb="OCTET STRING",Nb="BIT STRING";function mn(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);const i=n[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?Be.toUint8Array(i.valueHex):ff}fromBER(n,s,i){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!gn(this,o,s,i))return-1;const l=s+i;return this.valueHexView=o.subarray(s,l),this.valueHexView.length?(this.blockLength=i,l):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Fr)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Ye.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class ks{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Ii,warnings:n=[],valueBeforeDecode:s=ff}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Be.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Ye.ToHex(this.valueBeforeDecodeView)}}}ks.NAME="baseBlock";class Gt extends ks{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Gt.NAME="valueBlock";class Mb extends mn(ks){constructor({idBlock:e={}}={}){var t,n,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Be.toUint8Array(e.valueHex):ff,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Fr}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=Ss(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,l=new Uint8Array(o+1);if(l[0]=t|31,!e){for(let c=0;c<o-1;c++)l[c+1]=i[c]|128;l[o]=i[o-1]}return l.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)n[i+1]=s[i]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const l=i[0]&31;if(l!==31)this.tagNumber=l,this.blockLength=1;else{let c=1,d=this.valueHexView=new Uint8Array(255),f=255;for(;i[c]&128;){if(d[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===f){f+=255;const u=new Uint8Array(f);for(let h=0;h<d.length;h++)u[h]=d[h];d=this.valueHexView=new Uint8Array(f)}}this.blockLength=c+1,d[c-1]=i[c]&127;const a=new Uint8Array(c);for(let u=0;u<c;u++)a[u]=d[u];d=this.valueHexView=new Uint8Array(c),d.set(a),this.blockLength<=9?this.tagNumber=gi(d,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}Mb.NAME="identificationBlock";class Ob extends ks{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const l=t+1,c=s.subarray(l,l+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=gi(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const s=Ss(this.length,8);if(s.byteLength>127)return this.error="Too big length",Fr;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)n[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}Ob.NAME="lengthBlock";const Z={};class Ft extends ks{constructor({name:e=Ii,optional:t=!1,primitiveSchema:n,...s}={},i){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new Mb(s),this.lenBlock=new Ob(s),this.valueBlock=i?new i(s):new Gt(s)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const n=t||new df;t||$b(this);const s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(i)}return t?Fr:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Ye.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=Ye.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return VP(t,n)}}Ft.NAME="BaseBlock";function $b(r){var e;if(r instanceof Z.Constructed)for(const t of r.valueBlock.value)$b(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class Fb extends Ft{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Ii,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}Fb.NAME="BaseStringBlock";class Ub extends mn(Gt){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}Ub.NAME="PrimitiveValueBlock";var Vb;class Kb extends Ft{constructor(e={}){super(e,Ub),this.idBlock.isConstructed=!1}}Vb=Kb;Z.Primitive=Vb;Kb.NAME="PRIMITIVE";function KP(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function Zl(r,e=0,t=r.length){const n=e;let s=new Ft({},Gt);const i=new ks;if(!gn(i,r,e,t))return s.error=i.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let l=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),l===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=l,t-=s.idBlock.blockLength,l=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),l===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=l,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=Ft;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=Z.EndOfContent;break;case 1:c=Z.Boolean;break;case 2:c=Z.Integer;break;case 3:c=Z.BitString;break;case 4:c=Z.OctetString;break;case 5:c=Z.Null;break;case 6:c=Z.ObjectIdentifier;break;case 10:c=Z.Enumerated;break;case 12:c=Z.Utf8String;break;case 13:c=Z.RelativeObjectIdentifier;break;case 14:c=Z.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=Z.Sequence;break;case 17:c=Z.Set;break;case 18:c=Z.NumericString;break;case 19:c=Z.PrintableString;break;case 20:c=Z.TeletexString;break;case 21:c=Z.VideotexString;break;case 22:c=Z.IA5String;break;case 23:c=Z.UTCTime;break;case 24:c=Z.GeneralizedTime;break;case 25:c=Z.GraphicString;break;case 26:c=Z.VisibleString;break;case 27:c=Z.GeneralString;break;case 28:c=Z.UniversalString;break;case 29:c=Z.CharacterString;break;case 30:c=Z.BmpString;break;case 31:c=Z.DATE;break;case 32:c=Z.TimeOfDay;break;case 33:c=Z.DateTime;break;case 34:c=Z.Duration;break;default:{const d=s.idBlock.isConstructed?new Z.Constructed:new Z.Primitive;d.idBlock=s.idBlock,d.lenBlock=s.lenBlock,d.warnings=s.warnings,s=d}}break;default:c=s.idBlock.isConstructed?Z.Constructed:Z.Primitive}return s=KP(s,c),l=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:l,result:s}}function Ic(r){if(!r.byteLength){const e=new Ft({},Gt);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Zl(Be.toUint8Array(r).slice(),0,r.byteLength)}function qP(r,e){return r?1:e}class Nn extends Gt{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;qP(this.isIndefiniteForm,n)>0;){const o=Zl(s,i,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Eo)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Eo?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new df;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?Fr:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Nn.NAME="ConstructedValueBlock";var qb;class ki extends Ft{constructor(e={}){super(e,Nn),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}qb=ki;Z.Constructed=qb;ki.NAME="CONSTRUCTED";class Hb extends Gt{fromBER(e,t,n){return t}toBER(e){return Fr}}Hb.override="EndOfContentValueBlock";var zb;class Wb extends Ft{constructor(e={}){super(e,Hb),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}zb=Wb;Z.EndOfContent=zb;Wb.NAME=Eo;var Gb;class ul extends Ft{constructor(e={}){super(e,Gt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}Gb=ul;Z.Null=Gb;ul.NAME="NULL";class Yb extends mn(Gt){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Be.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const s=Be.toUint8Array(e);return gn(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,Rb.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}Yb.NAME="BooleanValueBlock";var Xb;let Zb=class extends Ft{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,Yb),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};Xb=Zb;Z.Boolean=Xb;Zb.NAME="BOOLEAN";class jb extends mn(Nn){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Nn.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===Eo){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==Bb)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?Nn.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}jb.NAME="OctetStringValueBlock";var hf;class Ks extends Ft{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},jb),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){const o=Zl(i,0,i.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return ki.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=Ye.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof hf&&e.push(t.valueBlock.valueHexView);return Be.concat(e)}}hf=Ks;Z.OctetString=hf;Ks.NAME=Bb;class Qb extends mn(Nn){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=Nn.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(const l of this.value){const c=l.constructor.NAME;if(c===Eo){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==Nb)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const d=l.valueBlock;if(this.unusedBits>0&&d.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=d.unusedBits}return s}const i=Be.toUint8Array(e);if(!gn(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const l=o.subarray(1);try{if(l.byteLength){const c=Zl(l,0,l.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return Nn.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength){const s=new Uint8Array(1);return s[0]=0,s.buffer}const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}Qb.NAME="BitStringValueBlock";var Jb;class ev extends Ft{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},Qb),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return ki.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),s=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}}Jb=ev;Z.BitString=Jb;ev.NAME=Nb;var tv;function HP(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e);let i=n.slice(0);const o=i.length-1,l=s.slice(0),c=l.length-1;let d=0;const f=c<o?o:c;let a=0;for(let u=f;u>=0;u--,a++)!0===a<l.length?d=i[o-a]+l[c-a]+t[0]:d=i[o-a]+t[0],t[0]=d/10,!0===a>=i.length?i=Nu(new Uint8Array([d%10]),i):i[o-a]=d%10;return t[0]>0&&(i=Nu(t,i)),i}function _p(r){if(r>=Ni.length)for(let e=Ni.length;e<=r;e++){const t=new Uint8Array([0]);let n=Ni[e-1].slice(0);for(let s=n.length-1;s>=0;s--){const i=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=i[0]/10,n[s]=i[0]%10}t[0]>0&&(n=Nu(t,n)),Ni.push(n)}return Ni[r]}function zP(r,e){let t=0;const n=new Uint8Array(r),s=new Uint8Array(e),i=n.slice(0),o=i.length-1,l=s.slice(0),c=l.length-1;let d,f=0;for(let a=c;a>=0;a--,f++)d=i[o-f]-l[c-f]-t,!0===d<0?(t=1,i[o-f]=d+10):(t=0,i[o-f]=d);if(t>0)for(let a=o-c+1;a>=0;a--,f++)if(d=i[o-f]-t,d<0)t=1,i[o-f]=d+10;else{t=0,i[o-f]=d;break}return i.slice()}class pf extends mn(Gt){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=Rb.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(UP(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){const i=this.fromBER(e,t,n);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,s;const i=this.valueHexView;let o="",l=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let d=0;d<8;d++)(s&1)===1&&(n===e?(t=zP(_p(n),t),o="-"):t=HP(t,_p(n))),n++,s>>=1}for(let c=0;c<t.length;c++)t[c]&&(l=!0),l&&(o+=wp.charAt(t[c]));return l===!1&&(o+=wp.charAt(0)),o}}tv=pf;pf.NAME="IntegerValueBlock";Object.defineProperty(tv.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var eo;class Zs extends Ft{constructor(e={}){super(e,pf),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return cl(),BigInt(this.valueBlock.toString())}static fromBigInt(e){cl();const t=BigInt(e),n=new df,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(Ye.FromHex(s));if(t<0){const l=new Uint8Array(i.length+(i[0]&128?1:0));l[0]|=128;const d=BigInt(`0x${Ye.ToHex(l)}`)+t,f=Be.toUint8Array(Ye.FromHex(d.toString(16)));f[0]|=128,n.write(f)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new eo({valueHex:n.final()})}convertToDER(){const e=new eo({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new eo({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}eo=Zs;Z.Integer=eo;Zs.NAME="INTEGER";var rv;class nv extends Zs{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}rv=nv;Z.Enumerated=rv;nv.NAME="ENUMERATED";class Mu extends mn(Gt){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let l=0;l<n&&(this.valueHexView[l]=i[l]&127,this.blockLength++,(i[l]&128)!==0);l++);const o=new Uint8Array(this.blockLength);for(let l=0;l<this.blockLength;l++)o[l]=this.valueHexView[l];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=gi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){cl();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Ss(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Fr;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n}toString(){let e="";if(this.isHexOnly)e=Ye.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Mu.NAME="sidBlock";class sv extends Gt{constructor({value:e=Ii,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new Mu;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,Fr;t.push(s)}return uf(t)}fromString(e){this.value=[];let t=0,n=0,s="",i=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,i){const o=this.value[0];let l=0;switch(o.valueDec){case 0:break;case 1:l=40;break;case 2:l=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+l,i=!1}else{const o=new Mu;if(s>Number.MAX_SAFE_INTEGER){cl();const l=BigInt(s);o.valueBigInt=l}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}sv.NAME="ObjectIdentifierValueBlock";var iv;class jn extends Ft{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,sv),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}iv=jn;Z.ObjectIdentifier=iv;jn.NAME="OBJECT IDENTIFIER";class Ou extends mn(ks){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let l=0;l<n&&(this.valueHexView[l]=i[l]&127,this.blockLength++,(i[l]&128)!==0);l++);const o=new Uint8Array(this.blockLength);for(let l=0;l<this.blockLength;l++)o[l]=this.valueHexView[l];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=gi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Ss(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Fr;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Ye.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Ou.NAME="relativeSidBlock";class ov extends Gt{constructor({value:e=Ii,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new Ou;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const n=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,Fr;n.push(i)}return uf(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;const i=new Ou;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}ov.NAME="RelativeObjectIdentifierValueBlock";var av;class lv extends Ft{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,ov),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}av=lv;Z.RelativeObjectIdentifier=av;lv.NAME="RelativeObjectIdentifier";var cv;class br extends ki{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}cv=br;Z.Sequence=cv;br.NAME="SEQUENCE";var uv;let dv=class extends ki{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};uv=dv;Z.Set=uv;dv.NAME="SET";class fv extends mn(Gt){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Ii}toJSON(){return{...super.toJSON(),value:this.value}}}fv.NAME="StringValueBlock";class hv extends fv{}hv.NAME="SimpleStringValueBlock";class rr extends Fb{constructor({...e}={}){super(e,hv)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Be.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}}rr.NAME="SIMPLE STRING";class pv extends rr{fromBuffer(e){this.valueBlock.valueHexView=Be.toUint8Array(e);try{this.valueBlock.value=Ye.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Ye.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Ye.FromUtf8String(e)),this.valueBlock.value=e}}pv.NAME="Utf8StringValueBlock";var gv;class Cs extends pv{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}gv=Cs;Z.Utf8String=gv;Cs.NAME="UTF8String";class mv extends rr{fromBuffer(e){this.valueBlock.value=Ye.ToUtf16String(e),this.valueBlock.valueHexView=Be.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Ye.FromUtf16String(e))}}mv.NAME="BmpStringValueBlock";var yv;class bv extends mv{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}yv=bv;Z.BmpString=yv;bv.NAME="BMPString";class vv extends rr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=Ss(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const l=4-o.length;for(let c=o.length-1;c>=0;c--)n[s*4+c+l]=o[c]}this.valueBlock.value=e}}vv.NAME="UniversalStringValueBlock";var wv;class _v extends vv{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}wv=_v;Z.UniversalString=wv;_v.NAME="UniversalString";var Sv;class Ev extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}Sv=Ev;Z.NumericString=Sv;Ev.NAME="NumericString";var xv;class Av extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}xv=Av;Z.PrintableString=xv;Av.NAME="PrintableString";var Iv;class kv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}Iv=kv;Z.TeletexString=Iv;kv.NAME="TeletexString";var Cv;class Tv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}Cv=Tv;Z.VideotexString=Cv;Tv.NAME="VideotexString";var Pv;class Dv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}Pv=Dv;Z.IA5String=Pv;Dv.NAME="IA5String";var Lv;class Rv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}Lv=Rv;Z.GraphicString=Lv;Rv.NAME="GraphicString";var Bv;class gf extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Bv=gf;Z.VisibleString=Bv;gf.NAME="VisibleString";var Nv;class Mv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}Nv=Mv;Z.GeneralString=Nv;Mv.NAME="GeneralString";var Ov;class $v extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}Ov=$v;Z.CharacterString=Ov;$v.NAME="CharacterString";var Fv;class mf extends gf{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Be.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=jt(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=jt(this.month,2),t[2]=jt(this.day,2),t[3]=jt(this.hour,2),t[4]=jt(this.minute,2),t[5]=jt(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}Fv=mf;Z.UTCTime=Fv;mf.NAME="UTCTime";var Uv;class Vv extends mf{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",i=0,o,l=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const a=new Number(e[e.length-1]);if(isNaN(a.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let a=1,u=n.indexOf("+"),h="";if(u===-1&&(u=n.indexOf("-"),a=-1),u!==-1){if(h=n.substring(u+1),n=n.substring(0,u),h.length!==2&&h.length!==4)throw new Error("Wrong input string for conversion");let p=parseInt(h.substring(0,2),10);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");if(l=a*p,h.length===4){if(p=parseInt(h.substring(2,4),10),isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");c=a*p}}}let d=n.indexOf(".");if(d===-1&&(d=n.indexOf(",")),d!==-1){const a=new Number(`0${n.substring(d)}`);if(isNaN(a.valueOf()))throw new Error("Wrong input string for conversion");i=a.valueOf(),s=n.substring(0,d)}else s=n;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,d!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,d!==-1){let a=60*i;this.minute=Math.floor(a),a=60*(a-this.minute),this.second=Math.floor(a),a=1e3*(a-this.second),this.millisecond=Math.floor(a)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,d!==-1){let a=60*i;this.second=Math.floor(a),a=1e3*(a-this.second),this.millisecond=Math.floor(a)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,d!==-1){const a=1e3*i;this.millisecond=Math.floor(a)}break;default:throw new Error("Wrong input string for conversion")}const f=o.exec(s);if(f===null)throw new Error("Wrong input string for conversion");for(let a=1;a<f.length;a++)switch(a){case 1:this.year=parseInt(f[a],10);break;case 2:this.month=parseInt(f[a],10);break;case 3:this.day=parseInt(f[a],10);break;case 4:this.hour=parseInt(f[a],10)+l;break;case 5:this.minute=parseInt(f[a],10)+c;break;case 6:this.second=parseInt(f[a],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const a=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=a.getUTCFullYear(),this.month=a.getUTCMonth(),this.day=a.getUTCDay(),this.hour=a.getUTCHours(),this.minute=a.getUTCMinutes(),this.second=a.getUTCSeconds(),this.millisecond=a.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(jt(this.year,4)),t.push(jt(this.month,2)),t.push(jt(this.day,2)),t.push(jt(this.hour,2)),t.push(jt(this.minute,2)),t.push(jt(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(jt(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}Uv=Vv;Z.GeneralizedTime=Uv;Vv.NAME="GeneralizedTime";var Kv;class qv extends Cs{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}Kv=qv;Z.DATE=Kv;qv.NAME="DATE";var Hv;class zv extends Cs{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}Hv=zv;Z.TimeOfDay=Hv;zv.NAME="TimeOfDay";var Wv;class Gv extends Cs{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}Wv=Gv;Z.DateTime=Wv;Gv.NAME="DateTime";var Yv;class Xv extends Cs{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}Yv=Xv;Z.Duration=Yv;Xv.NAME="Duration";var Zv;class jv extends Cs{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}Zv=jv;Z.TIME=Zv;jv.NAME="TIME";const WP=16,$u=32,Fu=1e4;async function jl(r,e){const n=await Lb().encrypt(r,e);return Lo.encode(n)}async function Sp(r,e,t){if(r.type==="RSA")return ZP(r,e,t);if(r.type==="Ed25519")return GP(r,e,t);if(r.type==="secp256k1")return YP(r,e,t);if(r.type==="ECDSA")return XP(r,e,t);throw new Ir}async function GP(r,e,t="libp2p-key"){if(t==="libp2p-key")return jl(Ho(r),e);throw new V(`export format '${t}' is not supported`)}async function YP(r,e,t="libp2p-key"){if(t==="libp2p-key")return jl(Ho(r),e);throw new V("Export format is not supported")}async function XP(r,e,t="libp2p-key"){if(t==="libp2p-key")return jl(Ho(r),e);throw new V(`export format '${t}' is not supported`)}async function ZP(r,e,t="pkcs-8"){if(t==="pkcs-8")return jP(r,e);if(t==="libp2p-key")return jl(Ho(r),e);throw new V("Export format is not supported")}async function jP(r,e){const t=Ot.get(),s=new br({value:[new Zs({value:0}),new br({value:[new jn({value:"1.2.840.113549.1.1.1"}),new ul]}),new Ks({valueHex:r.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=ai(WP),l=await Vy(Ul,e,o,{c:Fu,dkLen:$u}),c=ai(16),d=await t.subtle.importKey("raw",l,"AES-CBC",!1,["encrypt"]),f=await t.subtle.encrypt({name:"AES-CBC",iv:c},d,i),a=new br({value:[new Ks({valueHex:o}),new Zs({value:Fu}),new Zs({value:$u}),new br({value:[new jn({value:"1.2.840.113549.2.11"}),new ul]})]}),u=new br({value:[new jn({value:"1.2.840.113549.1.5.13"}),new br({value:[new br({value:[new jn({value:"1.2.840.113549.1.5.12"}),a]}),new br({value:[new jn({value:"2.16.840.1.101.3.4.1.42"}),new Ks({valueHex:c})]})]})]}),p=new br({value:[u,new Ks({valueHex:f})]}).toBER(),y=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...W(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Ep(r,e){try{const t=await QP(r,e);return UI(t)}catch{}if(!r.includes("BEGIN"))throw new V("Encrypted key was not a libp2p-key or a PEM file");return JP(r,e)}async function QP(r,e){const t=Lo.decode(r);return Lb().decrypt(t,e)}async function JP(r,e){const t=Ot.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=j(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ic(i),{iv:l,salt:c,iterations:d,keySize:f,cipherText:a}=eD(o),u=await Vy(Ul,e,c,{c:d,dkLen:f}),h=await t.subtle.importKey("raw",u,"AES-CBC",!1,["decrypt"]),p=to(await t.subtle.decrypt({name:"AES-CBC",iv:l},h,a)),{result:y}=Ic(p);n=xp(y)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const i=j(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ic(i);n=xp(o)}else throw new V("Could not parse private key from PEM data");const s=VI(n);if(s.type!=="RSA")throw new V("Could not parse RSA private key from PEM data");return s}function eD(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new V("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new V("Only pkcs5PBKDF2 key derivation functions are supported");const i=n.valueBlock.value[1],o=to(i.valueBlock.value[0].getValue());let l=Fu,c=$u;if(i.valueBlock.value.length===3)l=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new V("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const d=e.valueBlock.value[1].valueBlock.value[1],f=d.valueBlock.value[0].toString();if(f!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(f!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new V("Only AES-CBC encryption schemes are supported")}}}}const a=to(d.valueBlock.value[1].getValue());return{cipherText:to(r.valueBlock.value[1].getValue()),salt:o,iterations:l,keySize:c,iv:a}}function xp(r){return to(r.valueBlock.value[2].getValue())}function to(r){return new Uint8Array(r,0,r.byteLength)}const tD="/pkcs8/",Uu="/info/",Mi=new WeakMap,Yn={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function Ns(r){return r==null||typeof r!="string"?!1:r===NP(r.trim())&&r.length>0}async function mt(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Xn(r){return new je(tD+r)}function Ms(r){return new je(Uu+r)}async function rD(r){const e=Ho(r),t=await pr.digest(e);return De.encode(t.bytes).substring(1)}class nD{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...bp,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Yn.minKeyLength)throw new Error(`dek.keyLength must be least ${Yn.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Yn.minSaltLength)throw new Error(`dek.saltLength must be least ${Yn.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Yn.minIterationCount)throw new Error(`dek.iterationCount must be least ${Yn.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?Fh(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Mi.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[xr]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},this.options),t=Math.ceil(Yn.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=W(ai(t),"base64")),e}static get options(){return{dek:{...bp}}}async findKeyByName(e){if(!Ns(e))throw await mt(),new V(`Invalid key name '${e}'`);const t=Ms(e);try{const n=await this.components.datastore.get(t);return JSON.parse(W(n))}catch(n){throw await mt(),this.log.error("could not read key from datastore - %e",n),new $a(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:Uu};for await(const n of this.components.datastore.query(t)){const s=JSON.parse(W(n.value));if(s.id===e)return s}throw new V(`Key with id '${e}' does not exist.`)}catch(t){throw await mt(),t}}async importKey(e,t){if(!Ns(e))throw await mt(),new V(`Invalid key name '${e}'`);if(t==null)throw await mt(),new V("Key is required");const n=Xn(e);if(await this.components.datastore.has(n))throw await mt(),new V(`Key '${e}' already exists`);let i,o;try{i=await rD(t);const d=Mi.get(this);if(d==null)throw new V("dek missing");const f=d.dek;o=await Sp(t,f,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(d){throw await mt(),d}const l={name:e,id:i},c=this.components.datastore.batch();return c.put(n,j(o)),c.put(Ms(e),j(JSON.stringify(l))),await c.commit(),l}async exportKey(e){if(!Ns(e))throw await mt(),new V(`Invalid key name '${e}'`);const t=Xn(e);try{const n=await this.components.datastore.get(t),s=W(n),i=Mi.get(this);if(i==null)throw new V("dek missing");const o=i.dek;return await Ep(s,o)}catch(n){throw await mt(),n}}async removeKey(e){if(!Ns(e)||e===this.self)throw await mt(),new V(`Invalid key name '${e}'`);const t=Xn(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Ms(e)),await s.commit(),n}async listKeys(){const e={prefix:Uu},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(W(n.value)));return t}async renameKey(e,t){if(!Ns(e)||e===this.self)throw await mt(),new V(`Invalid old key name '${e}'`);if(!Ns(t)||t===this.self)throw await mt(),new V(`Invalid new key name '${t}'`);const n=Xn(e),s=Xn(t),i=Ms(e),o=Ms(t);if(await this.components.datastore.has(s))throw await mt(),new V(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),d=await this.components.datastore.get(i),f=JSON.parse(W(d));f.name=t;const a=this.components.datastore.batch();return a.put(s,c),a.put(o,j(JSON.stringify(f))),a.delete(n),a.delete(i),await a.commit(),f}catch(c){throw await mt(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await mt(),new V(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await mt(),new V(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await mt(),new V(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=Mi.get(this);if(n==null)throw new V("dek missing");const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?Fh(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Mi.set(this,{dek:i});const o=await this.listKeys();for(const l of o){const c=await this.components.datastore.get(Xn(l.name)),d=W(c),f=await Ep(d,s),a=i.toString(),u=await Sp(f,a,f.type==="RSA"?"pkcs-8":"libp2p-key"),h=this.components.datastore.batch(),p={name:l.name,id:l.id};h.put(Xn(l.name),j(u)),h.put(Ms(l.name),j(JSON.stringify(p))),await h.commit()}this.log("keychain reconstructed")}}function Qv(r={}){return e=>new nD(e,r)}async function sD(r,e={}){const t=e.selfKey??"self",n=Qv(e)({datastore:r,logger:dd()});let s;return await r.has(new je(`/pkcs8/${t}`))?s=await n.exportKey(t):(s=await $y(e.keyType??"Ed25519"),await n.importKey(t,s)),s}const iD=Symbol.for("@libp2p/pubsub");var kc={exports:{}},Ap;function oD(){return Ap||(Ap=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,d,f){this.fn=c,this.context=d,this.once=f||!1}function i(c,d,f,a,u){if(typeof f!="function")throw new TypeError("The listener must be a function");var h=new s(f,a||c,u),p=t?t+d:d;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],h]:c._events[p].push(h):(c._events[p]=h,c._eventsCount++),c}function o(c,d){--c._eventsCount===0?c._events=new n:delete c._events[d]}function l(){this._events=new n,this._eventsCount=0}l.prototype.eventNames=function(){var d=[],f,a;if(this._eventsCount===0)return d;for(a in f=this._events)e.call(f,a)&&d.push(t?a.slice(1):a);return Object.getOwnPropertySymbols?d.concat(Object.getOwnPropertySymbols(f)):d},l.prototype.listeners=function(d){var f=t?t+d:d,a=this._events[f];if(!a)return[];if(a.fn)return[a.fn];for(var u=0,h=a.length,p=new Array(h);u<h;u++)p[u]=a[u].fn;return p},l.prototype.listenerCount=function(d){var f=t?t+d:d,a=this._events[f];return a?a.fn?1:a.length:0},l.prototype.emit=function(d,f,a,u,h,p){var y=t?t+d:d;if(!this._events[y])return!1;var g=this._events[y],m=arguments.length,w,v;if(g.fn){switch(g.once&&this.removeListener(d,g.fn,void 0,!0),m){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,f),!0;case 3:return g.fn.call(g.context,f,a),!0;case 4:return g.fn.call(g.context,f,a,u),!0;case 5:return g.fn.call(g.context,f,a,u,h),!0;case 6:return g.fn.call(g.context,f,a,u,h,p),!0}for(v=1,w=new Array(m-1);v<m;v++)w[v-1]=arguments[v];g.fn.apply(g.context,w)}else{var _=g.length,k;for(v=0;v<_;v++)switch(g[v].once&&this.removeListener(d,g[v].fn,void 0,!0),m){case 1:g[v].fn.call(g[v].context);break;case 2:g[v].fn.call(g[v].context,f);break;case 3:g[v].fn.call(g[v].context,f,a);break;case 4:g[v].fn.call(g[v].context,f,a,u);break;default:if(!w)for(k=1,w=new Array(m-1);k<m;k++)w[k-1]=arguments[k];g[v].fn.apply(g[v].context,w)}}return!0},l.prototype.on=function(d,f,a){return i(this,d,f,a,!1)},l.prototype.once=function(d,f,a){return i(this,d,f,a,!0)},l.prototype.removeListener=function(d,f,a,u){var h=t?t+d:d;if(!this._events[h])return this;if(!f)return o(this,h),this;var p=this._events[h];if(p.fn)p.fn===f&&(!u||p.once)&&(!a||p.context===a)&&o(this,h);else{for(var y=0,g=[],m=p.length;y<m;y++)(p[y].fn!==f||u&&!p[y].once||a&&p[y].context!==a)&&g.push(p[y]);g.length?this._events[h]=g.length===1?g[0]:g:o(this,h)}return this},l.prototype.removeAllListeners=function(d){var f;return d?(f=t?t+d:d,this._events[f]&&o(this,f)):(this._events=new n,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=t,l.EventEmitter=l,r.exports=l})(kc)),kc.exports}var aD=oD();const lD=cd(aD);class yf extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,yf)}}const Ip=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function cD(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout},signal:o}=e;let l,c;const f=new Promise((a,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(o?.aborted){u(Ip(o));return}if(o&&(c=()=>{u(Ip(o))},o.addEventListener("abort",c,{once:!0})),r.then(a,u),t===Number.POSITIVE_INFINITY)return;const h=new yf;l=i.setTimeout.call(void 0,()=>{if(n){try{a(n())}catch(p){u(p)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?a():s instanceof Error?u(s):(h.message=s??`Promise timed out after ${t} milliseconds`,u(h))},t)}).finally(()=>{f.clear(),c&&o&&o.removeEventListener("abort",c)});return f.clear=()=>{i.clearTimeout.call(void 0,l),l=void 0},f}function uD(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}class dD{#e=[];enqueue(e,t){const{priority:n=0,id:s}=t??{},i={priority:n,id:s,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(i);return}const o=uD(this.#e,i,(l,c)=>c.priority-l.priority);this.#e.splice(o,0,i)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}}class Jv extends lD{#e;#r;#t=0;#n;#i=!1;#a=!1;#s;#h=0;#p=0;#d;#g;#f;#l=[];#c=0;#o;#m;#u=0;#_;#b;#E=1n;#y=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:dD,strict:!1,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(e.strict&&e.interval===0)throw new TypeError("The `strict` option requires a non-zero `interval`");if(e.strict&&e.intervalCap===Number.POSITIVE_INFINITY)throw new TypeError("The `strict` option requires a finite `intervalCap`");if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#r=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#n=e.intervalCap,this.#s=e.interval,this.#f=e.strict,this.#o=new e.queueClass,this.#m=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#b=e.autoStart===!1,this.#U()}#v(e){for(;this.#c<this.#l.length;){const n=this.#l[this.#c];if(n!==void 0&&e-n>=this.#s)this.#c++;else break}(this.#c>100&&this.#c>this.#l.length/2||this.#c===this.#l.length)&&(this.#l=this.#l.slice(this.#c),this.#c=0)}#x(e){this.#f?this.#l.push(e):this.#t++}#B(){this.#f?this.#l.length>this.#c&&this.#l.pop():this.#t>0&&this.#t--}#A(){return this.#l.length-this.#c}get#N(){return this.#r?!0:this.#f?this.#A()<this.#n:this.#t<this.#n}get#M(){return this.#u<this.#_}#O(){this.#u--,this.#u===0&&this.emit("pendingZero"),this.#C(),this.emit("next")}#$(){this.#g=void 0,this.#L(),this.#D()}#F(e){if(this.#f){if(this.#v(e),this.#A()>=this.#n){const n=this.#l[this.#c],s=this.#s-(e-n);return this.#I(s),!0}return!1}if(this.#d===void 0){const t=this.#h-e;if(t<0){if(this.#p>0){const n=e-this.#p;if(n<this.#s)return this.#I(this.#s-n),!0}this.#t=this.#e?this.#u:0}else return this.#I(t),!0}return!1}#I(e){this.#g===void 0&&(this.#g=setTimeout(()=>{this.#$()},e))}#k(){this.#d&&(clearInterval(this.#d),this.#d=void 0)}#P(){this.#g&&(clearTimeout(this.#g),this.#g=void 0)}#C(){if(this.#o.size===0){if(this.#k(),this.emit("empty"),this.#u===0){if(this.#P(),this.#f&&this.#c>0){const t=Date.now();this.#v(t)}this.emit("idle")}return!1}let e=!1;if(!this.#b){const t=Date.now(),n=!this.#F(t);if(this.#N&&this.#M){const s=this.#o.dequeue();this.#r||(this.#x(t),this.#S()),this.emit("active"),s(),n&&this.#D(),e=!0}}return e}#D(){this.#r||this.#d!==void 0||this.#f||(this.#d=setInterval(()=>{this.#L()},this.#s),this.#h=Date.now()+this.#s)}#L(){this.#f||(this.#t===0&&this.#u===0&&this.#d&&this.#k(),this.#t=this.#e?this.#u:0),this.#T(),this.#S()}#T(){for(;this.#C(););}get concurrency(){return this.#_}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#_=e,this.#T()}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#o.setPriority(e,t)}async add(e,t={}){return t={timeout:this.timeout,...t,id:t.id??(this.#E++).toString()},new Promise((n,s)=>{const i=Symbol(`task-${t.id}`);this.#o.enqueue(async()=>{this.#u++,this.#y.set(i,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});let o;try{try{t.signal?.throwIfAborted()}catch(d){throw this.#V(),this.#y.delete(i),d}this.#p=Date.now();let l=e({signal:t.signal});if(t.timeout&&(l=cD(Promise.resolve(l),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#u} running, ${this.#o.size} waiting)`})),t.signal){const{signal:d}=t;l=Promise.race([l,new Promise((f,a)=>{o=()=>{a(d.reason)},d.addEventListener("abort",o,{once:!0})})])}const c=await l;n(c),this.emit("completed",c)}catch(l){s(l),this.emit("error",l)}finally{o&&t.signal?.removeEventListener("abort",o),this.#y.delete(i),queueMicrotask(()=>{this.#O()})}},t),this.emit("add"),this.#C()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#b?(this.#b=!1,this.#T(),this):this}pause(){this.#b=!0}clear(){this.#o=new this.#m,this.#k(),this.#R(),this.emit("empty"),this.#u===0&&(this.#P(),this.emit("idle")),this.emit("next")}async onEmpty(){this.#o.size!==0&&await this.#w("empty")}async onSizeLessThan(e){this.#o.size<e||await this.#w("next",()=>this.#o.size<e)}async onIdle(){this.#u===0&&this.#o.size===0||await this.#w("idle")}async onPendingZero(){this.#u!==0&&await this.#w("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#w("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#w("rateLimitCleared")}onError(){return new Promise((e,t)=>{const n=s=>{this.off("error",n),t(s)};this.on("error",n)})}async#w(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#o.size}sizeBy(e){return this.#o.filter(e).length}get pending(){return this.#u}get isPaused(){return this.#b}#U(){this.#r||(this.on("add",()=>{this.#o.size>0&&this.#S()}),this.on("next",()=>{this.#S()}))}#S(){this.#r||this.#a||(this.#a=!0,queueMicrotask(()=>{this.#a=!1,this.#R()}))}#V(){this.#r||(this.#B(),this.#S())}#R(){const e=this.#i;if(this.#r||this.#o.size===0){e&&(this.#i=!1,this.emit("rateLimitCleared"));return}let t;if(this.#f){const s=Date.now();this.#v(s),t=this.#A()}else t=this.#t;const n=t>=this.#n;n!==e&&(this.#i=n,this.emit(n?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#i}get isSaturated(){return this.#u===this.#_&&this.#o.size>0||this.isRateLimited&&this.#o.size>0}get runningTasks(){return[...this.#y.values()].map(e=>({...e}))}}class fD{entries;validityMs;lastPruneTime=0;constructor(e){this.entries=new Map,this.validityMs=e.validityMs}put(e,t){this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),this.prune()}prune(){const e=Date.now();if(!(e-this.lastPruneTime<200)){this.lastPruneTime=e;for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries=new Map,this.lastPruneTime=0}}var xo;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.subscribe=s.bool();break}case 2:{l.topic=s.string();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.SubOpts||(r.SubOpts={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.sequenceNumber!=null&&(i.uint32(26),i.bytes(s.sequenceNumber)),s.topic!=null&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.from=s.bytes();break}case 2:{l.data=s.bytes();break}case 3:{l.sequenceNumber=s.bytes();break}case 4:{l.topic=s.string();break}case 5:{l.signature=s.bytes();break}case 6:{l.key=s.bytes();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Message||(r.Message={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const i of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(i,n);if(t.messages!=null)for(const i of t.messages)n.uint32(18),r.Message.codec().encode(i,n);t.control!=null&&(n.uint32(26),dl.codec().encode(t.control,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new vt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new vt('Decode error - map field "messages" had too many elements');i.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=dl.codec().decode(t,t.uint32(),{limits:s.limits?.control});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(xo||(xo={}));var dl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.ihave!=null)for(const i of t.ihave)n.uint32(10),fl.codec().encode(i,n);if(t.iwant!=null)for(const i of t.iwant)n.uint32(18),hl.codec().encode(i,n);if(t.graft!=null)for(const i of t.graft)n.uint32(26),pl.codec().encode(i,n);if(t.prune!=null)for(const i of t.prune)n.uint32(34),gl.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={ihave:[],iwant:[],graft:[],prune:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.ihave!=null&&i.ihave.length===s.limits.ihave)throw new vt('Decode error - map field "ihave" had too many elements');i.ihave.push(fl.codec().decode(t,t.uint32(),{limits:s.limits?.ihave$}));break}case 2:{if(s.limits?.iwant!=null&&i.iwant.length===s.limits.iwant)throw new vt('Decode error - map field "iwant" had too many elements');i.iwant.push(hl.codec().decode(t,t.uint32(),{limits:s.limits?.iwant$}));break}case 3:{if(s.limits?.graft!=null&&i.graft.length===s.limits.graft)throw new vt('Decode error - map field "graft" had too many elements');i.graft.push(pl.codec().decode(t,t.uint32(),{limits:s.limits?.graft$}));break}case 4:{if(s.limits?.prune!=null&&i.prune.length===s.limits.prune)throw new vt('Decode error - map field "prune" had too many elements');i.prune.push(gl.codec().decode(t,t.uint32(),{limits:s.limits?.prune$}));break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(dl||(dl={}));var fl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),t.messageIDs!=null)for(const i of t.messageIDs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={messageIDs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.topic=t.string();break}case 2:{if(s.limits?.messageIDs!=null&&i.messageIDs.length===s.limits.messageIDs)throw new vt('Decode error - map field "messageIDs" had too many elements');i.messageIDs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(fl||(fl={}));var hl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.messageIDs!=null)for(const i of t.messageIDs)n.uint32(10),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={messageIDs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.messageIDs!=null&&i.messageIDs.length===s.limits.messageIDs)throw new vt('Decode error - map field "messageIDs" had too many elements');i.messageIDs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(hl||(hl={}));var pl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();l>>>3===1?i.topic=t.string():t.skipType(l&7)}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(pl||(pl={}));var gl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),t.peers!=null)for(const i of t.peers)n.uint32(18),ml.codec().encode(i,n);t.backoff!=null&&(n.uint32(24),n.uint64(t.backoff)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.topic=t.string();break}case 2:{if(s.limits?.peers!=null&&i.peers.length===s.limits.peers)throw new vt('Decode error - map field "peers" had too many elements');i.peers.push(ml.codec().decode(t,t.uint32(),{limits:s.limits?.peers$}));break}case 3:{i.backoff=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(gl||(gl={}));var ml;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.peerID!=null&&(n.uint32(10),n.bytes(t.peerID)),t.signedPeerRecord!=null&&(n.uint32(18),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerID=t.bytes();break}case 2:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ml||(ml={}));class hD extends Dt{peerId;shutDownController;inboundPb;outboundPb;constructor(e){super(),this.peerId=e,this.shutDownController=new AbortController}attachInboundStream(e,t){this.inboundPb=Fn(e,t).pb(xo),Promise.resolve().then(async()=>{for(;;){if(this.inboundPb==null)return;const n=await this.inboundPb.read({signal:this.shutDownController.signal});this.safeDispatchEvent("message",{detail:n})}}).catch(n=>{this.inboundPb?.unwrap().unwrap().abort(n)})}attachOutboundStream(e,t){this.outboundPb=Fn(e,t).pb(xo)}write(e){this.outboundPb!=null&&this.outboundPb.write(e,{signal:this.shutDownController.signal}).catch(t=>{this.outboundPb?.unwrap().unwrap().abort(t)})}close(){this.shutDownController.abort(),Promise.all([this.inboundPb?.unwrap().unwrap().close().catch(e=>{this.inboundPb?.unwrap().unwrap().abort(e)}),this.outboundPb?.unwrap().unwrap().close().catch(e=>{this.inboundPb?.unwrap().unwrap().abort(e)})]).finally(()=>{this.safeDispatchEvent("close")})}}const ew=Symbol.for("nodejs.util.inspect.custom"),pD=114;let bf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(pD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[ew](){return`PeerId(${this.toString()})`}},tw=class extends bf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},rw=class extends bf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},nw=class extends bf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const gD=2336;let mD=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[ew](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(gD,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function sw(r){if(r.type==="Ed25519")return new rw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new nw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new tw({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function yD(r){return sw(r.publicKey)}function iw(r){if(vD(r))return new tw({multihash:r});if(bD(r))try{const e=zn(r);if(e.type==="Ed25519")return new rw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new nw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new mD(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function bD(r){return r.code===it.code}function vD(r){return r.code===pr.code}function wD(){return BigInt(`0x${W(ai(8),"base16")}`)}const _D=(r,e)=>{const t=j(e.toString(16).padStart(16,"0"),"base16"),n=Sr(r),s=new Uint8Array(n.byteLength+t.length);return s.set(n,0),s.set(t,n.byteLength),s},SD=r=>pr.encode(r),ED=async r=>{if(r.sequenceNumber==null||r.from==null||r.signature==null)return!1;const e=iw(hn(r.from));if(e.publicKey!=null)return!0;if(r.key!=null){const t=r.key;return sw(Hn(t)).equals(e)}return!1},xD=async r=>{if(r.from==null)throw new $e("RPC message was missing from");if(!await ED(r))return{type:"unsigned",topic:r.topic??"",data:r.data??new Uint8Array(0)};const e=iw(hn(r.from)),t=r.key??e.publicKey;if(t==null)throw new $e("RPC message was missing public key");return{type:"signed",from:e,topic:r.topic??"",sequenceNumber:ID(r.sequenceNumber??new Uint8Array(0)),data:r.data??new Uint8Array(0),signature:r.signature??new Uint8Array(0),key:t instanceof Uint8Array?Hn(t):t}},vf=r=>r.type==="signed"?{from:r.from.toMultihash().bytes,data:r.data,sequenceNumber:AD(r.sequenceNumber),topic:r.topic,signature:r.signature,key:r.key?Sr(r.key):void 0}:{data:r.data,topic:r.topic},AD=r=>{let e=r.toString(16);return e.length%2!==0&&(e=`0${e}`),j(e,"base16")},ID=r=>BigInt(`0x${W(r,"base16")}`),ow=j("libp2p-pubsub:");async function kD(r,e,t){const n={type:"signed",topic:e.topic,data:e.data,sequenceNumber:e.sequenceNumber,from:yD(r)},s=an([ow,t(vf(n)).subarray()]);return n.signature=await r.sign(s),n.key=r.publicKey,n}async function CD(r,e){if(r.type!=="signed")throw new Error('Message type must be "signed" to be verified');if(r.signature==null)throw new Error("Message must contain a signature to be verified");if(r.from==null)throw new Error("Message must contain a from property to be verified");const t=an([ow,e({...vf(r),signature:void 0,key:void 0}).subarray()]);return TD(r).verify(t,r.signature)}function TD(r){if(r.type!=="signed")throw new Error('Message type must be "signed" to have a public key');if(r.from==null)throw new Error("Could not get the public key from the originator id");if(r.key!=null)return r.key;if(r.from.publicKey!=null)return r.from.publicKey;throw new Error("Could not get the public key from the originator id")}class PD extends Dt{log;started;topics;subscriptions;peers;globalSignaturePolicy;canRelayMessage;emitSelf;topicValidators;queue;protocol;components;_registrarTopologyId;maxInboundStreams;maxOutboundStreams;seenCache;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:floodsub"),this.components=e,this.protocol=t.protocol??DD,this.started=!1,this.topics=new Map,this.subscriptions=new Set,this.peers=new Is,this.globalSignaturePolicy=t.globalSignaturePolicy==="StrictNoSign"?"StrictNoSign":"StrictSign",this.canRelayMessage=t.canRelayMessage??!0,this.emitSelf=t.emitSelf??!1,this.topicValidators=new Map,this.queue=new Jv({concurrency:t.messageProcessingConcurrency??10}),this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.seenCache=new fD({validityMs:t?.seenTTL??3e4}),this._onIncomingStream=this._onIncomingStream.bind(this),this._onPeerConnected=this._onPeerConnected.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this)}[iD]=!0;[Symbol.toStringTag]="@libp2p/floodsub";[xr]=["@libp2p/pubsub"];[Va]=["@libp2p/identify"];async start(){this.started||(this.log("starting"),await this.components.registrar.handle(this.protocol,this._onIncomingStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this._registrarTopologyId=await this.components.registrar.register(this.protocol,{onConnect:this._onPeerConnected,onDisconnect:this._onPeerDisconnected}),this.log("started"),this.started=!0)}async stop(){if(!this.started)return;const e=this.components.registrar;this._registrarTopologyId!=null&&e.unregister(this._registrarTopologyId),await e.unhandle(this.protocol),this.log("stopping");for(const t of this.peers.values())t.close();this.peers.clear(),this.subscriptions=new Set,this.started=!1,this.log("stopped")}isStarted(){return this.started}_onIncomingStream(e,t){this.addPeer(t.remotePeer,e).attachInboundStream(e)}async _onPeerConnected(e,t){if(this.log("connected %p",e),t.streams.find(i=>i.direction==="outbound"&&i.protocol===this.protocol)){this.log("outbound pubsub stream already present on connection from %p",e);return}const n=await t.newStream(this.protocol);this.addPeer(e,n).attachOutboundStream(n),this.send(e,{subscriptions:Array.from(this.subscriptions).map(i=>i.toString()),subscribe:!0})}_onPeerDisconnected(e,t){this.log("connection ended %p",e),this._removePeer(e)}addPeer(e,t){const n=this.peers.get(e);if(n!=null)return n;this.log("new peer %p",e);const s=new hD(e);return this.peers.set(e,s),s.addEventListener("message",i=>{const o=i.detail,l=[];for(const c of o.messages??[]){if(c.from==null||c.data==null||c.topic==null){this.log("message from %p was missing from, data or topic fields, dropping",e);continue}l.push({from:c.from,data:c.data,topic:c.topic,sequenceNumber:c.sequenceNumber??void 0,signature:c.signature??void 0,key:c.key??void 0})}this.processRpc(s,{subscriptions:(o.subscriptions??[]).map(c=>({subscribe:!!c.subscribe,topic:c.topic??""})),messages:l}).catch(c=>{this.log(c)})}),s.addEventListener("close",()=>this._removePeer(e),{once:!0}),s}_removePeer(e){const t=this.peers.get(e);if(t!=null){t.close(),this.log("delete peer %p",e),this.peers.delete(e);for(const n of this.topics.values())n.delete(e)}}async processRpc(e,t){this.log("rpc from %p",e.peerId);const{subscriptions:n,messages:s}=t;return n!=null&&n.length>0&&(this.log("subscription update from %p",e.peerId),n.forEach(i=>{this.processRpcSubOpt(e.peerId,i)}),super.dispatchEvent(new CustomEvent("subscription-change",{detail:{peerId:e.peerId,subscriptions:n.map(({topic:i,subscribe:o})=>({topic:`${i??""}`,subscribe:!!o}))}}))),s!=null&&s.length>0&&(this.log("messages from %p",e.peerId),this.queue.addAll(s.map(i=>async()=>{if(i.topic==null||!this.subscriptions.has(i.topic)&&!this.canRelayMessage)return this.log("received message we didn't subscribe to. Dropping."),!1;try{const o=await xD(i);await this.processMessage(e.peerId,o)}catch(o){this.log.error("failed to queue messages from %p - %e",e.peerId,o)}})).catch(i=>{this.log(i)})),!0}processRpcSubOpt(e,t){const n=t.topic;if(n==null)return;let s=this.topics.get(n);s==null&&(s=new hs,this.topics.set(n,s)),t.subscribe===!0?s.add(e):s.delete(e)}async processMessage(e,t){if(this.components.peerId.equals(e)&&!this.emitSelf)return;const n=await this.getMsgId(t),s=W(n,"base64");if(!this.seenCache.has(s)){this.seenCache.put(s,!0);try{await this.validate(e,t)}catch(i){this.log("Message is invalid, dropping it. %O",i);return}this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.emitSelf)&&super.dispatchEvent(new CustomEvent("message",{detail:t})),await this.publishMessage(e,t)}}getMsgId(e){switch(this.globalSignaturePolicy){case"StrictSign":if(e.type!=="signed")throw new $e('Message type should be "signed" when signature policy is StrictSign but it was not');if(e.sequenceNumber==null)throw new $e("Need sequence number when signature policy is StrictSign but it was missing");if(e.key==null)throw new $e("Need key when signature policy is StrictSign but it was missing");return _D(e.key,e.sequenceNumber);case"StrictNoSign":return SD(e.data);default:throw new $e("Cannot get message id: unhandled signature policy")}}encodeMessage(e){return xo.Message.encode(e)}send(e,t){const{messages:n,subscriptions:s,subscribe:i}=t;this.sendRpc(e,{subscriptions:(s??[]).map(o=>({topic:o,subscribe:!!i})),messages:(n??[]).map(vf)})}sendRpc(e,t){const n=this.peers.get(e);if(n==null){this.log.error("cannot send RPC to %p as there are no streams to it available",e);return}n.write(t)}async validate(e,t){switch(this.globalSignaturePolicy){case"StrictNoSign":if(t.type!=="unsigned")throw new $e('Message type should be "unsigned" when signature policy is StrictNoSign but it was not');if(t.signature!=null)throw new $e("StrictNoSigning: signature should not be present");if(t.key!=null)throw new $e("StrictNoSigning: key should not be present");if(t.sequenceNumber!=null)throw new $e("StrictNoSigning: seqno should not be present");break;case"StrictSign":if(t.type!=="signed")throw new $e('Message type should be "signed" when signature policy is StrictSign but it was not');if(t.signature==null)throw new $e("StrictSigning: Signing required and no signature was present");if(t.sequenceNumber==null)throw new $e("StrictSigning: Signing required and no sequenceNumber was present");if(!await CD(t,this.encodeMessage.bind(this)))throw new $e("StrictSigning: Invalid message signature");break;default:throw new $e("Cannot validate message: unhandled signature policy")}const s=this.topicValidators.get(t.topic);if(s!=null){const i=await s(e,t);if(i===yl.Reject||i===yl.Ignore)throw new $e("Message validation failed")}}async buildMessage(e){switch(this.globalSignaturePolicy){case"StrictSign":return kD(this.components.privateKey,e,this.encodeMessage.bind(this));case"StrictNoSign":return Promise.resolve({type:"unsigned",...e});default:throw new $e("Cannot build message: unhandled signature policy")}}getSubscribers(e){if(!this.started)throw new fo("not started yet");if(e==null)throw new V("Topic is required");const t=this.topics.get(e.toString());return t==null?[]:Array.from(t.values())}async publish(e,t){if(!this.started)throw new Error("Pubsub has not started");const n={from:this.components.peerId,topic:e,data:t??new Uint8Array(0),sequenceNumber:wD()};this.log("publish topic: %s from: %p data: %m",e,n.from,n.data);const s=await this.buildMessage(n);let i=!1;this.emitSelf&&this.subscriptions.has(e)&&(i=!0,super.dispatchEvent(new CustomEvent("message",{detail:s})));const o=await this.publishMessage(this.components.peerId,s);return i&&(o.recipients=[...o.recipients,this.components.peerId]),o}async publishMessage(e,t){const n=this.getSubscribers(t.topic),s=[];return n==null||n.length===0?(this.log("no peers are subscribed to topic %s",t.topic),{recipients:s}):(n.forEach(i=>{if(this.components.peerId.equals(i)){this.log("not sending message on topic %s to myself",t.topic);return}if(i.equals(e)){this.log("not sending message on topic %s to sender %p",t.topic,i);return}this.log("publish msgs on topics %s %p",t.topic,i),s.push(i),this.send(i,{messages:[t]})}),{recipients:s})}subscribe(e){if(!this.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.log("subscribe to topic: %s",e),this.subscriptions.add(e);for(const t of this.peers.keys())this.send(t,{subscriptions:[e],subscribe:!0})}}unsubscribe(e){if(!this.started)throw new Error("Pubsub is not started");if(this.subscriptions.has(e)){this.log("unsubscribe from %s",e),this.subscriptions.delete(e);for(const t of this.peers.keys())this.send(t,{subscriptions:[e],subscribe:!1})}}getTopics(){if(!this.started)throw new Error("Pubsub is not started");return Array.from(this.subscriptions)}getPeers(){if(!this.started)throw new Error("Pubsub is not started");return Array.from(this.peers.keys())}}const DD="/floodsub/1.0.0";var yl;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(yl||(yl={}));function LD(r={}){return e=>new PD(e,r)}const ca=globalThis.CustomEvent??Event;async function*RD(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=lr(),l=lr(),c=!1,d,f=!1;s.addEventListener("task-complete",()=>{l.resolve()}),Promise.resolve().then(async()=>{try{for await(const p of r){if(i.length===t&&(o=lr(),await o.promise),f)break;const y={done:!1};i.push(y),p().then(g=>{y.done=!0,y.ok=!0,y.value=g,s.dispatchEvent(new ca("task-complete"))},g=>{y.done=!0,y.err=g,s.dispatchEvent(new ca("task-complete"))})}c=!0,s.dispatchEvent(new ca("task-complete"))}catch(p){d=p,s.dispatchEvent(new ca("task-complete"))}});function a(){return n?i[0]?.done:!!i.find(p=>p.done)}function*u(){for(;i.length>0&&i[0].done;){const p=i[0];if(i.shift(),p.ok)yield p.value;else throw f=!0,o.resolve(),p.err;o.resolve()}}function*h(){for(;a();)for(let p=0;p<i.length;p++)if(i[p].done){const y=i[p];if(i.splice(p,1),p--,y.ok)yield y.value;else throw f=!0,o.resolve(),y.err;o.resolve()}}for(;;){if(a()||(l=lr(),await l.promise),d!=null||(n?yield*u():yield*h(),d!=null))throw d;if(c&&i.length===0)break}}const BD="0.1.0",ND="id",MD="1.0.0",OD=1024*8;var bl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new vt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new vt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(bl||(bl={}));const aw=Symbol.for("nodejs.util.inspect.custom"),$D=114;let wf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1($D,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[aw](){return`PeerId(${this.toString()})`}},lw=class extends wf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},cw=class extends wf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},uw=class extends wf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const FD=2336;let dw=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[aw](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(FD,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const UD=114,kp=2336;function VD(r){if(r.type==="Ed25519")return new cw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new uw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new lw({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function KD(r){if(HD(r))return new lw({multihash:r});if(qD(r))try{const e=zn(r);if(e.type==="Ed25519")return new cw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new uw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new dw(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function fw(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==UD&&r.code!==kp)throw new $o("Supplied PeerID CID is invalid");if(r.code===kp){const e=W(r.multihash.digest);return new dw(new URL(e))}return KD(r.multihash)}function qD(r){return r.code===it.code}function HD(r){return r.code===pr.code}const Gr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:OD,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function zD(r){if(r!=null&&r.length>0)try{return he(r)}catch{}}async function WD(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new $e("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:he(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=Hn(s.publicKey);if(!VD(c).equals(n.remotePeer))throw new $e("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const d=await nn.openAndCertify(c,ur.DOMAIN);let f=ur.createFromProtobuf(d.payload);const a=fw(d.publicKey.toCID());if(!f.peerId.equals(a))throw new $e("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(f.peerId))throw new $e("signing key does not match remote PeerId");let u;try{u=await r.get(f.peerId)}catch(h){if(h.name!=="NotFoundError")throw h}if(u!=null&&(i.metadata=u.metadata,u.peerRecordEnvelope!=null)){const h=nn.createFromProtobuf(u.peerRecordEnvelope),p=ur.createFromProtobuf(h.payload);p.seqNumber>=f.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,f.seqNumber),f=p,c=u.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=f.multiaddrs.map(h=>({isCertified:!0,multiaddr:h})),o={seq:f.seqNumber,addresses:f.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=j(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=j(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const l={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>he(c)),observedAddr:s.observedAddr==null?void 0:he(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:l}),l}class GD{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??Gr.timeout,this.maxInboundStreams=t.maxInboundStreams??Gr.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Gr.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Gr.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Gr.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Gr.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Gr.protocolPrefix}/${BD}`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:j(this.host.agentVersion),ProtocolVersion:j(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}}class YD extends GD{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Gr.protocolPrefix}/${ND}/${MD}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Gr.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(()=>{})})}[xr]=["@libp2p/identify"];async _identify(e,t={}){let n,s;if(t.signal==null){const i=AbortSignal.timeout(this.timeout);t={...t,signal:i}}this.log("run identify on new connection %a",e.remoteAddr);try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),s=n.log.newScope("identify");const i=Fn(n,{maxDataLength:this.maxMessageSize}).pb(bl),o=await i.read(t);return await i.unwrap().unwrap().close(t),o}catch(i){throw s?.error("identify failed - %e",i),n?.abort(i),i}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new $e("Public key was missing from identify message");const l=Hn(s),c=fw(l.toCID());if(!e.remotePeer.equals(c))throw new $e("Identified peer does not match the expected peer");if(this.components.peerId.equals(c))throw new $e("Identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("completed for peer %p and protocols %o",c,i),WD(this.components.peerStore,this.components.events,this.log,e,n)}maybeAddObservedAddress(e){const t=zD(e);if(t==null||(this.log.trace("our observed address was %a",t),ui(t)))return;const n=t.getComponents();if((n[0].code===ws||n[0].code===zd&&n[1].code===ws)&&!hk(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}el.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t))}async handleProtocol(e,t){const n=e.log.newScope("identify");n("responding to identify");const s=AbortSignal.timeout(this.timeout),i=await this.components.peerStore.get(this.components.peerId,{signal:s}),o=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(ce));let l=i.peerRecordEnvelope;if(o.length>0&&l==null){const f=new ur({peerId:this.components.peerId,multiaddrs:o});l=(await nn.seal(f,this.components.privateKey,{signal:s})).marshal().subarray()}let c=t.remoteAddr.bytes;mT.matches(t.remoteAddr)||(c=void 0);const d=Fn(e).pb(bl);n("send response"),await d.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Sr(this.components.privateKey.publicKey),listenAddrs:o.map(f=>f.bytes),signedPeerRecord:l,observedAddr:c,protocols:i.protocols},{signal:s}),n("close write"),await d.unwrap().unwrap().close({signal:s})}}function XD(r={}){return e=>new YD(e,r)}const ZD=Symbol.for("nodejs.util.inspect.custom"),jD=114;let _f=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(jD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[ZD](){return`PeerId(${this.toString()})`}},QD=class extends _f{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},JD=class extends _f{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},eL=class extends _f{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function tL(r){if(r.type==="Ed25519")return new JD({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new eL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new QD({multihash:r.toCID().multihash,publicKey:r});throw new Ir}var Vu;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubkey!=null&&(n.uint32(18),vl.codec().encode(t.pubkey,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.id=t.bytes();break}case 2:{i.pubkey=vl.codec().decode(t,t.uint32(),{limits:s.limits?.pubkey});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Vu||(Vu={}));var Es;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Es||(Es={}));var Ku;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Ku||(Ku={}));(function(r){r.codec=()=>qo(Ku)})(Es||(Es={}));var vl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Es.codec().encode(t.Type,n)),t.Data!=null&&t.Data.byteLength>0&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={Data:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=Es.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(vl||(vl={}));const rL="/plaintext/2.0.0";class nL{protocol=rL;privateKey;log;constructor(e){this.privateKey=e.privateKey,this.log=e.logger.forComponent("libp2p:plaintext")}[Symbol.toStringTag]="@libp2p/plaintext";[xr]=["@libp2p/connection-encryption"];async secureInbound(e,t){return this._encrypt(e,t)}async secureOutbound(e,t){return this._encrypt(e,t)}async _encrypt(e,t){const n=e.log?.newScope("plaintext")??this.log,s=Fn(e).pb(Vu);n("write pubkey exchange to peer %p",t?.remotePeer);const i=this.privateKey.publicKey;await s.write({id:i.toMultihash().bytes,pubkey:{Type:Es[i.type],Data:i.raw}},t);const o=await s.read(t);let l;try{if(o.pubkey==null)throw new ac("Public key missing");if(o.pubkey.Data.byteLength===0)throw new ac("Public key data too short");if(o.id==null)throw new ac("Remote id missing");const c=FI(o.pubkey.Data);if(l=tL(c),!pe(l.toMultihash().bytes,o.id))throw new ph("Public key did not match id")}catch(c){throw n.error("invalid public key - %e",c),new ph(`Invalid public key - ${c.message}`)}if(t?.remotePeer!=null&&!l.equals(t?.remotePeer))throw new Jx;return n("plaintext key exchange completed successfully with peer %p",l),{connection:s.unwrap().unwrap(),remotePeer:l}}}function sL(){return r=>new nL(r)}const iL=Symbol.for("nodejs.util.inspect.custom"),oL=114;let Sf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(oL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[iL](){return`PeerId(${this.toString()})`}},aL=class extends Sf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},lL=class extends Sf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},cL=class extends Sf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function uL(r){if(r.type==="Ed25519")return new lL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new cL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new aL({multihash:r.toCID().multihash,publicKey:r});throw new Ir}var wl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new vt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(wl||(wl={}));const dL="_peer-discovery._p2p._pubsub";class fL extends Dt{[Fa]=!0;[Symbol.toStringTag]="@libp2p/pubsub-peer-discovery";interval;listenOnly;topics;intervalId;components;log;constructor(e,t={}){super();const{interval:n,topics:s,listenOnly:i}=t;this.components=e,this.interval=n??1e4,this.listenOnly=i??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(s)&&s.length>0?this.topics=s:this.topics=[dL],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.subscribe(t),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.unsubscribe(t),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const t={publicKey:Sr(e.publicKey),addrs:this.components.addressManager.getAddresses().map(i=>i.bytes)},n=wl.encode(t),s=this.components.pubsub;if(s==null)throw new Error("PubSub not configured");for(const i of this.topics){if(s.getSubscribers(i).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",i);continue}this.log("broadcasting our peer data on topic %s",i),s.publish(i,n)}}_onMessage(e){if(!this.isStarted())return;const t=e.detail;if(this.topics.includes(t.topic))try{const n=wl.decode(t.data),s=Hn(n.publicKey),i=uL(s);if(i.equals(this.components.peerId))return;this.log("discovered peer %p on %s",i,t.topic),this.safeDispatchEvent("peer",{detail:{id:i,multiaddrs:n.addrs.map(o=>he(o))}})}catch(n){this.log.error("error handling incoming message",n)}}}function hL(r={}){return e=>new fL(e,r)}const pL=[ds,Gd,Zd,Yd,Xd];function Cp(r){return hw("sni",r)?.value}function Tp(r){const e=hw("tcp",r)?.value;return e==null?"":`:${e}`}function hw(r,e){return e.find(t=>t.name===r)}function Pp(r){return r.some(({code:e})=>e===fs)}function yr(r,e){const t=pw[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===ws?`[${n}]`:n}const pw={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${yr(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${yr(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${yr(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${yr(t,e)}`},http:(r,e)=>{const t=Pp(e),n=Cp(e),s=Tp(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let l=yr(o,e);return l=l?.replace("tcp://",""),`${i}${l}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=yr(t,e),s=decodeURIComponent(r.value??"");return`${n}${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return yr(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return yr(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=yr(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=Pp(e),n=Cp(e),s=Tp(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let l=yr(o,e);return l=l?.replace("tcp://",""),`${i}${l}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=yr(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function gL(r,e){const n=he(r).getComponents(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=pw[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let o=i(s,n)??"";return pL.includes(s.code)&&(o=o.replace(/^.*:\/\//,""),s.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}function mL(){throw new Error("WebSocket Servers can not be created in the browser!")}const yL=1024*1024*4,bL=10;class vL extends eb{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??yL,this.checkBufferedAmountTask=fb(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??bL),this.websocket.addEventListener("close",t=>{if(this.log('closed - code %d, reason "%s", wasClean %s',t.code,t.reason,t.wasClean),this.checkBufferedAmountTask.stop(),!t.wasClean){this.onRemoteReset();return}this.onTransportClosed()},{once:!0}),this.websocket.addEventListener("message",t=>{try{let n;if(typeof t.data=="string")n=j(t.data);else if(t.data instanceof ArrayBuffer)n=new Uint8Array(t.data,0,t.data.byteLength);else{this.abort(new Error("Incorrect binary type"));return}this.onData(n)}catch(n){this.log.error("error receiving data - %e",n)}})}sendData(e){for(const n of e)this.websocket.send(n);const t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),this.websocket.bufferedAmount===0&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}}function wL(r){return new vL(r)}class _L{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Um]=!0;[Symbol.toStringTag]="@libp2p/websockets";[xr]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=wL({websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval});this.log("new outbound connection %s",n.remoteAddr);const s=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),s}async _connect(e,t){t?.signal?.throwIfAborted();const n=gL(e);this.log("create websocket connection to %s",n);const s=new WebSocket(n);s.binaryType="arraybuffer";try{t.onProgress?.(new nt("websockets:open-connection")),await fr(s,"open",t)}catch(i){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new eA(`Could not connect to ${n}`);this.metrics?.dialerEvents.increment({error:!0});try{s.close()}catch{}throw i}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),s}createListener(e){return mL({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e.filter(t=>So.exactMatch(t)||tl.exactMatch(t))}dialFilter(e){return this.listenFilter(e)}}function SL(r={}){return e=>new _L(e,r)}const gw=Symbol.for("nodejs.util.inspect.custom"),EL=114;let Ef=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(EL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[gw](){return`PeerId(${this.toString()})`}},mw=class extends Ef{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},yw=class extends Ef{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},bw=class extends Ef{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const xL=2336;let vw=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[gw](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(xL,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const AL=114,Dp=2336;function mi(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=hn(De.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return CL(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return ww(t)}function IL(r){if(r.type==="Ed25519")return new yw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new bw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new mw({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function kL(r){return IL(r.publicKey)}function ww(r){if(PL(r))return new mw({multihash:r});if(TL(r))try{const e=zn(r);if(e.type==="Ed25519")return new yw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new bw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new vw(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function CL(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==AL&&r.code!==Dp)throw new $o("Supplied PeerID CID is invalid");if(r.code===Dp){const e=W(r.multihash.digest);return new vw(new URL(e))}return ww(r.multihash)}function TL(r){return r.code===it.code}function PL(r){return r.code===pr.code}var DL={};async function LL(r){if(r.connectionProtector===null&&DL?.LIBP2P_FORCE_PNET!=null)throw new V("Private network is enforced, but no protector was provided");return r}const _w=Symbol.for("nodejs.util.inspect.custom"),RL=114;class xf{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=De.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(RL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[_w](){return`PeerId(${this.toString()})`}}class Sw extends xf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class Ew extends xf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class xw extends xf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const BL=2336;class Aw{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[_w](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(BL,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}}const NL=114,Lp=2336;function ML(r){if(r.type==="Ed25519")return new Ew({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new xw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new Sw({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function OL(r){if(FL(r))return new Sw({multihash:r});if($L(r))try{const e=zn(r);if(e.type==="Ed25519")return new Ew({multihash:r,publicKey:e});if(e.type==="secp256k1")return new xw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new Aw(new URL(t))}throw new Kn("Supplied PeerID Multihash is invalid")}function Iw(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==NL&&r.code!==Lp)throw new $o("Supplied PeerID CID is invalid");if(r.code===Lp){const e=W(r.multihash.digest);return new Aw(new URL(e))}return OL(r.multihash)}function $L(r){return r.code===it.code}function FL(r){return r.code===pr.code}let yi=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Cc(r,e,t,n){const s=new yi(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((o,l)=>{function c(){Pc(t,"abort",a),Pc(r,e,d),Pc(r,i,f)}const d=u=>{try{if(n?.filter?.(u)===!1)return}catch(h){c(),l(h);return}c(),o(u)},f=u=>{if(c(),u instanceof Error){l(u);return}l(u.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},a=()=>{c(),l(s)};Tc(t,"abort",a),Tc(r,e,d),Tc(r,i,f)})}function Tc(r,e,t){r!=null&&(kw(r)?r.addEventListener(e,t):r.addListener(e,t))}function Pc(r,e,t){r!=null&&(kw(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function kw(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}class UL extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class VL{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new yi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function KL(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class qL{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=KL(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new yi),this.cleanup())}async join(e={}){const t=new VL(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Tt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function Rp(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Bp extends Dt{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=Rp(this.emitEmpty.bind(this),1),this.emitIdle=Rp(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new UL;const n=new qL(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new yi)}),this.clear()}async onEmpty(e){this.size!==0&&await Cc(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Cc(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Cc(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ud({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},l=()=>{n(new yi("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",l),n()}}}const Cw="lock:worker:request-read",Tw="lock:worker:abort-read-request",Pw="lock:worker:release-read",Dw="lock:master:grant-read",Lw="lock:master:error-read",Rw="lock:worker:request-write",Bw="lock:worker:abort-write-request",Nw="lock:worker:release-write",Mw="lock:master:grant-write",Ow="lock:master:error-write",$w="lock:worker:finalize",Fw="mortice",HL={singleProcess:!1},Np=(r,e,t,n,s,i,o,l,c)=>d=>{if(d.data==null)return;const f={type:d.data.type,name:d.data.name,identifier:d.data.identifier};f.type===s&&r.safeDispatchEvent(t,{detail:{name:f.name,identifier:f.identifier,handler:async()=>{e.postMessage({type:c,name:f.name,identifier:f.identifier}),await new Promise(a=>{const u=h=>{if(h?.data==null)return;const p={type:h.data.type,name:h.data.name,identifier:h.data.identifier};p.type===l&&p.identifier===f.identifier&&(e.removeEventListener("message",u),a())};e.addEventListener("message",u)})},onError:a=>{e.postMessage({type:o,name:f.name,identifier:f.identifier,error:{message:a.message,name:a.name,stack:a.stack}})}}}),f.type===i&&r.safeDispatchEvent(n,{detail:{name:f.name,identifier:f.identifier}}),f.type===$w&&r.safeDispatchEvent("finalizeRequest",{detail:{name:f.name}})},zL=(r=10)=>Math.random().toString().substring(2,r+2);class WL{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(Fw)}readLock(e){return this.sendRequest(Cw,Tw,Dw,Lw,Pw,e)}writeLock(e){return this.sendRequest(Rw,Bw,Mw,Ow,Nw,e)}finalize(){this.channel.postMessage({type:$w,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const l=zL();return this.channel.postMessage({type:e,identifier:l,name:this.name}),new Promise((c,d)=>{const f=()=>{this.channel.postMessage({type:t,identifier:l,name:this.name})};o?.signal?.addEventListener("abort",f,{once:!0});const a=u=>{if(u.data?.identifier===l&&(u.data?.type===n&&(this.channel.removeEventListener("message",a),o?.signal?.removeEventListener("abort",f),c(()=>{this.channel.postMessage({type:i,identifier:l,name:this.name})})),u.data.type===s)){this.channel.removeEventListener("message",a),o?.signal?.removeEventListener("abort",f);const h=new Error;u.data.error!=null&&(h.message=u.data.error.message,h.name=u.data.error.name,h.stack=u.data.error.stack),d(h)}};this.channel.addEventListener("message",a)})}}const GL=r=>{if(r=Object.assign({},HL,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(Fw),n=new Dt;return t.addEventListener("message",Np(n,t,"requestReadLock","abortReadLockRequest",Cw,Tw,Lw,Pw,Dw)),t.addEventListener("message",Np(n,t,"requestWriteLock","abortWriteLockRequest",Rw,Bw,Ow,Nw,Mw)),n}return new WL(r.name)},ns=new Map;let Oi;function Uw(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function YL(r){if(Oi==null&&(Oi=GL(r),!Uw(Oi))){const e=Oi;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=ns.get(n);if(i==null)return;const o=new AbortController,l=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",l),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",l)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=ns.get(n);if(i==null)return;const o=new AbortController,l=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",l),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",l)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=ns.get(n);s?.finalize()})}return Oi}async function Dc(r,e){let t,n;const s=new Promise((o,l)=>{t=o,n=l}),i=()=>{n(new yi)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const XL=(r,e)=>{let t=ns.get(r);if(t!=null)return t;const n=YL(e);if(Uw(n))return t=n,ns.set(r,t),t;const s=new Bp({concurrency:1});let i;return t={async readLock(o){if(i!=null)return Dc(i,o);i=new Bp({concurrency:e.concurrency,autoStart:!1});const l=i,c=Dc(i,o);return s.add(async()=>{l.start(),await l.onIdle().then(()=>{i===l&&(i=null)})}),c},async writeLock(o){return i=null,Dc(s,o)},finalize:()=>{ns.delete(r)},queue:s},ns.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},ZL={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function jL(r){const e=Object.assign({},ZL,r);return XL(e.name,e)}const QL=36e5,JL=216e5;var ss;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={key:"",value:Ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Sl.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.key=s.string();break}case 2:{l.value=Sl.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),_l.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new vt('Decode error - map field "addresses" had too many elements');i.addresses.push(_l.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new vt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Nh('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Nh('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ss||(ss={}));var _l;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(_l||(_l={}));var Sl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Sl||(Sl={}));function eR(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=Hn(e.publicKey,t);return ML(n)}function tR(r,e,t){const n=ss.decode(e);return zi(r,n,t)}function zi(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:eR(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:he(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function rR(r,e){return nR(r.addresses,e.addresses)&&sR(r.protocols,e.protocols)&&iR(r.publicKey,e.publicKey)&&oR(r.peerRecordEnvelope,e.peerRecordEnvelope)&&aR(r.metadata,e.metadata)&&lR(r.tags,e.tags)}function nR(r,e){return Kw(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!pe(t.multiaddr,n.multiaddr)))}function sR(r,e){return Kw(r,e,(t,n)=>t===n)}function iR(r,e){return Vw(r,e)}function oR(r,e){return Vw(r,e)}function aR(r,e){return qw(r,e,(t,n)=>pe(t,n))}function lR(r,e){return qw(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function Vw(r,e){return r==null&&e==null?!0:r!=null&&e!=null?pe(r,e):!1}function Kw(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function qw(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const Hw="/peers/";function ua(r){if(!Yi(r)||r.type==null)throw new V("Invalid PeerId");const e=r.toCID().toString();return new je(`${Hw}${e}`)}async function cR(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=he(o.multiaddr)),!Hl(o.multiaddr))throw new V("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const l=o.isCertified??!1,c=o.multiaddr.toString(),d=i.get(c);d!=null?o.isCertified=d.isCertified||l:i.set(c,{multiaddr:o.multiaddr,isCertified:l})}return[...i.values()].sort((o,l)=>o.multiaddr.toString().localeCompare(l.multiaddr.toString())).map(({isCertified:o,multiaddr:l})=>{const c=l.getComponents().find(d=>d.code===ce)?.value;return r.equals(c)&&(l=l.decapsulate(he(`/p2p/${r}`))),{isCertified:o,multiaddr:l.bytes}})}async function Lc(r,e,t,n){if(e==null)throw new V("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new V("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new V("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),l=s?.metadata??new Map,c=s?.tags??new Map,d=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(u=>({isCertified:!1,multiaddr:u}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const u=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);l=da(u,{validate:Mp})}if(e.tags!=null){const u=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=da(u,{validate:Op,map:$p})}e.peerRecordEnvelope!=null&&(d=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(u=>({isCertified:!1,multiaddr:u}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const u=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[h,p]of u)p==null?l.delete(h):l.set(h,p);l=da([...l.entries()],{validate:Mp})}if(e.tags!=null){const u=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(const[p,y]of u)y==null?h.delete(p):h.set(p,y);c=da([...h.entries()],{validate:Op,map:$p})}e.peerRecordEnvelope!=null&&(d=e.peerRecordEnvelope)}let f;s?.id.publicKey!=null?f=Sr(s.id.publicKey):e.publicKey!=null?f=Sr(e.publicKey):r.publicKey!=null&&(f=Sr(r.publicKey));const a={addresses:await cR(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((u,h)=>u.localeCompare(h)),metadata:l,tags:c,publicKey:f,peerRecordEnvelope:d};return a.addresses.forEach(u=>{u.observed=n.existingPeer?.peerPB.addresses?.find(h=>pe(h.multiaddr,h.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete a.publicKey,a}function da(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function Mp(r,e){if(typeof r!="string")throw new V("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new V("Metadata value must be a Uint8Array")}function Op(r,e){if(typeof r!="string")throw new V("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new V("Tag value must be an integer");if(e.value<0||e.value>100)throw new V("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new V("Tag ttl must be an integer");if(e.ttl<0)throw new V("Tag ttl must be between greater than 0")}}function $p(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function zw(r){const e=r.toString().split("/")[2],t=ue.parse(e,Rn);return Iw(t)}function Rc(r,e,t){const n=zw(r);return tR(n,e,t)}function uR(r,e){return{prefix:Hw,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(Rc(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(Rc(n.key,n.value,e),Rc(s.key,s.value,e)))}}class dR{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=mP({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??QL,this.maxPeerAge=t.maxPeerAge??JL}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:jL({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(ua(e),t)}async load(e,t){const n=ua(e),s=await this.datastore.get(n,t),i=ss.decode(s);if(this.#t(e,i))throw await this.datastore.delete(n,t),new $a;return zi(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await Lc(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#r(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await Lc(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#r(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await Lc(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#r(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(uR(e??{},this.maxAddressAge),e)){const s=zw(t);if(s.equals(this.peerId))continue;const i=ss.decode(n);if(this.#t(s,i)){await this.datastore.delete(t,e);continue}yield zi(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=ua(e),s=await this.datastore.get(n,t),i=ss.decode(s);if(this.#t(e,i))throw await this.datastore.delete(n,t),new $a;return{peerPB:i,peer:zi(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#r(e,t,n,s){t.updated=Date.now();const i=ss.encode(t);return await this.datastore.put(ua(e),i,s),{peer:zi(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!rR(t,n.peerPB)}}#t(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class fR{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new dR(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return au(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=Yi(t)?t:Yi(t?.expectedPeer)?t.expectedPeer:void 0,i=Yi(t)||t===void 0?n:t,o=await nn.openAndCertify(e,ur.DOMAIN,i),l=Iw(o.publicKey.toCID());if(s?.equals(l)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,l),!1;const c=ur.createFromProtobuf(o.payload);let d;try{d=await this.get(l,i)}catch(f){if(f.name!=="NotFoundError")throw f}if(d?.peerRecordEnvelope!=null){const f=nn.createFromProtobuf(d.peerRecordEnvelope),a=ur.createFromProtobuf(f.payload);if(a.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(f=>({isCertified:!0,multiaddr:f}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function hR(r,e={}){return new fR(r,e)}const Fp=864e13;class pR{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=un({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=qe(e);let n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(const s of this.mappings.values())if(s.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=Hd(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?Fp-Date.now():0,lastVerified:s?Fp-Date.now():void 0})})}remove(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",s,i.domain),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const s=e[n].multiaddr;if(!Er(s))continue;const i=qe(s);for(const[o,l]of this.mappings.entries()){if(i.host!==o)continue;const c=this.maybeAddSNIComponent(s,l.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:l.verified,type:"dns-mapping",expires:l.expires,lastVerified:l.lastVerified}))}}return t}maybeAddSNIComponent(e,t){const n=e.getComponents();for(let s=0;s<n.length;s++)if(n[s].code===fs&&n[s+1]?.code!==Ja)return n.splice(s+1,0,{name:"sni",code:Ja,value:t}),he(n)}confirm(e,t){const n=qe(e);let s=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(s=n.sni);let i=!1;for(const[o,l]of this.mappings.entries())l.domain===s&&(this.log("marking %s to %s DNS mapping as verified",o,l.domain),i=l.verified,l.verified=!0,l.expires=Date.now()+t,l.lastVerified=Date.now());return i}unconfirm(e,t){const n=qe(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;const s=n.sni??n.host;let i=!1;for(const[o,l]of this.mappings.entries())l.domain===s&&(this.log("removing verification of %s to %s DNS mapping",o,l.domain),i=i||l.verified,l.verified=!1,l.expires=Date.now()+t);return i}}class gR{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=un({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t.host)return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,l=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:ci(n)?4:6,protocol:i,verified:!1,expires:0};l.push(c),this.mappings.set(o,l)}remove(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[s,i]of this.mappings.entries()){for(let o=0;o<i.length;o++){const l=i[o];l.externalIp===t.host&&l.externalPort===t.port&&l.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,t.host,t.port,t.protocol),n=n||l.verified,i.splice(o,1),o--)}i.length===0&&this.mappings.delete(s)}return n}getAll(e){const t=[];for(const{multiaddr:n}of e){if(!Er(n))continue;const s=qe(n);if(s.type!=="ip4"&&s.type!=="ip6")continue;let i;if(s.protocol==="tcp"?i=`${s.host}-${s.port}-tcp`:s.protocol==="udp"&&(i=`${s.host}-${s.port}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const l of o)t.push({multiaddr:this.maybeOverrideIp(n,l.externalIp,l.externalFamily,l.protocol,l.externalPort),verified:l.verified,type:"ip-mapping",expires:l.expires,lastVerified:l.lastVerified})}return t}maybeOverrideIp(e,t,n,s,i){const o=e.getComponents(),l=o.findIndex(d=>d.code===Qa||d.code===ws),c=o.findIndex(d=>d.name===s);return l>-1&&c>-1?(o[l].value=t,o[l].code=n===4?Qa:ws,o[c].value=`${i}`,he(o)):e}confirm(e,t){if(!Er(e))return!1;const n=qe(e);let s=!1;for(const i of this.mappings.values())for(const o of i)o.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",o.internalIp,o.externalIp),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){if(!Er(e))return!1;const n=qe(e);let s=!1;for(const i of this.mappings.values())for(let o=0;o<i.length;o++){const l=i[o];l.externalIp===n.host&&l.externalPort===n.port&&l.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,n.host,n.port,n.protocol),s=s||l.verified,l.verified=!1,l.expires=Date.now()+t)}return s}}const mR={maxObservedAddresses:10};class yR{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=un({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??mR.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(ui(e)||pk(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:he(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const bR={maxObservedAddresses:10};class vR{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=un({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??bR.maxObservedAddresses}get(e,t){if(ui(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!Er(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(!Er(e))return e.toString();const t=qe(e);return`${t.host}-${t.port}-${t.protocol}`}}const Up=6e4,Vp={addressVerificationTTL:Up*10,addressVerificationRetry:Up*5},wR=r=>r;function Bc(r,e){const t=r.getComponents().findLast(n=>n.code===ce)?.value;return t!=null&&mi(t).equals(e)&&(r=r.decapsulate(he(`/p2p/${e.toString()}`))),r}class _R{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new yR(e,t),this.dnsMappings=new pR(e,t),this.ipMappings=new gR(e,t),this.transportAddresses=new vR(e,t),this.announceFilter=t.announceFilter??wR,this.observedAddressFilter=yo(1024),this.addressVerificationTTL=t.addressVerificationTTL??Vp.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??Vp.addressVerificationRetry,this._updatePeerStoreAddresses=Za(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===ce)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>he(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>he(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>he(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=qe(e);let n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=Bc(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Bc(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Bc(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=he(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(he(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${ci(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(he(`/ip${ci(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!Er(e))return!1;const t=qe(e);if(t.type!=="ip4"||Hd(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>So.exactMatch(i)||tl.exactMatch(i),i=>el.exactMatch(i),i=>bT.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(d=>d.getAddrs().filter(f=>qe(f).type==="ip4"&&i(f)).length>0);if(o.length!==1)continue;const l=o[0].getAddrs().filter(d=>!Du(d)).pop();if(l==null)continue;const c=qe(l);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}}var Kp;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(Kp||(Kp={}));class SR extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class ER extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Nc extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class qp extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class xR extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class AR extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class IR extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class Hp extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class kR extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class CR extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class TR extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class PR extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class DR extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class _a extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class fa extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class LR extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class RR extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class BR{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=dd())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>yd(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const NR=["metrics","connectionProtector","dns"],MR=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function OR(r={}){const e=new BR(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!MR.includes(s)){const o=e.components[s];if(o==null&&!NR.includes(s))throw new SR(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function $R(r){const e={};for(const t of Object.values(r.components))for(const n of FR(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of UR(t))if(e[n]!==!0)throw new ER(`Service "${VR(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function FR(r){return Array.isArray(r?.[xr])?r[xr]:[]}function UR(r){return Array.isArray(r?.[Va])?r[Va]:[]}function VR(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function KR(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>So.matches(e)?!0:ui(e)),r}function Ww(r){if(Yi(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getComponents().findLast(s=>s.code===ce)?.value;t=n==null?void 0:mi(n),e.forEach(s=>{if(!Hl(s))throw new gd("Invalid multiaddr");const i=s.getComponents().findLast(o=>o.code===ce)?.value;if(i==null){if(t!=null)throw new V("Multiaddrs must all have the same peer id or have no peer id")}else{const o=mi(i);if(t?.equals(o)!==!0)throw new V("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!gT.exactMatch(n)),{peerId:t,multiaddrs:e}}const qR=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function HR(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??qR;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function qu(r){const e=qe(r);let t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new V(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new V(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new Zy(e.host,t)}function Gw(r){return!di.exactMatch(r)}function Yw(r,e,t){if(r==null||e==null)return;const n=e.sort((i,o)=>i.direct?-1:o.direct?1:0).find(i=>i.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(i=>Gw(i)))return n}class zR{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>qu(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new Is;for(const c of e){const d=c.remotePeer;if(!s.has(d)){s.set(d,0);try{const f=await this.peerStore.get(d);s.set(d,[...f.tags.values()].reduce((a,u)=>a+u.value,0))}catch(f){f.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",f)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),l=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(f=>{if(Er(c.remoteAddr)){const a=qe(c.remoteAddr);return f.contains(a.host)}return!0})||l.push(c),l.length===o)break;await Promise.all(l.map(async c=>{await HR(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:l})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const Xw=1e4,Zw=1e3,WR=1e4,El=1e4,jw=25,GR=5,YR=10,XR=5,ZR="last-dial-failure",jR="last-dial-success",Qw=500,QR=32,JR=100,Jw=50;function eB(r,e){const t=el.exactMatch(r.multiaddr),n=el.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=tl.exactMatch(r.multiaddr),i=tl.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=So.exactMatch(r.multiaddr),l=So.exactMatch(e.multiaddr);if(o&&!l)return-1;if(!o&&l)return 1;const c=rp.exactMatch(r.multiaddr),d=rp.exactMatch(e.multiaddr);if(c&&!d)return-1;if(!c&&d)return 1;const f=ep.exactMatch(r.multiaddr),a=ep.exactMatch(e.multiaddr);if(f&&!a)return-1;if(!f&&a)return 1;const u=tp.exactMatch(r.multiaddr),h=tp.exactMatch(e.multiaddr);return u&&!h?-1:!u&&h?1:0}function tB(r,e){const t=Du(r.multiaddr),n=Du(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function rB(r,e){const t=ui(r.multiaddr),n=ui(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function nB(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function sB(r,e){const t=di.exactMatch(r.multiaddr),n=di.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function iB(r){return r.sort(eB).sort(nB).sort(sB).sort(rB).sort(tB)}class oB extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"}function e0(r){const e=[Un.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const t0=60;function r0(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Un[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Un[e.type],TTL:e.TTL??e.ttl??t0,data:e.data instanceof Uint8Array?W(e.data):e.data}))}}const aB=4;function zp(r,e={}){const t=new Jv({concurrency:e.queryConcurrency??aB});return async(n,s={})=>{const i=new URLSearchParams;i.set("name",n),e0(s.types).forEach(l=>{i.append("type",Un[l])}),s.onProgress?.(new nt("dns:query",n));const o=await t.add(async()=>{const l=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(l.status!==200)throw new Error(`Unexpected HTTP status: ${l.status} - ${l.statusText}`);const c=r0(await l.json());return s.onProgress?.(new nt("dns:response",c)),c},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function lB(){return[zp("https://cloudflare-dns.com/dns-query"),zp("https://dns.google/resolve")]}var Mc,Wp;function cB(){return Wp||(Wp=1,Mc=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}),Mc}var uB=cB();const dB=cd(uB);class fB{lru;constructor(e){this.lru=dB(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return r0({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:l})=>({...l,TTL:Math.round((o-Date.now())/1e3),type:Un[l.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??t0)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function hB(r){return new fB(r)}const pB=1e3;class gB{resolvers;cache;constructor(e){this.resolvers={},this.cache=hB(e.cacheSize??pB),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=lB())}async query(e,t={}){const n=e0(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new nt("dns:cache",s)),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),l=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const d=await c(e,{...t,types:n});for(const f of d.Answer)this.cache.add(e,f);return d}catch(d){l.push(d),t.onProgress?.(new nt("dns:error",d))}}throw new oB(l,`DNS lookup of ${e} ${n} failed`)}}var Un;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Un||(Un={}));function mB(r={}){return new gB(r)}class yB{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Un.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,l=[];for(const c of i.Answer){const d=c.data.replace(/["']/g,"").trim().split("=")[1];d!=null&&(o!=null&&!d.includes(o)||l.push(he(d)))}return l}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=mB()),this.dns)}}const n0=new yB;async function s0(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??QR))throw new RR("Max recursive depth reached");let s=!1;const i=[];for(const o of Object.values(e))if(o.canResolve(r)){s=!0;const l=await o.resolve(r,t);for(const c of l)i.push(...await s0(c,e,{...t,depth:n+1}))}return s===!1&&i.push(r),i}const $i={maxParallelDials:Jw,maxDialQueueLength:Qw,maxPeerAddrsToDial:jw,dialTimeout:Xw,resolvers:{dnsaddr:n0}};class bB{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??$i.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??$i.maxDialQueueLength,this.dialTimeout=t.dialTimeout??$i.dialTimeout,this.connections=t.connections??new Is,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??$i.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new FC({concurrency:t.maxParallelDials??$i.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==uo.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=Ww(e);if(n!=null&&t.force!==!0){const o=Yw(n,this.connections.get(n),s);if(o!=null)return this.log("already connected to %a",o.remoteAddr),t.onProgress?.(new nt("dial-queue:already-connected")),o}const i=this.queue.queue.find(o=>{if(n?.equals(o.options.peerId)===!0)return!0;const l=o.options.multiaddrs;if(l==null)return!1;for(const c of s)if(l.has(c.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(const o of s)i.options.multiaddrs.add(o.toString());return t.onProgress?.(new nt("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ya("Dial queue is full");return this.log("creating dial target for %p",n,s.map(o=>o.toString())),t.onProgress?.(new nt("dial-queue:add-to-dial-queue")),this.queue.add(async o=>{o.onProgress?.(new nt("dial-queue:start-dial"));const l=vs([this.shutDownController.signal,o.signal]);try{return await this.dialPeer(o,l)}finally{l.clear()}},{peerId:n,priority:t.priority??i0,multiaddrs:new Set(s.map(o=>o.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,l=0,c=0;const d=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const f=[],a=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...a]);const u=await this.calculateMultiaddrs(n,a,{...e,signal:t});for(const h of u){if(i.has(h.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",h.multiaddr,n);continue}f.push(h)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,f.map(h=>h.multiaddr.toString())),e?.onProgress?.(new nt("dial-queue:calculated-addresses",f));for(const h of f){if(l===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",l,e.peerId),new ya("Peer had more than maxPeerAddrsToDial");l++;try{const p=await this.components.transportManager.dial(h.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",h.multiaddr);try{await this.components.peerStore.merge(p.remotePeer,{multiaddrs:[p.remoteAddr],metadata:{[jR]:j(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}return p}catch(p){if(this.log.error("dial failed to %a - %e",h.multiaddr,p),i.add(h.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[ZR]:j(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}if(t.aborted)throw new nA(p.message);d.push(p)}}}throw d.length===1?d[0]:new AggregateError(d,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(a=>({multiaddr:he(a),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ya("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Hp("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const a=await this.components.peerStore.get(e);s.push(...a.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:u})=>u.toString()))}catch(a){if(a.name!=="NotFoundError")throw a}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const a=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:u})=>u.toString())),s.push(...a.multiaddrs.map(u=>({multiaddr:u,isCertified:!1})))}catch(a){a.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,a)}}}let i=(await Promise.all(s.map(async a=>{const u=await s0(a.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return u.length===1&&u[0].equals(a.multiaddr)?a:u.map(h=>({multiaddr:h,isCertified:!1}))}))).flat();if(e!=null){const a=`/p2p/${e.toString()}`;i=i.map(u=>u.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:u.multiaddr.encapsulate(a),isCertified:u.isCertified}:u)}const o=i.filter(a=>{if(this.components.transportManager.dialTransportForMultiaddr(a.multiaddr)==null)return!1;const u=a.multiaddr.getComponents().findLast(h=>h.code===ce)?.value;return e!=null&&u!=null?e.equals(u):!0}),l=new Map;for(const a of o){const u=a.multiaddr.toString(),h=l.get(u);if(h!=null){h.isCertified=h.isCertified||a.isCertified||!1;continue}l.set(u,a)}const c=[...l.values()];if(c.length===0)throw new TR("The dial request has no valid addresses");const d=[];for(const a of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(a.multiaddr)||d.push(a);const f=this.addressSorter==null?iB(d):d.sort(this.addressSorter);if(f.length===0)throw new Hp("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:a})=>a.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",f.map(({multiaddr:a})=>a.toString())),f}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!di.matches(s.multiaddr))!=null:!0}catch{}return!1}}const vB=Object.prototype.toString,wB=r=>vB.call(r)==="[object Error]",_B=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function SB(r){if(!(r&&wB(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:_B.has(t)}function EB(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function ha(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be â‰¥ ${t}.`)}}class xB extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function AB(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function Gp(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function IB({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){const i=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(i instanceof xB)throw i.originalError;const o=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,l=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:i,attemptNumber:e,retriesLeft:o,retriesConsumed:t});if(await s.onFailedAttempt(c),Gp(n,l)<=0)throw i;const d=await s.shouldConsumeRetry(c),f=Gp(n,l);if(f<=0||o<=0)throw i;if(i instanceof TypeError&&!SB(i)){if(d)throw i;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw i;if(!d)return s.signal?.throwIfAborted(),!1;const a=AB(t,s),u=Math.min(a,f);return s.signal?.throwIfAborted(),u>0&&await new Promise((h,p)=>{const y=()=>{clearTimeout(g),s.signal?.removeEventListener("abort",y),p(s.signal.reason)},g=setTimeout(()=>{s.signal?.removeEventListener("abort",y),h()},u);s.unref&&g.unref?.(),s.signal?.addEventListener("abort",y,{once:!0})}),s.signal?.throwIfAborted(),!0}async function kB(r,e={}){if(e={...e},EB(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,ha("factor",e.factor,{min:0,allowInfinity:!1}),ha("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),ha("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),ha("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0;const s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();const i=await r(t);return e.signal?.throwIfAborted(),i}catch(i){await IB({error:i,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}class CB{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Jd({concurrency:t.maxParallelReconnects??XR,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Yp(t)&&(this.queue.has(e)||this.queue.add(async n=>{await kB(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(md)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>Yp(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}}function Yp(r){for(const e of r.tags.keys())if(e.startsWith(md))return!0;return!1}const i0=50,Oc={maxConnections:JR,inboundConnectionThreshold:GR,maxIncomingPendingConnections:YR};class TB{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??Oc.maxConnections,this.maxConnections<1)throw new V("Connection Manager maxConnections must be greater than 0");this.connections=new Is,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>qu(he(n))),this.deny=(t.deny??[]).map(n=>qu(he(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Oc.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new UC({points:t.inboundConnectionThreshold??Oc.inboundConnectionThreshold,duration:1}),this.connectionPruner=new zR({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>he(n))}),this.dialQueue=new bB(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??Jw,maxDialQueueLength:t.maxDialQueueLength??Qw,maxPeerAddrsToDial:t.maxPeerAddrsToDial??jw,dialTimeout:t.dialTimeout??Xw,resolvers:t.resolvers??{dnsaddr:n0},connections:this.connections}),this.reconnectQueue=new CB({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const l=`${o.direction} ${o.protocol??"unnegotiated"}`;i[l]=(i[l]??0)+1}for(const[o,l]of Object.entries(i))e[o]=e[o]??[],e[o].push(l)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,l)=>o-l);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await $m(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Fm(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push(Promise.all([fr(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(s=>{n.abort(s)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new V("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new fo("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n,multiaddrs:s}=Ww(e);if(this.peerId.equals(n))throw new Mm("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const c=Yw(n,this.getConnections(n),s);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new nt("dial-queue:already-connected")),c}const i=await this.dialQueue.dial(e,{...t,priority:t.priority??i0});if(i.status!=="open")throw new bu("Remote closed connection during opening");let o=this.connections.get(i.remotePeer);o==null&&(o=[],this.connections.set(i.remotePeer,o));let l=!1;for(const c of o)if(c.id===i.id&&(l=!0),t.force!==!0&&c.id!==i.id&&c.remoteAddr.equals(i.remoteAddr))return i.abort(new gd("Duplicate multiaddr connection")),c;return l||o.push(i),i}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await Promise.all([fr(s,"close",t),s.close(t)])}catch(i){s.abort(i)}}))}acceptIncomingConnection(e){if(this.deny.some(s=>{if(Er(e.remoteAddr)){const i=qe(e.remoteAddr);return s.contains(i.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>{if(Er(e.remoteAddr)){const i=qe(e.remoteAddr);return s.contains(i.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(Er(e.remoteAddr)){const s=qe(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(s.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>he(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const PB=1e4,DB="1.0.0",LB="ping",RB="ipfs",Xp=32,BB=!0;class NB{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??RB}/${LB}/${DB}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??PB,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??BB,this.timeout=new Wk({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[xr]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=db(s);t=Date.now(),await Promise.all([i.write(ai(Xp),{signal:n}),i.read({bytes:Xp,signal:n})]),e.rtt=Date.now()-t,await s.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}class MB{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Nc("No content routers available");const n=this,s=new hs;for await(const i of cu(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new Nc("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Nc("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new fo;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new fo;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}class OB{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:W(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new qp("No peer routers available");if(e.toString()===this.peerId.toString())throw new xR("Should not try to find self");const n=this,s=cu(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>(async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error("router failed to find peer - %e",o)}})()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new $a}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new qp("No peer routers available");const n=this,s=yo(1024);for await(const i of RD((async function*(){const o=cu(...n.routers.filter(l=>l.getClosestPeers instanceof Function).map(l=>l.getClosestPeers(e,t)));for await(let l of o)yield async()=>{if(l.multiaddrs.length===0)try{l=await n.findPeer(l.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return l}})()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class $B extends Dt{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=vs([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=lr(),yield(await fr(this,"walk:peer",{signal:t,rejectionEvents:["walk:error"]})).detail}catch(n){throw n.detail!=null?n.detail:n}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=vs([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=ai(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Tt(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored - %e",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored - %e",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const o0=32,a0=64;class FB{log;topologies;handlers;components;middleware;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=un({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new AR(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new IR(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:o0,maxOutboundStreams:a0,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new V("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{const s=await this.components.peerStore.get(t,n);for(const i of s.protocols){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{l.filter?.has(t)!==!1&&(l.filter?.remove(t),await l.onDisconnect?.(t))}))}}catch(s){if(s.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,s)}}async _onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));try{for(const i of s){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{l.filter?.has(t.id)!==!1&&(l.filter?.remove(t.id),await l.onDisconnect?.(t.id))}))}}catch(i){this.log.error("could not inform topologies of updated peer %p - %e",t.id,i)}}async _onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;try{for(const i of t){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{n.limits!=null&&l.notifyOnLimitedConnection!==!0||l.filter?.has(s)!==!0&&(l.filter?.add(s),await l.onConnect?.(s,n))}))}}catch(i){this.log.error("could not inform topologies of updated peer after identify %p - %e",s,i)}}}class UB{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=un({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=un({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Ua.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new V("Transport must have a valid tag");if(this.transports.has(t))throw new V(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new LR(`No transport available for address ${String(e)}`);return t?.onProgress?.(new nt("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new fo("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new kR)});const n=[];for(const[i,o]of this.transports.entries()){const l=o.listenFilter(e);for(const c of l){this.log("creating listener for %s on %a",i,c);const d=o.createListener({upgrader:this.components.upgrader});let f=this.listeners.get(i)??[];f==null&&(f=[],this.listeners.set(i,f)),f.push(d),d.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:d})}),d.addEventListener("close",()=>{const a=f.findIndex(u=>u===d);f.splice(a,1),this.components.events.safeDispatchEvent("transport:close",{detail:d})}),Qh.matches(c)?t.ipv4.attempts++:Jh.matches(c)&&t.ipv6.attempts++,n.push(d.listen(c).then(()=>{t.errors.delete(c.toString()),Qh.matches(c)&&t.ipv4.success++,Jh.matches(c)&&t.ipv6.success++},a=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,a),t.errors.set(c.toString(),a),a}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Ua.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new CR(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${VB(o)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}function VB(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}const is="/multistream/1.0.0",l0=1024,KB=j(`
`);async function Hu(r,e){const n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==KB[0])throw new $e("Missing newline");return W(n).trimEnd()}async function zu(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");const n=r.log.newScope("mss:select"),s=Qd(r,{...t,maxDataLength:l0});for(let i=0;i<e.length;i++){const o=e[i];let l;if(i===0){n.trace('write ["%s", "%s"]',is,o);const c=j(`${is}
`),d=j(`${o}
`);if(await s.writeV([c,d],t),n.trace("reading multistream-select header"),l=await Hu(s,t),n.trace('read "%s"',l),l!==is){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',o),await s.write(j(`${o}
`),t);if(n.trace("reading protocol response"),l=await Hu(s,t),n.trace('read "%s"',l),l===o)return n.trace('selected "%s" after negotiation',l),s.unwrap(),o}throw new rA(`Protocol selection failed - could not negotiate ${e}`)}const c0=1024*1024*4;class qB extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}function HB(r){return r[Symbol.asyncIterator]!=null}function u0(r,e){if(r.byteLength>e)throw new qB("Message length too long")}const Ql=r=>{const e=Ar(r),t=on(e);return ji(r,t),Ql.bytes=e,t};Ql.bytes=0;function d0(r,e){e=e??{};const t=e.lengthEncoder??Ql,n=e?.maxDataLength??c0;function*s(i){u0(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return HB(r)?(async function*(){for await(const i of r)yield*s(i)})():(function*(){for(const i of r)yield*s(i)})()}d0.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Ql,n=e?.maxDataLength??c0;return u0(r,n),new Ne(t(r.byteLength),r)};var Zp;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Zp||(Zp={}));async function Wu(r,e,t={}){e=Array.isArray(e)?e:[e];const n=r.log.newScope("mss:handle"),s=Qd(r,{...t,maxDataLength:l0,maxLengthLength:2});for(;;){n.trace("reading incoming string");const i=await Hu(s,t);if(n.trace('read "%s"',i),i===is){n.trace('respond with "%s" for "%s"',is,i),await s.write(j(`${is}
`),t),n.trace('responded with "%s" for "%s"',is,i);continue}if(e.includes(i))return n.trace('respond with "%s" for "%s"',i,i),await s.write(j(`${i}
`),t),n.trace('responded with "%s" for "%s"',i,i),s.unwrap(),i;if(i==="ls"){const o=new Ne(...e.map(l=>d0.single(j(`${l}
`))),j(`
`));n.trace('respond with "%s" for %s',e,i),await s.write(o,t),n.trace('responded with "%s" for %s',e,i);continue}n.trace('respond with "na" for "%s"',i),await s.write(j(`na
`),t),n('responded with "na" for "%s"',i)}}class zB extends Dt{id;remoteAddr;remotePeer;direction;timeline;direct;multiplexer;encryption;limits;log;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;closeTimeout;constructor(e,t){super(),this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.timeline=t.maConn.timeline,this.encryption=t.cryptoProtocol,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??El,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??El,this.closeTimeout=t.closeTimeout??Zw,this.direct=Gw(t.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(n=>n.code===ce)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),t.muxer!=null&&(this.multiplexer=t.muxer.protocol,this.muxer=t.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",n=>{this.dispatchEvent(new Ml(n.local,n.error))})}[Symbol.toStringTag]="Connection";[Qx]=!0;get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}newStream=async(e,t={})=>{if(this.muxer==null)throw new _a("Connection is not multiplexed");if(this.muxer.status!=="open")throw new bu(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new bu(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new mh("Cannot open protocol stream on limited connection");Array.isArray(e)||(e=[e]),this.log.trace("starting new stream for protocols %s",e);const n=await this.muxer.createStream({...t,protocol:e.length===1?e[0]:void 0});this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const l=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:l}}n.protocol===""?(n.log.trace("selecting protocol from protocols %s",e),n.protocol=await zu(n,e,t),n.log("negotiated protocol %s",n.protocol)):n.log("pre-negotiated protocol %s",n.protocol);const s=YB(n.protocol,this.components.registrar,t),i=jp(n.protocol,"outbound",this);if(i>s){const l=new Om(`Too many outbound protocol streams for protocol "${n.protocol}" - ${i}/${s}`);throw n.abort(l),l}await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]}),this.components.metrics?.trackProtocolStream(n);const o=this.components.registrar.getMiddleware(n.protocol);return await this.runMiddlewareChain(n,this,o)}catch(s){throw n.status==="open"?n.abort(s):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,s),s}};async onIncomingStream(e){const t=e.detail,n=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);t.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(t.protocol===""){const d=this.components.registrar.getProtocols();t.log.trace("selecting protocol from protocols %s",d),t.protocol=await Wu(t,d,{signal:n}),t.log("negotiated protocol %s",t.protocol)}else t.log("pre-negotiated protocol %s",t.protocol);const s=GB(t.protocol,this.components.registrar);if(jp(t.protocol,"inbound",this)>s)throw new sA(`Too many inbound protocol streams for protocol "${t.protocol}" - limit ${s}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[t.protocol]},{signal:n}),this.components.metrics?.trackProtocolStream(t);const{handler:o,options:l}=this.components.registrar.getHandler(t.protocol);if(this.limits!=null&&l.runOnLimitedConnection!==!0)throw new mh("Cannot open protocol stream on limited connection");const c=this.components.registrar.getMiddleware(t.protocol);c.push(async(d,f,a)=>{await o(d,f),a(d,f)}),await this.runMiddlewareChain(t,this,c)}catch(s){t.abort(s)}}async runMiddlewareChain(e,t,n){for(let s=0;s<n.length;s++){const i=n[s];e.log.trace("running middleware",s,i),await new Promise((o,l)=>{try{const c=i(e,t,(d,f)=>{e=d,t=f,o()});c instanceof Promise&&c.catch(l)}catch(c){l(c)}}),e.log.trace("ran middleware",s,i)}return e}async close(e={}){if(this.log("closing connection to %a",this.remoteAddr),e.signal==null){const t=AbortSignal.timeout(this.closeTimeout);e={...e,signal:t}}await this.muxer?.close(e),await this.maConn.close(e)}abort(e){this.muxer?.abort(e),this.maConn.abort(e)}}function WB(r,e){return new zB(r,e)}function GB(r,e){try{const{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return o0}function YB(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??a0}function jp(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class XB{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;connectionCloseTimeout;constructor(e,t){this.components=e,this.connectionEncrypters=un({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=un({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??WR,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??El,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??El,this.connectionCloseTimeout=t.connectionCloseTimeout??Zw,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new PR(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return vs([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new DR("Connection denied");await Tt(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getComponents().findLast(o=>o.code===ce)?.value;let s;n!=null&&(s=mi(n),await Tt(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s=e,i,o,l,c;const d=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${d}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){const a=this.components.connectionProtector;a!=null&&(e.log("protecting the %s connection",t),s=await a.protect(s,n))}try{if(ZB(n)){if(n.remotePeer==null)throw new gd(`${t} connection that skipped encryption must have a peer id`);c="native",i=n.remotePeer}else{const a=e.remoteAddr.getComponents().findLast(h=>h.code===ce)?.value;let u;a!=null&&(u=mi(a)),n?.onProgress?.(new nt(`upgrader:encrypt-${t}-connection`)),{connection:s,remotePeer:i,protocol:c,streamMuxer:o}=await(t==="inbound"?this._encryptInbound(s,{...n,remotePeer:u}):this._encryptOutbound(s,{...n,remotePeer:u}))}if(i.equals(this.components.peerId)){const a=new Mm("Can not dial self");throw e.abort(a),a}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,e),n?.muxerFactory!=null?o=n.muxerFactory:o==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new nt(`upgrader:multiplex-${t}-connection`)),o=await(t==="inbound"?this._multiplexInbound(s,this.streamMuxers,n):this._multiplexOutbound(s,this.streamMuxers,n)))}catch(a){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,a),a}o!=null&&(e.log("create muxer %s",o.protocol),l=o.createStreamMuxer(s)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e);const f=this._createConnection({id:d,cryptoProtocol:c,direction:t,maConn:e,stream:s,muxer:l,remotePeer:i,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return f.log("successfully upgraded connection"),f}_createConnection(e){const t=WB(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const s=await Wu(e,n,t),i=this.connectionEncrypters.get(s);if(i==null)throw new fa(`no crypto module found for ${s}`);return e.log("encrypting inbound connection using %s",s),{...await i.secureInbound(e,t),protocol:s}}catch(s){throw new fa(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const s=await zu(e,n,t),i=this.connectionEncrypters.get(s);if(i==null)throw new fa(`no crypto module found for ${s}`);return e.log("encrypting outbound connection using %s",s),{...await i.secureOutbound(e,t),protocol:s}}catch(s){throw new fa(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const i=await zu(e,s,n),o=t.get(i);if(o==null)throw new _a(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),o}catch(i){throw e.log.error("error multiplexing outbound connection - %e",i),new _a(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{e.log.trace("selecting stream muxer from %s",s);const i=await Wu(e,s,n),o=t.get(i);if(o==null)throw new _a(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),o}catch(i){throw e.log.error("error multiplexing inbound connection - %e",i),i}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}function ZB(r){return r.skipEncryption===!0}const f0="3.1.2",h0="js-libp2p";function jB(r,e){return`${r??h0}/${e??f0} browser/${globalThis.navigator.userAgent}`}class QB extends Dt{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new Dt,n=t.dispatchEvent.bind(t);t.dispatchEvent=d=>{const f=n(d),a=this.dispatchEvent(new CustomEvent(d.type,{detail:d.detail}));return f||a},this.peerId=e.peerId,this.logger=e.logger??dd(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??h0,i=e.nodeInfo?.version??f0,o=this.components=OR({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??jB(s,i)},logger:this.logger,events:t,datastore:e.datastore??new DE,connectionGater:KR(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",hR(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",d=>{if(d.detail.previous==null){const f={id:d.detail.peer.id,multiaddrs:d.detail.peer.addresses.map(a=>a.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:f})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new XB(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((d,f)=>this.configureComponent(`connection-encryption-${f}`,d(this.components))),streamMuxers:(e.streamMuxers??[]).map((d,f)=>this.configureComponent(`stream-muxers-${f}`,d(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:e.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new UB(this.components,e.transportManager)),this.configureComponent("connectionManager",new TB(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new NB(this.components,e.connectionMonitor)),this.configureComponent("registrar",new FB(this.components)),this.configureComponent("addressManager",new _R(this.components,e.addresses));const l=(e.peerRouters??[]).map((d,f)=>this.configureComponent(`peer-router-${f}`,d(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new OB(this.components,{routers:l}));const c=(e.contentRouters??[]).map((d,f)=>this.configureComponent(`content-router-${f}`,d(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new MB(this.components,{routers:c})),this.configureComponent("randomWalk",new $B(this.components)),(e.peerDiscovery??[]).forEach((d,f)=>{this.configureComponent(`peer-discovery-${f}`,d(this.components)).addEventListener("peer",u=>{this.#e(u)})}),e.transports?.forEach((d,f)=>{this.components.transportManager.add(this.configureComponent(`transport-${f}`,d(this.components)))}),e.services!=null)for(const d of Object.keys(e.services)){const f=e.services[d],a=f(this.components);if(a==null){this.log.error("service factory %s returned null or undefined instance",d);continue}this.services[d]=a,this.configureComponent(d,a),a[hh]!=null&&(this.log("registering service %s for content routing",d),c.push(a[hh])),a[yh]!=null&&(this.log("registering service %s for peer routing",d),l.push(a[yh])),a[Fa]!=null&&(this.log("registering service %s for peer discovery",d),a[Fa].addEventListener?.("peer",u=>{this.#e(u)}))}$R(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(e){throw this.log.error("an error occurred starting libp2p - %e",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new hs;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new V("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new V("no protocols were provided to open a stream");return this.components.connectionManager.openStream(e,t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Hl(e)&&(e=mi(e.getComponents().findLast(n=>n.code===ce)?.value??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=an([j("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=Hn(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}use(e,t){this.components.registrar.use(e,Array.isArray(t)?t:[t])}unuse(e){this.components.registrar.unuse(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error("could not update multiaddrs of discovered peer - %e",n)})}}async function JB(r={}){r.privateKey??=await $y("Ed25519");const e=new QB({...await LL(r),peerId:kL(r.privateKey)});return r.start!==!1&&await e.start(),e}function p0(r){return r.toLowerCase().replace(/[^a-z0-9@&$!?\-+=.:/_]/g,"")}function Qp(r){return r.replace(/[^a-z0-9./:_-]/gi,"")}function $c(r){try{const t=he(r).toString();return t.includes("/p2p/")?t:null}catch{return null}}async function g0(r={}){const{type:e,moves:t,playerName:n,timestamp:s,value:i}=r;if(!e||typeof e!="string")throw new Error(["RECORD VALIDATION: BAD TYPE!",r]);if(!t||!(Array.isArray(t)||typeof t=="string"))throw new Error(["RECORD VALIDATION: BAD MOVES!",r]);if(t.length>MS)throw new Error(["RECORD VALIDATION: MOVES TOO LONG!",r]);if(!n||typeof n!="string")throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",r]);if(p0(n)!==n)throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",r]);if(typeof s!="number"||!Number.isFinite(s))throw new Error(["RECORD VALIDATION: BAD TIMESTAMP!",r]);if(typeof i!="number"||!(i>0))throw new Error(["RECORD VALIDATION: BAD VALUE!",r]);return new Promise((o,l)=>{let c=null;const d=setTimeout(()=>{c&&c(),l(["RECORD VALIDATION: TIMEOUT!",r])},3e3),f=u=>(u.get=()=>_i(u),u),a=hm({cardsStore:f(ir(Le.cards)),energyStore:f(ir(Le.energy)),logStore:f(ir(Le.log)),matchedIndexesStore:f(ir(Le.matchedIndexes)),movesStore:f(Vi(t)),optionsStore:f(Vi({playerName:n,cluster:!1,rapid:!0})),phaseStore:f(ir(Le.phase)),plusIndexStore:f(ir(Le.plusIndex)),recordsStore:f(ir({...Le.records})),scoreStore:f(ir(Le.score)),seedStore:f(Vi(dm(r))),timestampStore:f(Vi(s))});c=a.recordsStore.subscribe(u=>{const{movesInitial:h,phaseStore:p}=a;if(h!==null&&p.get()!==te.gameOver)return;clearTimeout(d),c&&c();const y=u[e][U.value];let g={type:e,moves:t,playerName:n,timestamp:s,value:i};y>=i?(g.value=y,o(g)):l(["RECORD VALIDATION: WRONG VALUE!",g,y])})})}let kn=-1,Te;const m0=new Set,Fc=new Set,Uc=new Set,eN=await yx(U.leaderboard),Jl=Object.fromEntries(await Promise.all(Ro.map(async r=>[r,await eN(r,[])]))),Qt=new BS({recordTypes:Ro,maxRecords:at,debug:Ei,validateRecord:g0,onUpdate:(r,e)=>{Jl[r].set(e)}});async function y0(r){try{const e=nu(r);if(e){const t=await Qt.handleRecordWithValidation(e)}}catch(e){Ei&&console.error("handleRecordMessage error:",e)}}const tN=Qt.createPushPreview(y0),b0=Qt.createPushRoot(y0),rN=Qt.createRootHandler(tN),nN=Qt.createPreviewHandler();function sN(){const r=co.get();return r.length===0?null:((kn===-1||kn>=r.length)&&(kn=Math.floor(Math.random()*r.length)),r[kn])}async function iN({detail:r}){const e=r.remotePeer.toString();if(Ei&&console.log("connection:open",e),m0.has(e)||r.status!=="open"||xi.get().some(s=>s.includes(e))||Uc.has(e))return;Uc.add(e);const n=await b0(r);Uc.delete(e),n?.error?.name==="UnsupportedProtocolError"&&r.close()}async function oN({detail:{from:r}}){if(Ei&&console.log("pubsub:message",r.toString(),r.equals(Te.peerId)?"local":"remote"),r.equals(Te.peerId)||Te.getConnections(r).length>0)return;const e=r.toString();if(Fc.has(e)||co.get().includes(e))return;const t=Te.getConnections().find(({remotePeer:s})=>co.get().includes(s.toString()));if(!t)return;const n=he(`${t.remoteAddr.toString()}/p2p-circuit/p2p/${e}`);Fc.add(e),Te.dial(n).catch(()=>{}).finally(()=>{Fc.delete(e)})}async function aN(){if(Te?.status!=="started"||Te.getConnections().length>0)return;const r=xi.get();if(r.length!==0)return Ei&&console.log("restoreRelay"),kn=(kn+1)%r.length,Te.dial(he(r[kn])).catch(e=>{console.error("Failed to restore relay",e)})}async function v0(){Te&&await Te.stop();const r=new Cm("keystore");await r.open();const e=await sD(r);Te=await JB({privateKey:e,addresses:{listen:["/p2p-circuit"]},transports:[SL(),TP()],connectionEncrypters:[sL()],streamMuxers:[rT()],peerDiscovery:[TT({list:xi.get()}),hL({interval:13e3,topics:["digifall._peer-discovery"],listenOnly:!1})],connectionGater:{denyDialMultiaddr:()=>!1,denyDialPeer(t){const n=t.toString();return m0.has(n)||Te.getConnections().length>=3||Te.getConnections().some(({remotePeer:i,status:o})=>i.toString()===n&&o!=="closed")?!0:NS?!1:co.get().includes(n)?n!==sN():!1},denyInboundConnection(){return Te.getConnections().length>=5}},services:{identify:XD({protocolPrefix:"digifall"}),pubsub:LD({emitSelf:!0}),keychain:Qv()}}),Te.services.pubsub.addEventListener("message",oN),Te.addEventListener("connection:open",iN),Te.handle($s.root,rN,{runOnLimitedConnection:!0}),Te.handle($s.preview,nN,{runOnLimitedConnection:!0}),Ei&&(window.libp2p=Te),bt.get().leaderboard&&await Te.start()}setInterval(()=>aN().catch(()=>{}),73e3);const lN=w0(()=>{if(!Te)return;const r=co.get();r.length!==0&&Te.getConnections().filter(({remotePeer:e,status:t})=>t==="open"&&!r.includes(e.toString())).forEach(b0)},5e3);Ro.forEach(r=>{const e=Jl[r];e.subscribe(async t=>{if(!(!t||t.length===0)){if(Qt.getData(r).length>0){const n=Qt.getRoots()[r];return Qt.updateRoot(r),n!==Qt.getRoots()[r]&&Te&&lN()}Promise.allSettled(t.map(n=>g0(n).then(s=>Qt.handleRecord(s)))).then(()=>e.set(Qt.getData(r)))}})});Mo.subscribe(r=>{const e=pn.get();e!==te.idle&&e!==te.gameOver||Ro.forEach(t=>{const n=r[t];n[U.value]!==0&&(n[U.type]=t,Qt.handleRecord(n),Jl[t].set(Qt.getData(t)))})});let Jp=!1;const cN=_0(()=>v0(),3e3);xi.subscribe(()=>{if(!Jp){Jp=!0,v0().catch(console.error);return}kn=-1,cN()});let eg=bt.get().leaderboard;const uN=_0(async r=>{r&&Te&&Te.status!=="started"&&await Te.start(),!r&&Te&&Te.status==="started"&&await Te.stop()},3e3);bt.subscribe(({leaderboard:r})=>{r!==eg&&(eg=r,uN(r))});function w0(r,e){let t=0,n=null;return((...s)=>{const i=Date.now();if(i-t>=e)return t=i,clearTimeout(n),n=null,r(...s);clearTimeout(n),n=setTimeout(()=>{t=Date.now(),n=null,r(...s)},e-(i-t))})}function _0(r,e){let t;return((...n)=>{clearTimeout(t),t=setTimeout(()=>r(...n),e)})}var dN=se("<li> </li>"),fN=se('<div><div class="place svelte-fan1x6"> </div> <div> </div> <div></div> <div> </div></div>'),hN=se('<div class="leaderboard content"><div class="section-1"><div class="types svelte-fan1x6" title="[switch leaderboard]" tabindex="0" role="button"><span>combos</span> <span class="high svelte-fan1x6">high &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span> <span>scores</span></div></div> <div class="section-2"><ul class="pages svelte-fan1x6" title="[select page]" tabindex="0" role="button"></ul></div> <div class="section-3 board svelte-fan1x6" tabindex="-1"><!></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>');function pN(r,e){ft(e,!0);const t=()=>fe(b(h),"$leaderboardStore",s),n=()=>fe(bt,"$optionsStore",s),[s,i]=tr(),o=100,l=Math.ceil(at/o)+1;let c=le(0),d=le(jr(U.highScore)),f=le(0),a=le(0),u=le(null),h=ie(()=>Jl[b(d)]),p=ie(()=>t().slice().sort((K,ee)=>ad(ee,K)).slice(0,at)),y=ie(()=>[...b(p).map((K,ee)=>({place:ee===999?0:ee+1,...K})),...Array.from({length:at-b(p).length}).map((K,ee,ge)=>({place:ee===ge.length-1?0:ee+b(p).length+1,playerName:"",value:0}))]),g=ie(()=>b(p).findIndex(({playerName:K})=>K===n()[U.playerName])),m=ie(()=>b(u)?w0(b(u).scrollToIndex,250):()=>{});st(()=>{D(b(a))}),st(()=>{Q()});function w(K){X(d,b(d)===U.highScore?U.highCombo:U.highScore,!0)}function v(K){if(K)return X(c,b(c)<1?l-1:b(c)-1,!0),b(u).scrollToIndex(Math.max(b(c)*o-1,0)),b(c);b(m)(Math.max(b(f)-8,0),!0)}function _(K){if(K)return X(c,b(c)<l-1?b(c)+1:0,!0),b(u).scrollToIndex(Math.max(b(c)*o-1,0)),b(c);b(m)(Math.min(b(f)+8,at-1),!0)}function k(K){const ee=K.composedPath().find(({dataset:Me})=>Me&&Me.index);if(ee===void 0)return;X(c,Number(ee.dataset.index),!0);const ge=b(c)===0?0:b(c)===10?at-1:ee.dataset.index*100-1;b(u).scrollToIndex(ge)}function P(){Nt(Xe,de.menu)}function D(K){return K>=at-2?X(c,10):X(c,I(K),!0)}function I(K){return K>0&&K<at*.1?0:K>=100&&K<at*.2?1:K>=200&&K<at*.3?2:K>=300&&K<at*.4?3:K>=400&&K<at*.5?4:K>=500&&K<at*.6?5:K>=600&&K<at*.7?6:K>=700&&K<at*.8?7:K>=800&&K<at*.9?8:K>=900&&K<at?9:0}function x(K){return K===0&&b(g)===-1?"???":Array.from({length:3-K?.toString().length}).map(()=>"0").join("")+K}function B(K,ee){return ee===0&&b(g)===-1?n()[U.playerName]:K}function Q(){b(u).scrollToIndex(b(g)===-1?at-1:Math.max(b(g)-7,0))}var M={prevPage:v,nextPage:_},A=hN(),E=O(A),S=O(E);S.__click=w;var T=O(S);let C;var L=z(T,4);let R;var N=z(E,2),$=O(N);$.__click=k,Dn($,21,()=>Array.from({length:l}),ei,(K,ee,ge)=>{const Me=ie(()=>ge>9?0:ge);var tt=dN();let Oe;Ln(tt,"data-index",ge);let pt;var Ur=O(tt);Pe(()=>{Oe=Ue(tt,1,"page svelte-fan1x6",null,Oe,{active:ge===b(c)}),pt=Ct(tt,"",pt,{"--color":`var(--color-${b(Me)??""})`}),He(Ur,b(Me))}),J(K,tt)});var q=z(N,2),F=O(q);Ze(jx(F,{get items(){return b(y)},get startIndex(){return b(f)},set startIndex(ee){X(f,ee,!0)},get endIndex(){return b(a)},set endIndex(ee){X(a,ee,!0)},children:(ee,ge)=>{let Me=()=>ge?.().place,tt=()=>ge?.().playerName,Oe=()=>ge?.().value;const pt=ie(()=>tt()===n()[U.playerName]),Ur=ie(()=>"place: "+Me()+`
name: `+tt()?.toUpperCase()+`
score: `+Oe());var Y=fN(),oe=O(Y);let be;var gt=O(oe),nr=z(oe,2);let gr;var Wn=O(nr),If=z(nr,2);let kf;var Cf=z(If,2);let Tf;var E0=O(Cf);Pe((x0,A0,I0)=>{Ue(Y,1,Yg(["grid",{first:Me()===1,second:Me()===2,third:Me()===3}]),"svelte-fan1x6"),Ln(Y,"title",b(Ur)),be=Ct(oe,"",be,x0),He(gt,A0),gr=Ue(nr,1,"player-name svelte-fan1x6",null,gr,{self:b(pt)}),He(Wn,I0),kf=Ue(If,1,"bar svelte-fan1x6",null,kf,{self:b(pt)}),Tf=Ue(Cf,1,"record svelte-fan1x6",null,Tf,{self:b(pt)}),He(E0,Oe())},[()=>({color:`var(--color-${I(Me())??""})`}),()=>x(Me()),()=>B(tt(),Me())]),J(ee,Y)},$$slots:{default:!0}}),ee=>X(u,ee,!0),()=>b(u));var H=z(q,2),G=O(H),re=O(G);re.__click=P,Pe(()=>{C=Ue(T,1,"type svelte-fan1x6",null,C,{active:b(d)===U.highCombo}),R=Ue(L,1,"type svelte-fan1x6",null,R,{active:b(d)===U.highScore})}),xe(5,S,()=>Ht,()=>({y:-48})),xe(1,re,()=>Ht,()=>({y:48})),xe(1,A,()=>Lr),J(r,A);var ne=ht(M);return i(),ne}$r(["click"]);var gN=se('<span class="title"> </span>'),mN=se('<div class="dialog content"><div class="section-1"><!></div> <div class="section-2"></div> <div class="section-3"><!></div> <div class="section-4"></div></div>');function Af(r,e){ft(e,!0);let t=Qr(e,"title",3,""),n=Qr(e,"visible",15,!1);function s(){n(!0)}function i(){n(!1)}var o={open:s,close:i},l=Yr(),c=rt(l);{var d=f=>{var a=mN(),u=O(a),h=O(u);{var p=m=>{var w=gN(),v=O(w);Pe(()=>He(v,t())),xe(1,w,()=>Ht,()=>({y:-48})),J(m,w)};we(h,m=>{t()&&m(p)})}var y=z(u,4),g=O(y);Hg(g,()=>e.children,()=>({visible:n(),open:s,close:i})),xe(1,y,()=>Ht,()=>({y:24})),xe(1,a,()=>Lr),J(f,a)};we(c,f=>{n()&&f(d)})}return J(r,l),ht(o)}const yN="0.13.0";var bN=se('<span class="rapid svelte-p9o308">rapid</span>'),vN=se('<button class="svelte-p9o308">new game</button>'),wN=se('<button class="svelte-p9o308">resume</button> <button class="svelte-p9o308">new game</button>',1),_N=se('<button class="svelte-p9o308">p2p leaderboard</button>'),SN=se('<div class="menu content svelte-p9o308"><div class="section-1 svelte-p9o308"><h1 class="svelte-p9o308">digifall <!></h1></div> <div class="section-2 svelte-p9o308"></div> <div class="section-3 svelte-p9o308"><div class="col svelte-p9o308"><!> <!> <button class="svelte-p9o308">options</button></div></div> <div class="section-4 svelte-p9o308"></div></div> <span class="version svelte-p9o308"> </span> <a href="https://github.com/llblab/digifall" class="github-corner svelte-p9o308" aria-label="View source on GitHub"><svg viewBox="0 0 250 250" aria-hidden="true" class="svelte-p9o308"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" class="svelte-p9o308"></path><path class="octo-arm svelte-p9o308" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor"></path><path class="octo-body svelte-p9o308" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path></svg></a>',1),EN=se('<div class="col svelte-p9o308"><p class="svelte-p9o308">start a new game?</p> <div class="row svelte-p9o308"><button class="svelte-p9o308">yes</button> <button class="svelte-p9o308">no</button></div></div>'),xN=se("<!> <!>",1);function AN(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",s),n=()=>fe(pn,"$phaseStore",s),[s,i]=tr();let o=le(null),l=le(!1);st(()=>{t().playerName===""&&Nt(Xe,de.wellcome)});function c(){return b(o).visible}function d(){b(o).close()}function f(){Nt(Xe,null)}function a(){b(o).close(),pd()}function u(){Nt(Xe,de.leaderboard)}function h(){Nt(Xe,de.options)}var p={isNewGameDialog:c,closeNewGameDialog:d},y=xN(),g=rt(y);{var m=_=>{var k=SN(),P=rt(k),D=O(P),I=O(D),x=z(O(I));{var B=q=>{var F=bN();J(q,F)};we(x,q=>{t().rapid&&q(B)})}var Q=z(D,4),M=O(Q),A=O(M);{var E=q=>{var F=vN();F.__click=a,J(q,F)},S=q=>{var F=wN(),H=rt(F);H.__click=f;var G=z(H,2);G.__click=function(...re){b(o)?.open?.apply(this,re)},J(q,F)};we(A,q=>{n()===te.gameOver?q(E):q(S,!1)})}var T=z(A,2);{var C=q=>{var F=_N();F.__click=u,J(q,F)};we(T,q=>{t()[U.leaderboard]&&q(C)})}var L=z(T,2);L.__click=h;var R=z(P,2),N=O(R),$=z(R,2);Pe(()=>He(N,yN)),xe(5,P,()=>Lr),xe(5,R,()=>Lr),xe(5,$,()=>Lr),J(_,k)};we(g,_=>{b(l)||_(m)})}var w=z(g,2);Ze(Af(w,{get visible(){return b(l)},set visible(_){X(l,_,!0)},children:(_,k)=>{var P=EN(),D=z(O(P),2),I=O(D);I.__click=a;var x=z(I,2);x.__click=function(...B){b(o).close?.apply(this,B)},J(_,P)},$$slots:{default:!0}}),_=>X(o,_,!0),()=>b(o)),J(r,y);var v=ht(p);return i(),v}$r(["click"]);var IN=se('<span class="symbols">a-z 0-9 @&$!?-+=.:/_</span> <input class="player-name" type="text" inputmode="url" placeholder="player name" spellcheck="false" maxlength="42"/>',1);function S0(r,e){ft(e,!0);let t=Qr(e,"value",15,""),n=le(null),s=le("hidden"),i=ie(()=>"player name: "+t().toUpperCase());st(()=>{t()===""&&b(n)?.focus()});function o(h){const p=h.target.value,y=p0(p);X(s,p===y?"hidden":"visible",!0),h.target.value=y,t(y)}function l(h=400){X(s,"hidden"),b(n)&&(b(n).classList.toggle("blink"),setTimeout(()=>b(n).classList.toggle("blink"),h))}var c={blink:l},d=IN(),f=rt(d);let a;var u=z(f,2);return u.__input=o,Ze(u,h=>X(n,h),()=>b(n)),Pe(()=>{a=Ct(f,"",a,{visibility:b(s)}),Ln(u,"title",b(i)),jc(u,t())}),J(r,d),ht(c)}$r(["input"]);var kN=se('<div class="options content"><div class="section-1"><span>options</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <input type="checkbox" id="rapid" class="svelte-awxzgh"/> <label for="rapid" tabindex="0" role="button" class="svelte-awxzgh">rapid mode</label> <input type="checkbox" id="sound" class="svelte-awxzgh"/> <label for="sound" tabindex="0" role="button" class="svelte-awxzgh">sound effects</label> <input type="checkbox" id="leaderboard" class="svelte-awxzgh"/> <label for="leaderboard" tabindex="0" role="button" class="svelte-awxzgh">p2p leaderboard</label> <button class="suboption svelte-awxzgh">relays</button></div></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>'),CN=se('<div class="col exclam-fix"><p>new name detected!</p> <p>progress will be lost!</p> <div class="row"><button>accept</button> <button>reject</button></div></div>'),TN=se("<!> <!>",1);function PN(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",n),[n,s]=tr();let i=le(null),o=le(!1),l=le(null),c=ie(()=>t().playerName);function d(){return b(o)}function f(){b(i).close(),Nt(Mo,Le.records),pd(b(c))}function a(){b(i).close(),X(c,t().playerName)}function u(){if(b(c)==="")return b(l).blink();if(b(c)!==t().playerName)return b(i).open();Nt(Xe,de.menu)}function h(){Nt(Xe,de.relays)}var p={isDialogVisible:d},y=TN(),g=rt(y);{var m=_=>{var k=kN(),P=O(k),D=O(P),I=z(P,4),x=O(I),B=O(x);Ze(S0(B,{get value(){return b(c)},set value($){X(c,$)}}),$=>X(l,$,!0),()=>b(l));var Q=z(B,2),M=z(Q,2),A=z(M,2);A.__click=()=>pa(bt,ct(t).sound=!t().sound,ct(t));var E=z(A,2),S=z(E,2),T=z(S,2),C=z(T,2);C.__click=h;var L=z(I,2),R=O(L),N=O(R);N.__click=u,Pe(()=>{Ln(M,"title",`boring animations ${t().rapid?"disabled":"enabled"}`),r1(A,t().sound),Ln(E,"title",`making sounds ${t().sound?"enabled":"disabled"}`),Ln(T,"title",`sharing records ${t().leaderboard?"enabled":"disabled"}`),C.disabled=!t().leaderboard}),xe(5,D,()=>Ht,()=>({y:-48})),Kf(Q,()=>t().rapid,$=>pa(bt,ct(t).rapid=$,ct(t))),Kf(S,()=>t().leaderboard,$=>pa(bt,ct(t).leaderboard=$,ct(t))),xe(5,C,()=>Ht,()=>({x:20})),xe(5,I,()=>Ht,()=>({y:24})),xe(5,N,()=>Ht,()=>({y:48})),xe(5,k,()=>Lr),J(_,k)};we(g,_=>{b(o)||_(m)})}var w=z(g,2);Ze(Af(w,{get title(){return b(c)},get visible(){return b(o)},set visible(_){X(o,_,!0)},children:(_,k)=>{var P=CN(),D=z(O(P),4),I=O(D);I.__click=f;var x=z(I,2);x.__click=a,J(_,P)},$$slots:{default:!0}}),_=>X(i,_,!0),()=>b(i)),J(r,y);var v=ht(p);return s(),v}$r(["click"]);var DN=se('<span class="error-msg svelte-16oz979"> </span>'),LN=se('<div class="relay-row svelte-16oz979"><div class="textarea-wrap svelte-16oz979"><textarea rows="3"></textarea> <!></div> <button class="remove-btn svelte-16oz979" title="remove"><span class="icon-remove svelte-16oz979">+</span></button></div>'),RN=se('<span class="error-msg svelte-16oz979"> </span>'),BN=se('<div class="relays content"><div class="section-1"><span>relays</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><div class="list svelte-16oz979"><!> <div class="relay-row new-row svelte-16oz979"><div class="textarea-wrap svelte-16oz979"><textarea placeholder="/dns4/example.com/tcp/443/wss/p2p/12D3KooW..." rows="3"></textarea> <!></div> <button class="add-btn svelte-16oz979" title="add relay">+</button></div></div></div></div> <div class="section-4 svelte-16oz979"><div class="row svelte-16oz979"><button title="[reset relays]">reset</button> <button title="[options]">back</button></div></div></div>');function NN(r,e){ft(e,!0);const t=()=>fe(xi,"$activeRelaysStore",n),[n,s]=tr();let i=le(jr([...t()])),o=le("");const l=F=>{const H=F.trim();return H?$c(H)?"":"invalid multiaddr":""};let c=ie(()=>b(i).map(l)),d=ie(()=>l(b(o)));st(()=>{X(i,[...t()],!0)});function f(F){mu.update(H=>({...H,active:F(H.active)}))}function a(){mu.set({active:[...ti],applied:[...ti]})}function u(F,H){const G=Qp(F.target.value);F.target.value=G,b(i)[H]=G}function h(F){const H=Qp(F.target.value);F.target.value=H,X(o,H,!0)}function p(F){const H=b(i)[F].trim();if(!H){f(re=>re.filter((ne,K)=>K!==F));return}if(b(c)[F])return;const G=$c(H);G!==t()[F]&&f(re=>re.map((ne,K)=>K===F?G:ne))}function y(){const F=b(o).trim();if(!F||b(d))return;const H=$c(F);f(G=>[...G,H]),X(o,"")}function g(F){f(H=>H.filter((G,re)=>re!==F))}function m(){const F=document.activeElement;if(F?.tagName!=="TEXTAREA")return;const H=F.closest(".relay-row"),G=Array.from(document.querySelectorAll(".relays .relay-row")),re=G.indexOf(H);re!==-1&&(re===G.length-1?y():p(re))}function w(){Nt(Xe,de.options)}var v={saveCurrentRelay:m},_=BN(),k=O(_),P=O(k),D=z(k,4),I=O(D),x=O(I),B=O(x);Dn(B,17,()=>b(i),ei,(F,H,G)=>{var re=LN(),ne=O(re),K=O(ne);K.__input=Oe=>u(Oe,G);let ee;var ge=z(K,2);{var Me=Oe=>{var pt=DN(),Ur=O(pt);Pe(()=>He(Ur,b(c)[G])),J(Oe,pt)};we(ge,Oe=>{b(c)[G]&&Oe(Me)})}var tt=z(ne,2);tt.__click=()=>g(G),Pe(Oe=>{jc(K,b(H)),ee=Ue(K,1,"svelte-16oz979",null,ee,Oe)},[()=>({error:b(c)[G],valid:!b(c)[G]&&b(H).trim()})]),_r("blur",K,()=>p(G)),J(F,re)});var Q=z(B,2),M=O(Q),A=O(M);A.__input=h;let E;var S=z(A,2);{var T=F=>{var H=RN(),G=O(H);Pe(()=>He(G,b(d))),J(F,H)};we(S,F=>{b(d)&&F(T)})}var C=z(M,2);C.__click=y;var L=z(D,2),R=O(L),N=O(R);N.__click=a;var $=z(N,2);$.__click=w,Pe(F=>{jc(A,b(o)),E=Ue(A,1,"svelte-16oz979",null,E,F)},[()=>({error:b(d),valid:!b(d)&&b(o).trim()})]),xe(5,P,()=>Ht,()=>({y:-48})),xe(5,D,()=>Ht,()=>({y:24})),xe(5,N,()=>Ht,()=>({y:48})),xe(5,$,()=>Ht,()=>({y:48})),xe(5,_,()=>Lr),J(r,_);var q=ht(v);return s(),q}$r(["input","click"]);var MN=se('<form class="wellcome content"><div class="section-1"><h1>digifall</h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <button type="submit">start</button></div></div> <div class="section-4"></div></form>'),ON=se(`<div class="col"><p>Game doesn't contain tutorial mode!</p> <p>Target: understand how to play it</p> <button>continue</button></div>`),$N=se("<!> <!>",1);function FN(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",n),[n,s]=tr();let i=ie(()=>null),o=ie(()=>!0),l=ie(()=>null),c=ie(()=>t().playerName);function d(){b(c)!==t().playerName&&(pa(bt,ct(t).playerName=b(c),ct(t)),Nt(hd,Date.now()))}function f(y){if(y.preventDefault(),b(c)==="")return b(l).blink();Nt(Xe,null)}var a=$N(),u=rt(a);{var h=y=>{var g=MN();g.__input=d;var m=z(O(g),4),w=O(m),v=O(w);Ze(S0(v,{get value(){return b(c)},set value(_){X(c,_)}}),_=>X(l,_),()=>b(l)),_r("submit",g,f),xe(5,g,()=>Lr),J(y,g)};we(u,y=>{b(o)||y(h)})}var p=z(u,2);Ze(Af(p,{title:"heads up!",get visible(){return b(o)},set visible(y){X(o,y)},children:(y,g)=>{var m=ON(),w=z(O(m),4);w.__click=function(...v){b(i).close?.apply(this,v)},J(y,m)},$$slots:{default:!0}}),y=>X(i,y),()=>b(i)),J(r,a),ht(),s()}$r(["input","click"]);var UN=se('<div class="overlay"><!></div>');function VN(r,e){ft(e,!0);const t=()=>fe(Xe,"$overlayStore",s),n=()=>fe(pn,"$phaseStore",s),[s,i]=tr();let o=le(null),l=le(null),c=le(null),d=le(null),f=le(null),a=le(null);async function u(){if(await R_(),b(l)&&b(l).isNewGameDialog())return b(l).closeNewGameDialog();Nt(Xe,currentOverlay===null||currentOverlay===de.leaderboard||currentOverlay===de.options||currentOverlay===de.relays?de.menu:null)}function h(){if(t()===de.relays)return k()?void 0:D(-2);P(-1)}function p(){if(t()===de.relays)return k()?void 0:D(2);P(1)}function y(){if(t()===de.relays)return k()?void 0:D(-1);if(t()===de.leaderboard)return b(a)?b(a).classList.contains("types")?b(a).click():b(o).prevPage(b(a).classList.contains("pages")):void 0;(t()!==de.options||b(c).isDialogVisible())&&P(-1)}function g(){if(t()===de.relays)return k()?void 0:D(1);if(t()===de.leaderboard)return b(a)?b(a).classList.contains("types")?b(a).click():b(o).nextPage(b(a).classList.contains("pages")):void 0;(t()!==de.options||b(c).isDialogVisible())&&P(-1)}function m(){if(t()===de.relays&&b(a)?.tagName==="TEXTAREA"){k()?(b(d)?.saveCurrentRelay(),b(a).blur()):b(a).focus();return}b(a)&&(b(f)&&b(f).isFocused()?b(f).nextType():b(a).classList.contains("focus")&&b(a).click())}function w(){if(b(a)&&b(a).blur(),t()===de.options||t()===de.leaderboard||t()===de.gameOver)return Xe.set(de.menu);if(t()===de.relays)return Xe.set(de.options);if(t()===de.menu&&n()!==te.gameOver)return Xe.set(null)}function v({node:A,selectors:E,shift:S=0}={}){if(!E||E.length<1)return;const T=E.map(N=>".overlay "+N).join(", "),C=Array.from(document.querySelectorAll(T));if(!A)return S<0?C[C.length+S]:C[0];if(S===0)return A;const L=C.indexOf(A);if(L===-1)return S<0?C[C.length+S]:C[0];let R=L+S;return R<0&&(R=C.length+R),R>C.length-1&&(R=R-C.length),C[R]}function _(A,E=!1){if(A){if(b(f)&&b(f).isFocused()&&b(f).blur(),b(a)&&(b(a).classList.remove("focus"),b(a).blur()),A.classList.contains("score"))return b(f)&&b(f).focus();X(a,A,!0),b(a).classList.add("focus"),E||b(a).focus()}}function k(){return b(a)?.tagName==="TEXTAREA"&&document.activeElement===b(a)}function P(A){const E=["button:not(.digifall)","[role='button']","input:not([type='checkbox'])","[tabindex='-1']"],S=E.map(L=>".overlay "+L+".focus").join(", "),T=document.querySelector(S),C=v({node:T,selectors:E,shift:A});_(C)}function D(A){const E=["textarea","button:not(.digifall)"],S=E.map(R=>".overlay "+R+".focus").join(", "),T=document.querySelector(S),C=v({node:T,selectors:E,shift:A}),L=C?.tagName==="TEXTAREA";_(C,L)}var I={switchOverlay:u,moveUp:h,moveDown:p,moveLeft:y,moveRight:g,perfomAction:m,blur:w},x=Yr(),B=rt(x);{var Q=A=>{var E=UN(),S=O(E);{var T=L=>{Yx(L,{get scoreComponent(){return b(f)},set scoreComponent(R){X(f,R,!0)}})},C=L=>{var R=Yr(),N=rt(R);{var $=F=>{Ze(pN(F,{}),H=>X(o,H,!0),()=>b(o))},q=F=>{var H=Yr(),G=rt(H);{var re=K=>{Ze(AN(K,{}),ee=>X(l,ee,!0),()=>b(l))},ne=K=>{var ee=Yr(),ge=rt(ee);{var Me=Oe=>{Ze(PN(Oe,{}),pt=>X(c,pt,!0),()=>b(c))},tt=Oe=>{var pt=Yr(),Ur=rt(pt);{var Y=be=>{Ze(NN(be,{}),gt=>X(d,gt,!0),()=>b(d))},oe=be=>{var gt=Yr(),nr=rt(gt);{var gr=Wn=>{FN(Wn,{})};we(nr,Wn=>{t()===de.wellcome&&Wn(gr)},!0)}J(be,gt)};we(Ur,be=>{t()===de.relays?be(Y):be(oe,!1)},!0)}J(Oe,pt)};we(ge,Oe=>{t()===de.options?Oe(Me):Oe(tt,!1)},!0)}J(K,ee)};we(G,K=>{t()===de.menu?K(re):K(ne,!1)},!0)}J(F,H)};we(N,F=>{t()===de.leaderboard?F($):F(q,!1)},!0)}J(L,R)};we(S,L=>{t()===de.gameOver?L(T):L(C,!1)})}xe(3,E,()=>ma,()=>({duration:200})),J(A,E)};we(B,A=>{t()&&A(Q)})}J(r,x);var M=ht(I);return i(),M}var KN=se('<div class="app"><!> <!></div>');function qN(r,e){ft(e,!0);const t=()=>fe(pn,"$phaseStore",o),n=()=>fe(Xe,"$overlayStore",o),s=()=>fe(Bl,"$energyStore",o),i=()=>fe(Oo,"$seedStore",o),[o,l]=tr();let c=le(null),d=le(null);st(()=>{eh>0&&setTimeout(()=>location=location,eh*1e3)}),st(()=>{t()===te.gameOver&&Nt(Xe,de.gameOver)}),st(()=>{document.documentElement.classList[s().value>100||t()===te.extra||t()===te.combo||n()===de.leaderboard||n()===de.gameOver?"add":"remove"]("random-color")});function f(g){const m=n()===null?b(c):b(d);switch(g.code){case"Escape":return g.preventDefault(),m.blur();case"Tab":return g.preventDefault(),!i()||n()===de.wellcome||n()===de.gameOver?void 0:b(d).switchOverlay();case"ArrowUp":return m.moveUp();case"ArrowDown":return m.moveDown();case"ArrowLeft":return m.moveLeft();case"ArrowRight":return m.moveRight();case"Enter":case"Space":return g.preventDefault(),m.perfomAction();case"KeyF":case"KeyJ":return m.perfomAction()}}function a(){document.hasFocus()||(document.location=document.location)}function u(){const{style:g,offsetHeight:m,offsetWidth:w}=document.documentElement,k=m/w<1.5?m/192:w/128,P=k%.25;g.setProperty("font-size",k-P+"px")}var h=KN();_r("keydown",Zn,f),_r("storage",Zn,a),_r("resize",Zn,u),_r("visibilitychange",Zn,u),Wg(Zn,g=>u?.());var p=O(h);Ze(qx(p,{}),g=>X(c,g,!0),()=>b(c));var y=z(p,2);Ze(VN(y,{}),g=>X(d,g,!0),()=>b(d)),J(r,h),ht(),l()}hm(ys,wE);U_(qN,{target:document.body});
