(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Uc=!1;var Qp=Array.isArray,w0=Array.prototype.indexOf,Sl=Array.from,Jp=Object.defineProperty,Hs=Object.getOwnPropertyDescriptor,eg=Object.getOwnPropertyDescriptors,_0=Object.prototype,S0=Array.prototype,Wu=Object.getPrototypeOf,kf=Object.isExtensible;function E0(r){return typeof r=="function"}const Vt=()=>{};function x0(r){return r()}function _a(r){for(var e=0;e<r.length;e++)r[e]()}function tg(){var r,e,t=new Promise((n,s)=>{r=n,e=s});return{promise:t,resolve:r,reject:e}}const vt=2,Gu=4,El=8,A0=1<<24,Or=16,dn=32,xs=64,xl=128,Sr=512,Tt=1024,Wt=2048,Br=4096,er=8192,tn=16384,Al=32768,Mn=65536,Cf=1<<17,rg=1<<18,vi=1<<19,ng=1<<20,jr=1<<25,hs=32768,Vc=1<<21,Yu=1<<22,kn=1<<23,is=Symbol("$state"),I0=Symbol("legacy props"),k0=Symbol(""),$s=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function C0(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function T0(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function P0(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function D0(r){throw new Error("https://svelte.dev/e/effect_orphan")}function L0(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function R0(r){throw new Error("https://svelte.dev/e/props_invalid_value")}function B0(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function N0(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function M0(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function O0(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const $0=1,F0=2,sg=4,U0=8,V0=16,K0=1,q0=2,H0=4,z0=8,W0=16,G0=1,Y0=2,X0=4,Z0=1,j0=2,St=Symbol(),Q0="http://www.w3.org/1999/xhtml";function J0(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function ig(r){return r===this.v}function og(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function ag(r){return!og(r,this.v)}let xo=!1,e_=!1;function t_(){xo=!0}let ut=null;function Qs(r){ut=r}function dt(r,e=!1,t){ut={p:ut,i:!1,c:null,e:null,s:r,x:null,l:xo&&!e?{s:null,u:null,$:[]}:null}}function ft(r){var e=ut,t=e.e;if(t!==null){e.e=null;for(var n of t)Eg(n)}return r!==void 0&&(e.x=r),e.i=!0,ut=e.p,r??{}}function wi(){return!xo||ut!==null&&ut.l===null}let jn=[];function lg(){var r=jn;jn=[],_a(r)}function As(r){if(jn.length===0&&!zi){var e=jn;queueMicrotask(()=>{e===jn&&lg()})}jn.push(r)}function r_(){for(;jn.length>0;)lg()}function cg(r){var e=_e;if(e===null)return ve.f|=kn,r;if((e.f&Al)===0){if((e.f&xl)===0)throw r;e.b.error(r)}else Js(r,e)}function Js(r,e){for(;e!==null;){if((e.f&xl)!==0)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r}const Wo=new Set;let He=null,lr=null,or=[],Il=null,Kc=!1,zi=!1;class Tr{committed=!1;current=new Map;previous=new Map;#e=new Set;#t=new Set;#r=0;#n=0;#o=null;#a=new Set;#s=new Set;skipped_effects=new Set;is_fork=!1;is_deferred(){return this.is_fork||this.#n>0}process(e){or=[],this.apply();var t={parent:null,effect:null,effects:[],render_effects:[]};for(const n of e)this.#l(n,t);this.is_fork||this.#g(),this.is_deferred()?(this.#f(t.effects),this.#f(t.render_effects)):(He=null,Tf(t.render_effects),Tf(t.effects),this.#o?.resolve()),lr=null}#l(e,t){e.f^=Tt;for(var n=e.first;n!==null;){var s=n.f,i=(s&(dn|xs))!==0,o=i&&(s&Tt)!==0,l=o||(s&er)!==0||this.skipped_effects.has(n);if((n.f&xl)!==0&&n.b?.is_pending()&&(t={parent:t,effect:n,effects:[],render_effects:[]}),!l&&n.fn!==null){i?n.f^=Tt:(s&Gu)!==0?t.effects.push(n):Co(n)&&((n.f&Or)!==0&&this.#a.add(n),so(n));var c=n.first;if(c!==null){n=c;continue}}var d=n.parent;for(n=n.next;n===null&&d!==null;)d===t.effect&&(this.#f(t.effects),this.#f(t.render_effects),t=t.parent),n=d.next,d=d.parent}}#f(e){for(const t of e)(t.f&Wt)!==0?this.#a.add(t):(t.f&Br)!==0&&this.#s.add(t),this.#c(t.deps),Pt(t,Tt)}#c(e){if(e!==null)for(const t of e)(t.f&vt)===0||(t.f&hs)===0||(t.f^=hs,this.#c(t.deps))}capture(e,t){this.previous.has(e)||this.previous.set(e,t),(e.f&kn)===0&&(this.current.set(e,e.v),lr?.set(e,e.v))}activate(){He=this,this.apply()}deactivate(){He===this&&(He=null,lr=null)}flush(){if(this.activate(),or.length>0){if(ug(),He!==null&&He!==this)return}else this.#r===0&&this.process([]);this.deactivate()}discard(){for(const e of this.#t)e(this);this.#t.clear()}#g(){if(this.#n===0){for(const e of this.#e)e();this.#e.clear()}this.#r===0&&this.#h()}#h(){if(Wo.size>1){this.previous.clear();var e=lr,t=!0,n={parent:null,effect:null,effects:[],render_effects:[]};for(const i of Wo){if(i===this){t=!1;continue}const o=[];for(const[c,d]of this.current){if(i.current.has(c))if(t&&d!==i.current.get(c))i.current.set(c,d);else continue;o.push(c)}if(o.length===0)continue;const l=[...i.current.keys()].filter(c=>!this.current.has(c));if(l.length>0){var s=or;or=[];const c=new Set,d=new Map;for(const f of o)dg(f,l,c,d);if(or.length>0){He=i,i.apply();for(const f of or)i.#l(f,n);i.deactivate()}or=s}}He=null,lr=e}this.committed=!0,Wo.delete(this)}increment(e){this.#r+=1,e&&(this.#n+=1)}decrement(e){this.#r-=1,e&&(this.#n-=1),this.revive()}revive(){for(const e of this.#a)this.#s.delete(e),Pt(e,Wt),ps(e);for(const e of this.#s)Pt(e,Br),ps(e);this.flush()}oncommit(e){this.#e.add(e)}ondiscard(e){this.#t.add(e)}settled(){return(this.#o??=tg()).promise}static ensure(){if(He===null){const e=He=new Tr;Wo.add(He),zi||Tr.enqueue(()=>{He===e&&e.flush()})}return He}static enqueue(e){As(e)}apply(){}}function n_(r){var e=zi;zi=!0;try{for(var t;;){if(r_(),or.length===0&&(He?.flush(),or.length===0))return Il=null,t;ug()}}finally{zi=e}}function ug(){var r=as;Kc=!0;var e=null;try{var t=0;for(xa(!0);or.length>0;){var n=Tr.ensure();if(t++>1e3){var s,i;s_()}n.process(or),Cn.clear()}}finally{Kc=!1,xa(r),Il=null}}function s_(){try{L0()}catch(r){Js(r,Il)}}let zr=null;function Tf(r){var e=r.length;if(e!==0){for(var t=0;t<e;){var n=r[t++];if((n.f&(tn|er))===0&&Co(n)&&(zr=new Set,so(n),n.deps===null&&n.first===null&&n.nodes===null&&(n.teardown===null&&n.ac===null?Ig(n):n.fn=null),zr?.size>0)){Cn.clear();for(const s of zr){if((s.f&(tn|er))!==0)continue;const i=[s];let o=s.parent;for(;o!==null;)zr.has(o)&&(zr.delete(o),i.push(o)),o=o.parent;for(let l=i.length-1;l>=0;l--){const c=i[l];(c.f&(tn|er))===0&&so(c)}}zr.clear()}}zr=null}}function dg(r,e,t,n){if(!t.has(r)&&(t.add(r),r.reactions!==null))for(const s of r.reactions){const i=s.f;(i&vt)!==0?dg(s,e,t,n):(i&(Yu|Or))!==0&&(i&Wt)===0&&fg(s,e,n)&&(Pt(s,Wt),ps(s))}}function fg(r,e,t){const n=t.get(r);if(n!==void 0)return n;if(r.deps!==null)for(const s of r.deps){if(e.includes(s))return!0;if((s.f&vt)!==0&&fg(s,e,t))return t.set(s,!0),!0}return t.set(r,!1),!1}function ps(r){for(var e=Il=r;e.parent!==null;){e=e.parent;var t=e.f;if(Kc&&e===_e&&(t&Or)!==0&&(t&rg)===0)return;if((t&(xs|dn))!==0){if((t&Tt)===0)return;e.f^=Tt}}or.push(e)}function i_(r){let e=0,t=gs(0),n;return()=>{ro()&&(b(t),ju(()=>(e===0&&(n=ct(()=>r(()=>Wi(t)))),e+=1,()=>{As(()=>{e-=1,e===0&&(n?.(),n=void 0,Wi(t))})})))}}var o_=Mn|vi|xl;function a_(r,e,t){new l_(r,e,t)}class l_{parent;#e=!1;#t;#r=null;#n;#o;#a;#s=null;#l=null;#f=null;#c=null;#g=null;#h=0;#u=0;#d=!1;#i=null;#E=i_(()=>(this.#i=gs(this.#h),()=>{this.#i=null}));constructor(e,t,n){this.#t=e,this.#n=t,this.#o=n,this.parent=_e.b,this.#e=!!this.#n.pending,this.#a=ko(()=>{_e.b=this;{var s=this.#m();try{this.#s=ar(()=>n(s))}catch(i){this.error(i)}this.#u>0?this.#y():this.#e=!1}return()=>{this.#g?.remove()}},o_)}#p(){try{this.#s=ar(()=>this.#o(this.#t))}catch(e){this.error(e)}this.#e=!1}#w(){const e=this.#n.pending;e&&(this.#l=ar(()=>e(this.#t)),Tr.enqueue(()=>{var t=this.#m();this.#s=this.#_(()=>(Tr.ensure(),ar(()=>this.#o(t)))),this.#u>0?this.#y():(os(this.#l,()=>{this.#l=null}),this.#e=!1)}))}#m(){var e=this.#t;return this.#e&&(this.#g=Tn(),this.#t.before(this.#g),e=this.#g),e}is_pending(){return this.#e||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!this.#n.pending}#_(e){var t=_e,n=ve,s=ut;Nr(this.#a),Kt(this.#a),Qs(this.#a.ctx);try{return e()}catch(i){return cg(i),null}finally{Nr(t),Kt(n),Qs(s)}}#y(){const e=this.#n.pending;this.#s!==null&&(this.#c=document.createDocumentFragment(),this.#c.append(this.#g),Tg(this.#s,this.#c)),this.#l===null&&(this.#l=ar(()=>e(this.#t)))}#b(e){if(!this.has_pending_snippet()){this.parent&&this.parent.#b(e);return}this.#u+=e,this.#u===0&&(this.#e=!1,this.#l&&os(this.#l,()=>{this.#l=null}),this.#c&&(this.#t.before(this.#c),this.#c=null))}update_pending_count(e){this.#b(e),this.#h+=e,this.#i&&ei(this.#i,this.#h)}get_effect_pending(){return this.#E(),b(this.#i)}error(e){var t=this.#n.onerror;let n=this.#n.failed;if(this.#d||!t&&!n)throw e;this.#s&&(zt(this.#s),this.#s=null),this.#l&&(zt(this.#l),this.#l=null),this.#f&&(zt(this.#f),this.#f=null);var s=!1,i=!1;const o=()=>{if(s){J0();return}s=!0,i&&O0(),Tr.ensure(),this.#h=0,this.#f!==null&&os(this.#f,()=>{this.#f=null}),this.#e=this.has_pending_snippet(),this.#s=this.#_(()=>(this.#d=!1,ar(()=>this.#o(this.#t)))),this.#u>0?this.#y():this.#e=!1};var l=ve;try{Kt(null),i=!0,t?.(e,o),i=!1}catch(c){Js(c,this.#a&&this.#a.parent)}finally{Kt(l)}n&&As(()=>{this.#f=this.#_(()=>{Tr.ensure(),this.#d=!0;try{return ar(()=>{n(this.#t,()=>e,()=>o)})}catch(c){return Js(c,this.#a.parent),null}finally{this.#d=!1}})})}}function c_(r,e,t,n){const s=wi()?Ao:to;if(t.length===0&&r.length===0){n(e.map(s));return}var i=He,o=_e,l=u_();function c(){Promise.all(t.map(d=>d_(d))).then(d=>{l();try{n([...e.map(s),...d])}catch(f){(o.f&tn)===0&&Js(f,o)}i?.deactivate(),Sa()}).catch(d=>{Js(d,o)})}r.length>0?Promise.all(r).then(()=>{l();try{return c()}finally{i?.deactivate(),Sa()}}):c()}function u_(){var r=_e,e=ve,t=ut,n=He;return function(i=!0){Nr(r),Kt(e),Qs(t),i&&n?.activate()}}function Sa(){Nr(null),Kt(null),Qs(null)}function Ao(r){var e=vt|Wt,t=ve!==null&&(ve.f&vt)!==0?ve:null;return _e!==null&&(_e.f|=vi),{ctx:ut,deps:null,effects:null,equals:ig,f:e,fn:r,reactions:null,rv:0,v:St,wv:0,parent:t??_e,ac:null}}function d_(r,e){let t=_e;t===null&&C0();var n=t.b,s=void 0,i=gs(St),o=!ve,l=new Map;return __(()=>{var c=tg();s=c.promise;try{Promise.resolve(r()).then(c.resolve,c.reject).then(()=>{d===He&&d.committed&&d.deactivate(),Sa()})}catch(u){c.reject(u),Sa()}var d=He;if(o){var f=!n.is_pending();n.update_pending_count(1),d.increment(f),l.get(d)?.reject($s),l.delete(d),l.set(d,c)}const a=(u,h=void 0)=>{if(d.activate(),h)h!==$s&&(i.f|=kn,ei(i,h));else{(i.f&kn)!==0&&(i.f^=kn),ei(i,u);for(const[p,y]of l){if(l.delete(p),p===d)break;y.reject($s)}}o&&(n.update_pending_count(-1),d.decrement(f))};c.promise.then(a,u=>a(null,u||"unknown"))}),Zu(()=>{for(const c of l.values())c.reject($s)}),new Promise(c=>{function d(f){function a(){f===s?c(i):d(s)}f.then(a,a)}d(s)})}function ie(r){const e=Ao(r);return Pg(e),e}function to(r){const e=Ao(r);return e.equals=ag,e}function hg(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)zt(e[t])}}function f_(r){for(var e=r.parent;e!==null;){if((e.f&vt)===0)return(e.f&tn)===0?e:null;e=e.parent}return null}function Xu(r){var e,t=_e;Nr(f_(r));try{r.f&=~hs,hg(r),e=Bg(r)}finally{Nr(t)}return e}function pg(r){var e=Xu(r);if(r.equals(e)||(He?.is_fork||(r.v=e),r.wv=Lg()),!Is)if(lr!==null)(ro()||He?.is_fork)&&lr.set(r,e);else{var t=(r.f&Sr)===0?Br:Tt;Pt(r,t)}}let qc=new Set;const Cn=new Map;let gg=!1;function gs(r,e){var t={f:0,v:r,reactions:null,equals:ig,rv:0,wv:0};return t}function le(r,e){const t=gs(r);return Pg(t),t}function mg(r,e=!1,t=!0){const n=gs(r);return e||(n.equals=ag),xo&&t&&ut!==null&&ut.l!==null&&(ut.l.s??=[]).push(n),n}function X(r,e,t=!1){ve!==null&&(!Pr||(ve.f&Cf)!==0)&&wi()&&(ve.f&(vt|Or|Yu|Cf))!==0&&!rn?.includes(r)&&M0();let n=t?Qr(e):e;return ei(r,n)}function ei(r,e){if(!r.equals(e)){var t=r.v;Is?Cn.set(r,e):Cn.set(r,t),r.v=e;var n=Tr.ensure();n.capture(r,t),(r.f&vt)!==0&&((r.f&Wt)!==0&&Xu(r),Pt(r,(r.f&Sr)!==0?Tt:Br)),r.wv=Lg(),yg(r,Wt),wi()&&_e!==null&&(_e.f&Tt)!==0&&(_e.f&(dn|xs))===0&&(sr===null?x_([r]):sr.push(r)),!n.is_fork&&qc.size>0&&!gg&&h_()}return e}function h_(){gg=!1;var r=as;xa(!0);const e=Array.from(qc);try{for(const t of e)(t.f&Tt)!==0&&Pt(t,Br),Co(t)&&so(t)}finally{xa(r)}qc.clear()}function Wi(r){X(r,r.v+1)}function yg(r,e){var t=r.reactions;if(t!==null)for(var n=wi(),s=t.length,i=0;i<s;i++){var o=t[i],l=o.f;if(!(!n&&o===_e)){var c=(l&Wt)===0;if(c&&Pt(o,e),(l&vt)!==0){var d=o;lr?.delete(d),(l&hs)===0&&(l&Sr&&(o.f|=hs),yg(d,Br))}else c&&((l&Or)!==0&&zr!==null&&zr.add(o),ps(o))}}}function Qr(r){if(typeof r!="object"||r===null||is in r)return r;const e=Wu(r);if(e!==_0&&e!==S0)return r;var t=new Map,n=Qp(r),s=le(0),i=ls,o=l=>{if(ls===i)return l();var c=ve,d=ls;Kt(null),Lf(i);var f=l();return Kt(c),Lf(d),f};return n&&t.set("length",le(r.length)),new Proxy(r,{defineProperty(l,c,d){(!("value"in d)||d.configurable===!1||d.enumerable===!1||d.writable===!1)&&B0();var f=t.get(c);return f===void 0?f=o(()=>{var a=le(d.value);return t.set(c,a),a}):X(f,d.value,!0),!0},deleteProperty(l,c){var d=t.get(c);if(d===void 0){if(c in l){const f=o(()=>le(St));t.set(c,f),Wi(s)}}else X(d,St),Wi(s);return!0},get(l,c,d){if(c===is)return r;var f=t.get(c),a=c in l;if(f===void 0&&(!a||Hs(l,c)?.writable)&&(f=o(()=>{var h=Qr(a?l[c]:St),p=le(h);return p}),t.set(c,f)),f!==void 0){var u=b(f);return u===St?void 0:u}return Reflect.get(l,c,d)},getOwnPropertyDescriptor(l,c){var d=Reflect.getOwnPropertyDescriptor(l,c);if(d&&"value"in d){var f=t.get(c);f&&(d.value=b(f))}else if(d===void 0){var a=t.get(c),u=a?.v;if(a!==void 0&&u!==St)return{enumerable:!0,configurable:!0,value:u,writable:!0}}return d},has(l,c){if(c===is)return!0;var d=t.get(c),f=d!==void 0&&d.v!==St||Reflect.has(l,c);if(d!==void 0||_e!==null&&(!f||Hs(l,c)?.writable)){d===void 0&&(d=o(()=>{var u=f?Qr(l[c]):St,h=le(u);return h}),t.set(c,d));var a=b(d);if(a===St)return!1}return f},set(l,c,d,f){var a=t.get(c),u=c in l;if(n&&c==="length")for(var h=d;h<a.v;h+=1){var p=t.get(h+"");p!==void 0?X(p,St):h in l&&(p=o(()=>le(St)),t.set(h+"",p))}if(a===void 0)(!u||Hs(l,c)?.writable)&&(a=o(()=>le(void 0)),X(a,Qr(d)),t.set(c,a));else{u=a.v!==St;var y=o(()=>Qr(d));X(a,y)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g?.set&&g.set.call(f,d),!u){if(n&&typeof c=="string"){var m=t.get("length"),w=Number(c);Number.isInteger(w)&&w>=m.v&&X(m,w+1)}Wi(s)}return!0},ownKeys(l){b(s);var c=Reflect.ownKeys(l).filter(a=>{var u=t.get(a);return u===void 0||u.v!==St});for(var[d,f]of t)f.v!==St&&!(d in l)&&c.push(d);return c},setPrototypeOf(){N0()}})}var Xn,bg,vg,wg;function p_(){if(Xn===void 0){Xn=window,bg=/Firefox/.test(navigator.userAgent);var r=Element.prototype,e=Node.prototype,t=Text.prototype;vg=Hs(e,"firstChild").get,wg=Hs(e,"nextSibling").get,kf(r)&&(r.__click=void 0,r.__className=void 0,r.__attributes=null,r.__style=void 0,r.__e=void 0),kf(t)&&(t.__t=void 0)}}function Tn(r=""){return document.createTextNode(r)}function Ea(r){return vg.call(r)}function Io(r){return wg.call(r)}function O(r,e){return Ea(r)}function rt(r,e=!1){{var t=Ea(r);return t instanceof Comment&&t.data===""?Io(t):t}}function z(r,e=1,t=!1){let n=r;for(;e--;)n=Io(n);return n}function g_(r){r.textContent=""}function _g(){return!1}let Pf=!1;function m_(){Pf||(Pf=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function _i(r){var e=ve,t=_e;Kt(null),Nr(null);try{return r()}finally{Kt(e),Nr(t)}}function y_(r,e,t,n=t){r.addEventListener(e,()=>_i(t));const s=r.__on_r;s?r.__on_r=()=>{s(),n(!0)}:r.__on_r=()=>n(!0),m_()}function Sg(r){_e===null&&(ve===null&&D0(),P0()),Is&&T0()}function b_(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function $r(r,e,t){var n=_e;n!==null&&(n.f&er)!==0&&(r|=er);var s={ctx:ut,deps:null,nodes:null,f:r|Wt|Sr,first:null,fn:e,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{so(s),s.f|=Al}catch(l){throw zt(s),l}else e!==null&&ps(s);var i=s;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&(i.f&vi)===0&&(i=i.first,(r&Or)!==0&&(r&Mn)!==0&&i!==null&&(i.f|=Mn)),i!==null&&(i.parent=n,n!==null&&b_(i,n),ve!==null&&(ve.f&vt)!==0&&(r&xs)===0)){var o=ve;(o.effects??=[]).push(i)}return s}function ro(){return ve!==null&&!Pr}function Zu(r){const e=$r(El,null,!1);return Pt(e,Tt),e.teardown=r,e}function st(r){Sg();var e=_e.f,t=!ve&&(e&dn)!==0&&(e&Al)===0;if(t){var n=ut;(n.e??=[]).push(r)}else return Eg(r)}function Eg(r){return $r(Gu|ng,r,!1)}function v_(r){return Sg(),$r(El|ng,r,!0)}function w_(r){Tr.ensure();const e=$r(xs|vi,r,!0);return(t={})=>new Promise(n=>{t.outro?os(e,()=>{zt(e),n(void 0)}):(zt(e),n(void 0))})}function kl(r){return $r(Gu,r,!1)}function __(r){return $r(Yu|vi,r,!0)}function ju(r,e=0){return $r(El|e,r,!0)}function Te(r,e=[],t=[],n=[]){c_(n,e,t,s=>{$r(El,()=>r(...s.map(b)),!0)})}function ko(r,e=0){var t=$r(Or|e,r,!0);return t}function ar(r){return $r(dn|vi,r,!0)}function xg(r){var e=r.teardown;if(e!==null){const t=Is,n=ve;Df(!0),Kt(null);try{e.call(null)}finally{Df(t),Kt(n)}}}function Ag(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){const s=t.ac;s!==null&&_i(()=>{s.abort($s)});var n=t.next;(t.f&xs)!==0?t.parent=null:zt(t,e),t=n}}function S_(r){for(var e=r.first;e!==null;){var t=e.next;(e.f&dn)===0&&zt(e),e=t}}function zt(r,e=!0){var t=!1;(e||(r.f&rg)!==0)&&r.nodes!==null&&r.nodes.end!==null&&(E_(r.nodes.start,r.nodes.end),t=!0),Ag(r,e&&!t),Aa(r,0),Pt(r,tn);var n=r.nodes&&r.nodes.t;if(n!==null)for(const i of n)i.stop();xg(r);var s=r.parent;s!==null&&s.first!==null&&Ig(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes=r.ac=null}function E_(r,e){for(;r!==null;){var t=r===e?null:Io(r);r.remove(),r=t}}function Ig(r){var e=r.parent,t=r.prev,n=r.next;t!==null&&(t.next=n),n!==null&&(n.prev=t),e!==null&&(e.first===r&&(e.first=n),e.last===r&&(e.last=t))}function os(r,e,t=!0){var n=[];kg(r,n,!0);var s=()=>{t&&zt(r),e&&e()},i=n.length;if(i>0){var o=()=>--i||s();for(var l of n)l.out(o)}else s()}function kg(r,e,t){if((r.f&er)===0){r.f^=er;var n=r.nodes&&r.nodes.t;if(n!==null)for(const l of n)(l.is_global||t)&&e.push(l);for(var s=r.first;s!==null;){var i=s.next,o=(s.f&Mn)!==0||(s.f&dn)!==0&&(r.f&Or)!==0;kg(s,e,o?t:!1),s=i}}}function Qu(r){Cg(r,!0)}function Cg(r,e){if((r.f&er)!==0){r.f^=er,(r.f&Tt)===0&&(Pt(r,Wt),ps(r));for(var t=r.first;t!==null;){var n=t.next,s=(t.f&Mn)!==0||(t.f&dn)!==0;Cg(t,s?e:!1),t=n}var i=r.nodes&&r.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Tg(r,e){if(r.nodes)for(var t=r.nodes.start,n=r.nodes.end;t!==null;){var s=t===n?null:Io(t);e.append(t),t=s}}let as=!1;function xa(r){as=r}let Is=!1;function Df(r){Is=r}let ve=null,Pr=!1;function Kt(r){ve=r}let _e=null;function Nr(r){_e=r}let rn=null;function Pg(r){ve!==null&&(rn===null?rn=[r]:rn.push(r))}let Rt=null,Yt=0,sr=null;function x_(r){sr=r}let Dg=1,no=0,ls=no;function Lf(r){ls=r}function Lg(){return++Dg}function Co(r){var e=r.f;if((e&Wt)!==0)return!0;if(e&vt&&(r.f&=~hs),(e&Br)!==0){var t=r.deps;if(t!==null)for(var n=t.length,s=0;s<n;s++){var i=t[s];if(Co(i)&&pg(i),i.wv>r.wv)return!0}(e&Sr)!==0&&lr===null&&Pt(r,Tt)}return!1}function Rg(r,e,t=!0){var n=r.reactions;if(n!==null&&!rn?.includes(r))for(var s=0;s<n.length;s++){var i=n[s];(i.f&vt)!==0?Rg(i,e,!1):e===i&&(t?Pt(i,Wt):(i.f&Tt)!==0&&Pt(i,Br),ps(i))}}function Bg(r){var e=Rt,t=Yt,n=sr,s=ve,i=rn,o=ut,l=Pr,c=ls,d=r.f;Rt=null,Yt=0,sr=null,ve=(d&(dn|xs))===0?r:null,rn=null,Qs(r.ctx),Pr=!1,ls=++no,r.ac!==null&&(_i(()=>{r.ac.abort($s)}),r.ac=null);try{r.f|=Vc;var f=r.fn,a=f(),u=r.deps;if(Rt!==null){var h;if(Aa(r,Yt),u!==null&&Yt>0)for(u.length=Yt+Rt.length,h=0;h<Rt.length;h++)u[Yt+h]=Rt[h];else r.deps=u=Rt;if(ro()&&(r.f&Sr)!==0)for(h=Yt;h<u.length;h++)(u[h].reactions??=[]).push(r)}else u!==null&&Yt<u.length&&(Aa(r,Yt),u.length=Yt);if(wi()&&sr!==null&&!Pr&&u!==null&&(r.f&(vt|Br|Wt))===0)for(h=0;h<sr.length;h++)Rg(sr[h],r);return s!==null&&s!==r&&(no++,sr!==null&&(n===null?n=sr:n.push(...sr))),(r.f&kn)!==0&&(r.f^=kn),a}catch(p){return cg(p)}finally{r.f^=Vc,Rt=e,Yt=t,sr=n,ve=s,rn=i,Qs(o),Pr=l,ls=c}}function A_(r,e){let t=e.reactions;if(t!==null){var n=w0.call(t,r);if(n!==-1){var s=t.length-1;s===0?t=e.reactions=null:(t[n]=t[s],t.pop())}}t===null&&(e.f&vt)!==0&&(Rt===null||!Rt.includes(e))&&(Pt(e,Br),(e.f&Sr)!==0&&(e.f^=Sr,e.f&=~hs),hg(e),Aa(e,0))}function Aa(r,e){var t=r.deps;if(t!==null)for(var n=e;n<t.length;n++)A_(r,t[n])}function so(r){var e=r.f;if((e&tn)===0){Pt(r,Tt);var t=_e,n=as;_e=r,as=!0;try{(e&(Or|A0))!==0?S_(r):Ag(r),xg(r);var s=Bg(r);r.teardown=typeof s=="function"?s:null,r.wv=Dg;var i;Uc&&e_&&(r.f&Wt)!==0&&r.deps}finally{as=n,_e=t}}}async function I_(){await Promise.resolve(),n_()}function b(r){var e=r.f,t=(e&vt)!==0;if(ve!==null&&!Pr){var n=_e!==null&&(_e.f&tn)!==0;if(!n&&!rn?.includes(r)){var s=ve.deps;if((ve.f&Vc)!==0)r.rv<no&&(r.rv=no,Rt===null&&s!==null&&s[Yt]===r?Yt++:Rt===null?Rt=[r]:Rt.includes(r)||Rt.push(r));else{(ve.deps??=[]).push(r);var i=r.reactions;i===null?r.reactions=[ve]:i.includes(ve)||i.push(ve)}}}if(Is){if(Cn.has(r))return Cn.get(r);if(t){var o=r,l=o.v;return((o.f&Tt)===0&&o.reactions!==null||Mg(o))&&(l=Xu(o)),Cn.set(o,l),l}}else t&&(!lr?.has(r)||He?.is_fork&&!ro())&&(o=r,Co(o)&&pg(o),as&&ro()&&(o.f&Sr)===0&&Ng(o));if(lr?.has(r))return lr.get(r);if((r.f&kn)!==0)throw r.v;return r.v}function Ng(r){if(r.deps!==null){r.f^=Sr;for(const e of r.deps)(e.reactions??=[]).push(r),(e.f&vt)!==0&&(e.f&Sr)===0&&Ng(e)}}function Mg(r){if(r.v===St)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(Cn.has(e)||(e.f&vt)!==0&&Mg(e))return!0;return!1}function ct(r){var e=Pr;try{return Pr=!0,r()}finally{Pr=e}}const k_=-7169;function Pt(r,e){r.f=r.f&k_|e}function C_(r,e){var t={};for(var n in r)e.includes(n)||(t[n]=r[n]);for(var s of Object.getOwnPropertySymbols(r))Object.propertyIsEnumerable.call(r,s)&&!e.includes(s)&&(t[s]=r[s]);return t}function T_(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(is in r)Hc(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&is in t&&Hc(t)}}}function Hc(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let n in r)try{Hc(r[n],e)}catch{}const t=Wu(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const n=eg(t);for(let s in n){const i=n[s].get;if(i)try{i.call(r)}catch{}}}}}const P_=["touchstart","touchmove"];function D_(r){return P_.includes(r)}const Og=new Set,zc=new Set;function L_(r,e,t,n={}){function s(i){if(n.capture||$i.call(e,i),!i.cancelBubble)return _i(()=>t?.call(this,i))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?As(()=>{e.addEventListener(r,s,n)}):e.addEventListener(r,s,n),s}function vr(r,e,t,n,s){var i={capture:n,passive:s},o=L_(r,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Zu(()=>{e.removeEventListener(r,o,i)})}function Fr(r){for(var e=0;e<r.length;e++)Og.add(r[e]);for(var t of zc)t(r)}let Rf=null;function $i(r){var e=this,t=e.ownerDocument,n=r.type,s=r.composedPath?.()||[],i=s[0]||r.target;Rf=r;var o=0,l=Rf===r&&r.__root;if(l){var c=s.indexOf(l);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var d=s.indexOf(e);if(d===-1)return;c<=d&&(o=c)}if(i=s[o]||r.target,i!==e){Jp(r,"currentTarget",{configurable:!0,get(){return i||t}});var f=ve,a=_e;Kt(null),Nr(null);try{for(var u,h=[];i!==null;){var p=i.assignedSlot||i.parentNode||i.host||null;try{var y=i["__"+n];y!=null&&(!i.disabled||r.target===i)&&y.call(i,r)}catch(g){u?h.push(g):u=g}if(r.cancelBubble||p===e||p===null)break;i=p}if(u){for(let g of h)queueMicrotask(()=>{throw g});throw u}}finally{r.__root=e,delete r.currentTarget,Kt(f),Nr(a)}}}function R_(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function Wc(r,e){var t=_e;t.nodes===null&&(t.nodes={start:r,end:e,a:null,t:null})}function se(r,e){var t=(e&Z0)!==0,n=(e&j0)!==0,s,i=!r.startsWith("<!>");return()=>{s===void 0&&(s=R_(i?r:"<!>"+r),t||(s=Ea(s)));var o=n||bg?document.importNode(s,!0):s.cloneNode(!0);if(t){var l=Ea(o),c=o.lastChild;Wc(l,c)}else Wc(o,o);return o}}function Xr(){var r=document.createDocumentFragment(),e=document.createComment(""),t=Tn();return r.append(e,t),Wc(e,t),r}function J(r,e){r!==null&&r.before(e)}let Gc=!0;function ze(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??=r.nodeValue)&&(r.__t=t,r.nodeValue=t+"")}function B_(r,e){return N_(r,e)}const Ps=new Map;function N_(r,{target:e,anchor:t,props:n={},events:s,context:i,intro:o=!0}){p_();var l=new Set,c=a=>{for(var u=0;u<a.length;u++){var h=a[u];if(!l.has(h)){l.add(h);var p=D_(h);e.addEventListener(h,$i,{passive:p});var y=Ps.get(h);y===void 0?(document.addEventListener(h,$i,{passive:p}),Ps.set(h,1)):Ps.set(h,y+1)}}};c(Sl(Og)),zc.add(c);var d=void 0,f=w_(()=>{var a=t??e.appendChild(Tn());return a_(a,{pending:()=>{}},u=>{if(i){dt({});var h=ut;h.c=i}s&&(n.$$events=s),Gc=o,d=r(u,n)||{},Gc=!0,i&&ft()}),()=>{for(var u of l){e.removeEventListener(u,$i);var h=Ps.get(u);--h===0?(document.removeEventListener(u,$i),Ps.delete(u)):Ps.set(u,h)}zc.delete(c),a!==t&&a.parentNode?.removeChild(a)}});return M_.set(d,f),d}let M_=new WeakMap;class Ju{anchor;#e=new Map;#t=new Map;#r=new Map;#n=new Set;#o=!0;constructor(e,t=!0){this.anchor=e,this.#o=t}#a=()=>{var e=He;if(this.#e.has(e)){var t=this.#e.get(e),n=this.#t.get(t);if(n)Qu(n),this.#n.delete(t);else{var s=this.#r.get(t);s&&(this.#t.set(t,s.effect),this.#r.delete(t),s.fragment.lastChild.remove(),this.anchor.before(s.fragment),n=s.effect)}for(const[i,o]of this.#e){if(this.#e.delete(i),i===e)break;const l=this.#r.get(o);l&&(zt(l.effect),this.#r.delete(o))}for(const[i,o]of this.#t){if(i===t||this.#n.has(i))continue;const l=()=>{if(Array.from(this.#e.values()).includes(i)){var d=document.createDocumentFragment();Tg(o,d),d.append(Tn()),this.#r.set(i,{effect:o,fragment:d})}else zt(o);this.#n.delete(i),this.#t.delete(i)};this.#o||!n?(this.#n.add(i),os(o,l,!1)):l()}}};#s=e=>{this.#e.delete(e);const t=Array.from(this.#e.values());for(const[n,s]of this.#r)t.includes(n)||(zt(s.effect),this.#r.delete(n))};ensure(e,t){var n=He,s=_g();if(t&&!this.#t.has(e)&&!this.#r.has(e))if(s){var i=document.createDocumentFragment(),o=Tn();i.append(o),this.#r.set(e,{effect:ar(()=>t(o)),fragment:i})}else this.#t.set(e,ar(()=>t(this.anchor)));if(this.#e.set(n,e),s){for(const[l,c]of this.#t)l===e?n.skipped_effects.delete(c):n.skipped_effects.add(c);for(const[l,c]of this.#r)l===e?n.skipped_effects.delete(c.effect):n.skipped_effects.add(c.effect);n.oncommit(this.#a),n.ondiscard(this.#s)}else this.#a()}}function we(r,e,t=!1){var n=new Ju(r),s=t?Mn:0;function i(o,l){n.ensure(o,l)}ko(()=>{var o=!1;e((l,c=!0)=>{o=!0,i(c,l)}),o||i(!1,null)},s)}function O_(r,e,t){var n=new Ju(r),s=!wi();ko(()=>{var i=e();s&&i!==null&&typeof i=="object"&&(i={}),n.ensure(i,t)})}function ti(r,e){return e}function $_(r,e,t){for(var n=[],s=e.length,i,o=e.length,l=0;l<s;l++){let a=e[l];os(a,()=>{if(i){if(i.pending.delete(a),i.done.add(a),i.pending.size===0){var u=r.outrogroups;Yc(Sl(i.done)),u.delete(i),u.size===0&&(r.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=n.length===0&&t!==null;if(c){var d=t,f=d.parentNode;g_(f),f.append(d),r.items.clear()}Yc(e,!c)}else i={pending:new Set(e),done:new Set},(r.outrogroups??=new Set).add(i)}function Yc(r,e=!0){for(var t=0;t<r.length;t++)zt(r[t],e)}var Bf;function Pn(r,e,t,n,s,i=null){var o=r,l=new Map,c=(e&sg)!==0;if(c){var d=r;o=d.appendChild(Tn())}var f=null,a=to(()=>{var m=t();return Qp(m)?m:m==null?[]:Sl(m)}),u,h=!0;function p(){g.fallback=f,F_(g,u,o,e,n),f!==null&&(u.length===0?(f.f&jr)===0?Qu(f):(f.f^=jr,Fi(f,null,o)):os(f,()=>{f=null}))}var y=ko(()=>{u=b(a);for(var m=u.length,w=new Set,v=He,_=_g(),k=0;k<m;k+=1){var P=u[k],D=n(P,k),I=h?null:l.get(D);I?(I.v&&ei(I.v,P),I.i&&ei(I.i,k),_&&v.skipped_effects.delete(I.e)):(I=U_(l,h?o:Bf??=Tn(),P,D,k,s,e,t),h||(I.e.f|=jr),l.set(D,I)),w.add(D)}if(m===0&&i&&!f&&(h?f=ar(()=>i(o)):(f=ar(()=>i(Bf??=Tn())),f.f|=jr)),!h)if(_){for(const[x,B]of l)w.has(x)||v.skipped_effects.add(B.e);v.oncommit(p),v.ondiscard(()=>{})}else p();b(a)}),g={effect:y,items:l,outrogroups:null,fallback:f};h=!1}function F_(r,e,t,n,s){var i=(n&U0)!==0,o=e.length,l=r.items,c=r.effect.first,d,f=null,a,u=[],h=[],p,y,g,m;if(i)for(m=0;m<o;m+=1)p=e[m],y=s(p,m),g=l.get(y).e,(g.f&jr)===0&&(g.nodes?.a?.measure(),(a??=new Set).add(g));for(m=0;m<o;m+=1){if(p=e[m],y=s(p,m),g=l.get(y).e,r.outrogroups!==null)for(const B of r.outrogroups)B.pending.delete(g),B.done.delete(g);if((g.f&jr)!==0)if(g.f^=jr,g===c)Fi(g,null,t);else{var w=f?f.next:c;g===r.effect.last&&(r.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),mn(r,f,g),mn(r,g,w),Fi(g,w,t),f=g,u=[],h=[],c=f.next;continue}if((g.f&er)!==0&&(Qu(g),i&&(g.nodes?.a?.unfix(),(a??=new Set).delete(g))),g!==c){if(d!==void 0&&d.has(g)){if(u.length<h.length){var v=h[0],_;f=v.prev;var k=u[0],P=u[u.length-1];for(_=0;_<u.length;_+=1)Fi(u[_],v,t);for(_=0;_<h.length;_+=1)d.delete(h[_]);mn(r,k.prev,P.next),mn(r,f,k),mn(r,P,v),c=v,f=P,m-=1,u=[],h=[]}else d.delete(g),Fi(g,c,t),mn(r,g.prev,g.next),mn(r,g,f===null?r.effect.first:f.next),mn(r,f,g),f=g;continue}for(u=[],h=[];c!==null&&c!==g;)(d??=new Set).add(c),h.push(c),c=c.next;if(c===null)continue}(g.f&jr)===0&&u.push(g),f=g,c=g.next}if(r.outrogroups!==null){for(const B of r.outrogroups)B.pending.size===0&&(Yc(Sl(B.done)),r.outrogroups?.delete(B));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||d!==void 0){var D=[];if(d!==void 0)for(g of d)(g.f&er)===0&&D.push(g);for(;c!==null;)(c.f&er)===0&&c!==r.fallback&&D.push(c),c=c.next;var I=D.length;if(I>0){var x=(n&sg)!==0&&o===0?t:null;if(i){for(m=0;m<I;m+=1)D[m].nodes?.a?.measure();for(m=0;m<I;m+=1)D[m].nodes?.a?.fix()}$_(r,D,x)}}i&&As(()=>{if(a!==void 0)for(g of a)g.nodes?.a?.apply()})}function U_(r,e,t,n,s,i,o,l){var c=(o&$0)!==0?(o&V0)===0?mg(t,!1,!1):gs(t):null,d=(o&F0)!==0?gs(s):null;return{v:c,i:d,e:ar(()=>(i(e,c??t,d??s,l),()=>{r.delete(n)}))}}function Fi(r,e,t){if(r.nodes)for(var n=r.nodes.start,s=r.nodes.end,i=e&&(e.f&jr)===0?e.nodes.start:t;n!==null;){var o=Io(n);if(i.before(n),n===s)return;n=o}}function mn(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function $g(r,e,...t){var n=new Ju(r);ko(()=>{const s=e()??null;n.ensure(s,s&&(i=>s(i,...t)))},Mn)}const V_=()=>performance.now(),Zr={tick:r=>requestAnimationFrame(r),now:()=>V_(),tasks:new Set};function Fg(){const r=Zr.now();Zr.tasks.forEach(e=>{e.c(r)||(Zr.tasks.delete(e),e.f())}),Zr.tasks.size!==0&&Zr.tick(Fg)}function K_(r){let e;return Zr.tasks.size===0&&Zr.tick(Fg),{promise:new Promise(t=>{Zr.tasks.add(e={c:r,f:t})}),abort(){Zr.tasks.delete(e)}}}function Go(r,e){_i(()=>{r.dispatchEvent(new CustomEvent(e))})}function q_(r){if(r==="float")return"cssFloat";if(r==="offset")return"cssOffset";if(r.startsWith("--"))return r;const e=r.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function Nf(r){const e={},t=r.split(";");for(const n of t){const[s,i]=n.split(":");if(!s||i===void 0)break;const o=q_(s.trim());e[o]=i.trim()}return e}const H_=r=>r;function xe(r,e,t,n){var s=(r&G0)!==0,i=(r&Y0)!==0,o=s&&i,l=(r&X0)!==0,c=o?"both":s?"in":"out",d,f=e.inert,a=e.style.overflow,u,h;function p(){return _i(()=>d??=t()(e,n?.()??{},{direction:c}))}var y={is_global:l,in(){if(e.inert=f,!s){h?.abort(),h?.reset?.();return}i||u?.abort(),Go(e,"introstart"),u=Xc(e,p(),h,1,()=>{Go(e,"introend"),u?.abort(),u=d=void 0,e.style.overflow=a})},out(v){if(!i){v?.(),d=void 0;return}e.inert=!0,Go(e,"outrostart"),h=Xc(e,p(),u,0,()=>{Go(e,"outroend"),v?.()})},stop:()=>{u?.abort(),h?.abort()}},g=_e;if((g.nodes.t??=[]).push(y),s&&Gc){var m=l;if(!m){for(var w=g.parent;w&&(w.f&Mn)!==0;)for(;(w=w.parent)&&(w.f&Or)===0;);m=!w||(w.f&Al)!==0}m&&kl(()=>{ct(()=>y.in())})}}function Xc(r,e,t,n,s){var i=n===1;if(E0(e)){var o,l=!1;return As(()=>{if(!l){var g=e({direction:i?"in":"out"});o=Xc(r,g,t,n,s)}}),{abort:()=>{l=!0,o?.abort()},deactivate:()=>o.deactivate(),reset:()=>o.reset(),t:()=>o.t()}}if(t?.deactivate(),!e?.duration)return s(),{abort:Vt,deactivate:Vt,reset:Vt,t:()=>n};const{delay:c=0,css:d,tick:f,easing:a=H_}=e;var u=[];if(i&&t===void 0&&(f&&f(0,1),d)){var h=Nf(d(0,1));u.push(h,h)}var p=()=>1-n,y=r.animate(u,{duration:c,fill:"forwards"});return y.onfinish=()=>{y.cancel();var g=t?.t()??1-n;t?.abort();var m=n-g,w=e.duration*Math.abs(m),v=[];if(w>0){var _=!1;if(d)for(var k=Math.ceil(w/16.666666666666668),P=0;P<=k;P+=1){var D=g+m*a(P/k),I=Nf(d(D,1-D));v.push(I),_||=I.overflow==="hidden"}_&&(r.style.overflow="hidden"),p=()=>{var x=y.currentTime;return g+m*a(x/w)},f&&K_(()=>{if(y.playState!=="running")return!1;var x=p();return f(x,1-x),!0})}y=r.animate(v,{duration:w,fill:"forwards"}),y.onfinish=()=>{p=()=>n,f?.(n,1-n),s()}},{abort:()=>{y&&(y.cancel(),y.effect=null,y.onfinish=Vt)},deactivate:()=>{s=Vt},reset:()=>{n===0&&f?.(1,0)},t:()=>p()}}function Ug(r,e,t){kl(()=>{var n=ct(()=>e(r,t?.())||{});if(n?.destroy)return()=>n.destroy()})}function Vg(r){var e,t,n="";if(typeof r=="string"||typeof r=="number")n+=r;else if(typeof r=="object")if(Array.isArray(r)){var s=r.length;for(e=0;e<s;e++)r[e]&&(t=Vg(r[e]))&&(n&&(n+=" "),n+=t)}else for(t in r)r[t]&&(n&&(n+=" "),n+=t);return n}function z_(){for(var r,e,t=0,n="",s=arguments.length;t<s;t++)(r=arguments[t])&&(e=Vg(r))&&(n&&(n+=" "),n+=e);return n}function Kg(r){return typeof r=="object"?z_(r):r??""}const Mf=[...` 	
\r\fÂ \v\uFEFF`];function W_(r,e,t){var n=r==null?"":""+r;if(e&&(n=n?n+" "+e:e),t){for(var s in t)if(t[s])n=n?n+" "+s:s;else if(n.length)for(var i=s.length,o=0;(o=n.indexOf(s,o))>=0;){var l=o+i;(o===0||Mf.includes(n[o-1]))&&(l===n.length||Mf.includes(n[l]))?n=(o===0?"":n.substring(0,o))+n.substring(l+1):o=l}}return n===""?null:n}function Of(r,e=!1){var t=e?" !important;":";",n="";for(var s in r){var i=r[s];i!=null&&i!==""&&(n+=" "+s+": "+i+t)}return n}function tc(r){return r[0]!=="-"||r[1]!=="-"?r.toLowerCase():r}function G_(r,e){if(e){var t="",n,s;if(Array.isArray(e)?(n=e[0],s=e[1]):n=e,r){r=String(r).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var i=!1,o=0,l=!1,c=[];n&&c.push(...Object.keys(n).map(tc)),s&&c.push(...Object.keys(s).map(tc));var d=0,f=-1;const y=r.length;for(var a=0;a<y;a++){var u=r[a];if(l?u==="/"&&r[a-1]==="*"&&(l=!1):i?i===u&&(i=!1):u==="/"&&r[a+1]==="*"?l=!0:u==='"'||u==="'"?i=u:u==="("?o++:u===")"&&o--,!l&&i===!1&&o===0){if(u===":"&&f===-1)f=a;else if(u===";"||a===y-1){if(f!==-1){var h=tc(r.substring(d,f).trim());if(!c.includes(h)){u!==";"&&a++;var p=r.substring(d,a).trim();t+=" "+p+";"}}d=a+1,f=-1}}}}return n&&(t+=Of(n)),s&&(t+=Of(s,!0)),t=t.trim(),t===""?null:t}return r==null?null:String(r)}function Ue(r,e,t,n,s,i){var o=r.__className;if(o!==t||o===void 0){var l=W_(t,n,i);l==null?r.removeAttribute("class"):r.className=l,r.__className=t}else if(i&&s!==i)for(var c in i){var d=!!i[c];(s==null||d!==!!s[c])&&r.classList.toggle(c,d)}return i}function rc(r,e={},t,n){for(var s in t){var i=t[s];e[s]!==i&&(t[s]==null?r.style.removeProperty(s):r.style.setProperty(s,i,n))}}function kt(r,e,t,n){var s=r.__style;if(s!==e){var i=G_(e,n);i==null?r.removeAttribute("style"):r.style.cssText=i,r.__style=e}else n&&(Array.isArray(n)?(rc(r,t?.[0],n[0]),rc(r,t?.[1],n[1],"important")):rc(r,t,n));return n}const Y_=Symbol("is custom element"),X_=Symbol("is html");function Zc(r,e){var t=ed(r);t.value===(t.value=e??void 0)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e??"")}function Z_(r,e){var t=ed(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function Dn(r,e,t,n){var s=ed(r);s[e]!==(s[e]=t)&&(e==="loading"&&(r[k0]=t),t==null?r.removeAttribute(e):typeof t!="string"&&j_(r).includes(e)?r[e]=t:r.setAttribute(e,t))}function ed(r){return r.__attributes??={[Y_]:r.nodeName.includes("-"),[X_]:r.namespaceURI===Q0}}var $f=new Map;function j_(r){var e=r.getAttribute("is")||r.nodeName,t=$f.get(e);if(t)return t;$f.set(e,t=[]);for(var n,s=r,i=Element.prototype;i!==s;){n=eg(s);for(var o in n)n[o].set&&t.push(o);s=Wu(s)}return t}function Ff(r,e,t=e){y_(r,"change",n=>{var s=n?r.defaultChecked:r.checked;t(s)}),ct(e)==null&&t(r.checked),ju(()=>{var n=e();r.checked=!!n})}class td{#e=new WeakMap;#t;#r;static entries=new WeakMap;constructor(e){this.#r=e}observe(e,t){var n=this.#e.get(e)||new Set;return n.add(t),this.#e.set(e,n),this.#n().observe(e,this.#r),()=>{var s=this.#e.get(e);s.delete(t),s.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#n(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var t of e){td.entries.set(t.target,t);for(var n of this.#e.get(t.target)||[])n(t)}}))}}var Q_=new td({box:"border-box"});function Uf(r,e,t){var n=Q_.observe(r,()=>t(r[e]));kl(()=>(ct(()=>t(r[e])),n))}function Vf(r,e){return r===e||r?.[is]===e}function Ze(r={},e,t,n){return kl(()=>{var s,i;return ju(()=>{s=i,i=[],ct(()=>{r!==t(...i)&&(e(r,...i),s&&Vf(t(...s),r)&&e(null,...s))})}),()=>{As(()=>{i&&Vf(t(...i),r)&&e(null,...i)})}}),r}function J_(r=!1){const e=ut,t=e.l.u;if(!t)return;let n=()=>T_(e.s);if(r){let s=0,i={};const o=Ao(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==i[d]&&(i[d]=c[d],l=!0);return l&&s++,s});n=()=>b(o)}t.b.length&&v_(()=>{Kf(e,n),_a(t.b)}),st(()=>{const s=ct(()=>t.m.map(x0));return()=>{for(const i of s)typeof i=="function"&&i()}}),t.a.length&&st(()=>{Kf(e,n),_a(t.a)})}function Kf(r,e){if(r.l.s)for(const t of r.l.s)b(t);e()}function rd(r,e,t){if(r==null)return e(void 0),t&&t(void 0),Vt;const n=ct(()=>r.subscribe(e,t));return n.unsubscribe?()=>n.unsubscribe():n}const Ds=[];function Ui(r,e){return{subscribe:ir(r,e).subscribe}}function ir(r,e=Vt){let t=null;const n=new Set;function s(l){if(og(r,l)&&(r=l,t)){const c=!Ds.length;for(const d of n)d[1](),Ds.push(d,r);if(c){for(let d=0;d<Ds.length;d+=2)Ds[d][0](Ds[d+1]);Ds.length=0}}}function i(l){s(l(r))}function o(l,c=Vt){const d=[l,c];return n.add(d),n.size===1&&(t=e(s,i)||Vt),l(r),()=>{n.delete(d),n.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:o}}function e1(r,e,t){const n=!Array.isArray(r),s=n?[r]:r;if(!s.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const i=e.length<2;return Ui(t,(o,l)=>{let c=!1;const d=[];let f=0,a=Vt;const u=()=>{if(f)return;a();const p=e(n?d[0]:d,o,l);i?o(p):a=typeof p=="function"?p:Vt},h=s.map((p,y)=>rd(p,g=>{d[y]=g,f&=~(1<<y),c&&u()},()=>{f|=1<<y}));return c=!0,u(),function(){_a(h),a(),c=!1}})}function Si(r){let e;return rd(r,t=>e=t)(),e}let Yo=!1,jc=Symbol();function fe(r,e,t){const n=t[e]??={store:null,source:mg(void 0),unsubscribe:Vt};if(n.store!==r&&!(jc in t))if(n.unsubscribe(),n.store=r??null,r==null)n.source.v=void 0,n.unsubscribe=Vt;else{var s=!0;n.unsubscribe=rd(r,i=>{s?n.source.v=i:X(n.source,i)}),s=!1}return r&&jc in t?Si(r):b(n.source)}function Nt(r,e){return r.set(e),e}function tr(){const r={};function e(){Zu(()=>{for(var t in r)r[t].unsubscribe();Jp(r,jc,{enumerable:!1,value:!0})})}return[r,e]}function ha(r,e,t){return r.set(t),e}function t1(r){var e=Yo;try{return Yo=!1,[r(),Yo]}finally{Yo=e}}function Jr(r,e,t,n){var s=!xo||(t&q0)!==0,i=(t&z0)!==0,o=(t&W0)!==0,l=n,c=!0,d=()=>(c&&(c=!1,l=o?ct(n):n),l),f;if(i){var a=is in r||I0 in r;f=Hs(r,e)?.set??(a&&e in r?v=>r[e]=v:void 0)}var u,h=!1;i?[u,h]=t1(()=>r[e]):u=r[e],u===void 0&&n!==void 0&&(u=d(),f&&(s&&R0(),f(u)));var p;if(s?p=()=>{var v=r[e];return v===void 0?d():(c=!0,v)}:p=()=>{var v=r[e];return v!==void 0&&(l=void 0),v===void 0?l:v},s&&(t&H0)===0)return p;if(f){var y=r.$$legacy;return(function(v,_){return arguments.length>0?((!s||!_||y||h)&&f(_?p():v),v):p()})}var g=!1,m=((t&K0)!==0?Ao:to)(()=>(g=!1,p()));i&&b(m);var w=_e;return(function(v,_){if(arguments.length>0){const k=_?b(m):s&&i?Qr(v):v;return X(m,k),g=!0,l!==void 0&&(l=k),v}return Is&&g||(w.f&tn)!==0?m.v:b(m)})}const r1="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(r1);class n1{data;indexes;#e;#t;#r;constructor({data:e=[],maxSize:t=1/0,compare:n=(i,o)=>i<o?-1:i>o?1:0,extractKey:s=i=>i}={}){if(this.data=e,this.indexes=new Map(e.map((i,o)=>[s(i),o])),this.#e=t,this.#t=n,this.#r=s,e.length>0)for(let i=(e.length>>>1)-1;i>=0;i--)this.#o(i)}#n(e){const{data:t,indexes:n}=this,s=this.#t,i=this.#r,o=t[e];for(;e>0;){const l=e-1>>>1,c=t[l];if(s(o,c)>=0)break;n.set(i(c),e),t[e]=c,e=l}n.set(i(o),e),t[e]=o}#o(e){const{data:t,indexes:n}=this,s=this.#t,i=this.#r,o=t[e],l=t.length>>>1;for(;e<l;){let c=(e<<1)+1,d=t[c];const f=c+1;if(f<t.length){const a=t[f];s(a,d)<0&&(c=f,d=a)}if(s(d,o)>=0)break;n.set(i(d),e),t[e]=d,e=c}n.set(i(o),e),t[e]=o}push(e){const t=this.#r(e),n=this.indexes.get(t);if(n===void 0)return this.data.push(e),this.#n(this.data.length-1),this.data.length<=this.#e?void 0:this.pop();const s=this.data[n];this.data[n]=e;const i=this.#t(s,e);i<0?this.#o(n):i>0&&this.#n(n)}pop(){if(this.data.length===0)return;const e=this.data[0];this.indexes.delete(this.#r(e));const t=this.data.pop();return this.data.length>0&&t!==void 0&&(this.indexes.set(this.#r(t),0),this.data[0]=t,this.#o(0)),e}peek(){return this.data[0]}remove(e){const t=this.indexes.get(e);if(t===void 0)return!1;const n=this.data.length-1;if(t===n)return this.indexes.delete(e),this.data.pop(),!0;const s=this.data.pop();this.indexes.delete(e),this.indexes.set(this.#r(s),t),this.data[t]=s;const i=t-1>>>1;return t>0&&this.#t(s,this.data[i])<0?this.#n(t):this.#o(t),!0}has(e){return this.indexes.has(e)}get(e){const t=this.indexes.get(e);return t!==void 0?this.data[t]:void 0}clear(){this.data=[],this.indexes.clear()}get size(){return this.data.length}*[Symbol.iterator](){yield*this.data}}function s1(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Cl(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function i1(r){return new TextEncoder().encode(r)}function o1(r){return new TextDecoder().decode(r)}function a1(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var l=r.length,c=r.charAt(0),d=Math.log(l)/Math.log(256),f=Math.log(256)/Math.log(l);function a(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var y=0,g=0,m=0,w=p.length;m!==w&&p[m]===0;)m++,y++;for(var v=(w-m)*f+1>>>0,_=new Uint8Array(v);m!==w;){for(var k=p[m],P=0,D=v-1;(k!==0||P<g)&&D!==-1;D--,P++)k+=256*_[D]>>>0,_[D]=k%l>>>0,k=k/l>>>0;if(k!==0)throw new Error("Non-zero carry");g=P,m++}for(var I=v-g;I!==v&&_[I]===0;)I++;for(var x=c.repeat(y);I<v;++I)x+=r.charAt(_[I]);return x}function u(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var y=0;if(p[y]!==" "){for(var g=0,m=0;p[y]===c;)g++,y++;for(var w=(p.length-y)*d+1>>>0,v=new Uint8Array(w);p[y];){var _=t[p.charCodeAt(y)];if(_===255)return;for(var k=0,P=w-1;(_!==0||k<m)&&P!==-1;P--,k++)_+=l*v[P]>>>0,v[P]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");m=k,y++}if(p[y]!==" "){for(var D=w-m;D!==w&&v[D]===0;)D++;for(var I=new Uint8Array(g+(w-D)),x=g;D!==w;)I[x++]=v[D++];return I}}}function h(p){var y=u(p);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:a,decodeUnsafe:u,decode:h}}var l1=a1,c1=l1;class u1{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}let d1=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return qg(this,e)}};class f1{decoders;constructor(e){this.decoders=e}or(e){return qg(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function qg(r,e){return new f1({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class h1{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new u1(e,t,n),this.decoder=new d1(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function Tl({name:r,prefix:e,encode:t,decode:n}){return new h1(r,e,t,n)}function To({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=c1(t,r);return Tl({prefix:e,name:r,encode:n,decode:i=>Cl(s(i))})}function p1(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,l=0,c=0;for(let d=0;d<s;++d){const f=e[r[d]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);l=l<<t|f,o+=t,o>=8&&(o-=8,i[c++]=255&l>>o)}if(o>=t||(255&l<<8-o)!==0)throw new SyntaxError("Unexpected end of data");return i}function g1(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,l=0;for(let c=0;c<r.length;++c)for(l=l<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&l>>o];if(o!==0&&(i+=e[s&l<<t-o]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function m1(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function wt({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=m1(n);return Tl({prefix:e,name:r,encode(i){return g1(i,n,t)},decode(i){return p1(i,s,t,r)}})}const y1=To({prefix:"9",name:"base10",alphabet:"0123456789"}),b1=Object.freeze(Object.defineProperty({__proto__:null,base10:y1},Symbol.toStringTag,{value:"Module"})),v1=wt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),w1=wt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),_1=Object.freeze(Object.defineProperty({__proto__:null,base16:v1,base16upper:w1},Symbol.toStringTag,{value:"Module"})),S1=wt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),E1=Object.freeze(Object.defineProperty({__proto__:null,base2:S1},Symbol.toStringTag,{value:"Module"})),Hg=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),x1=Hg.reduce((r,e,t)=>(r[t]=e,r),[]),A1=Hg.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function I1(r){return r.reduce((e,t)=>(e+=x1[t],e),"")}function k1(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=A1[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const C1=Tl({prefix:"ðŸš€",name:"base256emoji",encode:I1,decode:k1}),T1=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:C1},Symbol.toStringTag,{value:"Module"})),Ln=wt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),P1=wt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),D1=wt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),L1=wt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),R1=wt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),B1=wt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),N1=wt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),M1=wt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),O1=wt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),$1=Object.freeze(Object.defineProperty({__proto__:null,base32:Ln,base32hex:R1,base32hexpad:N1,base32hexpadupper:M1,base32hexupper:B1,base32pad:D1,base32padupper:L1,base32upper:P1,base32z:O1},Symbol.toStringTag,{value:"Module"})),pa=To({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),F1=To({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),U1=Object.freeze(Object.defineProperty({__proto__:null,base36:pa,base36upper:F1},Symbol.toStringTag,{value:"Module"})),Pe=To({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),V1=To({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),K1=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Pe,base58flickr:V1},Symbol.toStringTag,{value:"Module"})),Po=wt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),q1=wt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),zg=wt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),H1=wt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),z1=Object.freeze(Object.defineProperty({__proto__:null,base64:Po,base64pad:q1,base64url:zg,base64urlpad:H1},Symbol.toStringTag,{value:"Module"})),W1=wt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),G1=Object.freeze(Object.defineProperty({__proto__:null,base8:W1},Symbol.toStringTag,{value:"Module"})),Y1=Tl({prefix:"\0",name:"identity",encode:r=>o1(r),decode:r=>i1(r)}),X1=Object.freeze(Object.defineProperty({__proto__:null,identity:Y1},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;var Z1=Wg,qf=128,j1=-128,Q1=Math.pow(2,31);function Wg(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Q1;)e[t++]=r&255|qf,r/=128;for(;r&j1;)e[t++]=r&255|qf,r>>>=7;return e[t]=r|0,Wg.bytes=t-n+1,e}var J1=Qc,eS=128,Hf=127;function Qc(r,n){var t=0,n=n||0,s=0,i=n,o,l=r.length;do{if(i>=l)throw Qc.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Hf)<<s:(o&Hf)*Math.pow(2,s),s+=7}while(o>=eS);return Qc.bytes=i-n,t}var tS=Math.pow(2,7),rS=Math.pow(2,14),nS=Math.pow(2,21),sS=Math.pow(2,28),iS=Math.pow(2,35),oS=Math.pow(2,42),aS=Math.pow(2,49),lS=Math.pow(2,56),cS=Math.pow(2,63),uS=function(r){return r<tS?1:r<rS?2:r<nS?3:r<sS?4:r<iS?5:r<oS?6:r<aS?7:r<lS?8:r<cS?9:10},dS={encode:Z1,decode:J1,encodingLength:uS},Ia=dS;function Jc(r,e=0){return[Ia.decode(r,e),Ia.decode.bytes]}function ka(r,e,t=0){return Ia.encode(r,e,t),e}function Ca(r){return Ia.encodingLength(r)}function Ei(r,e){const t=e.byteLength,n=Ca(r),s=n+Ca(t),i=new Uint8Array(s+t);return ka(r,i,0),ka(t,i,n),i.set(e,s),new nd(r,t,e,i)}function fn(r){const e=Cl(r),[t,n]=Jc(e),[s,i]=Jc(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new nd(t,s,o,e)}function fS(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&s1(r.bytes,t.bytes)}}class nd{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}const Gg=0,hS="identity",Yg=Cl;function pS(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return Ei(Gg,Yg(r))}const it={code:Gg,name:hS,encode:Yg,digest:pS},gS=20;function mS({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:s}){return new yS(r,e,t,n,s)}class yS{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,s,i){this.name=e,this.code=t,this.encode=n,this.minDigestLength=s??gS,this.maxDigestLength=i}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?zf(n,this.code,t?.truncate):n.then(s=>zf(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}}function zf(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return Ei(e,r)}function bS(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const pr=mS({name:"sha2-256",code:18,encode:bS("SHA-256")});function Wf(r,e){const{bytes:t,version:n}=r;return n===0?wS(t,eu(r),e??Pe.encoder):_S(t,eu(r),e??Ln.encoder)}const Gf=new WeakMap;function eu(r){const e=Gf.get(r);if(e==null){const t=new Map;return Gf.set(r,t),t}return e}class ue{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ki)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==SS)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ue.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Ei(e,t);return ue.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ue.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&fS(e.multihash,n.multihash)}toString(e){return Wf(this,e)}toJSON(){return{"/":Wf(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ue)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ue(n,s,i,o??Yf(n,s,i.bytes))}else if(t[ES]===!0){const{version:n,multihash:s,code:i}=t,o=fn(s);return ue.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ki)throw new Error(`Version 0 CID must use dag-pb (code: ${ki}) block encoding`);return new ue(e,t,n,n.bytes)}case 1:{const s=Yf(e,t,n.bytes);return new ue(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ue.create(0,ki,e)}static createV1(e,t){return ue.create(1,e,t)}static decode(e){const[t,n]=ue.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ue.inspectBytes(e),n=t.size-t.multihashSize,s=Cl(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new nd(t.multihashCode,t.digestSize,i,s);return[t.version===0?ue.createV0(o):ue.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[a,u]=Jc(e.subarray(t));return t+=u,a};let s=n(),i=ki;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,l=n(),c=n(),d=t+c,f=d-o;return{version:s,codec:i,multihashCode:l,digestSize:c,multihashSize:f,size:d}}static parse(e,t){const[n,s]=vS(e,t),i=ue.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return eu(i).set(n,e),i}}function vS(r,e){switch(r[0]){case"Q":{const t=e??Pe;return[Pe.prefix,t.decode(`${Pe.prefix}${r}`)]}case Pe.prefix:{const t=e??Pe;return[Pe.prefix,t.decode(r)]}case Ln.prefix:{const t=e??Ln;return[Ln.prefix,t.decode(r)]}case pa.prefix:{const t=e??pa;return[pa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function wS(r,e,t){const{prefix:n}=t;if(n!==Pe.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function _S(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const ki=112,SS=18;function Yf(r,e,t){const n=Ca(r),s=n+Ca(e),i=new Uint8Array(s+t.byteLength);return ka(r,i,0),ka(e,i,n),i.set(t,s),i}const ES=Symbol.for("@ipld/js-cid/CID"),tu={...X1,...E1,...G1,...b1,..._1,...$1,...U1,...K1,...z1,...T1};function Ke(r=0){return new Uint8Array(r)}function on(r=0){return new Uint8Array(r)}function Xg(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const Xf=Xg("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),nc=Xg("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=on(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Zg={utf8:Xf,"utf-8":Xf,hex:tu.base16,latin1:nc,ascii:nc,binary:nc,...tu};function j(r,e="utf8"){const t=Zg[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function W(r,e="utf8"){const t=Zg[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const ri=Object.freeze(["/dns4/r2.digifall.app/tcp/443/wss/p2p/12D3KooWPN8DqXM1ytrTs9bxpWt3ZnMLEWxHc3AEX2kKg62qhesv","/dns4/r3.digifall.app/tcp/443/wss/p2p/12D3KooWHUFx2bdvULtrXugaX8T3RX8A8KzoPmRbSMPKDqNNbLUw"]),Fs=Object.freeze({root:"/digifall/root/1.0",preview:"/digifall/preview/1.0"}),xS=Object.freeze(["highCombo","highScore"]);function sd(r,e){return r.value>e.value?1:r.value<e.value||r.timestamp<e.timestamp?-1:r.timestamp>e.timestamp?1:0}function AS(r){return r?.playerName??""}function ru(r){return JSON.parse(W(r.subarray()))}function Ls(r){return j(JSON.stringify(r))}function Zf(r){let e=0;for(const t of r)e=e*31+t|0;return e}function IS({playerName:r="",timestamp:e=0}){let t=e|0;for(let n=0;n<r.length;n++)t=t*31+r.charCodeAt(n)|0;return t}function kS(r){return r.length===0?0:Zf(r.slice().sort(sd).map(e=>Zf([IS(e),e.value])))}class CS{recordTypes;maxRecords;debug;validateRecord;onUpdate;queues;roots;constructor(e={}){this.recordTypes=e.recordTypes??[...xS],this.maxRecords=e.maxRecords??1e3,this.debug=e.debug??!1,this.validateRecord=e.validateRecord??null,this.onUpdate=e.onUpdate??null,this.queues=Object.fromEntries(this.recordTypes.map(t=>[t,new n1({maxSize:this.maxRecords,compare:sd,extractKey:AS})])),this.roots=Object.fromEntries(this.recordTypes.map(t=>[t,0]))}updateRoot(e){const t=this.queues[e];this.roots[e]=t?kS(t.data):0}getQueue(e){return this.queues[e]}getRoots(){return{...this.roots}}getData(e){return this.queues[e]?.data??[]}getAllData(){return Object.fromEntries(this.recordTypes.map(e=>[e,this.getData(e)]))}loadData(e,t){const n=this.queues[e];if(n){for(const s of t)n.push(s);this.updateRoot(e)}}handleRecord(e){const{type:t,playerName:n,value:s}=e,i=this.queues[t];if(!i)return!1;const{data:o,indexes:l}=i,c=l.get(n);return c in o&&o[c].value>=s?!1:(i.push(e),this.updateRoot(t),this.debug&&console.log("LEADERBOARD UPDATED:",t,n,s),this.onUpdate?.(t,i.data),!0)}async handleRecordWithValidation(e){const{type:t,playerName:n,value:s}=e,i=this.queues[t];if(!i)return!1;const{data:o,indexes:l}=i,c=l.get(n);if(c in o&&o[c].value>=s)return!1;if(this.validateRecord)try{const d=await this.validateRecord(e);return d?this.handleRecord(d):!1}catch(d){return this.debug&&console.error(d),!1}return this.handleRecord(e)}createRootHandler(e){return async(t,n)=>{this.debug&&console.log("handleRoot");const s=new Set;t.addEventListener("message",i=>{const o=i.detail??i.data;try{const l=ru(o);if(l===null){if(t.close(),s.size===0||n.status!=="open")return;e(n,Array.from(s));return}if(Array.isArray(l)){const[c,d]=l;if(!(c in this.roots))return;if(d===0){for(const f of this.queues[c].data)t.send(Ls(f));return}d!==this.roots[c]&&s.add(c)}else this.handleRecordWithValidation(l)}catch(l){this.debug&&console.error(l)}}),t.resume()}}createPreviewHandler(){return async(e,t)=>{this.debug&&console.log("handlePreview");const n=new Set,s=Object.fromEntries(this.recordTypes.map(i=>[i,new Set]));e.addEventListener("message",i=>{const o=i.detail??i.data;try{const l=ru(o);if(l===null){Array.from(n).flatMap(u=>this.queues[u].data.filter(h=>!s[u].has(h.playerName))).forEach(u=>e.send(Ls(u))),e.close();return}const{type:c,playerName:d,value:f}=l;if(!(c in this.queues))return;n.add(c);const a=this.queues[c].indexes.get(d);if(a===void 0||this.queues[c].data[a].value>f)return;s[c].add(d)}catch(l){this.debug&&console.error(l)}}),e.resume()}}createPushRoot(e){return async t=>(this.debug&&console.log(Fs.root),t.newStream(Fs.root,{runOnLimitedConnection:!0}).then(async n=>{n.addEventListener("message",s=>{const i=s.detail??s.data;e(i)}),Object.entries(this.roots).forEach(([s,i])=>n.send(Ls([s,i]))),n.send(Ls(null)),n.readStatus==="paused"&&n.resume()}).catch(n=>(this.debug&&console.error(n),{error:n})))}createPushPreview(e){return async(t,n)=>(this.debug&&console.log(Fs.preview),t.newStream(Fs.preview,{runOnLimitedConnection:!0}).then(async s=>{s.addEventListener("message",i=>{const o=i.detail??i.data;e(o)}),n.forEach(i=>this.queues[i].data.forEach(({playerName:o,value:l})=>s.send(Ls({type:i,playerName:o,value:l})))),s.send(Ls(null)),s.readStatus==="paused"&&s.resume()}).catch(s=>{this.debug&&console.error(s)}))}}const Rn=!!localStorage.getItem("debug"),jf=Number(localStorage.getItem("reload")),TS=!!localStorage.getItem("use-all-relays"),at=1e3,PS=4e4,Le=Object.freeze({columns:6,rows:6,maxValue:9}),U=Object.freeze({digifall:"digifall",highCombo:"highCombo",highComboPrev:"highComboPrev",highScore:"highScore",highScorePrev:"highScorePrev",leaderboard:"leaderboard",local:"local",moves:"moves",options:"options",peerId:"peerId",playerName:"playerName",records:"records",relays:"relays",score:"score",timestamp:"timestamp",type:"type",value:"value"}),de=Object.freeze({gameOver:"gameOver",leaderboard:"leaderboard",menu:"menu",options:"options",relays:"relays",wellcome:"wellcome"}),te=Object.freeze({blink:"blink",combo:"combo",extra:"extra",fall:"fall",gameOver:"gameOver",idle:"idle",initial:"initial",match:"match",plus:"plus",score:"score"}),Do=Object.freeze([U.highCombo,U.highScore]),De=Object.freeze({cards:[],energy:{buffer:0,value:100},[U.leaderboard]:{highCombo:[],highScore:[]},log:[],matchedIndexes:new Set,[U.moves]:"",[U.options]:{[U.playerName]:"",[U.leaderboard]:!0,cluster:!0,rapid:!1,sound:!0},[U.relays]:{active:[...ri],applied:[...ri]},overlay:de.menu,phase:te.initial,plusIndex:null,[U.records]:Do.reduce((r,e)=>(r[e]={[U.playerName]:"",[U.timestamp]:0,[U.moves]:"",[U.value]:0},r),{}),[U.score]:{buffer:0,value:0}}),{abs:jg,sign:id,trunc:Qg}=Math;function Ta(r=0){return(r*16807+19487171)%2147483647}function DS(r){return btoa(String.fromCodePoint(...r))}function Jg(r){return Array.from(atob(r)).map(e=>e.charCodeAt())}function LS(r){const e=BigInt(Number.MAX_SAFE_INTEGER),t=r.reduce((n,s)=>(n=BigInt(`${n}${s}`),n>e&&(n=n%e),n),0);return Number(t)}function hr(r,e,t=0){const{rapid:n}=r.optionsStore.get(),s=!n&&r.movesInitial===null&&t>0;switch(typeof e){case"undefined":return{duration:s?0:400};case"function":return s?setTimeout(()=>e(r),t):e(r);case"object":return s?{duration:0}:e;default:return s?0:e}}function Mr(r,e,{muteRapid:t=!1}={}){if(!e)return;const{sound:n,rapid:s}=r.optionsStore.get();if(!(t&&s)&&!(!n||r.movesInitial!==null||!r.ready)){if(Array.isArray(e)){e.forEach(i=>i&&i());return}e()}}function Pa(r,e,t){const n=r.recordsStore.get();n[e][U.value]>=t||(n[e]={[U.moves]:r.movesStore.get(),[U.playerName]:r.optionsStore.get().playerName,[U.timestamp]:r.timestampStore.get(),[U.value]:t},r.recordsStore.set(n))}function io(r){return r<Le.maxValue?r+1:0}function Pl(r){const e=Array.from({length:Le.columns},()=>Array.from({length:2*Le.rows}));return r.forEach(({x:t,y:n},s)=>e[t][n]=s),e}function em(r,e){const t=r.phaseStore.get(),{rapid:n}=r.optionsStore.get(),s=Pl(e),i=[],o=new Set;return s.forEach(l=>{let c=0;l.forEach((d,f)=>{if(d===void 0)return++c;const{x:a,value:u}=e[d],h=n||r.movesInitial||t!==te.fall?0:100*(2*c)**.5;i[d]={x:a,y:f-c,value:u,nextValue:io(u),duration:h},c>0&&h>0&&!o.has(h)&&o.add(h)})}),Mr(r,()=>o.forEach(l=>setTimeout(r.sounds.playKick,l)),{muteRapid:!0}),i}function tm(r){const e=Pl(r),t=new Set,n=[],s=(i,o,l)=>{if(t.has(o))return;const{x:c,y:d,value:f}=r[o];l!==void 0&&l!==f||(n[i]||(n[i]={value:f,indexes:new Set}),n[i].indexes.add(o),t.add(o),d<Le.rows-1&&s(i,e[c][d+1],f),c<Le.columns-1&&s(i,e[c+1][d],f),d>0&&s(i,e[c][d-1],f),c>0&&s(i,e[c-1][d],f))};return r.forEach((i,o)=>s(o,o)),n.reduce((i,o)=>(o.value===o.indexes.size&&(i.counts++,i.digits.add(o.value),o.indexes.forEach(i.indexes.add,i.indexes)),i),{counts:0,digits:new Set,indexes:new Set})}function rm(r,e,t){const n=Array.from({length:Le.columns},()=>0),s=i=>n[i]+e.filter(({x:o})=>o===i).sort(({y:o},{y:l})=>l-o)[0].y;return e.map((i,o)=>i.y<Le.rows&&t.has(o)?(++n[i.x],{x:i.x,y:s(i.x),value:r.getNextCardValue(i.x),duration:0}):i)}function Dl(r,e){if(!r.optionsStore.get().cluster)return e;const t=Pl(e);return e.map(n=>({...n,cluster:RS(e,t,n)}))}function RS(r,e,{x:t,y:n,value:s}){const i=n===Le.rows-1?-1:e[t][n+1],o=t===Le.columns-1?-1:e[t+1][n],l=n===0?-1:e[t][n-1],c=t===0?-1:e[t-1][n],d=i>-1?r[i].value:NaN,f=o>-1?r[o].value:NaN,a=l>-1?r[l].value:NaN,u=c>-1?r[c].value:NaN;return{top:d===s,right:f===s,bottom:a===s,left:u===s}}function nm(r){return id(r)*Qg(jg(r)**.5)}function BS(r,{buffer:e,value:t}){const n=r.phaseStore.get(),{rapid:s}=r.optionsStore.get(),i=s||r.movesInitial?e:n===te.gameOver?id(e):nm(e);if(n===te.extra){if(e===0){hr(r,()=>r.phaseStore.set(te.combo),800);return}r.logStore.update(o=>{const l=o.length-1,{extra:c}=o[l];return o[l]={extra:c-i},o})}if(e===0){n===te.gameOver&&Mr(r,()=>setTimeout(r.sounds.playGameOver,600));return}hr(r,()=>{r.energyStore.set({buffer:e-i,value:t+i})},n===te.gameOver?200:32)}function NS(r){setTimeout(()=>r.phaseStore.set(te.idle),0)}function MS(r){if(r.movesInitial!==null){if(r.moveCount<r.movesInitial.length){r.plusIndexStore.set(r.movesInitial[r.moveCount++]),r.energyStore.update(({buffer:e,value:t})=>({buffer:e,value:t-10})),r.phaseStore.set(te.plus);return}r.movesInitial=null,Pa(r,U.highScore,r.scoreStore.get().value);return}r.cardsStore.update(e=>e.map(t=>({...t,duration:0}))),Pa(r,U.highScore,r.scoreStore.get().value),Mr(r,r.sounds.reset)}function OS(r){r.plusIndexStore.update(e=>(r.cardsStore.update(t=>Dl(r,t.map((n,s)=>{if(s!==e)return n;const i=io(n.value);return{...n,value:i,nextValue:io(i),duration:0}}))),null)),r.phaseStore.set(te.blink)}function $S(r){const e=r.cardsStore.get();let{counts:t,digits:n,indexes:s}=tm(e);r.matchedIndexesStore.set(s);const{value:i}=r.energyStore.get();if(s.size>0){const o=Array.from(s);r.logStore.update(c=>c.concat(o.reduce((d,f)=>{const a=e[f];return d[a.value]=(d[a.value]||0)+a.value,d.sum=(d.sum||0)+a.value,d.counts=t,d.digits=Array.from(n),d},{})));const l=o.reduce((c,d)=>c+e[d].value,0);hr(r,()=>r.energyStore.set({buffer:l,value:i}),400),hr(r,()=>r.phaseStore.set(te.match),800),Mr(r,[r.sounds.playWordUp,r.sounds.playBlink],{muteRapid:!0});return}if(i>100){r.phaseStore.set(te.extra);return}if(r.logStore.get().length>0){r.phaseStore.set(te.combo);return}if(i<10){r.phaseStore.set(te.gameOver);return}r.phaseStore.set(te.idle)}function FS(r){r.matchedIndexesStore.update(e=>(r.cardsStore.update(t=>Dl(r,rm(r,t,e))),new Set)),hr(r,()=>r.phaseStore.set(te.fall),400)}function US(r){r.cardsStore.update(e=>Dl(r,em(r,e))),hr(r,()=>r.phaseStore.set(te.blink),400)}function VS(r){r.energyStore.update(({value:e})=>({buffer:100-e,value:e})),r.logStore.update(e=>e.concat({extra:100})),Mr(r,r.sounds.playWordUp,{muteRapid:!0})}function sm(r){return r.reduce((e,{counts:t,extra:n,sum:s},i)=>e+(i+1)*(s||n)*(t||1),0)}function KS(r){const e=r.logStore.get(),t=sm(e);r.scoreStore.update(({value:n})=>({buffer:t,value:n})),Pa(r,U.highCombo,t),hr(r,()=>r.phaseStore.set(te.score),e.length>1?800:0),Mr(r,r.sounds.playWordUp,{muteRapid:!0})}function qS(r){r.logStore.get().length<2||r.scoreStore.update(e=>({...e}))}function HS(r){hr(r,()=>{r.energyStore.update(({value:e})=>({buffer:-e,value:e})),r.scoreStore.update(({value:e})=>({buffer:r.energyStore.get().value,value:e}))},400)}const zS={[te.initial]:NS,[te.idle]:MS,[te.plus]:OS,[te.blink]:$S,[te.match]:FS,[te.fall]:US,[te.extra]:VS,[te.combo]:KS,[te.score]:qS,[te.gameOver]:HS};function WS(r,e){zS[e](r)}function GS(r,e){if(e===null||r.movesInitial!==null)return;let t=r.movesStore.get();t=Array.isArray(t)?t:Jg(t),t.push(e),r.movesStore.set(DS(t)),r.energyStore.update(n=>({...n,buffer:-10})),hr(r,()=>r.phaseStore.set(te.plus),400)}function YS(r){switch(jg(r)){case 1:return 130;case 2:case 3:return 80;case 4:case 5:case 6:return 50;case 7:case 8:case 9:case 10:case 11:return 30;default:return 20}}function XS(r,{buffer:e,value:t}){const n=r.phaseStore.get();if(n!==te.gameOver&&n!==te.score)return;if(e===0){if(n===te.gameOver){Pa(r,U.highScore,t);return}hr(r,()=>{r.logStore.set([]),r.phaseStore.set(r.energyStore.get().value<10?te.gameOver:te.idle),Mr(r,r.sounds.playTurnOn)},200);return}const{rapid:s}=r.optionsStore.get(),i=s||r.movesInitial?e:n===te.gameOver?id(e):nm(e);hr(r,()=>{r.scoreStore.set({buffer:e-i,value:t+i})},n===te.gameOver?200:YS(i)),Mr(r,r.sounds.playBleep,{muteRapid:!0})}function im({playerName:r,timestamp:e}){return r&&typeof r=="string"&&e&&typeof e=="number"&&e<1/0&&LS([e,...Array.from(r).map(t=>t.charCodeAt())])}function ZS(r){let e=0;const t=[Ta(r)];for(;e<Le.columns-1;)t.push(Ta(2*t[e++]));return t}function jS(r){let e=ZS(r);return t=>{if(t<0||Le.columns-1<t)return;let n=e[t];return e[t]=Ta(n),n%10}}function QS(r){return Array.from({length:Le.columns*Le.rows},(e,t,n,s)=>(n=Qg(t/Le.columns),s=r.getNextCardValue(n),{x:n,y:t%Le.rows,value:s,nextValue:io(s),duration:0}))}function JS(r,e){for(;;){const t=tm(e).indexes;if(t.size===0)return e;const n=rm(r,e,t);e=em(r,n)}}function eE(r,e){if(e==null)return;r.getNextCardValue=jS(e),r.cardsStore.set(Dl(r,JS(r,QS(r))));let t=r.movesStore.get();if(t){if(t=Array.isArray(t)?t:Jg(t),t.length>0){r.moveCount=0,r.movesInitial=t;return}r.movesInitial=null}}function om(r){const e=r.recordsStore.get();r[U.highComboPrev]=e[U.highCombo][U.value],r[U.highScorePrev]=e[U.highScore][U.value]}function am(r,e){return om(r),r.sounds=e||{},r.getNextCardValue=()=>0,r.moveCount=0,r.movesInitial=null,r.energyStore.subscribe(t=>{BS(r,t)}),r.phaseStore.subscribe(t=>{WS(r,t)}),r.plusIndexStore.subscribe(t=>{GS(r,t)}),r.scoreStore.subscribe(t=>{XS(r,t)}),r.seedStore.subscribe(t=>{eE(r,t)}),r}function lm(r,e,t){if(e<0)return r.ready=!0;setTimeout(()=>{r.logStore.set(De.log),r.plusIndexStore.set(De.plusIndex),r.matchedIndexesStore.set(De.matchedIndexes),r.movesStore.set(De.moves),r.scoreStore.set(De.score),r.energyStore.set(De.energy),r.phaseStore.set(De.phase),r.timestampStore.set(Date.now()),lm(r,--e),t&&r.optionsStore.update(n=>({...n,playerName:t}))},64)}function tE(r,e){om(r),Mr(r,r.sounds.playGenerate),r.ready=!1,lm(r,8,e)}var rE=se('<div><div class="value"><div> </div> <div> </div></div></div>');function nE(r,e){dt(e,!0);let t=ie(()=>io(e.card.value));var n=rE();let s,i;var o=O(n),l=O(o);let c,d;var f=O(l),a=z(l,2);let u,h;var p=O(a);Te(()=>{s=Ue(n,1,"card",null,s,{blink:e.blink,focus:e.focus,longpress:e.longpress,plus:e.plus}),Dn(n,"data-index",e.index),i=kt(n,"",i,{"--card-x":e.card.x,"--card-y":e.card.y,"--card-duration":e.card.duration}),c=Ue(l,1,"current",null,c,{"cluster-top":e.card.cluster&&e.card.cluster.top,"cluster-right":e.card.cluster&&e.card.cluster.right,"cluster-bottom":e.card.cluster&&e.card.cluster.bottom,"cluster-left":e.card.cluster&&e.card.cluster.left,"only-shadow":e.card.y===5}),d=kt(l,"",d,{"--color":`var(--color-${e.card.value??""})`}),ze(f,e.card.value),u=Ue(a,1,"next",null,u,{"only-shadow":e.card.y===5}),h=kt(a,"",h,{"--color":`var(--color-${b(t)??""})`}),ze(p,b(t))}),J(r,n),ft()}var Ci=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function od(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var sc={};var Qf;function sE(){return Qf||(Qf=1,(function(r){(function(){var e=function(){this.init()};e.prototype={init:function(){var a=this||t;return a._counter=1e3,a._html5AudioPool=[],a.html5PoolSize=10,a._codecs={},a._howls=[],a._muted=!1,a._volume=1,a._canPlayEvent="canplaythrough",a._navigator=typeof window<"u"&&window.navigator?window.navigator:null,a.masterGain=null,a.noAudio=!1,a.usingWebAudio=!0,a.autoSuspend=!0,a.ctx=null,a.autoUnlock=!0,a._setup(),a},volume:function(a){var u=this||t;if(a=parseFloat(a),u.ctx||f(),typeof a<"u"&&a>=0&&a<=1){if(u._volume=a,u._muted)return u;u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a,t.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.volume=g._volume*a)}return u}return u._volume},mute:function(a){var u=this||t;u.ctx||f(),u._muted=a,u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a?0:u._volume,t.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.muted=a?!0:g._muted)}return u},stop:function(){for(var a=this||t,u=0;u<a._howls.length;u++)a._howls[u].stop();return a},unload:function(){for(var a=this||t,u=a._howls.length-1;u>=0;u--)a._howls[u].unload();return a.usingWebAudio&&a.ctx&&typeof a.ctx.close<"u"&&(a.ctx.close(),a.ctx=null,f()),a},codecs:function(a){return(this||t)._codecs[a.replace(/^x-/,"")]},_setup:function(){var a=this||t;if(a.state=a.ctx&&a.ctx.state||"suspended",a._autoSuspend(),!a.usingWebAudio)if(typeof Audio<"u")try{var u=new Audio;typeof u.oncanplaythrough>"u"&&(a._canPlayEvent="canplay")}catch{a.noAudio=!0}else a.noAudio=!0;try{var u=new Audio;u.muted&&(a.noAudio=!0)}catch{}return a.noAudio||a._setupCodecs(),a},_setupCodecs:function(){var a=this||t,u=null;try{u=typeof Audio<"u"?new Audio:null}catch{return a}if(!u||typeof u.canPlayType!="function")return a;var h=u.canPlayType("audio/mpeg;").replace(/^no$/,""),p=a._navigator?a._navigator.userAgent:"",y=p.match(/OPR\/(\d+)/g),g=y&&parseInt(y[0].split("/")[1],10)<33,m=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,w=p.match(/Version\/(.*?) /),v=m&&w&&parseInt(w[1],10)<15;return a._codecs={mp3:!!(!g&&(h||u.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!h,opus:!!u.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(u.canPlayType('audio/wav; codecs="1"')||u.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!u.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!u.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(u.canPlayType("audio/x-m4a;")||u.canPlayType("audio/m4a;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(u.canPlayType("audio/x-m4b;")||u.canPlayType("audio/m4b;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(u.canPlayType("audio/x-mp4;")||u.canPlayType("audio/mp4;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!v&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!v&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!u.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(u.canPlayType("audio/x-flac;")||u.canPlayType("audio/flac;")).replace(/^no$/,"")},a},_unlockAudio:function(){var a=this||t;if(!(a._audioUnlocked||!a.ctx)){a._audioUnlocked=!1,a.autoUnlock=!1,!a._mobileUnloaded&&a.ctx.sampleRate!==44100&&(a._mobileUnloaded=!0,a.unload()),a._scratchBuffer=a.ctx.createBuffer(1,1,22050);var u=function(h){for(;a._html5AudioPool.length<a.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,a._releaseHtml5Audio(p)}catch{a.noAudio=!0;break}for(var y=0;y<a._howls.length;y++)if(!a._howls[y]._webAudio)for(var g=a._howls[y]._getSoundIds(),m=0;m<g.length;m++){var w=a._howls[y]._soundById(g[m]);w&&w._node&&!w._node._unlocked&&(w._node._unlocked=!0,w._node.load())}a._autoResume();var v=a.ctx.createBufferSource();v.buffer=a._scratchBuffer,v.connect(a.ctx.destination),typeof v.start>"u"?v.noteOn(0):v.start(0),typeof a.ctx.resume=="function"&&a.ctx.resume(),v.onended=function(){v.disconnect(0),a._audioUnlocked=!0,document.removeEventListener("touchstart",u,!0),document.removeEventListener("touchend",u,!0),document.removeEventListener("click",u,!0),document.removeEventListener("keydown",u,!0);for(var _=0;_<a._howls.length;_++)a._howls[_]._emit("unlock")}};return document.addEventListener("touchstart",u,!0),document.addEventListener("touchend",u,!0),document.addEventListener("click",u,!0),document.addEventListener("keydown",u,!0),a}},_obtainHtml5Audio:function(){var a=this||t;if(a._html5AudioPool.length)return a._html5AudioPool.pop();var u=new Audio().play();return u&&typeof Promise<"u"&&(u instanceof Promise||typeof u.then=="function")&&u.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(a){var u=this||t;return a._unlocked&&u._html5AudioPool.push(a),u},_autoSuspend:function(){var a=this;if(!(!a.autoSuspend||!a.ctx||typeof a.ctx.suspend>"u"||!t.usingWebAudio)){for(var u=0;u<a._howls.length;u++)if(a._howls[u]._webAudio){for(var h=0;h<a._howls[u]._sounds.length;h++)if(!a._howls[u]._sounds[h]._paused)return a}return a._suspendTimer&&clearTimeout(a._suspendTimer),a._suspendTimer=setTimeout(function(){if(a.autoSuspend){a._suspendTimer=null,a.state="suspending";var p=function(){a.state="suspended",a._resumeAfterSuspend&&(delete a._resumeAfterSuspend,a._autoResume())};a.ctx.suspend().then(p,p)}},3e4),a}},_autoResume:function(){var a=this;if(!(!a.ctx||typeof a.ctx.resume>"u"||!t.usingWebAudio))return a.state==="running"&&a.ctx.state!=="interrupted"&&a._suspendTimer?(clearTimeout(a._suspendTimer),a._suspendTimer=null):a.state==="suspended"||a.state==="running"&&a.ctx.state==="interrupted"?(a.ctx.resume().then(function(){a.state="running";for(var u=0;u<a._howls.length;u++)a._howls[u]._emit("resume")}),a._suspendTimer&&(clearTimeout(a._suspendTimer),a._suspendTimer=null)):a.state==="suspending"&&(a._resumeAfterSuspend=!0),a}};var t=new e,n=function(a){var u=this;if(!a.src||a.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}u.init(a)};n.prototype={init:function(a){var u=this;return t.ctx||f(),u._autoplay=a.autoplay||!1,u._format=typeof a.format!="string"?a.format:[a.format],u._html5=a.html5||!1,u._muted=a.mute||!1,u._loop=a.loop||!1,u._pool=a.pool||5,u._preload=typeof a.preload=="boolean"||a.preload==="metadata"?a.preload:!0,u._rate=a.rate||1,u._sprite=a.sprite||{},u._src=typeof a.src!="string"?a.src:[a.src],u._volume=a.volume!==void 0?a.volume:1,u._xhr={method:a.xhr&&a.xhr.method?a.xhr.method:"GET",headers:a.xhr&&a.xhr.headers?a.xhr.headers:null,withCredentials:a.xhr&&a.xhr.withCredentials?a.xhr.withCredentials:!1},u._duration=0,u._state="unloaded",u._sounds=[],u._endTimers={},u._queue=[],u._playLock=!1,u._onend=a.onend?[{fn:a.onend}]:[],u._onfade=a.onfade?[{fn:a.onfade}]:[],u._onload=a.onload?[{fn:a.onload}]:[],u._onloaderror=a.onloaderror?[{fn:a.onloaderror}]:[],u._onplayerror=a.onplayerror?[{fn:a.onplayerror}]:[],u._onpause=a.onpause?[{fn:a.onpause}]:[],u._onplay=a.onplay?[{fn:a.onplay}]:[],u._onstop=a.onstop?[{fn:a.onstop}]:[],u._onmute=a.onmute?[{fn:a.onmute}]:[],u._onvolume=a.onvolume?[{fn:a.onvolume}]:[],u._onrate=a.onrate?[{fn:a.onrate}]:[],u._onseek=a.onseek?[{fn:a.onseek}]:[],u._onunlock=a.onunlock?[{fn:a.onunlock}]:[],u._onresume=[],u._webAudio=t.usingWebAudio&&!u._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(u),u._autoplay&&u._queue.push({event:"play",action:function(){u.play()}}),u._preload&&u._preload!=="none"&&u.load(),u},load:function(){var a=this,u=null;if(t.noAudio){a._emit("loaderror",null,"No audio support.");return}typeof a._src=="string"&&(a._src=[a._src]);for(var h=0;h<a._src.length;h++){var p,y;if(a._format&&a._format[h])p=a._format[h];else{if(y=a._src[h],typeof y!="string"){a._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(y),p||(p=/\.([^.]+)$/.exec(y.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&t.codecs(p)){u=a._src[h];break}}if(!u){a._emit("loaderror",null,"No codec support for selected audio sources.");return}return a._src=u,a._state="loading",window.location.protocol==="https:"&&u.slice(0,5)==="http:"&&(a._html5=!0,a._webAudio=!1),new s(a),a._webAudio&&o(a),a},play:function(a,u){var h=this,p=null;if(typeof a=="number")p=a,a=null;else{if(typeof a=="string"&&h._state==="loaded"&&!h._sprite[a])return null;if(typeof a>"u"&&(a="__default",!h._playLock)){for(var y=0,g=0;g<h._sounds.length;g++)h._sounds[g]._paused&&!h._sounds[g]._ended&&(y++,p=h._sounds[g]._id);y===1?a=null:p=null}}var m=p?h._soundById(p):h._inactiveSound();if(!m)return null;if(p&&!a&&(a=m._sprite||"__default"),h._state!=="loaded"){m._sprite=a,m._ended=!1;var w=m._id;return h._queue.push({event:"play",action:function(){h.play(w)}}),w}if(p&&!m._paused)return u||h._loadQueue("play"),m._id;h._webAudio&&t._autoResume();var v=Math.max(0,m._seek>0?m._seek:h._sprite[a][0]/1e3),_=Math.max(0,(h._sprite[a][0]+h._sprite[a][1])/1e3-v),k=_*1e3/Math.abs(m._rate),P=h._sprite[a][0]/1e3,D=(h._sprite[a][0]+h._sprite[a][1])/1e3;m._sprite=a,m._ended=!1;var I=function(){m._paused=!1,m._seek=v,m._start=P,m._stop=D,m._loop=!!(m._loop||h._sprite[a][2])};if(v>=D){h._ended(m);return}var x=m._node;if(h._webAudio){var B=function(){h._playLock=!1,I(),h._refreshBuffer(m);var E=m._muted||h._muted?0:m._volume;x.gain.setValueAtTime(E,t.ctx.currentTime),m._playStart=t.ctx.currentTime,typeof x.bufferSource.start>"u"?m._loop?x.bufferSource.noteGrainOn(0,v,86400):x.bufferSource.noteGrainOn(0,v,_):m._loop?x.bufferSource.start(0,v,86400):x.bufferSource.start(0,v,_),k!==1/0&&(h._endTimers[m._id]=setTimeout(h._ended.bind(h,m),k)),u||setTimeout(function(){h._emit("play",m._id),h._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?B():(h._playLock=!0,h.once("resume",B),h._clearTimer(m._id))}else{var Q=function(){x.currentTime=v,x.muted=m._muted||h._muted||t._muted||x.muted,x.volume=m._volume*t.volume(),x.playbackRate=m._rate;try{var E=x.play();if(E&&typeof Promise<"u"&&(E instanceof Promise||typeof E.then=="function")?(h._playLock=!0,I(),E.then(function(){h._playLock=!1,x._unlocked=!0,u?h._loadQueue():h._emit("play",m._id)}).catch(function(){h._playLock=!1,h._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),m._ended=!0,m._paused=!0})):u||(h._playLock=!1,I(),h._emit("play",m._id)),x.playbackRate=m._rate,x.paused){h._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}a!=="__default"||m._loop?h._endTimers[m._id]=setTimeout(h._ended.bind(h,m),k):(h._endTimers[m._id]=function(){h._ended(m),x.removeEventListener("ended",h._endTimers[m._id],!1)},x.addEventListener("ended",h._endTimers[m._id],!1))}catch(S){h._emit("playerror",m._id,S)}};x.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(x.src=h._src,x.load());var M=window&&window.ejecta||!x.readyState&&t._navigator.isCocoonJS;if(x.readyState>=3||M)Q();else{h._playLock=!0,h._state="loading";var A=function(){h._state="loaded",Q(),x.removeEventListener(t._canPlayEvent,A,!1)};x.addEventListener(t._canPlayEvent,A,!1),h._clearTimer(m._id)}}return m._id},pause:function(a){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"pause",action:function(){u.pause(a)}}),u;for(var h=u._getSoundIds(a),p=0;p<h.length;p++){u._clearTimer(h[p]);var y=u._soundById(h[p]);if(y&&!y._paused&&(y._seek=u.seek(h[p]),y._rateSeek=0,y._paused=!0,u._stopFade(h[p]),y._node))if(u._webAudio){if(!y._node.bufferSource)continue;typeof y._node.bufferSource.stop>"u"?y._node.bufferSource.noteOff(0):y._node.bufferSource.stop(0),u._cleanBuffer(y._node)}else(!isNaN(y._node.duration)||y._node.duration===1/0)&&y._node.pause();arguments[1]||u._emit("pause",y?y._id:null)}return u},stop:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"stop",action:function(){h.stop(a)}}),h;for(var p=h._getSoundIds(a),y=0;y<p.length;y++){h._clearTimer(p[y]);var g=h._soundById(p[y]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,h._stopFade(p[y]),g._node&&(h._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),h._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&h._clearSound(g._node))),u||h._emit("stop",g._id))}return h},mute:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"mute",action:function(){h.mute(a,u)}}),h;if(typeof u>"u")if(typeof a=="boolean")h._muted=a;else return h._muted;for(var p=h._getSoundIds(u),y=0;y<p.length;y++){var g=h._soundById(p[y]);g&&(g._muted=a,g._interval&&h._stopFade(g._id),h._webAudio&&g._node?g._node.gain.setValueAtTime(a?0:g._volume,t.ctx.currentTime):g._node&&(g._node.muted=t._muted?!0:a),h._emit("mute",g._id))}return h},volume:function(){var a=this,u=arguments,h,p;if(u.length===0)return a._volume;if(u.length===1||u.length===2&&typeof u[1]>"u"){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length>=2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var m;if(typeof h<"u"&&h>=0&&h<=1){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"volume",action:function(){a.volume.apply(a,u)}}),a;typeof p>"u"&&(a._volume=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)m=a._soundById(p[w]),m&&(m._volume=h,u[2]||a._stopFade(p[w]),a._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(h,t.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=h*t.volume()),a._emit("volume",m._id))}else return m=p?a._soundById(p):a._sounds[0],m?m._volume:0;return a},fade:function(a,u,h,p){var y=this;if(y._state!=="loaded"||y._playLock)return y._queue.push({event:"fade",action:function(){y.fade(a,u,h,p)}}),y;a=Math.min(Math.max(0,parseFloat(a)),1),u=Math.min(Math.max(0,parseFloat(u)),1),h=parseFloat(h),y.volume(a,p);for(var g=y._getSoundIds(p),m=0;m<g.length;m++){var w=y._soundById(g[m]);if(w){if(p||y._stopFade(g[m]),y._webAudio&&!w._muted){var v=t.ctx.currentTime,_=v+h/1e3;w._volume=a,w._node.gain.setValueAtTime(a,v),w._node.gain.linearRampToValueAtTime(u,_)}y._startFadeInterval(w,a,u,h,g[m],typeof p>"u")}}return y},_startFadeInterval:function(a,u,h,p,y,g){var m=this,w=u,v=h-u,_=Math.abs(v/.01),k=Math.max(4,_>0?p/_:p),P=Date.now();a._fadeTo=h,a._interval=setInterval(function(){var D=(Date.now()-P)/p;P=Date.now(),w+=v*D,w=Math.round(w*100)/100,v<0?w=Math.max(h,w):w=Math.min(h,w),m._webAudio?a._volume=w:m.volume(w,a._id,!0),g&&(m._volume=w),(h<u&&w<=h||h>u&&w>=h)&&(clearInterval(a._interval),a._interval=null,a._fadeTo=null,m.volume(h,a._id),m._emit("fade",a._id))},k)},_stopFade:function(a){var u=this,h=u._soundById(a);return h&&h._interval&&(u._webAudio&&h._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(h._interval),h._interval=null,u.volume(h._fadeTo,a),h._fadeTo=null,u._emit("fade",a)),u},loop:function(){var a=this,u=arguments,h,p,y;if(u.length===0)return a._loop;if(u.length===1)if(typeof u[0]=="boolean")h=u[0],a._loop=h;else return y=a._soundById(parseInt(u[0],10)),y?y._loop:!1;else u.length===2&&(h=u[0],p=parseInt(u[1],10));for(var g=a._getSoundIds(p),m=0;m<g.length;m++)y=a._soundById(g[m]),y&&(y._loop=h,a._webAudio&&y._node&&y._node.bufferSource&&(y._node.bufferSource.loop=h,h&&(y._node.bufferSource.loopStart=y._start||0,y._node.bufferSource.loopEnd=y._stop,a.playing(g[m])&&(a.pause(g[m],!0),a.play(g[m],!0)))));return a},rate:function(){var a=this,u=arguments,h,p;if(u.length===0)p=a._sounds[0]._id;else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var m;if(typeof h=="number"){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"rate",action:function(){a.rate.apply(a,u)}}),a;typeof p>"u"&&(a._rate=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)if(m=a._soundById(p[w]),m){a.playing(p[w])&&(m._rateSeek=a.seek(p[w]),m._playStart=a._webAudio?t.ctx.currentTime:m._playStart),m._rate=h,a._webAudio&&m._node&&m._node.bufferSource?m._node.bufferSource.playbackRate.setValueAtTime(h,t.ctx.currentTime):m._node&&(m._node.playbackRate=h);var v=a.seek(p[w]),_=(a._sprite[m._sprite][0]+a._sprite[m._sprite][1])/1e3-v,k=_*1e3/Math.abs(m._rate);(a._endTimers[p[w]]||!m._paused)&&(a._clearTimer(p[w]),a._endTimers[p[w]]=setTimeout(a._ended.bind(a,m),k)),a._emit("rate",m._id)}}else return m=a._soundById(p),m?m._rate:a._rate;return a},seek:function(){var a=this,u=arguments,h,p;if(u.length===0)a._sounds.length&&(p=a._sounds[0]._id);else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):a._sounds.length&&(p=a._sounds[0]._id,h=parseFloat(u[0]))}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));if(typeof p>"u")return 0;if(typeof h=="number"&&(a._state!=="loaded"||a._playLock))return a._queue.push({event:"seek",action:function(){a.seek.apply(a,u)}}),a;var m=a._soundById(p);if(m)if(typeof h=="number"&&h>=0){var w=a.playing(p);w&&a.pause(p,!0),m._seek=h,m._ended=!1,a._clearTimer(p),!a._webAudio&&m._node&&!isNaN(m._node.duration)&&(m._node.currentTime=h);var v=function(){w&&a.play(p,!0),a._emit("seek",p)};if(w&&!a._webAudio){var _=function(){a._playLock?setTimeout(_,0):v()};setTimeout(_,0)}else v()}else if(a._webAudio){var k=a.playing(p)?t.ctx.currentTime-m._playStart:0,P=m._rateSeek?m._rateSeek-m._seek:0;return m._seek+(P+k*Math.abs(m._rate))}else return m._node.currentTime;return a},playing:function(a){var u=this;if(typeof a=="number"){var h=u._soundById(a);return h?!h._paused:!1}for(var p=0;p<u._sounds.length;p++)if(!u._sounds[p]._paused)return!0;return!1},duration:function(a){var u=this,h=u._duration,p=u._soundById(a);return p&&(h=u._sprite[p._sprite][1]/1e3),h},state:function(){return this._state},unload:function(){for(var a=this,u=a._sounds,h=0;h<u.length;h++)u[h]._paused||a.stop(u[h]._id),a._webAudio||(a._clearSound(u[h]._node),u[h]._node.removeEventListener("error",u[h]._errorFn,!1),u[h]._node.removeEventListener(t._canPlayEvent,u[h]._loadFn,!1),u[h]._node.removeEventListener("ended",u[h]._endFn,!1),t._releaseHtml5Audio(u[h]._node)),delete u[h]._node,a._clearTimer(u[h]._id);var p=t._howls.indexOf(a);p>=0&&t._howls.splice(p,1);var y=!0;for(h=0;h<t._howls.length;h++)if(t._howls[h]._src===a._src||a._src.indexOf(t._howls[h]._src)>=0){y=!1;break}return i&&y&&delete i[a._src],t.noAudio=!1,a._state="unloaded",a._sounds=[],a=null,null},on:function(a,u,h,p){var y=this,g=y["_on"+a];return typeof u=="function"&&g.push(p?{id:h,fn:u,once:p}:{id:h,fn:u}),y},off:function(a,u,h){var p=this,y=p["_on"+a],g=0;if(typeof u=="number"&&(h=u,u=null),u||h)for(g=0;g<y.length;g++){var m=h===y[g].id;if(u===y[g].fn&&m||!u&&m){y.splice(g,1);break}}else if(a)p["_on"+a]=[];else{var w=Object.keys(p);for(g=0;g<w.length;g++)w[g].indexOf("_on")===0&&Array.isArray(p[w[g]])&&(p[w[g]]=[])}return p},once:function(a,u,h){var p=this;return p.on(a,u,h,1),p},_emit:function(a,u,h){for(var p=this,y=p["_on"+a],g=y.length-1;g>=0;g--)(!y[g].id||y[g].id===u||a==="load")&&(setTimeout(function(m){m.call(this,u,h)}.bind(p,y[g].fn),0),y[g].once&&p.off(a,y[g].fn,y[g].id));return p._loadQueue(a),p},_loadQueue:function(a){var u=this;if(u._queue.length>0){var h=u._queue[0];h.event===a&&(u._queue.shift(),u._loadQueue()),a||h.action()}return u},_ended:function(a){var u=this,h=a._sprite;if(!u._webAudio&&a._node&&!a._node.paused&&!a._node.ended&&a._node.currentTime<a._stop)return setTimeout(u._ended.bind(u,a),100),u;var p=!!(a._loop||u._sprite[h][2]);if(u._emit("end",a._id),!u._webAudio&&p&&u.stop(a._id,!0).play(a._id),u._webAudio&&p){u._emit("play",a._id),a._seek=a._start||0,a._rateSeek=0,a._playStart=t.ctx.currentTime;var y=(a._stop-a._start)*1e3/Math.abs(a._rate);u._endTimers[a._id]=setTimeout(u._ended.bind(u,a),y)}return u._webAudio&&!p&&(a._paused=!0,a._ended=!0,a._seek=a._start||0,a._rateSeek=0,u._clearTimer(a._id),u._cleanBuffer(a._node),t._autoSuspend()),!u._webAudio&&!p&&u.stop(a._id,!0),u},_clearTimer:function(a){var u=this;if(u._endTimers[a]){if(typeof u._endTimers[a]!="function")clearTimeout(u._endTimers[a]);else{var h=u._soundById(a);h&&h._node&&h._node.removeEventListener("ended",u._endTimers[a],!1)}delete u._endTimers[a]}return u},_soundById:function(a){for(var u=this,h=0;h<u._sounds.length;h++)if(a===u._sounds[h]._id)return u._sounds[h];return null},_inactiveSound:function(){var a=this;a._drain();for(var u=0;u<a._sounds.length;u++)if(a._sounds[u]._ended)return a._sounds[u].reset();return new s(a)},_drain:function(){var a=this,u=a._pool,h=0,p=0;if(!(a._sounds.length<u)){for(p=0;p<a._sounds.length;p++)a._sounds[p]._ended&&h++;for(p=a._sounds.length-1;p>=0;p--){if(h<=u)return;a._sounds[p]._ended&&(a._webAudio&&a._sounds[p]._node&&a._sounds[p]._node.disconnect(0),a._sounds.splice(p,1),h--)}}},_getSoundIds:function(a){var u=this;if(typeof a>"u"){for(var h=[],p=0;p<u._sounds.length;p++)h.push(u._sounds[p]._id);return h}else return[a]},_refreshBuffer:function(a){var u=this;return a._node.bufferSource=t.ctx.createBufferSource(),a._node.bufferSource.buffer=i[u._src],a._panner?a._node.bufferSource.connect(a._panner):a._node.bufferSource.connect(a._node),a._node.bufferSource.loop=a._loop,a._loop&&(a._node.bufferSource.loopStart=a._start||0,a._node.bufferSource.loopEnd=a._stop||0),a._node.bufferSource.playbackRate.setValueAtTime(a._rate,t.ctx.currentTime),u},_cleanBuffer:function(a){var u=this,h=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!a.bufferSource)return u;if(t._scratchBuffer&&a.bufferSource&&(a.bufferSource.onended=null,a.bufferSource.disconnect(0),h))try{a.bufferSource.buffer=t._scratchBuffer}catch{}return a.bufferSource=null,u},_clearSound:function(a){var u=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);u||(a.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(a){this._parent=a,this.init()};s.prototype={init:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++t._counter,u._sounds.push(a),a.create(),a},create:function(){var a=this,u=a._parent,h=t._muted||a._muted||a._parent._muted?0:a._volume;return u._webAudio?(a._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),a._node.gain.setValueAtTime(h,t.ctx.currentTime),a._node.paused=!0,a._node.connect(t.masterGain)):t.noAudio||(a._node=t._obtainHtml5Audio(),a._errorFn=a._errorListener.bind(a),a._node.addEventListener("error",a._errorFn,!1),a._loadFn=a._loadListener.bind(a),a._node.addEventListener(t._canPlayEvent,a._loadFn,!1),a._endFn=a._endListener.bind(a),a._node.addEventListener("ended",a._endFn,!1),a._node.src=u._src,a._node.preload=u._preload===!0?"auto":u._preload,a._node.volume=h*t.volume(),a._node.load()),a},reset:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._rateSeek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++t._counter,a},_errorListener:function(){var a=this;a._parent._emit("loaderror",a._id,a._node.error?a._node.error.code:0),a._node.removeEventListener("error",a._errorFn,!1)},_loadListener:function(){var a=this,u=a._parent;u._duration=Math.ceil(a._node.duration*10)/10,Object.keys(u._sprite).length===0&&(u._sprite={__default:[0,u._duration*1e3]}),u._state!=="loaded"&&(u._state="loaded",u._emit("load"),u._loadQueue()),a._node.removeEventListener(t._canPlayEvent,a._loadFn,!1)},_endListener:function(){var a=this,u=a._parent;u._duration===1/0&&(u._duration=Math.ceil(a._node.duration*10)/10,u._sprite.__default[1]===1/0&&(u._sprite.__default[1]=u._duration*1e3),u._ended(a)),a._node.removeEventListener("ended",a._endFn,!1)}};var i={},o=function(a){var u=a._src;if(i[u]){a._duration=i[u].duration,d(a);return}if(/^data:[^;]+;base64,/.test(u)){for(var h=atob(u.split(",")[1]),p=new Uint8Array(h.length),y=0;y<h.length;++y)p[y]=h.charCodeAt(y);c(p.buffer,a)}else{var g=new XMLHttpRequest;g.open(a._xhr.method,u,!0),g.withCredentials=a._xhr.withCredentials,g.responseType="arraybuffer",a._xhr.headers&&Object.keys(a._xhr.headers).forEach(function(m){g.setRequestHeader(m,a._xhr.headers[m])}),g.onload=function(){var m=(g.status+"")[0];if(m!=="0"&&m!=="2"&&m!=="3"){a._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}c(g.response,a)},g.onerror=function(){a._webAudio&&(a._html5=!0,a._webAudio=!1,a._sounds=[],delete i[u],a.load())},l(g)}},l=function(a){try{a.send()}catch{a.onerror()}},c=function(a,u){var h=function(){u._emit("loaderror",null,"Decoding audio data failed.")},p=function(y){y&&u._sounds.length>0?(i[u._src]=y,d(u,y)):h()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(a).then(p).catch(h):t.ctx.decodeAudioData(a,p,h)},d=function(a,u){u&&!a._duration&&(a._duration=u.duration),Object.keys(a._sprite).length===0&&(a._sprite={__default:[0,a._duration*1e3]}),a._state!=="loaded"&&(a._state="loaded",a._emit("load"),a._loadQueue())},f=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var a=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),u=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),h=u?parseInt(u[1],10):null;if(a&&h&&h<9){var p=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!p&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};r.Howler=t,r.Howl=n,typeof Ci<"u"?(Ci.HowlerGlobal=e,Ci.Howler=t,Ci.Howl=n,Ci.Sound=s):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=n,window.Sound=s)})();(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var s=n._howls.length-1;s>=0;s--)n._howls[s].stereo(t);return n},HowlerGlobal.prototype.pos=function(t,n,s){var i=this;if(!i.ctx||!i.ctx.listener)return i;if(n=typeof n!="number"?i._pos[1]:n,s=typeof s!="number"?i._pos[2]:s,typeof t=="number")i._pos=[t,n,s],typeof i.ctx.listener.positionX<"u"?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]);else return i._pos;return i},HowlerGlobal.prototype.orientation=function(t,n,s,i,o,l){var c=this;if(!c.ctx||!c.ctx.listener)return c;var d=c._orientation;if(n=typeof n!="number"?d[1]:n,s=typeof s!="number"?d[2]:s,i=typeof i!="number"?d[3]:i,o=typeof o!="number"?d[4]:o,l=typeof l!="number"?d[5]:l,typeof t=="number")c._orientation=[t,n,s,i,o,l],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(l,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(t,n,s,i,o,l);else return d;return c},Howl.prototype.init=(function(t){return function(n){var s=this;return s._orientation=n.orientation||[1,0,0],s._stereo=n.stereo||null,s._pos=n.pos||null,s._pannerAttr={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:360,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:360,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:0,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:"inverse",maxDistance:typeof n.maxDistance<"u"?n.maxDistance:1e4,panningModel:typeof n.panningModel<"u"?n.panningModel:"HRTF",refDistance:typeof n.refDistance<"u"?n.refDistance:1,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:1},s._onstereo=n.onstereo?[{fn:n.onstereo}]:[],s._onpos=n.onpos?[{fn:n.onpos}]:[],s._onorientation=n.onorientation?[{fn:n.onorientation}]:[],t.call(this,n)}})(Howl.prototype.init),Howl.prototype.stereo=function(t,n){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(t,n)}}),s;var i=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof n>"u")if(typeof t=="number")s._stereo=t,s._pos=[t,0,0];else return s._stereo;for(var o=s._getSoundIds(n),l=0;l<o.length;l++){var c=s._soundById(o[l]);if(c)if(typeof t=="number")c._stereo=t,c._pos=[t,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&e(c,i),i==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(t,0,0):c._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",c._id);else return c._stereo}return s},Howl.prototype.pos=function(t,n,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(t,n,s,i)}}),o;if(n=typeof n!="number"?0:n,s=typeof s!="number"?-.5:s,typeof i>"u")if(typeof t=="number")o._pos=[t,n,s];else return o._pos;for(var l=o._getSoundIds(i),c=0;c<l.length;c++){var d=o._soundById(l[c]);if(d)if(typeof t=="number")d._pos=[t,n,s],d._node&&((!d._panner||d._panner.pan)&&e(d,"spatial"),typeof d._panner.positionX<"u"?(d._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),d._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setPosition(t,n,s)),o._emit("pos",d._id);else return d._pos}return o},Howl.prototype.orientation=function(t,n,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(t,n,s,i)}}),o;if(n=typeof n!="number"?o._orientation[1]:n,s=typeof s!="number"?o._orientation[2]:s,typeof i>"u")if(typeof t=="number")o._orientation=[t,n,s];else return o._orientation;for(var l=o._getSoundIds(i),c=0;c<l.length;c++){var d=o._soundById(l[c]);if(d)if(typeof t=="number")d._orientation=[t,n,s],d._node&&(d._panner||(d._pos||(d._pos=o._pos||[0,0,-.5]),e(d,"spatial")),typeof d._panner.orientationX<"u"?(d._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),d._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setOrientation(t,n,s)),o._emit("orientation",d._id);else return d._orientation}return o},Howl.prototype.pannerAttr=function(){var t=this,n=arguments,s,i,o;if(!t._webAudio)return t;if(n.length===0)return t._pannerAttr;if(n.length===1)if(typeof n[0]=="object")s=n[0],typeof i>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),t._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:t._panningModel});else return o=t._soundById(parseInt(n[0],10)),o?o._pannerAttr:t._pannerAttr;else n.length===2&&(s=n[0],i=parseInt(n[1],10));for(var l=t._getSoundIds(i),c=0;c<l.length;c++)if(o=t._soundById(l[c]),o){var d=o._pannerAttr;d={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:d.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:d.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:d.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:d.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:d.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:d.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:d.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:d.panningModel};var f=o._panner;f||(o._pos||(o._pos=t._pos||[0,0,-.5]),e(o,"spatial"),f=o._panner),f.coneInnerAngle=d.coneInnerAngle,f.coneOuterAngle=d.coneOuterAngle,f.coneOuterGain=d.coneOuterGain,f.distanceModel=d.distanceModel,f.maxDistance=d.maxDistance,f.refDistance=d.refDistance,f.rolloffFactor=d.rolloffFactor,f.panningModel=d.panningModel}return t},Sound.prototype.init=(function(t){return function(){var n=this,s=n._parent;n._orientation=s._orientation,n._stereo=s._stereo,n._pos=s._pos,n._pannerAttr=s._pannerAttr,t.call(this),n._stereo?s.stereo(n._stereo):n._pos&&s.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(t){return function(){var n=this,s=n._parent;return n._orientation=s._orientation,n._stereo=s._stereo,n._pos=s._pos,n._pannerAttr=s._pannerAttr,n._stereo?s.stereo(n._stereo):n._pos?s.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,s._refreshBuffer(n)),t.call(this)}})(Sound.prototype.reset);var e=function(t,n){n=n||"spatial",n==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(sc)),sc}var Ft=sE();const{random:nu,round:iE}=Math,cm=.6,et={bleep:new Ft.Howl({src:"/sounds/bleep.wav"}),blink:new Ft.Howl({src:"/sounds/blink.wav",rate:cm}),gameOver:new Ft.Howl({src:"/sounds/game-over.wav"}),generate:new Ft.Howl({src:"/sounds/generate.wav"}),hit:new Ft.Howl({src:"/sounds/hit.wav"}),kicks:[new Ft.Howl({src:"/sounds/kick-1.wav"}),new Ft.Howl({src:"/sounds/kick-2.wav"})],lowEnergy:new Ft.Howl({src:"/sounds/low-energy.wav"}),plus:new Ft.Howl({src:"/sounds/plus.wav"}),slideIn:new Ft.Howl({src:"/sounds/slide-in.wav"}),slideMove:new Ft.Howl({src:"/sounds/slide-move.wav"}),slideOut:new Ft.Howl({src:"/sounds/slide-out.wav"}),turnOn:new Ft.Howl({src:"/sounds/turn-on.wav"}),wordUp:new Ft.Howl({src:"/sounds/word-up.wav"})};function oE(){et.bleep.play()}function aE(){const r=(e=.02)=>{et.blink.rate(et.blink.rate()+e),et.blink.play()};r(),setTimeout(r,200),setTimeout(()=>r(.04),400)}function um(){et.lowEnergy.play()}function dm(){et.plus.play()}function lE(){et.gameOver.play()}function cE(){et.generate.play()}function fm(r=0){et.hit.rate(1-(r||10)/36),et.hit.play()}function uE(){const r=et.kicks[iE(nu())];r.rate(1-(nu()-.5)/2),r.play()}function dE(){et.newRecord.play()}function su(){et.slideIn.play()}function iu(r=0){et.slideMove.rate(1+r/27),et.slideMove.play()}function hm(){et.slideOut.play()}function fE(){et.turnOn.rate(1-(nu()-.5)/10),et.turnOn.play()}function pm(){et.wordUp.play()}function hE(){et.blink.rate(cm)}const pE=Object.freeze(Object.defineProperty({__proto__:null,playBleep:oE,playBlink:aE,playGameOver:lE,playGenerate:cE,playHit:fm,playKick:uE,playLowEnergy:um,playNewRecord:dE,playPlus:dm,playSlideIn:su,playSlideMove:iu,playSlideOut:hm,playTurnOn:fE,playWordUp:pm,reset:hE},Symbol.toStringTag,{value:"Module"})),Hr="/",gm=new TextEncoder().encode(Hr),Xo=gm[0];class je{_buf;constructor(e,t){if(typeof e=="string")this._buf=j(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Xo)throw new Error("Invalid key")}toString(e="utf8"){return W(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new je(e.join(Hr))}static random(){return new je(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new je(e):typeof e.uint8Array=="function"?new je(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=gm),this._buf[0]!==Xo){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Xo,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Xo;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return je.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Hr).slice(1)}type(){return gE(this.baseNamespace())}name(){return mE(this.baseNamespace())}instance(e){return new je(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Hr)||(e+=Hr),e+=this.type(),new je(e)}parent(){const e=this.list();return e.length===1?new je(Hr):new je(e.slice(0,-1).join(Hr))}child(e){return this.toString()===Hr?e:e.toString()===Hr?this:new je(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return je.withNamespaces([...this.namespaces(),...yE(e.map(t=>t.namespaces()))])}}function gE(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function mE(r){const e=r.split(":");return e[e.length-1]}function yE(r){return[].concat(...r)}const bE="SHARDING";function vE(r){return r[Symbol.asyncIterator]!=null}function Jf(r){if(vE(r))return(async()=>{for await(const e of r);})();for(const e of r);}function wE(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function _E(r){return r[Symbol.asyncIterator]!=null}function En(r,e){let t=0;if(_E(r))return(async function*(){for await(const c of r)await e(c,t++)&&(yield c)})();const n=wE(r),{value:s,done:i}=n.next();if(i===!0)return(function*(){})();const o=e(s,t++);if(typeof o.then=="function")return(async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)})();const l=e;return(function*(){o===!0&&(yield s);for(const c of n)l(c,t++)&&(yield c)})()}function SE(r){return r[Symbol.asyncIterator]!=null}function ou(r){if(SE(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}function EE(r){return r[Symbol.asyncIterator]!=null}function Da(r,e){return EE(r)?(async function*(){yield*(await ou(r)).sort(e)})():(function*(){yield*ou(r).sort(e)})()}function xE(r){return r[Symbol.asyncIterator]!=null}function eh(r,e){return xE(r)?(async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}})()}class mm{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Jf(this.putMany(e,n)),e=[],await Jf(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=En(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>En(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Da(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=En(n,()=>s++>=i)}return e.limit!=null&&(n=eh(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=En(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>En(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Da(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=En(n,()=>i++>=s)}return e.limit!=null&&(n=eh(n,e.limit)),n}}class La extends Error{static name="OpenFailedError";static code="ERR_OPEN_FAILED";name=La.name;code=La.code;constructor(e="Open failed"){super(e)}}class Ra extends Error{static name="PutFailedError";static code="ERR_PUT_FAILED";name=Ra.name;code=Ra.code;constructor(e="Put failed"){super(e)}}class oo extends Error{static name="GetFailedError";static code="ERR_GET_FAILED";name=oo.name;code=oo.code;constructor(e="Get failed"){super(e)}}class Ba extends Error{static name="DeleteFailedError";static code="ERR_DELETE_FAILED";name=Ba.name;code=Ba.code;constructor(e="Delete failed"){super(e)}}let ym=class au extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=au.name;code=au.code;constructor(e="Not Found"){super(e)}};class AE extends mm{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new ym;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new je(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new je(n),t?.signal?.throwIfAborted()}}function cr(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class th{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class ic{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new th(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new th(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let IE=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ad(r={}){return kE(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function kE(r,e){e=e??{};let t=e.onEnd,n=new ic,s,i,o,l=cr();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((g,m)=>{i=w=>{i=null,n.push(w);try{g(r(n))}catch(v){m(v)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{l.resolve(),l=cr()})}},d=g=>i!=null?i(g):(n.push(g),s),f=g=>(n=new ic,i!=null?i({error:g}):(n.push({error:g}),s)),a=g=>{if(o)return s;if(e?.objectMode!==!0&&g?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return d({done:!1,value:g})},u=g=>o?s:(o=!0,g!=null?f(g):d({done:!0})),h=()=>(n=new ic,u(),{done:!0}),p=g=>(u(g),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:h,throw:p,push:a,end:u,get readableLength(){return n.size},onEmpty:async g=>{const m=g?.signal;if(m?.throwIfAborted(),n.isEmpty())return;let w,v;m!=null&&(w=new Promise((_,k)=>{v=()=>{k(new IE)},m.addEventListener("abort",v)}));try{await Promise.race([l.promise,w])}finally{v!=null&&m!=null&&m?.removeEventListener("abort",v)}}},t==null)return s;const y=s;return s={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(g){return y.throw(g),t!=null&&(t(g),t=void 0),{done:!0}},return(){return y.return(),t!=null&&(t(),t=void 0),{done:!0}},push:a,end(g){return y.end(g),t!=null&&(t(g),t=void 0),s},get readableLength(){return y.readableLength},onEmpty:g=>y.onEmpty(g)},s}function CE(r){return r.reason}async function Ct(r,e,t){if(e==null)return r;const n=t?.translateError??CE;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((i,o)=>{s=()=>{o(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}class TE{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=cr(),this.haveNext=cr()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=cr(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=cr(),await Ct(this.readNext.promise,t?.signal,t)}}function PE(){return new TE}function DE(r){return r[Symbol.asyncIterator]!=null}async function LE(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*RE(r){const e=new AbortController,t=PE();LE(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*BE(r){for(const e of r)yield*e}function lu(...r){const e=[];for(const t of r)DE(t)||e.push(t);return e.length===r.length?BE(e):RE(r)}new je(bE);const ni=1e3,si=ni*60,ii=si*60,ms=ii*24,ao=ms*7,oi=ms*365.25,lo=oi/12;function NE(r,e){if(typeof r=="string")return ME(r);if(typeof r=="number")return FE(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var bm=NE;function ME(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,s=parseFloat(t),i=n.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return s*oi;case"months":case"month":case"mo":return s*lo;case"weeks":case"week":case"w":return s*ao;case"days":case"day":case"d":return s*ms;case"hours":case"hour":case"hrs":case"hr":case"h":return s*ii;case"minutes":case"minute":case"mins":case"min":case"m":return s*si;case"seconds":case"second":case"secs":case"sec":case"s":return s*ni;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function OE(r){let e=Math.abs(r);return e>=oi?`${Math.round(r/oi)}y`:e>=lo?`${Math.round(r/lo)}mo`:e>=ao?`${Math.round(r/ao)}w`:e>=ms?`${Math.round(r/ms)}d`:e>=ii?`${Math.round(r/ii)}h`:e>=si?`${Math.round(r/si)}m`:e>=ni?`${Math.round(r/ni)}s`:`${r}ms`}function $E(r){let e=Math.abs(r);return e>=oi?Wn(r,e,oi,"year"):e>=lo?Wn(r,e,lo,"month"):e>=ao?Wn(r,e,ao,"week"):e>=ms?Wn(r,e,ms,"day"):e>=ii?Wn(r,e,ii,"hour"):e>=si?Wn(r,e,si,"minute"):e>=ni?Wn(r,e,ni,"second"):`${r} ms`}function FE(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?$E(r):OE(r)}function Wn(r,e,t,n){let s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function UE(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=bm,t.destroy=d,Object.keys(r).forEach(f=>{t[f]=r[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let a=0;for(let u=0;u<f.length;u++)a=(a<<5)-a+f.charCodeAt(u),a|=0;return t.colors[Math.abs(a)%t.colors.length]}t.selectColor=e;function t(f,a){let u,h=null,p,y;function g(...m){if(!g.enabled)return;const w=g,v=Number(new Date),_=v-(u||v);w.diff=_,w.prev=u,w.curr=v,u=v,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let k=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(D,I)=>{if(D==="%%")return"%";k++;const x=t.formatters[I];if(typeof x=="function"){const B=m[k];D=x.call(w,B),m.splice(k,1),k--}return D}),t.formatArgs.call(w,m),a?.onLog!=null&&a.onLog(...m),(w.log||t.log).apply(w,m)}return g.namespace=f,g.useColors=t.useColors(),g.color=t.selectColor(f),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(p!==t.namespaces&&(p=t.namespaces,y=t.enabled(f)),y),set:m=>{h=m}}),typeof t.init=="function"&&t.init(g),g}function n(f,a){const u=t(this.namespace+(typeof a>"u"?":":a)+f);return u.log=this.log,u}function s(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];let a;const u=(typeof f=="string"?f:"").split(/[\s,]+/),h=u.length;for(a=0;a<h;a++)u[a]&&(f=u[a].replace(/\*/g,".*?"),f[0]==="-"?t.skips.push(new RegExp("^"+f.substr(1)+"$")):t.names.push(new RegExp("^"+f+"$")))}function i(){const f=[...t.names.map(l),...t.skips.map(l).map(a=>"-"+a)].join(",");return t.enable(""),f}function o(f){if(f[f.length-1]==="*")return!0;let a,u;for(a=0,u=t.skips.length;a<u;a++)if(t.skips[a].test(f))return!1;for(a=0,u=t.names.length;a<u;a++)if(t.names[a].test(f))return!0;return!1}function l(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function c(f){return f instanceof Error?f.stack??f.message:f}function d(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var VE={};const Na=YE(),KE=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function qE(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function HE(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+bm(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const zE=console.debug??console.log??(()=>{});function WE(r){try{r?Na?.setItem("debug",r):Na?.removeItem("debug")}catch{}}function GE(){let r;try{r=Na?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=VE.DEBUG),r}function YE(){try{return localStorage}catch{}}function XE(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Jt=UE({formatArgs:HE,save:WE,load:GE,useColors:qE,setupFormatters:XE,colors:KE,storage:Na,log:zE});Jt.formatters.b=r=>r==null?"undefined":Pe.baseEncode(r);Jt.formatters.t=r=>r==null?"undefined":Ln.baseEncode(r);Jt.formatters.m=r=>r==null?"undefined":Po.baseEncode(r);Jt.formatters.p=r=>r==null?"undefined":r.toString();Jt.formatters.c=r=>r==null?"undefined":r.toString();Jt.formatters.k=r=>r==null?"undefined":r.toString();Jt.formatters.a=r=>r==null?"undefined":r.toString();function rh(r,e=""){const t=nh(r.message),n=nh(r.stack);return t!=null&&n!=null?n.includes(t)?`${n.split(`
`).join(`
${e}`)}`:`${t}
${e}${n.split(`
`).join(`
${e}`)}`:n!=null?`${n.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${r.toString()}`}function ZE(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}function vm(r,e=""){if(ZE(r)){let t=rh(r,e);return r.errors.length>0?(e=`${e}    `,t+=`
${e}${r.errors.map(n=>`${vm(n,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return rh(r,e)}Jt.formatters.e=r=>r==null?"undefined":vm(r);function jE(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function ld(r){return{forComponent(e){return cd(e,r)}}}function cd(r,e){let t=jE(`${r}:trace`);return Jt.enabled(`${r}:trace`)&&Jt.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=Jt(`${r}:trace`,e)),Object.assign(Jt(r,e),{error:Jt(`${r}:error`,e),trace:t,newScope:n=>cd(`${r}:${n}`,e)})}function nh(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}cd("datastore:core:tiered");const cu=(r,e)=>e.some(t=>r instanceof t);let sh,ih;function QE(){return sh||(sh=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function JE(){return ih||(ih=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const uu=new WeakMap,oc=new WeakMap,Ll=new WeakMap;function ex(r){const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("success",i),r.removeEventListener("error",o)},i=()=>{t(Bn(r.result)),s()},o=()=>{n(r.error),s()};r.addEventListener("success",i),r.addEventListener("error",o)});return Ll.set(e,r),e}function tx(r){if(uu.has(r))return;const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)});uu.set(r,e)}let du={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return uu.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Bn(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function wm(r){du=r(du)}function rx(r){return JE().includes(r)?function(...e){return r.apply(fu(this),e),Bn(this.request)}:function(...e){return Bn(r.apply(fu(this),e))}}function nx(r){return typeof r=="function"?rx(r):(r instanceof IDBTransaction&&tx(r),cu(r,QE())?new Proxy(r,du):r)}function Bn(r){if(r instanceof IDBRequest)return ex(r);if(oc.has(r))return oc.get(r);const e=nx(r);return e!==r&&(oc.set(r,e),Ll.set(e,r)),e}const fu=r=>Ll.get(r);function sx(r,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){const o=indexedDB.open(r,e),l=Bn(o);return n&&o.addEventListener("upgradeneeded",c=>{n(Bn(o.result),c.oldVersion,c.newVersion,Bn(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),l.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}function ix(r,{blocked:e}={}){const t=indexedDB.deleteDatabase(r);return e&&t.addEventListener("blocked",n=>e(n.oldVersion,n)),Bn(t).then(()=>{})}const ox=["get","getKey","getAll","getAllKeys","count"],ax=["put","add","delete","clear"],ac=new Map;function oh(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(ac.get(e))return ac.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,s=ax.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||ox.includes(t)))return;const i=async function(o,...l){const c=this.transaction(o,s?"readwrite":"readonly");let d=c.store;return n&&(d=d.index(l.shift())),(await Promise.all([d[t](...l),s&&c.done]))[0]};return ac.set(e,i),i}wm(r=>({...r,get:(e,t,n)=>oh(e,t)||r.get(e,t,n),has:(e,t)=>!!oh(e,t)||r.has(e,t)}));const lx=["continue","continuePrimaryKey","advance"],ah={},hu=new WeakMap,_m=new WeakMap,cx={get(r,e){if(!lx.includes(e))return r[e];let t=ah[e];return t||(t=ah[e]=function(...n){hu.set(this,_m.get(this)[e](...n))}),t}};async function*ux(...r){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...r)),!e)return;e=e;const t=new Proxy(e,cx);for(_m.set(t,e),Ll.set(t,fu(e));e;)yield t,e=await(hu.get(t)||e.continue()),hu.delete(t)}function lh(r,e){return e===Symbol.asyncIterator&&cu(r,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&cu(r,[IDBIndex,IDBObjectStore])}wm(r=>({...r,get(e,t,n){return lh(e,t)?ux:r.get(e,t,n)},has(e,t){return lh(e,t)||r.has(e,t)}}));class Sm extends mm{location;version;db;constructor(e,t={}){super(),this.location=`${t.prefix??""}${e}`,this.version=t.version??1}async open(){try{const e=this.location;this.db=await sx(e,this.version,{upgrade(t){t.createObjectStore(e)}})}catch(e){throw new La(String(e))}}async close(){this.db?.close()}async put(e,t,n){if(this.db==null)throw new Error("Datastore needs to be opened.");try{n?.signal?.throwIfAborted(),await Ct(this.db.put(this.location,t,e.toString()),n?.signal)}catch(s){throw new Ra(String(s))}return e}async get(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");let n;try{t?.signal?.throwIfAborted(),n=await Ct(this.db.get(this.location,e.toString()),t?.signal)}catch(s){throw new oo(String(s))}if(n===void 0)throw new ym;return n}async has(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return t?.signal?.throwIfAborted(),!!await Ct(this.db.getKey(this.location,e.toString()))}catch(n){throw new oo(String(n))}}async delete(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");try{t?.signal?.throwIfAborted(),await Ct(this.db.delete(this.location,e.toString()),t?.signal)}catch(n){throw new Ba(String(n))}}batch(){const e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{if(this.db==null)throw new Error("Datastore needs to be opened.");n?.signal?.throwIfAborted();const s=this.db.transaction(this.location,"readwrite");try{const i=e.filter(({key:o})=>t.find(l=>l.toString()===o.toString())==null).map(o=>async()=>{await s.store.put(o.value,o.key.toString())}).concat(t.map(o=>async()=>{await s.store.delete(o.toString())})).concat(async()=>{await s.done});n?.signal?.throwIfAborted(),await Ct(Promise.all(i.map(async o=>{await o()})),n?.signal)}catch{s.abort()}}}}async*query(e,t){let n=this.#e(e,(s,i)=>({key:s,value:i}),t);Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>En(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Da(s,i),n)),yield*n}async*queryKeys(e,t){let n=this.#e(e,s=>s,t);Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>En(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Da(s,i),n)),yield*n}async*#e(e,t,n){if(this.db==null)throw new Error("Datastore needs to be opened.");let s=0,i=-1;n?.signal?.throwIfAborted();for(const o of await this.db.getAllKeys(this.location)){if(n?.signal?.throwIfAborted(),e.prefix!=null&&!o.toString().startsWith(e.prefix))continue;if(e.limit!=null&&s===e.limit)return;if(i++,e.offset!=null&&i<e.offset)continue;const l=new je(o.toString());let c;try{c=await this.get(l,n)}catch(d){if(d.name!=="NotFoundError")throw d;continue}c!=null&&(yield t(l,c),n?.signal?.throwIfAborted(),s++)}}async destroy(){await ix(this.location)}}function Lo(r,e,t=s=>{const i=localStorage.getItem(r);return i?JSON.parse(i):s},n=s=>{localStorage.setItem(r,JSON.stringify(s))}){const s=ir(t(e)||e);return{get(){return Si(s)},set(i){n(i),s.set(i)},update(i){this.set(i(this.get()))},subscribe:s.subscribe}}async function dx(r){const e=new Sm(r);return await e.open().catch(()=>{}),async function(n,s,i=async l=>{const c=await e.get(n).catch(()=>l);return c===void 0&&l!==void 0?(await e.put(n,l),l):c},o=async l=>{await e.put(n,l).catch(()=>{})}){const l=ir(await i(s).catch(()=>s));return{get(){return Si(l)},set(c){o(c).then(()=>l.set(c))},update(c){this.set(c(this.get()))},subscribe:l.subscribe}}}function Un(r){let e=ir(r);return e.get=()=>Si(e),e}function Rl(r=[],e=()=>{}){let t=e1(r,e);return t.get=()=>Si(t),t}const Em=Un(De.cards),Bl=Un(De.energy),Ro=Un(De.log),xm=Un(De.matchedIndexes),fx=Lo(U.moves,De.moves),mt=Lo(U.options,De.options),hn=Un(De.phase),pu=Un(De.plusIndex),Bo=Lo(U.records,De.records),Nl=Un(De.score),ud=Lo(U.timestamp,Date.now()),No=Rl([mt,ud],([{playerName:r},e])=>im({playerName:r,timestamp:e})),Lt=Rl([Ro,mt,No],([r,{rapid:e},t])=>{if(!e)return[];if(t!==Lt.seed&&(Lt.seed=t,Lt.prev=[],Lt.rows=[]),r.length===0){const n=sm(Lt.prev);n&&(Lt.rows=[...Lt.rows,{combo:n,key:performance.now()}],Wr(pm),Lt.rows.length>7&&(Lt.rows=Lt.rows.slice(-7)),Lt.prev=[])}else Lt.prev=r;return Lt.rows}),gu=Lo(U.relays,De.relays,function(e){const t=localStorage.getItem(U.relays),n=t?JSON.parse(t):null;if(!n)return e;const s=new Set(n.active??[]),i=new Set(n.applied??[]),o=new Set(ri);for(const l of ri)i.has(l)||(s.add(l),i.add(l));for(const l of[...i])o.has(l)||(s.delete(l),i.delete(l));return{active:[...s],applied:[...i]}}),Mo=Rl([gu],([{active:r}])=>r),Ml=Rl([Mo],([r])=>r.map(e=>{const t=e.match(/\/p2p\/([a-zA-Z0-9]+)$/);return t?t[1]:null}).filter(Boolean)),Xe=Un(De.overlay),ys={cardsStore:Em,energyStore:Bl,logStore:Ro,matchedIndexesStore:xm,movesStore:fx,optionsStore:mt,phaseStore:hn,plusIndexStore:pu,recordsStore:Bo,scoreStore:Nl,seedStore:No,timestampStore:ud,ready:!0};function Ti(r,e=0){return hr(ys,r,e)}function Wr(r,{muteRapid:e=!1}={}){return Mr(ys,r,{muteRapid:e})}function dd(r){Xe.set(null),tE(ys,r)}var hx=se('<div tabindex="0" role="button"><!> <div></div> <div></div></div>');function px(r,e){dt(e,!0);const t=()=>fe(mt,"$optionsStore",d),n=()=>fe(hn,"$phaseStore",d),s=()=>fe(xm,"$matchedIndexesStore",d),i=()=>fe(Ro,"$logStore",d),o=()=>fe(pu,"$plusIndexStore",d),l=()=>fe(Em,"$cardsStore",d),c=()=>fe(No,"$seedStore",d),[d,f]=tr();let a=null,u=null,h=null,p=le(null),y=null,g=le(null),m=le(null),w=ie(()=>t().rapid),v=ie(()=>n()===te.idle),_=ie(()=>s().size>0&&i().length===1),k=ie(()=>!b(v)&&!b(_)),P=ie(()=>!b(v)||o()!==null),D=ie(()=>l()[o()]),I=ie(()=>!!(b(D)||b(p)||b(_))),x=ie(()=>Pl(l()));st(()=>{const Y=b(D)||b(p);Y&&X(g,Y,!0)}),st(()=>{s().size>0&&E({muteSound:!0})}),st(()=>{c()&&ct(()=>E({muteSound:!0}))});function B(){return!!b(p)}function Q({x:Y=0,y:oe=0}={}){if(!b(v))return{};if(S(),b(p)){y=b(p),Y+=b(p).x,oe+=b(p).y;const ye=Y<0?Le.columns-1:Y%Le.columns,pt=oe<0?Le.rows-1:oe%Le.rows;return A({x:ye,y:pt,topEdge:pt===0&&y&&y.y===Le.rows-1,bottomEdge:pt===Le.rows-1&&y&&y.y===0})}if(Y!==0)return y?(newValue={x:Y>0?0:Le.columns-1,y:y.y},y=null,A(newValue)):A({x:Math.round(Le.columns/2)+Y+(Y>0?-1:0),y:Math.round(Le.rows/2)+(Y>0?0:-1)});if(oe!==0){if(y){const ye={x:y.x,y:oe>0?0:Le.rows-1};return y=null,A(ye)}return A({x:Math.round(Le.columns/2)+(oe>0?-1:0),y:Math.round(Le.rows/2)+oe+(oe>0?-1:0)})}return b(p)||{}}function M(){if(!B())return;y=null;const Y=l().findIndex(({x:oe,y:ye})=>oe===b(p).x&&ye===b(p).y);Y!==-1&&(Nt(pu,Y),!b(P)&&Wr(dm,{muteRapid:!0}))}function A(Y){B()||Wr(su);const oe=b(x)[Y.x][Y.y];return Wr(()=>iu(l()[oe].value)),X(p,Y,!0)}function E({savePrev:Y=!1,muteSound:oe=!1}={}){B()&&(y=Y?b(p):null,X(p,null),oe||Wr(hm))}function S(){u.style.animation="none",u.offsetHeight,u.style.animation=null,h.style.animation="none",h.offsetHeight,h.style.animation=null}function T(Y){if(b(P)||b(m)!==null)return;B()||Wr(su);const oe=l()[Y];oe&&(b(p)&&b(p).x===oe.x&&b(p).y===oe.y||(S(),Wr(()=>iu(oe.value)),y=b(p),X(p,oe,!0)))}function C(Y){if(Y===a)return null;if(Y.classList.contains("card"))return Y;const oe=Y.querySelector(".card");if(oe)return oe;let ye=Y.parentElement;for(;ye;){if(ye.classList.contains("card"))return ye;ye=ye.parentElement}return null}function L(Y){const oe=C(Y.target);if(!oe||!oe.dataset.index)return null;const ye=Number(oe.dataset.index);return isNaN(ye)?null:ye}function R(Y){if(!ys.ready)return;const oe=L(Y);oe!==null&&oe>=0&&T(oe)}function N(Y){E({muteSound:n()!==te.idle})}function $(Y){if(b(P))return;const oe=L(Y.detail);oe!==null&&(T(oe),b(w)||X(m,oe,!0),Y.detail.type==="mousedown"&&(Wr(()=>fm(l()[oe].value),{}),b(w)&&M()))}function q(Y){b(w)||L(Y.detail)!==b(m)||(X(m,null),M(),E())}function F(Y){b(w)||X(m,null)}function H(Y){Y.preventDefault()}function G(Y,{duration:oe=400}={}){let ye;st(()=>{const pt=(gr={})=>{Y.dispatchEvent(new CustomEvent("longpressstart",{bubbles:!0,detail:gr})),ye=window.setTimeout(()=>{Y.dispatchEvent(new CustomEvent("longpressfire",{bubbles:!0,detail:gr}))},oe)},nr=(gr={})=>{clearTimeout(ye),Y.dispatchEvent(new CustomEvent("longpressend",{bubbles:!0,detail:gr}))};return Y.addEventListener("mousedown",pt,{passive:!0}),Y.addEventListener("touchstart",pt,{passive:!0}),Y.addEventListener("touchend",nr,{passive:!0}),window.addEventListener("mouseup",nr,{passive:!0}),()=>{clearTimeout(ye),Y.removeEventListener("mousedown",pt),Y.removeEventListener("touchstart",pt),Y.removeEventListener("touchend",nr),window.removeEventListener("mouseup",nr)}})}var re={isFocused:B,shiftFocus:Q,plusFocusedCard:M,focusCard:A,blur:E,longpress:G},ne=hx();let K;ne.__mousemove=R,ne.__dblclick=H;let ee;var ge=O(ne);Pn(ge,1,l,ti,(Y,oe,ye)=>{const pt=ie(()=>b(oe).x===(b(p)&&b(p).x)&&b(oe).y===(b(p)&&b(p).y));{let nr=ie(()=>s().has(ye)),gr=ie(()=>ye===b(m)),zn=ie(()=>ye===o());nE(Y,{get card(){return b(oe)},index:ye,get focus(){return b(pt)},get blink(){return b(nr)},get longpress(){return b(gr)},get plus(){return b(zn)}})}});var Me=z(ge,2);let tt;Ze(Me,Y=>u=Y,()=>u);var Oe=z(Me,2);let ht;Ze(Oe,Y=>h=Y,()=>h),Ze(ne,Y=>a=Y,()=>a),Ug(ne,Y=>G?.(Y)),Te(()=>{K=Ue(ne,1,"board svelte-nytrg3",null,K,{overflow:b(k),progress:b(P)}),ee=kt(ne,"",ee,{"--focus-x":b(g)&&b(g).x,"--focus-y":b(g)&&b(g).y}),tt=Ue(Me,1,"slider horizontal svelte-nytrg3",null,tt,{blink:b(_),focus:b(I)}),ht=Ue(Oe,1,"slider vertical svelte-nytrg3",null,ht,{blink:b(_),focus:b(I)})}),vr("mouseleave",ne,N),vr("longpressstart",ne,$),vr("longpressfire",ne,q),vr("longpressend",ne,F),J(r,ne);var Vr=ft(re);return f(),Vr}Fr(["mousemove","dblclick"]);var gx=se('<span class="back svelte-5x6s5r">O</span>'),mx=se("<span> </span>"),yx=se('<span class="energy-out svelte-5x6s5r"></span>'),bx=se('<div class="energy svelte-5x6s5r"><div><span> </span></div> <div><span><span class="front svelte-5x6s5r"> </span> <!></span></div> <!></div>');function Am(r,e){dt(e,!0);const t=()=>fe(Bl,"$energyStore",s),n=()=>fe(hn,"$phaseStore",s),[s,i]=tr();let o=Jr(e,"gameOver",3,!1),l=le(!1),c=ie(()=>t().value),d=ie(()=>b(c)>100),f=ie(()=>b(c)<20&&n()===te.idle),a=ie(()=>`
    z-index: ${b(d)?0:1};
    flex: ${(b(d)?200-b(c):b(c))/100};
  `),u=ie(()=>`
    position: ${b(d)?"absolute":"relative"};
  `),h=ie(()=>`
    z-index: ${b(d)?1:0};
    flex: ${b(d)?(b(c)-100)/100:0};
  `),p=ie(()=>`
    position: ${b(d)?"relative":"absolute"};
    left: ${b(d)?`calc(${b(c)>119?0:(b(c)-120)/100} * 128rem)`:0};
  `);st(()=>{b(f)&&Wr(um)}),st(()=>{o()&&!b(l)&&setTimeout(()=>X(l,!0))});var y=bx(),g=O(y);let m;var w=O(g);let v;var _=O(w),k=z(g,2);let P;var D=O(k);let I;var x=O(D),B=O(x),Q=z(x,2);{var M=S=>{var T=gx();J(S,T)};we(Q,S=>{o()&&S(M)})}var A=z(k,2);{var E=S=>{var T=yx();Pn(T,20,()=>"ut of energy",ti,(C,L,R)=>{var N=mx();kt(N,"",{},{"animation-delay":`${400+R*100}ms`});var $=O(N);Te(()=>{Ue(N,1,Kg(L===" "?"space":"letter"),"svelte-5x6s5r"),ze($,L)}),J(C,N)}),J(S,T)};we(A,S=>{o()&&S(E)})}Te(()=>{m=Ue(g,1,"left-bar svelte-5x6s5r",null,m,{warning:b(f)}),kt(g,b(a)),v=Ue(w,1,"left-value svelte-5x6s5r",null,v,{warning:b(f)}),kt(w,b(u)),ze(_,b(c)),P=Ue(k,1,"right-bar svelte-5x6s5r",null,P,{extra:b(d)}),kt(k,b(h)),I=Ue(D,1,"right-value svelte-5x6s5r",null,I,{warning:b(f),flip:b(l)}),kt(D,b(p)),ze(B,b(c))}),J(r,y),ft(),i()}t_();const vx=r=>r;function Im(r){const e=r-1;return e*e*e+1}function wx(r){return r<.5?4*r*r*r:.5*Math.pow(2*r-2,3)+1}function mu(r){const e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}function Lr(r,{delay:e=0,duration:t=400,easing:n=wx,amount:s=5,opacity:i=0}={}){const o=getComputedStyle(r),l=+o.opacity,c=o.filter==="none"?"":o.filter,d=l*(1-i),[f,a]=mu(s);return{delay:e,duration:t,easing:n,css:(u,h)=>`opacity: ${l-d*h}; filter: ${c} blur(${h*f}${a});`}}function ga(r,{delay:e=0,duration:t=400,easing:n=vx}={}){const s=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:n,css:i=>`opacity: ${i*s}`}}function qt(r,{delay:e=0,duration:t=400,easing:n=Im,x:s=0,y:i=0,opacity:o=0}={}){const l=getComputedStyle(r),c=+l.opacity,d=l.transform==="none"?"":l.transform,f=c*(1-o),[a,u]=mu(s),[h,p]=mu(i);return{delay:e,duration:t,easing:n,css:(y,g)=>`
			transform: ${d} translate(${(1-y)*a}${u}, ${(1-y)*h}${p});
			opacity: ${c-f*g}`}}function ch(r,{delay:e=0,duration:t=400,easing:n=Im,axis:s="y"}={}){const i=getComputedStyle(r),o=+i.opacity,l=s==="y"?"height":"width",c=parseFloat(i[l]),d=s==="y"?["top","bottom"]:["left","right"],f=d.map(m=>`${m[0].toUpperCase()}${m.slice(1)}`),a=parseFloat(i[`padding${f[0]}`]),u=parseFloat(i[`padding${f[1]}`]),h=parseFloat(i[`margin${f[0]}`]),p=parseFloat(i[`margin${f[1]}`]),y=parseFloat(i[`border${f[0]}Width`]),g=parseFloat(i[`border${f[1]}Width`]);return{delay:e,duration:t,easing:n,css:m=>`overflow: hidden;opacity: ${Math.min(m*20,1)*o};${l}: ${m*c}px;padding-${d[0]}: ${m*a}px;padding-${d[1]}: ${m*u}px;margin-${d[0]}: ${m*h}px;margin-${d[1]}: ${m*p}px;border-${d[0]}-width: ${m*y}px;border-${d[1]}-width: ${m*g}px;min-${l}: 0`}}var _x=se('<span class="plus svelte-zkpbwt">+</span>'),Sx=se('<span class="value svelte-zkpbwt"> </span> <!>',1),Ex=se('<span class="counts svelte-zkpbwt"> </span>'),xx=se('<span class="svelte-zkpbwt">]</span> <!> <span class="svelte-zkpbwt">=</span> <span class="sum svelte-zkpbwt"> </span>',1),Ax=se('<span class="extra svelte-zkpbwt"> </span> <span class="svelte-zkpbwt">]=</span> <span class="sum svelte-zkpbwt"> </span>',1),Ix=se('<li class="row svelte-zkpbwt"><span class="svelte-zkpbwt"></span> <span class="svelte-zkpbwt">[</span> <!> <!></li>'),kx=se('<span class="svelte-zkpbwt"> </span>'),Cx=se('<li><!> <span class="sum svelte-zkpbwt"> </span></li>'),Tx=se('<span class="combo svelte-zkpbwt"> </span>'),Px=se('<ol class="log svelte-zkpbwt"><!> <!> <!></ol>');function Dx(r,e){dt(e,!1);const t=()=>fe(hn,"$phaseStore",o),n=()=>fe(Ro,"$logStore",o),s=()=>fe(Nl,"$scoreStore",o),i=()=>fe(Lt,"$combosStore",o),[o,l]=tr();function c(y=[]){let{length:g}=y;return g<1?"":(g>4&&(g=4),y.reduce((m,w,v)=>m+`--clr-${v+1}: var(--color-${w});`,`animation: colors-${g} ${200+200*g}ms steps(2, end) infinite;`))}J_();var d=Px(),f=O(d);{var a=y=>{var g=Xr(),m=rt(g);Pn(m,1,n,ti,(w,v,_)=>{let k=()=>b(v).digits,P=()=>b(v).counts,D=()=>b(v).extra,I=()=>b(v).sum,x=()=>C_(b(v),["digits","counts","extra","sum"]);const B=to(()=>Object.keys(x()));var Q=Ix(),M=O(Q);M.textContent=_+1;var A=z(M,4);Pn(A,1,()=>b(B),ti,(C,L,R)=>{var N=Sx(),$=rt(N);let q;var F=O($),H=z($,2);{var G=re=>{var ne=_x();J(re,ne)};we(H,re=>{R<b(B).length-1&&re(G)})}Te(()=>{q=kt($,"",q,{color:`var(--color-${b(L)??""})`}),ze(F,x()[b(L)])}),J(C,N)});var E=z(A,2);{var S=C=>{var L=xx(),R=z(rt(L),2);{var N=F=>{var H=Ex(),G=O(H);Te(re=>{kt(H,re),ze(G,P())},[()=>c(k())]),J(F,H)};we(R,F=>{P()>1&&F(N)})}var $=z(R,4),q=O($);Te(()=>ze(q,(_+1)*I()*P())),J(C,L)},T=C=>{var L=Ax(),R=rt(L),N=O(R),$=z(R,4),q=O($);Te(()=>{ze(N,D()),ze(q,(_+1)*D())}),J(C,L)};we(E,C=>{D()===void 0?C(S):C(T,!1)})}xe(1,Q,()=>ch,()=>Ti({duration:100})),xe(2,Q,()=>ga,()=>Ti({duration:200})),J(w,Q)}),J(y,g)};we(f,y=>{t()!==te.score&&y(a)})}var u=z(f,2);{var h=y=>{const g=to(()=>n().length===1);var m=Cx();let w;var v=O(m);{var _=D=>{var I=kx(),x=O(I);Te(()=>ze(x,b(g)?"":"combo:")),xe(2,I,()=>ga,()=>Ti({duration:200})),J(D,I)};we(v,D=>{t()===te.combo&&D(_)})}var k=z(v,2),P=O(k);Te(()=>{w=Ue(m,1,"svelte-zkpbwt",null,w,{collapse:b(g)}),ze(P,`${t()===te.score&&s().buffer>0?"+":""}${s().buffer??""}`)}),xe(1,m,()=>ch,()=>Ti({duration:b(g)?0:100})),xe(2,m,()=>ga,()=>Ti({duration:200})),J(y,m)};we(u,y=>{(t()===te.combo||t()===te.score)&&y(h)})}var p=z(u,2);Pn(p,1,i,({combo:y,key:g})=>g,(y,g)=>{let m=()=>b(g).combo;var w=Tx(),v=O(w);Te(()=>ze(v,`+${m()??""}`)),J(y,w)}),J(r,d),ft(),l()}var Lx=se('<span class="value"> </span>'),Rx=se('<span tabindex="0" role="button"><span> </span> <!></span>');function km(r,e){dt(e,!0);const t=()=>fe(Nl,"$scoreStore",i),n=()=>fe(Bo,"$recordsStore",i),s=()=>fe(hn,"$phaseStore",i),[i,o]=tr(),l={[U.highCombo]:"hi-combo",[U.highScore]:"hi-score",[U.score]:"score"};let c=le(Qr(U.score)),d=le(null),f=le(!1),a=le(!1),u=ie(()=>b(c)===U.score?t().value:n()[b(c)][U.value]),h=ie(()=>"score: "+b(u)+`
high score: `+n()[U.highScore][U.value]+`
high combo: `+n()[U.highCombo][U.value]);st(()=>{e.newRecord&&(X(c,e.newRecordHighScore?U.highScore:U.highCombo,!0),X(f,!0))});function p(){return b(a)}function y(){X(a,!0)}function g(){X(a,!1)}function m(x){x.preventDefault(),X(c,v(b(c)),!0),_()}function w(){X(c,v(b(c),!0),!0),_()}function v(x,B=!1){return e.newRecord?{[U.highScore]:e.newRecordHighCombo?U.highCombo:U.highScore,[U.highCombo]:e.newRecordHighScore?U.highScore:U.highCombo}[x]:B?{[U.score]:U.highCombo,[U.highScore]:U.score,[U.highCombo]:U.highScore}[x]:{[U.score]:U.highScore,[U.highScore]:U.highCombo,[U.highCombo]:U.score}[x]}function _(){X(f,!0),clearTimeout(b(d)),!e.newRecord&&X(d,setTimeout(()=>{X(c,U.score,!0),X(f,e.newRecord,!0)},3200),!0)}var k={isFocused:p,focus:y,blur:g,nextType:m,prevType:w},P=Xr(),D=rt(P);O_(D,()=>b(c),x=>{var B=Rx();let Q;B.__click=m;var M=O(B);let A;var E=O(M),S=z(M,2);{var T=C=>{var L=Lx(),R=O(L);Te(()=>ze(R,b(u))),J(C,L)};we(S,C=>{(e.overlaid||s()!==te.gameOver)&&C(T)})}Te(()=>{Q=Ue(B,1,"score",null,Q,{focus:b(a)}),Dn(B,"title",b(h)),A=Ue(M,1,"type",null,A,{visible:b(f)}),ze(E,`${l[b(c)]??""}:`)}),xe(1,B,()=>Lr),J(x,B)}),J(r,P);var I=ft(k);return o(),I}Fr(["click"]);var Bx=se('<span class="rapid">rapid</span>'),Nx=se('<div class="section-1"><button title="[open menu]"><h1>digifall <!></h1> <!></button></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div>',1),Mx=se('<div><div class="seedground"></div> <div class="content"><!></div></div>');function Ox(r,e){dt(e,!0);const t=()=>fe(Ro,"$logStore",l),n=()=>fe(Lt,"$combosStore",l),s=()=>fe(Xe,"$overlayStore",l),i=()=>fe(No,"$seedStore",l),o=()=>fe(mt,"$optionsStore",l),[l,c]=tr();let d=le(null),f=le(null),a=le(null),u=ie(()=>t().length>0||n().length>0);st(()=>{b(d)&&(b(d).isFocused=()=>b(d).classList.contains("focus"),b(d).focus=()=>b(d).classList.add("focus"),b(d).blur=()=>b(d).classList.remove("focus"))});function h(){b(d).isFocused()?(b(d).blur(),b(a).shiftFocus({y:1})):b(f).isFocused()?(b(f).blur(),b(d).focus()):b(a).shiftFocus({y:1}).topEdge&&(b(a).blur({savePrev:!0}),b(f).focus())}function p(){b(d).isFocused()?(b(d).blur(),b(f).focus()):b(f).isFocused()?(b(f).blur(),b(a).shiftFocus({y:-1})):b(a).shiftFocus({y:-1}).bottomEdge&&(b(a).blur({savePrev:!0}),b(d).focus())}function y(){b(d).isFocused()||(b(f).isFocused()?b(f).prevType():b(a).shiftFocus({x:-1}))}function g(){b(d).isFocused()||(b(f).isFocused()?b(f).nextType():b(a).shiftFocus({x:1}))}function m(){b(d).isFocused()?(b(d).click(),b(d).blur(),b(a).blur({savePrev:!0})):b(f).isFocused()?b(f).nextType():b(a).plusFocusedCard()}function w(){b(d).blur(),b(f).blur(),b(a).blur()}function v(M){if(!M)return;const A=()=>M=Ta(M),E=(q=13)=>`hsl(${A()%360},50%,${q}%)`,S=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149];let T=4;const C=[];for(;T--;){const[q]=S.splice(A()%S.length,1);C.push(q)}const[L,R,N,$]=C;return`
      background-color: var(--color-dark);
      background-image:
        linear-gradient(90deg, ${E()} 50%, transparent 50%),
        linear-gradient(90deg, ${E()} 50%, transparent 50%),
        linear-gradient(90deg, transparent 50%, ${E()} 50%),
        linear-gradient(90deg, transparent 50%, ${E()} 50%);
      background-size: ${L}rem, ${R}rem, ${N}rem, ${$}rem;`}var _={moveUp:h,moveDown:p,moveLeft:y,moveRight:g,perfomAction:m,blur:w},k=Mx();let P;var D=O(k),I=z(D,2),x=O(I);{var B=M=>{var A=Nx(),E=rt(A),S=O(E);let T;S.__click=()=>Nt(Xe,de.menu);var C=O(S),L=z(O(C));{var R=ne=>{var K=Bx();J(ne,K)};we(L,ne=>{o().rapid&&ne(R)})}var N=z(C,2);Dx(N,{}),Ze(S,ne=>X(d,ne),()=>b(d));var $=z(E,2),q=O($);Ze(km(q,{}),ne=>X(f,ne,!0),()=>b(f));var F=z($,2),H=O(F);Ze(px(H,{}),ne=>X(a,ne,!0),()=>b(a));var G=z(F,2),re=O(G);Am(re,{}),Te(()=>T=Ue(S,1,"digifall",null,T,{screen:b(u)})),J(M,A)};we(x,M=>{i()&&M(B)})}Te(M=>{P=Ue(k,1,"game",null,P,{blur:s()}),kt(D,M)},[()=>v(i())]),J(r,k);var Q=ft(_);return c(),Q}Fr(["click"]);var $x=se("<h1> </h1>"),Fx=se("<button>p2p leaderboard</button>"),Ux=se('<div class="col"><button>new game</button> <!> <button>options</button></div>'),Vx=se('<div><div class="section-1"><!></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div></div>');function Kx(r,e){dt(e,!0);const t=()=>fe(Bl,"$energyStore",o),n=()=>fe(Bo,"$recordsStore",o),s=()=>fe(Nl,"$scoreStore",o),i=()=>fe(mt,"$optionsStore",o),[o,l]=tr();let c=Jr(e,"scoreComponent",15,null),d=ie(()=>t().value===0),f=ie(()=>b(d)&&t().buffer===0),a=ie(()=>n()[U.highCombo][U.value]),u=ie(()=>b(f)&&b(a)>ys[U.highComboPrev]),h=ie(()=>b(f)&&s().value>ys[U.highScorePrev]),p=ie(()=>b(u)||b(h));function y(){dd()}function g(){Xe.set(de.leaderboard)}function m(){Xe.set(de.options)}var w=Vx();let v;var _=O(w),k=O(_);{var P=E=>{var S=$x(),T=O(S);Te(()=>ze(T,b(p)?"new record!":"game over")),xe(5,S,()=>qt,()=>({delay:600,y:-48})),J(E,S)};we(k,E=>{b(f)&&E(P)})}var D=z(_,2),I=O(D);Ze(km(I,{get newRecordHighCombo(){return b(u)},get newRecordHighScore(){return b(h)},get newRecord(){return b(p)},overlaid:!0}),E=>c(E),()=>c());var x=z(D,2),B=O(x);{var Q=E=>{var S=Ux(),T=O(S);T.__click=y;var C=z(T,2);{var L=N=>{var $=Fx();$.__click=g,J(N,$)};we(C,N=>{i()[U.leaderboard]&&N(L)})}var R=z(C,2);R.__click=m,xe(5,S,()=>qt,()=>({delay:600,y:24})),J(E,S)};we(B,E=>{b(f)&&E(Q)})}var M=z(x,2),A=O(M);Am(A,{get gameOver(){return b(f)}}),Te(()=>v=Ue(w,1,"game-over content",null,v,{"new-record":b(p)})),xe(1,w,()=>Lr),J(r,w),ft(),l()}Fr(["click"]);var qx=se('<div class="virtual-item svelte-a5i8l1"><!></div>'),Hx=se('<div class="virtual-scroll svelte-a5i8l1"><div class="virtual-list"></div></div>');function zx(r,e){dt(e,!0);let t=Jr(e,"bufferSize",3,16),n=Jr(e,"startIndex",15,0),s=Jr(e,"endIndex",15,0),i=Jr(e,"keyFn",3,(k,P)=>P),o=le(null),l=le(0),c=le(0),d=le(0),f=ie(()=>Math.max(0,n()-t())),a=ie(()=>Math.min(s()+t(),e.items.length)),u=ie(()=>e.items.slice(b(f),b(a))),h=ie(()=>b(f)*b(c)),p=ie(()=>e.items.length*b(c));st(()=>{b(c)&&(n(Math.floor(b(d)/b(c))),s(n()+Math.ceil(b(l)/b(c))))});function y(k){X(d,k.target.scrollTop)}function g(k,P=!1){k<0||k>=e.items.length||requestAnimationFrame(()=>{b(o)?.scrollTo({top:k*b(c),behavior:P?"smooth":"instant"})})}var m={scrollToIndex:g},w=Hx(),v=O(w);let _;return Pn(v,23,()=>b(u),(k,P)=>i()(k,b(f)+P),(k,P,D)=>{var I=qx(),x=O(I);$g(x,()=>e.children??Vt,()=>b(P),()=>b(f)+b(D)),Uf(I,"offsetHeight",B=>X(c,B)),J(k,I)}),Ze(w,k=>X(o,k),()=>b(o)),Te(()=>_=kt(v,"",_,{height:`${b(p)??""}px`,"padding-top":`${b(h)??""}px`})),vr("scroll",w,y),Uf(w,"offsetHeight",k=>X(l,k)),J(r,w),ft(m)}const Wx=Symbol.for("@libp2p/connection"),uh=Symbol.for("@libp2p/content-routing");let co=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class Gx extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}class dh extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}}let V=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class Cm extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class Tm extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class yu extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class Yx extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Vi extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class Xx extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class Pi extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}class fh extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}}class Ma extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}}class Pm extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let fd=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class Oo extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class Vn extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class Zx extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class $e extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}let lc=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},jx=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class uo extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class ma extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class bu extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class hh extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class Qx extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class Dm extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class Ar extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class Jx extends Event{data;constructor(e,t){super("message",t),this.data=e}}class Ol extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}}class eA extends Ol{constructor(e,t){super(!0,e,t)}}class tA extends Ol{constructor(e,t){super(!1,e,t)}}const Oa=Symbol.for("@libp2p/peer-discovery"),ot=Symbol.for("@libp2p/peer-id");function Gi(r){return!!r?.[ot]}const ph=Symbol.for("@libp2p/peer-routing"),hd="keep-alive";function pd(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Lm(...r){const e=[];for(const t of r)pd(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Rm(...r){const e=[];for(const t of r)pd(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const Bm=Symbol.for("@libp2p/transport");var $a;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})($a||($a={}));class Dt extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}const Er=Symbol.for("@libp2p/service-capabilities"),Fa=Symbol.for("@libp2p/service-dependencies");class gh extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class mh extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class rA extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Mt={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new rA("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};function pe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function an(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=on(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const Nm=Symbol.for("@achingbrain/uint8arraylist");function yh(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Zo(r){return!!r?.[Nm]}class Ne{bufs;length;[Nm]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Zo(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Zo(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=yh(this.bufs,e);return t.buf[t.index]}set(e,t){const n=yh(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Zo(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return an(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:an(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Ne;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],l=s,c=l+o.byteLength;if(s=c,e>=c)continue;const d=e>=l&&e<c,f=t>l&&t<=c;if(d&&f){if(e===l&&t===c){n.push(o);break}const a=e-l;n.push(o.subarray(a,a+(t-e)));break}if(d){if(e===0){n.push(o);continue}n.push(o.subarray(e-l));continue}if(f){if(t===c){n.push(o);break}n.push(o.subarray(0,t-l));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Zo(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let a=0;a<i;a++)o[a]=-1;for(let a=0;a<s;a++)o[n[a]]=a;const l=o,c=this.byteLength-n.byteLength,d=n.byteLength-1;let f;for(let a=t;a<=c;a+=f){f=0;for(let u=d;u>=0;u--){const h=this.get(a+u);if(n[u]!==h){f=Math.max(1,u-l[h]);break}}if(f===0)return a}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=on(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=on(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Ne)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!pe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Ne;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const nA=parseInt("11111",2),vu=parseInt("10000000",2),sA=parseInt("01111111",2),bh={0:Di,1:Di,2:iA,3:lA,4:cA,5:aA,6:oA,16:Di,22:Di,48:Di};function Kn(r,e={offset:0}){const t=r[e.offset]&nA;if(e.offset++,bh[t]!=null)return bh[t](r,e);throw new Error("No decoder for tag "+t)}function $o(r,e){let t=0;if((r[e.offset]&vu)===vu){const n=r[e.offset]&sA;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Di(r,e){$o(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Kn(r,e);if(n===null)break;t.push(n)}return t}function iA(r,e){const t=$o(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function oA(r,e){const t=$o(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let l=`${i}.${o}`,c=[];for(;e.offset<n;){const d=r[e.offset];if(e.offset++,c.push(d&127),d<128){c.reverse();let f=0;for(let a=0;a<c.length;a++)f+=c[a]<<a*7;l+=`.${f}`,c=[]}}return l}function aA(r,e){return e.offset++,null}function lA(r,e){const t=$o(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function cA(r,e){const t=$o(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function uA(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ne;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function $l(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=uA(r.byteLength);return new Ne(Uint8Array.from([e.byteLength|vu]),e)}function Xt(r){const e=new Ne,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ne(Uint8Array.from([2]),$l(e),e)}function gd(r){const e=Uint8Array.from([0]),t=new Ne(e,r);return new Ne(Uint8Array.from([3]),$l(t),t)}function dA(r){return new Ne(Uint8Array.from([4]),$l(r),r)}function nn(r,e=48){const t=new Ne;for(const n of r)t.append(n);return new Ne(Uint8Array.from([e]),$l(t),t)}const Mm="1.2.840.10045.3.1.7",Om="1.3.132.0.34",$m="1.3.132.0.35";async function fA(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function hA(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function pA(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const gA=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),mA=Uint8Array.from([6,5,43,129,4,0,34]),yA=Uint8Array.from([6,5,43,129,4,0,35]),Fm={ext:!0,kty:"EC",crv:"P-256"},Um={ext:!0,kty:"EC",crv:"P-384"},Vm={ext:!0,kty:"EC",crv:"P-521"},zs=32,Ws=48,Gs=66;function bA(r){const e=Kn(r);return Km(e)}function Km(r){const e=r[1],t=W(e,"base64url"),n=r[2][1][0],s=1;let i,o;if(e.byteLength===zs)return i=W(n.subarray(s,s+zs),"base64url"),o=W(n.subarray(s+zs),"base64url"),new ba({...Fm,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Ws)return i=W(n.subarray(s,s+Ws),"base64url"),o=W(n.subarray(s+Ws),"base64url"),new ba({...Um,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Gs)return i=W(n.subarray(s,s+Gs),"base64url"),o=W(n.subarray(s+Gs),"base64url"),new ba({...Vm,key_ops:["sign"],d:t,x:i,y:o});throw new V(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function qm(r){const e=Kn(r);return Hm(e)}function Hm(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===zs*2+1)return n=W(e.subarray(t,t+zs),"base64url"),s=W(e.subarray(t+zs),"base64url"),new ya({...Fm,key_ops:["verify"],x:n,y:s});if(e.byteLength===Ws*2+1)return n=W(e.subarray(t,t+Ws),"base64url"),s=W(e.subarray(t+Ws),"base64url"),new ya({...Um,key_ops:["verify"],x:n,y:s});if(e.byteLength===Gs*2+1)return n=W(e.subarray(t,t+Gs),"base64url"),s=W(e.subarray(t+Gs),"base64url"),new ya({...Vm,key_ops:["verify"],x:n,y:s});throw new V(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function vA(r){return nn([Xt(Uint8Array.from([1])),dA(j(r.d??"","base64url")),nn([zm(r.crv)],160),nn([gd(new Ne(Uint8Array.from([4]),j(r.x??"","base64url"),j(r.y??"","base64url")))],161)]).subarray()}function wA(r){return nn([Xt(Uint8Array.from([1])),nn([zm(r.crv)],160),nn([gd(new Ne(Uint8Array.from([4]),j(r.x??"","base64url"),j(r.y??"","base64url")))],161)]).subarray()}function zm(r){if(r==="P-256")return gA;if(r==="P-384")return mA;if(r==="P-521")return yA;throw new V(`Invalid curve ${r}`)}async function _A(r="P-256"){const e=await fA(r);return new ba(e.privateKey)}class ya{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=wA(this.jwk)),this._raw}toMultihash(){return it.digest(wr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async verify(e,t,n){return pA(this.jwk,t,e,n)}}class ba{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new ya({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=vA(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async sign(e,t){return hA(this.jwk,e,t)}}function Fl(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Rr(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function be(r,e,t=""){const n=Fl(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,l=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+l+", got "+c)}return r}function md(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Rr(r.outputLen),Rr(r.blockLen)}function Ua(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function SA(r,e){be(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function ln(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Yi(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Ir(r,e){return r<<32-e|r>>>e}function cc(r,e){return r<<e|r>>>32-e>>>0}const Wm=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",EA=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Fo(r){if(be(r),Wm)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=EA[r[t]];return e}const Kr={_0:48,_9:57,A:65,F:70,a:97,f:102};function vh(r){if(r>=Kr._0&&r<=Kr._9)return r-Kr._0;if(r>=Kr.A&&r<=Kr.F)return r-(Kr.A-10);if(r>=Kr.a&&r<=Kr.f)return r-(Kr.a-10)}function fo(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(Wm)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=vh(r.charCodeAt(i)),l=vh(r.charCodeAt(i+1));if(o===void 0||l===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+l}return n}const xA=async()=>{};async function AA(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);const i=Date.now()-n;i>=0&&i<e||(await xA(),n+=i)}}function IA(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function wh(r,e=""){return typeof r=="string"?IA(r):be(r,void 0,e)}function Dr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];be(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function kA(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(r,e)}function yd(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Ul(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const Gm=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function Ym(r,e,t){return r&e^~r&t}function Xm(r,e,t){return r&e^r&t^e&t}class bd{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Yi(this.buffer)}update(e){Ua(this),be(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const l=Math.min(s-this.pos,i-o);if(l===s){const c=Yi(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+l),this.pos),this.pos+=l,o+=l,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ua(this),SA(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,ln(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let a=o;a<s;a++)t[a]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const l=Yi(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const d=c/4,f=this.get();if(d>f.length)throw new Error("_sha2: outputLen bigger than state");for(let a=0;a<d;a++)l.setUint32(4*a,f[a],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:l}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=l,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const yn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),_t=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),jo=BigInt(2**32-1),_h=BigInt(32);function CA(r,e=!1){return e?{h:Number(r&jo),l:Number(r>>_h&jo)}:{h:Number(r>>_h&jo)|0,l:Number(r&jo)|0}}function TA(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l}=CA(r[i],e);[n[i],s[i]]=[o,l]}return[n,s]}const Sh=(r,e,t)=>r>>>t,Eh=(r,e,t)=>r<<32-t|e>>>t,Rs=(r,e,t)=>r>>>t|e<<32-t,Bs=(r,e,t)=>r<<32-t|e>>>t,Qo=(r,e,t)=>r<<64-t|e>>>t-32,Jo=(r,e,t)=>r>>>t-32|e<<64-t;function qr(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const PA=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),DA=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,LA=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),RA=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,BA=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),NA=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,MA=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),bn=new Uint32Array(64);class OA extends bd{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:l,H:c}=this;return[e,t,n,s,i,o,l,c]}set(e,t,n,s,i,o,l,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=l|0,this.H=c|0}process(e,t){for(let a=0;a<16;a++,t+=4)bn[a]=e.getUint32(t,!1);for(let a=16;a<64;a++){const u=bn[a-15],h=bn[a-2],p=Ir(u,7)^Ir(u,18)^u>>>3,y=Ir(h,17)^Ir(h,19)^h>>>10;bn[a]=y+bn[a-7]+p+bn[a-16]|0}let{A:n,B:s,C:i,D:o,E:l,F:c,G:d,H:f}=this;for(let a=0;a<64;a++){const u=Ir(l,6)^Ir(l,11)^Ir(l,25),h=f+u+Ym(l,c,d)+MA[a]+bn[a]|0,y=(Ir(n,2)^Ir(n,13)^Ir(n,22))+Xm(n,s,i)|0;f=d,d=c,c=l,l=o+h|0,o=i,i=s,s=n,n=h+y|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,l=l+this.E|0,c=c+this.F|0,d=d+this.G|0,f=f+this.H|0,this.set(n,s,i,o,l,c,d,f)}roundClean(){ln(bn)}destroy(){this.set(0,0,0,0,0,0,0,0),ln(this.buffer)}}class $A extends OA{A=yn[0]|0;B=yn[1]|0;C=yn[2]|0;D=yn[3]|0;E=yn[4]|0;F=yn[5]|0;G=yn[6]|0;H=yn[7]|0;constructor(){super(32)}}const Zm=TA(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),FA=Zm[0],UA=Zm[1],vn=new Uint32Array(80),wn=new Uint32Array(80);class VA extends bd{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:l,Dl:c,Eh:d,El:f,Fh:a,Fl:u,Gh:h,Gl:p,Hh:y,Hl:g}=this;return[e,t,n,s,i,o,l,c,d,f,a,u,h,p,y,g]}set(e,t,n,s,i,o,l,c,d,f,a,u,h,p,y,g){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=l|0,this.Dl=c|0,this.Eh=d|0,this.El=f|0,this.Fh=a|0,this.Fl=u|0,this.Gh=h|0,this.Gl=p|0,this.Hh=y|0,this.Hl=g|0}process(e,t){for(let v=0;v<16;v++,t+=4)vn[v]=e.getUint32(t),wn[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const _=vn[v-15]|0,k=wn[v-15]|0,P=Rs(_,k,1)^Rs(_,k,8)^Sh(_,k,7),D=Bs(_,k,1)^Bs(_,k,8)^Eh(_,k,7),I=vn[v-2]|0,x=wn[v-2]|0,B=Rs(I,x,19)^Qo(I,x,61)^Sh(I,x,6),Q=Bs(I,x,19)^Jo(I,x,61)^Eh(I,x,6),M=LA(D,Q,wn[v-7],wn[v-16]),A=RA(M,P,B,vn[v-7],vn[v-16]);vn[v]=A|0,wn[v]=M|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:l,Cl:c,Dh:d,Dl:f,Eh:a,El:u,Fh:h,Fl:p,Gh:y,Gl:g,Hh:m,Hl:w}=this;for(let v=0;v<80;v++){const _=Rs(a,u,14)^Rs(a,u,18)^Qo(a,u,41),k=Bs(a,u,14)^Bs(a,u,18)^Jo(a,u,41),P=a&h^~a&y,D=u&p^~u&g,I=BA(w,k,D,UA[v],wn[v]),x=NA(I,m,_,P,FA[v],vn[v]),B=I|0,Q=Rs(n,s,28)^Qo(n,s,34)^Qo(n,s,39),M=Bs(n,s,28)^Jo(n,s,34)^Jo(n,s,39),A=n&i^n&l^i&l,E=s&o^s&c^o&c;m=y|0,w=g|0,y=h|0,g=p|0,h=a|0,p=u|0,{h:a,l:u}=qr(d|0,f|0,x|0,B|0),d=l|0,f=c|0,l=i|0,c=o|0,i=n|0,o=s|0;const S=PA(B,M,E);n=DA(S,x,Q,A),s=S|0}({h:n,l:s}=qr(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=qr(this.Bh|0,this.Bl|0,i|0,o|0),{h:l,l:c}=qr(this.Ch|0,this.Cl|0,l|0,c|0),{h:d,l:f}=qr(this.Dh|0,this.Dl|0,d|0,f|0),{h:a,l:u}=qr(this.Eh|0,this.El|0,a|0,u|0),{h,l:p}=qr(this.Fh|0,this.Fl|0,h|0,p|0),{h:y,l:g}=qr(this.Gh|0,this.Gl|0,y|0,g|0),{h:m,l:w}=qr(this.Hh|0,this.Hl|0,m|0,w|0),this.set(n,s,i,o,l,c,d,f,a,u,h,p,y,g,m,w)}roundClean(){ln(vn,wn)}destroy(){ln(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class KA extends VA{Ah=_t[0]|0;Al=_t[1]|0;Bh=_t[2]|0;Bl=_t[3]|0;Ch=_t[4]|0;Cl=_t[5]|0;Dh=_t[6]|0;Dl=_t[7]|0;Eh=_t[8]|0;El=_t[9]|0;Fh=_t[10]|0;Fl=_t[11]|0;Gh=_t[12]|0;Gl=_t[13]|0;Hh=_t[14]|0;Hl=_t[15]|0;constructor(){super(64)}}const Uo=yd(()=>new $A,Gm(1)),Vl=yd(()=>new KA,Gm(3));const vd=BigInt(0),wu=BigInt(1);function bs(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function jm(r){if(typeof r=="bigint"){if(!va(r))throw new Error("positive bigint expected, got "+r)}else Rr(r);return r}function ea(r){const e=jm(r).toString(16);return e.length&1?"0"+e:e}function Qm(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?vd:BigInt("0x"+r)}function Kl(r){return Qm(Fo(r))}function ho(r){return Qm(Fo(_u(be(r)).reverse()))}function wd(r,e){Rr(e),r=jm(r);const t=fo(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function Jm(r,e){return wd(r,e).reverse()}function _u(r){return Uint8Array.from(r)}const va=r=>typeof r=="bigint"&&vd<=r;function qA(r,e,t){return va(r)&&va(e)&&va(t)&&e<=r&&r<t}function Su(r,e,t,n){if(!qA(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function HA(r){let e;for(e=0;r>vd;r>>=wu,e+=1);return e}const _d=r=>(wu<<BigInt(r))-wu;function zA(r,e,t){if(Rr(r,"hashLen"),Rr(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=g=>new Uint8Array(g),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),l=1e3;let c=n(r),d=n(r),f=0;const a=()=>{c.fill(1),d.fill(0),f=0},u=(...g)=>t(d,Dr(c,...g)),h=(g=s)=>{d=u(i,g),c=u(),g.length!==0&&(d=u(o,g),c=u())},p=()=>{if(f++>=l)throw new Error("drbg: tried max amount of iterations");let g=0;const m=[];for(;g<e;){c=u();const w=c.slice();m.push(w),g+=c.length}return Dr(...m)};return(g,m)=>{a(),h(g);let w;for(;!(w=m(p()));)h();return a(),w}}function Vo(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,l){const c=r[i];if(l&&c===void 0)return;const d=typeof c;if(d!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${d}`)}const s=(i,o)=>Object.entries(i).forEach(([l,c])=>n(l,c,o));s(e,!1),s(t,!0)}function Va(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const Ht=BigInt(0),bt=BigInt(1),Qn=BigInt(2),ey=BigInt(3),ty=BigInt(4),ry=BigInt(5),WA=BigInt(7),ny=BigInt(8),GA=BigInt(9),sy=BigInt(16);function Je(r,e){const t=r%e;return t>=Ht?t:e+t}function Ge(r,e,t){let n=r;for(;e-- >Ht;)n*=n,n%=t;return n}function xh(r,e){if(r===Ht)throw new Error("invert: expected non-zero number");if(e<=Ht)throw new Error("invert: expected positive modulus, got "+e);let t=Je(r,e),n=e,s=Ht,i=bt;for(;t!==Ht;){const l=n/t,c=n%t,d=s-i*l;n=t,t=c,s=i,i=d}if(n!==bt)throw new Error("invert: does not exist");return Je(s,e)}function Sd(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function iy(r,e){const t=(r.ORDER+bt)/ty,n=r.pow(e,t);return Sd(r,n,e),n}function YA(r,e){const t=(r.ORDER-ry)/ny,n=r.mul(e,Qn),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,Qn),s),l=r.mul(i,r.sub(o,r.ONE));return Sd(r,l,e),l}function XA(r){const e=ql(r),t=oy(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+WA)/sy;return(l,c)=>{let d=l.pow(c,o),f=l.mul(d,n);const a=l.mul(d,s),u=l.mul(d,i),h=l.eql(l.sqr(f),c),p=l.eql(l.sqr(a),c);d=l.cmov(d,f,h),f=l.cmov(u,a,p);const y=l.eql(l.sqr(f),c),g=l.cmov(d,f,y);return Sd(l,g,c),g}}function oy(r){if(r<ey)throw new Error("sqrt is not defined for small field");let e=r-bt,t=0;for(;e%Qn===Ht;)e/=Qn,t++;let n=Qn;const s=ql(r);for(;Ah(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return iy;let i=s.pow(n,e);const o=(e+bt)/Qn;return function(c,d){if(c.is0(d))return d;if(Ah(c,d)!==1)throw new Error("Cannot find square root");let f=t,a=c.mul(c.ONE,i),u=c.pow(d,e),h=c.pow(d,o);for(;!c.eql(u,c.ONE);){if(c.is0(u))return c.ZERO;let p=1,y=c.sqr(u);for(;!c.eql(y,c.ONE);)if(p++,y=c.sqr(y),p===f)throw new Error("Cannot find square root");const g=bt<<BigInt(f-p-1),m=c.pow(a,g);f=p,a=c.sqr(m),u=c.mul(u,a),h=c.mul(h,m)}return h}}function ZA(r){return r%ty===ey?iy:r%ny===ry?YA:r%sy===GA?XA(r):oy(r)}const jA=(r,e)=>(Je(r,e)&bt)===bt,QA=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function JA(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=QA.reduce((n,s)=>(n[s]="function",n),e);return Vo(r,t),r}function e2(r,e,t){if(t<Ht)throw new Error("invalid exponent, negatives unsupported");if(t===Ht)return r.ONE;if(t===bt)return e;let n=r.ONE,s=e;for(;t>Ht;)t&bt&&(n=r.mul(n,s)),s=r.sqr(s),t>>=bt;return n}function ay(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,l,c)=>r.is0(l)?o:(n[c]=o,r.mul(o,l)),r.ONE),i=r.inv(s);return e.reduceRight((o,l,c)=>r.is0(l)?o:(n[c]=r.mul(o,n[c]),r.mul(o,l)),i),n}function Ah(r,e){const t=(r.ORDER-bt)/Qn,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function t2(r,e){e!==void 0&&Rr(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}class r2{ORDER;BITS;BYTES;isLE;ZERO=Ht;ONE=bt;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=Ht)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=t2(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Je(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return Ht<=e&&e<this.ORDER}is0(e){return e===Ht}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&bt)===bt}neg(e){return Je(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Je(e*e,this.ORDER)}add(e,t){return Je(e+t,this.ORDER)}sub(e,t){return Je(e-t,this.ORDER)}mul(e,t){return Je(e*t,this.ORDER)}pow(e,t){return e2(this,e,t)}div(e,t){return Je(e*xh(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return xh(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=ZA(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?Jm(e,this.BYTES):wd(e,this.BYTES)}fromBytes(e,t=!1){be(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:l}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const d=new Uint8Array(s);d.set(e,i?0:d.length-e.length),e=d}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?ho(e):Kl(e);if(l&&(c=Je(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return ay(this,e)}cmov(e,t,n){return n?t:e}}function ql(r,e={}){return new r2(r,e)}function ly(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function cy(r){const e=ly(r);return e+Math.ceil(e/2)}function n2(r,e,t=!1){be(r);const n=r.length,s=ly(e),i=cy(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?ho(r):Kl(r),l=Je(o,e-bt)+bt;return t?Jm(l,s):wd(l,s)}const ai=BigInt(0),Jn=BigInt(1);function Ka(r,e){const t=e.negate();return r?t:e}function Xi(r,e){const t=ay(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function uy(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function uc(r,e){uy(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=_d(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function Ih(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let l=Number(r&s),c=r>>o;l>n&&(l-=i,c+=Jn);const d=e*n,f=d+Math.abs(l)-1,a=l===0,u=l<0,h=e%2!==0;return{nextN:c,offset:f,isZero:a,isNeg:u,isNegF:h,offsetF:d}}const dc=new WeakMap,dy=new WeakMap;function fc(r){return dy.get(r)||1}function kh(r){if(r!==ai)throw new Error("invalid wNAF")}class fy{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>ai;)t&Jn&&(n=n.add(s)),s=s.double(),t>>=Jn;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=uc(t,this.bits),i=[];let o=e,l=o;for(let c=0;c<n;c++){l=o,i.push(l);for(let d=1;d<s;d++)l=l.add(o),i.push(l);o=l.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=uc(e,this.bits);for(let l=0;l<o.windows;l++){const{nextN:c,offset:d,isZero:f,isNeg:a,isNegF:u,offsetF:h}=Ih(n,l,o);n=c,f?i=i.add(Ka(u,t[h])):s=s.add(Ka(a,t[d]))}return kh(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=uc(e,this.bits);for(let o=0;o<i.windows&&n!==ai;o++){const{nextN:l,offset:c,isZero:d,isNeg:f}=Ih(n,o,i);if(n=l,!d){const a=t[c];s=s.add(f?a.negate():a)}}return kh(n),s}getPrecomputes(e,t,n){let s=dc.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),dc.set(t,s))),s}cached(e,t,n){const s=fc(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=fc(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){uy(t,this.bits),dy.set(e,t),dc.delete(e)}hasCache(e){return fc(e)!==1}}function s2(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>ai||n>ai;)t&Jn&&(i=i.add(s)),n&Jn&&(o=o.add(s)),s=s.double(),t>>=Jn,n>>=Jn;return{p1:i,p2:o}}function Ch(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return JA(e),e}else return ql(r,{isLE:t})}function hy(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const d=e[c];if(!(typeof d=="bigint"&&d>ai))throw new Error(`CURVE.${c} must be positive bigint`)}const s=Ch(e.p,t.Fp,n),i=Ch(e.n,t.Fn,n),l=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of l)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function py(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const _n=BigInt(0),lt=BigInt(1),hc=BigInt(2),i2=BigInt(8);function o2(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),l=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,l)}function a2(r,e={}){const t=hy("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;Vo(e,{},{uvRatio:"function"});const l=hc<<BigInt(s.BYTES*8)-lt,c=g=>n.create(g),d=e.uvRatio||((g,m)=>{try{return{isValid:!0,value:n.sqrt(n.div(g,m))}}catch{return{isValid:!1,value:_n}}});if(!o2(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function f(g,m,w=!1){const v=w?lt:_n;return Su("coordinate "+g,m,v,l),m}function a(g){if(!(g instanceof p))throw new Error("EdwardsPoint expected")}const u=Va((g,m)=>{const{X:w,Y:v,Z:_}=g,k=g.is0();m==null&&(m=k?i2:n.inv(_));const P=c(w*m),D=c(v*m),I=n.mul(_,m);if(k)return{x:_n,y:lt};if(I!==lt)throw new Error("invZ was invalid");return{x:P,y:D}}),h=Va(g=>{const{a:m,d:w}=i;if(g.is0())throw new Error("bad point: ZERO");const{X:v,Y:_,Z:k,T:P}=g,D=c(v*v),I=c(_*_),x=c(k*k),B=c(x*x),Q=c(D*m),M=c(x*c(Q+I)),A=c(B+c(w*c(D*I)));if(M!==A)throw new Error("bad point: equation left != right (1)");const E=c(v*_),S=c(k*P);if(E!==S)throw new Error("bad point: equation left != right (2)");return!0});class p{static BASE=new p(i.Gx,i.Gy,lt,c(i.Gx*i.Gy));static ZERO=new p(_n,lt,lt,_n);static Fp=n;static Fn=s;X;Y;Z;T;constructor(m,w,v,_){this.X=f("x",m),this.Y=f("y",w),this.Z=f("z",v,!0),this.T=f("t",_),Object.freeze(this)}static CURVE(){return i}static fromAffine(m){if(m instanceof p)throw new Error("extended point not allowed");const{x:w,y:v}=m||{};return f("x",w),f("y",v),new p(w,v,lt,c(w*v))}static fromBytes(m,w=!1){const v=n.BYTES,{a:_,d:k}=i;m=_u(be(m,v,"point")),bs(w,"zip215");const P=_u(m),D=m[v-1];P[v-1]=D&-129;const I=ho(P),x=w?l:n.ORDER;Su("point.y",I,_n,x);const B=c(I*I),Q=c(B-lt),M=c(k*B-_);let{isValid:A,value:E}=d(Q,M);if(!A)throw new Error("bad point: invalid y coordinate");const S=(E&lt)===lt,T=(D&128)!==0;if(!w&&E===_n&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(E=c(-E)),p.fromAffine({x:E,y:I})}static fromHex(m,w=!1){return p.fromBytes(fo(m),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(m=8,w=!0){return y.createCache(this,m),w||this.multiply(hc),this}assertValidity(){h(this)}equals(m){a(m);const{X:w,Y:v,Z:_}=this,{X:k,Y:P,Z:D}=m,I=c(w*D),x=c(k*_),B=c(v*D),Q=c(P*_);return I===x&&B===Q}is0(){return this.equals(p.ZERO)}negate(){return new p(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:m}=i,{X:w,Y:v,Z:_}=this,k=c(w*w),P=c(v*v),D=c(hc*c(_*_)),I=c(m*k),x=w+v,B=c(c(x*x)-k-P),Q=I+P,M=Q-D,A=I-P,E=c(B*M),S=c(Q*A),T=c(B*A),C=c(M*Q);return new p(E,S,C,T)}add(m){a(m);const{a:w,d:v}=i,{X:_,Y:k,Z:P,T:D}=this,{X:I,Y:x,Z:B,T:Q}=m,M=c(_*I),A=c(k*x),E=c(D*v*Q),S=c(P*B),T=c((_+k)*(I+x)-M-A),C=S-E,L=S+E,R=c(A-w*M),N=c(T*C),$=c(L*R),q=c(T*R),F=c(C*L);return new p(N,$,F,q)}subtract(m){return this.add(m.negate())}multiply(m){if(!s.isValidNot0(m))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:w,f:v}=y.cached(this,m,_=>Xi(p,_));return Xi(p,[w,v])[0]}multiplyUnsafe(m,w=p.ZERO){if(!s.isValid(m))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return m===_n?p.ZERO:this.is0()||m===lt?this:y.unsafe(this,m,v=>Xi(p,v),w)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return y.unsafe(this,i.n).is0()}toAffine(m){return u(this,m)}clearCofactor(){return o===lt?this:this.multiplyUnsafe(o)}toBytes(){const{x:m,y:w}=this.toAffine(),v=n.toBytes(w);return v[v.length-1]|=m&lt?128:0,v}toHex(){return Fo(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const y=new fy(p,s.BITS);return p.BASE.precompute(8),p}function l2(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Vo(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,l=t.randomBytes||Ul,c=t.adjustScalarBytes||(I=>I),d=t.domain||((I,x,B)=>{if(bs(B,"phflag"),x.length||B)throw new Error("Contexts/pre-hash are not supported");return I});function f(I){return o.create(ho(I))}function a(I){const x=v.secretKey;be(I,v.secretKey,"secretKey");const B=be(e(I),2*x,"hashedSecretKey"),Q=c(B.slice(0,x)),M=B.slice(x,2*x),A=f(Q);return{head:Q,prefix:M,scalar:A}}function u(I){const{head:x,prefix:B,scalar:Q}=a(I),M=s.multiply(Q),A=M.toBytes();return{head:x,prefix:B,scalar:Q,point:M,pointBytes:A}}function h(I){return u(I).pointBytes}function p(I=Uint8Array.of(),...x){const B=Dr(...x);return f(e(d(B,be(I,void 0,"context"),!!n)))}function y(I,x,B={}){I=be(I,void 0,"message"),n&&(I=n(I));const{prefix:Q,scalar:M,pointBytes:A}=u(x),E=p(B.context,Q,I),S=s.multiply(E).toBytes(),T=p(B.context,S,A,I),C=o.create(E+T*M);if(!o.isValid(C))throw new Error("sign failed: invalid s");const L=Dr(S,o.toBytes(C));return be(L,v.signature,"result")}const g={zip215:!0};function m(I,x,B,Q=g){const{context:M,zip215:A}=Q,E=v.signature;I=be(I,E,"signature"),x=be(x,void 0,"message"),B=be(B,v.publicKey,"publicKey"),A!==void 0&&bs(A,"zip215"),n&&(x=n(x));const S=E/2,T=I.subarray(0,S),C=ho(I.subarray(S,E));let L,R,N;try{L=r.fromBytes(B,A),R=r.fromBytes(T,A),N=s.multiplyUnsafe(C)}catch{return!1}if(!A&&L.isSmallOrder())return!1;const $=p(M,R.toBytes(),L.toBytes(),x);return R.add(L.multiplyUnsafe($)).subtract(N).clearCofactor().is0()}const w=i.BYTES,v={secretKey:w,publicKey:w,signature:2*w,seed:w};function _(I=l(v.seed)){return be(I,v.seed,"seed")}function k(I){return Fl(I)&&I.length===o.BYTES}function P(I,x){try{return!!r.fromBytes(I,x)}catch{return!1}}const D={getExtendedPublicKey:u,randomSecretKey:_,isValidSecretKey:k,isValidPublicKey:P,toMontgomery(I){const{y:x}=r.fromBytes(I),B=v.publicKey,Q=B===32;if(!Q&&B!==57)throw new Error("only defined for 25519 and 448");const M=Q?i.div(lt+x,lt-x):i.div(x-lt,x+lt);return i.toBytes(M)},toMontgomerySecret(I){const x=v.secretKey;be(I,x);const B=e(I.subarray(0,x));return c(B).subarray(0,x)}};return Object.freeze({keygen:py(_,h),getPublicKey:h,sign:y,verify:m,utils:D,Point:r,lengths:v})}const c2=BigInt(1),Th=BigInt(2),u2=BigInt(5),d2=BigInt(8),Ed=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),f2={p:Ed,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:d2,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function h2(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Ed,l=r*r%i*r%i,c=Ge(l,Th,i)*l%i,d=Ge(c,c2,i)*r%i,f=Ge(d,u2,i)*d%i,a=Ge(f,e,i)*f%i,u=Ge(a,t,i)*a%i,h=Ge(u,n,i)*u%i,p=Ge(h,s,i)*h%i,y=Ge(p,s,i)*h%i,g=Ge(y,e,i)*f%i;return{pow_p_5_8:Ge(g,Th,i)*r%i,b2:l}}function p2(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const Ph=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function g2(r,e){const t=Ed,n=Je(e*e*e,t),s=Je(n*n*e,t),i=h2(r*s).pow_p_5_8;let o=Je(r*n*i,t);const l=Je(e*o*o,t),c=o,d=Je(o*Ph,t),f=l===r,a=l===Je(-r,t),u=l===Je(-r*Ph,t);return f&&(o=c),(a||u)&&(o=d),jA(o,t)&&(o=Je(-o,t)),{isValid:f||a,value:o}}const m2=a2(f2,{uvRatio:g2});function y2(r){return l2(m2,Vl,Object.assign({adjustScalarBytes:p2},r))}const qa=y2({}),po=32,Cr=64,Eu=32;let Ys;const gy=(async()=>{try{return await Mt.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function b2(){const r=qa.utils.randomSecretKey(),e=qa.getPublicKey(r);return{privateKey:A2(r,e),publicKey:e}}async function v2(r,e){let t;r.length===Cr?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:W(r.subarray(32),"base64url"),d:W(t,"base64url"),ext:!0,key_ops:["sign"]},s=await Mt.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Mt.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function w2(r,e){const t=r.subarray(0,Eu);return qa.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function _2(r,e){return Ys==null&&(Ys=await gy),Ys?v2(r,e):w2(r,e)}async function S2(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Mt.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Mt.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function E2(r,e,t){return qa.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function x2(r,e,t){return Ys==null&&(Ys=await gy),Ys?S2(r,e,t):E2(r,e,t)}function A2(r,e){const t=new Uint8Array(Cr);for(let n=0;n<Eu;n++)t[n]=r[n],t[Eu+n]=e[n];return t}function Hl(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class my{type="Ed25519";raw;constructor(e){this.raw=go(e,po)}toMultihash(){return it.digest(wr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=x2(this.raw,t,e);return Hl(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}class xu{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=go(e,Cr),this.publicKey=new my(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=_2(this.raw,e);return Hl(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function yy(r){if(r.length>Cr){r=go(r,Cr+po);const n=r.subarray(0,Cr),s=r.subarray(Cr,r.length);return new xu(n,s)}r=go(r,Cr);const e=r.subarray(0,Cr),t=r.subarray(po);return new xu(e,t)}function xd(r){return r=go(r,po),new my(r)}async function I2(){const{privateKey:r,publicKey:e}=b2();return new xu(r,e)}function go(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new V(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const k2=Math.pow(2,7),C2=Math.pow(2,14),T2=Math.pow(2,21),Ad=Math.pow(2,28),Id=Math.pow(2,35),kd=Math.pow(2,42),Cd=Math.pow(2,49),Ee=128,xt=127;function xr(r){if(r<k2)return 1;if(r<C2)return 2;if(r<T2)return 3;if(r<Ad)return 4;if(r<Id)return 5;if(r<kd)return 6;if(r<Cd)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Ha(r,e,t=0){switch(xr(r)){case 8:e[t++]=r&255|Ee,r/=128;case 7:e[t++]=r&255|Ee,r/=128;case 6:e[t++]=r&255|Ee,r/=128;case 5:e[t++]=r&255|Ee,r/=128;case 4:e[t++]=r&255|Ee,r>>>=7;case 3:e[t++]=r&255|Ee,r>>>=7;case 2:e[t++]=r&255|Ee,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function P2(r,e,t=0){switch(xr(r)){case 8:e.set(t++,r&255|Ee),r/=128;case 7:e.set(t++,r&255|Ee),r/=128;case 6:e.set(t++,r&255|Ee),r/=128;case 5:e.set(t++,r&255|Ee),r/=128;case 4:e.set(t++,r&255|Ee),r>>>=7;case 3:e.set(t++,r&255|Ee),r>>>=7;case 2:e.set(t++,r&255|Ee),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function by(r,e){let t=r[e],n=0;if(n+=t&xt,t<Ee||(t=r[e+1],n+=(t&xt)<<7,t<Ee)||(t=r[e+2],n+=(t&xt)<<14,t<Ee)||(t=r[e+3],n+=(t&xt)<<21,t<Ee)||(t=r[e+4],n+=(t&xt)*Ad,t<Ee)||(t=r[e+5],n+=(t&xt)*Id,t<Ee)||(t=r[e+6],n+=(t&xt)*kd,t<Ee)||(t=r[e+7],n+=(t&xt)*Cd,t<Ee))return n;throw new RangeError("Could not decode varint")}function D2(r,e){let t=r.get(e),n=0;if(n+=t&xt,t<Ee||(t=r.get(e+1),n+=(t&xt)<<7,t<Ee)||(t=r.get(e+2),n+=(t&xt)<<14,t<Ee)||(t=r.get(e+3),n+=(t&xt)<<21,t<Ee)||(t=r.get(e+4),n+=(t&xt)*Ad,t<Ee)||(t=r.get(e+5),n+=(t&xt)*Id,t<Ee)||(t=r.get(e+6),n+=(t&xt)*kd,t<Ee)||(t=r.get(e+7),n+=(t&xt)*Cd,t<Ee))return n;throw new RangeError("Could not decode varint")}function Zi(r,e,t=0){return e==null&&(e=on(xr(r))),e instanceof Uint8Array?Ha(r,e,t):P2(r,e,t)}function Td(r,e=0){return r instanceof Uint8Array?by(r,e):D2(r,e)}const Pd=new Float32Array([-0]),An=new Uint8Array(Pd.buffer);function L2(r,e,t){Pd[0]=r,e[t]=An[0],e[t+1]=An[1],e[t+2]=An[2],e[t+3]=An[3]}function R2(r,e){return An[0]=r[e],An[1]=r[e+1],An[2]=r[e+2],An[3]=r[e+3],Pd[0]}const Dd=new Float64Array([-0]),At=new Uint8Array(Dd.buffer);function B2(r,e,t){Dd[0]=r,e[t]=At[0],e[t+1]=At[1],e[t+2]=At[2],e[t+3]=At[3],e[t+4]=At[4],e[t+5]=At[5],e[t+6]=At[6],e[t+7]=At[7]}function N2(r,e){return At[0]=r[e],At[1]=r[e+1],At[2]=r[e+2],At[3]=r[e+3],At[4]=r[e+4],At[5]=r[e+5],At[6]=r[e+6],At[7]=r[e+7],Dd[0]}const M2=BigInt(Number.MAX_SAFE_INTEGER),O2=BigInt(Number.MIN_SAFE_INTEGER);class It{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return cs;if(e<M2&&e>O2)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>Dh&&(s=0n,++n>Dh&&(n=0n))),new It(Number(s),Number(n))}static fromNumber(e){if(e===0)return cs;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new It(n,s)}static from(e){return typeof e=="number"?It.fromNumber(e):typeof e=="bigint"?It.fromBigInt(e):typeof e=="string"?It.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new It(e.low>>>0,e.high>>>0):cs}}const cs=new It(0,0);cs.toBigInt=function(){return 0n};cs.zzEncode=cs.zzDecode=function(){return this};cs.length=function(){return 1};const Dh=4294967296n;function $2(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function F2(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,l;for(;e<t;)l=r[e++],l<128?i[o++]=l:l>191&&l<224?i[o++]=(l&31)<<6|r[e++]&63:l>239&&l<365?(l=((l&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(l>>10),i[o++]=56320+(l&1023)):i[o++]=(l&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function vy(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function mr(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function ta(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class U2{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,mr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw mr(this,4);return ta(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw mr(this,4);return ta(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw mr(this,4);const e=R2(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw mr(this,4);const e=N2(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw mr(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return F2(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw mr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw mr(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new It(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw mr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw mr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw mr(this,8);const e=ta(this.buf,this.pos+=4),t=ta(this.buf,this.pos+=4);return new It(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=by(this.buf,this.pos);return this.pos+=xr(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function V2(r){return new U2(r instanceof Uint8Array?r:r.subarray())}function Ie(r,e,t){const n=V2(r);return e.decode(n,void 0,t)}function K2(r){let n,s=8192;return function(o){if(o<1||o>4096)return on(o);s+o>8192&&(n=on(8192),s=0);const l=n.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),l}}class Ki{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function pc(){}class q2{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const H2=K2();function z2(r){return globalThis.Buffer!=null?on(r):H2(r)}class Au{len;head;tail;states;constructor(){this.len=0,this.head=new Ki(pc,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new Ki(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new G2((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(ra,10,It.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=It.fromBigInt(e);return this._push(ra,t.length(),t)}uint64Number(e){return this._push(Ha,xr(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=It.fromBigInt(e).zzEncode();return this._push(ra,t.length(),t)}sint64Number(e){const t=It.fromNumber(e).zzEncode();return this._push(ra,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(gc,1,e?1:0)}fixed32(e){return this._push(Li,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=It.fromBigInt(e);return this._push(Li,4,t.lo)._push(Li,4,t.hi)}fixed64Number(e){const t=It.fromNumber(e);return this._push(Li,4,t.lo)._push(Li,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(L2,4,e)}double(e){return this._push(B2,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(gc,1,0):this.uint32(t)._push(Y2,t,e)}string(e){const t=$2(e);return t!==0?this.uint32(t)._push(vy,t,e):this._push(gc,1,0)}fork(){return this.states=new q2(this),this.head=this.tail=new Ki(pc,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Ki(pc,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=z2(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function gc(r,e,t){e[t]=r&255}function W2(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class G2 extends Ki{next;constructor(e,t){super(W2,e,t),this.next=void 0}}function ra(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Li(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Y2(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(Au.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(X2,e,r),this},Au.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(Z2,e,r),this});function X2(r,e,t){e.set(r,t)}function Z2(r,e,t){r.length<40?vy(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(j(r),t)}function j2(){return new Au}function ke(r,e){const t=j2();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var za;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(za||(za={}));function wy(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Ko(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const l=e(i);o.int32(l)},n=function(i){const o=i.int32();return e(o)};return wy("enum",za.VARINT,t,n)}function Ce(r,e){return wy("message",za.LENGTH_DELIMITED,r,e)}class yt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class Lh extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var We;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(We||(We={}));var Iu;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Iu||(Iu={}));(function(r){r.codec=()=>Ko(Iu)})(We||(We={}));var On;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),We.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=We.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(On||(On={}));var Wa;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),We.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=We.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Wa||(Wa={}));function li(r){if(isNaN(r)||r<=0)throw new V("random bytes length must be a Number bigger than 0");return Ul(r)}class Ld{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Bd(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return ue.createV1(114,this._multihash)}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return dI(this.jwk,t,e,n)}}class _y{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=tI(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return uI(this.jwk,e,t)}}const Sy=8192,Rd=18,Q2=1062,J2=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function eI(r){return{n:W(r[1],"base64url"),e:W(r[2],"base64url"),d:W(r[3],"base64url"),p:W(r[4],"base64url"),q:W(r[5],"base64url"),dp:W(r[6],"base64url"),dq:W(r[7],"base64url"),qi:W(r[8],"base64url"),kty:"RSA"}}function tI(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new V("JWK was missing components");return nn([Xt(Uint8Array.from([0])),Xt(j(r.n,"base64url")),Xt(j(r.e,"base64url")),Xt(j(r.d,"base64url")),Xt(j(r.p,"base64url")),Xt(j(r.q,"base64url")),Xt(j(r.dp,"base64url")),Xt(j(r.dq,"base64url")),Xt(j(r.qi,"base64url"))]).subarray()}function rI(r){const e=Kn(r[1],{offset:0});return{kty:"RSA",n:W(e[0],"base64url"),e:W(e[1],"base64url")}}function Bd(r){if(r.n==null||r.e==null)throw new V("JWK was missing components");return nn([J2,gd(nn([Xt(j(r.n,"base64url")),Xt(j(r.e,"base64url"))]))]).subarray()}function nI(r){const e=Kn(r);return Ey(e)}function Ey(r){const e=eI(r);return iI(e)}function sI(r,e){if(r.byteLength>=Q2)throw new Cm("Key size is too large");const t=Kn(r,{offset:0});return xy(t,r,e)}function xy(r,e,t){const n=rI(r);if(t==null){const s=Uo(On.encode({Type:We.RSA,Data:e}));t=Ei(Rd,s)}return new Ld(n,t)}function iI(r){if(hI(r)>Sy)throw new V("Key size is too large");const e=aI(r),t=Uo(On.encode({Type:We.RSA,Data:Bd(e.publicKey)})),n=Ei(Rd,t);return new _y(e.privateKey,new Ld(e.publicKey,n))}async function oI(r){if(r>Sy)throw new V("Key size is too large");const e=await cI(r),t=Uo(On.encode({Type:We.RSA,Data:Bd(e.publicKey)})),n=Ei(Rd,t);return new _y(e.privateKey,new Ld(e.publicKey,n))}function aI(r){if(r==null)throw new V("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const lI="1.2.840.113549.1.1.1";async function cI(r,e){const t=await Mt.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await fI(t);return{privateKey:n[0],publicKey:n[1]}}async function uI(r,e,t){const n=await Mt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const s=await Mt.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function dI(r,e,t,n){const s=await Mt.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Mt.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function fI(r,e){if(r.privateKey==null||r.publicKey==null)throw new V("Private and public key are required");return await Promise.all([Mt.get().subtle.exportKey("jwk",r.privateKey),Mt.get().subtle.exportKey("jwk",r.publicKey)])}function hI(r){if(r.kty!=="RSA")throw new V("invalid key type");if(r.n==null)throw new V("invalid key modulus");return j(r.n,"base64url").length*8}class Ay{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(md(e),be(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),ln(s)}update(e){return Ua(this),this.iHash.update(e),this}digestInto(e){Ua(this),be(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:l}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=l,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Nd=(r,e,t)=>new Ay(r,e).update(t).digest();Nd.create=(r,e)=>new Ay(r,e);const Rh=(r,e)=>(r+(r>=0?e:-e)/Iy)/e;function pI(r,e,t){const[[n,s],[i,o]]=e,l=Rh(o*r,t),c=Rh(-s*r,t);let d=r-l*n-c*i,f=-l*s-c*o;const a=d<en,u=f<en;a&&(d=-d),u&&(f=-f);const h=_d(Math.ceil(HA(t)/2))+Xs;if(d<en||d>=h||f<en||f>=h)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:a,k1:d,k2neg:u,k2:f}}function ku(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function mc(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return bs(t.lowS,"lowS"),bs(t.prehash,"prehash"),t.format!==void 0&&ku(t.format),t}class gI extends Error{constructor(e=""){super(e)}}const xn={Err:gI,_tlv:{encode:(r,e)=>{const{Err:t}=xn;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=ea(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?ea(s.length/2|128):"";return ea(r)+i+s+e},decode(r,e){const{Err:t}=xn;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const d=e.subarray(n,n+c);if(d.length!==c)throw new t("tlv.decode: length bytes not complete");if(d[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const f of d)o=o<<8|f;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const l=e.subarray(n,n+o);if(l.length!==o)throw new t("tlv.decode: wrong value length");return{v:l,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=xn;if(r<en)throw new e("integer: negative integers are not allowed");let t=ea(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=xn;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Kl(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=xn,s=be(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:l,l:c}=n.decode(2,i),{v:d,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(l),s:t.decode(d)}},hexFromSig(r){const{_tlv:e,_int:t}=xn,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},en=BigInt(0),Xs=BigInt(1),Iy=BigInt(2),na=BigInt(3),mI=BigInt(4);function yI(r,e={}){const t=hy("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:l}=i;Vo(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const d=Cy(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function a(M,A,E){const{x:S,y:T}=A.toAffine(),C=n.toBytes(S);if(bs(E,"isCompressed"),E){f();const L=!n.isOdd(T);return Dr(ky(L),C)}else return Dr(Uint8Array.of(4),C,n.toBytes(T))}function u(M){be(M,void 0,"Point");const{publicKey:A,publicKeyUncompressed:E}=d,S=M.length,T=M[0],C=M.subarray(1);if(S===A&&(T===2||T===3)){const L=n.fromBytes(C);if(!n.isValid(L))throw new Error("bad point: is not on curve, wrong x");const R=y(L);let N;try{N=n.sqrt(R)}catch(F){const H=F instanceof Error?": "+F.message:"";throw new Error("bad point: is not on curve, sqrt error"+H)}f();const $=n.isOdd(N);return(T&1)===1!==$&&(N=n.neg(N)),{x:L,y:N}}else if(S===E&&T===4){const L=n.BYTES,R=n.fromBytes(C.subarray(0,L)),N=n.fromBytes(C.subarray(L,L*2));if(!g(R,N))throw new Error("bad point: is not on curve");return{x:R,y:N}}else throw new Error(`bad point: got length ${S}, expected compressed=${A} or uncompressed=${E}`)}const h=e.toBytes||a,p=e.fromBytes||u;function y(M){const A=n.sqr(M),E=n.mul(A,M);return n.add(n.add(E,n.mul(M,i.a)),i.b)}function g(M,A){const E=n.sqr(A),S=y(M);return n.eql(E,S)}if(!g(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const m=n.mul(n.pow(i.a,na),mI),w=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(m,w)))throw new Error("bad curve params: a or b");function v(M,A,E=!1){if(!n.isValid(A)||E&&n.is0(A))throw new Error(`bad point coordinate ${M}`);return A}function _(M){if(!(M instanceof x))throw new Error("Weierstrass Point expected")}function k(M){if(!c||!c.basises)throw new Error("no endo");return pI(M,c.basises,s.ORDER)}const P=Va((M,A)=>{const{X:E,Y:S,Z:T}=M;if(n.eql(T,n.ONE))return{x:E,y:S};const C=M.is0();A==null&&(A=C?n.ONE:n.inv(T));const L=n.mul(E,A),R=n.mul(S,A),N=n.mul(T,A);if(C)return{x:n.ZERO,y:n.ZERO};if(!n.eql(N,n.ONE))throw new Error("invZ was invalid");return{x:L,y:R}}),D=Va(M=>{if(M.is0()){if(e.allowInfinityPoint&&!n.is0(M.Y))return;throw new Error("bad point: ZERO")}const{x:A,y:E}=M.toAffine();if(!n.isValid(A)||!n.isValid(E))throw new Error("bad point: x or y not field elements");if(!g(A,E))throw new Error("bad point: equation left != right");if(!M.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function I(M,A,E,S,T){return E=new x(n.mul(E.X,M),E.Y,E.Z),A=Ka(S,A),E=Ka(T,E),A.add(E)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(A,E,S){this.X=v("x",A),this.Y=v("y",E,!0),this.Z=v("z",S),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){const{x:E,y:S}=A||{};if(!A||!n.isValid(E)||!n.isValid(S))throw new Error("invalid affine point");if(A instanceof x)throw new Error("projective point not allowed");return n.is0(E)&&n.is0(S)?x.ZERO:new x(E,S,n.ONE)}static fromBytes(A){const E=x.fromAffine(p(be(A,void 0,"point")));return E.assertValidity(),E}static fromHex(A){return x.fromBytes(fo(A))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,E=!0){return Q.createCache(this,A),E||this.multiply(na),this}assertValidity(){D(this)}hasEvenY(){const{y:A}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(A)}equals(A){_(A);const{X:E,Y:S,Z:T}=this,{X:C,Y:L,Z:R}=A,N=n.eql(n.mul(E,R),n.mul(C,T)),$=n.eql(n.mul(S,R),n.mul(L,T));return N&&$}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:A,b:E}=i,S=n.mul(E,na),{X:T,Y:C,Z:L}=this;let R=n.ZERO,N=n.ZERO,$=n.ZERO,q=n.mul(T,T),F=n.mul(C,C),H=n.mul(L,L),G=n.mul(T,C);return G=n.add(G,G),$=n.mul(T,L),$=n.add($,$),R=n.mul(A,$),N=n.mul(S,H),N=n.add(R,N),R=n.sub(F,N),N=n.add(F,N),N=n.mul(R,N),R=n.mul(G,R),$=n.mul(S,$),H=n.mul(A,H),G=n.sub(q,H),G=n.mul(A,G),G=n.add(G,$),$=n.add(q,q),q=n.add($,q),q=n.add(q,H),q=n.mul(q,G),N=n.add(N,q),H=n.mul(C,L),H=n.add(H,H),q=n.mul(H,G),R=n.sub(R,q),$=n.mul(H,F),$=n.add($,$),$=n.add($,$),new x(R,N,$)}add(A){_(A);const{X:E,Y:S,Z:T}=this,{X:C,Y:L,Z:R}=A;let N=n.ZERO,$=n.ZERO,q=n.ZERO;const F=i.a,H=n.mul(i.b,na);let G=n.mul(E,C),re=n.mul(S,L),ne=n.mul(T,R),K=n.add(E,S),ee=n.add(C,L);K=n.mul(K,ee),ee=n.add(G,re),K=n.sub(K,ee),ee=n.add(E,T);let ge=n.add(C,R);return ee=n.mul(ee,ge),ge=n.add(G,ne),ee=n.sub(ee,ge),ge=n.add(S,T),N=n.add(L,R),ge=n.mul(ge,N),N=n.add(re,ne),ge=n.sub(ge,N),q=n.mul(F,ee),N=n.mul(H,ne),q=n.add(N,q),N=n.sub(re,q),q=n.add(re,q),$=n.mul(N,q),re=n.add(G,G),re=n.add(re,G),ne=n.mul(F,ne),ee=n.mul(H,ee),re=n.add(re,ne),ne=n.sub(G,ne),ne=n.mul(F,ne),ee=n.add(ee,ne),G=n.mul(re,ee),$=n.add($,G),G=n.mul(ge,ee),N=n.mul(K,N),N=n.sub(N,G),G=n.mul(K,re),q=n.mul(ge,q),q=n.add(q,G),new x(N,$,q)}subtract(A){return this.add(A.negate())}is0(){return this.equals(x.ZERO)}multiply(A){const{endo:E}=e;if(!s.isValidNot0(A))throw new Error("invalid scalar: out of range");let S,T;const C=L=>Q.cached(this,L,R=>Xi(x,R));if(E){const{k1neg:L,k1:R,k2neg:N,k2:$}=k(A),{p:q,f:F}=C(R),{p:H,f:G}=C($);T=F.add(G),S=I(E.beta,q,H,L,N)}else{const{p:L,f:R}=C(A);S=L,T=R}return Xi(x,[S,T])[0]}multiplyUnsafe(A){const{endo:E}=e,S=this;if(!s.isValid(A))throw new Error("invalid scalar: out of range");if(A===en||S.is0())return x.ZERO;if(A===Xs)return S;if(Q.hasCache(this))return this.multiply(A);if(E){const{k1neg:T,k1:C,k2neg:L,k2:R}=k(A),{p1:N,p2:$}=s2(x,S,C,R);return I(E.beta,N,$,T,L)}else return Q.unsafe(S,A)}toAffine(A){return P(this,A)}isTorsionFree(){const{isTorsionFree:A}=e;return o===Xs?!0:A?A(x,this):Q.unsafe(this,l).is0()}clearCofactor(){const{clearCofactor:A}=e;return o===Xs?this:A?A(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(A=!0){return bs(A,"isCompressed"),this.assertValidity(),h(x,this,A)}toHex(A=!0){return Fo(this.toBytes(A))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const B=s.BITS,Q=new fy(x,e.endo?Math.ceil(B/2):B);return x.BASE.precompute(8),x}function ky(r){return Uint8Array.of(r?2:3)}function Cy(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function bI(r,e={}){const{Fn:t}=r,n=e.randomBytes||Ul,s=Object.assign(Cy(r.Fp,t),{seed:cy(t.ORDER)});function i(h){try{const p=t.fromBytes(h);return t.isValidNot0(p)}catch{return!1}}function o(h,p){const{publicKey:y,publicKeyUncompressed:g}=s;try{const m=h.length;return p===!0&&m!==y||p===!1&&m!==g?!1:!!r.fromBytes(h)}catch{return!1}}function l(h=n(s.seed)){return n2(be(h,s.seed,"seed"),t.ORDER)}function c(h,p=!0){return r.BASE.multiply(t.fromBytes(h)).toBytes(p)}function d(h){const{secretKey:p,publicKey:y,publicKeyUncompressed:g}=s;if(!Fl(h)||"_lengths"in t&&t._lengths||p===y)return;const m=be(h,void 0,"key").length;return m===y||m===g}function f(h,p,y=!0){if(d(h)===!0)throw new Error("first arg must be private key");if(d(p)===!1)throw new Error("second arg must be public key");const g=t.fromBytes(h);return r.fromBytes(p).multiply(g).toBytes(y)}const a={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:l},u=py(l,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:u,Point:r,utils:a,lengths:s})}function vI(r,e,t={}){md(e),Vo(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||Ul,s=t.hmac||((E,S)=>Nd(e,E,S)),{Fp:i,Fn:o}=r,{ORDER:l,BITS:c}=o,{keygen:d,getPublicKey:f,getSharedSecret:a,utils:u,lengths:h}=bI(r,t),p={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},y=l*Iy<i.ORDER;function g(E){const S=l>>Xs;return E>S}function m(E,S){if(!o.isValidNot0(S))throw new Error(`invalid signature ${E}: out of range 1..Point.Fn.ORDER`);return S}function w(){if(y)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function v(E,S){ku(S);const T=h.signature,C=S==="compact"?T:S==="recovered"?T+1:void 0;return be(E,C)}class _{r;s;recovery;constructor(S,T,C){if(this.r=m("r",S),this.s=m("s",T),C!=null){if(w(),![0,1,2,3].includes(C))throw new Error("invalid recovery id");this.recovery=C}Object.freeze(this)}static fromBytes(S,T=p.format){v(S,T);let C;if(T==="der"){const{r:$,s:q}=xn.toSig(be(S));return new _($,q)}T==="recovered"&&(C=S[0],T="compact",S=S.subarray(1));const L=h.signature/2,R=S.subarray(0,L),N=S.subarray(L,L*2);return new _(o.fromBytes(R),o.fromBytes(N),C)}static fromHex(S,T){return this.fromBytes(fo(S),T)}assertRecovery(){const{recovery:S}=this;if(S==null)throw new Error("invalid recovery id: must be present");return S}addRecoveryBit(S){return new _(this.r,this.s,S)}recoverPublicKey(S){const{r:T,s:C}=this,L=this.assertRecovery(),R=L===2||L===3?T+l:T;if(!i.isValid(R))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const N=i.toBytes(R),$=r.fromBytes(Dr(ky((L&1)===0),N)),q=o.inv(R),F=P(be(S,void 0,"msgHash")),H=o.create(-F*q),G=o.create(C*q),re=r.BASE.multiplyUnsafe(H).add($.multiplyUnsafe(G));if(re.is0())throw new Error("invalid recovery: point at infinify");return re.assertValidity(),re}hasHighS(){return g(this.s)}toBytes(S=p.format){if(ku(S),S==="der")return fo(xn.hexFromSig(this));const{r:T,s:C}=this,L=o.toBytes(T),R=o.toBytes(C);return S==="recovered"?(w(),Dr(Uint8Array.of(this.assertRecovery()),L,R)):Dr(L,R)}toHex(S){return Fo(this.toBytes(S))}}const k=t.bits2int||function(S){if(S.length>8192)throw new Error("input is too large");const T=Kl(S),C=S.length*8-c;return C>0?T>>BigInt(C):T},P=t.bits2int_modN||function(S){return o.create(k(S))},D=_d(c);function I(E){return Su("num < 2^"+c,E,en,D),o.toBytes(E)}function x(E,S){return be(E,void 0,"message"),S?be(e(E),void 0,"prehashed message"):E}function B(E,S,T){const{lowS:C,prehash:L,extraEntropy:R}=mc(T,p);E=x(E,L);const N=P(E),$=o.fromBytes(S);if(!o.isValidNot0($))throw new Error("invalid private key");const q=[I($),I(N)];if(R!=null&&R!==!1){const re=R===!0?n(h.secretKey):R;q.push(be(re,void 0,"extraEntropy"))}const F=Dr(...q),H=N;function G(re){const ne=k(re);if(!o.isValidNot0(ne))return;const K=o.inv(ne),ee=r.BASE.multiply(ne).toAffine(),ge=o.create(ee.x);if(ge===en)return;const Me=o.create(K*o.create(H+ge*$));if(Me===en)return;let tt=(ee.x===ge?0:2)|Number(ee.y&Xs),Oe=Me;return C&&g(Me)&&(Oe=o.neg(Me),tt^=1),new _(ge,Oe,y?void 0:tt)}return{seed:F,k2sig:G}}function Q(E,S,T={}){const{seed:C,k2sig:L}=B(E,S,T);return zA(e.outputLen,o.BYTES,s)(C,L).toBytes(T.format)}function M(E,S,T,C={}){const{lowS:L,prehash:R,format:N}=mc(C,p);if(T=be(T,void 0,"publicKey"),S=x(S,R),!Fl(E)){const $=E instanceof _?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+$)}v(E,N);try{const $=_.fromBytes(E,N),q=r.fromBytes(T);if(L&&$.hasHighS())return!1;const{r:F,s:H}=$,G=P(S),re=o.inv(H),ne=o.create(G*re),K=o.create(F*re),ee=r.BASE.multiplyUnsafe(ne).add(q.multiplyUnsafe(K));return ee.is0()?!1:o.create(ee.x)===F}catch{return!1}}function A(E,S,T={}){const{prehash:C}=mc(T,p);return S=x(S,C),_.fromBytes(E,"recovered").recoverPublicKey(S).toBytes()}return Object.freeze({keygen:d,getPublicKey:f,getSharedSecret:a,utils:u,lengths:h,Point:r,sign:Q,verify:M,recoverPublicKey:A,Signature:_,hash:e})}const Md={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},wI={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Bh=BigInt(2);function _I(r){const e=Md.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),l=BigInt(44),c=BigInt(88),d=r*r*r%e,f=d*d*r%e,a=Ge(f,t,e)*f%e,u=Ge(a,t,e)*f%e,h=Ge(u,Bh,e)*d%e,p=Ge(h,s,e)*h%e,y=Ge(p,i,e)*p%e,g=Ge(y,l,e)*y%e,m=Ge(g,c,e)*g%e,w=Ge(m,l,e)*y%e,v=Ge(w,t,e)*f%e,_=Ge(v,o,e)*p%e,k=Ge(_,n,e)*d%e,P=Ge(k,Bh,e);if(!Cu.eql(Cu.sqr(P),r))throw new Error("Cannot find square root");return P}const Cu=ql(Md.p,{sqrt:_I}),SI=yI(Md,{Fp:Cu,endo:wI}),cn=vI(SI,Uo),EI=33,xI=32;function AI(r,e,t){const n=pr.digest(e instanceof Uint8Array?e:e.subarray());if(Hl(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),cn.sign(s,r,{prehash:!1,format:"der"}))).catch(s=>{throw s.name==="AbortError"?s:new gh(String(s))});try{return cn.sign(n.digest,r,{prehash:!1,format:"der"})}catch(s){throw new gh(String(s))}}function II(r,e,t,n){const s=pr.digest(t instanceof Uint8Array?t:t.subarray());if(Hl(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),cn.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new mh(String(i))});try{return n?.signal?.throwIfAborted(),cn.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new mh(String(i))}}class Ty{type="secp256k1";raw;_key;constructor(e){this._key=PI(e),this.raw=CI(this._key)}toMultihash(){return it.digest(wr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return II(this._key,t,e,n)}}class Py{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=TI(e),this.publicKey=new Ty(t??DI(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return AI(this.raw,e,t)}}function Dy(r){return new Py(r)}function Od(r){return new Ty(r)}async function kI(){const r=LI();return new Py(r)}function CI(r){return cn.Point.fromBytes(r).toBytes()}function TI(r){try{return cn.getPublicKey(r,!0),r}catch(e){throw new Tm(String(e))}}function PI(r){try{return cn.Point.fromBytes(r),r}catch(e){throw new Cm(String(e))}}function DI(r){try{return cn.getPublicKey(r,!0)}catch(e){throw new Tm(String(e))}}function LI(){return cn.utils.randomSecretKey()}async function Ly(r,e){if(r==="Ed25519")return I2();if(r==="secp256k1")return kI();if(r==="RSA")return oI(MI());if(r==="ECDSA")return _A(OI());throw new Ar}function qn(r,e){const{Type:t,Data:n}=On.decode(r),s=n??new Uint8Array;switch(t){case We.RSA:return sI(s,e);case We.Ed25519:return xd(s);case We.secp256k1:return Od(s);case We.ECDSA:return qm(s);default:throw new Ar}}function RI(r){if(r.byteLength===po)return xd(r);if(r.byteLength===EI)return Od(r);const e=Kn(r),t=e[1]?.[0];if(t===Mm||t===Om||t===$m)return Hm(e);if(e[0]?.[0]===lI)return xy(e,r);throw new V("Could not extract public key from raw bytes")}function Hn(r){const{Type:e,Data:t}=On.decode(r.digest),n=t??new Uint8Array;switch(e){case We.Ed25519:return xd(n);case We.secp256k1:return Od(n);case We.ECDSA:return qm(n);default:throw new Ar}}function wr(r){return On.encode({Type:We[r.type],Data:r.raw})}function BI(r){const e=Wa.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case We.RSA:return nI(t);case We.Ed25519:return yy(t);case We.secp256k1:return Dy(t);case We.ECDSA:return bA(t);default:throw new Ar}}function NI(r){if(r.byteLength===Cr)return yy(r);if(r.byteLength===xI)return Dy(r);const e=Kn(r),t=e[2]?.[0];if(t===Mm||t===Om||t===$m)return Km(e);if(e.length>8)return Ey(e);throw new V("Could not extract private key from raw bytes")}function qo(r){return Wa.encode({Type:We[r.type],Data:r.raw})}function MI(r){return 2048}function OI(r){return"P-256"}const Ri=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),Sn=new Uint32Array(80);class $I extends bd{A=Ri[0]|0;B=Ri[1]|0;C=Ri[2]|0;D=Ri[3]|0;E=Ri[4]|0;constructor(){super(64,20,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i}=this;return[e,t,n,s,i]}set(e,t,n,s,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)Sn[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)Sn[c]=cc(Sn[c-3]^Sn[c-8]^Sn[c-14]^Sn[c-16],1);let{A:n,B:s,C:i,D:o,E:l}=this;for(let c=0;c<80;c++){let d,f;c<20?(d=Ym(s,i,o),f=1518500249):c<40?(d=s^i^o,f=1859775393):c<60?(d=Xm(s,i,o),f=2400959708):(d=s^i^o,f=3395469782);const a=cc(n,5)+d+l+f+Sn[c]|0;l=o,o=i,i=cc(s,30),s=n,n=a}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,l=l+this.E|0,this.set(n,s,i,o,l)}roundClean(){ln(Sn)}destroy(){this.set(0,0,0,0,0),ln(this.buffer)}}const FI=yd(()=>new $I);function Ry(r,e,t,n){md(r);const s=kA({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:l}=s;if(Rr(i,"c"),Rr(o,"dkLen"),Rr(l,"asyncTick"),i<1)throw new Error("iterations (c) must be >= 1");const c=wh(e,"password"),d=wh(t,"salt"),f=new Uint8Array(o),a=Nd.create(r,c),u=a._cloneInto().update(d);return{c:i,dkLen:o,asyncTick:l,DK:f,PRF:a,PRFSalt:u}}function By(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),ln(s),t}function UI(r,e,t,n){const{c:s,dkLen:i,DK:o,PRF:l,PRFSalt:c}=Ry(r,e,t,n);let d;const f=new Uint8Array(4),a=Yi(f),u=new Uint8Array(l.outputLen);for(let h=1,p=0;p<i;h++,p+=l.outputLen){const y=o.subarray(p,p+l.outputLen);a.setInt32(0,h,!1),(d=c._cloneInto(d)).update(f).digestInto(u),y.set(u.subarray(0,y.length));for(let g=1;g<s;g++){l._cloneInto(d).update(u).digestInto(u);for(let m=0;m<y.length;m++)y[m]^=u[m]}}return By(l,c,o,d,u)}async function Ny(r,e,t,n){const{c:s,dkLen:i,asyncTick:o,DK:l,PRF:c,PRFSalt:d}=Ry(r,e,t,n);let f;const a=new Uint8Array(4),u=Yi(a),h=new Uint8Array(c.outputLen);for(let p=1,y=0;y<i;p++,y+=c.outputLen){const g=l.subarray(y,y+c.outputLen);u.setInt32(0,p,!1),(f=d._cloneInto(f)).update(a).digestInto(h),g.set(h.subarray(0,g.length)),await AA(s-1,o,()=>{c._cloneInto(f).update(h).digestInto(h);for(let m=0;m<g.length;m++)g[m]^=h[m]})}return By(c,d,l,f,h)}const Nh={sha1:FI,"sha2-256":Uo,"sha2-512":Vl};function Mh(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const l=Object.keys(Nh).join(" / ");throw new V(`Hash '${s}' is unknown or not supported. Must be ${l}`)}const i=Nh[s],o=UI(i,r,e,{c:t,dkLen:n});return Po.encode(o).substring(1)}const $d={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},My={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Oy=new globalThis.TextEncoder;function VI(r,e){const t=$d[e];let n=My[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function KI(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=$d[e];let s=My[e],i=r;for(;i.length>0;){const o=Oy.encodeInto(i,t);i=i.slice(o.read);for(let l=0;l<o.written;l++)s^=BigInt(t[l]),s=BigInt.asUintN(e,s*n)}return s}function qI(r,{size:e=32,utf8Buffer:t}={}){if(!$d[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return KI(r,e,t);r=Oy.encode(r)}return VI(r,e)}const Fd={hash:r=>Number(qI(r,{size:32})),hashV:(r,e)=>HI(Fd.hash(r,e))};function HI(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),j(e,"base16")}const $y=64;class es{fp;h;seed;constructor(e,t,n,s=2){if(s>$y)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=Ke(s);for(let l=0;l<o.length;l++)o[l]=i[l];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?pe(this.fp,e.fp):!1}}function Ga(r,e){return Math.floor(Math.random()*(e-r))+r}class sa{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof es))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof es))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof es))throw new TypeError("Invalid Fingerprint");const t=Ga(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof es))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const zI=500;class Oh{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Fd,this.seed=e.seed??Ga(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=j(e));const t=new es(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new sa(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new sa(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[Ga(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new sa(this.bucketSize));for(let l=0;l<zI;l++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new sa(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=j(e));const t=new es(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=j(e));const t=new es(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const WI={1:.5,2:.84,4:.95,8:.98};function GI(r=.001){return r>.002?2:r>1e-5?4:8}function YI(r,e=.001){const t=GI(e),n=WI[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),$y);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class XI{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Fd,this.seed=e.seed??Ga(0,Math.pow(2,10)),this.filterSeries=[new Oh({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=j(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Oh({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=j(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=j(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function mo(r,e=.001,t){return new XI({...YI(r,e)})}function qe(r){const e=r.getComponents(),t={};let n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new V(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}class ZI{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const l=this.peekChar();if(l===void 0)return;const c=l==="0",d=2**(8*s)-1;for(;;){const f=this.readAtomically(()=>{const a=this.readChar();if(a===void 0)return;const u=Number.parseInt(a,e);if(!Number.isNaN(u))return u});if(f===void 0)break;if(i*=e,i+=f,i>d||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[l]=e(i.subarray(0,o));return t.set(i.subarray(0,l),16-l),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const Fy=45,jI=15,ci=new ZI;function Uy(r){if(!(r.length>jI))return ci.new(r).parseWith(()=>ci.readIPv4Addr())}function Vy(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Fy))return ci.new(r).parseWith(()=>ci.readIPv6Addr())}function Tu(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>Fy)return;const t=ci.new(r).parseWith(()=>ci.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function QI(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function JI(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function ek(r){switch(r.length){case yo:return r.join(".");case bo:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function tk(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function rk(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const yo=4,bo=16,nk=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Ky(r,e){e.length===bo&&r.length===yo&&QI(e,0,11)&&(e=e.slice(12)),e.length===yo&&r.length===bo&&JI(r,nk,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function sk(r,e){if(typeof e=="string"&&(e=Tu(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function ik(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=yo,s=Uy(e);if(s==null&&(n=bo,s=Vy(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=qy(i,8*n);return{network:Ky(s,o),mask:o}}function qy(r,e){if(e!==8*yo&&e!==8*bo)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class Hy{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=ik(e));else{const n=Tu(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=Tu(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=qy(s,8*n.length);this.network=Ky(n,this.mask)}}contains(e){return sk({network:this.network,mask:this.mask},e)}toString(){const e=tk(this.mask),t=e!==-1?String(e):rk(this.mask);return ek(this.network)+"/"+t}}function ok(r,e){return new Hy(r).contains(e)}function ak(r){try{const e=qe(r);return e.type==="ip6"?ok("2000::/3",e.host):!1}catch{return!1}}function lk(r){try{const e=qe(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function ck(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Pu(r){try{const e=qe(r);switch(e.type){case"ip4":case"ip6":return ck(e.host);default:return!1}}catch{return!1}}function _r(r){try{return qe(r),!0}catch{return!1}}function ui(r){return!!Uy(r)}function zy(r){return!!Vy(r)}var Ns={},$h;function uk(){return $h||($h=1,(function(){var r,e,t,n,s,i,o,l;l=function(c){var d,f,a,u;return d=(c&255<<24)>>>24,f=(c&255<<16)>>>16,a=(c&65280)>>>8,u=c&255,[d,f,a,u].join(".")},o=function(c){var d,f,a,u,h,p;for(d=[],a=u=0;u<=3&&c.length!==0;a=++u){if(a>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),h=p[0],f=p[1],c=c.substring(f),d.push(h)}if(c.length!==0)throw new Error("Invalid IP");switch(d.length){case 1:if(d[0]>4294967295)throw new Error("Invalid IP");return d[0]>>>0;case 2:if(d[0]>255||d[1]>16777215)throw new Error("Invalid IP");return(d[0]<<24|d[1])>>>0;case 3:if(d[0]>255||d[1]>255||d[2]>65535)throw new Error("Invalid IP");return(d[0]<<24|d[1]<<16|d[2])>>>0;case 4:if(d[0]>255||d[1]>255||d[2]>255||d[3]>255)throw new Error("Invalid IP");return(d[0]<<24|d[1]<<16|d[2]<<8|d[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var d,f,a,u,h;for(u=0,d=10,f="9",a=0,c.length>1&&c[a]==="0"&&(c[a+1]==="x"||c[a+1]==="X"?(a+=2,d=16):"0"<=c[a+1]&&c[a+1]<="9"&&(a++,d=8,f="7")),h=a;a<c.length;){if("0"<=c[a]&&c[a]<=f)u=u*d+(t(c[a])-n)>>>0;else if(d===16)if("a"<=c[a]&&c[a]<="f")u=u*d+(10+t(c[a])-i)>>>0;else if("A"<=c[a]&&c[a]<="F")u=u*d+(10+t(c[a])-s)>>>0;else break;else break;if(u>4294967295)throw new Error("too large");a++}if(a===h)throw new Error("empty octet");return[u,a]},r=(function(){function c(d,f){var a,u,h;if(typeof d!="string")throw new Error("Missing `net' parameter");if(f||(h=d.split("/",2),d=h[0],f=h[1]),f||(f=32),typeof f=="string"&&f.indexOf(".")>-1){try{this.maskLong=o(f)}catch{throw new Error("Invalid mask: "+f)}for(a=u=32;u>=0;a=--u)if(this.maskLong===4294967295<<32-a>>>0){this.bitmask=a;break}}else if(f||f===0)this.bitmask=parseInt(f,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(d)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+d)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+f);this.size=Math.pow(2,32-this.bitmask),this.base=l(this.netLong),this.mask=l(this.maskLong),this.hostmask=l(~this.maskLong),this.first=this.bitmask<=30?l(this.netLong+1):this.base,this.last=this.bitmask<=30?l(this.netLong+this.size-2):l(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?l(this.netLong+this.size-1):void 0}return c.prototype.contains=function(d){return typeof d=="string"&&(d.indexOf("/")>0||d.split(".").length!==4)&&(d=new c(d)),d instanceof c?this.contains(d.base)&&this.contains(d.broadcast||d.last):(o(d)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(d){return d==null&&(d=1),new c(l(this.netLong+this.size*d),this.mask)},c.prototype.forEach=function(d){var f,a,u;for(u=o(this.first),a=o(this.last),f=0;u<=a;)d(l(u),u,f),f++,u++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),Ns.ip2long=o,Ns.long2ip=l,Ns.Netmask=r}).call(Ns)),Ns}var dk=uk();const fk=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],hk=fk.map(r=>new dk.Netmask(r));function Ud(r){for(const e of hk)if(e.contains(r))return!0;return!1}function pk(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function gk(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Ud(s)}function mk(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function yk(r){const e=r.split(":"),t=e[e.length-1];return Ud(t)}function bk(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function Vd(r){if(ui(r))return Ud(r);if(pk(r))return gk(r);if(mk(r))return yk(r);if(zy(r))return bk(r)}function di(r){try{const e=qe(r);switch(e.type){case"ip4":case"ip6":return Vd(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}let vk=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},wk=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const Fh=r=>globalThis.DOMException===void 0?new wk(r):new DOMException(r),Uh=r=>{const e=r.reason===void 0?Fh("This operation was aborted."):r.reason;return e instanceof Error?e:Fh(e)};function _k(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,l;const d=new Promise((f,a)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:h}=e;h.aborted&&a(Uh(h)),l=()=>{a(Uh(h))},h.addEventListener("abort",l,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,a);return}const u=new vk;o=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){a(h)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?f():s instanceof Error?a(s):(u.message=s??`Promise timed out after ${t} milliseconds`,a(u))},t),(async()=>{try{f(await r)}catch(h){a(h)}})()}).finally(()=>{d.clear(),l&&e.signal&&e.signal.removeEventListener("abort",l)});return d.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},d}const Sk=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Ek(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const l=[e].flat(),c=[],{addListener:d,removeListener:f}=Sk(r),a=async(...h)=>{const p=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(p))return}catch(y){n(),o(y);return}c.push(p),t.count===c.length&&(n(),i(c))},u=(...h)=>{n(),o(t.rejectionMultiArgs?h:h[0])};n=()=>{for(const h of l)f(h,a);for(const h of t.rejectionEvents)l.includes(h)||f(h,u)};for(const h of l)d(h,a);for(const h of t.rejectionEvents)l.includes(h)||d(h,u);t.signal&&t.signal.addEventListener("abort",()=>{u(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=_k(s,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return s}function fr(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=Ek(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}function Ya(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class xk extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let Ak=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};class Xa extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"}class Ik extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"}class kk extends Error{static name="StreamClosedError";name="StreamClosedError"}let Ck=class{deferred;signal;constructor(e){this.signal=e,this.deferred=cr(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new co)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Tk(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let Pk=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Tk(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new co),this.cleanup())}async join(e={}){const t=new Ck(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Ct(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},Wy=class extends Dt{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Ya(this.emitEmpty.bind(this),1),this.emitIdle=Ya(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Ak;const n=new Pk(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new co)}),this.clear()}async onEmpty(e){this.size!==0&&await fr(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await fr(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await fr(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ad({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail.error)},o=()=>{n()},l=()=>{n(new co("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",l),n()}}};const Dk=Math.pow(2,20)*4;class Gy extends Dt{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??Dk,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new Ne,this.writeBuffer=new Ne,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);const t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);const n=s=>{this.onDrainPromise?.reject(s.error??new kk)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),Ct(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;const e=ad(),t=i=>{e.push(i.data)};this.addEventListener("message",t);const n=i=>{e.end(i.error)};this.addEventListener("close",n);const s=()=>{e.end()};this.addEventListener("remoteCloseWrite",s);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",s)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new Pi(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new eA(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Pi("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Pi("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Pi(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Pi(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");const e=new Xx;this.dispatchEvent(new tA(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Ol))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let n=0;for(;this.writeBuffer.byteLength>0;){const s=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(s===0){e=!1;break}const i=this.writeBuffer.sublist(0,s),o=new Ne(i);this.writeBuffer.consume(i.byteLength);const l=this.sendData(i);if(e=l.canSendMore,n+=l.sentBytes,l.sentBytes!==o.byteLength&&(o.consume(l.sentBytes),this.writeBuffer.prepend(o)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new Jx(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new fh(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new fh(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}}class Yy extends Gy{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}}function Lk(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class Rk extends Dt{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;const n=o=>{try{this.onData(o.data)}catch(l){this.abort(l),this.maConn.abort(l)}};this.maConn.addEventListener("message",n);const s=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(o=>{o.onMuxerDrain()})};this.maConn.addEventListener("drain",s);const i=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",i)}send(e){const t=this.maConn.send(e);return t===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),t}async close(e){this.status==="closed"||this.status==="closing"||(this.status="closing",await Ct(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(t){this.abort(t)}this.status="closed"}async createStream(e){if(this.status!=="open")throw new Vi;let t=this.onCreateStream({...this.streamOptions,...e});return Lk(t)&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),this.listenerCount("stream")===0){this.earlyStreams.push(e),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new Ik(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){const t=n=>{const s=this.streams.findIndex(i=>i===e);s!==-1&&this.streams.splice(s,1),n.error!=null?n.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})};e.addEventListener("close",t),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(t=>{this.safeDispatchEvent("stream",{detail:t})}),this.earlyStreams=[]})}}class Bk extends Gy{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await fr(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(e){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}}function vs(r){const e=new globalThis.AbortController;function t(){const i=r.filter(o=>o?.aborted===!0).map(o=>o?.reason).pop();e.abort(i);for(const o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}class yc{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const Nk=1.2,Mk=2,Ok=5e3,$k=6e4,Fk=5e3;class Uk{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??Fk;this.success=new yc(t),this.failure=new yc(t),this.next=new yc(t),this.failureMultiplier=e.failureMultiplier??Mk,this.timeoutMultiplier=e.timeoutMultiplier??Nk,this.minTimeout=e.minTimeout??Ok,this.maxTimeout=e.maxTimeout??$k,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=vs([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class ur extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class vo extends Error{static name="ValidationError";name="ValidationError"}class Vk extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class Kk extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}const Za=4,us=6,Xy=273,qk=33,ws=41,Kd=42,qd=43,Hd=53,zd=54,Wd=55,Gd=56,Hk=132,zk=301,Wk=302,Zy=400,ce=421,Gk=444,Yk=445,Xk=446,Zk=447,ds=448,ja=449,jk=454,jy=460,Qy=461,Jy=465,wo=466,Zs=480,Qk=481,Du=443,Yd=477,eb=478,Jk=479,eC=277,tC=275,rC=276,tb=280,ji=281,Ho=290,rb=777;function Vh(r){return e=>W(e,r)}function Kh(r){return e=>j(e,r)}function qi(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Us(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function nC(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=j(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Us(n);return an([t,s],t.length+s.length)}function sC(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ln.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Us(n);return an([t,s],t.length+s.length)}function qh(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=W(e,"base32"),s=qi(t);return`${n}:${s}`}const nb=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new ur("Invalid byte value in IP address");e[n]=s}),e},iC=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=ui(t[n]);let o;i&&(o=nb(t[n]),t[n]=W(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,W(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new ur("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},oC=function(r){if(r.byteLength!==4)throw new ur("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},aC=function(r){if(r.byteLength!==16)throw new ur("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new ur(`Invalid IPv6 address "${t}"`)}};function lC(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new ur(`Invalid IPv6 address "${r}"`)}}const bc=Object.values(tu).map(r=>r.decoder),cC=(function(){let r=bc[0].or(bc[1]);return bc.slice(2).forEach(e=>r=r.or(e)),r})();function uC(r){return cC.decode(r)}function dC(r){return e=>r.encoder.encode(e)}function fC(r){if(parseInt(r).toString()!==r)throw new vo("Value must be an integer")}function hC(r){if(r<0)throw new vo("Value must be a positive integer, or zero")}function pC(r){return e=>{if(e>r)throw new vo(`Value must be smaller than or equal to ${r}`)}}function gC(...r){return e=>{for(const t of r)t(e)}}const ia=gC(fC,hC,pC(65535)),Et=-1;class mC{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new Kk(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}}const xi=new mC,yC=[{code:Za,name:"ip4",size:32,valueToBytes:nb,bytesToValue:oC,validate:r=>{if(!ui(r))throw new vo(`Invalid IPv4 address "${r}"`)}},{code:us,name:"tcp",size:16,valueToBytes:Us,bytesToValue:qi,validate:ia},{code:Xy,name:"udp",size:16,valueToBytes:Us,bytesToValue:qi,validate:ia},{code:qk,name:"dccp",size:16,valueToBytes:Us,bytesToValue:qi,validate:ia},{code:ws,name:"ip6",size:128,valueToBytes:iC,bytesToValue:aC,stringToValue:lC,validate:r=>{if(!zy(r))throw new vo(`Invalid IPv6 address "${r}"`)}},{code:Kd,name:"ip6zone",size:Et},{code:qd,name:"ipcidr",size:8,bytesToValue:Vh("base10"),valueToBytes:Kh("base10")},{code:Hd,name:"dns",size:Et},{code:zd,name:"dns4",size:Et},{code:Wd,name:"dns6",size:Et},{code:Gd,name:"dnsaddr",size:Et},{code:Hk,name:"sctp",size:16,valueToBytes:Us,bytesToValue:qi,validate:ia},{code:zk,name:"udt"},{code:Wk,name:"utp"},{code:Zy,name:"unix",size:Et,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:ce,name:"p2p",aliases:["ipfs"],size:Et,bytesToValue:Vh("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?Kh("base58btc")(r):ue.parse(r).multihash.bytes},{code:Gk,name:"onion",size:96,bytesToValue:qh,valueToBytes:nC},{code:Yk,name:"onion3",size:296,bytesToValue:qh,valueToBytes:sC},{code:Xk,name:"garlic64",size:Et},{code:Zk,name:"garlic32",size:Et},{code:ds,name:"tls"},{code:ja,name:"sni",size:Et},{code:jk,name:"noise"},{code:jy,name:"quic"},{code:Qy,name:"quic-v1"},{code:Jy,name:"webtransport"},{code:wo,name:"certhash",size:Et,bytesToValue:dC(zg),valueToBytes:uC},{code:Zs,name:"http"},{code:Qk,name:"http-path",size:Et,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:Du,name:"https"},{code:Yd,name:"ws"},{code:eb,name:"wss"},{code:Jk,name:"p2p-websocket-star"},{code:eC,name:"p2p-stardust"},{code:tC,name:"p2p-webrtc-star"},{code:rC,name:"p2p-webrtc-direct"},{code:tb,name:"webrtc-direct"},{code:ji,name:"webrtc"},{code:Ho,name:"p2p-circuit"},{code:rb,name:"memory",size:Et}];yC.forEach(r=>{xi.addProtocol(r)});function bC(r){const e=[];let t=0;for(;t<r.length;){const n=Td(r,t),s=xi.getProtocol(n),i=xr(n),o=SC(s,r,t+i);let l=0;o>0&&s.size===Et&&(l=xr(o));const c=i+l+o,d={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const f=t+i+l,a=r.subarray(f,f+o);d.value=s.bytesToValue?.(a)??W(a)}e.push(d),t+=c}return e}function vC(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=xi.getProtocol(n.code),i=xr(n.code);let o,l=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??j(n.value),l=o.byteLength,s.size===Et&&(c=xr(l)));const d=new Uint8Array(i+c+l);let f=0;Ha(n.code,d,f),f+=i,o!=null&&(s.size===Et&&(Ha(l,d,f),f+=c),d.set(o,f)),n.bytes=d}t.push(n.bytes),e+=n.bytes.byteLength}return an(t,e)}function wC(r){if(r.charAt(0)!=="/")throw new ur('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const l=i===r.length-1;if(o==="/"||l){const c=xi.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(l)throw new ur(`Component ${s} was missing value`);t="value"}else if(t==="value"){const d={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new ur(`Component ${s} was missing value`);d.value=c.stringToValue?.(n)??n}e.push(d),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new ur("Incomplete multiaddr");return e}function _C(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=xi.getProtocol(e.code);if(t==null)throw new ur(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function SC(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Td(e,t)}const EC=Symbol.for("nodejs.util.inspect.custom"),sb=Symbol.for("@multiformats/multiaddr");function xC(r){if(r==null&&(r="/"),zl(r))return r.getComponents();if(r instanceof Uint8Array)return bC(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),wC(r);if(Array.isArray(r))return r;throw new ur("Must be a string, Uint8Array, Component[], or another Multiaddr")}class Vs{[sb]=!0;#e;#t;#r;constructor(e="/",t={}){this.#e=xC(e),t.validate!==!1&&AC(this)}get bytes(){return this.#r==null&&(this.#r=vC(this.#e)),this.#r}toString(){return this.#t==null&&(this.#t=_C(this.#e)),this.#t}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){const t=new Vs(e);return new Vs([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Vk(`Address ${this.toString()} does not contain subaddress: ${t}`);return new Vs(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new Vs(this.#e.slice(0,t),{validate:!1})}equals(e){return pe(this.bytes,e.bytes)}[EC](){return`Multiaddr(${this.toString()})`}}function AC(r){r.getComponents().forEach(e=>{const t=xi.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function zl(r){return!!r?.[sb]}function he(r){return new Vs(r)}const IC=4194304;class Hh extends Error{static name="UnwrappedError";name="UnwrappedError"}class kC extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}let CC=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"};class TC extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function PC(r){return typeof r?.closeRead=="function"}function DC(r){return typeof r?.close=="function"}function vc(r){return PC(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:DC(r)?r.status!=="open":!1}function LC(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function ib(r,e){const t=e?.maxBufferSize??IC,n=new Ne;let s,i=!1;if(!LC(r))throw new V("Argument should be a Stream or a Multiaddr");const o=f=>{if(n.append(f.data),n.byteLength>t){const a=n.byteLength;n.consume(n.byteLength),s?.reject(new Error(`Read buffer overflow - ${a} > ${t}`))}s?.resolve()};r.addEventListener("message",o);const l=f=>{f.error!=null?s?.reject(f.error):s?.resolve()};r.addEventListener("close",l);const c=()=>{s?.resolve()};r.addEventListener("remoteCloseWrite",c);const d={readBuffer:n,async read(f){if(i===!0)throw new Hh("Stream was unwrapped");if(vc(r)){if(f?.bytes==null)return null;if(n.byteLength<f.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,f.bytes),new Xa(`Unexpected EOF - stream closed after reading ${n.byteLength}/${f.bytes} bytes`)}const a=f?.bytes??1;for(s=Promise.withResolvers();;){if(n.byteLength>=a){s.resolve();break}if(await Ct(s.promise,f?.signal),vc(r)){if(n.byteLength===0&&f?.bytes==null)return null;break}s=Promise.withResolvers()}const u=f?.bytes??n.byteLength;if(n.byteLength<u){if(vc(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,u),new Xa(`Unexpected EOF - stream closed while reading ${n.byteLength}/${u} bytes`);return d.read(f)}const h=n.sublist(0,u);return n.consume(u),h},async write(f,a){if(i===!0)throw new Hh("Stream was unwrapped");r.send(f)||await fr(r,"drain",{signal:a?.signal,rejectionEvents:["close"]})},unwrap(){return i||(i=!0,r.removeEventListener("message",o),r.removeEventListener("close",l),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return d}function Xd(r,e={}){const t=ib(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=xr(e.maxDataLength));const n=e?.lengthDecoder??Td,s=e?.lengthEncoder??Zi;return{async read(o){let l=-1;const c=new Ne;for(;;){const f=await t.read({...o,bytes:1});if(f==null)break;c.append(f);try{l=n(c)}catch(a){if(a instanceof RangeError)continue;throw a}if(l<0)throw new kC("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new TC(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(l>-1)break}if(e?.maxDataLength!=null&&l>e.maxDataLength)throw new CC(`Message length too long - ${l} > ${e.maxDataLength}`);const d=await t.read({...o,bytes:l});if(d==null)throw r.log.error("tried to read %d bytes but the stream closed",l),new Xa(`Unexpected EOF - tried to read ${l} bytes but the stream closed`);if(d.byteLength!==l)throw r.log.error("read %d/%d bytes before the stream closed",d.byteLength,l),new Xa(`Unexpected EOF - read ${d.byteLength}/${l} bytes before the stream closed`);return d},async write(o,l){await t.write(new Ne(s(o.byteLength),o),l)},async writeV(o,l){const c=new Ne(...o.flatMap(d=>[s(d.byteLength),d]));await t.write(c,l)},unwrap(){return t.unwrap()}}}function $n(r,e){const t=Xd(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(l=>i.encode(l)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class Zd extends Wy{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}let RC=class extends Wy{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};class BC{memoryStorage;points;duration;blockDuration;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new NC}consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new xk("Rate limit exceeded",o);return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class NC{storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function ob(r,e,t){let n,s,i=!1;function o(){const d={signal:s.signal};if(t?.timeout!=null){const f=vs([s.signal,AbortSignal.timeout(t.timeout)]);d.signal=f}i=!0,Promise.resolve().then(async()=>{await r(d)}).catch(()=>{}).finally(()=>{i=!1,!s.signal.aborted&&(n=setTimeout(o,e))})}const l=Ya(o,t?.debounce??100);let c=!1;return{setInterval:d=>{e!==d&&(e=d,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:d=>{t??={},t.timeout=d},run:()=>{i||(clearTimeout(n),l())},start:()=>{c||(c=!0,s=new AbortController,s.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),s?.abort(),c=!1}}}class MC extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function un(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new MC({name:e,metrics:t}):n=new Map,n}var Qe;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Qe||(Qe={}));var Se;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Se||(Se={}));Object.values(Se).filter(r=>typeof r!="string");const OC=0;var Zt;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Zt||(Zt={}));const ts=12;class Wl extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}}function $C(r){return r?.reason!==null}class Ks extends Wl{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,Zt.ProtocolError),this.name="InvalidFrameError"}}class FC extends Wl{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,Zt.ProtocolError),this.name="UnRequestedPingError"}}class UC extends Wl{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,Zt.ProtocolError),this.name="NotMatchingPingError"}}class VC extends Wl{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,Zt.ProtocolError),this.name="ReceiveWindowExceededError"}}const ab=256*1024,KC=16*1024*1024,oa={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3};function qC(r){if(r.keepAliveInterval!=null&&r.keepAliveInterval<=0)throw new V("keep-alive interval must be positive");if(r.maxInboundStreams!=null&&r.maxInboundStreams<0)throw new V("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams!=null&&r.maxOutboundStreams<0)throw new V("max outbound streams must be larger or equal 0");if(r.maxMessageSize!=null&&r.maxMessageSize<1024)throw new V("MaxMessageSize must be greater than a kilobyte");if(r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize<ab)throw new V("InitialStreamWindowSize must be larger or equal 256 kB");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize<r.streamOptions?.initialStreamWindowSize)throw new V("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize>2**32-1)throw new V("MaxStreamWindowSize must be less than equal MAX_UINT32")}function HC(r){return r.header.type===Qe.Data&&r.data!==null}const zh=2**24;function zC(r){if(r[0]!==OC)throw new Ks("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*zh+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*zh+(r[9]<<16)+(r[10]<<8)+r[11]}}class WC{buffer;constructor(){this.buffer=new Ne}*emitFrames(e){for(this.buffer.append(e);;){const t=this.readFrame();if(t===void 0)break;yield t}}readFrame(){let e=ts;if(this.buffer.byteLength<ts)return;const t=zC(this.buffer.subarray(0,ts));if(t.type===Qe.Data){if(e+=t.length,this.buffer.byteLength<e)return;const n=this.buffer.sublist(ts,e);return this.buffer.consume(e),{header:t,data:n}}return this.buffer.consume(e),{header:t}}}function Wh(r){const e=new Uint8Array(ts);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var Ut;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished",r[r.Paused=5]="Paused"})(Ut||(Ut={}));class GC extends Bk{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){const t=e.initialStreamWindowSize??ab;super({...e,maxMessageSize:t-ts}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??KC,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;const n=()=>{this.state=Ut.Finished};this.addEventListener("close",n)}sendData(e){const t=e.byteLength;let n=0,s=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(this.sendWindowCapacity===0){s=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",n,t);break}const i=Math.min(this.sendWindowCapacity,e.byteLength),o=this.getSendFlags(),l=e.sublist(0,i);e.consume(i);const c=this.sendFrame({type:Qe.Data,flag:o,streamID:this.streamId,length:i},l);if(this.sendWindowCapacity-=i,n+=i,!c){s=c,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",n,t);break}}return{sentBytes:n,canSendMore:s}}sendReset(){this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Se.FIN;this.sendFrame({type:Qe.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=Ut.Paused}sendResume(){this.state=Ut.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-ts,this.maxMessageSize<0&&(this.maxMessageSize=0),this.maxMessageSize!==0&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!HC(e))throw new Ks("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new VC("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&Se.ACK)===Se.ACK&&this.state===Ut.SYNSent&&(this.state=Ut.Established),(e&Se.FIN)===Se.FIN&&this.onRemoteCloseWrite(),(e&Se.RST)===Se.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case Ut.Init:return this.state=Ut.SYNSent,Se.SYN;case Ut.SYNReceived:return this.state=Ut.Established,Se.ACK;default:return 0}}sendWindowUpdate(){if(this.state===Ut.Paused){this.epochStart=Date.now();return}const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<=n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Qe.WindowUpdate,flag:e,streamID:this.streamId,length:s})}}function Gh(r){return{type:Qe[r.type],flags:[(r.flag&Se.SYN)===Se.SYN?"SYN":void 0,(r.flag&Se.ACK)===Se.ACK?"ACK":void 0,(r.flag&Se.FIN)===Se.FIN?"FIN":void 0,(r.flag&Se.RST)===Se.RST?"RST":void 0].filter(Boolean),streamID:r.streamID,length:r.length}}const lb="/yamux/1.0.0";class YC{protocol=lb;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[Er]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new XC(e,{...this._init})}}class XC extends Rk{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:lb,name:"yamux"}),this.client=e.direction==="outbound",qC(t),this.enableKeepAlive=t.enableKeepAlive??oa.enableKeepAlive,this.keepAliveInterval=t.keepAliveInterval??oa.keepAliveInterval,this.maxInboundStreams=t.maxInboundStreams??oa.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??oa.maxOutboundStreams,this.decoder=new WC,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=ob(async n=>{try{await this.ping(n)}catch(s){this.log.error("ping error: %s",s)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(const t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(this.remoteGoAway!==void 0)throw new Vi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Vi("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new Dm("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);const t=this._newStream(e,Ut.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(this.remoteGoAway!==void 0)throw new Vi("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Vi("Muxer closed locally");if(this.activePing!=null)return Ct(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await Ct(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.status==="open")try{const t=e?.reason??Zt.NormalTermination;this.log.trace("muxer close reason=%s",Zt[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if(this.status==="open")try{super.abort(e);let t=Zt.InternalError;$C(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,n){if(this.streams.find(i=>i.streamId===e)!=null)throw new V("Stream already exists with that id");const s=new GC({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:n,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${n}:${e}`),getRTT:this.getRTT.bind(this)});return s.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){const{streamID:t,type:n,length:s}=e.header;if(this.log.trace("received frame %o",Gh(e.header)),t===0)switch(n){case Qe.Ping:{this.handlePing(e.header);return}case Qe.GoAway:{this.handleGoAway(s);return}default:throw new Ks("Invalid frame type")}else switch(e.header.type){case Qe.Data:case Qe.WindowUpdate:{this.handleStreamMessage(e);return}default:throw new Ks("Invalid frame type")}}handlePing(e){if(e.flag===Se.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Se.ACK);else if(e.flag===Se.ACK)this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Ks("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new FC("ping not requested");if(this.activePing.id!==e)throw new UC("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",Zt[e]??"unknown"),this.remoteGoAway=e,e===Zt.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){const{streamID:t,flag:n,type:s}=e.header;(n&Se.SYN)===Se.SYN&&this.incomingStream(t);const i=this.streams.find(o=>o.streamId===t);if(i===void 0){this.log.trace("frame for missing stream id=%s",t);return}switch(s){case Qe.WindowUpdate:{i.handleWindowUpdate(e);return}case Qe.Data:{i.handleData(e);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new V("Both endpoints are clients");if(this.streams.find(n=>n.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.maxInboundStreams){this.log("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}const t=this._newStream(e,Ut.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let n;if(e.type===Qe.Data){if(t==null)throw new Ks("Invalid frame");n=new Ne(Wh(e),t)}else n=Wh(e);return this.log.trace("sending frame %o",Gh(e)),this.send(n)}sendPing(e,t=Se.SYN){t===Se.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:Qe.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Zt.NormalTermination){this.log("sending GoAway reason=%s",Zt[e]),this.localGoAway=e,this.sendFrame({type:Qe.GoAway,flag:0,streamID:0,length:e})}}function ZC(r={}){return()=>new YC(r)}const cb=Symbol.for("nodejs.util.inspect.custom"),jC=114;let jd=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(jC,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[cb](){return`PeerId(${this.toString()})`}},QC=class extends jd{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},JC=class extends jd{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},eT=class extends jd{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const tT=2336;let ub=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[cb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(tT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const rT=114,Yh=2336;function nT(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=fn(Pe.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return sT(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return db(t)}function db(r){if(oT(r))return new QC({multihash:r});if(iT(r))try{const e=Hn(r);if(e.type==="Ed25519")return new JC({multihash:r,publicKey:e});if(e.type==="secp256k1")return new eT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new ub(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function sT(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==rT&&r.code!==Yh)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Yh){const e=W(r.multihash.digest);return new ub(new URL(e))}return db(r.multihash)}function iT(r){return r.code===it.code}function oT(r){return r.code===pr.code}const Fe=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),ae=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),aT=r=>({match:e=>r.match(e)===!1?e:!1}),me=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),Ot=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),Ae=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function Ve(...r){function e(s){if(s==null)return!1;let i=s.getComponents();for(const o of r){const l=o.match(i);if(l===!1)return!1;i=l}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const lT=ae(ce),cT=Ve(lT),Gl=ae(zd),Yl=ae(Wd),Xl=ae(Gd),Qd=ae(Hd);Ve(Gl,me(ae(ce)));Ve(Yl,me(ae(ce)));Ve(Xl,me(ae(ce)));Ve(Ot(Qd,Xl,Gl,Yl),me(ae(ce)));const fb=Ae(ae(Za),me(ae(qd))),hb=Ae(me(ae(Kd)),ae(ws),me(ae(qd))),Jd=Ot(fb,hb),_s=Ot(Jd,Qd,Gl,Yl,Xl),uT=Ve(Ot(Jd,Ae(Ot(Qd,Xl,Gl,Yl),me(ae(ce))))),Xh=Ve(fb),Zh=Ve(hb);Ve(Jd);const ef=Ae(_s,ae(us)),zo=Ae(_s,ae(Xy)),Qa=Ve(Ae(ef,me(ae(ce))));Ve(zo);const tf=Ae(zo,Fe(jy),me(ae(ce))),Zl=Ae(zo,Fe(Qy),me(ae(ce))),dT=Ot(tf,Zl);Ve(tf);const fT=Ve(Zl),Lu=Ot(_s,ef,zo,tf,Zl),pb=Ot(Ae(Lu,Fe(Yd),me(ae(ce)))),_o=Ve(pb),gb=Ot(Ae(Lu,Fe(eb),me(ae(ce))),Ae(Lu,Fe(ds),me(ae(ja)),Fe(Yd),me(ae(ce)))),Ja=Ve(gb),mb=Ae(zo,Fe(tb),me(ae(wo)),me(ae(wo)),me(ae(ce))),jh=Ve(mb),yb=Ae(Zl,Fe(Jy),me(ae(wo)),me(ae(wo)),me(ae(ce))),Qh=Ve(yb),el=Ot(pb,gb,Ae(ef,me(ae(ce))),Ae(dT,me(ae(ce))),Ae(_s,me(ae(ce))),mb,yb,ae(ce)),bb=Ve(el),hT=Ae(me(el),Fe(Ho),aT(Fe(ji)),me(ae(ce))),fi=Ve(hT),pT=Ot(Ae(el,Fe(Ho),Fe(ji),me(ae(ce))),Ae(el,Fe(ji),me(ae(ce))),Ae(Fe(ji),me(ae(ce)))),Jh=Ve(pT),gT=Ot(Ae(_s,ae(us),Fe(Zs),me(ae(ce))),Ae(_s,Fe(Zs),me(ae(ce))));Ve(gT);const mT=Ae(_s,Ot(Ae(ae(us,"443"),Fe(Zs)),Ae(ae(us),Fe(Du)),Ae(ae(us),Fe(ds),Fe(Zs)),Ae(Fe(ds),Fe(Zs)),Fe(ds),Fe(Du)),me(ae(ce)));Ve(mT);const yT=Ot(Ae(ae(rb),me(ae(ce))));Ve(yT);const bT=Ot(Ae(ae(Zy),me(ae(ce))));Ve(bT);const vT="bootstrap",wT=50,_T=1e3;class ST extends Dt{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??_T,this.list=t.list.map(n=>he(n)).filter(n=>bb.matches(n)?n.getComponents().findLast(i=>i.code===ce)?.value==null?(this.log.error("invalid bootstrap multiaddr without peer id"),!1):!0:(this.log.error("invalid multiaddr %a",n),!1)).map(n=>({id:nT(n.getComponents().findLast(s=>s.code===ce)?.value??""),multiaddrs:[n]})),this._init=t}[Oa]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[Er]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??vT]:{value:this._init.tagValue??wT,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function ET(r){return e=>new ST(e,r)}const vb=Symbol.for("nodejs.util.inspect.custom"),xT=114;let rf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(xT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[vb](){return`PeerId(${this.toString()})`}},AT=class extends rf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},IT=class extends rf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},kT=class extends rf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const CT=2336;let wb=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[vb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(CT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const TT=114,ep=2336;function tp(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=fn(Pe.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return PT(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return nf(t)}function nf(r){if(LT(r))return new AT({multihash:r});if(DT(r))try{const e=Hn(r);if(e.type==="Ed25519")return new IT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new kT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new wb(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function PT(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==TT&&r.code!==ep)throw new Oo("Supplied PeerID CID is invalid");if(r.code===ep){const e=W(r.multihash.digest);return new wb(new URL(e))}return nf(r.multihash)}function DT(r){return r.code===it.code}function LT(r){return r.code===pr.code}var tl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),payload:Ke(0),signature:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(tl||(tl={}));class RT extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class sn{static createFromProtobuf=e=>{const t=tl.decode(e),n=qn(t.publicKey);return new sn({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),l=rp(s,i,o),c=await t.sign(l.subarray(),n);return new sn({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=sn.createFromProtobuf(e);if(!await s.validate(t,n))throw new RT("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=tl.encode({publicKey:wr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:pe(this.marshal(),e.marshal())}async validate(e,t){const n=rp(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const rp=(r,e,t)=>{const n=j(r),s=Zi(n.byteLength),i=Zi(e.length),o=Zi(t.length);return new Ne(s,n,i,e,o,t)},_b=Symbol.for("nodejs.util.inspect.custom"),BT=114;let sf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(BT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[_b](){return`PeerId(${this.toString()})`}},NT=class extends sf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},MT=class extends sf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},OT=class extends sf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const $T=2336;let FT=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[_b](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1($T,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function UT(r){if(KT(r))return new NT({multihash:r});if(VT(r))try{const e=Hn(r);if(e.type==="Ed25519")return new MT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new OT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new FT(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function VT(r){return r.code===it.code}function KT(r){return r.code===pr.code}const qT="libp2p-peer-record",HT=Uint8Array.from([3,1]);var rl;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={multiaddr:Ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();d>>>3===1?l.multiaddr=s.bytes():s.skipType(d&7)}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:Ke(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new yt('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(rl||(rl={}));function zT(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}class dr{static createFromProtobuf=e=>{const t=rl.decode(e),n=UT(fn(t.peerId)),s=(t.addresses??[]).map(o=>he(o.multiaddr)),i=t.seq;return new dr({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=qT;static CODEC=HT;peerId;multiaddrs;seqNumber;domain=dr.DOMAIN;codec=dr.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=rl.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof dr)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!zT(this.multiaddrs,e.multiaddrs))}}const WT=1,Sb=5e3,GT=100,aa=`${hd}-circuit-relay`;BigInt(1<<17);const nl="/libp2p/circuit/relay/0.2.0/hop",np="/libp2p/circuit/relay/0.2.0/stop",sp=300,YT=4096,XT=.001;var hi;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),(function(n){n.codec=()=>Ko(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),pi.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),sl.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),gi.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),Bt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},l=s==null?n.len:n.pos+s;for(;n.pos<l;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=pi.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=sl.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=gi.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Bt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,s)=>Ie(n,r.codec(),s)})(hi||(hi={}));var Gr;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),(function(n){n.codec=()=>Ko(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),pi.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),gi.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),Bt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},l=s==null?n.len:n.pos+s;for(;n.pos<l;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=pi.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=gi.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Bt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,s)=>Ie(n,r.codec(),s)})(Gr||(Gr={}));var pi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:Ke(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(pi||(pi={}));var sl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),ol.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=ol.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(sl||(sl={}));var gi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(gi||(gi={}));var Bt;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Bt||(Bt={}));var Ru;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Ru||(Ru={}));(function(r){r.codec=()=>Ko(Ru)})(Bt||(Bt={}));var il;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:Ke(0),peer:Ke(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(il||(il={}));var ol;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),il.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),signature:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=il.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ol||(ol={}));class ip extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class ZT extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class jT extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function op(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class ap{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const Eb=Ve(Ae(bb.matchers[0],Fe(Ho))),xb=Ve(Fe(Ho)),Ab=Symbol.for("nodejs.util.inspect.custom"),QT=114;let of=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(QT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Ab](){return`PeerId(${this.toString()})`}},JT=class extends of{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},eP=class extends of{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},tP=class extends of{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const rP=2336;let nP=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Ab](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(rP,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function sP(r){if(oP(r))return new JT({multihash:r});if(iP(r))try{const e=Hn(r);if(e.type==="Ed25519")return new eP({multihash:r,publicKey:e});if(e.type==="secp256k1")return new tP({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new nP(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function iP(r){return r.code===it.code}function oP(r){return r.code===pr.code}function Qi(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function wc(r){const e=fn(Pe.decode(`z${r}`));return sP(e)}class ks{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Qi(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Qi(this.map.values(),e=>e.key)}values(){return Qi(this.map.values(),e=>e.value)}get size(){return this.map.size}}class fs{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Qi(this.set.entries(),e=>{const t=wc(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=wc(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Qi(this.set.values(),e=>wc(e))}intersection(e){const t=new fs;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new fs;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new fs;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}class aP{filter;constructor(e,t){this.filter=mo(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function lP(r,e=.001){return new aP(r,e)}class cP extends ks{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function uP(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new cP({name:e,metrics:t}):n=new ks,n}class nt extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class dP extends Dt{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(nl,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(nl)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=lp(n),o=lp(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new Zd({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p - %e",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=vs([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function lp(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(W(e)).getTime()}class fP extends Dt{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??Sb,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(xb.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Eb.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new bu(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>he(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function hP(r){return new fP(r)}const pP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let gP=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=pP[t[r]&63];return e};const mP=60*1e3*10,yP=60*1e3*5,bP=30*1e3;class vP extends Dt{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new ks,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??GT,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??Sb,this.started=!1,this.relayFilter=mo(100),this.reserveQueue=new Zd({concurrency:t?.reservationConcurrency??WT,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#t(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(aa)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[aa]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#r()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=gP();return this.pendingReservations.push(e),this.#r(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new bu("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new jT("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new bu("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const p=this.connectionManager.getConnections(e);let y=!1;if(p.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),p.map(g=>g.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),y=!0),y&&op(i.reservation.expire)>mP)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#t(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new ip("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const l=await this.connectionManager.openConnection(e,{signal:o});if(fi.matches(l.remoteAddr))throw new ZT("not creating reservation over relayed connection");const c=await this.#e(l,{signal:o}),d=op(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+d).toString());const f=Math.min(Math.max(d-yP,bP),Math.pow(2,31)-1),a=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async p=>{this.log.error("could not refresh reservation to relay %p - %e",e,p),await this.#t(e)}).catch(p=>{this.log.error("could not remove expired reservation to relay %p - %e",e,p)})},f);let u;if(t==="discovered"){const p=this.pendingReservations.pop();if(p==null)throw new ip("Made reservation on relay but did not need any more discovered relays");u={timeout:a,reservation:c,type:t,connection:l.id,id:p}}else u={timeout:a,reservation:c,type:t,connection:l.id};this.reservations.set(e,u),await this.peerStore.merge(e,{tags:{[aa]:{value:1,ttl:d}}}),this.#r();const h={relay:e,details:u};return this.safeDispatchEvent("relay:created-reservation",{detail:h}),h}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#t(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(nl,t),i=$n(n).pb(hi);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:hi.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",o.status),o.status===Bt.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const d of o.reservation.addrs){let f=he(d);f.getComponents().find(a=>a.code===ce)==null&&(f=f.encapsulate(`/p2p/${e.remotePeer}`)),f=he(f.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(f.toString())}return o.reservation.addrs=[...c].map(d=>he(d).bytes),o.reservation}const l=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(l),new Error(l)}async#t(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[aa]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#r())}#r(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=mo(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}class wP extends Yy{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}}function cp(r){return new wP(r)}const _P=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(he)}catch{return!1}return!0},up={maxInboundStopStreams:sp,maxOutboundStopStreams:sp};class SP{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??up.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??up.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new dP(e,{filter:t.discoveryFilter??lP(YT,XT)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,s)})}),this.reservationStore=new vP(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[Er]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Fa](){return this.discovery!=null?["@libp2p/identify"]:[]}[Bm]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(np,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Lm(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Rm(this.discovery,this.reservationStore),await this.components.registrar.unhandle(np),this.started=!1}async dial(e,t){const n=e.toString().split("/p2p-circuit"),s=he(n[0]),i=he(n[n.length-1]),o=s.getComponents().find(h=>h.code===ce)?.value,l=i.getComponents().find(h=>h.code===ce)?.value;if(o==null||l==null){const h=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${h}`),new ma(`C${h}`)}const c=tp(o),d=tp(l);let a=this.components.connectionManager.getConnections(c)[0];a==null?(await this.components.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new nt("circuit-relay:open-connection")),a=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new nt("circuit-relay:reuse-connection"));let u;try{t.onProgress?.(new nt("circuit-relay:open-hop-stream")),u=await a.newStream(nl,t);const h=$n(u).pb(hi);t.onProgress?.(new nt("circuit-relay:write-connect-message")),await h.write({type:hi.Type.CONNECT,peer:{id:d.toMultihash().bytes,addrs:[he(i).bytes]}},t),t.onProgress?.(new nt("circuit-relay:read-connect-response"));const p=await h.read(t);if(p.status!==Bt.OK)throw new $e(`failed to connect via relay with status ${p?.status?.toString()??"undefined"}`);const y=new ap(p.limit),g=cp({stream:h.unwrap().unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:y.onData,onDataWrite:y.onData,log:u.log.newScope("circuit-relay:connection")}),m=await this.components.upgrader.upgradeOutbound(g,{...t,limits:y.getLimits()});return m.log("outbound relayed connection established to %p with limits %o, over connection %s",m.remotePeer,p.limit??"none",a.id),m}catch(h){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",d,c,h),u?.abort(h),h}}createListener(e){return hP({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Eb.exactMatch(t)||xb.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>fi.exactMatch(t))}async onStop(e,t){const n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(a){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",a)}const s=$n(e).pb(Gr),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:Gr.Type.STATUS,status:Bt.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(i.type!==Gr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Gr.Type.STATUS,status:Bt.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!_P(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Gr.Type.STATUS,status:Bt.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}const o=nf(fn(i.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:Gr.Type.STATUS,status:Bt.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:Gr.Type.STATUS,status:Bt.OK},{signal:n});const l=new ap(i.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),d=this.components.addressManager.getAddresses()[0],f=cp({stream:s.unwrap().unwrap(),remoteAddr:c,localAddr:d,onDataRead:l.onData,onDataWrite:l.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(f,{limits:l.getLimits(),signal:n}),f.log("inbound relayed connection established to %p with limits %o, over connection %s",o,i.limit??"none",t.id)}finally{n?.clear()}}}function EP(r={}){return e=>new SP(e,r)}var _c,dp;function xP(){if(dp)return _c;dp=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return _c=function(n,s,i){if(typeof s!="string")throw new Error("Input must be string");for(var o=s.length,l=0,c,d,f=0;f<o;f+=1){if(c=s.charCodeAt(f),d=s[f],r(c)&&e(s.charCodeAt(f+1))&&(f+=1,d+=s[f]),l+=n(d),l===i)return s.slice(0,f+1);if(l>i)return s.slice(0,f-d.length+1)}return s},_c}var Sc,fp;function AP(){if(fp)return Sc;fp=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return Sc=function(n){if(typeof n!="string")throw new Error("Input must be string");for(var s=n.length,i=0,o=null,l=null,c=0;c<s;c++)o=n.charCodeAt(c),e(o)?l!=null&&r(l)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),l=o;return i},Sc}var Ec,hp;function IP(){if(hp)return Ec;hp=1;var r=xP(),e=AP();return Ec=r.bind(null,e),Ec}var xc,pp;function kP(){if(pp)return xc;pp=1;var r=IP(),e=/[\/\?<>\\:\*\|"]/g,t=/[\x00-\x1f\x80-\x9f]/g,n=/^\.+$/,s=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=/[\. ]+$/;function o(l,c){if(typeof l!="string")throw new Error("Input must be string");var d=l.replace(e,c).replace(t,c).replace(n,c).replace(s,c).replace(i,c);return r(d,255)}return xc=function(l,c){var d=c&&c.replacement||"",f=o(l,d);return d===""?f:o(f,"")},xc}var CP=kP();const TP=od(CP),gp={keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"},Ac={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Ib(r){const e="AES-GCM";let t=16;const n=12,s="SHA-256",i=16,o=32767,l=Mt.get();t*=8;async function c(a,u){const h=l.getRandomValues(new Uint8Array(i)),p=l.getRandomValues(new Uint8Array(n)),y={name:e,iv:p};typeof u=="string"&&(u=j(u));let g;if(u.length===0){g=await l.subtle.importKey("jwk",Ac,{name:"AES-GCM"},!0,["encrypt"]);try{const w={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},v=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);g=await l.subtle.deriveKey(w,v,{name:e,length:t},!0,["encrypt"])}catch{g=await l.subtle.importKey("jwk",Ac,{name:"AES-GCM"},!0,["encrypt"])}}else{const w={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},v=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);g=await l.subtle.deriveKey(w,v,{name:e,length:t},!0,["encrypt"])}const m=await l.subtle.encrypt(y,g,a);return an([h,y.iv,new Uint8Array(m)])}async function d(a,u){const h=a.subarray(0,i),p=a.subarray(i,i+n),y=a.subarray(i+n),g={name:e,iv:p};typeof u=="string"&&(u=j(u));let m;if(u.length===0)try{const v={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},_=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);m=await l.subtle.deriveKey(v,_,{name:e,length:t},!0,["decrypt"])}catch{m=await l.subtle.importKey("jwk",Ac,{name:"AES-GCM"},!0,["decrypt"])}else{const v={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},_=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);m=await l.subtle.deriveKey(v,_,{name:e,length:t},!0,["decrypt"])}const w=await l.subtle.decrypt(g,m,y);return new Uint8Array(w)}return{encrypt:c,decrypt:d}}const PP="[object ArrayBuffer]";class Be{static isArrayBuffer(e){return Object.prototype.toString.call(e)===PP}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=Be.toUint8Array(e),s=Be.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const s=new Uint8Array(n);let i=0;for(const o of t){const l=this.toUint8Array(o);s.set(l,i),i+=l.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Ic="string",DP=/^[0-9a-f\s]+$/i,LP=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,RP=/^[a-zA-Z0-9-_]+$/;class mp{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){const t=Be.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}}class kr{static toString(e,t=!1){const n=Be.toArrayBuffer(e),s=new DataView(n);let i="";for(let o=0;o<n.byteLength;o+=2){const l=s.getUint16(o,t);i+=String.fromCharCode(l)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return n}}class Ye{static isHex(e){return typeof e===Ic&&DP.test(e)}static isBase64(e){return typeof e===Ic&&LP.test(e)}static isBase64Url(e){return typeof e===Ic&&RP.test(e)}static ToString(e,t="utf8"){const n=Be.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return kr.toString(n,!0);case"utf16":case"utf16be":return kr.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return kr.fromString(e,!0);case"utf16":case"utf16be":return kr.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=Be.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=Ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return mp.fromString(e);case"utf16":case"utf16be":return kr.fromString(e);case"utf16le":case"usc2":return kr.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=Ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return mp.toString(e);case"utf16":case"utf16be":return kr.toString(e);case"utf16le":case"usc2":return kr.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){const t=Be.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){const t=Be.toUint8Array(e);let n="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);n[s/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return kr.toString(e,t)}static FromUtf16String(e,t=!1){return kr.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}Ye.DEFAULT_UTF8_ENCODING="utf8";function mi(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Ss(r,e,t=-1){const n=t;let s=r,i=0,o=Math.pow(2,e);for(let l=1;l<8;l++){if(r<o){let c;if(n<0)c=new ArrayBuffer(l),i=l;else{if(n<l)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}const d=new Uint8Array(c);for(let f=l-1;f>=0;f--){const a=Math.pow(2,f*e);d[i-f-1]=Math.floor(s/a),s-=d[i-f-1]*a}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function Bu(...r){let e=0,t=0;for(const i of r)e+=i.length;const n=new ArrayBuffer(e),s=new Uint8Array(n);for(const i of r)s.set(i,t),t+=i.length;return s}function kb(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const l=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(l||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let l=0;l<this.valueHex.byteLength;l++)t[l]=0;t[0]=r[0]&128;const n=mi(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let l=0;l<this.valueHex.byteLength;l++)i[l]=r[l];return i[0]&=127,mi(i,8)-n}function BP(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,l=Ss(o,8,n),c=new Uint8Array(l);return c[0]|=128,l}let s=Ss(e,8,n),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),l=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=l[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function NP(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function jt(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,s=new Array(n);for(let o=0;o<n;o++)s[o]="0";return s.join("").concat(t)}function al(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function af(r){let e=0,t=0;for(let s=0;s<r.length;s++){const i=r[s];e+=i.byteLength}const n=new Uint8Array(e);for(let s=0;s<r.length;s++){const i=r[s];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function pn(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class lf{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return af(this.items)}}const Bi=[new Uint8Array([1])],yp="0123456789",Ai="",Ur=new ArrayBuffer(0),cf=new Uint8Array(0),So="EndOfContent",Cb="OCTET STRING",Tb="BIT STRING";function gn(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);const i=n[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?Be.toUint8Array(i.valueHex):cf}fromBER(n,s,i){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!pn(this,o,s,i))return-1;const l=s+i;return this.valueHexView=o.subarray(s,l),this.valueHexView.length?(this.blockLength=i,l):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Ur)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Ye.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Cs{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Ai,warnings:n=[],valueBeforeDecode:s=cf}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Be.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Ye.ToHex(this.valueBeforeDecodeView)}}}Cs.NAME="baseBlock";class Gt extends Cs{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Gt.NAME="valueBlock";class Pb extends gn(Cs){constructor({idBlock:e={}}={}){var t,n,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Be.toUint8Array(e.valueHex):cf,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Ur}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=Ss(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,l=new Uint8Array(o+1);if(l[0]=t|31,!e){for(let c=0;c<o-1;c++)l[c+1]=i[c]|128;l[o]=i[o-1]}return l.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)n[i+1]=s[i]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!pn(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const l=i[0]&31;if(l!==31)this.tagNumber=l,this.blockLength=1;else{let c=1,d=this.valueHexView=new Uint8Array(255),f=255;for(;i[c]&128;){if(d[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===f){f+=255;const u=new Uint8Array(f);for(let h=0;h<d.length;h++)u[h]=d[h];d=this.valueHexView=new Uint8Array(f)}}this.blockLength=c+1,d[c-1]=i[c]&127;const a=new Uint8Array(c);for(let u=0;u<c;u++)a[u]=d[u];d=this.valueHexView=new Uint8Array(c),d.set(a),this.blockLength<=9?this.tagNumber=mi(d,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}Pb.NAME="identificationBlock";class Db extends Cs{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!pn(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const l=t+1,c=s.subarray(l,l+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=mi(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const s=Ss(this.length,8);if(s.byteLength>127)return this.error="Too big length",Ur;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)n[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}Db.NAME="lengthBlock";const Z={};class $t extends Cs{constructor({name:e=Ai,optional:t=!1,primitiveSchema:n,...s}={},i){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new Pb(s),this.lenBlock=new Db(s),this.valueBlock=i?new i(s):new Gt(s)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const n=t||new lf;t||Lb(this);const s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(i)}return t?Ur:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Ye.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=Ye.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return NP(t,n)}}$t.NAME="BaseBlock";function Lb(r){var e;if(r instanceof Z.Constructed)for(const t of r.valueBlock.value)Lb(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class Rb extends $t{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Ai,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}Rb.NAME="BaseStringBlock";class Bb extends gn(Gt){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}Bb.NAME="PrimitiveValueBlock";var Nb;class Mb extends $t{constructor(e={}){super(e,Bb),this.idBlock.isConstructed=!1}}Nb=Mb;Z.Primitive=Nb;Mb.NAME="PRIMITIVE";function MP(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function jl(r,e=0,t=r.length){const n=e;let s=new $t({},Gt);const i=new Cs;if(!pn(i,r,e,t))return s.error=i.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let l=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),l===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=l,t-=s.idBlock.blockLength,l=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),l===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=l,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=$t;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=Z.EndOfContent;break;case 1:c=Z.Boolean;break;case 2:c=Z.Integer;break;case 3:c=Z.BitString;break;case 4:c=Z.OctetString;break;case 5:c=Z.Null;break;case 6:c=Z.ObjectIdentifier;break;case 10:c=Z.Enumerated;break;case 12:c=Z.Utf8String;break;case 13:c=Z.RelativeObjectIdentifier;break;case 14:c=Z.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=Z.Sequence;break;case 17:c=Z.Set;break;case 18:c=Z.NumericString;break;case 19:c=Z.PrintableString;break;case 20:c=Z.TeletexString;break;case 21:c=Z.VideotexString;break;case 22:c=Z.IA5String;break;case 23:c=Z.UTCTime;break;case 24:c=Z.GeneralizedTime;break;case 25:c=Z.GraphicString;break;case 26:c=Z.VisibleString;break;case 27:c=Z.GeneralString;break;case 28:c=Z.UniversalString;break;case 29:c=Z.CharacterString;break;case 30:c=Z.BmpString;break;case 31:c=Z.DATE;break;case 32:c=Z.TimeOfDay;break;case 33:c=Z.DateTime;break;case 34:c=Z.Duration;break;default:{const d=s.idBlock.isConstructed?new Z.Constructed:new Z.Primitive;d.idBlock=s.idBlock,d.lenBlock=s.lenBlock,d.warnings=s.warnings,s=d}}break;default:c=s.idBlock.isConstructed?Z.Constructed:Z.Primitive}return s=MP(s,c),l=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:l,result:s}}function kc(r){if(!r.byteLength){const e=new $t({},Gt);return e.error="Input buffer has zero length",{offset:-1,result:e}}return jl(Be.toUint8Array(r).slice(),0,r.byteLength)}function OP(r,e){return r?1:e}class Nn extends Gt{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!pn(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;OP(this.isIndefiniteForm,n)>0;){const o=jl(s,i,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===So)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===So?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new lf;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?Ur:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Nn.NAME="ConstructedValueBlock";var Ob;class Ii extends $t{constructor(e={}){super(e,Nn),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}Ob=Ii;Z.Constructed=Ob;Ii.NAME="CONSTRUCTED";class $b extends Gt{fromBER(e,t,n){return t}toBER(e){return Ur}}$b.override="EndOfContentValueBlock";var Fb;class Ub extends $t{constructor(e={}){super(e,$b),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}Fb=Ub;Z.EndOfContent=Fb;Ub.NAME=So;var Vb;class ll extends $t{constructor(e={}){super(e,Gt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}Vb=ll;Z.Null=Vb;ll.NAME="NULL";class Kb extends gn(Gt){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Be.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const s=Be.toUint8Array(e);return pn(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,kb.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}Kb.NAME="BooleanValueBlock";var qb;let Hb=class extends $t{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,Kb),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};qb=Hb;Z.Boolean=qb;Hb.NAME="BOOLEAN";class zb extends gn(Nn){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Nn.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===So){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==Cb)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?Nn.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}zb.NAME="OctetStringValueBlock";var uf;class qs extends $t{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},zb),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){const o=jl(i,0,i.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Ii.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=Ye.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof uf&&e.push(t.valueBlock.valueHexView);return Be.concat(e)}}uf=qs;Z.OctetString=uf;qs.NAME=Cb;class Wb extends gn(Nn){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=Nn.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(const l of this.value){const c=l.constructor.NAME;if(c===So){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==Tb)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const d=l.valueBlock;if(this.unusedBits>0&&d.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=d.unusedBits}return s}const i=Be.toUint8Array(e);if(!pn(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const l=o.subarray(1);try{if(l.byteLength){const c=jl(l,0,l.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return Nn.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength){const s=new Uint8Array(1);return s[0]=0,s.buffer}const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}Wb.NAME="BitStringValueBlock";var Gb;class Yb extends $t{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},Wb),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Ii.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),s=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}}Gb=Yb;Z.BitString=Gb;Yb.NAME=Tb;var Xb;function $P(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e);let i=n.slice(0);const o=i.length-1,l=s.slice(0),c=l.length-1;let d=0;const f=c<o?o:c;let a=0;for(let u=f;u>=0;u--,a++)!0===a<l.length?d=i[o-a]+l[c-a]+t[0]:d=i[o-a]+t[0],t[0]=d/10,!0===a>=i.length?i=Bu(new Uint8Array([d%10]),i):i[o-a]=d%10;return t[0]>0&&(i=Bu(t,i)),i}function bp(r){if(r>=Bi.length)for(let e=Bi.length;e<=r;e++){const t=new Uint8Array([0]);let n=Bi[e-1].slice(0);for(let s=n.length-1;s>=0;s--){const i=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=i[0]/10,n[s]=i[0]%10}t[0]>0&&(n=Bu(t,n)),Bi.push(n)}return Bi[r]}function FP(r,e){let t=0;const n=new Uint8Array(r),s=new Uint8Array(e),i=n.slice(0),o=i.length-1,l=s.slice(0),c=l.length-1;let d,f=0;for(let a=c;a>=0;a--,f++)d=i[o-f]-l[c-f]-t,!0===d<0?(t=1,i[o-f]=d+10):(t=0,i[o-f]=d);if(t>0)for(let a=o-c+1;a>=0;a--,f++)if(d=i[o-f]-t,d<0)t=1,i[o-f]=d+10;else{t=0,i[o-f]=d;break}return i.slice()}class df extends gn(Gt){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=kb.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(BP(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){const i=this.fromBER(e,t,n);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,s;const i=this.valueHexView;let o="",l=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let d=0;d<8;d++)(s&1)===1&&(n===e?(t=FP(bp(n),t),o="-"):t=$P(t,bp(n))),n++,s>>=1}for(let c=0;c<t.length;c++)t[c]&&(l=!0),l&&(o+=yp.charAt(t[c]));return l===!1&&(o+=yp.charAt(0)),o}}Xb=df;df.NAME="IntegerValueBlock";Object.defineProperty(Xb.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Ji;class js extends $t{constructor(e={}){super(e,df),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return al(),BigInt(this.valueBlock.toString())}static fromBigInt(e){al();const t=BigInt(e),n=new lf,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(Ye.FromHex(s));if(t<0){const l=new Uint8Array(i.length+(i[0]&128?1:0));l[0]|=128;const d=BigInt(`0x${Ye.ToHex(l)}`)+t,f=Be.toUint8Array(Ye.FromHex(d.toString(16)));f[0]|=128,n.write(f)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new Ji({valueHex:n.final()})}convertToDER(){const e=new Ji({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new Ji({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}Ji=js;Z.Integer=Ji;js.NAME="INTEGER";var Zb;class jb extends js{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Zb=jb;Z.Enumerated=Zb;jb.NAME="ENUMERATED";class Nu extends gn(Gt){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const s=Be.toUint8Array(e);if(!pn(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let l=0;l<n&&(this.valueHexView[l]=i[l]&127,this.blockLength++,(i[l]&128)!==0);l++);const o=new Uint8Array(this.blockLength);for(let l=0;l<this.blockLength;l++)o[l]=this.valueHexView[l];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=mi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){al();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Ss(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Ur;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n}toString(){let e="";if(this.isHexOnly)e=Ye.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Nu.NAME="sidBlock";class Qb extends Gt{constructor({value:e=Ai,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new Nu;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,Ur;t.push(s)}return af(t)}fromString(e){this.value=[];let t=0,n=0,s="",i=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,i){const o=this.value[0];let l=0;switch(o.valueDec){case 0:break;case 1:l=40;break;case 2:l=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+l,i=!1}else{const o=new Nu;if(s>Number.MAX_SAFE_INTEGER){al();const l=BigInt(s);o.valueBigInt=l}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}Qb.NAME="ObjectIdentifierValueBlock";var Jb;class Zn extends $t{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,Qb),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Jb=Zn;Z.ObjectIdentifier=Jb;Zn.NAME="OBJECT IDENTIFIER";class Mu extends gn(Cs){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const s=Be.toUint8Array(e);if(!pn(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let l=0;l<n&&(this.valueHexView[l]=i[l]&127,this.blockLength++,(i[l]&128)!==0);l++);const o=new Uint8Array(this.blockLength);for(let l=0;l<this.blockLength;l++)o[l]=this.valueHexView[l];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=mi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Ss(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Ur;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Ye.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Mu.NAME="relativeSidBlock";class ev extends Gt{constructor({value:e=Ai,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new Mu;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const n=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,Ur;n.push(i)}return af(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;const i=new Mu;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}ev.NAME="RelativeObjectIdentifierValueBlock";var tv;class rv extends $t{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,ev),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}tv=rv;Z.RelativeObjectIdentifier=tv;rv.NAME="RelativeObjectIdentifier";var nv;class br extends Ii{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}nv=br;Z.Sequence=nv;br.NAME="SEQUENCE";var sv;let iv=class extends Ii{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};sv=iv;Z.Set=sv;iv.NAME="SET";class ov extends gn(Gt){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Ai}toJSON(){return{...super.toJSON(),value:this.value}}}ov.NAME="StringValueBlock";class av extends ov{}av.NAME="SimpleStringValueBlock";class rr extends Rb{constructor({...e}={}){super(e,av)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Be.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}}rr.NAME="SIMPLE STRING";class lv extends rr{fromBuffer(e){this.valueBlock.valueHexView=Be.toUint8Array(e);try{this.valueBlock.value=Ye.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Ye.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Ye.FromUtf8String(e)),this.valueBlock.value=e}}lv.NAME="Utf8StringValueBlock";var cv;class Ts extends lv{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}cv=Ts;Z.Utf8String=cv;Ts.NAME="UTF8String";class uv extends rr{fromBuffer(e){this.valueBlock.value=Ye.ToUtf16String(e),this.valueBlock.valueHexView=Be.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Ye.FromUtf16String(e))}}uv.NAME="BmpStringValueBlock";var dv;class fv extends uv{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}dv=fv;Z.BmpString=dv;fv.NAME="BMPString";class hv extends rr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=Ss(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const l=4-o.length;for(let c=o.length-1;c>=0;c--)n[s*4+c+l]=o[c]}this.valueBlock.value=e}}hv.NAME="UniversalStringValueBlock";var pv;class gv extends hv{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}pv=gv;Z.UniversalString=pv;gv.NAME="UniversalString";var mv;class yv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}mv=yv;Z.NumericString=mv;yv.NAME="NumericString";var bv;class vv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}bv=vv;Z.PrintableString=bv;vv.NAME="PrintableString";var wv;class _v extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}wv=_v;Z.TeletexString=wv;_v.NAME="TeletexString";var Sv;class Ev extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}Sv=Ev;Z.VideotexString=Sv;Ev.NAME="VideotexString";var xv;class Av extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}xv=Av;Z.IA5String=xv;Av.NAME="IA5String";var Iv;class kv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}Iv=kv;Z.GraphicString=Iv;kv.NAME="GraphicString";var Cv;class ff extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Cv=ff;Z.VisibleString=Cv;ff.NAME="VisibleString";var Tv;class Pv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}Tv=Pv;Z.GeneralString=Tv;Pv.NAME="GeneralString";var Dv;class Lv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}Dv=Lv;Z.CharacterString=Dv;Lv.NAME="CharacterString";var Rv;class hf extends ff{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Be.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=jt(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=jt(this.month,2),t[2]=jt(this.day,2),t[3]=jt(this.hour,2),t[4]=jt(this.minute,2),t[5]=jt(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}Rv=hf;Z.UTCTime=Rv;hf.NAME="UTCTime";var Bv;class Nv extends hf{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",i=0,o,l=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const a=new Number(e[e.length-1]);if(isNaN(a.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let a=1,u=n.indexOf("+"),h="";if(u===-1&&(u=n.indexOf("-"),a=-1),u!==-1){if(h=n.substring(u+1),n=n.substring(0,u),h.length!==2&&h.length!==4)throw new Error("Wrong input string for conversion");let p=parseInt(h.substring(0,2),10);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");if(l=a*p,h.length===4){if(p=parseInt(h.substring(2,4),10),isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");c=a*p}}}let d=n.indexOf(".");if(d===-1&&(d=n.indexOf(",")),d!==-1){const a=new Number(`0${n.substring(d)}`);if(isNaN(a.valueOf()))throw new Error("Wrong input string for conversion");i=a.valueOf(),s=n.substring(0,d)}else s=n;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,d!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,d!==-1){let a=60*i;this.minute=Math.floor(a),a=60*(a-this.minute),this.second=Math.floor(a),a=1e3*(a-this.second),this.millisecond=Math.floor(a)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,d!==-1){let a=60*i;this.second=Math.floor(a),a=1e3*(a-this.second),this.millisecond=Math.floor(a)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,d!==-1){const a=1e3*i;this.millisecond=Math.floor(a)}break;default:throw new Error("Wrong input string for conversion")}const f=o.exec(s);if(f===null)throw new Error("Wrong input string for conversion");for(let a=1;a<f.length;a++)switch(a){case 1:this.year=parseInt(f[a],10);break;case 2:this.month=parseInt(f[a],10);break;case 3:this.day=parseInt(f[a],10);break;case 4:this.hour=parseInt(f[a],10)+l;break;case 5:this.minute=parseInt(f[a],10)+c;break;case 6:this.second=parseInt(f[a],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const a=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=a.getUTCFullYear(),this.month=a.getUTCMonth(),this.day=a.getUTCDay(),this.hour=a.getUTCHours(),this.minute=a.getUTCMinutes(),this.second=a.getUTCSeconds(),this.millisecond=a.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(jt(this.year,4)),t.push(jt(this.month,2)),t.push(jt(this.day,2)),t.push(jt(this.hour,2)),t.push(jt(this.minute,2)),t.push(jt(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(jt(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}Bv=Nv;Z.GeneralizedTime=Bv;Nv.NAME="GeneralizedTime";var Mv;class Ov extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}Mv=Ov;Z.DATE=Mv;Ov.NAME="DATE";var $v;class Fv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}$v=Fv;Z.TimeOfDay=$v;Fv.NAME="TimeOfDay";var Uv;class Vv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}Uv=Vv;Z.DateTime=Uv;Vv.NAME="DateTime";var Kv;class qv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}Kv=qv;Z.Duration=Kv;qv.NAME="Duration";var Hv;class zv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}Hv=zv;Z.TIME=Hv;zv.NAME="TIME";const UP=16,Ou=32,$u=1e4;async function Ql(r,e){const n=await Ib().encrypt(r,e);return Po.encode(n)}async function vp(r,e,t){if(r.type==="RSA")return HP(r,e,t);if(r.type==="Ed25519")return VP(r,e,t);if(r.type==="secp256k1")return KP(r,e,t);if(r.type==="ECDSA")return qP(r,e,t);throw new Ar}async function VP(r,e,t="libp2p-key"){if(t==="libp2p-key")return Ql(qo(r),e);throw new V(`export format '${t}' is not supported`)}async function KP(r,e,t="libp2p-key"){if(t==="libp2p-key")return Ql(qo(r),e);throw new V("Export format is not supported")}async function qP(r,e,t="libp2p-key"){if(t==="libp2p-key")return Ql(qo(r),e);throw new V(`export format '${t}' is not supported`)}async function HP(r,e,t="pkcs-8"){if(t==="pkcs-8")return zP(r,e);if(t==="libp2p-key")return Ql(qo(r),e);throw new V("Export format is not supported")}async function zP(r,e){const t=Mt.get(),s=new br({value:[new js({value:0}),new br({value:[new Zn({value:"1.2.840.113549.1.1.1"}),new ll]}),new qs({valueHex:r.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=li(UP),l=await Ny(Vl,e,o,{c:$u,dkLen:Ou}),c=li(16),d=await t.subtle.importKey("raw",l,"AES-CBC",!1,["encrypt"]),f=await t.subtle.encrypt({name:"AES-CBC",iv:c},d,i),a=new br({value:[new qs({valueHex:o}),new js({value:$u}),new js({value:Ou}),new br({value:[new Zn({value:"1.2.840.113549.2.11"}),new ll]})]}),u=new br({value:[new Zn({value:"1.2.840.113549.1.5.13"}),new br({value:[new br({value:[new Zn({value:"1.2.840.113549.1.5.12"}),a]}),new br({value:[new Zn({value:"2.16.840.1.101.3.4.1.42"}),new qs({valueHex:c})]})]})]}),p=new br({value:[u,new qs({valueHex:f})]}).toBER(),y=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...W(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function wp(r,e){try{const t=await WP(r,e);return BI(t)}catch{}if(!r.includes("BEGIN"))throw new V("Encrypted key was not a libp2p-key or a PEM file");return GP(r,e)}async function WP(r,e){const t=Po.decode(r);return Ib().decrypt(t,e)}async function GP(r,e){const t=Mt.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=j(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=kc(i),{iv:l,salt:c,iterations:d,keySize:f,cipherText:a}=YP(o),u=await Ny(Vl,e,c,{c:d,dkLen:f}),h=await t.subtle.importKey("raw",u,"AES-CBC",!1,["decrypt"]),p=eo(await t.subtle.decrypt({name:"AES-CBC",iv:l},h,a)),{result:y}=kc(p);n=_p(y)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const i=j(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=kc(i);n=_p(o)}else throw new V("Could not parse private key from PEM data");const s=NI(n);if(s.type!=="RSA")throw new V("Could not parse RSA private key from PEM data");return s}function YP(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new V("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new V("Only pkcs5PBKDF2 key derivation functions are supported");const i=n.valueBlock.value[1],o=eo(i.valueBlock.value[0].getValue());let l=$u,c=Ou;if(i.valueBlock.value.length===3)l=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new V("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const d=e.valueBlock.value[1].valueBlock.value[1],f=d.valueBlock.value[0].toString();if(f!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(f!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new V("Only AES-CBC encryption schemes are supported")}}}}const a=eo(d.valueBlock.value[1].getValue());return{cipherText:eo(r.valueBlock.value[1].getValue()),salt:o,iterations:l,keySize:c,iv:a}}function _p(r){return eo(r.valueBlock.value[2].getValue())}function eo(r){return new Uint8Array(r,0,r.byteLength)}const XP="/pkcs8/",Fu="/info/",Ni=new WeakMap,Gn={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function Ms(r){return r==null||typeof r!="string"?!1:r===TP(r.trim())&&r.length>0}async function gt(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Yn(r){return new je(XP+r)}function Os(r){return new je(Fu+r)}async function ZP(r){const e=qo(r),t=await pr.digest(e);return Pe.encode(t.bytes).substring(1)}class jP{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...gp,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Gn.minKeyLength)throw new Error(`dek.keyLength must be least ${Gn.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Gn.minSaltLength)throw new Error(`dek.saltLength must be least ${Gn.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Gn.minIterationCount)throw new Error(`dek.iterationCount must be least ${Gn.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?Mh(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Ni.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[Er]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},this.options),t=Math.ceil(Gn.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=W(li(t),"base64")),e}static get options(){return{dek:{...gp}}}async findKeyByName(e){if(!Ms(e))throw await gt(),new V(`Invalid key name '${e}'`);const t=Os(e);try{const n=await this.components.datastore.get(t);return JSON.parse(W(n))}catch(n){throw await gt(),this.log.error("could not read key from datastore - %e",n),new Ma(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:Fu};for await(const n of this.components.datastore.query(t)){const s=JSON.parse(W(n.value));if(s.id===e)return s}throw new V(`Key with id '${e}' does not exist.`)}catch(t){throw await gt(),t}}async importKey(e,t){if(!Ms(e))throw await gt(),new V(`Invalid key name '${e}'`);if(t==null)throw await gt(),new V("Key is required");const n=Yn(e);if(await this.components.datastore.has(n))throw await gt(),new V(`Key '${e}' already exists`);let i,o;try{i=await ZP(t);const d=Ni.get(this);if(d==null)throw new V("dek missing");const f=d.dek;o=await vp(t,f,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(d){throw await gt(),d}const l={name:e,id:i},c=this.components.datastore.batch();return c.put(n,j(o)),c.put(Os(e),j(JSON.stringify(l))),await c.commit(),l}async exportKey(e){if(!Ms(e))throw await gt(),new V(`Invalid key name '${e}'`);const t=Yn(e);try{const n=await this.components.datastore.get(t),s=W(n),i=Ni.get(this);if(i==null)throw new V("dek missing");const o=i.dek;return await wp(s,o)}catch(n){throw await gt(),n}}async removeKey(e){if(!Ms(e)||e===this.self)throw await gt(),new V(`Invalid key name '${e}'`);const t=Yn(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Os(e)),await s.commit(),n}async listKeys(){const e={prefix:Fu},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(W(n.value)));return t}async renameKey(e,t){if(!Ms(e)||e===this.self)throw await gt(),new V(`Invalid old key name '${e}'`);if(!Ms(t)||t===this.self)throw await gt(),new V(`Invalid new key name '${t}'`);const n=Yn(e),s=Yn(t),i=Os(e),o=Os(t);if(await this.components.datastore.has(s))throw await gt(),new V(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),d=await this.components.datastore.get(i),f=JSON.parse(W(d));f.name=t;const a=this.components.datastore.batch();return a.put(s,c),a.put(o,j(JSON.stringify(f))),a.delete(n),a.delete(i),await a.commit(),f}catch(c){throw await gt(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await gt(),new V(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await gt(),new V(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await gt(),new V(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=Ni.get(this);if(n==null)throw new V("dek missing");const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?Mh(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Ni.set(this,{dek:i});const o=await this.listKeys();for(const l of o){const c=await this.components.datastore.get(Yn(l.name)),d=W(c),f=await wp(d,s),a=i.toString(),u=await vp(f,a,f.type==="RSA"?"pkcs-8":"libp2p-key"),h=this.components.datastore.batch(),p={name:l.name,id:l.id};h.put(Yn(l.name),j(u)),h.put(Os(l.name),j(JSON.stringify(p))),await h.commit()}this.log("keychain reconstructed")}}function Wv(r={}){return e=>new jP(e,r)}async function QP(r,e={}){const t=e.selfKey??"self",n=Wv(e)({datastore:r,logger:ld()});let s;return await r.has(new je(`/pkcs8/${t}`))?s=await n.exportKey(t):(s=await Ly(e.keyType??"Ed25519"),await n.importKey(t,s)),s}const JP=Symbol.for("@libp2p/pubsub");var Cc={exports:{}},Sp;function eD(){return Sp||(Sp=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,d,f){this.fn=c,this.context=d,this.once=f||!1}function i(c,d,f,a,u){if(typeof f!="function")throw new TypeError("The listener must be a function");var h=new s(f,a||c,u),p=t?t+d:d;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],h]:c._events[p].push(h):(c._events[p]=h,c._eventsCount++),c}function o(c,d){--c._eventsCount===0?c._events=new n:delete c._events[d]}function l(){this._events=new n,this._eventsCount=0}l.prototype.eventNames=function(){var d=[],f,a;if(this._eventsCount===0)return d;for(a in f=this._events)e.call(f,a)&&d.push(t?a.slice(1):a);return Object.getOwnPropertySymbols?d.concat(Object.getOwnPropertySymbols(f)):d},l.prototype.listeners=function(d){var f=t?t+d:d,a=this._events[f];if(!a)return[];if(a.fn)return[a.fn];for(var u=0,h=a.length,p=new Array(h);u<h;u++)p[u]=a[u].fn;return p},l.prototype.listenerCount=function(d){var f=t?t+d:d,a=this._events[f];return a?a.fn?1:a.length:0},l.prototype.emit=function(d,f,a,u,h,p){var y=t?t+d:d;if(!this._events[y])return!1;var g=this._events[y],m=arguments.length,w,v;if(g.fn){switch(g.once&&this.removeListener(d,g.fn,void 0,!0),m){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,f),!0;case 3:return g.fn.call(g.context,f,a),!0;case 4:return g.fn.call(g.context,f,a,u),!0;case 5:return g.fn.call(g.context,f,a,u,h),!0;case 6:return g.fn.call(g.context,f,a,u,h,p),!0}for(v=1,w=new Array(m-1);v<m;v++)w[v-1]=arguments[v];g.fn.apply(g.context,w)}else{var _=g.length,k;for(v=0;v<_;v++)switch(g[v].once&&this.removeListener(d,g[v].fn,void 0,!0),m){case 1:g[v].fn.call(g[v].context);break;case 2:g[v].fn.call(g[v].context,f);break;case 3:g[v].fn.call(g[v].context,f,a);break;case 4:g[v].fn.call(g[v].context,f,a,u);break;default:if(!w)for(k=1,w=new Array(m-1);k<m;k++)w[k-1]=arguments[k];g[v].fn.apply(g[v].context,w)}}return!0},l.prototype.on=function(d,f,a){return i(this,d,f,a,!1)},l.prototype.once=function(d,f,a){return i(this,d,f,a,!0)},l.prototype.removeListener=function(d,f,a,u){var h=t?t+d:d;if(!this._events[h])return this;if(!f)return o(this,h),this;var p=this._events[h];if(p.fn)p.fn===f&&(!u||p.once)&&(!a||p.context===a)&&o(this,h);else{for(var y=0,g=[],m=p.length;y<m;y++)(p[y].fn!==f||u&&!p[y].once||a&&p[y].context!==a)&&g.push(p[y]);g.length?this._events[h]=g.length===1?g[0]:g:o(this,h)}return this},l.prototype.removeAllListeners=function(d){var f;return d?(f=t?t+d:d,this._events[f]&&o(this,f)):(this._events=new n,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=t,l.EventEmitter=l,r.exports=l})(Cc)),Cc.exports}var tD=eD();const rD=od(tD);class pf extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,pf)}}const Ep=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function nD(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout},signal:o}=e;let l,c;const f=new Promise((a,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(o?.aborted){u(Ep(o));return}if(o&&(c=()=>{u(Ep(o))},o.addEventListener("abort",c,{once:!0})),r.then(a,u),t===Number.POSITIVE_INFINITY)return;const h=new pf;l=i.setTimeout.call(void 0,()=>{if(n){try{a(n())}catch(p){u(p)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?a():s instanceof Error?u(s):(h.message=s??`Promise timed out after ${t} milliseconds`,u(h))},t)}).finally(()=>{f.clear(),c&&o&&o.removeEventListener("abort",c)});return f.clear=()=>{i.clearTimeout.call(void 0,l),l=void 0},f}function sD(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}class iD{#e=[];enqueue(e,t){const{priority:n=0,id:s}=t??{},i={priority:n,id:s,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(i);return}const o=sD(this.#e,i,(l,c)=>c.priority-l.priority);this.#e.splice(o,0,i)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}}class Gv extends rD{#e;#t;#r=0;#n;#o=!1;#a=!1;#s;#l=0;#f=0;#c;#g;#h;#u=[];#d=0;#i;#E;#p=0;#w;#m;#_=1n;#y=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:iD,strict:!1,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(e.strict&&e.interval===0)throw new TypeError("The `strict` option requires a non-zero `interval`");if(e.strict&&e.intervalCap===Number.POSITIVE_INFINITY)throw new TypeError("The `strict` option requires a finite `intervalCap`");if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#t=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#n=e.intervalCap,this.#s=e.interval,this.#h=e.strict,this.#i=new e.queueClass,this.#E=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#m=e.autoStart===!1,this.#U()}#b(e){for(;this.#d<this.#u.length;){const n=this.#u[this.#d];if(n!==void 0&&e-n>=this.#s)this.#d++;else break}(this.#d>100&&this.#d>this.#u.length/2||this.#d===this.#u.length)&&(this.#u=this.#u.slice(this.#d),this.#d=0)}#R(e){this.#h?this.#u.push(e):this.#r++}#B(){this.#h?this.#u.length>this.#d&&this.#u.pop():this.#r>0&&this.#r--}#x(){return this.#u.length-this.#d}get#N(){return this.#t?!0:this.#h?this.#x()<this.#n:this.#r<this.#n}get#M(){return this.#p<this.#w}#O(){this.#p--,this.#p===0&&this.emit("pendingZero"),this.#k(),this.emit("next")}#$(){this.#g=void 0,this.#D(),this.#P()}#F(e){if(this.#h){if(this.#b(e),this.#x()>=this.#n){const n=this.#u[this.#d],s=this.#s-(e-n);return this.#A(s),!0}return!1}if(this.#c===void 0){const t=this.#l-e;if(t<0){if(this.#f>0){const n=e-this.#f;if(n<this.#s)return this.#A(this.#s-n),!0}this.#r=this.#e?this.#p:0}else return this.#A(t),!0}return!1}#A(e){this.#g===void 0&&(this.#g=setTimeout(()=>{this.#$()},e))}#I(){this.#c&&(clearInterval(this.#c),this.#c=void 0)}#T(){this.#g&&(clearTimeout(this.#g),this.#g=void 0)}#k(){if(this.#i.size===0){if(this.#I(),this.emit("empty"),this.#p===0){if(this.#T(),this.#h&&this.#d>0){const t=Date.now();this.#b(t)}this.emit("idle")}return!1}let e=!1;if(!this.#m){const t=Date.now(),n=!this.#F(t);if(this.#N&&this.#M){const s=this.#i.dequeue();this.#t||(this.#R(t),this.#S()),this.emit("active"),s(),n&&this.#P(),e=!0}}return e}#P(){this.#t||this.#c!==void 0||this.#h||(this.#c=setInterval(()=>{this.#D()},this.#s),this.#l=Date.now()+this.#s)}#D(){this.#h||(this.#r===0&&this.#p===0&&this.#c&&this.#I(),this.#r=this.#e?this.#p:0),this.#C(),this.#S()}#C(){for(;this.#k(););}get concurrency(){return this.#w}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#w=e,this.#C()}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#i.setPriority(e,t)}async add(e,t={}){return t={timeout:this.timeout,...t,id:t.id??(this.#_++).toString()},new Promise((n,s)=>{const i=Symbol(`task-${t.id}`);this.#i.enqueue(async()=>{this.#p++,this.#y.set(i,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});let o;try{try{t.signal?.throwIfAborted()}catch(d){throw this.#V(),this.#y.delete(i),d}this.#f=Date.now();let l=e({signal:t.signal});if(t.timeout&&(l=nD(Promise.resolve(l),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#p} running, ${this.#i.size} waiting)`})),t.signal){const{signal:d}=t;l=Promise.race([l,new Promise((f,a)=>{o=()=>{a(d.reason)},d.addEventListener("abort",o,{once:!0})})])}const c=await l;n(c),this.emit("completed",c)}catch(l){s(l),this.emit("error",l)}finally{o&&t.signal?.removeEventListener("abort",o),this.#y.delete(i),queueMicrotask(()=>{this.#O()})}},t),this.emit("add"),this.#k()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#m?(this.#m=!1,this.#C(),this):this}pause(){this.#m=!0}clear(){this.#i=new this.#E,this.#I(),this.#L(),this.emit("empty"),this.#p===0&&(this.#T(),this.emit("idle")),this.emit("next")}async onEmpty(){this.#i.size!==0&&await this.#v("empty")}async onSizeLessThan(e){this.#i.size<e||await this.#v("next",()=>this.#i.size<e)}async onIdle(){this.#p===0&&this.#i.size===0||await this.#v("idle")}async onPendingZero(){this.#p!==0&&await this.#v("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#v("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#v("rateLimitCleared")}onError(){return new Promise((e,t)=>{const n=s=>{this.off("error",n),t(s)};this.on("error",n)})}async#v(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#i.size}sizeBy(e){return this.#i.filter(e).length}get pending(){return this.#p}get isPaused(){return this.#m}#U(){this.#t||(this.on("add",()=>{this.#i.size>0&&this.#S()}),this.on("next",()=>{this.#S()}))}#S(){this.#t||this.#a||(this.#a=!0,queueMicrotask(()=>{this.#a=!1,this.#L()}))}#V(){this.#t||(this.#B(),this.#S())}#L(){const e=this.#o;if(this.#t||this.#i.size===0){e&&(this.#o=!1,this.emit("rateLimitCleared"));return}let t;if(this.#h){const s=Date.now();this.#b(s),t=this.#x()}else t=this.#r;const n=t>=this.#n;n!==e&&(this.#o=n,this.emit(n?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#o}get isSaturated(){return this.#p===this.#w&&this.#i.size>0||this.isRateLimited&&this.#i.size>0}get runningTasks(){return[...this.#y.values()].map(e=>({...e}))}}class oD{entries;validityMs;lastPruneTime=0;constructor(e){this.entries=new Map,this.validityMs=e.validityMs}put(e,t){this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),this.prune()}prune(){const e=Date.now();if(!(e-this.lastPruneTime<200)){this.lastPruneTime=e;for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries=new Map,this.lastPruneTime=0}}var Eo;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.subscribe=s.bool();break}case 2:{l.topic=s.string();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.SubOpts||(r.SubOpts={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.sequenceNumber!=null&&(i.uint32(26),i.bytes(s.sequenceNumber)),s.topic!=null&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.from=s.bytes();break}case 2:{l.data=s.bytes();break}case 3:{l.sequenceNumber=s.bytes();break}case 4:{l.topic=s.string();break}case 5:{l.signature=s.bytes();break}case 6:{l.key=s.bytes();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Message||(r.Message={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const i of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(i,n);if(t.messages!=null)for(const i of t.messages)n.uint32(18),r.Message.codec().encode(i,n);t.control!=null&&(n.uint32(26),cl.codec().encode(t.control,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new yt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new yt('Decode error - map field "messages" had too many elements');i.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=cl.codec().decode(t,t.uint32(),{limits:s.limits?.control});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Eo||(Eo={}));var cl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.ihave!=null)for(const i of t.ihave)n.uint32(10),ul.codec().encode(i,n);if(t.iwant!=null)for(const i of t.iwant)n.uint32(18),dl.codec().encode(i,n);if(t.graft!=null)for(const i of t.graft)n.uint32(26),fl.codec().encode(i,n);if(t.prune!=null)for(const i of t.prune)n.uint32(34),hl.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={ihave:[],iwant:[],graft:[],prune:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.ihave!=null&&i.ihave.length===s.limits.ihave)throw new yt('Decode error - map field "ihave" had too many elements');i.ihave.push(ul.codec().decode(t,t.uint32(),{limits:s.limits?.ihave$}));break}case 2:{if(s.limits?.iwant!=null&&i.iwant.length===s.limits.iwant)throw new yt('Decode error - map field "iwant" had too many elements');i.iwant.push(dl.codec().decode(t,t.uint32(),{limits:s.limits?.iwant$}));break}case 3:{if(s.limits?.graft!=null&&i.graft.length===s.limits.graft)throw new yt('Decode error - map field "graft" had too many elements');i.graft.push(fl.codec().decode(t,t.uint32(),{limits:s.limits?.graft$}));break}case 4:{if(s.limits?.prune!=null&&i.prune.length===s.limits.prune)throw new yt('Decode error - map field "prune" had too many elements');i.prune.push(hl.codec().decode(t,t.uint32(),{limits:s.limits?.prune$}));break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(cl||(cl={}));var ul;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),t.messageIDs!=null)for(const i of t.messageIDs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={messageIDs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.topic=t.string();break}case 2:{if(s.limits?.messageIDs!=null&&i.messageIDs.length===s.limits.messageIDs)throw new yt('Decode error - map field "messageIDs" had too many elements');i.messageIDs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ul||(ul={}));var dl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.messageIDs!=null)for(const i of t.messageIDs)n.uint32(10),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={messageIDs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.messageIDs!=null&&i.messageIDs.length===s.limits.messageIDs)throw new yt('Decode error - map field "messageIDs" had too many elements');i.messageIDs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(dl||(dl={}));var fl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();l>>>3===1?i.topic=t.string():t.skipType(l&7)}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(fl||(fl={}));var hl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),t.peers!=null)for(const i of t.peers)n.uint32(18),pl.codec().encode(i,n);t.backoff!=null&&(n.uint32(24),n.uint64(t.backoff)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.topic=t.string();break}case 2:{if(s.limits?.peers!=null&&i.peers.length===s.limits.peers)throw new yt('Decode error - map field "peers" had too many elements');i.peers.push(pl.codec().decode(t,t.uint32(),{limits:s.limits?.peers$}));break}case 3:{i.backoff=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(hl||(hl={}));var pl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.peerID!=null&&(n.uint32(10),n.bytes(t.peerID)),t.signedPeerRecord!=null&&(n.uint32(18),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerID=t.bytes();break}case 2:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(pl||(pl={}));class aD extends Dt{peerId;shutDownController;inboundPb;outboundPb;constructor(e){super(),this.peerId=e,this.shutDownController=new AbortController}attachInboundStream(e,t){this.inboundPb=$n(e,t).pb(Eo),Promise.resolve().then(async()=>{for(;;){if(this.inboundPb==null)return;const n=await this.inboundPb.read({signal:this.shutDownController.signal});this.safeDispatchEvent("message",{detail:n})}}).catch(n=>{this.inboundPb?.unwrap().unwrap().abort(n)})}attachOutboundStream(e,t){this.outboundPb=$n(e,t).pb(Eo)}write(e){this.outboundPb!=null&&this.outboundPb.write(e,{signal:this.shutDownController.signal}).catch(t=>{this.outboundPb?.unwrap().unwrap().abort(t)})}close(){this.shutDownController.abort(),Promise.all([this.inboundPb?.unwrap().unwrap().close().catch(e=>{this.inboundPb?.unwrap().unwrap().abort(e)}),this.outboundPb?.unwrap().unwrap().close().catch(e=>{this.inboundPb?.unwrap().unwrap().abort(e)})]).finally(()=>{this.safeDispatchEvent("close")})}}const Yv=Symbol.for("nodejs.util.inspect.custom"),lD=114;let gf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(lD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Yv](){return`PeerId(${this.toString()})`}},Xv=class extends gf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Zv=class extends gf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},jv=class extends gf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const cD=2336;let uD=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Yv](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(cD,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function Qv(r){if(r.type==="Ed25519")return new Zv({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new jv({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new Xv({multihash:r.toCID().multihash,publicKey:r});throw new Ar}function dD(r){return Qv(r.publicKey)}function Jv(r){if(hD(r))return new Xv({multihash:r});if(fD(r))try{const e=Hn(r);if(e.type==="Ed25519")return new Zv({multihash:r,publicKey:e});if(e.type==="secp256k1")return new jv({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new uD(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function fD(r){return r.code===it.code}function hD(r){return r.code===pr.code}function pD(){return BigInt(`0x${W(li(8),"base16")}`)}const gD=(r,e)=>{const t=j(e.toString(16).padStart(16,"0"),"base16"),n=wr(r),s=new Uint8Array(n.byteLength+t.length);return s.set(n,0),s.set(t,n.byteLength),s},mD=r=>pr.encode(r),yD=async r=>{if(r.sequenceNumber==null||r.from==null||r.signature==null)return!1;const e=Jv(fn(r.from));if(e.publicKey!=null)return!0;if(r.key!=null){const t=r.key;return Qv(qn(t)).equals(e)}return!1},bD=async r=>{if(r.from==null)throw new $e("RPC message was missing from");if(!await yD(r))return{type:"unsigned",topic:r.topic??"",data:r.data??new Uint8Array(0)};const e=Jv(fn(r.from)),t=r.key??e.publicKey;if(t==null)throw new $e("RPC message was missing public key");return{type:"signed",from:e,topic:r.topic??"",sequenceNumber:wD(r.sequenceNumber??new Uint8Array(0)),data:r.data??new Uint8Array(0),signature:r.signature??new Uint8Array(0),key:t instanceof Uint8Array?qn(t):t}},mf=r=>r.type==="signed"?{from:r.from.toMultihash().bytes,data:r.data,sequenceNumber:vD(r.sequenceNumber),topic:r.topic,signature:r.signature,key:r.key?wr(r.key):void 0}:{data:r.data,topic:r.topic},vD=r=>{let e=r.toString(16);return e.length%2!==0&&(e=`0${e}`),j(e,"base16")},wD=r=>BigInt(`0x${W(r,"base16")}`),ew=j("libp2p-pubsub:");async function _D(r,e,t){const n={type:"signed",topic:e.topic,data:e.data,sequenceNumber:e.sequenceNumber,from:dD(r)},s=an([ew,t(mf(n)).subarray()]);return n.signature=await r.sign(s),n.key=r.publicKey,n}async function SD(r,e){if(r.type!=="signed")throw new Error('Message type must be "signed" to be verified');if(r.signature==null)throw new Error("Message must contain a signature to be verified");if(r.from==null)throw new Error("Message must contain a from property to be verified");const t=an([ew,e({...mf(r),signature:void 0,key:void 0}).subarray()]);return ED(r).verify(t,r.signature)}function ED(r){if(r.type!=="signed")throw new Error('Message type must be "signed" to have a public key');if(r.from==null)throw new Error("Could not get the public key from the originator id");if(r.key!=null)return r.key;if(r.from.publicKey!=null)return r.from.publicKey;throw new Error("Could not get the public key from the originator id")}class xD extends Dt{log;started;topics;subscriptions;peers;globalSignaturePolicy;canRelayMessage;emitSelf;topicValidators;queue;protocol;components;_registrarTopologyId;maxInboundStreams;maxOutboundStreams;seenCache;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:floodsub"),this.components=e,this.protocol=t.protocol??AD,this.started=!1,this.topics=new Map,this.subscriptions=new Set,this.peers=new ks,this.globalSignaturePolicy=t.globalSignaturePolicy==="StrictNoSign"?"StrictNoSign":"StrictSign",this.canRelayMessage=t.canRelayMessage??!0,this.emitSelf=t.emitSelf??!1,this.topicValidators=new Map,this.queue=new Gv({concurrency:t.messageProcessingConcurrency??10}),this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.seenCache=new oD({validityMs:t?.seenTTL??3e4}),this._onIncomingStream=this._onIncomingStream.bind(this),this._onPeerConnected=this._onPeerConnected.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this)}[JP]=!0;[Symbol.toStringTag]="@libp2p/floodsub";[Er]=["@libp2p/pubsub"];[Fa]=["@libp2p/identify"];async start(){this.started||(this.log("starting"),await this.components.registrar.handle(this.protocol,this._onIncomingStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this._registrarTopologyId=await this.components.registrar.register(this.protocol,{onConnect:this._onPeerConnected,onDisconnect:this._onPeerDisconnected}),this.log("started"),this.started=!0)}async stop(){if(!this.started)return;const e=this.components.registrar;this._registrarTopologyId!=null&&e.unregister(this._registrarTopologyId),await e.unhandle(this.protocol),this.log("stopping");for(const t of this.peers.values())t.close();this.peers.clear(),this.subscriptions=new Set,this.started=!1,this.log("stopped")}isStarted(){return this.started}_onIncomingStream(e,t){this.addPeer(t.remotePeer,e).attachInboundStream(e)}async _onPeerConnected(e,t){if(this.log("connected %p",e),t.streams.find(i=>i.direction==="outbound"&&i.protocol===this.protocol)){this.log("outbound pubsub stream already present on connection from %p",e);return}const n=await t.newStream(this.protocol);this.addPeer(e,n).attachOutboundStream(n),this.send(e,{subscriptions:Array.from(this.subscriptions).map(i=>i.toString()),subscribe:!0})}_onPeerDisconnected(e,t){this.log("connection ended %p",e),this._removePeer(e)}addPeer(e,t){const n=this.peers.get(e);if(n!=null)return n;this.log("new peer %p",e);const s=new aD(e);return this.peers.set(e,s),s.addEventListener("message",i=>{const o=i.detail,l=[];for(const c of o.messages??[]){if(c.from==null||c.data==null||c.topic==null){this.log("message from %p was missing from, data or topic fields, dropping",e);continue}l.push({from:c.from,data:c.data,topic:c.topic,sequenceNumber:c.sequenceNumber??void 0,signature:c.signature??void 0,key:c.key??void 0})}this.processRpc(s,{subscriptions:(o.subscriptions??[]).map(c=>({subscribe:!!c.subscribe,topic:c.topic??""})),messages:l}).catch(c=>{this.log(c)})}),s.addEventListener("close",()=>this._removePeer(e),{once:!0}),s}_removePeer(e){const t=this.peers.get(e);if(t!=null){t.close(),this.log("delete peer %p",e),this.peers.delete(e);for(const n of this.topics.values())n.delete(e)}}async processRpc(e,t){this.log("rpc from %p",e.peerId);const{subscriptions:n,messages:s}=t;return n!=null&&n.length>0&&(this.log("subscription update from %p",e.peerId),n.forEach(i=>{this.processRpcSubOpt(e.peerId,i)}),super.dispatchEvent(new CustomEvent("subscription-change",{detail:{peerId:e.peerId,subscriptions:n.map(({topic:i,subscribe:o})=>({topic:`${i??""}`,subscribe:!!o}))}}))),s!=null&&s.length>0&&(this.log("messages from %p",e.peerId),this.queue.addAll(s.map(i=>async()=>{if(i.topic==null||!this.subscriptions.has(i.topic)&&!this.canRelayMessage)return this.log("received message we didn't subscribe to. Dropping."),!1;try{const o=await bD(i);await this.processMessage(e.peerId,o)}catch(o){this.log.error("failed to queue messages from %p - %e",e.peerId,o)}})).catch(i=>{this.log(i)})),!0}processRpcSubOpt(e,t){const n=t.topic;if(n==null)return;let s=this.topics.get(n);s==null&&(s=new fs,this.topics.set(n,s)),t.subscribe===!0?s.add(e):s.delete(e)}async processMessage(e,t){if(this.components.peerId.equals(e)&&!this.emitSelf)return;const n=await this.getMsgId(t),s=W(n,"base64");if(!this.seenCache.has(s)){this.seenCache.put(s,!0);try{await this.validate(e,t)}catch(i){this.log("Message is invalid, dropping it. %O",i);return}this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.emitSelf)&&super.dispatchEvent(new CustomEvent("message",{detail:t})),await this.publishMessage(e,t)}}getMsgId(e){switch(this.globalSignaturePolicy){case"StrictSign":if(e.type!=="signed")throw new $e('Message type should be "signed" when signature policy is StrictSign but it was not');if(e.sequenceNumber==null)throw new $e("Need sequence number when signature policy is StrictSign but it was missing");if(e.key==null)throw new $e("Need key when signature policy is StrictSign but it was missing");return gD(e.key,e.sequenceNumber);case"StrictNoSign":return mD(e.data);default:throw new $e("Cannot get message id: unhandled signature policy")}}encodeMessage(e){return Eo.Message.encode(e)}send(e,t){const{messages:n,subscriptions:s,subscribe:i}=t;this.sendRpc(e,{subscriptions:(s??[]).map(o=>({topic:o,subscribe:!!i})),messages:(n??[]).map(mf)})}sendRpc(e,t){const n=this.peers.get(e);if(n==null){this.log.error("cannot send RPC to %p as there are no streams to it available",e);return}n.write(t)}async validate(e,t){switch(this.globalSignaturePolicy){case"StrictNoSign":if(t.type!=="unsigned")throw new $e('Message type should be "unsigned" when signature policy is StrictNoSign but it was not');if(t.signature!=null)throw new $e("StrictNoSigning: signature should not be present");if(t.key!=null)throw new $e("StrictNoSigning: key should not be present");if(t.sequenceNumber!=null)throw new $e("StrictNoSigning: seqno should not be present");break;case"StrictSign":if(t.type!=="signed")throw new $e('Message type should be "signed" when signature policy is StrictSign but it was not');if(t.signature==null)throw new $e("StrictSigning: Signing required and no signature was present");if(t.sequenceNumber==null)throw new $e("StrictSigning: Signing required and no sequenceNumber was present");if(!await SD(t,this.encodeMessage.bind(this)))throw new $e("StrictSigning: Invalid message signature");break;default:throw new $e("Cannot validate message: unhandled signature policy")}const s=this.topicValidators.get(t.topic);if(s!=null){const i=await s(e,t);if(i===gl.Reject||i===gl.Ignore)throw new $e("Message validation failed")}}async buildMessage(e){switch(this.globalSignaturePolicy){case"StrictSign":return _D(this.components.privateKey,e,this.encodeMessage.bind(this));case"StrictNoSign":return Promise.resolve({type:"unsigned",...e});default:throw new $e("Cannot build message: unhandled signature policy")}}getSubscribers(e){if(!this.started)throw new uo("not started yet");if(e==null)throw new V("Topic is required");const t=this.topics.get(e.toString());return t==null?[]:Array.from(t.values())}async publish(e,t){if(!this.started)throw new Error("Pubsub has not started");const n={from:this.components.peerId,topic:e,data:t??new Uint8Array(0),sequenceNumber:pD()};this.log("publish topic: %s from: %p data: %m",e,n.from,n.data);const s=await this.buildMessage(n);let i=!1;this.emitSelf&&this.subscriptions.has(e)&&(i=!0,super.dispatchEvent(new CustomEvent("message",{detail:s})));const o=await this.publishMessage(this.components.peerId,s);return i&&(o.recipients=[...o.recipients,this.components.peerId]),o}async publishMessage(e,t){const n=this.getSubscribers(t.topic),s=[];return n==null||n.length===0?(this.log("no peers are subscribed to topic %s",t.topic),{recipients:s}):(n.forEach(i=>{if(this.components.peerId.equals(i)){this.log("not sending message on topic %s to myself",t.topic);return}if(i.equals(e)){this.log("not sending message on topic %s to sender %p",t.topic,i);return}this.log("publish msgs on topics %s %p",t.topic,i),s.push(i),this.send(i,{messages:[t]})}),{recipients:s})}subscribe(e){if(!this.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.log("subscribe to topic: %s",e),this.subscriptions.add(e);for(const t of this.peers.keys())this.send(t,{subscriptions:[e],subscribe:!0})}}unsubscribe(e){if(!this.started)throw new Error("Pubsub is not started");if(this.subscriptions.has(e)){this.log("unsubscribe from %s",e),this.subscriptions.delete(e);for(const t of this.peers.keys())this.send(t,{subscriptions:[e],subscribe:!1})}}getTopics(){if(!this.started)throw new Error("Pubsub is not started");return Array.from(this.subscriptions)}getPeers(){if(!this.started)throw new Error("Pubsub is not started");return Array.from(this.peers.keys())}}const AD="/floodsub/1.0.0";var gl;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(gl||(gl={}));function ID(r={}){return e=>new xD(e,r)}const la=globalThis.CustomEvent??Event;async function*kD(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=cr(),l=cr(),c=!1,d,f=!1;s.addEventListener("task-complete",()=>{l.resolve()}),Promise.resolve().then(async()=>{try{for await(const p of r){if(i.length===t&&(o=cr(),await o.promise),f)break;const y={done:!1};i.push(y),p().then(g=>{y.done=!0,y.ok=!0,y.value=g,s.dispatchEvent(new la("task-complete"))},g=>{y.done=!0,y.err=g,s.dispatchEvent(new la("task-complete"))})}c=!0,s.dispatchEvent(new la("task-complete"))}catch(p){d=p,s.dispatchEvent(new la("task-complete"))}});function a(){return n?i[0]?.done:!!i.find(p=>p.done)}function*u(){for(;i.length>0&&i[0].done;){const p=i[0];if(i.shift(),p.ok)yield p.value;else throw f=!0,o.resolve(),p.err;o.resolve()}}function*h(){for(;a();)for(let p=0;p<i.length;p++)if(i[p].done){const y=i[p];if(i.splice(p,1),p--,y.ok)yield y.value;else throw f=!0,o.resolve(),y.err;o.resolve()}}for(;;){if(a()||(l=cr(),await l.promise),d!=null||(n?yield*u():yield*h(),d!=null))throw d;if(c&&i.length===0)break}}const CD="0.1.0",TD="id",PD="1.0.0",DD=1024*8;var ml;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new yt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new yt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ml||(ml={}));const tw=Symbol.for("nodejs.util.inspect.custom"),LD=114;let yf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(LD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[tw](){return`PeerId(${this.toString()})`}},rw=class extends yf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},nw=class extends yf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},sw=class extends yf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const RD=2336;let iw=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[tw](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(RD,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const BD=114,xp=2336;function ND(r){if(r.type==="Ed25519")return new nw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new sw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new rw({multihash:r.toCID().multihash,publicKey:r});throw new Ar}function MD(r){if($D(r))return new rw({multihash:r});if(OD(r))try{const e=Hn(r);if(e.type==="Ed25519")return new nw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new sw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new iw(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function ow(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==BD&&r.code!==xp)throw new Oo("Supplied PeerID CID is invalid");if(r.code===xp){const e=W(r.multihash.digest);return new iw(new URL(e))}return MD(r.multihash)}function OD(r){return r.code===it.code}function $D(r){return r.code===pr.code}const Yr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:DD,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function FD(r){if(r!=null&&r.length>0)try{return he(r)}catch{}}async function UD(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new $e("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:he(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=qn(s.publicKey);if(!ND(c).equals(n.remotePeer))throw new $e("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const d=await sn.openAndCertify(c,dr.DOMAIN);let f=dr.createFromProtobuf(d.payload);const a=ow(d.publicKey.toCID());if(!f.peerId.equals(a))throw new $e("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(f.peerId))throw new $e("signing key does not match remote PeerId");let u;try{u=await r.get(f.peerId)}catch(h){if(h.name!=="NotFoundError")throw h}if(u!=null&&(i.metadata=u.metadata,u.peerRecordEnvelope!=null)){const h=sn.createFromProtobuf(u.peerRecordEnvelope),p=dr.createFromProtobuf(h.payload);p.seqNumber>=f.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,f.seqNumber),f=p,c=u.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=f.multiaddrs.map(h=>({isCertified:!0,multiaddr:h})),o={seq:f.seqNumber,addresses:f.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=j(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=j(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const l={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>he(c)),observedAddr:s.observedAddr==null?void 0:he(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:l}),l}class VD{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??Yr.timeout,this.maxInboundStreams=t.maxInboundStreams??Yr.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Yr.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Yr.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Yr.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Yr.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Yr.protocolPrefix}/${CD}`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:j(this.host.agentVersion),ProtocolVersion:j(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}}class KD extends VD{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Yr.protocolPrefix}/${TD}/${PD}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Yr.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(()=>{})})}[Er]=["@libp2p/identify"];async _identify(e,t={}){let n,s;if(t.signal==null){const i=AbortSignal.timeout(this.timeout);t={...t,signal:i}}this.log("run identify on new connection %a",e.remoteAddr);try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),s=n.log.newScope("identify");const i=$n(n,{maxDataLength:this.maxMessageSize}).pb(ml),o=await i.read(t);return await i.unwrap().unwrap().close(t),o}catch(i){throw s?.error("identify failed - %e",i),n?.abort(i),i}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new $e("Public key was missing from identify message");const l=qn(s),c=ow(l.toCID());if(!e.remotePeer.equals(c))throw new $e("Identified peer does not match the expected peer");if(this.components.peerId.equals(c))throw new $e("Identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("completed for peer %p and protocols %o",c,i),UD(this.components.peerStore,this.components.events,this.log,e,n)}maybeAddObservedAddress(e){const t=FD(e);if(t==null||(this.log.trace("our observed address was %a",t),di(t)))return;const n=t.getComponents();if((n[0].code===ws||n[0].code===Kd&&n[1].code===ws)&&!ak(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Qa.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t))}async handleProtocol(e,t){const n=e.log.newScope("identify");n("responding to identify");const s=AbortSignal.timeout(this.timeout),i=await this.components.peerStore.get(this.components.peerId,{signal:s}),o=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(ce));let l=i.peerRecordEnvelope;if(o.length>0&&l==null){const f=new dr({peerId:this.components.peerId,multiaddrs:o});l=(await sn.seal(f,this.components.privateKey,{signal:s})).marshal().subarray()}let c=t.remoteAddr.bytes;uT.matches(t.remoteAddr)||(c=void 0);const d=$n(e).pb(ml);n("send response"),await d.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:wr(this.components.privateKey.publicKey),listenAddrs:o.map(f=>f.bytes),signedPeerRecord:l,observedAddr:c,protocols:i.protocols},{signal:s}),n("close write"),await d.unwrap().unwrap().close({signal:s})}}function qD(r={}){return e=>new KD(e,r)}const HD=Symbol.for("nodejs.util.inspect.custom"),zD=114;let bf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(zD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[HD](){return`PeerId(${this.toString()})`}},WD=class extends bf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},GD=class extends bf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},YD=class extends bf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function XD(r){if(r.type==="Ed25519")return new GD({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new YD({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new WD({multihash:r.toCID().multihash,publicKey:r});throw new Ar}var Uu;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubkey!=null&&(n.uint32(18),yl.codec().encode(t.pubkey,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.id=t.bytes();break}case 2:{i.pubkey=yl.codec().decode(t,t.uint32(),{limits:s.limits?.pubkey});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Uu||(Uu={}));var Es;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Es||(Es={}));var Vu;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Vu||(Vu={}));(function(r){r.codec=()=>Ko(Vu)})(Es||(Es={}));var yl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Es.codec().encode(t.Type,n)),t.Data!=null&&t.Data.byteLength>0&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={Data:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=Es.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(yl||(yl={}));const ZD="/plaintext/2.0.0";class jD{protocol=ZD;privateKey;log;constructor(e){this.privateKey=e.privateKey,this.log=e.logger.forComponent("libp2p:plaintext")}[Symbol.toStringTag]="@libp2p/plaintext";[Er]=["@libp2p/connection-encryption"];async secureInbound(e,t){return this._encrypt(e,t)}async secureOutbound(e,t){return this._encrypt(e,t)}async _encrypt(e,t){const n=e.log?.newScope("plaintext")??this.log,s=$n(e).pb(Uu);n("write pubkey exchange to peer %p",t?.remotePeer);const i=this.privateKey.publicKey;await s.write({id:i.toMultihash().bytes,pubkey:{Type:Es[i.type],Data:i.raw}},t);const o=await s.read(t);let l;try{if(o.pubkey==null)throw new lc("Public key missing");if(o.pubkey.Data.byteLength===0)throw new lc("Public key data too short");if(o.id==null)throw new lc("Remote id missing");const c=RI(o.pubkey.Data);if(l=XD(c),!pe(l.toMultihash().bytes,o.id))throw new dh("Public key did not match id")}catch(c){throw n.error("invalid public key - %e",c),new dh(`Invalid public key - ${c.message}`)}if(t?.remotePeer!=null&&!l.equals(t?.remotePeer))throw new Gx;return n("plaintext key exchange completed successfully with peer %p",l),{connection:s.unwrap().unwrap(),remotePeer:l}}}function QD(){return r=>new jD(r)}const JD=Symbol.for("nodejs.util.inspect.custom"),eL=114;let vf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(eL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[JD](){return`PeerId(${this.toString()})`}},tL=class extends vf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},rL=class extends vf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},nL=class extends vf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function sL(r){if(r.type==="Ed25519")return new rL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new nL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new tL({multihash:r.toCID().multihash,publicKey:r});throw new Ar}var bl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(bl||(bl={}));const iL="_peer-discovery._p2p._pubsub";class oL extends Dt{[Oa]=!0;[Symbol.toStringTag]="@libp2p/pubsub-peer-discovery";interval;listenOnly;topics;intervalId;components;log;constructor(e,t={}){super();const{interval:n,topics:s,listenOnly:i}=t;this.components=e,this.interval=n??1e4,this.listenOnly=i??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(s)&&s.length>0?this.topics=s:this.topics=[iL],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.subscribe(t),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.unsubscribe(t),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const t={publicKey:wr(e.publicKey),addrs:this.components.addressManager.getAddresses().map(i=>i.bytes)},n=bl.encode(t),s=this.components.pubsub;if(s==null)throw new Error("PubSub not configured");for(const i of this.topics){if(s.getSubscribers(i).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",i);continue}this.log("broadcasting our peer data on topic %s",i),s.publish(i,n)}}_onMessage(e){if(!this.isStarted())return;const t=e.detail;if(this.topics.includes(t.topic))try{const n=bl.decode(t.data),s=qn(n.publicKey),i=sL(s);if(i.equals(this.components.peerId))return;this.log("discovered peer %p on %s",i,t.topic),this.safeDispatchEvent("peer",{detail:{id:i,multiaddrs:n.addrs.map(o=>he(o))}})}catch(n){this.log.error("error handling incoming message",n)}}}function aL(r={}){return e=>new oL(e,r)}const lL=[us,Hd,Gd,zd,Wd];function Ap(r){return aw("sni",r)?.value}function Ip(r){const e=aw("tcp",r)?.value;return e==null?"":`:${e}`}function aw(r,e){return e.find(t=>t.name===r)}function kp(r){return r.some(({code:e})=>e===ds)}function yr(r,e){const t=lw[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===ws?`[${n}]`:n}const lw={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${yr(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${yr(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${yr(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${yr(t,e)}`},http:(r,e)=>{const t=kp(e),n=Ap(e),s=Ip(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let l=yr(o,e);return l=l?.replace("tcp://",""),`${i}${l}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=yr(t,e),s=decodeURIComponent(r.value??"");return`${n}${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return yr(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return yr(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=yr(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=kp(e),n=Ap(e),s=Ip(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let l=yr(o,e);return l=l?.replace("tcp://",""),`${i}${l}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=yr(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function cL(r,e){const n=he(r).getComponents(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=lw[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let o=i(s,n)??"";return lL.includes(s.code)&&(o=o.replace(/^.*:\/\//,""),s.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}function uL(){throw new Error("WebSocket Servers can not be created in the browser!")}const dL=1024*1024*4,fL=10;class hL extends Yy{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??dL,this.checkBufferedAmountTask=ob(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??fL),this.websocket.addEventListener("close",t=>{if(this.log('closed - code %d, reason "%s", wasClean %s',t.code,t.reason,t.wasClean),this.checkBufferedAmountTask.stop(),!t.wasClean){this.onRemoteReset();return}this.onTransportClosed()},{once:!0}),this.websocket.addEventListener("message",t=>{try{let n;if(typeof t.data=="string")n=j(t.data);else if(t.data instanceof ArrayBuffer)n=new Uint8Array(t.data,0,t.data.byteLength);else{this.abort(new Error("Incorrect binary type"));return}this.onData(n)}catch(n){this.log.error("error receiving data - %e",n)}})}sendData(e){for(const n of e)this.websocket.send(n);const t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),this.websocket.bufferedAmount===0&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}}function pL(r){return new hL(r)}class gL{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Bm]=!0;[Symbol.toStringTag]="@libp2p/websockets";[Er]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=pL({websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval});this.log("new outbound connection %s",n.remoteAddr);const s=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),s}async _connect(e,t){t?.signal?.throwIfAborted();const n=cL(e);this.log("create websocket connection to %s",n);const s=new WebSocket(n);s.binaryType="arraybuffer";try{t.onProgress?.(new nt("websockets:open-connection")),await fr(s,"open",t)}catch(i){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new Yx(`Could not connect to ${n}`);this.metrics?.dialerEvents.increment({error:!0});try{s.close()}catch{}throw i}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),s}createListener(e){return uL({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e.filter(t=>_o.exactMatch(t)||Ja.exactMatch(t))}dialFilter(e){return this.listenFilter(e)}}function mL(r={}){return e=>new gL(e,r)}const cw=Symbol.for("nodejs.util.inspect.custom"),yL=114;let wf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(yL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[cw](){return`PeerId(${this.toString()})`}},uw=class extends wf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},dw=class extends wf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},fw=class extends wf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const bL=2336;let hw=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[cw](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(bL,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const vL=114,Cp=2336;function yi(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=fn(Pe.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return SL(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return pw(t)}function wL(r){if(r.type==="Ed25519")return new dw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new fw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new uw({multihash:r.toCID().multihash,publicKey:r});throw new Ar}function _L(r){return wL(r.publicKey)}function pw(r){if(xL(r))return new uw({multihash:r});if(EL(r))try{const e=Hn(r);if(e.type==="Ed25519")return new dw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new fw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new hw(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function SL(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==vL&&r.code!==Cp)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Cp){const e=W(r.multihash.digest);return new hw(new URL(e))}return pw(r.multihash)}function EL(r){return r.code===it.code}function xL(r){return r.code===pr.code}var AL={};async function IL(r){if(r.connectionProtector===null&&AL?.LIBP2P_FORCE_PNET!=null)throw new V("Private network is enforced, but no protector was provided");return r}const gw=Symbol.for("nodejs.util.inspect.custom"),kL=114;class _f{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(kL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[gw](){return`PeerId(${this.toString()})`}}class mw extends _f{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class yw extends _f{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class bw extends _f{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const CL=2336;class vw{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[gw](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(CL,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}}const TL=114,Tp=2336;function PL(r){if(r.type==="Ed25519")return new yw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new bw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new mw({multihash:r.toCID().multihash,publicKey:r});throw new Ar}function DL(r){if(RL(r))return new mw({multihash:r});if(LL(r))try{const e=Hn(r);if(e.type==="Ed25519")return new yw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new bw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new vw(new URL(t))}throw new Vn("Supplied PeerID Multihash is invalid")}function ww(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==TL&&r.code!==Tp)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Tp){const e=W(r.multihash.digest);return new vw(new URL(e))}return DL(r.multihash)}function LL(r){return r.code===it.code}function RL(r){return r.code===pr.code}let bi=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Tc(r,e,t,n){const s=new bi(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((o,l)=>{function c(){Dc(t,"abort",a),Dc(r,e,d),Dc(r,i,f)}const d=u=>{try{if(n?.filter?.(u)===!1)return}catch(h){c(),l(h);return}c(),o(u)},f=u=>{if(c(),u instanceof Error){l(u);return}l(u.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},a=()=>{c(),l(s)};Pc(t,"abort",a),Pc(r,e,d),Pc(r,i,f)})}function Pc(r,e,t){r!=null&&(_w(r)?r.addEventListener(e,t):r.addListener(e,t))}function Dc(r,e,t){r!=null&&(_w(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function _w(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}class BL extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class NL{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new bi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function ML(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class OL{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=ML(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new bi),this.cleanup())}async join(e={}){const t=new NL(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Ct(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function Pp(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Dp extends Dt{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=Pp(this.emitEmpty.bind(this),1),this.emitIdle=Pp(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new BL;const n=new OL(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new bi)}),this.clear()}async onEmpty(e){this.size!==0&&await Tc(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Tc(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Tc(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ad({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},l=()=>{n(new bi("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",l),n()}}}const Sw="lock:worker:request-read",Ew="lock:worker:abort-read-request",xw="lock:worker:release-read",Aw="lock:master:grant-read",Iw="lock:master:error-read",kw="lock:worker:request-write",Cw="lock:worker:abort-write-request",Tw="lock:worker:release-write",Pw="lock:master:grant-write",Dw="lock:master:error-write",Lw="lock:worker:finalize",Rw="mortice",$L={singleProcess:!1},Lp=(r,e,t,n,s,i,o,l,c)=>d=>{if(d.data==null)return;const f={type:d.data.type,name:d.data.name,identifier:d.data.identifier};f.type===s&&r.safeDispatchEvent(t,{detail:{name:f.name,identifier:f.identifier,handler:async()=>{e.postMessage({type:c,name:f.name,identifier:f.identifier}),await new Promise(a=>{const u=h=>{if(h?.data==null)return;const p={type:h.data.type,name:h.data.name,identifier:h.data.identifier};p.type===l&&p.identifier===f.identifier&&(e.removeEventListener("message",u),a())};e.addEventListener("message",u)})},onError:a=>{e.postMessage({type:o,name:f.name,identifier:f.identifier,error:{message:a.message,name:a.name,stack:a.stack}})}}}),f.type===i&&r.safeDispatchEvent(n,{detail:{name:f.name,identifier:f.identifier}}),f.type===Lw&&r.safeDispatchEvent("finalizeRequest",{detail:{name:f.name}})},FL=(r=10)=>Math.random().toString().substring(2,r+2);class UL{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(Rw)}readLock(e){return this.sendRequest(Sw,Ew,Aw,Iw,xw,e)}writeLock(e){return this.sendRequest(kw,Cw,Pw,Dw,Tw,e)}finalize(){this.channel.postMessage({type:Lw,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const l=FL();return this.channel.postMessage({type:e,identifier:l,name:this.name}),new Promise((c,d)=>{const f=()=>{this.channel.postMessage({type:t,identifier:l,name:this.name})};o?.signal?.addEventListener("abort",f,{once:!0});const a=u=>{if(u.data?.identifier===l&&(u.data?.type===n&&(this.channel.removeEventListener("message",a),o?.signal?.removeEventListener("abort",f),c(()=>{this.channel.postMessage({type:i,identifier:l,name:this.name})})),u.data.type===s)){this.channel.removeEventListener("message",a),o?.signal?.removeEventListener("abort",f);const h=new Error;u.data.error!=null&&(h.message=u.data.error.message,h.name=u.data.error.name,h.stack=u.data.error.stack),d(h)}};this.channel.addEventListener("message",a)})}}const VL=r=>{if(r=Object.assign({},$L,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel(Rw),n=new Dt;return t.addEventListener("message",Lp(n,t,"requestReadLock","abortReadLockRequest",Sw,Ew,Iw,xw,Aw)),t.addEventListener("message",Lp(n,t,"requestWriteLock","abortWriteLockRequest",kw,Cw,Dw,Tw,Pw)),n}return new UL(r.name)},rs=new Map;let Mi;function Bw(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function KL(r){if(Mi==null&&(Mi=VL(r),!Bw(Mi))){const e=Mi;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=rs.get(n);if(i==null)return;const o=new AbortController,l=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",l),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",l)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=rs.get(n);if(i==null)return;const o=new AbortController,l=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",l),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",l)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=rs.get(n);s?.finalize()})}return Mi}async function Lc(r,e){let t,n;const s=new Promise((o,l)=>{t=o,n=l}),i=()=>{n(new bi)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const qL=(r,e)=>{let t=rs.get(r);if(t!=null)return t;const n=KL(e);if(Bw(n))return t=n,rs.set(r,t),t;const s=new Dp({concurrency:1});let i;return t={async readLock(o){if(i!=null)return Lc(i,o);i=new Dp({concurrency:e.concurrency,autoStart:!1});const l=i,c=Lc(i,o);return s.add(async()=>{l.start(),await l.onIdle().then(()=>{i===l&&(i=null)})}),c},async writeLock(o){return i=null,Lc(s,o)},finalize:()=>{rs.delete(r)},queue:s},rs.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},HL={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function zL(r){const e=Object.assign({},HL,r);return qL(e.name,e)}const WL=36e5,GL=216e5;var ns;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={key:"",value:Ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),wl.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.key=s.string();break}case 2:{l.value=wl.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),vl.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new yt('Decode error - map field "addresses" had too many elements');i.addresses.push(vl.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new yt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Lh('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Lh('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ns||(ns={}));var vl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(vl||(vl={}));var wl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(wl||(wl={}));function YL(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=qn(e.publicKey,t);return PL(n)}function XL(r,e,t){const n=ns.decode(e);return Hi(r,n,t)}function Hi(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:YL(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:he(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function ZL(r,e){return jL(r.addresses,e.addresses)&&QL(r.protocols,e.protocols)&&JL(r.publicKey,e.publicKey)&&eR(r.peerRecordEnvelope,e.peerRecordEnvelope)&&tR(r.metadata,e.metadata)&&rR(r.tags,e.tags)}function jL(r,e){return Mw(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!pe(t.multiaddr,n.multiaddr)))}function QL(r,e){return Mw(r,e,(t,n)=>t===n)}function JL(r,e){return Nw(r,e)}function eR(r,e){return Nw(r,e)}function tR(r,e){return Ow(r,e,(t,n)=>pe(t,n))}function rR(r,e){return Ow(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function Nw(r,e){return r==null&&e==null?!0:r!=null&&e!=null?pe(r,e):!1}function Mw(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function Ow(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const $w="/peers/";function ca(r){if(!Gi(r)||r.type==null)throw new V("Invalid PeerId");const e=r.toCID().toString();return new je(`${$w}${e}`)}async function nR(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=he(o.multiaddr)),!zl(o.multiaddr))throw new V("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const l=o.isCertified??!1,c=o.multiaddr.toString(),d=i.get(c);d!=null?o.isCertified=d.isCertified||l:i.set(c,{multiaddr:o.multiaddr,isCertified:l})}return[...i.values()].sort((o,l)=>o.multiaddr.toString().localeCompare(l.multiaddr.toString())).map(({isCertified:o,multiaddr:l})=>{const c=l.getComponents().find(d=>d.code===ce)?.value;return r.equals(c)&&(l=l.decapsulate(he(`/p2p/${r}`))),{isCertified:o,multiaddr:l.bytes}})}async function Rc(r,e,t,n){if(e==null)throw new V("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new V("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new V("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),l=s?.metadata??new Map,c=s?.tags??new Map,d=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(u=>({isCertified:!1,multiaddr:u}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const u=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);l=ua(u,{validate:Rp})}if(e.tags!=null){const u=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=ua(u,{validate:Bp,map:Np})}e.peerRecordEnvelope!=null&&(d=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(u=>({isCertified:!1,multiaddr:u}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const u=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[h,p]of u)p==null?l.delete(h):l.set(h,p);l=ua([...l.entries()],{validate:Rp})}if(e.tags!=null){const u=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(const[p,y]of u)y==null?h.delete(p):h.set(p,y);c=ua([...h.entries()],{validate:Bp,map:Np})}e.peerRecordEnvelope!=null&&(d=e.peerRecordEnvelope)}let f;s?.id.publicKey!=null?f=wr(s.id.publicKey):e.publicKey!=null?f=wr(e.publicKey):r.publicKey!=null&&(f=wr(r.publicKey));const a={addresses:await nR(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((u,h)=>u.localeCompare(h)),metadata:l,tags:c,publicKey:f,peerRecordEnvelope:d};return a.addresses.forEach(u=>{u.observed=n.existingPeer?.peerPB.addresses?.find(h=>pe(h.multiaddr,h.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete a.publicKey,a}function ua(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function Rp(r,e){if(typeof r!="string")throw new V("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new V("Metadata value must be a Uint8Array")}function Bp(r,e){if(typeof r!="string")throw new V("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new V("Tag value must be an integer");if(e.value<0||e.value>100)throw new V("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new V("Tag ttl must be an integer");if(e.ttl<0)throw new V("Tag ttl must be between greater than 0")}}function Np(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function Fw(r){const e=r.toString().split("/")[2],t=ue.parse(e,Ln);return ww(t)}function Bc(r,e,t){const n=Fw(r);return XL(n,e,t)}function sR(r,e){return{prefix:$w,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(Bc(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(Bc(n.key,n.value,e),Bc(s.key,s.value,e)))}}class iR{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=uP({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??WL,this.maxPeerAge=t.maxPeerAge??GL}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:zL({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(ca(e),t)}async load(e,t){const n=ca(e),s=await this.datastore.get(n,t),i=ns.decode(s);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Ma;return Hi(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await Rc(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#t(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await Rc(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await Rc(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(sR(e??{},this.maxAddressAge),e)){const s=Fw(t);if(s.equals(this.peerId))continue;const i=ns.decode(n);if(this.#r(s,i)){await this.datastore.delete(t,e);continue}yield Hi(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=ca(e),s=await this.datastore.get(n,t),i=ns.decode(s);if(this.#r(e,i))throw await this.datastore.delete(n,t),new Ma;return{peerPB:i,peer:Hi(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#t(e,t,n,s){t.updated=Date.now();const i=ns.encode(t);return await this.datastore.put(ca(e),i,s),{peer:Hi(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!ZL(t,n.peerPB)}}#r(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class oR{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new iR(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return ou(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=Gi(t)?t:Gi(t?.expectedPeer)?t.expectedPeer:void 0,i=Gi(t)||t===void 0?n:t,o=await sn.openAndCertify(e,dr.DOMAIN,i),l=ww(o.publicKey.toCID());if(s?.equals(l)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,l),!1;const c=dr.createFromProtobuf(o.payload);let d;try{d=await this.get(l,i)}catch(f){if(f.name!=="NotFoundError")throw f}if(d?.peerRecordEnvelope!=null){const f=sn.createFromProtobuf(d.peerRecordEnvelope),a=dr.createFromProtobuf(f.payload);if(a.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(f=>({isCertified:!0,multiaddr:f}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function aR(r,e={}){return new oR(r,e)}const Mp=864e13;class lR{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=un({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=qe(e);let n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(const s of this.mappings.values())if(s.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=Vd(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?Mp-Date.now():0,lastVerified:s?Mp-Date.now():void 0})})}remove(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",s,i.domain),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const s=e[n].multiaddr;if(!_r(s))continue;const i=qe(s);for(const[o,l]of this.mappings.entries()){if(i.host!==o)continue;const c=this.maybeAddSNIComponent(s,l.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:l.verified,type:"dns-mapping",expires:l.expires,lastVerified:l.lastVerified}))}}return t}maybeAddSNIComponent(e,t){const n=e.getComponents();for(let s=0;s<n.length;s++)if(n[s].code===ds&&n[s+1]?.code!==ja)return n.splice(s+1,0,{name:"sni",code:ja,value:t}),he(n)}confirm(e,t){const n=qe(e);let s=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(s=n.sni);let i=!1;for(const[o,l]of this.mappings.entries())l.domain===s&&(this.log("marking %s to %s DNS mapping as verified",o,l.domain),i=l.verified,l.verified=!0,l.expires=Date.now()+t,l.lastVerified=Date.now());return i}unconfirm(e,t){const n=qe(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;const s=n.sni??n.host;let i=!1;for(const[o,l]of this.mappings.entries())l.domain===s&&(this.log("removing verification of %s to %s DNS mapping",o,l.domain),i=i||l.verified,l.verified=!1,l.expires=Date.now()+t);return i}}class cR{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=un({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t.host)return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,l=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:ui(n)?4:6,protocol:i,verified:!1,expires:0};l.push(c),this.mappings.set(o,l)}remove(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[s,i]of this.mappings.entries()){for(let o=0;o<i.length;o++){const l=i[o];l.externalIp===t.host&&l.externalPort===t.port&&l.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,t.host,t.port,t.protocol),n=n||l.verified,i.splice(o,1),o--)}i.length===0&&this.mappings.delete(s)}return n}getAll(e){const t=[];for(const{multiaddr:n}of e){if(!_r(n))continue;const s=qe(n);if(s.type!=="ip4"&&s.type!=="ip6")continue;let i;if(s.protocol==="tcp"?i=`${s.host}-${s.port}-tcp`:s.protocol==="udp"&&(i=`${s.host}-${s.port}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const l of o)t.push({multiaddr:this.maybeOverrideIp(n,l.externalIp,l.externalFamily,l.protocol,l.externalPort),verified:l.verified,type:"ip-mapping",expires:l.expires,lastVerified:l.lastVerified})}return t}maybeOverrideIp(e,t,n,s,i){const o=e.getComponents(),l=o.findIndex(d=>d.code===Za||d.code===ws),c=o.findIndex(d=>d.name===s);return l>-1&&c>-1?(o[l].value=t,o[l].code=n===4?Za:ws,o[c].value=`${i}`,he(o)):e}confirm(e,t){if(!_r(e))return!1;const n=qe(e);let s=!1;for(const i of this.mappings.values())for(const o of i)o.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",o.internalIp,o.externalIp),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){if(!_r(e))return!1;const n=qe(e);let s=!1;for(const i of this.mappings.values())for(let o=0;o<i.length;o++){const l=i[o];l.externalIp===n.host&&l.externalPort===n.port&&l.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,n.host,n.port,n.protocol),s=s||l.verified,l.verified=!1,l.expires=Date.now()+t)}return s}}const uR={maxObservedAddresses:10};class dR{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=un({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??uR.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(di(e)||lk(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:he(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const fR={maxObservedAddresses:10};class hR{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=un({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??fR.maxObservedAddresses}get(e,t){if(di(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!_r(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(!_r(e))return e.toString();const t=qe(e);return`${t.host}-${t.port}-${t.protocol}`}}const Op=6e4,$p={addressVerificationTTL:Op*10,addressVerificationRetry:Op*5},pR=r=>r;function Nc(r,e){const t=r.getComponents().findLast(n=>n.code===ce)?.value;return t!=null&&yi(t).equals(e)&&(r=r.decapsulate(he(`/p2p/${e.toString()}`))),r}class gR{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new dR(e,t),this.dnsMappings=new lR(e,t),this.ipMappings=new cR(e,t),this.transportAddresses=new hR(e,t),this.announceFilter=t.announceFilter??pR,this.observedAddressFilter=mo(1024),this.addressVerificationTTL=t.addressVerificationTTL??$p.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??$p.addressVerificationRetry,this._updatePeerStoreAddresses=Ya(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===ce)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>he(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>he(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>he(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=qe(e);let n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=Nc(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Nc(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Nc(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=he(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(he(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${ui(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(he(`/ip${ui(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!_r(e))return!1;const t=qe(e);if(t.type!=="ip4"||Vd(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>_o.exactMatch(i)||Ja.exactMatch(i),i=>Qa.exactMatch(i),i=>fT.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(d=>d.getAddrs().filter(f=>qe(f).type==="ip4"&&i(f)).length>0);if(o.length!==1)continue;const l=o[0].getAddrs().filter(d=>!Pu(d)).pop();if(l==null)continue;const c=qe(l);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}}var Fp;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(Fp||(Fp={}));class mR extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class yR extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Mc extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class Up extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class bR extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class vR extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class wR extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class Vp extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class _R extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class SR extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class ER extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class xR extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class AR extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class wa extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class da extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class IR extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class kR extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class CR{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=ld())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>pd(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const TR=["metrics","connectionProtector","dns"],PR=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function DR(r={}){const e=new CR(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!PR.includes(s)){const o=e.components[s];if(o==null&&!TR.includes(s))throw new mR(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function LR(r){const e={};for(const t of Object.values(r.components))for(const n of RR(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of BR(t))if(e[n]!==!0)throw new yR(`Service "${NR(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function RR(r){return Array.isArray(r?.[Er])?r[Er]:[]}function BR(r){return Array.isArray(r?.[Fa])?r[Fa]:[]}function NR(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function MR(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>_o.matches(e)?!0:di(e)),r}function Uw(r){if(Gi(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getComponents().findLast(s=>s.code===ce)?.value;t=n==null?void 0:yi(n),e.forEach(s=>{if(!zl(s))throw new fd("Invalid multiaddr");const i=s.getComponents().findLast(o=>o.code===ce)?.value;if(i==null){if(t!=null)throw new V("Multiaddrs must all have the same peer id or have no peer id")}else{const o=yi(i);if(t?.equals(o)!==!0)throw new V("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!cT.exactMatch(n)),{peerId:t,multiaddrs:e}}const OR=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function $R(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??OR;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function Ku(r){const e=qe(r);let t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new V(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new V(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new Hy(e.host,t)}function Vw(r){return!fi.exactMatch(r)}function Kw(r,e,t){if(r==null||e==null)return;const n=e.sort((i,o)=>i.direct?-1:o.direct?1:0).find(i=>i.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(i=>Vw(i)))return n}class FR{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Ku(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new ks;for(const c of e){const d=c.remotePeer;if(!s.has(d)){s.set(d,0);try{const f=await this.peerStore.get(d);s.set(d,[...f.tags.values()].reduce((a,u)=>a+u.value,0))}catch(f){f.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",f)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),l=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(f=>{if(_r(c.remoteAddr)){const a=qe(c.remoteAddr);return f.contains(a.host)}return!0})||l.push(c),l.length===o)break;await Promise.all(l.map(async c=>{await $R(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:l})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const qw=1e4,Hw=1e3,UR=1e4,_l=1e4,zw=25,VR=5,KR=10,qR=5,HR="last-dial-failure",zR="last-dial-success",Ww=500,WR=32,GR=100,Gw=50;function YR(r,e){const t=Qa.exactMatch(r.multiaddr),n=Qa.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=Ja.exactMatch(r.multiaddr),i=Ja.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=_o.exactMatch(r.multiaddr),l=_o.exactMatch(e.multiaddr);if(o&&!l)return-1;if(!o&&l)return 1;const c=Jh.exactMatch(r.multiaddr),d=Jh.exactMatch(e.multiaddr);if(c&&!d)return-1;if(!c&&d)return 1;const f=jh.exactMatch(r.multiaddr),a=jh.exactMatch(e.multiaddr);if(f&&!a)return-1;if(!f&&a)return 1;const u=Qh.exactMatch(r.multiaddr),h=Qh.exactMatch(e.multiaddr);return u&&!h?-1:!u&&h?1:0}function XR(r,e){const t=Pu(r.multiaddr),n=Pu(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function ZR(r,e){const t=di(r.multiaddr),n=di(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function jR(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function QR(r,e){const t=fi.exactMatch(r.multiaddr),n=fi.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function JR(r){return r.sort(YR).sort(jR).sort(QR).sort(ZR).sort(XR)}class eB extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"}function Yw(r){const e=[Fn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const Xw=60;function Zw(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Fn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Fn[e.type],TTL:e.TTL??e.ttl??Xw,data:e.data instanceof Uint8Array?W(e.data):e.data}))}}const tB=4;function Kp(r,e={}){const t=new Gv({concurrency:e.queryConcurrency??tB});return async(n,s={})=>{const i=new URLSearchParams;i.set("name",n),Yw(s.types).forEach(l=>{i.append("type",Fn[l])}),s.onProgress?.(new nt("dns:query",n));const o=await t.add(async()=>{const l=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(l.status!==200)throw new Error(`Unexpected HTTP status: ${l.status} - ${l.statusText}`);const c=Zw(await l.json());return s.onProgress?.(new nt("dns:response",c)),c},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function rB(){return[Kp("https://cloudflare-dns.com/dns-query"),Kp("https://dns.google/resolve")]}var Oc,qp;function nB(){return qp||(qp=1,Oc=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}),Oc}var sB=nB();const iB=od(sB);class oB{lru;constructor(e){this.lru=iB(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return Zw({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:l})=>({...l,TTL:Math.round((o-Date.now())/1e3),type:Fn[l.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??Xw)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function aB(r){return new oB(r)}const lB=1e3;class cB{resolvers;cache;constructor(e){this.resolvers={},this.cache=aB(e.cacheSize??lB),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=rB())}async query(e,t={}){const n=Yw(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new nt("dns:cache",s)),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),l=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const d=await c(e,{...t,types:n});for(const f of d.Answer)this.cache.add(e,f);return d}catch(d){l.push(d),t.onProgress?.(new nt("dns:error",d))}}throw new eB(l,`DNS lookup of ${e} ${n} failed`)}}var Fn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Fn||(Fn={}));function uB(r={}){return new cB(r)}class dB{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Fn.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,l=[];for(const c of i.Answer){const d=c.data.replace(/["']/g,"").trim().split("=")[1];d!=null&&(o!=null&&!d.includes(o)||l.push(he(d)))}return l}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=uB()),this.dns)}}const jw=new dB;async function Qw(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??WR))throw new kR("Max recursive depth reached");let s=!1;const i=[];for(const o of Object.values(e))if(o.canResolve(r)){s=!0;const l=await o.resolve(r,t);for(const c of l)i.push(...await Qw(c,e,{...t,depth:n+1}))}return s===!1&&i.push(r),i}const Oi={maxParallelDials:Gw,maxDialQueueLength:Ww,maxPeerAddrsToDial:zw,dialTimeout:qw,resolvers:{dnsaddr:jw}};class fB{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Oi.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Oi.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Oi.dialTimeout,this.connections=t.connections??new ks,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Oi.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new RC({concurrency:t.maxParallelDials??Oi.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==co.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=Uw(e);if(n!=null&&t.force!==!0){const o=Kw(n,this.connections.get(n),s);if(o!=null)return this.log("already connected to %a",o.remoteAddr),t.onProgress?.(new nt("dial-queue:already-connected")),o}const i=this.queue.queue.find(o=>{if(n?.equals(o.options.peerId)===!0)return!0;const l=o.options.multiaddrs;if(l==null)return!1;for(const c of s)if(l.has(c.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(const o of s)i.options.multiaddrs.add(o.toString());return t.onProgress?.(new nt("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ma("Dial queue is full");return this.log("creating dial target for %p",n,s.map(o=>o.toString())),t.onProgress?.(new nt("dial-queue:add-to-dial-queue")),this.queue.add(async o=>{o.onProgress?.(new nt("dial-queue:start-dial"));const l=vs([this.shutDownController.signal,o.signal]);try{return await this.dialPeer(o,l)}finally{l.clear()}},{peerId:n,priority:t.priority??Jw,multiaddrs:new Set(s.map(o=>o.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,l=0,c=0;const d=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const f=[],a=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...a]);const u=await this.calculateMultiaddrs(n,a,{...e,signal:t});for(const h of u){if(i.has(h.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",h.multiaddr,n);continue}f.push(h)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,f.map(h=>h.multiaddr.toString())),e?.onProgress?.(new nt("dial-queue:calculated-addresses",f));for(const h of f){if(l===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",l,e.peerId),new ma("Peer had more than maxPeerAddrsToDial");l++;try{const p=await this.components.transportManager.dial(h.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",h.multiaddr);try{await this.components.peerStore.merge(p.remotePeer,{multiaddrs:[p.remoteAddr],metadata:{[zR]:j(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}return p}catch(p){if(this.log.error("dial failed to %a - %e",h.multiaddr,p),i.add(h.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[HR]:j(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}if(t.aborted)throw new jx(p.message);d.push(p)}}}throw d.length===1?d[0]:new AggregateError(d,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(a=>({multiaddr:he(a),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ma("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new Vp("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const a=await this.components.peerStore.get(e);s.push(...a.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:u})=>u.toString()))}catch(a){if(a.name!=="NotFoundError")throw a}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const a=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:u})=>u.toString())),s.push(...a.multiaddrs.map(u=>({multiaddr:u,isCertified:!1})))}catch(a){a.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,a)}}}let i=(await Promise.all(s.map(async a=>{const u=await Qw(a.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return u.length===1&&u[0].equals(a.multiaddr)?a:u.map(h=>({multiaddr:h,isCertified:!1}))}))).flat();if(e!=null){const a=`/p2p/${e.toString()}`;i=i.map(u=>u.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:u.multiaddr.encapsulate(a),isCertified:u.isCertified}:u)}const o=i.filter(a=>{if(this.components.transportManager.dialTransportForMultiaddr(a.multiaddr)==null)return!1;const u=a.multiaddr.getComponents().findLast(h=>h.code===ce)?.value;return e!=null&&u!=null?e.equals(u):!0}),l=new Map;for(const a of o){const u=a.multiaddr.toString(),h=l.get(u);if(h!=null){h.isCertified=h.isCertified||a.isCertified||!1;continue}l.set(u,a)}const c=[...l.values()];if(c.length===0)throw new ER("The dial request has no valid addresses");const d=[];for(const a of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(a.multiaddr)||d.push(a);const f=this.addressSorter==null?JR(d):d.sort(this.addressSorter);if(f.length===0)throw new Vp("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:a})=>a.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",f.map(({multiaddr:a})=>a.toString())),f}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!fi.matches(s.multiaddr))!=null:!0}catch{}return!1}}const hB=Object.prototype.toString,pB=r=>hB.call(r)==="[object Error]",gB=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function mB(r){if(!(r&&pB(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:gB.has(t)}function yB(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function fa(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be â‰¥ ${t}.`)}}class bB extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function vB(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function Hp(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function wB({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){const i=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(i instanceof bB)throw i.originalError;const o=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,l=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:i,attemptNumber:e,retriesLeft:o,retriesConsumed:t});if(await s.onFailedAttempt(c),Hp(n,l)<=0)throw i;const d=await s.shouldConsumeRetry(c),f=Hp(n,l);if(f<=0||o<=0)throw i;if(i instanceof TypeError&&!mB(i)){if(d)throw i;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw i;if(!d)return s.signal?.throwIfAborted(),!1;const a=vB(t,s),u=Math.min(a,f);return s.signal?.throwIfAborted(),u>0&&await new Promise((h,p)=>{const y=()=>{clearTimeout(g),s.signal?.removeEventListener("abort",y),p(s.signal.reason)},g=setTimeout(()=>{s.signal?.removeEventListener("abort",y),h()},u);s.unref&&g.unref?.(),s.signal?.addEventListener("abort",y,{once:!0})}),s.signal?.throwIfAborted(),!0}async function _B(r,e={}){if(e={...e},yB(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,fa("factor",e.factor,{min:0,allowInfinity:!1}),fa("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),fa("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),fa("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0;const s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();const i=await r(t);return e.signal?.throwIfAborted(),i}catch(i){await wB({error:i,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}class SB{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Zd({concurrency:t.maxParallelReconnects??qR,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);zp(t)&&(this.queue.has(e)||this.queue.add(async n=>{await _B(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(hd)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>zp(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}}function zp(r){for(const e of r.tags.keys())if(e.startsWith(hd))return!0;return!1}const Jw=50,$c={maxConnections:GR,inboundConnectionThreshold:VR,maxIncomingPendingConnections:KR};class EB{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??$c.maxConnections,this.maxConnections<1)throw new V("Connection Manager maxConnections must be greater than 0");this.connections=new ks,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Ku(he(n))),this.deny=(t.deny??[]).map(n=>Ku(he(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??$c.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new BC({points:t.inboundConnectionThreshold??$c.inboundConnectionThreshold,duration:1}),this.connectionPruner=new FR({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>he(n))}),this.dialQueue=new fB(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??Gw,maxDialQueueLength:t.maxDialQueueLength??Ww,maxPeerAddrsToDial:t.maxPeerAddrsToDial??zw,dialTimeout:t.dialTimeout??qw,resolvers:t.resolvers??{dnsaddr:jw},connections:this.connections}),this.reconnectQueue=new SB({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const l=`${o.direction} ${o.protocol??"unnegotiated"}`;i[l]=(i[l]??0)+1}for(const[o,l]of Object.entries(i))e[o]=e[o]??[],e[o].push(l)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,l)=>o-l);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Lm(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Rm(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push(Promise.all([fr(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(s=>{n.abort(s)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new V("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new uo("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n,multiaddrs:s}=Uw(e);if(this.peerId.equals(n))throw new Pm("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const c=Kw(n,this.getConnections(n),s);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new nt("dial-queue:already-connected")),c}const i=await this.dialQueue.dial(e,{...t,priority:t.priority??Jw});if(i.status!=="open")throw new yu("Remote closed connection during opening");let o=this.connections.get(i.remotePeer);o==null&&(o=[],this.connections.set(i.remotePeer,o));let l=!1;for(const c of o)if(c.id===i.id&&(l=!0),t.force!==!0&&c.id!==i.id&&c.remoteAddr.equals(i.remoteAddr))return i.abort(new fd("Duplicate multiaddr connection")),c;return l||o.push(i),i}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await Promise.all([fr(s,"close",t),s.close(t)])}catch(i){s.abort(i)}}))}acceptIncomingConnection(e){if(this.deny.some(s=>{if(_r(e.remoteAddr)){const i=qe(e.remoteAddr);return s.contains(i.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>{if(_r(e.remoteAddr)){const i=qe(e.remoteAddr);return s.contains(i.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(_r(e.remoteAddr)){const s=qe(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(s.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>he(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const xB=1e4,AB="1.0.0",IB="ping",kB="ipfs",Wp=32,CB=!0;class TB{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??kB}/${IB}/${AB}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??xB,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??CB,this.timeout=new Uk({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[Er]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=ib(s);t=Date.now(),await Promise.all([i.write(li(Wp),{signal:n}),i.read({bytes:Wp,signal:n})]),e.rtt=Date.now()-t,await s.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}class PB{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Mc("No content routers available");const n=this,s=new fs;for await(const i of lu(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new Mc("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Mc("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new uo;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new uo;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}class DB{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:W(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Up("No peer routers available");if(e.toString()===this.peerId.toString())throw new bR("Should not try to find self");const n=this,s=lu(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>(async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error("router failed to find peer - %e",o)}})()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new Ma}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Up("No peer routers available");const n=this,s=mo(1024);for await(const i of kD((async function*(){const o=lu(...n.routers.filter(l=>l.getClosestPeers instanceof Function).map(l=>l.getClosestPeers(e,t)));for await(let l of o)yield async()=>{if(l.multiaddrs.length===0)try{l=await n.findPeer(l.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return l}})()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class LB extends Dt{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=vs([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=cr(),yield(await fr(this,"walk:peer",{signal:t,rejectionEvents:["walk:error"]})).detail}catch(n){throw n.detail!=null?n.detail:n}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=vs([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=li(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Ct(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored - %e",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored - %e",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const e0=32,t0=64;class RB{log;topologies;handlers;components;middleware;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=un({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new vR(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new wR(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:e0,maxOutboundStreams:t0,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new V("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{const s=await this.components.peerStore.get(t,n);for(const i of s.protocols){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{l.filter?.has(t)!==!1&&(l.filter?.remove(t),await l.onDisconnect?.(t))}))}}catch(s){if(s.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,s)}}async _onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));try{for(const i of s){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{l.filter?.has(t.id)!==!1&&(l.filter?.remove(t.id),await l.onDisconnect?.(t.id))}))}}catch(i){this.log.error("could not inform topologies of updated peer %p - %e",t.id,i)}}async _onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;try{for(const i of t){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{n.limits!=null&&l.notifyOnLimitedConnection!==!0||l.filter?.has(s)!==!0&&(l.filter?.add(s),await l.onConnect?.(s,n))}))}}catch(i){this.log.error("could not inform topologies of updated peer after identify %p - %e",s,i)}}}class BB{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=un({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=un({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??$a.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new V("Transport must have a valid tag");if(this.transports.has(t))throw new V(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new IR(`No transport available for address ${String(e)}`);return t?.onProgress?.(new nt("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new uo("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new _R)});const n=[];for(const[i,o]of this.transports.entries()){const l=o.listenFilter(e);for(const c of l){this.log("creating listener for %s on %a",i,c);const d=o.createListener({upgrader:this.components.upgrader});let f=this.listeners.get(i)??[];f==null&&(f=[],this.listeners.set(i,f)),f.push(d),d.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:d})}),d.addEventListener("close",()=>{const a=f.findIndex(u=>u===d);f.splice(a,1),this.components.events.safeDispatchEvent("transport:close",{detail:d})}),Xh.matches(c)?t.ipv4.attempts++:Zh.matches(c)&&t.ipv6.attempts++,n.push(d.listen(c).then(()=>{t.errors.delete(c.toString()),Xh.matches(c)&&t.ipv4.success++,Zh.matches(c)&&t.ipv6.success++},a=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,a),t.errors.set(c.toString(),a),a}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===$a.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new SR(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${NB(o)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}function NB(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}const ss="/multistream/1.0.0",r0=1024,MB=j(`
`);async function qu(r,e){const n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==MB[0])throw new $e("Missing newline");return W(n).trimEnd()}async function Hu(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");const n=r.log.newScope("mss:select"),s=Xd(r,{...t,maxDataLength:r0});for(let i=0;i<e.length;i++){const o=e[i];let l;if(i===0){n.trace('write ["%s", "%s"]',ss,o);const c=j(`${ss}
`),d=j(`${o}
`);if(await s.writeV([c,d],t),n.trace("reading multistream-select header"),l=await qu(s,t),n.trace('read "%s"',l),l!==ss){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',o),await s.write(j(`${o}
`),t);if(n.trace("reading protocol response"),l=await qu(s,t),n.trace('read "%s"',l),l===o)return n.trace('selected "%s" after negotiation',l),s.unwrap(),o}throw new Zx(`Protocol selection failed - could not negotiate ${e}`)}const n0=1024*1024*4;class OB extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}function $B(r){return r[Symbol.asyncIterator]!=null}function s0(r,e){if(r.byteLength>e)throw new OB("Message length too long")}const Jl=r=>{const e=xr(r),t=on(e);return Zi(r,t),Jl.bytes=e,t};Jl.bytes=0;function i0(r,e){e=e??{};const t=e.lengthEncoder??Jl,n=e?.maxDataLength??n0;function*s(i){s0(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return $B(r)?(async function*(){for await(const i of r)yield*s(i)})():(function*(){for(const i of r)yield*s(i)})()}i0.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Jl,n=e?.maxDataLength??n0;return s0(r,n),new Ne(t(r.byteLength),r)};var Gp;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Gp||(Gp={}));async function zu(r,e,t={}){e=Array.isArray(e)?e:[e];const n=r.log.newScope("mss:handle"),s=Xd(r,{...t,maxDataLength:r0,maxLengthLength:2});for(;;){n.trace("reading incoming string");const i=await qu(s,t);if(n.trace('read "%s"',i),i===ss){n.trace('respond with "%s" for "%s"',ss,i),await s.write(j(`${ss}
`),t),n.trace('responded with "%s" for "%s"',ss,i);continue}if(e.includes(i))return n.trace('respond with "%s" for "%s"',i,i),await s.write(j(`${i}
`),t),n.trace('responded with "%s" for "%s"',i,i),s.unwrap(),i;if(i==="ls"){const o=new Ne(...e.map(l=>i0.single(j(`${l}
`))),j(`
`));n.trace('respond with "%s" for %s',e,i),await s.write(o,t),n.trace('responded with "%s" for %s',e,i);continue}n.trace('respond with "na" for "%s"',i),await s.write(j(`na
`),t),n('responded with "na" for "%s"',i)}}class FB extends Dt{id;remoteAddr;remotePeer;direction;timeline;direct;multiplexer;encryption;limits;log;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;closeTimeout;constructor(e,t){super(),this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.timeline=t.maConn.timeline,this.encryption=t.cryptoProtocol,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??_l,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??_l,this.closeTimeout=t.closeTimeout??Hw,this.direct=Vw(t.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(n=>n.code===ce)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),t.muxer!=null&&(this.multiplexer=t.muxer.protocol,this.muxer=t.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",n=>{this.dispatchEvent(new Ol(n.local,n.error))})}[Symbol.toStringTag]="Connection";[Wx]=!0;get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}newStream=async(e,t={})=>{if(this.muxer==null)throw new wa("Connection is not multiplexed");if(this.muxer.status!=="open")throw new yu(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new yu(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new hh("Cannot open protocol stream on limited connection");Array.isArray(e)||(e=[e]),this.log.trace("starting new stream for protocols %s",e);const n=await this.muxer.createStream({...t,protocol:e.length===1?e[0]:void 0});this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const l=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:l}}n.protocol===""?(n.log.trace("selecting protocol from protocols %s",e),n.protocol=await Hu(n,e,t),n.log("negotiated protocol %s",n.protocol)):n.log("pre-negotiated protocol %s",n.protocol);const s=KB(n.protocol,this.components.registrar,t),i=Yp(n.protocol,"outbound",this);if(i>s){const l=new Dm(`Too many outbound protocol streams for protocol "${n.protocol}" - ${i}/${s}`);throw n.abort(l),l}await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]}),this.components.metrics?.trackProtocolStream(n);const o=this.components.registrar.getMiddleware(n.protocol);return await this.runMiddlewareChain(n,this,o)}catch(s){throw n.status==="open"?n.abort(s):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,s),s}};async onIncomingStream(e){const t=e.detail,n=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);t.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(t.protocol===""){const d=this.components.registrar.getProtocols();t.log.trace("selecting protocol from protocols %s",d),t.protocol=await zu(t,d,{signal:n}),t.log("negotiated protocol %s",t.protocol)}else t.log("pre-negotiated protocol %s",t.protocol);const s=VB(t.protocol,this.components.registrar);if(Yp(t.protocol,"inbound",this)>s)throw new Qx(`Too many inbound protocol streams for protocol "${t.protocol}" - limit ${s}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[t.protocol]},{signal:n}),this.components.metrics?.trackProtocolStream(t);const{handler:o,options:l}=this.components.registrar.getHandler(t.protocol);if(this.limits!=null&&l.runOnLimitedConnection!==!0)throw new hh("Cannot open protocol stream on limited connection");const c=this.components.registrar.getMiddleware(t.protocol);c.push(async(d,f,a)=>{await o(d,f),a(d,f)}),await this.runMiddlewareChain(t,this,c)}catch(s){t.abort(s)}}async runMiddlewareChain(e,t,n){for(let s=0;s<n.length;s++){const i=n[s];e.log.trace("running middleware",s,i),await new Promise((o,l)=>{try{const c=i(e,t,(d,f)=>{e=d,t=f,o()});c instanceof Promise&&c.catch(l)}catch(c){l(c)}}),e.log.trace("ran middleware",s,i)}return e}async close(e={}){if(this.log("closing connection to %a",this.remoteAddr),e.signal==null){const t=AbortSignal.timeout(this.closeTimeout);e={...e,signal:t}}await this.muxer?.close(e),await this.maConn.close(e)}abort(e){this.muxer?.abort(e),this.maConn.abort(e)}}function UB(r,e){return new FB(r,e)}function VB(r,e){try{const{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return e0}function KB(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??t0}function Yp(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class qB{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;connectionCloseTimeout;constructor(e,t){this.components=e,this.connectionEncrypters=un({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=un({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??UR,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??_l,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??_l,this.connectionCloseTimeout=t.connectionCloseTimeout??Hw,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new xR(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return vs([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new AR("Connection denied");await Ct(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getComponents().findLast(o=>o.code===ce)?.value;let s;n!=null&&(s=yi(n),await Ct(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s=e,i,o,l,c;const d=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${d}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){const a=this.components.connectionProtector;a!=null&&(e.log("protecting the %s connection",t),s=await a.protect(s,n))}try{if(HB(n)){if(n.remotePeer==null)throw new fd(`${t} connection that skipped encryption must have a peer id`);c="native",i=n.remotePeer}else{const a=e.remoteAddr.getComponents().findLast(h=>h.code===ce)?.value;let u;a!=null&&(u=yi(a)),n?.onProgress?.(new nt(`upgrader:encrypt-${t}-connection`)),{connection:s,remotePeer:i,protocol:c,streamMuxer:o}=await(t==="inbound"?this._encryptInbound(s,{...n,remotePeer:u}):this._encryptOutbound(s,{...n,remotePeer:u}))}if(i.equals(this.components.peerId)){const a=new Pm("Can not dial self");throw e.abort(a),a}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,e),n?.muxerFactory!=null?o=n.muxerFactory:o==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new nt(`upgrader:multiplex-${t}-connection`)),o=await(t==="inbound"?this._multiplexInbound(s,this.streamMuxers,n):this._multiplexOutbound(s,this.streamMuxers,n)))}catch(a){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,a),a}o!=null&&(e.log("create muxer %s",o.protocol),l=o.createStreamMuxer(s)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e);const f=this._createConnection({id:d,cryptoProtocol:c,direction:t,maConn:e,stream:s,muxer:l,remotePeer:i,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return f.log("successfully upgraded connection"),f}_createConnection(e){const t=UB(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const s=await zu(e,n,t),i=this.connectionEncrypters.get(s);if(i==null)throw new da(`no crypto module found for ${s}`);return e.log("encrypting inbound connection using %s",s),{...await i.secureInbound(e,t),protocol:s}}catch(s){throw new da(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const s=await Hu(e,n,t),i=this.connectionEncrypters.get(s);if(i==null)throw new da(`no crypto module found for ${s}`);return e.log("encrypting outbound connection using %s",s),{...await i.secureOutbound(e,t),protocol:s}}catch(s){throw new da(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const i=await Hu(e,s,n),o=t.get(i);if(o==null)throw new wa(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),o}catch(i){throw e.log.error("error multiplexing outbound connection - %e",i),new wa(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{e.log.trace("selecting stream muxer from %s",s);const i=await zu(e,s,n),o=t.get(i);if(o==null)throw new wa(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),o}catch(i){throw e.log.error("error multiplexing inbound connection - %e",i),i}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}function HB(r){return r.skipEncryption===!0}const o0="3.1.2",a0="js-libp2p";function zB(r,e){return`${r??a0}/${e??o0} browser/${globalThis.navigator.userAgent}`}class WB extends Dt{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new Dt,n=t.dispatchEvent.bind(t);t.dispatchEvent=d=>{const f=n(d),a=this.dispatchEvent(new CustomEvent(d.type,{detail:d.detail}));return f||a},this.peerId=e.peerId,this.logger=e.logger??ld(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??a0,i=e.nodeInfo?.version??o0,o=this.components=DR({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??zB(s,i)},logger:this.logger,events:t,datastore:e.datastore??new AE,connectionGater:MR(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",aR(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",d=>{if(d.detail.previous==null){const f={id:d.detail.peer.id,multiaddrs:d.detail.peer.addresses.map(a=>a.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:f})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new qB(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((d,f)=>this.configureComponent(`connection-encryption-${f}`,d(this.components))),streamMuxers:(e.streamMuxers??[]).map((d,f)=>this.configureComponent(`stream-muxers-${f}`,d(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:e.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new BB(this.components,e.transportManager)),this.configureComponent("connectionManager",new EB(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new TB(this.components,e.connectionMonitor)),this.configureComponent("registrar",new RB(this.components)),this.configureComponent("addressManager",new gR(this.components,e.addresses));const l=(e.peerRouters??[]).map((d,f)=>this.configureComponent(`peer-router-${f}`,d(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new DB(this.components,{routers:l}));const c=(e.contentRouters??[]).map((d,f)=>this.configureComponent(`content-router-${f}`,d(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new PB(this.components,{routers:c})),this.configureComponent("randomWalk",new LB(this.components)),(e.peerDiscovery??[]).forEach((d,f)=>{this.configureComponent(`peer-discovery-${f}`,d(this.components)).addEventListener("peer",u=>{this.#e(u)})}),e.transports?.forEach((d,f)=>{this.components.transportManager.add(this.configureComponent(`transport-${f}`,d(this.components)))}),e.services!=null)for(const d of Object.keys(e.services)){const f=e.services[d],a=f(this.components);if(a==null){this.log.error("service factory %s returned null or undefined instance",d);continue}this.services[d]=a,this.configureComponent(d,a),a[uh]!=null&&(this.log("registering service %s for content routing",d),c.push(a[uh])),a[ph]!=null&&(this.log("registering service %s for peer routing",d),l.push(a[ph])),a[Oa]!=null&&(this.log("registering service %s for peer discovery",d),a[Oa].addEventListener?.("peer",u=>{this.#e(u)}))}LR(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(e){throw this.log.error("an error occurred starting libp2p - %e",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new fs;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new V("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new V("no protocols were provided to open a stream");return this.components.connectionManager.openStream(e,t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){zl(e)&&(e=yi(e.getComponents().findLast(n=>n.code===ce)?.value??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=an([j("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=qn(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}use(e,t){this.components.registrar.use(e,Array.isArray(t)?t:[t])}unuse(e){this.components.registrar.unuse(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error("could not update multiaddrs of discovered peer - %e",n)})}}async function GB(r={}){r.privateKey??=await Ly("Ed25519");const e=new WB({...await IL(r),peerId:_L(r.privateKey)});return r.start!==!1&&await e.start(),e}function l0(r){return r.toLowerCase().replace(/[^a-z0-9@&$!?\-+=.:/_]/g,"")}function Xp(r){return r.replace(/[^a-z0-9./:_-]/gi,"")}function Fc(r){try{const t=he(r).toString();return t.includes("/p2p/")?t:null}catch{return null}}async function c0(r={}){const{type:e,moves:t,playerName:n,timestamp:s,value:i}=r;if(!e||typeof e!="string")throw new Error(["RECORD VALIDATION: BAD TYPE!",r]);if(!t||!(Array.isArray(t)||typeof t=="string"))throw new Error(["RECORD VALIDATION: BAD MOVES!",r]);if(t.length>PS)throw new Error(["RECORD VALIDATION: MOVES TOO LONG!",r]);if(!n||typeof n!="string")throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",r]);if(l0(n)!==n)throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",r]);if(typeof s!="number"||!Number.isFinite(s))throw new Error(["RECORD VALIDATION: BAD TIMESTAMP!",r]);if(typeof i!="number"||!(i>0))throw new Error(["RECORD VALIDATION: BAD VALUE!",r]);return new Promise((o,l)=>{let c=null;const d=setTimeout(()=>{c&&c(),l(["RECORD VALIDATION: TIMEOUT!",r])},3e3),f=u=>(u.get=()=>Si(u),u),a=am({cardsStore:f(ir(De.cards)),energyStore:f(ir(De.energy)),logStore:f(ir(De.log)),matchedIndexesStore:f(ir(De.matchedIndexes)),movesStore:f(Ui(t)),optionsStore:f(Ui({playerName:n,cluster:!1,rapid:!0})),phaseStore:f(ir(De.phase)),plusIndexStore:f(ir(De.plusIndex)),recordsStore:f(ir({...De.records})),scoreStore:f(ir(De.score)),seedStore:f(Ui(im(r))),timestampStore:f(Ui(s))});c=a.recordsStore.subscribe(u=>{const{movesInitial:h,phaseStore:p}=a;if(h!==null&&p.get()!==te.gameOver)return;clearTimeout(d),c&&c();const y=u[e][U.value];let g={type:e,moves:t,playerName:n,timestamp:s,value:i};y>=i?(g.value=y,o(g)):l(["RECORD VALIDATION: WRONG VALUE!",g,y])})})}let In=-1,Re;const YB=new Set,XB=await dx(U.leaderboard),ec=Object.fromEntries(await Promise.all(Do.map(async r=>[r,await XB(r,[])]))),Qt=new CS({recordTypes:Do,maxRecords:at,debug:Rn,validateRecord:c0,onUpdate:(r,e)=>{ec[r].set(e)}});async function u0(r){try{const e=ru(r);if(Rn&&console.log("handleRecordMessage:",e?.type,e?.playerName,e?.value),e){const t=await Qt.handleRecordWithValidation(e);Rn&&console.log("Record validation result:",t)}}catch(e){Rn&&console.error("handleRecordMessage error:",e)}}const ZB=Qt.createPushPreview(u0),d0=Qt.createPushRoot(u0),jB=Qt.createRootHandler(ZB),QB=Qt.createPreviewHandler();function JB(){const r=Ml.get();return r.length===0?null:((In===-1||In>=r.length)&&(In=Math.floor(Math.random()*r.length)),r[In])}async function eN({detail:r}){const e=r.remotePeer.toString();Rn&&console.log("connection:open",e),!Ml.get().includes(e)&&r.status==="open"&&await d0(r)}async function tN({detail:{from:r}}){Rn&&console.log("pubsub:message",r.toString(),r.equals(Re.peerId)?"local":"remote"),Re.getConnections(r).length===0&&Re.dial(r).catch(()=>{})}async function rN(){if(Re?.status!=="started"||Re.getConnections().length>0)return;const r=Mo.get();if(r.length!==0)return Rn&&console.log("restoreRelay"),In=(In+1)%r.length,Re.dial(he(r[In])).catch(e=>{console.error("Failed to restore relay",e)})}async function f0(){Re&&await Re.stop();const r=new Sm("keystore");await r.open();const e=await QP(r);Re=await GB({privateKey:e,addresses:{listen:["/p2p-circuit"]},transports:[mL(),EP()],connectionEncrypters:[QD()],streamMuxers:[ZC()],peerDiscovery:[ET({list:Mo.get()}),aL({interval:13e3,topics:["digifall._peer-discovery"],listenOnly:!1})],connectionGater:{denyDialMultiaddr:()=>!1,denyDialPeer(t){const n=t.toString();return YB.has(n)||Re.getConnections().length>=3||Re.getConnections().some(({remotePeer:i,status:o})=>i.toString()===n&&o!=="closed")?!0:TS?!1:Ml.get().includes(n)?n!==JB():!1},denyInboundConnection(){return Re.getConnections().length>=5}},services:{identify:qD({protocolPrefix:"digifall"}),pubsub:ID({emitSelf:!0}),keychain:Wv()}}),Re.services.pubsub.addEventListener("message",tN),Re.addEventListener("connection:open",eN),Re.handle(Fs.root,jB,{runOnLimitedConnection:!0}),Re.handle(Fs.preview,QB,{runOnLimitedConnection:!0}),Rn&&(window.libp2p=Re),mt.get().leaderboard&&await Re.start()}setInterval(()=>rN().catch(()=>{}),73e3);const nN=h0(()=>{if(!Re)return;const r=Ml.get();Re.getConnections().filter(({remotePeer:e,status:t})=>t==="open"&&!r.includes(e.toString())).forEach(d0)},5e3);Do.forEach(r=>{const e=ec[r];e.subscribe(async t=>{if(!(!t||t.length===0)){if(Qt.getData(r).length>0){const n=Qt.getRoots()[r];return Qt.updateRoot(r),n!==Qt.getRoots()[r]&&Re&&nN()}Promise.allSettled(t.map(n=>c0(n).then(s=>Qt.handleRecord(s)))).then(()=>e.set(Qt.getData(r)))}})});Bo.subscribe(r=>{const e=hn.get();e!==te.idle&&e!==te.gameOver||Do.forEach(t=>{const n=r[t];n[U.value]!==0&&(n[U.type]=t,Qt.handleRecord(n),ec[t].set(Qt.getData(t)))})});let Zp=!1;const sN=p0(()=>f0(),3e3);Mo.subscribe(()=>{if(!Zp){Zp=!0,f0().catch(console.error);return}In=-1,sN()});let jp=mt.get().leaderboard;const iN=p0(async r=>{r&&Re&&Re.status!=="started"&&await Re.start(),!r&&Re&&Re.status==="started"&&await Re.stop()},3e3);mt.subscribe(({leaderboard:r})=>{r!==jp&&(jp=r,iN(r))});function h0(r,e){let t=0,n=null;return((...s)=>{const i=Date.now();if(i-t>=e)return t=i,clearTimeout(n),n=null,r(...s);clearTimeout(n),n=setTimeout(()=>{t=Date.now(),n=null,r(...s)},e-(i-t))})}function p0(r,e){let t;return((...n)=>{clearTimeout(t),t=setTimeout(()=>r(...n),e)})}var oN=se("<li> </li>"),aN=se('<div><div class="place svelte-fan1x6"> </div> <div> </div> <div></div> <div> </div></div>'),lN=se('<div class="leaderboard content"><div class="section-1"><div class="types svelte-fan1x6" title="[switch leaderboard]" tabindex="0" role="button"><span>combos</span> <span class="high svelte-fan1x6">high &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span> <span>scores</span></div></div> <div class="section-2"><ul class="pages svelte-fan1x6" title="[select page]" tabindex="0" role="button"></ul></div> <div class="section-3 board svelte-fan1x6" tabindex="-1"><!></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>');function cN(r,e){dt(e,!0);const t=()=>fe(b(h),"$leaderboardStore",s),n=()=>fe(mt,"$optionsStore",s),[s,i]=tr(),o=100,l=Math.ceil(at/o)+1;let c=le(0),d=le(Qr(U.highScore)),f=le(0),a=le(0),u=le(null),h=ie(()=>ec[b(d)]),p=ie(()=>t().slice().sort((K,ee)=>sd(ee,K)).slice(0,at)),y=ie(()=>[...b(p).map((K,ee)=>({place:ee===999?0:ee+1,...K})),...Array.from({length:at-b(p).length}).map((K,ee,ge)=>({place:ee===ge.length-1?0:ee+b(p).length+1,playerName:"",value:0}))]),g=ie(()=>b(p).findIndex(({playerName:K})=>K===n()[U.playerName])),m=ie(()=>b(u)?h0(b(u).scrollToIndex,250):()=>{});st(()=>{D(b(a))}),st(()=>{Q()});function w(K){X(d,b(d)===U.highScore?U.highCombo:U.highScore,!0)}function v(K){if(K)return X(c,b(c)<1?l-1:b(c)-1,!0),b(u).scrollToIndex(Math.max(b(c)*o-1,0)),b(c);b(m)(Math.max(b(f)-8,0),!0)}function _(K){if(K)return X(c,b(c)<l-1?b(c)+1:0,!0),b(u).scrollToIndex(Math.max(b(c)*o-1,0)),b(c);b(m)(Math.min(b(f)+8,at-1),!0)}function k(K){const ee=K.composedPath().find(({dataset:Me})=>Me&&Me.index);if(ee===void 0)return;X(c,Number(ee.dataset.index),!0);const ge=b(c)===0?0:b(c)===10?at-1:ee.dataset.index*100-1;b(u).scrollToIndex(ge)}function P(){Nt(Xe,de.menu)}function D(K){return K>=at-2?X(c,10):X(c,I(K),!0)}function I(K){return K>0&&K<at*.1?0:K>=100&&K<at*.2?1:K>=200&&K<at*.3?2:K>=300&&K<at*.4?3:K>=400&&K<at*.5?4:K>=500&&K<at*.6?5:K>=600&&K<at*.7?6:K>=700&&K<at*.8?7:K>=800&&K<at*.9?8:K>=900&&K<at?9:0}function x(K){return K===0&&b(g)===-1?"???":Array.from({length:3-K?.toString().length}).map(()=>"0").join("")+K}function B(K,ee){return ee===0&&b(g)===-1?n()[U.playerName]:K}function Q(){b(u).scrollToIndex(b(g)===-1?at-1:Math.max(b(g)-7,0))}var M={prevPage:v,nextPage:_},A=lN(),E=O(A),S=O(E);S.__click=w;var T=O(S);let C;var L=z(T,4);let R;var N=z(E,2),$=O(N);$.__click=k,Pn($,21,()=>Array.from({length:l}),ti,(K,ee,ge)=>{const Me=ie(()=>ge>9?0:ge);var tt=oN();let Oe;Dn(tt,"data-index",ge);let ht;var Vr=O(tt);Te(()=>{Oe=Ue(tt,1,"page svelte-fan1x6",null,Oe,{active:ge===b(c)}),ht=kt(tt,"",ht,{"--color":`var(--color-${b(Me)??""})`}),ze(Vr,b(Me))}),J(K,tt)});var q=z(N,2),F=O(q);Ze(zx(F,{get items(){return b(y)},get startIndex(){return b(f)},set startIndex(ee){X(f,ee,!0)},get endIndex(){return b(a)},set endIndex(ee){X(a,ee,!0)},children:(ee,ge)=>{let Me=()=>ge?.().place,tt=()=>ge?.().playerName,Oe=()=>ge?.().value;const ht=ie(()=>tt()===n()[U.playerName]),Vr=ie(()=>"place: "+Me()+`
name: `+tt()?.toUpperCase()+`
score: `+Oe());var Y=aN(),oe=O(Y);let ye;var pt=O(oe),nr=z(oe,2);let gr;var zn=O(nr),Ef=z(nr,2);let xf;var Af=z(Ef,2);let If;var m0=O(Af);Te((y0,b0,v0)=>{Ue(Y,1,Kg(["grid",{first:Me()===1,second:Me()===2,third:Me()===3}]),"svelte-fan1x6"),Dn(Y,"title",b(Vr)),ye=kt(oe,"",ye,y0),ze(pt,b0),gr=Ue(nr,1,"player-name svelte-fan1x6",null,gr,{self:b(ht)}),ze(zn,v0),xf=Ue(Ef,1,"bar svelte-fan1x6",null,xf,{self:b(ht)}),If=Ue(Af,1,"record svelte-fan1x6",null,If,{self:b(ht)}),ze(m0,Oe())},[()=>({color:`var(--color-${I(Me())??""})`}),()=>x(Me()),()=>B(tt(),Me())]),J(ee,Y)},$$slots:{default:!0}}),ee=>X(u,ee,!0),()=>b(u));var H=z(q,2),G=O(H),re=O(G);re.__click=P,Te(()=>{C=Ue(T,1,"type svelte-fan1x6",null,C,{active:b(d)===U.highCombo}),R=Ue(L,1,"type svelte-fan1x6",null,R,{active:b(d)===U.highScore})}),xe(5,S,()=>qt,()=>({y:-48})),xe(1,re,()=>qt,()=>({y:48})),xe(1,A,()=>Lr),J(r,A);var ne=ft(M);return i(),ne}Fr(["click"]);var uN=se('<span class="title"> </span>'),dN=se('<div class="dialog content"><div class="section-1"><!></div> <div class="section-2"></div> <div class="section-3"><!></div> <div class="section-4"></div></div>');function Sf(r,e){dt(e,!0);let t=Jr(e,"title",3,""),n=Jr(e,"visible",15,!1);function s(){n(!0)}function i(){n(!1)}var o={open:s,close:i},l=Xr(),c=rt(l);{var d=f=>{var a=dN(),u=O(a),h=O(u);{var p=m=>{var w=uN(),v=O(w);Te(()=>ze(v,t())),xe(1,w,()=>qt,()=>({y:-48})),J(m,w)};we(h,m=>{t()&&m(p)})}var y=z(u,4),g=O(y);$g(g,()=>e.children,()=>({visible:n(),open:s,close:i})),xe(1,y,()=>qt,()=>({y:24})),xe(1,a,()=>Lr),J(f,a)};we(c,f=>{n()&&f(d)})}return J(r,l),ft(o)}const fN="0.13.0";var hN=se('<span class="rapid svelte-p9o308">rapid</span>'),pN=se('<button class="svelte-p9o308">new game</button>'),gN=se('<button class="svelte-p9o308">resume</button> <button class="svelte-p9o308">new game</button>',1),mN=se('<button class="svelte-p9o308">p2p leaderboard</button>'),yN=se('<div class="menu content svelte-p9o308"><div class="section-1 svelte-p9o308"><h1 class="svelte-p9o308">digifall <!></h1></div> <div class="section-2 svelte-p9o308"></div> <div class="section-3 svelte-p9o308"><div class="col svelte-p9o308"><!> <!> <button class="svelte-p9o308">options</button></div></div> <div class="section-4 svelte-p9o308"></div></div> <span class="version svelte-p9o308"> </span> <a href="https://github.com/llblab/digifall" class="github-corner svelte-p9o308" aria-label="View source on GitHub"><svg viewBox="0 0 250 250" aria-hidden="true" class="svelte-p9o308"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" class="svelte-p9o308"></path><path class="octo-arm svelte-p9o308" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor"></path><path class="octo-body svelte-p9o308" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path></svg></a>',1),bN=se('<div class="col svelte-p9o308"><p class="svelte-p9o308">start a new game?</p> <div class="row svelte-p9o308"><button class="svelte-p9o308">yes</button> <button class="svelte-p9o308">no</button></div></div>'),vN=se("<!> <!>",1);function wN(r,e){dt(e,!0);const t=()=>fe(mt,"$optionsStore",s),n=()=>fe(hn,"$phaseStore",s),[s,i]=tr();let o=le(null),l=le(!1);st(()=>{t().playerName===""&&Nt(Xe,de.wellcome)});function c(){return b(o).visible}function d(){b(o).close()}function f(){Nt(Xe,null)}function a(){b(o).close(),dd()}function u(){Nt(Xe,de.leaderboard)}function h(){Nt(Xe,de.options)}var p={isNewGameDialog:c,closeNewGameDialog:d},y=vN(),g=rt(y);{var m=_=>{var k=yN(),P=rt(k),D=O(P),I=O(D),x=z(O(I));{var B=q=>{var F=hN();J(q,F)};we(x,q=>{t().rapid&&q(B)})}var Q=z(D,4),M=O(Q),A=O(M);{var E=q=>{var F=pN();F.__click=a,J(q,F)},S=q=>{var F=gN(),H=rt(F);H.__click=f;var G=z(H,2);G.__click=function(...re){b(o)?.open?.apply(this,re)},J(q,F)};we(A,q=>{n()===te.gameOver?q(E):q(S,!1)})}var T=z(A,2);{var C=q=>{var F=mN();F.__click=u,J(q,F)};we(T,q=>{t()[U.leaderboard]&&q(C)})}var L=z(T,2);L.__click=h;var R=z(P,2),N=O(R),$=z(R,2);Te(()=>ze(N,fN)),xe(5,P,()=>Lr),xe(5,R,()=>Lr),xe(5,$,()=>Lr),J(_,k)};we(g,_=>{b(l)||_(m)})}var w=z(g,2);Ze(Sf(w,{get visible(){return b(l)},set visible(_){X(l,_,!0)},children:(_,k)=>{var P=bN(),D=z(O(P),2),I=O(D);I.__click=a;var x=z(I,2);x.__click=function(...B){b(o).close?.apply(this,B)},J(_,P)},$$slots:{default:!0}}),_=>X(o,_,!0),()=>b(o)),J(r,y);var v=ft(p);return i(),v}Fr(["click"]);var _N=se('<span class="symbols">a-z 0-9 @&$!?-+=.:/_</span> <input class="player-name" type="text" inputmode="url" placeholder="player name" spellcheck="false" maxlength="42"/>',1);function g0(r,e){dt(e,!0);let t=Jr(e,"value",15,""),n=le(null),s=le("hidden"),i=ie(()=>"player name: "+t().toUpperCase());st(()=>{t()===""&&b(n)?.focus()});function o(h){const p=h.target.value,y=l0(p);X(s,p===y?"hidden":"visible",!0),h.target.value=y,t(y)}function l(h=400){X(s,"hidden"),b(n)&&(b(n).classList.toggle("blink"),setTimeout(()=>b(n).classList.toggle("blink"),h))}var c={blink:l},d=_N(),f=rt(d);let a;var u=z(f,2);return u.__input=o,Ze(u,h=>X(n,h),()=>b(n)),Te(()=>{a=kt(f,"",a,{visibility:b(s)}),Dn(u,"title",b(i)),Zc(u,t())}),J(r,d),ft(c)}Fr(["input"]);var SN=se('<div class="options content"><div class="section-1"><span>options</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <input type="checkbox" id="rapid" class="svelte-awxzgh"/> <label for="rapid" tabindex="0" role="button" class="svelte-awxzgh">rapid mode</label> <input type="checkbox" id="sound" class="svelte-awxzgh"/> <label for="sound" tabindex="0" role="button" class="svelte-awxzgh">sound effects</label> <input type="checkbox" id="leaderboard" class="svelte-awxzgh"/> <label for="leaderboard" tabindex="0" role="button" class="svelte-awxzgh">p2p leaderboard</label> <button class="suboption svelte-awxzgh">relays</button></div></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>'),EN=se('<div class="col exclam-fix"><p>new name detected!</p> <p>progress will be lost!</p> <div class="row"><button>accept</button> <button>reject</button></div></div>'),xN=se("<!> <!>",1);function AN(r,e){dt(e,!0);const t=()=>fe(mt,"$optionsStore",n),[n,s]=tr();let i=le(null),o=le(!1),l=le(null),c=ie(()=>t().playerName);function d(){return b(o)}function f(){b(i).close(),Nt(Bo,De.records),dd(b(c))}function a(){b(i).close(),X(c,t().playerName)}function u(){if(b(c)==="")return b(l).blink();if(b(c)!==t().playerName)return b(i).open();Nt(Xe,de.menu)}function h(){Nt(Xe,de.relays)}var p={isDialogVisible:d},y=xN(),g=rt(y);{var m=_=>{var k=SN(),P=O(k),D=O(P),I=z(P,4),x=O(I),B=O(x);Ze(g0(B,{get value(){return b(c)},set value($){X(c,$)}}),$=>X(l,$,!0),()=>b(l));var Q=z(B,2),M=z(Q,2),A=z(M,2);A.__click=()=>ha(mt,ct(t).sound=!t().sound,ct(t));var E=z(A,2),S=z(E,2),T=z(S,2),C=z(T,2);C.__click=h;var L=z(I,2),R=O(L),N=O(R);N.__click=u,Te(()=>{Dn(M,"title",`boring animations ${t().rapid?"disabled":"enabled"}`),Z_(A,t().sound),Dn(E,"title",`making sounds ${t().sound?"enabled":"disabled"}`),Dn(T,"title",`sharing records ${t().leaderboard?"enabled":"disabled"}`),C.disabled=!t().leaderboard}),xe(5,D,()=>qt,()=>({y:-48})),Ff(Q,()=>t().rapid,$=>ha(mt,ct(t).rapid=$,ct(t))),Ff(S,()=>t().leaderboard,$=>ha(mt,ct(t).leaderboard=$,ct(t))),xe(5,C,()=>qt,()=>({x:20})),xe(5,I,()=>qt,()=>({y:24})),xe(5,N,()=>qt,()=>({y:48})),xe(5,k,()=>Lr),J(_,k)};we(g,_=>{b(o)||_(m)})}var w=z(g,2);Ze(Sf(w,{get title(){return b(c)},get visible(){return b(o)},set visible(_){X(o,_,!0)},children:(_,k)=>{var P=EN(),D=z(O(P),4),I=O(D);I.__click=f;var x=z(I,2);x.__click=a,J(_,P)},$$slots:{default:!0}}),_=>X(i,_,!0),()=>b(i)),J(r,y);var v=ft(p);return s(),v}Fr(["click"]);var IN=se('<span class="error-msg svelte-16oz979"> </span>'),kN=se('<div class="relay-row svelte-16oz979"><div class="textarea-wrap svelte-16oz979"><textarea rows="3"></textarea> <!></div> <button class="remove-btn svelte-16oz979" title="remove"><span class="icon-remove svelte-16oz979">+</span></button></div>'),CN=se('<span class="error-msg svelte-16oz979"> </span>'),TN=se('<div class="relays content"><div class="section-1"><span>relays</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><div class="list svelte-16oz979"><!> <div class="relay-row new-row svelte-16oz979"><div class="textarea-wrap svelte-16oz979"><textarea placeholder="/dns4/example.com/tcp/443/wss/p2p/12D3KooW..." rows="3"></textarea> <!></div> <button class="add-btn svelte-16oz979" title="add relay">+</button></div></div></div></div> <div class="section-4 svelte-16oz979"><div class="row svelte-16oz979"><button title="[reset relays]">reset</button> <button title="[options]">back</button></div></div></div>');function PN(r,e){dt(e,!0);const t=()=>fe(Mo,"$activeRelaysStore",n),[n,s]=tr();let i=le(Qr([...t()])),o=le("");const l=F=>{const H=F.trim();return H?Fc(H)?"":"invalid multiaddr":""};let c=ie(()=>b(i).map(l)),d=ie(()=>l(b(o)));st(()=>{X(i,[...t()],!0)});function f(F){gu.update(H=>({...H,active:F(H.active)}))}function a(){gu.set({active:[...ri],applied:[...ri]})}function u(F,H){const G=Xp(F.target.value);F.target.value=G,b(i)[H]=G}function h(F){const H=Xp(F.target.value);F.target.value=H,X(o,H,!0)}function p(F){const H=b(i)[F].trim();if(!H){f(re=>re.filter((ne,K)=>K!==F));return}if(b(c)[F])return;const G=Fc(H);G!==t()[F]&&f(re=>re.map((ne,K)=>K===F?G:ne))}function y(){const F=b(o).trim();if(!F||b(d))return;const H=Fc(F);f(G=>[...G,H]),X(o,"")}function g(F){f(H=>H.filter((G,re)=>re!==F))}function m(){const F=document.activeElement;if(F?.tagName!=="TEXTAREA")return;const H=F.closest(".relay-row"),G=Array.from(document.querySelectorAll(".relays .relay-row")),re=G.indexOf(H);re!==-1&&(re===G.length-1?y():p(re))}function w(){Nt(Xe,de.options)}var v={saveCurrentRelay:m},_=TN(),k=O(_),P=O(k),D=z(k,4),I=O(D),x=O(I),B=O(x);Pn(B,17,()=>b(i),ti,(F,H,G)=>{var re=kN(),ne=O(re),K=O(ne);K.__input=Oe=>u(Oe,G);let ee;var ge=z(K,2);{var Me=Oe=>{var ht=IN(),Vr=O(ht);Te(()=>ze(Vr,b(c)[G])),J(Oe,ht)};we(ge,Oe=>{b(c)[G]&&Oe(Me)})}var tt=z(ne,2);tt.__click=()=>g(G),Te(Oe=>{Zc(K,b(H)),ee=Ue(K,1,"svelte-16oz979",null,ee,Oe)},[()=>({error:b(c)[G],valid:!b(c)[G]&&b(H).trim()})]),vr("blur",K,()=>p(G)),J(F,re)});var Q=z(B,2),M=O(Q),A=O(M);A.__input=h;let E;var S=z(A,2);{var T=F=>{var H=CN(),G=O(H);Te(()=>ze(G,b(d))),J(F,H)};we(S,F=>{b(d)&&F(T)})}var C=z(M,2);C.__click=y;var L=z(D,2),R=O(L),N=O(R);N.__click=a;var $=z(N,2);$.__click=w,Te(F=>{Zc(A,b(o)),E=Ue(A,1,"svelte-16oz979",null,E,F)},[()=>({error:b(d),valid:!b(d)&&b(o).trim()})]),xe(5,P,()=>qt,()=>({y:-48})),xe(5,D,()=>qt,()=>({y:24})),xe(5,N,()=>qt,()=>({y:48})),xe(5,$,()=>qt,()=>({y:48})),xe(5,_,()=>Lr),J(r,_);var q=ft(v);return s(),q}Fr(["input","click"]);var DN=se('<form class="wellcome content"><div class="section-1"><h1>digifall</h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <button type="submit">start</button></div></div> <div class="section-4"></div></form>'),LN=se(`<div class="col"><p>Game doesn't contain tutorial mode!</p> <p>Target: understand how to play it</p> <button>continue</button></div>`),RN=se("<!> <!>",1);function BN(r,e){dt(e,!0);const t=()=>fe(mt,"$optionsStore",n),[n,s]=tr();let i=ie(()=>null),o=ie(()=>!0),l=ie(()=>null),c=ie(()=>t().playerName);function d(){b(c)!==t().playerName&&(ha(mt,ct(t).playerName=b(c),ct(t)),Nt(ud,Date.now()))}function f(y){if(y.preventDefault(),b(c)==="")return b(l).blink();Nt(Xe,null)}var a=RN(),u=rt(a);{var h=y=>{var g=DN();g.__input=d;var m=z(O(g),4),w=O(m),v=O(w);Ze(g0(v,{get value(){return b(c)},set value(_){X(c,_)}}),_=>X(l,_),()=>b(l)),vr("submit",g,f),xe(5,g,()=>Lr),J(y,g)};we(u,y=>{b(o)||y(h)})}var p=z(u,2);Ze(Sf(p,{title:"heads up!",get visible(){return b(o)},set visible(y){X(o,y)},children:(y,g)=>{var m=LN(),w=z(O(m),4);w.__click=function(...v){b(i).close?.apply(this,v)},J(y,m)},$$slots:{default:!0}}),y=>X(i,y),()=>b(i)),J(r,a),ft(),s()}Fr(["input","click"]);var NN=se('<div class="overlay"><!></div>');function MN(r,e){dt(e,!0);const t=()=>fe(Xe,"$overlayStore",s),n=()=>fe(hn,"$phaseStore",s),[s,i]=tr();let o=le(null),l=le(null),c=le(null),d=le(null),f=le(null),a=le(null);async function u(){if(await I_(),b(l)&&b(l).isNewGameDialog())return b(l).closeNewGameDialog();Nt(Xe,currentOverlay===null||currentOverlay===de.leaderboard||currentOverlay===de.options||currentOverlay===de.relays?de.menu:null)}function h(){if(t()===de.relays)return k()?void 0:D(-2);P(-1)}function p(){if(t()===de.relays)return k()?void 0:D(2);P(1)}function y(){if(t()===de.relays)return k()?void 0:D(-1);if(t()===de.leaderboard)return b(a)?b(a).classList.contains("types")?b(a).click():b(o).prevPage(b(a).classList.contains("pages")):void 0;(t()!==de.options||b(c).isDialogVisible())&&P(-1)}function g(){if(t()===de.relays)return k()?void 0:D(1);if(t()===de.leaderboard)return b(a)?b(a).classList.contains("types")?b(a).click():b(o).nextPage(b(a).classList.contains("pages")):void 0;(t()!==de.options||b(c).isDialogVisible())&&P(-1)}function m(){if(t()===de.relays&&b(a)?.tagName==="TEXTAREA"){k()?(b(d)?.saveCurrentRelay(),b(a).blur()):b(a).focus();return}b(a)&&(b(f)&&b(f).isFocused()?b(f).nextType():b(a).classList.contains("focus")&&b(a).click())}function w(){if(b(a)&&b(a).blur(),t()===de.options||t()===de.leaderboard||t()===de.gameOver)return Xe.set(de.menu);if(t()===de.relays)return Xe.set(de.options);if(t()===de.menu&&n()!==te.gameOver)return Xe.set(null)}function v({node:A,selectors:E,shift:S=0}={}){if(!E||E.length<1)return;const T=E.map(N=>".overlay "+N).join(", "),C=Array.from(document.querySelectorAll(T));if(!A)return S<0?C[C.length+S]:C[0];if(S===0)return A;const L=C.indexOf(A);if(L===-1)return S<0?C[C.length+S]:C[0];let R=L+S;return R<0&&(R=C.length+R),R>C.length-1&&(R=R-C.length),C[R]}function _(A,E=!1){if(A){if(b(f)&&b(f).isFocused()&&b(f).blur(),b(a)&&(b(a).classList.remove("focus"),b(a).blur()),A.classList.contains("score"))return b(f)&&b(f).focus();X(a,A,!0),b(a).classList.add("focus"),E||b(a).focus()}}function k(){return b(a)?.tagName==="TEXTAREA"&&document.activeElement===b(a)}function P(A){const E=["button:not(.digifall)","[role='button']","input:not([type='checkbox'])","[tabindex='-1']"],S=E.map(L=>".overlay "+L+".focus").join(", "),T=document.querySelector(S),C=v({node:T,selectors:E,shift:A});_(C)}function D(A){const E=["textarea","button:not(.digifall)"],S=E.map(R=>".overlay "+R+".focus").join(", "),T=document.querySelector(S),C=v({node:T,selectors:E,shift:A}),L=C?.tagName==="TEXTAREA";_(C,L)}var I={switchOverlay:u,moveUp:h,moveDown:p,moveLeft:y,moveRight:g,perfomAction:m,blur:w},x=Xr(),B=rt(x);{var Q=A=>{var E=NN(),S=O(E);{var T=L=>{Kx(L,{get scoreComponent(){return b(f)},set scoreComponent(R){X(f,R,!0)}})},C=L=>{var R=Xr(),N=rt(R);{var $=F=>{Ze(cN(F,{}),H=>X(o,H,!0),()=>b(o))},q=F=>{var H=Xr(),G=rt(H);{var re=K=>{Ze(wN(K,{}),ee=>X(l,ee,!0),()=>b(l))},ne=K=>{var ee=Xr(),ge=rt(ee);{var Me=Oe=>{Ze(AN(Oe,{}),ht=>X(c,ht,!0),()=>b(c))},tt=Oe=>{var ht=Xr(),Vr=rt(ht);{var Y=ye=>{Ze(PN(ye,{}),pt=>X(d,pt,!0),()=>b(d))},oe=ye=>{var pt=Xr(),nr=rt(pt);{var gr=zn=>{BN(zn,{})};we(nr,zn=>{t()===de.wellcome&&zn(gr)},!0)}J(ye,pt)};we(Vr,ye=>{t()===de.relays?ye(Y):ye(oe,!1)},!0)}J(Oe,ht)};we(ge,Oe=>{t()===de.options?Oe(Me):Oe(tt,!1)},!0)}J(K,ee)};we(G,K=>{t()===de.menu?K(re):K(ne,!1)},!0)}J(F,H)};we(N,F=>{t()===de.leaderboard?F($):F(q,!1)},!0)}J(L,R)};we(S,L=>{t()===de.gameOver?L(T):L(C,!1)})}xe(3,E,()=>ga,()=>({duration:200})),J(A,E)};we(B,A=>{t()&&A(Q)})}J(r,x);var M=ft(I);return i(),M}var ON=se('<div class="app"><!> <!></div>');function $N(r,e){dt(e,!0);const t=()=>fe(hn,"$phaseStore",o),n=()=>fe(Xe,"$overlayStore",o),s=()=>fe(Bl,"$energyStore",o),i=()=>fe(No,"$seedStore",o),[o,l]=tr();let c=le(null),d=le(null);st(()=>{jf>0&&setTimeout(()=>location=location,jf*1e3)}),st(()=>{t()===te.gameOver&&Nt(Xe,de.gameOver)}),st(()=>{document.documentElement.classList[s().value>100||t()===te.extra||t()===te.combo||n()===de.leaderboard||n()===de.gameOver?"add":"remove"]("random-color")});function f(g){const m=n()===null?b(c):b(d);switch(g.code){case"Escape":return g.preventDefault(),m.blur();case"Tab":return g.preventDefault(),!i()||n()===de.wellcome||n()===de.gameOver?void 0:b(d).switchOverlay();case"ArrowUp":return m.moveUp();case"ArrowDown":return m.moveDown();case"ArrowLeft":return m.moveLeft();case"ArrowRight":return m.moveRight();case"Enter":case"Space":return g.preventDefault(),m.perfomAction();case"KeyF":case"KeyJ":return m.perfomAction()}}function a(){document.hasFocus()||(document.location=document.location)}function u(){const{style:g,offsetHeight:m,offsetWidth:w}=document.documentElement,k=m/w<1.5?m/192:w/128,P=k%.25;g.setProperty("font-size",k-P+"px")}var h=ON();vr("keydown",Xn,f),vr("storage",Xn,a),vr("resize",Xn,u),vr("visibilitychange",Xn,u),Ug(Xn,g=>u?.());var p=O(h);Ze(Ox(p,{}),g=>X(c,g,!0),()=>b(c));var y=z(p,2);Ze(MN(y,{}),g=>X(d,g,!0),()=>b(d)),J(r,h),ft(),l()}am(ys,pE);B_($N,{target:document.body});
