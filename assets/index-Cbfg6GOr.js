(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const Fc=!1;var eg=Array.isArray,I0=Array.prototype.indexOf,xl=Array.from,tg=Object.defineProperty,Hs=Object.getOwnPropertyDescriptor,rg=Object.getOwnPropertyDescriptors,k0=Object.prototype,C0=Array.prototype,zu=Object.getPrototypeOf,Tf=Object.isExtensible;function T0(r){return typeof r=="function"}const Kt=()=>{};function P0(r){return r()}function Sa(r){for(var e=0;e<r.length;e++)r[e]()}function ng(){var r,e,t=new Promise((n,s)=>{r=n,e=s});return{promise:t,resolve:r,reject:e}}const _t=2,Ea=4,xo=8,sg=1<<24,Mr=16,dn=32,As=64,Wu=128,dr=512,Pt=1024,Mt=2048,fn=4096,er=8192,en=16384,Al=32768,On=65536,Pf=1<<17,ig=1<<18,vi=1<<19,og=1<<20,Zr=1<<25,gs=32768,Uc=1<<21,Gu=1<<22,Cn=1<<23,as=Symbol("$state"),D0=Symbol("legacy props"),L0=Symbol(""),$s=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function R0(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function B0(r){throw new Error("https://svelte.dev/e/effect_in_teardown")}function N0(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function M0(r){throw new Error("https://svelte.dev/e/effect_orphan")}function O0(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function $0(r){throw new Error("https://svelte.dev/e/props_invalid_value")}function F0(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function U0(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function V0(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function K0(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const q0=1,H0=2,ag=4,z0=8,W0=16,G0=1,Y0=2,X0=4,Z0=8,j0=16,Q0=1,J0=2,e_=4,t_=1,r_=2,yt=Symbol(),n_="http://www.w3.org/1999/xhtml";function s_(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function lg(r){return r===this.v}function cg(r,e){return r!=r?e==e:r!==e||r!==null&&typeof r=="object"||typeof r=="function"}function ug(r){return!cg(r,this.v)}let Ao=!1,i_=!1;function o_(){Ao=!0}let ut=null;function Qs(r){ut=r}function ft(r,e=!1,t){ut={p:ut,i:!1,c:null,e:null,s:r,x:null,l:Ao&&!e?{s:null,u:null,$:[]}:null}}function ht(r){var e=ut,t=e.e;if(t!==null){e.e=null;for(var n of t)Cg(n)}return r!==void 0&&(e.x=r),e.i=!0,ut=e.p,r??{}}function wi(){return!Ao||ut!==null&&ut.l===null}let Jn=[];function dg(){var r=Jn;Jn=[],Sa(r)}function Is(r){if(Jn.length===0&&!Wi){var e=Jn;queueMicrotask(()=>{e===Jn&&dg()})}Jn.push(r)}function a_(){for(;Jn.length>0;)dg()}function fg(r){var e=_e;if(e===null)return me.f|=Cn,r;if((e.f&Al)===0){if((e.f&Wu)===0)throw r;e.b.error(r)}else Js(r,e)}function Js(r,e){for(;e!==null;){if((e.f&Wu)!==0)try{e.b.error(r);return}catch(t){r=t}e=e.parent}throw r}const l_=-7169;function dt(r,e){r.f=r.f&l_|e}function Yu(r){(r.f&dr)!==0||r.deps===null?dt(r,Pt):dt(r,fn)}function hg(r){if(r!==null)for(const e of r)(e.f&_t)===0||(e.f&gs)===0||(e.f^=gs,hg(e.deps))}function pg(r,e,t){(r.f&Mt)!==0?e.add(r):(r.f&fn)!==0&&t.add(r),hg(r.deps),dt(r,Pt)}const Wo=new Set;let We=null,vr=null,or=[],Il=null,Vc=!1,Wi=!1;class Pr{committed=!1;current=new Map;previous=new Map;#e=new Set;#r=new Set;#t=0;#n=0;#i=null;#a=new Set;#s=new Set;skipped_effects=new Set;is_fork=!1;is_deferred(){return this.is_fork||this.#n>0}process(e){or=[],this.apply();var t=[],n=[];for(const s of e)this.#h(s,t,n);this.is_fork||this.#d(),this.is_deferred()?(this.#p(n),this.#p(t)):(We=null,Df(n),Df(t),this.#i?.resolve()),vr=null}#h(e,t,n){e.f^=Pt;for(var s=e.first,i=null;s!==null;){var o=s.f,l=(o&(dn|As))!==0,c=l&&(o&Pt)!==0,d=c||(o&er)!==0||this.skipped_effects.has(s);if(!d&&s.fn!==null){l?s.f^=Pt:i!==null&&(o&(Ea|xo|sg))!==0?i.b.defer_effect(s):(o&Ea)!==0?t.push(s):To(s)&&((o&Mr)!==0&&this.#a.add(s),so(s));var f=s.first;if(f!==null){s=f;continue}}var a=s.parent;for(s=s.next;s===null&&a!==null;)a===i&&(i=null),s=a.next,a=a.parent}}#p(e){for(var t=0;t<e.length;t+=1)pg(e[t],this.#a,this.#s)}capture(e,t){t!==yt&&!this.previous.has(e)&&this.previous.set(e,t),(e.f&Cn)===0&&(this.current.set(e,e.v),vr?.set(e,e.v))}activate(){We=this,this.apply()}deactivate(){We===this&&(We=null,vr=null)}flush(){if(this.activate(),or.length>0){if(gg(),We!==null&&We!==this)return}else this.#t===0&&this.process([]);this.deactivate()}discard(){for(const e of this.#r)e(this);this.#r.clear()}#d(){if(this.#n===0){for(const e of this.#e)e();this.#e.clear()}this.#t===0&&this.#g()}#g(){if(Wo.size>1){this.previous.clear();var e=vr,t=!0;for(const s of Wo){if(s===this){t=!1;continue}const i=[];for(const[l,c]of this.current){if(s.current.has(l))if(t&&c!==s.current.get(l))s.current.set(l,c);else continue;i.push(l)}if(i.length===0)continue;const o=[...s.current.keys()].filter(l=>!this.current.has(l));if(o.length>0){var n=or;or=[];const l=new Set,c=new Map;for(const d of i)mg(d,o,l,c);if(or.length>0){We=s,s.apply();for(const d of or)s.#h(d,[],[]);s.deactivate()}or=n}}We=null,vr=e}this.committed=!0,Wo.delete(this)}increment(e){this.#t+=1,e&&(this.#n+=1)}decrement(e){this.#t-=1,e&&(this.#n-=1),this.revive()}revive(){for(const e of this.#a)this.#s.delete(e),dt(e,Mt),sn(e);for(const e of this.#s)dt(e,fn),sn(e);this.flush()}oncommit(e){this.#e.add(e)}ondiscard(e){this.#r.add(e)}settled(){return(this.#i??=ng()).promise}static ensure(){if(We===null){const e=We=new Pr;Wo.add(We),Wi||Pr.enqueue(()=>{We===e&&e.flush()})}return We}static enqueue(e){Is(e)}apply(){}}function c_(r){var e=Wi;Wi=!0;try{for(var t;;){if(a_(),or.length===0&&(We?.flush(),or.length===0))return Il=null,t;gg()}}finally{Wi=e}}function gg(){var r=cs;Vc=!0;var e=null;try{var t=0;for(Ia(!0);or.length>0;){var n=Pr.ensure();if(t++>1e3){var s,i;u_()}n.process(or),Tn.clear()}}finally{Vc=!1,Ia(r),Il=null}}function u_(){try{O0()}catch(r){Js(r,Il)}}let Hr=null;function Df(r){var e=r.length;if(e!==0){for(var t=0;t<e;){var n=r[t++];if((n.f&(en|er))===0&&To(n)&&(Hr=new Set,so(n),n.deps===null&&n.first===null&&n.nodes===null&&(n.teardown===null&&n.ac===null?Dg(n):n.fn=null),Hr?.size>0)){Tn.clear();for(const s of Hr){if((s.f&(en|er))!==0)continue;const i=[s];let o=s.parent;for(;o!==null;)Hr.has(o)&&(Hr.delete(o),i.push(o)),o=o.parent;for(let l=i.length-1;l>=0;l--){const c=i[l];(c.f&(en|er))===0&&so(c)}}Hr.clear()}}Hr=null}}function mg(r,e,t,n){if(!t.has(r)&&(t.add(r),r.reactions!==null))for(const s of r.reactions){const i=s.f;(i&_t)!==0?mg(s,e,t,n):(i&(Gu|Mr))!==0&&(i&Mt)===0&&yg(s,e,n)&&(dt(s,Mt),sn(s))}}function yg(r,e,t){const n=t.get(r);if(n!==void 0)return n;if(r.deps!==null)for(const s of r.deps){if(e.includes(s))return!0;if((s.f&_t)!==0&&yg(s,e,t))return t.set(s,!0),!0}return t.set(r,!1),!1}function sn(r){for(var e=Il=r;e.parent!==null;){e=e.parent;var t=e.f;if(Vc&&e===_e&&(t&Mr)!==0&&(t&ig)===0)return;if((t&(As|dn))!==0){if((t&Pt)===0)return;e.f^=Pt}}or.push(e)}function d_(r){let e=0,t=ms(0),n;return()=>{Zu()&&(b(t),Qu(()=>(e===0&&(n=ct(()=>r(()=>Gi(t)))),e+=1,()=>{Is(()=>{e-=1,e===0&&(n?.(),n=void 0,Gi(t))})})))}}var f_=On|vi|Wu;function h_(r,e,t){new p_(r,e,t)}class p_{parent;is_pending=!1;#e;#r=null;#t;#n;#i;#a=null;#s=null;#h=null;#p=null;#d=null;#g=0;#f=0;#l=!1;#c=new Set;#o=new Set;#m=null;#u=d_(()=>(this.#m=ms(this.#g),()=>{this.#m=null}));constructor(e,t,n){this.#e=e,this.#t=t,this.#n=n,this.parent=_e.b,this.is_pending=!!this.#t.pending,this.#i=Co(()=>{_e.b=this;{var s=this.#E();try{this.#a=ar(()=>n(s))}catch(i){this.error(i)}this.#f>0?this.#v():this.is_pending=!1}return()=>{this.#d?.remove()}},f_)}#_(){try{this.#a=ar(()=>this.#n(this.#e))}catch(e){this.error(e)}}#b(){const e=this.#t.pending;e&&(this.#s=ar(()=>e(this.#e)),Pr.enqueue(()=>{var t=this.#E();this.#a=this.#y(()=>(Pr.ensure(),ar(()=>this.#n(t)))),this.#f>0?this.#v():(ls(this.#s,()=>{this.#s=null}),this.is_pending=!1)}))}#E(){var e=this.#e;return this.is_pending&&(this.#d=Pn(),this.#e.before(this.#d),e=this.#d),e}defer_effect(e){pg(e,this.#c,this.#o)}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!this.#t.pending}#y(e){var t=_e,n=me,s=ut;Br(this.#i),qt(this.#i),Qs(this.#i.ctx);try{return e()}catch(i){return fg(i),null}finally{Br(t),qt(n),Qs(s)}}#v(){const e=this.#t.pending;this.#a!==null&&(this.#p=document.createDocumentFragment(),this.#p.append(this.#d),Bg(this.#a,this.#p)),this.#s===null&&(this.#s=ar(()=>e(this.#e)))}#x(e){if(!this.has_pending_snippet()){this.parent&&this.parent.#x(e);return}if(this.#f+=e,this.#f===0){this.is_pending=!1;for(const t of this.#c)dt(t,Mt),sn(t);for(const t of this.#o)dt(t,fn),sn(t);this.#c.clear(),this.#o.clear(),this.#s&&ls(this.#s,()=>{this.#s=null}),this.#p&&(this.#e.before(this.#p),this.#p=null)}}update_pending_count(e){this.#x(e),this.#g+=e,this.#m&&ei(this.#m,this.#g)}get_effect_pending(){return this.#u(),b(this.#m)}error(e){var t=this.#t.onerror;let n=this.#t.failed;if(this.#l||!t&&!n)throw e;this.#a&&(Wt(this.#a),this.#a=null),this.#s&&(Wt(this.#s),this.#s=null),this.#h&&(Wt(this.#h),this.#h=null);var s=!1,i=!1;const o=()=>{if(s){s_();return}s=!0,i&&K0(),Pr.ensure(),this.#g=0,this.#h!==null&&ls(this.#h,()=>{this.#h=null}),this.is_pending=this.has_pending_snippet(),this.#a=this.#y(()=>(this.#l=!1,ar(()=>this.#n(this.#e)))),this.#f>0?this.#v():this.is_pending=!1};var l=me;try{qt(null),i=!0,t?.(e,o),i=!1}catch(c){Js(c,this.#i&&this.#i.parent)}finally{qt(l)}n&&Is(()=>{this.#h=this.#y(()=>{Pr.ensure(),this.#l=!0;try{return ar(()=>{n(this.#e,()=>e,()=>o)})}catch(c){return Js(c,this.#i.parent),null}finally{this.#l=!1}})})}}function g_(r,e,t,n){const s=wi()?Io:ro;if(t.length===0&&r.length===0){n(e.map(s));return}var i=We,o=_e,l=m_();function c(){Promise.all(t.map(d=>y_(d))).then(d=>{l();try{n([...e.map(s),...d])}catch(f){(o.f&en)===0&&Js(f,o)}i?.deactivate(),xa()}).catch(d=>{Js(d,o)})}r.length>0?Promise.all(r).then(()=>{l();try{return c()}finally{i?.deactivate(),xa()}}):c()}function m_(){var r=_e,e=me,t=ut,n=We;return function(i=!0){Br(r),qt(e),Qs(t),i&&n?.activate()}}function xa(){Br(null),qt(null),Qs(null)}function Io(r){var e=_t|Mt,t=me!==null&&(me.f&_t)!==0?me:null;return _e!==null&&(_e.f|=vi),{ctx:ut,deps:null,effects:null,equals:lg,f:e,fn:r,reactions:null,rv:0,v:yt,wv:0,parent:t??_e,ac:null}}function y_(r,e,t){let n=_e;n===null&&R0();var s=n.b,i=void 0,o=ms(yt),l=!me,c=new Map;return k_(()=>{var d=ng();i=d.promise;try{Promise.resolve(r()).then(d.resolve,d.reject).then(()=>{f===We&&f.committed&&f.deactivate(),xa()})}catch(h){d.reject(h),xa()}var f=We;if(l){var a=s.is_rendered();s.update_pending_count(1),f.increment(a),c.get(f)?.reject($s),c.delete(f),c.set(f,d)}const u=(h,p=void 0)=>{if(f.activate(),p)p!==$s&&(o.f|=Cn,ei(o,p));else{(o.f&Cn)!==0&&(o.f^=Cn),ei(o,h);for(const[y,g]of c){if(c.delete(y),y===f)break;g.reject($s)}}l&&(s.update_pending_count(-1),f.decrement(a))};d.promise.then(u,h=>u(null,h||"unknown"))}),ju(()=>{for(const d of c.values())d.reject($s)}),new Promise(d=>{function f(a){function u(){a===i?d(o):f(i)}a.then(u,u)}f(i)})}function ie(r){const e=Io(r);return Ng(e),e}function ro(r){const e=Io(r);return e.equals=ug,e}function bg(r){var e=r.effects;if(e!==null){r.effects=null;for(var t=0;t<e.length;t+=1)Wt(e[t])}}function b_(r){for(var e=r.parent;e!==null;){if((e.f&_t)===0)return(e.f&en)===0?e:null;e=e.parent}return null}function Xu(r){var e,t=_e;Br(b_(r));try{r.f&=~gs,bg(r),e=Fg(r)}finally{Br(t)}return e}function vg(r){var e=Xu(r);if(!r.equals(e)&&(r.wv=Og(),(!We?.is_fork||r.deps===null)&&(r.v=e,r.deps===null))){dt(r,Pt);return}$n||(vr!==null?(Zu()||We?.is_fork)&&vr.set(r,e):Yu(r))}let Kc=new Set;const Tn=new Map;let wg=!1;function ms(r,e){var t={f:0,v:r,reactions:null,equals:lg,rv:0,wv:0};return t}function le(r,e){const t=ms(r);return Ng(t),t}function _g(r,e=!1,t=!0){const n=ms(r);return e||(n.equals=ug),Ao&&t&&ut!==null&&ut.l!==null&&(ut.l.s??=[]).push(n),n}function X(r,e,t=!1){me!==null&&(!wr||(me.f&Pf)!==0)&&wi()&&(me.f&(_t|Mr|Gu|Pf))!==0&&!tn?.includes(r)&&V0();let n=t?jr(e):e;return ei(r,n)}function ei(r,e){if(!r.equals(e)){var t=r.v;$n?Tn.set(r,e):Tn.set(r,t),r.v=e;var n=Pr.ensure();if(n.capture(r,t),(r.f&_t)!==0){const s=r;(r.f&Mt)!==0&&Xu(s),Yu(s)}r.wv=Og(),Sg(r,Mt),wi()&&_e!==null&&(_e.f&Pt)!==0&&(_e.f&(dn|As))===0&&(sr===null?P_([r]):sr.push(r)),!n.is_fork&&Kc.size>0&&!wg&&v_()}return e}function v_(){wg=!1;var r=cs;Ia(!0);const e=Array.from(Kc);try{for(const t of e)(t.f&Pt)!==0&&dt(t,fn),To(t)&&so(t)}finally{Ia(r)}Kc.clear()}function Gi(r){X(r,r.v+1)}function Sg(r,e){var t=r.reactions;if(t!==null)for(var n=wi(),s=t.length,i=0;i<s;i++){var o=t[i],l=o.f;if(!(!n&&o===_e)){var c=(l&Mt)===0;if(c&&dt(o,e),(l&_t)!==0){var d=o;vr?.delete(d),(l&gs)===0&&(l&dr&&(o.f|=gs),Sg(d,fn))}else c&&((l&Mr)!==0&&Hr!==null&&Hr.add(o),sn(o))}}}function jr(r){if(typeof r!="object"||r===null||as in r)return r;const e=zu(r);if(e!==k0&&e!==C0)return r;var t=new Map,n=eg(r),s=le(0),i=us,o=l=>{if(us===i)return l();var c=me,d=us;qt(null),Bf(i);var f=l();return qt(c),Bf(d),f};return n&&t.set("length",le(r.length)),new Proxy(r,{defineProperty(l,c,d){(!("value"in d)||d.configurable===!1||d.enumerable===!1||d.writable===!1)&&F0();var f=t.get(c);return f===void 0?f=o(()=>{var a=le(d.value);return t.set(c,a),a}):X(f,d.value,!0),!0},deleteProperty(l,c){var d=t.get(c);if(d===void 0){if(c in l){const f=o(()=>le(yt));t.set(c,f),Gi(s)}}else X(d,yt),Gi(s);return!0},get(l,c,d){if(c===as)return r;var f=t.get(c),a=c in l;if(f===void 0&&(!a||Hs(l,c)?.writable)&&(f=o(()=>{var h=jr(a?l[c]:yt),p=le(h);return p}),t.set(c,f)),f!==void 0){var u=b(f);return u===yt?void 0:u}return Reflect.get(l,c,d)},getOwnPropertyDescriptor(l,c){var d=Reflect.getOwnPropertyDescriptor(l,c);if(d&&"value"in d){var f=t.get(c);f&&(d.value=b(f))}else if(d===void 0){var a=t.get(c),u=a?.v;if(a!==void 0&&u!==yt)return{enumerable:!0,configurable:!0,value:u,writable:!0}}return d},has(l,c){if(c===as)return!0;var d=t.get(c),f=d!==void 0&&d.v!==yt||Reflect.has(l,c);if(d!==void 0||_e!==null&&(!f||Hs(l,c)?.writable)){d===void 0&&(d=o(()=>{var u=f?jr(l[c]):yt,h=le(u);return h}),t.set(c,d));var a=b(d);if(a===yt)return!1}return f},set(l,c,d,f){var a=t.get(c),u=c in l;if(n&&c==="length")for(var h=d;h<a.v;h+=1){var p=t.get(h+"");p!==void 0?X(p,yt):h in l&&(p=o(()=>le(yt)),t.set(h+"",p))}if(a===void 0)(!u||Hs(l,c)?.writable)&&(a=o(()=>le(void 0)),X(a,jr(d)),t.set(c,a));else{u=a.v!==yt;var y=o(()=>jr(d));X(a,y)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g?.set&&g.set.call(f,d),!u){if(n&&typeof c=="string"){var m=t.get("length"),w=Number(c);Number.isInteger(w)&&w>=m.v&&X(m,w+1)}Gi(s)}return!0},ownKeys(l){b(s);var c=Reflect.ownKeys(l).filter(a=>{var u=t.get(a);return u===void 0||u.v!==yt});for(var[d,f]of t)f.v!==yt&&!(d in l)&&c.push(d);return c},setPrototypeOf(){U0()}})}var jn,Eg,xg,Ag;function w_(){if(jn===void 0){jn=window,Eg=/Firefox/.test(navigator.userAgent);var r=Element.prototype,e=Node.prototype,t=Text.prototype;xg=Hs(e,"firstChild").get,Ag=Hs(e,"nextSibling").get,Tf(r)&&(r.__click=void 0,r.__className=void 0,r.__attributes=null,r.__style=void 0,r.__e=void 0),Tf(t)&&(t.__t=void 0)}}function Pn(r=""){return document.createTextNode(r)}function Aa(r){return xg.call(r)}function ko(r){return Ag.call(r)}function O(r,e){return Aa(r)}function rt(r,e=!1){{var t=Aa(r);return t instanceof Comment&&t.data===""?ko(t):t}}function z(r,e=1,t=!1){let n=r;for(;e--;)n=ko(n);return n}function __(r){r.textContent=""}function Ig(){return!1}let Lf=!1;function S_(){Lf||(Lf=!0,document.addEventListener("reset",r=>{Promise.resolve().then(()=>{if(!r.defaultPrevented)for(const e of r.target.elements)e.__on_r?.()})},{capture:!0}))}function _i(r){var e=me,t=_e;qt(null),Br(null);try{return r()}finally{qt(e),Br(t)}}function E_(r,e,t,n=t){r.addEventListener(e,()=>_i(t));const s=r.__on_r;s?r.__on_r=()=>{s(),n(!0)}:r.__on_r=()=>n(!0),S_()}function kg(r){_e===null&&(me===null&&M0(),N0()),$n&&B0()}function x_(r,e){var t=e.last;t===null?e.last=e.first=r:(t.next=r,r.prev=t,e.last=r)}function Or(r,e,t){var n=_e;n!==null&&(n.f&er)!==0&&(r|=er);var s={ctx:ut,deps:null,nodes:null,f:r|Mt|dr,first:null,fn:e,last:null,next:null,parent:n,b:n&&n.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{so(s),s.f|=Al}catch(l){throw Wt(s),l}else e!==null&&sn(s);var i=s;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&(i.f&vi)===0&&(i=i.first,(r&Mr)!==0&&(r&On)!==0&&i!==null&&(i.f|=On)),i!==null&&(i.parent=n,n!==null&&x_(i,n),me!==null&&(me.f&_t)!==0&&(r&As)===0)){var o=me;(o.effects??=[]).push(i)}return s}function Zu(){return me!==null&&!wr}function ju(r){const e=Or(xo,null,!1);return dt(e,Pt),e.teardown=r,e}function st(r){kg();var e=_e.f,t=!me&&(e&dn)!==0&&(e&Al)===0;if(t){var n=ut;(n.e??=[]).push(r)}else return Cg(r)}function Cg(r){return Or(Ea|og,r,!1)}function A_(r){return kg(),Or(xo|og,r,!0)}function I_(r){Pr.ensure();const e=Or(As|vi,r,!0);return(t={})=>new Promise(n=>{t.outro?ls(e,()=>{Wt(e),n(void 0)}):(Wt(e),n(void 0))})}function kl(r){return Or(Ea,r,!1)}function k_(r){return Or(Gu|vi,r,!0)}function Qu(r,e=0){return Or(xo|e,r,!0)}function Te(r,e=[],t=[],n=[]){g_(n,e,t,s=>{Or(xo,()=>r(...s.map(b)),!0)})}function Co(r,e=0){var t=Or(Mr|e,r,!0);return t}function ar(r){return Or(dn|vi,r,!0)}function Tg(r){var e=r.teardown;if(e!==null){const t=$n,n=me;Rf(!0),qt(null);try{e.call(null)}finally{Rf(t),qt(n)}}}function Pg(r,e=!1){var t=r.first;for(r.first=r.last=null;t!==null;){const s=t.ac;s!==null&&_i(()=>{s.abort($s)});var n=t.next;(t.f&As)!==0?t.parent=null:Wt(t,e),t=n}}function C_(r){for(var e=r.first;e!==null;){var t=e.next;(e.f&dn)===0&&Wt(e),e=t}}function Wt(r,e=!0){var t=!1;(e||(r.f&ig)!==0)&&r.nodes!==null&&r.nodes.end!==null&&(T_(r.nodes.start,r.nodes.end),t=!0),Pg(r,e&&!t),ka(r,0),dt(r,en);var n=r.nodes&&r.nodes.t;if(n!==null)for(const i of n)i.stop();Tg(r);var s=r.parent;s!==null&&s.first!==null&&Dg(r),r.next=r.prev=r.teardown=r.ctx=r.deps=r.fn=r.nodes=r.ac=null}function T_(r,e){for(;r!==null;){var t=r===e?null:ko(r);r.remove(),r=t}}function Dg(r){var e=r.parent,t=r.prev,n=r.next;t!==null&&(t.next=n),n!==null&&(n.prev=t),e!==null&&(e.first===r&&(e.first=n),e.last===r&&(e.last=t))}function ls(r,e,t=!0){var n=[];Lg(r,n,!0);var s=()=>{t&&Wt(r),e&&e()},i=n.length;if(i>0){var o=()=>--i||s();for(var l of n)l.out(o)}else s()}function Lg(r,e,t){if((r.f&er)===0){r.f^=er;var n=r.nodes&&r.nodes.t;if(n!==null)for(const l of n)(l.is_global||t)&&e.push(l);for(var s=r.first;s!==null;){var i=s.next,o=(s.f&On)!==0||(s.f&dn)!==0&&(r.f&Mr)!==0;Lg(s,e,o?t:!1),s=i}}}function Ju(r){Rg(r,!0)}function Rg(r,e){if((r.f&er)!==0){r.f^=er,(r.f&Pt)===0&&(dt(r,Mt),sn(r));for(var t=r.first;t!==null;){var n=t.next,s=(t.f&On)!==0||(t.f&dn)!==0;Rg(t,s?e:!1),t=n}var i=r.nodes&&r.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Bg(r,e){if(r.nodes)for(var t=r.nodes.start,n=r.nodes.end;t!==null;){var s=t===n?null:ko(t);e.append(t),t=s}}let cs=!1;function Ia(r){cs=r}let $n=!1;function Rf(r){$n=r}let me=null,wr=!1;function qt(r){me=r}let _e=null;function Br(r){_e=r}let tn=null;function Ng(r){me!==null&&(tn===null?tn=[r]:tn.push(r))}let Rt=null,Yt=0,sr=null;function P_(r){sr=r}let Mg=1,no=0,us=no;function Bf(r){us=r}function Og(){return++Mg}function To(r){var e=r.f;if((e&Mt)!==0)return!0;if(e&_t&&(r.f&=~gs),(e&fn)!==0){for(var t=r.deps,n=t.length,s=0;s<n;s++){var i=t[s];if(To(i)&&vg(i),i.wv>r.wv)return!0}(e&dr)!==0&&vr===null&&dt(r,Pt)}return!1}function $g(r,e,t=!0){var n=r.reactions;if(n!==null&&!tn?.includes(r))for(var s=0;s<n.length;s++){var i=n[s];(i.f&_t)!==0?$g(i,e,!1):e===i&&(t?dt(i,Mt):(i.f&Pt)!==0&&dt(i,fn),sn(i))}}function Fg(r){var e=Rt,t=Yt,n=sr,s=me,i=tn,o=ut,l=wr,c=us,d=r.f;Rt=null,Yt=0,sr=null,me=(d&(dn|As))===0?r:null,tn=null,Qs(r.ctx),wr=!1,us=++no,r.ac!==null&&(_i(()=>{r.ac.abort($s)}),r.ac=null);try{r.f|=Uc;var f=r.fn,a=f(),u=r.deps;if(Rt!==null){var h;if(ka(r,Yt),u!==null&&Yt>0)for(u.length=Yt+Rt.length,h=0;h<Rt.length;h++)u[Yt+h]=Rt[h];else r.deps=u=Rt;if(Zu()&&(r.f&dr)!==0)for(h=Yt;h<u.length;h++)(u[h].reactions??=[]).push(r)}else u!==null&&Yt<u.length&&(ka(r,Yt),u.length=Yt);if(wi()&&sr!==null&&!wr&&u!==null&&(r.f&(_t|fn|Mt))===0)for(h=0;h<sr.length;h++)$g(sr[h],r);return s!==null&&s!==r&&(no++,sr!==null&&(n===null?n=sr:n.push(...sr))),(r.f&Cn)!==0&&(r.f^=Cn),a}catch(p){return fg(p)}finally{r.f^=Uc,Rt=e,Yt=t,sr=n,me=s,tn=i,Qs(o),wr=l,us=c}}function D_(r,e){let t=e.reactions;if(t!==null){var n=I0.call(t,r);if(n!==-1){var s=t.length-1;s===0?t=e.reactions=null:(t[n]=t[s],t.pop())}}if(t===null&&(e.f&_t)!==0&&(Rt===null||!Rt.includes(e))){var i=e;(i.f&dr)!==0&&(i.f^=dr,i.f&=~gs),Yu(i),bg(i),ka(i,0)}}function ka(r,e){var t=r.deps;if(t!==null)for(var n=e;n<t.length;n++)D_(r,t[n])}function so(r){var e=r.f;if((e&en)===0){dt(r,Pt);var t=_e,n=cs;_e=r,cs=!0;try{(e&(Mr|sg))!==0?C_(r):Pg(r),Tg(r);var s=Fg(r);r.teardown=typeof s=="function"?s:null,r.wv=Mg;var i;Fc&&i_&&(r.f&Mt)!==0&&r.deps}finally{cs=n,_e=t}}}async function L_(){await Promise.resolve(),c_()}function b(r){var e=r.f,t=(e&_t)!==0;if(me!==null&&!wr){var n=_e!==null&&(_e.f&en)!==0;if(!n&&!tn?.includes(r)){var s=me.deps;if((me.f&Uc)!==0)r.rv<no&&(r.rv=no,Rt===null&&s!==null&&s[Yt]===r?Yt++:Rt===null?Rt=[r]:Rt.includes(r)||Rt.push(r));else{(me.deps??=[]).push(r);var i=r.reactions;i===null?r.reactions=[me]:i.includes(me)||i.push(me)}}}if($n&&Tn.has(r))return Tn.get(r);if(t){var o=r;if($n){var l=o.v;return((o.f&Pt)===0&&o.reactions!==null||Vg(o))&&(l=Xu(o)),Tn.set(o,l),l}var c=(o.f&dr)===0&&!wr&&me!==null&&(cs||(me.f&dr)!==0),d=o.deps===null;To(o)&&(c&&(o.f|=dr),vg(o)),c&&!d&&Ug(o)}if(vr?.has(r))return vr.get(r);if((r.f&Cn)!==0)throw r.v;return r.v}function Ug(r){if(r.deps!==null){r.f|=dr;for(const e of r.deps)(e.reactions??=[]).push(r),(e.f&_t)!==0&&(e.f&dr)===0&&Ug(e)}}function Vg(r){if(r.v===yt)return!0;if(r.deps===null)return!1;for(const e of r.deps)if(Tn.has(e)||(e.f&_t)!==0&&Vg(e))return!0;return!1}function ct(r){var e=wr;try{return wr=!0,r()}finally{wr=e}}function R_(r,e){var t={};for(var n in r)e.includes(n)||(t[n]=r[n]);for(var s of Object.getOwnPropertySymbols(r))Object.propertyIsEnumerable.call(r,s)&&!e.includes(s)&&(t[s]=r[s]);return t}function B_(r){if(!(typeof r!="object"||!r||r instanceof EventTarget)){if(as in r)qc(r);else if(!Array.isArray(r))for(let e in r){const t=r[e];typeof t=="object"&&t&&as in t&&qc(t)}}}function qc(r,e=new Set){if(typeof r=="object"&&r!==null&&!(r instanceof EventTarget)&&!e.has(r)){e.add(r),r instanceof Date&&r.getTime();for(let n in r)try{qc(r[n],e)}catch{}const t=zu(r);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const n=rg(t);for(let s in n){const i=n[s].get;if(i)try{i.call(r)}catch{}}}}}const N_=["touchstart","touchmove"];function M_(r){return N_.includes(r)}const Kg=new Set,Hc=new Set;function O_(r,e,t,n={}){function s(i){if(n.capture||Fi.call(e,i),!i.cancelBubble)return _i(()=>t?.call(this,i))}return r.startsWith("pointer")||r.startsWith("touch")||r==="wheel"?Is(()=>{e.addEventListener(r,s,n)}):e.addEventListener(r,s,n),s}function _r(r,e,t,n,s){var i={capture:n,passive:s},o=O_(r,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&ju(()=>{e.removeEventListener(r,o,i)})}function $r(r){for(var e=0;e<r.length;e++)Kg.add(r[e]);for(var t of Hc)t(r)}let Nf=null;function Fi(r){var e=this,t=e.ownerDocument,n=r.type,s=r.composedPath?.()||[],i=s[0]||r.target;Nf=r;var o=0,l=Nf===r&&r.__root;if(l){var c=s.indexOf(l);if(c!==-1&&(e===document||e===window)){r.__root=e;return}var d=s.indexOf(e);if(d===-1)return;c<=d&&(o=c)}if(i=s[o]||r.target,i!==e){tg(r,"currentTarget",{configurable:!0,get(){return i||t}});var f=me,a=_e;qt(null),Br(null);try{for(var u,h=[];i!==null;){var p=i.assignedSlot||i.parentNode||i.host||null;try{var y=i["__"+n];y!=null&&(!i.disabled||r.target===i)&&y.call(i,r)}catch(g){u?h.push(g):u=g}if(r.cancelBubble||p===e||p===null)break;i=p}if(u){for(let g of h)queueMicrotask(()=>{throw g});throw u}}finally{r.__root=e,delete r.currentTarget,qt(f),Br(a)}}}function $_(r){var e=document.createElement("template");return e.innerHTML=r.replaceAll("<!>","<!---->"),e.content}function zc(r,e){var t=_e;t.nodes===null&&(t.nodes={start:r,end:e,a:null,t:null})}function se(r,e){var t=(e&t_)!==0,n=(e&r_)!==0,s,i=!r.startsWith("<!>");return()=>{s===void 0&&(s=$_(i?r:"<!>"+r),t||(s=Aa(s)));var o=n||Eg?document.importNode(s,!0):s.cloneNode(!0);if(t){var l=Aa(o),c=o.lastChild;zc(l,c)}else zc(o,o);return o}}function Yr(){var r=document.createDocumentFragment(),e=document.createComment(""),t=Pn();return r.append(e,t),zc(e,t),r}function J(r,e){r!==null&&r.before(e)}let Wc=!0;function He(r,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(r.__t??=r.nodeValue)&&(r.__t=t,r.nodeValue=t+"")}function F_(r,e){return U_(r,e)}const Ps=new Map;function U_(r,{target:e,anchor:t,props:n={},events:s,context:i,intro:o=!0}){w_();var l=new Set,c=a=>{for(var u=0;u<a.length;u++){var h=a[u];if(!l.has(h)){l.add(h);var p=M_(h);e.addEventListener(h,Fi,{passive:p});var y=Ps.get(h);y===void 0?(document.addEventListener(h,Fi,{passive:p}),Ps.set(h,1)):Ps.set(h,y+1)}}};c(xl(Kg)),Hc.add(c);var d=void 0,f=I_(()=>{var a=t??e.appendChild(Pn());return h_(a,{pending:()=>{}},u=>{if(i){ft({});var h=ut;h.c=i}s&&(n.$$events=s),Wc=o,d=r(u,n)||{},Wc=!0,i&&ht()}),()=>{for(var u of l){e.removeEventListener(u,Fi);var h=Ps.get(u);--h===0?(document.removeEventListener(u,Fi),Ps.delete(u)):Ps.set(u,h)}Hc.delete(c),a!==t&&a.parentNode?.removeChild(a)}});return V_.set(d,f),d}let V_=new WeakMap;class ed{anchor;#e=new Map;#r=new Map;#t=new Map;#n=new Set;#i=!0;constructor(e,t=!0){this.anchor=e,this.#i=t}#a=()=>{var e=We;if(this.#e.has(e)){var t=this.#e.get(e),n=this.#r.get(t);if(n)Ju(n),this.#n.delete(t);else{var s=this.#t.get(t);s&&(this.#r.set(t,s.effect),this.#t.delete(t),s.fragment.lastChild.remove(),this.anchor.before(s.fragment),n=s.effect)}for(const[i,o]of this.#e){if(this.#e.delete(i),i===e)break;const l=this.#t.get(o);l&&(Wt(l.effect),this.#t.delete(o))}for(const[i,o]of this.#r){if(i===t||this.#n.has(i))continue;const l=()=>{if(Array.from(this.#e.values()).includes(i)){var d=document.createDocumentFragment();Bg(o,d),d.append(Pn()),this.#t.set(i,{effect:o,fragment:d})}else Wt(o);this.#n.delete(i),this.#r.delete(i)};this.#i||!n?(this.#n.add(i),ls(o,l,!1)):l()}}};#s=e=>{this.#e.delete(e);const t=Array.from(this.#e.values());for(const[n,s]of this.#t)t.includes(n)||(Wt(s.effect),this.#t.delete(n))};ensure(e,t){var n=We,s=Ig();if(t&&!this.#r.has(e)&&!this.#t.has(e))if(s){var i=document.createDocumentFragment(),o=Pn();i.append(o),this.#t.set(e,{effect:ar(()=>t(o)),fragment:i})}else this.#r.set(e,ar(()=>t(this.anchor)));if(this.#e.set(n,e),s){for(const[l,c]of this.#r)l===e?n.skipped_effects.delete(c):n.skipped_effects.add(c);for(const[l,c]of this.#t)l===e?n.skipped_effects.delete(c.effect):n.skipped_effects.add(c.effect);n.oncommit(this.#a),n.ondiscard(this.#s)}else this.#a()}}function we(r,e,t=!1){var n=new ed(r),s=t?On:0;function i(o,l){n.ensure(o,l)}Co(()=>{var o=!1;e((l,c=!0)=>{o=!0,i(c,l)}),o||i(!1,null)},s)}function K_(r,e,t){var n=new ed(r),s=!wi();Co(()=>{var i=e();s&&i!==null&&typeof i=="object"&&(i={}),n.ensure(i,t)})}function ti(r,e){return e}function q_(r,e,t){for(var n=[],s=e.length,i,o=e.length,l=0;l<s;l++){let a=e[l];ls(a,()=>{if(i){if(i.pending.delete(a),i.done.add(a),i.pending.size===0){var u=r.outrogroups;Gc(xl(i.done)),u.delete(i),u.size===0&&(r.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=n.length===0&&t!==null;if(c){var d=t,f=d.parentNode;__(f),f.append(d),r.items.clear()}Gc(e,!c)}else i={pending:new Set(e),done:new Set},(r.outrogroups??=new Set).add(i)}function Gc(r,e=!0){for(var t=0;t<r.length;t++)Wt(r[t],e)}var Mf;function Dn(r,e,t,n,s,i=null){var o=r,l=new Map,c=(e&ag)!==0;if(c){var d=r;o=d.appendChild(Pn())}var f=null,a=ro(()=>{var m=t();return eg(m)?m:m==null?[]:xl(m)}),u,h=!0;function p(){g.fallback=f,H_(g,u,o,e,n),f!==null&&(u.length===0?(f.f&Zr)===0?Ju(f):(f.f^=Zr,Ui(f,null,o)):ls(f,()=>{f=null}))}var y=Co(()=>{u=b(a);for(var m=u.length,w=new Set,v=We,_=Ig(),k=0;k<m;k+=1){var P=u[k],D=n(P,k),I=h?null:l.get(D);I?(I.v&&ei(I.v,P),I.i&&ei(I.i,k),_&&v.skipped_effects.delete(I.e)):(I=z_(l,h?o:Mf??=Pn(),P,D,k,s,e,t),h||(I.e.f|=Zr),l.set(D,I)),w.add(D)}if(m===0&&i&&!f&&(h?f=ar(()=>i(o)):(f=ar(()=>i(Mf??=Pn())),f.f|=Zr)),!h)if(_){for(const[x,B]of l)w.has(x)||v.skipped_effects.add(B.e);v.oncommit(p),v.ondiscard(()=>{})}else p();b(a)}),g={effect:y,items:l,outrogroups:null,fallback:f};h=!1}function H_(r,e,t,n,s){var i=(n&z0)!==0,o=e.length,l=r.items,c=r.effect.first,d,f=null,a,u=[],h=[],p,y,g,m;if(i)for(m=0;m<o;m+=1)p=e[m],y=s(p,m),g=l.get(y).e,(g.f&Zr)===0&&(g.nodes?.a?.measure(),(a??=new Set).add(g));for(m=0;m<o;m+=1){if(p=e[m],y=s(p,m),g=l.get(y).e,r.outrogroups!==null)for(const B of r.outrogroups)B.pending.delete(g),B.done.delete(g);if((g.f&Zr)!==0)if(g.f^=Zr,g===c)Ui(g,null,t);else{var w=f?f.next:c;g===r.effect.last&&(r.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),yn(r,f,g),yn(r,g,w),Ui(g,w,t),f=g,u=[],h=[],c=f.next;continue}if((g.f&er)!==0&&(Ju(g),i&&(g.nodes?.a?.unfix(),(a??=new Set).delete(g))),g!==c){if(d!==void 0&&d.has(g)){if(u.length<h.length){var v=h[0],_;f=v.prev;var k=u[0],P=u[u.length-1];for(_=0;_<u.length;_+=1)Ui(u[_],v,t);for(_=0;_<h.length;_+=1)d.delete(h[_]);yn(r,k.prev,P.next),yn(r,f,k),yn(r,P,v),c=v,f=P,m-=1,u=[],h=[]}else d.delete(g),Ui(g,c,t),yn(r,g.prev,g.next),yn(r,g,f===null?r.effect.first:f.next),yn(r,f,g),f=g;continue}for(u=[],h=[];c!==null&&c!==g;)(d??=new Set).add(c),h.push(c),c=c.next;if(c===null)continue}(g.f&Zr)===0&&u.push(g),f=g,c=g.next}if(r.outrogroups!==null){for(const B of r.outrogroups)B.pending.size===0&&(Gc(xl(B.done)),r.outrogroups?.delete(B));r.outrogroups.size===0&&(r.outrogroups=null)}if(c!==null||d!==void 0){var D=[];if(d!==void 0)for(g of d)(g.f&er)===0&&D.push(g);for(;c!==null;)(c.f&er)===0&&c!==r.fallback&&D.push(c),c=c.next;var I=D.length;if(I>0){var x=(n&ag)!==0&&o===0?t:null;if(i){for(m=0;m<I;m+=1)D[m].nodes?.a?.measure();for(m=0;m<I;m+=1)D[m].nodes?.a?.fix()}q_(r,D,x)}}i&&Is(()=>{if(a!==void 0)for(g of a)g.nodes?.a?.apply()})}function z_(r,e,t,n,s,i,o,l){var c=(o&q0)!==0?(o&W0)===0?_g(t,!1,!1):ms(t):null,d=(o&H0)!==0?ms(s):null;return{v:c,i:d,e:ar(()=>(i(e,c??t,d??s,l),()=>{r.delete(n)}))}}function Ui(r,e,t){if(r.nodes)for(var n=r.nodes.start,s=r.nodes.end,i=e&&(e.f&Zr)===0?e.nodes.start:t;n!==null;){var o=ko(n);if(i.before(n),n===s)return;n=o}}function yn(r,e,t){e===null?r.effect.first=t:e.next=t,t===null?r.effect.last=e:t.prev=e}function qg(r,e,...t){var n=new ed(r);Co(()=>{const s=e()??null;n.ensure(s,s&&(i=>s(i,...t)))},On)}const W_=()=>performance.now(),Xr={tick:r=>requestAnimationFrame(r),now:()=>W_(),tasks:new Set};function Hg(){const r=Xr.now();Xr.tasks.forEach(e=>{e.c(r)||(Xr.tasks.delete(e),e.f())}),Xr.tasks.size!==0&&Xr.tick(Hg)}function G_(r){let e;return Xr.tasks.size===0&&Xr.tick(Hg),{promise:new Promise(t=>{Xr.tasks.add(e={c:r,f:t})}),abort(){Xr.tasks.delete(e)}}}function Go(r,e){_i(()=>{r.dispatchEvent(new CustomEvent(e))})}function Y_(r){if(r==="float")return"cssFloat";if(r==="offset")return"cssOffset";if(r.startsWith("--"))return r;const e=r.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function Of(r){const e={},t=r.split(";");for(const n of t){const[s,i]=n.split(":");if(!s||i===void 0)break;const o=Y_(s.trim());e[o]=i.trim()}return e}const X_=r=>r;function xe(r,e,t,n){var s=(r&Q0)!==0,i=(r&J0)!==0,o=s&&i,l=(r&e_)!==0,c=o?"both":s?"in":"out",d,f=e.inert,a=e.style.overflow,u,h;function p(){return _i(()=>d??=t()(e,n?.()??{},{direction:c}))}var y={is_global:l,in(){if(e.inert=f,!s){h?.abort(),h?.reset?.();return}i||u?.abort(),Go(e,"introstart"),u=Yc(e,p(),h,1,()=>{Go(e,"introend"),u?.abort(),u=d=void 0,e.style.overflow=a})},out(v){if(!i){v?.(),d=void 0;return}e.inert=!0,Go(e,"outrostart"),h=Yc(e,p(),u,0,()=>{Go(e,"outroend"),v?.()})},stop:()=>{u?.abort(),h?.abort()}},g=_e;if((g.nodes.t??=[]).push(y),s&&Wc){var m=l;if(!m){for(var w=g.parent;w&&(w.f&On)!==0;)for(;(w=w.parent)&&(w.f&Mr)===0;);m=!w||(w.f&Al)!==0}m&&kl(()=>{ct(()=>y.in())})}}function Yc(r,e,t,n,s){var i=n===1;if(T0(e)){var o,l=!1;return Is(()=>{if(!l){var g=e({direction:i?"in":"out"});o=Yc(r,g,t,n,s)}}),{abort:()=>{l=!0,o?.abort()},deactivate:()=>o.deactivate(),reset:()=>o.reset(),t:()=>o.t()}}if(t?.deactivate(),!e?.duration)return s(),{abort:Kt,deactivate:Kt,reset:Kt,t:()=>n};const{delay:c=0,css:d,tick:f,easing:a=X_}=e;var u=[];if(i&&t===void 0&&(f&&f(0,1),d)){var h=Of(d(0,1));u.push(h,h)}var p=()=>1-n,y=r.animate(u,{duration:c,fill:"forwards"});return y.onfinish=()=>{y.cancel();var g=t?.t()??1-n;t?.abort();var m=n-g,w=e.duration*Math.abs(m),v=[];if(w>0){var _=!1;if(d)for(var k=Math.ceil(w/16.666666666666668),P=0;P<=k;P+=1){var D=g+m*a(P/k),I=Of(d(D,1-D));v.push(I),_||=I.overflow==="hidden"}_&&(r.style.overflow="hidden"),p=()=>{var x=y.currentTime;return g+m*a(x/w)},f&&G_(()=>{if(y.playState!=="running")return!1;var x=p();return f(x,1-x),!0})}y=r.animate(v,{duration:w,fill:"forwards"}),y.onfinish=()=>{p=()=>n,f?.(n,1-n),s()}},{abort:()=>{y&&(y.cancel(),y.effect=null,y.onfinish=Kt)},deactivate:()=>{s=Kt},reset:()=>{n===0&&f?.(1,0)},t:()=>p()}}function zg(r,e,t){kl(()=>{var n=ct(()=>e(r,t?.())||{});if(n?.destroy)return()=>n.destroy()})}function Wg(r){var e,t,n="";if(typeof r=="string"||typeof r=="number")n+=r;else if(typeof r=="object")if(Array.isArray(r)){var s=r.length;for(e=0;e<s;e++)r[e]&&(t=Wg(r[e]))&&(n&&(n+=" "),n+=t)}else for(t in r)r[t]&&(n&&(n+=" "),n+=t);return n}function Z_(){for(var r,e,t=0,n="",s=arguments.length;t<s;t++)(r=arguments[t])&&(e=Wg(r))&&(n&&(n+=" "),n+=e);return n}function Gg(r){return typeof r=="object"?Z_(r):r??""}const $f=[...` 	
\r\fÂ \v\uFEFF`];function j_(r,e,t){var n=r==null?"":""+r;if(e&&(n=n?n+" "+e:e),t){for(var s in t)if(t[s])n=n?n+" "+s:s;else if(n.length)for(var i=s.length,o=0;(o=n.indexOf(s,o))>=0;){var l=o+i;(o===0||$f.includes(n[o-1]))&&(l===n.length||$f.includes(n[l]))?n=(o===0?"":n.substring(0,o))+n.substring(l+1):o=l}}return n===""?null:n}function Ff(r,e=!1){var t=e?" !important;":";",n="";for(var s in r){var i=r[s];i!=null&&i!==""&&(n+=" "+s+": "+i+t)}return n}function ec(r){return r[0]!=="-"||r[1]!=="-"?r.toLowerCase():r}function Q_(r,e){if(e){var t="",n,s;if(Array.isArray(e)?(n=e[0],s=e[1]):n=e,r){r=String(r).replaceAll(/\s*\/\*.*?\*\/\s*/g,"").trim();var i=!1,o=0,l=!1,c=[];n&&c.push(...Object.keys(n).map(ec)),s&&c.push(...Object.keys(s).map(ec));var d=0,f=-1;const y=r.length;for(var a=0;a<y;a++){var u=r[a];if(l?u==="/"&&r[a-1]==="*"&&(l=!1):i?i===u&&(i=!1):u==="/"&&r[a+1]==="*"?l=!0:u==='"'||u==="'"?i=u:u==="("?o++:u===")"&&o--,!l&&i===!1&&o===0){if(u===":"&&f===-1)f=a;else if(u===";"||a===y-1){if(f!==-1){var h=ec(r.substring(d,f).trim());if(!c.includes(h)){u!==";"&&a++;var p=r.substring(d,a).trim();t+=" "+p+";"}}d=a+1,f=-1}}}}return n&&(t+=Ff(n)),s&&(t+=Ff(s,!0)),t=t.trim(),t===""?null:t}return r==null?null:String(r)}function Ue(r,e,t,n,s,i){var o=r.__className;if(o!==t||o===void 0){var l=j_(t,n,i);l==null?r.removeAttribute("class"):r.className=l,r.__className=t}else if(i&&s!==i)for(var c in i){var d=!!i[c];(s==null||d!==!!s[c])&&r.classList.toggle(c,d)}return i}function tc(r,e={},t,n){for(var s in t){var i=t[s];e[s]!==i&&(t[s]==null?r.style.removeProperty(s):r.style.setProperty(s,i,n))}}function Ct(r,e,t,n){var s=r.__style;if(s!==e){var i=Q_(e,n);i==null?r.removeAttribute("style"):r.style.cssText=i,r.__style=e}else n&&(Array.isArray(n)?(tc(r,t?.[0],n[0]),tc(r,t?.[1],n[1],"important")):tc(r,t,n));return n}const J_=Symbol("is custom element"),e1=Symbol("is html");function Xc(r,e){var t=td(r);t.value===(t.value=e??void 0)||r.value===e&&(e!==0||r.nodeName!=="PROGRESS")||(r.value=e??"")}function t1(r,e){var t=td(r);t.checked!==(t.checked=e??void 0)&&(r.checked=e)}function Ln(r,e,t,n){var s=td(r);s[e]!==(s[e]=t)&&(e==="loading"&&(r[L0]=t),t==null?r.removeAttribute(e):typeof t!="string"&&r1(r).includes(e)?r[e]=t:r.setAttribute(e,t))}function td(r){return r.__attributes??={[J_]:r.nodeName.includes("-"),[e1]:r.namespaceURI===n_}}var Uf=new Map;function r1(r){var e=r.getAttribute("is")||r.nodeName,t=Uf.get(e);if(t)return t;Uf.set(e,t=[]);for(var n,s=r,i=Element.prototype;i!==s;){n=rg(s);for(var o in n)n[o].set&&t.push(o);s=zu(s)}return t}function Vf(r,e,t=e){E_(r,"change",n=>{var s=n?r.defaultChecked:r.checked;t(s)}),ct(e)==null&&t(r.checked),Qu(()=>{var n=e();r.checked=!!n})}class rd{#e=new WeakMap;#r;#t;static entries=new WeakMap;constructor(e){this.#t=e}observe(e,t){var n=this.#e.get(e)||new Set;return n.add(t),this.#e.set(e,n),this.#n().observe(e,this.#t),()=>{var s=this.#e.get(e);s.delete(t),s.size===0&&(this.#e.delete(e),this.#r.unobserve(e))}}#n(){return this.#r??(this.#r=new ResizeObserver(e=>{for(var t of e){rd.entries.set(t.target,t);for(var n of this.#e.get(t.target)||[])n(t)}}))}}var n1=new rd({box:"border-box"});function Kf(r,e,t){var n=n1.observe(r,()=>t(r[e]));kl(()=>(ct(()=>t(r[e])),n))}function qf(r,e){return r===e||r?.[as]===e}function Ze(r={},e,t,n){return kl(()=>{var s,i;return Qu(()=>{s=i,i=[],ct(()=>{r!==t(...i)&&(e(r,...i),s&&qf(t(...s),r)&&e(null,...s))})}),()=>{Is(()=>{i&&qf(t(...i),r)&&e(null,...i)})}}),r}function s1(r=!1){const e=ut,t=e.l.u;if(!t)return;let n=()=>B_(e.s);if(r){let s=0,i={};const o=Io(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==i[d]&&(i[d]=c[d],l=!0);return l&&s++,s});n=()=>b(o)}t.b.length&&A_(()=>{Hf(e,n),Sa(t.b)}),st(()=>{const s=ct(()=>t.m.map(P0));return()=>{for(const i of s)typeof i=="function"&&i()}}),t.a.length&&st(()=>{Hf(e,n),Sa(t.a)})}function Hf(r,e){if(r.l.s)for(const t of r.l.s)b(t);e()}function nd(r,e,t){if(r==null)return e(void 0),t&&t(void 0),Kt;const n=ct(()=>r.subscribe(e,t));return n.unsubscribe?()=>n.unsubscribe():n}const Ds=[];function Vi(r,e){return{subscribe:ir(r,e).subscribe}}function ir(r,e=Kt){let t=null;const n=new Set;function s(l){if(cg(r,l)&&(r=l,t)){const c=!Ds.length;for(const d of n)d[1](),Ds.push(d,r);if(c){for(let d=0;d<Ds.length;d+=2)Ds[d][0](Ds[d+1]);Ds.length=0}}}function i(l){s(l(r))}function o(l,c=Kt){const d=[l,c];return n.add(d),n.size===1&&(t=e(s,i)||Kt),l(r),()=>{n.delete(d),n.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:o}}function i1(r,e,t){const n=!Array.isArray(r),s=n?[r]:r;if(!s.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const i=e.length<2;return Vi(t,(o,l)=>{let c=!1;const d=[];let f=0,a=Kt;const u=()=>{if(f)return;a();const p=e(n?d[0]:d,o,l);i?o(p):a=typeof p=="function"?p:Kt},h=s.map((p,y)=>nd(p,g=>{d[y]=g,f&=~(1<<y),c&&u()},()=>{f|=1<<y}));return c=!0,u(),function(){Sa(h),a(),c=!1}})}function Si(r){let e;return nd(r,t=>e=t)(),e}let Yo=!1,Zc=Symbol();function fe(r,e,t){const n=t[e]??={store:null,source:_g(void 0),unsubscribe:Kt};if(n.store!==r&&!(Zc in t))if(n.unsubscribe(),n.store=r??null,r==null)n.source.v=void 0,n.unsubscribe=Kt;else{var s=!0;n.unsubscribe=nd(r,i=>{s?n.source.v=i:X(n.source,i)}),s=!1}return r&&Zc in t?Si(r):b(n.source)}function Nt(r,e){return r.set(e),e}function tr(){const r={};function e(){ju(()=>{for(var t in r)r[t].unsubscribe();tg(r,Zc,{enumerable:!1,value:!0})})}return[r,e]}function ha(r,e,t){return r.set(t),e}function o1(r){var e=Yo;try{return Yo=!1,[r(),Yo]}finally{Yo=e}}function Qr(r,e,t,n){var s=!Ao||(t&Y0)!==0,i=(t&Z0)!==0,o=(t&j0)!==0,l=n,c=!0,d=()=>(c&&(c=!1,l=o?ct(n):n),l),f;if(i){var a=as in r||D0 in r;f=Hs(r,e)?.set??(a&&e in r?v=>r[e]=v:void 0)}var u,h=!1;i?[u,h]=o1(()=>r[e]):u=r[e],u===void 0&&n!==void 0&&(u=d(),f&&(s&&$0(),f(u)));var p;if(s?p=()=>{var v=r[e];return v===void 0?d():(c=!0,v)}:p=()=>{var v=r[e];return v!==void 0&&(l=void 0),v===void 0?l:v},s&&(t&X0)===0)return p;if(f){var y=r.$$legacy;return(function(v,_){return arguments.length>0?((!s||!_||y||h)&&f(_?p():v),v):p()})}var g=!1,m=((t&G0)!==0?Io:ro)(()=>(g=!1,p()));i&&b(m);var w=_e;return(function(v,_){if(arguments.length>0){const k=_?b(m):s&&i?jr(v):v;return X(m,k),g=!0,l!==void 0&&(l=k),v}return $n&&g||(w.f&en)!==0?m.v:b(m)})}const a1="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(a1);class l1{data;indexes;#e;#r;#t;constructor({data:e=[],maxSize:t=1/0,compare:n=(i,o)=>i<o?-1:i>o?1:0,extractKey:s=i=>i}={}){if(this.data=e,this.indexes=new Map(e.map((i,o)=>[s(i),o])),this.#e=t,this.#r=n,this.#t=s,e.length>0)for(let i=(e.length>>>1)-1;i>=0;i--)this.#i(i)}#n(e){const{data:t,indexes:n}=this,s=this.#r,i=this.#t,o=t[e];for(;e>0;){const l=e-1>>>1,c=t[l];if(s(o,c)>=0)break;n.set(i(c),e),t[e]=c,e=l}n.set(i(o),e),t[e]=o}#i(e){const{data:t,indexes:n}=this,s=this.#r,i=this.#t,o=t[e],l=t.length>>>1;for(;e<l;){let c=(e<<1)+1,d=t[c];const f=c+1;if(f<t.length){const a=t[f];s(a,d)<0&&(c=f,d=a)}if(s(d,o)>=0)break;n.set(i(d),e),t[e]=d,e=c}n.set(i(o),e),t[e]=o}push(e){const t=this.#t(e),n=this.indexes.get(t);if(n===void 0)return this.data.push(e),this.#n(this.data.length-1),this.data.length<=this.#e?void 0:this.pop();const s=this.data[n];this.data[n]=e;const i=this.#r(s,e);i<0?this.#i(n):i>0&&this.#n(n)}pop(){if(this.data.length===0)return;const e=this.data[0];this.indexes.delete(this.#t(e));const t=this.data.pop();return this.data.length>0&&t!==void 0&&(this.indexes.set(this.#t(t),0),this.data[0]=t,this.#i(0)),e}peek(){return this.data[0]}remove(e){const t=this.indexes.get(e);if(t===void 0)return!1;const n=this.data.length-1;if(t===n)return this.indexes.delete(e),this.data.pop(),!0;const s=this.data.pop();this.indexes.delete(e),this.indexes.set(this.#t(s),t),this.data[t]=s;const i=t-1>>>1;return t>0&&this.#r(s,this.data[i])<0?this.#n(t):this.#i(t),!0}has(e){return this.indexes.has(e)}get(e){const t=this.indexes.get(e);return t!==void 0?this.data[t]:void 0}clear(){this.data=[],this.indexes.clear()}get size(){return this.data.length}*[Symbol.iterator](){yield*this.data}}function c1(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Cl(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function u1(r){return new TextEncoder().encode(r)}function d1(r){return new TextDecoder().decode(r)}function f1(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var l=r.length,c=r.charAt(0),d=Math.log(l)/Math.log(256),f=Math.log(256)/Math.log(l);function a(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var y=0,g=0,m=0,w=p.length;m!==w&&p[m]===0;)m++,y++;for(var v=(w-m)*f+1>>>0,_=new Uint8Array(v);m!==w;){for(var k=p[m],P=0,D=v-1;(k!==0||P<g)&&D!==-1;D--,P++)k+=256*_[D]>>>0,_[D]=k%l>>>0,k=k/l>>>0;if(k!==0)throw new Error("Non-zero carry");g=P,m++}for(var I=v-g;I!==v&&_[I]===0;)I++;for(var x=c.repeat(y);I<v;++I)x+=r.charAt(_[I]);return x}function u(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var y=0;if(p[y]!==" "){for(var g=0,m=0;p[y]===c;)g++,y++;for(var w=(p.length-y)*d+1>>>0,v=new Uint8Array(w);p[y];){var _=t[p.charCodeAt(y)];if(_===255)return;for(var k=0,P=w-1;(_!==0||k<m)&&P!==-1;P--,k++)_+=l*v[P]>>>0,v[P]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");m=k,y++}if(p[y]!==" "){for(var D=w-m;D!==w&&v[D]===0;)D++;for(var I=new Uint8Array(g+(w-D)),x=g;D!==w;)I[x++]=v[D++];return I}}}function h(p){var y=u(p);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:a,decodeUnsafe:u,decode:h}}var h1=f1,p1=h1;class g1{name;prefix;baseEncode;constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}let m1=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,n){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Yg(this,e)}};class y1{decoders;constructor(e){this.decoders=e}or(e){return Yg(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function Yg(r,e){return new y1({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class b1{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new g1(e,t,n),this.decoder=new m1(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function Tl({name:r,prefix:e,encode:t,decode:n}){return new b1(r,e,t,n)}function Po({name:r,prefix:e,alphabet:t}){const{encode:n,decode:s}=p1(t,r);return Tl({prefix:e,name:r,encode:n,decode:i=>Cl(s(i))})}function v1(r,e,t,n){let s=r.length;for(;r[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let o=0,l=0,c=0;for(let d=0;d<s;++d){const f=e[r[d]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);l=l<<t|f,o+=t,o>=8&&(o-=8,i[c++]=255&l>>o)}if(o>=t||(255&l<<8-o)!==0)throw new SyntaxError("Unexpected end of data");return i}function w1(r,e,t){const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,l=0;for(let c=0;c<r.length;++c)for(l=l<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&l>>o];if(o!==0&&(i+=e[s&l<<t-o]),n)for(;(i.length*t&7)!==0;)i+="=";return i}function _1(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function St({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const s=_1(n);return Tl({prefix:e,name:r,encode(i){return w1(i,n,t)},decode(i){return v1(i,s,t,r)}})}const S1=Po({prefix:"9",name:"base10",alphabet:"0123456789"}),E1=Object.freeze(Object.defineProperty({__proto__:null,base10:S1},Symbol.toStringTag,{value:"Module"})),x1=St({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),A1=St({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),I1=Object.freeze(Object.defineProperty({__proto__:null,base16:x1,base16upper:A1},Symbol.toStringTag,{value:"Module"})),k1=St({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),C1=Object.freeze(Object.defineProperty({__proto__:null,base2:k1},Symbol.toStringTag,{value:"Module"})),Xg=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),T1=Xg.reduce((r,e,t)=>(r[t]=e,r),[]),P1=Xg.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function D1(r){return r.reduce((e,t)=>(e+=T1[t],e),"")}function L1(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const s=P1[n];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const R1=Tl({prefix:"ðŸš€",name:"base256emoji",encode:D1,decode:L1}),B1=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:R1},Symbol.toStringTag,{value:"Module"})),Rn=St({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),N1=St({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),M1=St({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),O1=St({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),$1=St({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),F1=St({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),U1=St({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),V1=St({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),K1=St({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),q1=Object.freeze(Object.defineProperty({__proto__:null,base32:Rn,base32hex:$1,base32hexpad:U1,base32hexpadupper:V1,base32hexupper:F1,base32pad:M1,base32padupper:O1,base32upper:N1,base32z:K1},Symbol.toStringTag,{value:"Module"})),pa=Po({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),H1=Po({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),z1=Object.freeze(Object.defineProperty({__proto__:null,base36:pa,base36upper:H1},Symbol.toStringTag,{value:"Module"})),Pe=Po({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),W1=Po({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),G1=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Pe,base58flickr:W1},Symbol.toStringTag,{value:"Module"})),Do=St({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Y1=St({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Zg=St({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),X1=St({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Z1=Object.freeze(Object.defineProperty({__proto__:null,base64:Do,base64pad:Y1,base64url:Zg,base64urlpad:X1},Symbol.toStringTag,{value:"Module"})),j1=St({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Q1=Object.freeze(Object.defineProperty({__proto__:null,base8:j1},Symbol.toStringTag,{value:"Module"})),J1=Tl({prefix:"\0",name:"identity",encode:r=>d1(r),decode:r=>u1(r)}),eS=Object.freeze(Object.defineProperty({__proto__:null,identity:J1},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;var tS=jg,zf=128,rS=-128,nS=Math.pow(2,31);function jg(r,e,t){e=e||[],t=t||0;for(var n=t;r>=nS;)e[t++]=r&255|zf,r/=128;for(;r&rS;)e[t++]=r&255|zf,r>>>=7;return e[t]=r|0,jg.bytes=t-n+1,e}var sS=jc,iS=128,Wf=127;function jc(r,n){var t=0,n=n||0,s=0,i=n,o,l=r.length;do{if(i>=l)throw jc.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Wf)<<s:(o&Wf)*Math.pow(2,s),s+=7}while(o>=iS);return jc.bytes=i-n,t}var oS=Math.pow(2,7),aS=Math.pow(2,14),lS=Math.pow(2,21),cS=Math.pow(2,28),uS=Math.pow(2,35),dS=Math.pow(2,42),fS=Math.pow(2,49),hS=Math.pow(2,56),pS=Math.pow(2,63),gS=function(r){return r<oS?1:r<aS?2:r<lS?3:r<cS?4:r<uS?5:r<dS?6:r<fS?7:r<hS?8:r<pS?9:10},mS={encode:tS,decode:sS,encodingLength:gS},Ca=mS;function Qc(r,e=0){return[Ca.decode(r,e),Ca.decode.bytes]}function Ta(r,e,t=0){return Ca.encode(r,e,t),e}function Pa(r){return Ca.encodingLength(r)}function Ei(r,e){const t=e.byteLength,n=Pa(r),s=n+Pa(t),i=new Uint8Array(s+t);return Ta(r,i,0),Ta(t,i,n),i.set(e,s),new sd(r,t,e,i)}function hn(r){const e=Cl(r),[t,n]=Qc(e),[s,i]=Qc(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new sd(t,s,o,e)}function yS(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&c1(r.bytes,t.bytes)}}class sd{code;size;digest;bytes;constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}const Qg=0,bS="identity",Jg=Cl;function vS(r,e){if(e?.truncate!=null&&e.truncate!==r.byteLength){if(e.truncate<0||e.truncate>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,e.truncate)}return Ei(Qg,Jg(r))}const it={code:Qg,name:bS,encode:Jg,digest:vS},wS=20;function _S({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:s}){return new SS(r,e,t,n,s)}class SS{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,n,s,i){this.name=e,this.code=t,this.encode=n,this.minDigestLength=s??wS,this.maxDigestLength=i}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?Gf(n,this.code,t?.truncate):n.then(s=>Gf(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}}function Gf(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return Ei(e,r)}function ES(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const pr=_S({name:"sha2-256",code:18,encode:ES("SHA-256")});function Yf(r,e){const{bytes:t,version:n}=r;return n===0?AS(t,Jc(r),e??Pe.encoder):IS(t,Jc(r),e??Rn.encoder)}const Xf=new WeakMap;function Jc(r){const e=Xf.get(r);if(e==null){const t=new Map;return Xf.set(r,t),t}return e}class ue{code;version;multihash;bytes;"/";constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ci)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==kS)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ue.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Ei(e,t);return ue.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ue.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&yS(e.multihash,n.multihash)}toString(e){return Yf(this,e)}toJSON(){return{"/":Yf(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ue)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ue(n,s,i,o??Zf(n,s,i.bytes))}else if(t[CS]===!0){const{version:n,multihash:s,code:i}=t,o=hn(s);return ue.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ci)throw new Error(`Version 0 CID must use dag-pb (code: ${Ci}) block encoding`);return new ue(e,t,n,n.bytes)}case 1:{const s=Zf(e,t,n.bytes);return new ue(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ue.create(0,Ci,e)}static createV1(e,t){return ue.create(1,e,t)}static decode(e){const[t,n]=ue.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ue.inspectBytes(e),n=t.size-t.multihashSize,s=Cl(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new sd(t.multihashCode,t.digestSize,i,s);return[t.version===0?ue.createV0(o):ue.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[a,u]=Qc(e.subarray(t));return t+=u,a};let s=n(),i=Ci;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,l=n(),c=n(),d=t+c,f=d-o;return{version:s,codec:i,multihashCode:l,digestSize:c,multihashSize:f,size:d}}static parse(e,t){const[n,s]=xS(e,t),i=ue.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Jc(i).set(n,e),i}}function xS(r,e){switch(r[0]){case"Q":{const t=e??Pe;return[Pe.prefix,t.decode(`${Pe.prefix}${r}`)]}case Pe.prefix:{const t=e??Pe;return[Pe.prefix,t.decode(r)]}case Rn.prefix:{const t=e??Rn;return[Rn.prefix,t.decode(r)]}case pa.prefix:{const t=e??pa;return[pa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function AS(r,e,t){const{prefix:n}=t;if(n!==Pe.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s}function IS(r,e,t){const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s}const Ci=112,kS=18;function Zf(r,e,t){const n=Pa(r),s=n+Pa(e),i=new Uint8Array(s+t.byteLength);return Ta(r,i,0),Ta(e,i,n),i.set(t,s),i}const CS=Symbol.for("@ipld/js-cid/CID"),eu={...eS,...C1,...Q1,...E1,...I1,...q1,...z1,...G1,...Z1,...B1};function Ke(r=0){return new Uint8Array(r)}function on(r=0){return new Uint8Array(r)}function em(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const jf=em("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),rc=em("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=on(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),tm={utf8:jf,"utf-8":jf,hex:eu.base16,latin1:rc,ascii:rc,binary:rc,...eu};function j(r,e="utf8"){const t=tm[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function W(r,e="utf8"){const t=tm[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const ri=Object.freeze(["/dns4/r2.digifall.app/tcp/443/wss/p2p/12D3KooWPN8DqXM1ytrTs9bxpWt3ZnMLEWxHc3AEX2kKg62qhesv","/dns4/r3.digifall.app/tcp/443/wss/p2p/12D3KooWHUFx2bdvULtrXugaX8T3RX8A8KzoPmRbSMPKDqNNbLUw"]),Fs=Object.freeze({root:"/digifall/root/1.0",preview:"/digifall/preview/1.0"}),TS=Object.freeze(["highCombo","highScore"]);function id(r,e){return r.value>e.value?1:r.value<e.value||r.timestamp<e.timestamp?-1:r.timestamp>e.timestamp?1:0}function PS(r){return r?.playerName??""}function tu(r){return JSON.parse(W(r.subarray()))}function Ls(r){return j(JSON.stringify(r))}function Qf(r){let e=0;for(const t of r)e=e*31+t|0;return e}function DS({playerName:r="",timestamp:e=0}){let t=e|0;for(let n=0;n<r.length;n++)t=t*31+r.charCodeAt(n)|0;return t}function LS(r){return r.length===0?0:Qf(r.slice().sort(id).map(e=>Qf([DS(e),e.value])))}class RS{recordTypes;maxRecords;debug;validateRecord;onUpdate;queues;roots;constructor(e={}){this.recordTypes=e.recordTypes??[...TS],this.maxRecords=e.maxRecords??1e3,this.debug=e.debug??!1,this.validateRecord=e.validateRecord??null,this.onUpdate=e.onUpdate??null,this.queues=Object.fromEntries(this.recordTypes.map(t=>[t,new l1({maxSize:this.maxRecords,compare:id,extractKey:PS})])),this.roots=Object.fromEntries(this.recordTypes.map(t=>[t,0]))}updateRoot(e){const t=this.queues[e];this.roots[e]=t?LS(t.data):0}getQueue(e){return this.queues[e]}getRoots(){return{...this.roots}}getData(e){return this.queues[e]?.data??[]}getAllData(){return Object.fromEntries(this.recordTypes.map(e=>[e,this.getData(e)]))}loadData(e,t){const n=this.queues[e];if(n){for(const s of t)n.push(s);this.updateRoot(e)}}handleRecord(e){const{type:t,playerName:n,value:s}=e,i=this.queues[t];if(!i)return!1;const{data:o,indexes:l}=i,c=l.get(n);return c in o&&o[c].value>=s?!1:(i.push(e),this.updateRoot(t),this.debug&&console.log("LEADERBOARD UPDATED:",t,n,s),this.onUpdate?.(t,i.data),!0)}async handleRecordWithValidation(e){const{type:t,playerName:n,value:s}=e,i=this.queues[t];if(!i)return!1;const{data:o,indexes:l}=i,c=l.get(n);if(c in o&&o[c].value>=s)return!1;if(this.validateRecord)try{const d=await this.validateRecord(e);return d?this.handleRecord(d):!1}catch(d){return this.debug&&console.error(d),!1}return this.handleRecord(e)}createRootHandler(e){return async(t,n)=>{this.debug&&console.log("handleRoot");const s=new Set;t.addEventListener("message",i=>{const o=i.detail??i.data;try{const l=tu(o);if(l===null){if(t.close(),s.size===0||n.status!=="open")return;e(n,Array.from(s));return}if(Array.isArray(l)){const[c,d]=l;if(!(c in this.roots))return;if(d===0){for(const f of this.queues[c].data)t.send(Ls(f));return}d!==this.roots[c]&&s.add(c)}else this.handleRecordWithValidation(l)}catch(l){this.debug&&console.error(l)}})}}createPreviewHandler(){return async(e,t)=>{this.debug&&console.log("handlePreview");const n=new Set,s=Object.fromEntries(this.recordTypes.map(i=>[i,new Set]));e.addEventListener("message",i=>{const o=i.detail??i.data;try{const l=tu(o);if(l===null){Array.from(n).flatMap(u=>this.queues[u].data.filter(h=>!s[u].has(h.playerName))).forEach(u=>e.send(Ls(u))),e.close();return}const{type:c,playerName:d,value:f}=l;if(!(c in this.queues))return;n.add(c);const a=this.queues[c].indexes.get(d);if(a===void 0||this.queues[c].data[a].value>f)return;s[c].add(d)}catch(l){this.debug&&console.error(l)}})}}createPushRoot(e){return async t=>(this.debug&&console.log(Fs.root),t.newStream(Fs.root,{runOnLimitedConnection:!0}).then(async n=>{n.addEventListener("message",s=>{const i=s.detail??s.data;e(i)}),Object.entries(this.roots).forEach(([s,i])=>n.send(Ls([s,i]))),n.send(Ls(null))}).catch(n=>(this.debug&&console.error(n),{error:n})))}createPushPreview(e){return async(t,n)=>(this.debug&&console.log(Fs.preview),t.newStream(Fs.preview,{runOnLimitedConnection:!0}).then(async s=>{s.addEventListener("message",i=>{const o=i.detail??i.data;e(o)}),n.forEach(i=>this.queues[i].data.forEach(({playerName:o,value:l})=>s.send(Ls({type:i,playerName:o,value:l})))),s.send(Ls(null))}).catch(s=>{this.debug&&console.error(s)}))}}const Bn=!!localStorage.getItem("debug"),Jf=Number(localStorage.getItem("reload")),BS=!!localStorage.getItem("use-all-relays"),at=1e3,NS=4e4,Le=Object.freeze({columns:6,rows:6,maxValue:9}),U=Object.freeze({digifall:"digifall",highCombo:"highCombo",highComboPrev:"highComboPrev",highScore:"highScore",highScorePrev:"highScorePrev",leaderboard:"leaderboard",local:"local",moves:"moves",options:"options",peerId:"peerId",playerName:"playerName",records:"records",relays:"relays",score:"score",timestamp:"timestamp",type:"type",value:"value"}),de=Object.freeze({gameOver:"gameOver",leaderboard:"leaderboard",menu:"menu",options:"options",relays:"relays",wellcome:"wellcome"}),te=Object.freeze({blink:"blink",combo:"combo",extra:"extra",fall:"fall",gameOver:"gameOver",idle:"idle",initial:"initial",match:"match",plus:"plus",score:"score"}),Lo=Object.freeze([U.highCombo,U.highScore]),De=Object.freeze({cards:[],energy:{buffer:0,value:100},[U.leaderboard]:{highCombo:[],highScore:[]},log:[],matchedIndexes:new Set,[U.moves]:"",[U.options]:{[U.playerName]:"",[U.leaderboard]:!0,cluster:!0,rapid:!1,sound:!0},[U.relays]:{active:[...ri],applied:[...ri]},overlay:de.menu,phase:te.initial,plusIndex:null,[U.records]:Lo.reduce((r,e)=>(r[e]={[U.playerName]:"",[U.timestamp]:0,[U.moves]:"",[U.value]:0},r),{}),[U.score]:{buffer:0,value:0}}),{abs:rm,sign:od,trunc:nm}=Math;function Da(r=0){return(r*16807+19487171)%2147483647}function MS(r){return btoa(String.fromCodePoint(...r))}function sm(r){return Array.from(atob(r)).map(e=>e.charCodeAt())}function OS(r){const e=BigInt(Number.MAX_SAFE_INTEGER),t=r.reduce((n,s)=>(n=BigInt(`${n}${s}`),n>e&&(n=n%e),n),0);return Number(t)}function hr(r,e,t=0){const{rapid:n}=r.optionsStore.get(),s=!n&&r.movesInitial===null&&t>0;switch(typeof e){case"undefined":return{duration:s?0:400};case"function":return s?setTimeout(()=>e(r),t):e(r);case"object":return s?{duration:0}:e;default:return s?0:e}}function Nr(r,e,{muteRapid:t=!1}={}){if(!e)return;const{sound:n,rapid:s}=r.optionsStore.get();if(!(t&&s)&&!(!n||r.movesInitial!==null||!r.ready)){if(Array.isArray(e)){e.forEach(i=>i&&i());return}e()}}function La(r,e,t){const n=r.recordsStore.get();n[e][U.value]>=t||(n[e]={[U.moves]:r.movesStore.get(),[U.playerName]:r.optionsStore.get().playerName,[U.timestamp]:r.timestampStore.get(),[U.value]:t},r.recordsStore.set(n))}function io(r){return r<Le.maxValue?r+1:0}function Pl(r){const e=Array.from({length:Le.columns},()=>Array.from({length:2*Le.rows}));return r.forEach(({x:t,y:n},s)=>e[t][n]=s),e}function im(r,e){const t=r.phaseStore.get(),{rapid:n}=r.optionsStore.get(),s=Pl(e),i=[],o=new Set;return s.forEach(l=>{let c=0;l.forEach((d,f)=>{if(d===void 0)return++c;const{x:a,value:u}=e[d],h=n||r.movesInitial||t!==te.fall?0:100*(2*c)**.5;i[d]={x:a,y:f-c,value:u,nextValue:io(u),duration:h},c>0&&h>0&&!o.has(h)&&o.add(h)})}),Nr(r,()=>o.forEach(l=>setTimeout(r.sounds.playKick,l)),{muteRapid:!0}),i}function om(r){const e=Pl(r),t=new Set,n=[],s=(i,o,l)=>{if(t.has(o))return;const{x:c,y:d,value:f}=r[o];l!==void 0&&l!==f||(n[i]||(n[i]={value:f,indexes:new Set}),n[i].indexes.add(o),t.add(o),d<Le.rows-1&&s(i,e[c][d+1],f),c<Le.columns-1&&s(i,e[c+1][d],f),d>0&&s(i,e[c][d-1],f),c>0&&s(i,e[c-1][d],f))};return r.forEach((i,o)=>s(o,o)),n.reduce((i,o)=>(o.value===o.indexes.size&&(i.counts++,i.digits.add(o.value),o.indexes.forEach(i.indexes.add,i.indexes)),i),{counts:0,digits:new Set,indexes:new Set})}function am(r,e,t){const n=Array.from({length:Le.columns},()=>0),s=i=>n[i]+e.filter(({x:o})=>o===i).sort(({y:o},{y:l})=>l-o)[0].y;return e.map((i,o)=>i.y<Le.rows&&t.has(o)?(++n[i.x],{x:i.x,y:s(i.x),value:r.getNextCardValue(i.x),duration:0}):i)}function Dl(r,e){if(!r.optionsStore.get().cluster)return e;const t=Pl(e);return e.map(n=>({...n,cluster:$S(e,t,n)}))}function $S(r,e,{x:t,y:n,value:s}){const i=n===Le.rows-1?-1:e[t][n+1],o=t===Le.columns-1?-1:e[t+1][n],l=n===0?-1:e[t][n-1],c=t===0?-1:e[t-1][n],d=i>-1?r[i].value:NaN,f=o>-1?r[o].value:NaN,a=l>-1?r[l].value:NaN,u=c>-1?r[c].value:NaN;return{top:d===s,right:f===s,bottom:a===s,left:u===s}}function lm(r){return od(r)*nm(rm(r)**.5)}function FS(r,{buffer:e,value:t}){const n=r.phaseStore.get(),{rapid:s}=r.optionsStore.get(),i=s||r.movesInitial?e:n===te.gameOver?od(e):lm(e);if(n===te.extra){if(e===0){hr(r,()=>r.phaseStore.set(te.combo),800);return}r.logStore.update(o=>{const l=o.length-1,{extra:c}=o[l];return o[l]={extra:c-i},o})}if(e===0){n===te.gameOver&&Nr(r,()=>setTimeout(r.sounds.playGameOver,600));return}hr(r,()=>{r.energyStore.set({buffer:e-i,value:t+i})},n===te.gameOver?200:32)}function US(r){setTimeout(()=>r.phaseStore.set(te.idle),0)}function VS(r){if(r.movesInitial!==null){if(r.moveCount<r.movesInitial.length){r.plusIndexStore.set(r.movesInitial[r.moveCount++]),r.energyStore.update(({buffer:e,value:t})=>({buffer:e,value:t-10})),r.phaseStore.set(te.plus);return}r.movesInitial=null,La(r,U.highScore,r.scoreStore.get().value);return}r.cardsStore.update(e=>e.map(t=>({...t,duration:0}))),La(r,U.highScore,r.scoreStore.get().value),Nr(r,r.sounds.reset)}function KS(r){r.plusIndexStore.update(e=>(r.cardsStore.update(t=>Dl(r,t.map((n,s)=>{if(s!==e)return n;const i=io(n.value);return{...n,value:i,nextValue:io(i),duration:0}}))),null)),r.phaseStore.set(te.blink)}function qS(r){const e=r.cardsStore.get();let{counts:t,digits:n,indexes:s}=om(e);r.matchedIndexesStore.set(s);const{value:i}=r.energyStore.get();if(s.size>0){const o=Array.from(s);r.logStore.update(c=>c.concat(o.reduce((d,f)=>{const a=e[f];return d[a.value]=(d[a.value]||0)+a.value,d.sum=(d.sum||0)+a.value,d.counts=t,d.digits=Array.from(n),d},{})));const l=o.reduce((c,d)=>c+e[d].value,0);hr(r,()=>r.energyStore.set({buffer:l,value:i}),400),hr(r,()=>r.phaseStore.set(te.match),800),Nr(r,[r.sounds.playWordUp,r.sounds.playBlink],{muteRapid:!0});return}if(i>100){r.phaseStore.set(te.extra);return}if(r.logStore.get().length>0){r.phaseStore.set(te.combo);return}if(i<10){r.phaseStore.set(te.gameOver);return}r.phaseStore.set(te.idle)}function HS(r){r.matchedIndexesStore.update(e=>(r.cardsStore.update(t=>Dl(r,am(r,t,e))),new Set)),hr(r,()=>r.phaseStore.set(te.fall),400)}function zS(r){r.cardsStore.update(e=>Dl(r,im(r,e))),hr(r,()=>r.phaseStore.set(te.blink),400)}function WS(r){r.energyStore.update(({value:e})=>({buffer:100-e,value:e})),r.logStore.update(e=>e.concat({extra:100})),Nr(r,r.sounds.playWordUp,{muteRapid:!0})}function cm(r){return r.reduce((e,{counts:t,extra:n,sum:s},i)=>e+(i+1)*(s||n)*(t||1),0)}function GS(r){const e=r.logStore.get(),t=cm(e);r.scoreStore.update(({value:n})=>({buffer:t,value:n})),La(r,U.highCombo,t),hr(r,()=>r.phaseStore.set(te.score),e.length>1?800:0),Nr(r,r.sounds.playWordUp,{muteRapid:!0})}function YS(r){r.logStore.get().length<2||r.scoreStore.update(e=>({...e}))}function XS(r){hr(r,()=>{r.energyStore.update(({value:e})=>({buffer:-e,value:e})),r.scoreStore.update(({value:e})=>({buffer:r.energyStore.get().value,value:e}))},400)}const ZS={[te.initial]:US,[te.idle]:VS,[te.plus]:KS,[te.blink]:qS,[te.match]:HS,[te.fall]:zS,[te.extra]:WS,[te.combo]:GS,[te.score]:YS,[te.gameOver]:XS};function jS(r,e){ZS[e](r)}function QS(r,e){if(e===null||r.movesInitial!==null)return;let t=r.movesStore.get();t=Array.isArray(t)?t:sm(t),t.push(e),r.movesStore.set(MS(t)),r.energyStore.update(n=>({...n,buffer:-10})),hr(r,()=>r.phaseStore.set(te.plus),400)}function JS(r){switch(rm(r)){case 1:return 130;case 2:case 3:return 80;case 4:case 5:case 6:return 50;case 7:case 8:case 9:case 10:case 11:return 30;default:return 20}}function eE(r,{buffer:e,value:t}){const n=r.phaseStore.get();if(n!==te.gameOver&&n!==te.score)return;if(e===0){if(n===te.gameOver){La(r,U.highScore,t);return}hr(r,()=>{r.logStore.set([]),r.phaseStore.set(r.energyStore.get().value<10?te.gameOver:te.idle),Nr(r,r.sounds.playTurnOn)},200);return}const{rapid:s}=r.optionsStore.get(),i=s||r.movesInitial?e:n===te.gameOver?od(e):lm(e);hr(r,()=>{r.scoreStore.set({buffer:e-i,value:t+i})},n===te.gameOver?200:JS(i)),Nr(r,r.sounds.playBleep,{muteRapid:!0})}function um({playerName:r,timestamp:e}){return r&&typeof r=="string"&&e&&typeof e=="number"&&e<1/0&&OS([e,...Array.from(r).map(t=>t.charCodeAt())])}function tE(r){let e=0;const t=[Da(r)];for(;e<Le.columns-1;)t.push(Da(2*t[e++]));return t}function rE(r){let e=tE(r);return t=>{if(t<0||Le.columns-1<t)return;let n=e[t];return e[t]=Da(n),n%10}}function nE(r){return Array.from({length:Le.columns*Le.rows},(e,t,n,s)=>(n=nm(t/Le.columns),s=r.getNextCardValue(n),{x:n,y:t%Le.rows,value:s,nextValue:io(s),duration:0}))}function sE(r,e){for(;;){const t=om(e).indexes;if(t.size===0)return e;const n=am(r,e,t);e=im(r,n)}}function iE(r,e){if(e==null)return;r.getNextCardValue=rE(e),r.cardsStore.set(Dl(r,sE(r,nE(r))));let t=r.movesStore.get();if(t){if(t=Array.isArray(t)?t:sm(t),t.length>0){r.moveCount=0,r.movesInitial=t;return}r.movesInitial=null}}function dm(r){const e=r.recordsStore.get();r[U.highComboPrev]=e[U.highCombo][U.value],r[U.highScorePrev]=e[U.highScore][U.value]}function fm(r,e){return dm(r),r.sounds=e||{},r.getNextCardValue=()=>0,r.moveCount=0,r.movesInitial=null,r.energyStore.subscribe(t=>{FS(r,t)}),r.phaseStore.subscribe(t=>{jS(r,t)}),r.plusIndexStore.subscribe(t=>{QS(r,t)}),r.scoreStore.subscribe(t=>{eE(r,t)}),r.seedStore.subscribe(t=>{iE(r,t)}),r}function hm(r,e,t){if(e<0)return r.ready=!0;setTimeout(()=>{r.logStore.set(De.log),r.plusIndexStore.set(De.plusIndex),r.matchedIndexesStore.set(De.matchedIndexes),r.movesStore.set(De.moves),r.scoreStore.set(De.score),r.energyStore.set(De.energy),r.phaseStore.set(De.phase),r.timestampStore.set(Date.now()),hm(r,--e),t&&r.optionsStore.update(n=>({...n,playerName:t}))},64)}function oE(r,e){dm(r),Nr(r,r.sounds.playGenerate),r.ready=!1,hm(r,8,e)}var aE=se('<div><div class="value"><div> </div> <div> </div></div></div>');function lE(r,e){ft(e,!0);let t=ie(()=>io(e.card.value));var n=aE();let s,i;var o=O(n),l=O(o);let c,d;var f=O(l),a=z(l,2);let u,h;var p=O(a);Te(()=>{s=Ue(n,1,"card",null,s,{blink:e.blink,focus:e.focus,longpress:e.longpress,plus:e.plus}),Ln(n,"data-index",e.index),i=Ct(n,"",i,{"--card-x":e.card.x,"--card-y":e.card.y,"--card-duration":e.card.duration}),c=Ue(l,1,"current",null,c,{"cluster-top":e.card.cluster&&e.card.cluster.top,"cluster-right":e.card.cluster&&e.card.cluster.right,"cluster-bottom":e.card.cluster&&e.card.cluster.bottom,"cluster-left":e.card.cluster&&e.card.cluster.left,"only-shadow":e.card.y===5}),d=Ct(l,"",d,{"--color":`var(--color-${e.card.value??""})`}),He(f,e.card.value),u=Ue(a,1,"next",null,u,{"only-shadow":e.card.y===5}),h=Ct(a,"",h,{"--color":`var(--color-${b(t)??""})`}),He(p,b(t))}),J(r,n),ht()}var Ti=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ad(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var nc={};var eh;function cE(){return eh||(eh=1,(function(r){(function(){var e=function(){this.init()};e.prototype={init:function(){var a=this||t;return a._counter=1e3,a._html5AudioPool=[],a.html5PoolSize=10,a._codecs={},a._howls=[],a._muted=!1,a._volume=1,a._canPlayEvent="canplaythrough",a._navigator=typeof window<"u"&&window.navigator?window.navigator:null,a.masterGain=null,a.noAudio=!1,a.usingWebAudio=!0,a.autoSuspend=!0,a.ctx=null,a.autoUnlock=!0,a._setup(),a},volume:function(a){var u=this||t;if(a=parseFloat(a),u.ctx||f(),typeof a<"u"&&a>=0&&a<=1){if(u._volume=a,u._muted)return u;u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a,t.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.volume=g._volume*a)}return u}return u._volume},mute:function(a){var u=this||t;u.ctx||f(),u._muted=a,u.usingWebAudio&&u.masterGain.gain.setValueAtTime(a?0:u._volume,t.ctx.currentTime);for(var h=0;h<u._howls.length;h++)if(!u._howls[h]._webAudio)for(var p=u._howls[h]._getSoundIds(),y=0;y<p.length;y++){var g=u._howls[h]._soundById(p[y]);g&&g._node&&(g._node.muted=a?!0:g._muted)}return u},stop:function(){for(var a=this||t,u=0;u<a._howls.length;u++)a._howls[u].stop();return a},unload:function(){for(var a=this||t,u=a._howls.length-1;u>=0;u--)a._howls[u].unload();return a.usingWebAudio&&a.ctx&&typeof a.ctx.close<"u"&&(a.ctx.close(),a.ctx=null,f()),a},codecs:function(a){return(this||t)._codecs[a.replace(/^x-/,"")]},_setup:function(){var a=this||t;if(a.state=a.ctx&&a.ctx.state||"suspended",a._autoSuspend(),!a.usingWebAudio)if(typeof Audio<"u")try{var u=new Audio;typeof u.oncanplaythrough>"u"&&(a._canPlayEvent="canplay")}catch{a.noAudio=!0}else a.noAudio=!0;try{var u=new Audio;u.muted&&(a.noAudio=!0)}catch{}return a.noAudio||a._setupCodecs(),a},_setupCodecs:function(){var a=this||t,u=null;try{u=typeof Audio<"u"?new Audio:null}catch{return a}if(!u||typeof u.canPlayType!="function")return a;var h=u.canPlayType("audio/mpeg;").replace(/^no$/,""),p=a._navigator?a._navigator.userAgent:"",y=p.match(/OPR\/(\d+)/g),g=y&&parseInt(y[0].split("/")[1],10)<33,m=p.indexOf("Safari")!==-1&&p.indexOf("Chrome")===-1,w=p.match(/Version\/(.*?) /),v=m&&w&&parseInt(w[1],10)<15;return a._codecs={mp3:!!(!g&&(h||u.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!h,opus:!!u.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!u.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(u.canPlayType('audio/wav; codecs="1"')||u.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!u.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!u.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(u.canPlayType("audio/x-m4a;")||u.canPlayType("audio/m4a;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(u.canPlayType("audio/x-m4b;")||u.canPlayType("audio/m4b;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(u.canPlayType("audio/x-mp4;")||u.canPlayType("audio/mp4;")||u.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!v&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!v&&u.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!u.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(u.canPlayType("audio/x-flac;")||u.canPlayType("audio/flac;")).replace(/^no$/,"")},a},_unlockAudio:function(){var a=this||t;if(!(a._audioUnlocked||!a.ctx)){a._audioUnlocked=!1,a.autoUnlock=!1,!a._mobileUnloaded&&a.ctx.sampleRate!==44100&&(a._mobileUnloaded=!0,a.unload()),a._scratchBuffer=a.ctx.createBuffer(1,1,22050);var u=function(h){for(;a._html5AudioPool.length<a.html5PoolSize;)try{var p=new Audio;p._unlocked=!0,a._releaseHtml5Audio(p)}catch{a.noAudio=!0;break}for(var y=0;y<a._howls.length;y++)if(!a._howls[y]._webAudio)for(var g=a._howls[y]._getSoundIds(),m=0;m<g.length;m++){var w=a._howls[y]._soundById(g[m]);w&&w._node&&!w._node._unlocked&&(w._node._unlocked=!0,w._node.load())}a._autoResume();var v=a.ctx.createBufferSource();v.buffer=a._scratchBuffer,v.connect(a.ctx.destination),typeof v.start>"u"?v.noteOn(0):v.start(0),typeof a.ctx.resume=="function"&&a.ctx.resume(),v.onended=function(){v.disconnect(0),a._audioUnlocked=!0,document.removeEventListener("touchstart",u,!0),document.removeEventListener("touchend",u,!0),document.removeEventListener("click",u,!0),document.removeEventListener("keydown",u,!0);for(var _=0;_<a._howls.length;_++)a._howls[_]._emit("unlock")}};return document.addEventListener("touchstart",u,!0),document.addEventListener("touchend",u,!0),document.addEventListener("click",u,!0),document.addEventListener("keydown",u,!0),a}},_obtainHtml5Audio:function(){var a=this||t;if(a._html5AudioPool.length)return a._html5AudioPool.pop();var u=new Audio().play();return u&&typeof Promise<"u"&&(u instanceof Promise||typeof u.then=="function")&&u.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(a){var u=this||t;return a._unlocked&&u._html5AudioPool.push(a),u},_autoSuspend:function(){var a=this;if(!(!a.autoSuspend||!a.ctx||typeof a.ctx.suspend>"u"||!t.usingWebAudio)){for(var u=0;u<a._howls.length;u++)if(a._howls[u]._webAudio){for(var h=0;h<a._howls[u]._sounds.length;h++)if(!a._howls[u]._sounds[h]._paused)return a}return a._suspendTimer&&clearTimeout(a._suspendTimer),a._suspendTimer=setTimeout(function(){if(a.autoSuspend){a._suspendTimer=null,a.state="suspending";var p=function(){a.state="suspended",a._resumeAfterSuspend&&(delete a._resumeAfterSuspend,a._autoResume())};a.ctx.suspend().then(p,p)}},3e4),a}},_autoResume:function(){var a=this;if(!(!a.ctx||typeof a.ctx.resume>"u"||!t.usingWebAudio))return a.state==="running"&&a.ctx.state!=="interrupted"&&a._suspendTimer?(clearTimeout(a._suspendTimer),a._suspendTimer=null):a.state==="suspended"||a.state==="running"&&a.ctx.state==="interrupted"?(a.ctx.resume().then(function(){a.state="running";for(var u=0;u<a._howls.length;u++)a._howls[u]._emit("resume")}),a._suspendTimer&&(clearTimeout(a._suspendTimer),a._suspendTimer=null)):a.state==="suspending"&&(a._resumeAfterSuspend=!0),a}};var t=new e,n=function(a){var u=this;if(!a.src||a.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}u.init(a)};n.prototype={init:function(a){var u=this;return t.ctx||f(),u._autoplay=a.autoplay||!1,u._format=typeof a.format!="string"?a.format:[a.format],u._html5=a.html5||!1,u._muted=a.mute||!1,u._loop=a.loop||!1,u._pool=a.pool||5,u._preload=typeof a.preload=="boolean"||a.preload==="metadata"?a.preload:!0,u._rate=a.rate||1,u._sprite=a.sprite||{},u._src=typeof a.src!="string"?a.src:[a.src],u._volume=a.volume!==void 0?a.volume:1,u._xhr={method:a.xhr&&a.xhr.method?a.xhr.method:"GET",headers:a.xhr&&a.xhr.headers?a.xhr.headers:null,withCredentials:a.xhr&&a.xhr.withCredentials?a.xhr.withCredentials:!1},u._duration=0,u._state="unloaded",u._sounds=[],u._endTimers={},u._queue=[],u._playLock=!1,u._onend=a.onend?[{fn:a.onend}]:[],u._onfade=a.onfade?[{fn:a.onfade}]:[],u._onload=a.onload?[{fn:a.onload}]:[],u._onloaderror=a.onloaderror?[{fn:a.onloaderror}]:[],u._onplayerror=a.onplayerror?[{fn:a.onplayerror}]:[],u._onpause=a.onpause?[{fn:a.onpause}]:[],u._onplay=a.onplay?[{fn:a.onplay}]:[],u._onstop=a.onstop?[{fn:a.onstop}]:[],u._onmute=a.onmute?[{fn:a.onmute}]:[],u._onvolume=a.onvolume?[{fn:a.onvolume}]:[],u._onrate=a.onrate?[{fn:a.onrate}]:[],u._onseek=a.onseek?[{fn:a.onseek}]:[],u._onunlock=a.onunlock?[{fn:a.onunlock}]:[],u._onresume=[],u._webAudio=t.usingWebAudio&&!u._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(u),u._autoplay&&u._queue.push({event:"play",action:function(){u.play()}}),u._preload&&u._preload!=="none"&&u.load(),u},load:function(){var a=this,u=null;if(t.noAudio){a._emit("loaderror",null,"No audio support.");return}typeof a._src=="string"&&(a._src=[a._src]);for(var h=0;h<a._src.length;h++){var p,y;if(a._format&&a._format[h])p=a._format[h];else{if(y=a._src[h],typeof y!="string"){a._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}p=/^data:audio\/([^;,]+);/i.exec(y),p||(p=/\.([^.]+)$/.exec(y.split("?",1)[0])),p&&(p=p[1].toLowerCase())}if(p||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),p&&t.codecs(p)){u=a._src[h];break}}if(!u){a._emit("loaderror",null,"No codec support for selected audio sources.");return}return a._src=u,a._state="loading",window.location.protocol==="https:"&&u.slice(0,5)==="http:"&&(a._html5=!0,a._webAudio=!1),new s(a),a._webAudio&&o(a),a},play:function(a,u){var h=this,p=null;if(typeof a=="number")p=a,a=null;else{if(typeof a=="string"&&h._state==="loaded"&&!h._sprite[a])return null;if(typeof a>"u"&&(a="__default",!h._playLock)){for(var y=0,g=0;g<h._sounds.length;g++)h._sounds[g]._paused&&!h._sounds[g]._ended&&(y++,p=h._sounds[g]._id);y===1?a=null:p=null}}var m=p?h._soundById(p):h._inactiveSound();if(!m)return null;if(p&&!a&&(a=m._sprite||"__default"),h._state!=="loaded"){m._sprite=a,m._ended=!1;var w=m._id;return h._queue.push({event:"play",action:function(){h.play(w)}}),w}if(p&&!m._paused)return u||h._loadQueue("play"),m._id;h._webAudio&&t._autoResume();var v=Math.max(0,m._seek>0?m._seek:h._sprite[a][0]/1e3),_=Math.max(0,(h._sprite[a][0]+h._sprite[a][1])/1e3-v),k=_*1e3/Math.abs(m._rate),P=h._sprite[a][0]/1e3,D=(h._sprite[a][0]+h._sprite[a][1])/1e3;m._sprite=a,m._ended=!1;var I=function(){m._paused=!1,m._seek=v,m._start=P,m._stop=D,m._loop=!!(m._loop||h._sprite[a][2])};if(v>=D){h._ended(m);return}var x=m._node;if(h._webAudio){var B=function(){h._playLock=!1,I(),h._refreshBuffer(m);var E=m._muted||h._muted?0:m._volume;x.gain.setValueAtTime(E,t.ctx.currentTime),m._playStart=t.ctx.currentTime,typeof x.bufferSource.start>"u"?m._loop?x.bufferSource.noteGrainOn(0,v,86400):x.bufferSource.noteGrainOn(0,v,_):m._loop?x.bufferSource.start(0,v,86400):x.bufferSource.start(0,v,_),k!==1/0&&(h._endTimers[m._id]=setTimeout(h._ended.bind(h,m),k)),u||setTimeout(function(){h._emit("play",m._id),h._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?B():(h._playLock=!0,h.once("resume",B),h._clearTimer(m._id))}else{var Q=function(){x.currentTime=v,x.muted=m._muted||h._muted||t._muted||x.muted,x.volume=m._volume*t.volume(),x.playbackRate=m._rate;try{var E=x.play();if(E&&typeof Promise<"u"&&(E instanceof Promise||typeof E.then=="function")?(h._playLock=!0,I(),E.then(function(){h._playLock=!1,x._unlocked=!0,u?h._loadQueue():h._emit("play",m._id)}).catch(function(){h._playLock=!1,h._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),m._ended=!0,m._paused=!0})):u||(h._playLock=!1,I(),h._emit("play",m._id)),x.playbackRate=m._rate,x.paused){h._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}a!=="__default"||m._loop?h._endTimers[m._id]=setTimeout(h._ended.bind(h,m),k):(h._endTimers[m._id]=function(){h._ended(m),x.removeEventListener("ended",h._endTimers[m._id],!1)},x.addEventListener("ended",h._endTimers[m._id],!1))}catch(S){h._emit("playerror",m._id,S)}};x.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(x.src=h._src,x.load());var M=window&&window.ejecta||!x.readyState&&t._navigator.isCocoonJS;if(x.readyState>=3||M)Q();else{h._playLock=!0,h._state="loading";var A=function(){h._state="loaded",Q(),x.removeEventListener(t._canPlayEvent,A,!1)};x.addEventListener(t._canPlayEvent,A,!1),h._clearTimer(m._id)}}return m._id},pause:function(a){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"pause",action:function(){u.pause(a)}}),u;for(var h=u._getSoundIds(a),p=0;p<h.length;p++){u._clearTimer(h[p]);var y=u._soundById(h[p]);if(y&&!y._paused&&(y._seek=u.seek(h[p]),y._rateSeek=0,y._paused=!0,u._stopFade(h[p]),y._node))if(u._webAudio){if(!y._node.bufferSource)continue;typeof y._node.bufferSource.stop>"u"?y._node.bufferSource.noteOff(0):y._node.bufferSource.stop(0),u._cleanBuffer(y._node)}else(!isNaN(y._node.duration)||y._node.duration===1/0)&&y._node.pause();arguments[1]||u._emit("pause",y?y._id:null)}return u},stop:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"stop",action:function(){h.stop(a)}}),h;for(var p=h._getSoundIds(a),y=0;y<p.length;y++){h._clearTimer(p[y]);var g=h._soundById(p[y]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,h._stopFade(p[y]),g._node&&(h._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),h._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&h._clearSound(g._node))),u||h._emit("stop",g._id))}return h},mute:function(a,u){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"mute",action:function(){h.mute(a,u)}}),h;if(typeof u>"u")if(typeof a=="boolean")h._muted=a;else return h._muted;for(var p=h._getSoundIds(u),y=0;y<p.length;y++){var g=h._soundById(p[y]);g&&(g._muted=a,g._interval&&h._stopFade(g._id),h._webAudio&&g._node?g._node.gain.setValueAtTime(a?0:g._volume,t.ctx.currentTime):g._node&&(g._node.muted=t._muted?!0:a),h._emit("mute",g._id))}return h},volume:function(){var a=this,u=arguments,h,p;if(u.length===0)return a._volume;if(u.length===1||u.length===2&&typeof u[1]>"u"){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length>=2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var m;if(typeof h<"u"&&h>=0&&h<=1){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"volume",action:function(){a.volume.apply(a,u)}}),a;typeof p>"u"&&(a._volume=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)m=a._soundById(p[w]),m&&(m._volume=h,u[2]||a._stopFade(p[w]),a._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(h,t.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=h*t.volume()),a._emit("volume",m._id))}else return m=p?a._soundById(p):a._sounds[0],m?m._volume:0;return a},fade:function(a,u,h,p){var y=this;if(y._state!=="loaded"||y._playLock)return y._queue.push({event:"fade",action:function(){y.fade(a,u,h,p)}}),y;a=Math.min(Math.max(0,parseFloat(a)),1),u=Math.min(Math.max(0,parseFloat(u)),1),h=parseFloat(h),y.volume(a,p);for(var g=y._getSoundIds(p),m=0;m<g.length;m++){var w=y._soundById(g[m]);if(w){if(p||y._stopFade(g[m]),y._webAudio&&!w._muted){var v=t.ctx.currentTime,_=v+h/1e3;w._volume=a,w._node.gain.setValueAtTime(a,v),w._node.gain.linearRampToValueAtTime(u,_)}y._startFadeInterval(w,a,u,h,g[m],typeof p>"u")}}return y},_startFadeInterval:function(a,u,h,p,y,g){var m=this,w=u,v=h-u,_=Math.abs(v/.01),k=Math.max(4,_>0?p/_:p),P=Date.now();a._fadeTo=h,a._interval=setInterval(function(){var D=(Date.now()-P)/p;P=Date.now(),w+=v*D,w=Math.round(w*100)/100,v<0?w=Math.max(h,w):w=Math.min(h,w),m._webAudio?a._volume=w:m.volume(w,a._id,!0),g&&(m._volume=w),(h<u&&w<=h||h>u&&w>=h)&&(clearInterval(a._interval),a._interval=null,a._fadeTo=null,m.volume(h,a._id),m._emit("fade",a._id))},k)},_stopFade:function(a){var u=this,h=u._soundById(a);return h&&h._interval&&(u._webAudio&&h._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(h._interval),h._interval=null,u.volume(h._fadeTo,a),h._fadeTo=null,u._emit("fade",a)),u},loop:function(){var a=this,u=arguments,h,p,y;if(u.length===0)return a._loop;if(u.length===1)if(typeof u[0]=="boolean")h=u[0],a._loop=h;else return y=a._soundById(parseInt(u[0],10)),y?y._loop:!1;else u.length===2&&(h=u[0],p=parseInt(u[1],10));for(var g=a._getSoundIds(p),m=0;m<g.length;m++)y=a._soundById(g[m]),y&&(y._loop=h,a._webAudio&&y._node&&y._node.bufferSource&&(y._node.bufferSource.loop=h,h&&(y._node.bufferSource.loopStart=y._start||0,y._node.bufferSource.loopEnd=y._stop,a.playing(g[m])&&(a.pause(g[m],!0),a.play(g[m],!0)))));return a},rate:function(){var a=this,u=arguments,h,p;if(u.length===0)p=a._sounds[0]._id;else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):h=parseFloat(u[0])}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));var m;if(typeof h=="number"){if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"rate",action:function(){a.rate.apply(a,u)}}),a;typeof p>"u"&&(a._rate=h),p=a._getSoundIds(p);for(var w=0;w<p.length;w++)if(m=a._soundById(p[w]),m){a.playing(p[w])&&(m._rateSeek=a.seek(p[w]),m._playStart=a._webAudio?t.ctx.currentTime:m._playStart),m._rate=h,a._webAudio&&m._node&&m._node.bufferSource?m._node.bufferSource.playbackRate.setValueAtTime(h,t.ctx.currentTime):m._node&&(m._node.playbackRate=h);var v=a.seek(p[w]),_=(a._sprite[m._sprite][0]+a._sprite[m._sprite][1])/1e3-v,k=_*1e3/Math.abs(m._rate);(a._endTimers[p[w]]||!m._paused)&&(a._clearTimer(p[w]),a._endTimers[p[w]]=setTimeout(a._ended.bind(a,m),k)),a._emit("rate",m._id)}}else return m=a._soundById(p),m?m._rate:a._rate;return a},seek:function(){var a=this,u=arguments,h,p;if(u.length===0)a._sounds.length&&(p=a._sounds[0]._id);else if(u.length===1){var y=a._getSoundIds(),g=y.indexOf(u[0]);g>=0?p=parseInt(u[0],10):a._sounds.length&&(p=a._sounds[0]._id,h=parseFloat(u[0]))}else u.length===2&&(h=parseFloat(u[0]),p=parseInt(u[1],10));if(typeof p>"u")return 0;if(typeof h=="number"&&(a._state!=="loaded"||a._playLock))return a._queue.push({event:"seek",action:function(){a.seek.apply(a,u)}}),a;var m=a._soundById(p);if(m)if(typeof h=="number"&&h>=0){var w=a.playing(p);w&&a.pause(p,!0),m._seek=h,m._ended=!1,a._clearTimer(p),!a._webAudio&&m._node&&!isNaN(m._node.duration)&&(m._node.currentTime=h);var v=function(){w&&a.play(p,!0),a._emit("seek",p)};if(w&&!a._webAudio){var _=function(){a._playLock?setTimeout(_,0):v()};setTimeout(_,0)}else v()}else if(a._webAudio){var k=a.playing(p)?t.ctx.currentTime-m._playStart:0,P=m._rateSeek?m._rateSeek-m._seek:0;return m._seek+(P+k*Math.abs(m._rate))}else return m._node.currentTime;return a},playing:function(a){var u=this;if(typeof a=="number"){var h=u._soundById(a);return h?!h._paused:!1}for(var p=0;p<u._sounds.length;p++)if(!u._sounds[p]._paused)return!0;return!1},duration:function(a){var u=this,h=u._duration,p=u._soundById(a);return p&&(h=u._sprite[p._sprite][1]/1e3),h},state:function(){return this._state},unload:function(){for(var a=this,u=a._sounds,h=0;h<u.length;h++)u[h]._paused||a.stop(u[h]._id),a._webAudio||(a._clearSound(u[h]._node),u[h]._node.removeEventListener("error",u[h]._errorFn,!1),u[h]._node.removeEventListener(t._canPlayEvent,u[h]._loadFn,!1),u[h]._node.removeEventListener("ended",u[h]._endFn,!1),t._releaseHtml5Audio(u[h]._node)),delete u[h]._node,a._clearTimer(u[h]._id);var p=t._howls.indexOf(a);p>=0&&t._howls.splice(p,1);var y=!0;for(h=0;h<t._howls.length;h++)if(t._howls[h]._src===a._src||a._src.indexOf(t._howls[h]._src)>=0){y=!1;break}return i&&y&&delete i[a._src],t.noAudio=!1,a._state="unloaded",a._sounds=[],a=null,null},on:function(a,u,h,p){var y=this,g=y["_on"+a];return typeof u=="function"&&g.push(p?{id:h,fn:u,once:p}:{id:h,fn:u}),y},off:function(a,u,h){var p=this,y=p["_on"+a],g=0;if(typeof u=="number"&&(h=u,u=null),u||h)for(g=0;g<y.length;g++){var m=h===y[g].id;if(u===y[g].fn&&m||!u&&m){y.splice(g,1);break}}else if(a)p["_on"+a]=[];else{var w=Object.keys(p);for(g=0;g<w.length;g++)w[g].indexOf("_on")===0&&Array.isArray(p[w[g]])&&(p[w[g]]=[])}return p},once:function(a,u,h){var p=this;return p.on(a,u,h,1),p},_emit:function(a,u,h){for(var p=this,y=p["_on"+a],g=y.length-1;g>=0;g--)(!y[g].id||y[g].id===u||a==="load")&&(setTimeout(function(m){m.call(this,u,h)}.bind(p,y[g].fn),0),y[g].once&&p.off(a,y[g].fn,y[g].id));return p._loadQueue(a),p},_loadQueue:function(a){var u=this;if(u._queue.length>0){var h=u._queue[0];h.event===a&&(u._queue.shift(),u._loadQueue()),a||h.action()}return u},_ended:function(a){var u=this,h=a._sprite;if(!u._webAudio&&a._node&&!a._node.paused&&!a._node.ended&&a._node.currentTime<a._stop)return setTimeout(u._ended.bind(u,a),100),u;var p=!!(a._loop||u._sprite[h][2]);if(u._emit("end",a._id),!u._webAudio&&p&&u.stop(a._id,!0).play(a._id),u._webAudio&&p){u._emit("play",a._id),a._seek=a._start||0,a._rateSeek=0,a._playStart=t.ctx.currentTime;var y=(a._stop-a._start)*1e3/Math.abs(a._rate);u._endTimers[a._id]=setTimeout(u._ended.bind(u,a),y)}return u._webAudio&&!p&&(a._paused=!0,a._ended=!0,a._seek=a._start||0,a._rateSeek=0,u._clearTimer(a._id),u._cleanBuffer(a._node),t._autoSuspend()),!u._webAudio&&!p&&u.stop(a._id,!0),u},_clearTimer:function(a){var u=this;if(u._endTimers[a]){if(typeof u._endTimers[a]!="function")clearTimeout(u._endTimers[a]);else{var h=u._soundById(a);h&&h._node&&h._node.removeEventListener("ended",u._endTimers[a],!1)}delete u._endTimers[a]}return u},_soundById:function(a){for(var u=this,h=0;h<u._sounds.length;h++)if(a===u._sounds[h]._id)return u._sounds[h];return null},_inactiveSound:function(){var a=this;a._drain();for(var u=0;u<a._sounds.length;u++)if(a._sounds[u]._ended)return a._sounds[u].reset();return new s(a)},_drain:function(){var a=this,u=a._pool,h=0,p=0;if(!(a._sounds.length<u)){for(p=0;p<a._sounds.length;p++)a._sounds[p]._ended&&h++;for(p=a._sounds.length-1;p>=0;p--){if(h<=u)return;a._sounds[p]._ended&&(a._webAudio&&a._sounds[p]._node&&a._sounds[p]._node.disconnect(0),a._sounds.splice(p,1),h--)}}},_getSoundIds:function(a){var u=this;if(typeof a>"u"){for(var h=[],p=0;p<u._sounds.length;p++)h.push(u._sounds[p]._id);return h}else return[a]},_refreshBuffer:function(a){var u=this;return a._node.bufferSource=t.ctx.createBufferSource(),a._node.bufferSource.buffer=i[u._src],a._panner?a._node.bufferSource.connect(a._panner):a._node.bufferSource.connect(a._node),a._node.bufferSource.loop=a._loop,a._loop&&(a._node.bufferSource.loopStart=a._start||0,a._node.bufferSource.loopEnd=a._stop||0),a._node.bufferSource.playbackRate.setValueAtTime(a._rate,t.ctx.currentTime),u},_cleanBuffer:function(a){var u=this,h=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!a.bufferSource)return u;if(t._scratchBuffer&&a.bufferSource&&(a.bufferSource.onended=null,a.bufferSource.disconnect(0),h))try{a.bufferSource.buffer=t._scratchBuffer}catch{}return a.bufferSource=null,u},_clearSound:function(a){var u=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);u||(a.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(a){this._parent=a,this.init()};s.prototype={init:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++t._counter,u._sounds.push(a),a.create(),a},create:function(){var a=this,u=a._parent,h=t._muted||a._muted||a._parent._muted?0:a._volume;return u._webAudio?(a._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),a._node.gain.setValueAtTime(h,t.ctx.currentTime),a._node.paused=!0,a._node.connect(t.masterGain)):t.noAudio||(a._node=t._obtainHtml5Audio(),a._errorFn=a._errorListener.bind(a),a._node.addEventListener("error",a._errorFn,!1),a._loadFn=a._loadListener.bind(a),a._node.addEventListener(t._canPlayEvent,a._loadFn,!1),a._endFn=a._endListener.bind(a),a._node.addEventListener("ended",a._endFn,!1),a._node.src=u._src,a._node.preload=u._preload===!0?"auto":u._preload,a._node.volume=h*t.volume(),a._node.load()),a},reset:function(){var a=this,u=a._parent;return a._muted=u._muted,a._loop=u._loop,a._volume=u._volume,a._rate=u._rate,a._seek=0,a._rateSeek=0,a._paused=!0,a._ended=!0,a._sprite="__default",a._id=++t._counter,a},_errorListener:function(){var a=this;a._parent._emit("loaderror",a._id,a._node.error?a._node.error.code:0),a._node.removeEventListener("error",a._errorFn,!1)},_loadListener:function(){var a=this,u=a._parent;u._duration=Math.ceil(a._node.duration*10)/10,Object.keys(u._sprite).length===0&&(u._sprite={__default:[0,u._duration*1e3]}),u._state!=="loaded"&&(u._state="loaded",u._emit("load"),u._loadQueue()),a._node.removeEventListener(t._canPlayEvent,a._loadFn,!1)},_endListener:function(){var a=this,u=a._parent;u._duration===1/0&&(u._duration=Math.ceil(a._node.duration*10)/10,u._sprite.__default[1]===1/0&&(u._sprite.__default[1]=u._duration*1e3),u._ended(a)),a._node.removeEventListener("ended",a._endFn,!1)}};var i={},o=function(a){var u=a._src;if(i[u]){a._duration=i[u].duration,d(a);return}if(/^data:[^;]+;base64,/.test(u)){for(var h=atob(u.split(",")[1]),p=new Uint8Array(h.length),y=0;y<h.length;++y)p[y]=h.charCodeAt(y);c(p.buffer,a)}else{var g=new XMLHttpRequest;g.open(a._xhr.method,u,!0),g.withCredentials=a._xhr.withCredentials,g.responseType="arraybuffer",a._xhr.headers&&Object.keys(a._xhr.headers).forEach(function(m){g.setRequestHeader(m,a._xhr.headers[m])}),g.onload=function(){var m=(g.status+"")[0];if(m!=="0"&&m!=="2"&&m!=="3"){a._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}c(g.response,a)},g.onerror=function(){a._webAudio&&(a._html5=!0,a._webAudio=!1,a._sounds=[],delete i[u],a.load())},l(g)}},l=function(a){try{a.send()}catch{a.onerror()}},c=function(a,u){var h=function(){u._emit("loaderror",null,"Decoding audio data failed.")},p=function(y){y&&u._sounds.length>0?(i[u._src]=y,d(u,y)):h()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(a).then(p).catch(h):t.ctx.decodeAudioData(a,p,h)},d=function(a,u){u&&!a._duration&&(a._duration=u.duration),Object.keys(a._sprite).length===0&&(a._sprite={__default:[0,a._duration*1e3]}),a._state!=="loaded"&&(a._state="loaded",a._emit("load"),a._loadQueue())},f=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch{t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var a=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),u=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),h=u?parseInt(u[1],10):null;if(a&&h&&h<9){var p=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!p&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};r.Howler=t,r.Howl=n,typeof Ti<"u"?(Ti.HowlerGlobal=e,Ti.Howler=t,Ti.Howl=n,Ti.Sound=s):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=n,window.Sound=s)})();(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var n=this;if(!n.ctx||!n.ctx.listener)return n;for(var s=n._howls.length-1;s>=0;s--)n._howls[s].stereo(t);return n},HowlerGlobal.prototype.pos=function(t,n,s){var i=this;if(!i.ctx||!i.ctx.listener)return i;if(n=typeof n!="number"?i._pos[1]:n,s=typeof s!="number"?i._pos[2]:s,typeof t=="number")i._pos=[t,n,s],typeof i.ctx.listener.positionX<"u"?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]);else return i._pos;return i},HowlerGlobal.prototype.orientation=function(t,n,s,i,o,l){var c=this;if(!c.ctx||!c.ctx.listener)return c;var d=c._orientation;if(n=typeof n!="number"?d[1]:n,s=typeof s!="number"?d[2]:s,i=typeof i!="number"?d[3]:i,o=typeof o!="number"?d[4]:o,l=typeof l!="number"?d[5]:l,typeof t=="number")c._orientation=[t,n,s,i,o,l],typeof c.ctx.listener.forwardX<"u"?(c.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),c.ctx.listener.forwardY.setTargetAtTime(n,Howler.ctx.currentTime,.1),c.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),c.ctx.listener.upX.setTargetAtTime(i,Howler.ctx.currentTime,.1),c.ctx.listener.upY.setTargetAtTime(o,Howler.ctx.currentTime,.1),c.ctx.listener.upZ.setTargetAtTime(l,Howler.ctx.currentTime,.1)):c.ctx.listener.setOrientation(t,n,s,i,o,l);else return d;return c},Howl.prototype.init=(function(t){return function(n){var s=this;return s._orientation=n.orientation||[1,0,0],s._stereo=n.stereo||null,s._pos=n.pos||null,s._pannerAttr={coneInnerAngle:typeof n.coneInnerAngle<"u"?n.coneInnerAngle:360,coneOuterAngle:typeof n.coneOuterAngle<"u"?n.coneOuterAngle:360,coneOuterGain:typeof n.coneOuterGain<"u"?n.coneOuterGain:0,distanceModel:typeof n.distanceModel<"u"?n.distanceModel:"inverse",maxDistance:typeof n.maxDistance<"u"?n.maxDistance:1e4,panningModel:typeof n.panningModel<"u"?n.panningModel:"HRTF",refDistance:typeof n.refDistance<"u"?n.refDistance:1,rolloffFactor:typeof n.rolloffFactor<"u"?n.rolloffFactor:1},s._onstereo=n.onstereo?[{fn:n.onstereo}]:[],s._onpos=n.onpos?[{fn:n.onpos}]:[],s._onorientation=n.onorientation?[{fn:n.onorientation}]:[],t.call(this,n)}})(Howl.prototype.init),Howl.prototype.stereo=function(t,n){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(t,n)}}),s;var i=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof n>"u")if(typeof t=="number")s._stereo=t,s._pos=[t,0,0];else return s._stereo;for(var o=s._getSoundIds(n),l=0;l<o.length;l++){var c=s._soundById(o[l]);if(c)if(typeof t=="number")c._stereo=t,c._pos=[t,0,0],c._node&&(c._pannerAttr.panningModel="equalpower",(!c._panner||!c._panner.pan)&&e(c,i),i==="spatial"?typeof c._panner.positionX<"u"?(c._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),c._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),c._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):c._panner.setPosition(t,0,0):c._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",c._id);else return c._stereo}return s},Howl.prototype.pos=function(t,n,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"pos",action:function(){o.pos(t,n,s,i)}}),o;if(n=typeof n!="number"?0:n,s=typeof s!="number"?-.5:s,typeof i>"u")if(typeof t=="number")o._pos=[t,n,s];else return o._pos;for(var l=o._getSoundIds(i),c=0;c<l.length;c++){var d=o._soundById(l[c]);if(d)if(typeof t=="number")d._pos=[t,n,s],d._node&&((!d._panner||d._panner.pan)&&e(d,"spatial"),typeof d._panner.positionX<"u"?(d._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),d._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setPosition(t,n,s)),o._emit("pos",d._id);else return d._pos}return o},Howl.prototype.orientation=function(t,n,s,i){var o=this;if(!o._webAudio)return o;if(o._state!=="loaded")return o._queue.push({event:"orientation",action:function(){o.orientation(t,n,s,i)}}),o;if(n=typeof n!="number"?o._orientation[1]:n,s=typeof s!="number"?o._orientation[2]:s,typeof i>"u")if(typeof t=="number")o._orientation=[t,n,s];else return o._orientation;for(var l=o._getSoundIds(i),c=0;c<l.length;c++){var d=o._soundById(l[c]);if(d)if(typeof t=="number")d._orientation=[t,n,s],d._node&&(d._panner||(d._pos||(d._pos=o._pos||[0,0,-.5]),e(d,"spatial")),typeof d._panner.orientationX<"u"?(d._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),d._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),d._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):d._panner.setOrientation(t,n,s)),o._emit("orientation",d._id);else return d._orientation}return o},Howl.prototype.pannerAttr=function(){var t=this,n=arguments,s,i,o;if(!t._webAudio)return t;if(n.length===0)return t._pannerAttr;if(n.length===1)if(typeof n[0]=="object")s=n[0],typeof i>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),t._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:t._panningModel});else return o=t._soundById(parseInt(n[0],10)),o?o._pannerAttr:t._pannerAttr;else n.length===2&&(s=n[0],i=parseInt(n[1],10));for(var l=t._getSoundIds(i),c=0;c<l.length;c++)if(o=t._soundById(l[c]),o){var d=o._pannerAttr;d={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:d.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:d.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:d.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:d.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:d.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:d.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:d.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:d.panningModel};var f=o._panner;f||(o._pos||(o._pos=t._pos||[0,0,-.5]),e(o,"spatial"),f=o._panner),f.coneInnerAngle=d.coneInnerAngle,f.coneOuterAngle=d.coneOuterAngle,f.coneOuterGain=d.coneOuterGain,f.distanceModel=d.distanceModel,f.maxDistance=d.maxDistance,f.refDistance=d.refDistance,f.rolloffFactor=d.rolloffFactor,f.panningModel=d.panningModel}return t},Sound.prototype.init=(function(t){return function(){var n=this,s=n._parent;n._orientation=s._orientation,n._stereo=s._stereo,n._pos=s._pos,n._pannerAttr=s._pannerAttr,t.call(this),n._stereo?s.stereo(n._stereo):n._pos&&s.pos(n._pos[0],n._pos[1],n._pos[2],n._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(t){return function(){var n=this,s=n._parent;return n._orientation=s._orientation,n._stereo=s._stereo,n._pos=s._pos,n._pannerAttr=s._pannerAttr,n._stereo?s.stereo(n._stereo):n._pos?s.pos(n._pos[0],n._pos[1],n._pos[2],n._id):n._panner&&(n._panner.disconnect(0),n._panner=void 0,s._refreshBuffer(n)),t.call(this)}})(Sound.prototype.reset);var e=function(t,n){n=n||"spatial",n==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(nc)),nc}var Ut=cE();const{random:ru,round:uE}=Math,pm=.6,et={bleep:new Ut.Howl({src:"/sounds/bleep.wav"}),blink:new Ut.Howl({src:"/sounds/blink.wav",rate:pm}),gameOver:new Ut.Howl({src:"/sounds/game-over.wav"}),generate:new Ut.Howl({src:"/sounds/generate.wav"}),hit:new Ut.Howl({src:"/sounds/hit.wav"}),kicks:[new Ut.Howl({src:"/sounds/kick-1.wav"}),new Ut.Howl({src:"/sounds/kick-2.wav"})],lowEnergy:new Ut.Howl({src:"/sounds/low-energy.wav"}),plus:new Ut.Howl({src:"/sounds/plus.wav"}),slideIn:new Ut.Howl({src:"/sounds/slide-in.wav"}),slideMove:new Ut.Howl({src:"/sounds/slide-move.wav"}),slideOut:new Ut.Howl({src:"/sounds/slide-out.wav"}),turnOn:new Ut.Howl({src:"/sounds/turn-on.wav"}),wordUp:new Ut.Howl({src:"/sounds/word-up.wav"})};function dE(){et.bleep.play()}function fE(){const r=(e=.02)=>{et.blink.rate(et.blink.rate()+e),et.blink.play()};r(),setTimeout(r,200),setTimeout(()=>r(.04),400)}function gm(){et.lowEnergy.play()}function mm(){et.plus.play()}function hE(){et.gameOver.play()}function pE(){et.generate.play()}function ym(r=0){et.hit.rate(1-(r||10)/36),et.hit.play()}function gE(){const r=et.kicks[uE(ru())];r.rate(1-(ru()-.5)/2),r.play()}function mE(){et.newRecord.play()}function nu(){et.slideIn.play()}function su(r=0){et.slideMove.rate(1+r/27),et.slideMove.play()}function bm(){et.slideOut.play()}function yE(){et.turnOn.rate(1-(ru()-.5)/10),et.turnOn.play()}function vm(){et.wordUp.play()}function bE(){et.blink.rate(pm)}const vE=Object.freeze(Object.defineProperty({__proto__:null,playBleep:dE,playBlink:fE,playGameOver:hE,playGenerate:pE,playHit:ym,playKick:gE,playLowEnergy:gm,playNewRecord:mE,playPlus:mm,playSlideIn:nu,playSlideMove:su,playSlideOut:bm,playTurnOn:yE,playWordUp:vm,reset:bE},Symbol.toStringTag,{value:"Module"})),qr="/",wm=new TextEncoder().encode(qr),Xo=wm[0];class je{_buf;constructor(e,t){if(typeof e=="string")this._buf=j(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Xo)throw new Error("Invalid key")}toString(e="utf8"){return W(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new je(e.join(qr))}static random(){return new je(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new je(e):typeof e.uint8Array=="function"?new je(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=wm),this._buf[0]!==Xo){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Xo,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Xo;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return je.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(qr).slice(1)}type(){return wE(this.baseNamespace())}name(){return _E(this.baseNamespace())}instance(e){return new je(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(qr)||(e+=qr),e+=this.type(),new je(e)}parent(){const e=this.list();return e.length===1?new je(qr):new je(e.slice(0,-1).join(qr))}child(e){return this.toString()===qr?e:e.toString()===qr?this:new je(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return je.withNamespaces([...this.namespaces(),...SE(e.map(t=>t.namespaces()))])}}function wE(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function _E(r){const e=r.split(":");return e[e.length-1]}function SE(r){return[].concat(...r)}const EE="SHARDING";function xE(r){return r[Symbol.asyncIterator]!=null}function th(r){if(xE(r))return(async()=>{for await(const e of r);})();for(const e of r);}function AE(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function IE(r){return r[Symbol.asyncIterator]!=null}function xn(r,e){let t=0;if(IE(r))return(async function*(){for await(const c of r)await e(c,t++)&&(yield c)})();const n=AE(r),{value:s,done:i}=n.next();if(i===!0)return(function*(){})();const o=e(s,t++);if(typeof o.then=="function")return(async function*(){await o&&(yield s);for(const c of n)await e(c,t++)&&(yield c)})();const l=e;return(function*(){o===!0&&(yield s);for(const c of n)l(c,t++)&&(yield c)})()}function kE(r){return r[Symbol.asyncIterator]!=null}function iu(r){if(kE(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}function CE(r){return r[Symbol.asyncIterator]!=null}function Ra(r,e){return CE(r)?(async function*(){yield*(await iu(r)).sort(e)})():(function*(){yield*iu(r).sort(e)})()}function TE(r){return r[Symbol.asyncIterator]!=null}function rh(r,e){return TE(r)?(async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}})():(function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}})()}class _m{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await th(this.putMany(e,n)),e=[],await th(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const s=e.prefix;n=xn(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),e.offset!=null){let s=0;const i=e.offset;n=xn(n,()=>s++>=i)}return e.limit!=null&&(n=rh(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;n=xn(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),e.offset!=null){const s=e.offset;let i=0;n=xn(n,()=>i++>=s)}return e.limit!=null&&(n=rh(n,e.limit)),n}}class Ba extends Error{static name="OpenFailedError";static code="ERR_OPEN_FAILED";name=Ba.name;code=Ba.code;constructor(e="Open failed"){super(e)}}class Na extends Error{static name="PutFailedError";static code="ERR_PUT_FAILED";name=Na.name;code=Na.code;constructor(e="Put failed"){super(e)}}class oo extends Error{static name="GetFailedError";static code="ERR_GET_FAILED";name=oo.name;code=oo.code;constructor(e="Get failed"){super(e)}}class Ma extends Error{static name="DeleteFailedError";static code="ERR_DELETE_FAILED";name=Ma.name;code=Ma.code;constructor(e="Delete failed"){super(e)}}let Sm=class ou extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=ou.name;code=ou.code;constructor(e="Not Found"){super(e)}};class PE extends _m{data;constructor(){super(),this.data=new Map}put(e,t,n){return n?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const n=this.data.get(e.toString());if(n==null)throw new Sm;return n}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[n,s]of this.data.entries())yield{key:new je(n),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const n of this.data.keys())yield new je(n),t?.signal?.throwIfAborted()}}function lr(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class nh{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class sc{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new nh(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new nh(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let DE=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ld(r={}){return LE(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function LE(r,e){e=e??{};let t=e.onEnd,n=new sc,s,i,o,l=lr();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((g,m)=>{i=w=>{i=null,n.push(w);try{g(r(n))}catch(v){m(v)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{l.resolve(),l=lr()})}},d=g=>i!=null?i(g):(n.push(g),s),f=g=>(n=new sc,i!=null?i({error:g}):(n.push({error:g}),s)),a=g=>{if(o)return s;if(e?.objectMode!==!0&&g?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return d({done:!1,value:g})},u=g=>o?s:(o=!0,g!=null?f(g):d({done:!0})),h=()=>(n=new sc,u(),{done:!0}),p=g=>(u(g),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:h,throw:p,push:a,end:u,get readableLength(){return n.size},onEmpty:async g=>{const m=g?.signal;if(m?.throwIfAborted(),n.isEmpty())return;let w,v;m!=null&&(w=new Promise((_,k)=>{v=()=>{k(new DE)},m.addEventListener("abort",v)}));try{await Promise.race([l.promise,w])}finally{v!=null&&m!=null&&m?.removeEventListener("abort",v)}}},t==null)return s;const y=s;return s={[Symbol.asyncIterator](){return this},next(){return y.next()},throw(g){return y.throw(g),t!=null&&(t(g),t=void 0),{done:!0}},return(){return y.return(),t!=null&&(t(),t=void 0),{done:!0}},push:a,end(g){return y.end(g),t!=null&&(t(g),t=void 0),s},get readableLength(){return y.readableLength},onEmpty:g=>y.onEmpty(g)},s}function RE(r){return r.reason}async function Tt(r,e,t){if(e==null)return r;const n=t?.translateError??RE;if(e.aborted)return r.catch(()=>{}),Promise.reject(n(e));let s;try{return await Promise.race([r,new Promise((i,o)=>{s=()=>{o(n(e))},e.addEventListener("abort",s)})])}finally{s!=null&&e.removeEventListener("abort",s)}}class BE{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=lr(),this.haveNext=lr()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=lr(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=lr(),await Tt(this.readNext.promise,t?.signal,t)}}function NE(){return new BE}function ME(r){return r[Symbol.asyncIterator]!=null}async function OE(r,e,t){try{await Promise.all(r.map(async n=>{for await(const s of n)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(n){await e.end(n,{signal:t}).catch(()=>{})}}async function*$E(r){const e=new AbortController,t=NE();OE(r,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*FE(r){for(const e of r)yield*e}function au(...r){const e=[];for(const t of r)ME(t)||e.push(t);return e.length===r.length?FE(e):$E(r)}new je(EE);const ni=1e3,si=ni*60,ii=si*60,ys=ii*24,ao=ys*7,oi=ys*365.25,lo=oi/12;function UE(r,e){if(typeof r=="string")return VE(r);if(typeof r=="number")return HE(r,e);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(r)}`)}var Em=UE;function VE(r){if(typeof r!="string"||r.length===0||r.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(r)}`);let e=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(r);if(!e?.groups)return NaN;let{value:t,unit:n="ms"}=e.groups,s=parseFloat(t),i=n.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return s*oi;case"months":case"month":case"mo":return s*lo;case"weeks":case"week":case"w":return s*ao;case"days":case"day":case"d":return s*ys;case"hours":case"hour":case"hrs":case"hr":case"h":return s*ii;case"minutes":case"minute":case"mins":case"min":case"m":return s*si;case"seconds":case"second":case"secs":case"sec":case"s":return s*ni;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(r)}`)}}function KE(r){let e=Math.abs(r);return e>=oi?`${Math.round(r/oi)}y`:e>=lo?`${Math.round(r/lo)}mo`:e>=ao?`${Math.round(r/ao)}w`:e>=ys?`${Math.round(r/ys)}d`:e>=ii?`${Math.round(r/ii)}h`:e>=si?`${Math.round(r/si)}m`:e>=ni?`${Math.round(r/ni)}s`:`${r}ms`}function qE(r){let e=Math.abs(r);return e>=oi?Yn(r,e,oi,"year"):e>=lo?Yn(r,e,lo,"month"):e>=ao?Yn(r,e,ao,"week"):e>=ys?Yn(r,e,ys,"day"):e>=ii?Yn(r,e,ii,"hour"):e>=si?Yn(r,e,si,"minute"):e>=ni?Yn(r,e,ni,"second"):`${r} ms`}function HE(r,e){if(typeof r!="number"||!Number.isFinite(r))throw Error("Value provided to ms.format() must be of type number.");return e?.long?qE(r):KE(r)}function Yn(r,e,t,n){let s=e>=t*1.5;return`${Math.round(r/t)} ${n}${s?"s":""}`}function zE(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=Em,t.destroy=d,Object.keys(r).forEach(f=>{t[f]=r[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let a=0;for(let u=0;u<f.length;u++)a=(a<<5)-a+f.charCodeAt(u),a|=0;return t.colors[Math.abs(a)%t.colors.length]}t.selectColor=e;function t(f,a){let u,h=null,p,y;function g(...m){if(!g.enabled)return;const w=g,v=Number(new Date),_=v-(u||v);w.diff=_,w.prev=u,w.curr=v,u=v,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let k=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(D,I)=>{if(D==="%%")return"%";k++;const x=t.formatters[I];if(typeof x=="function"){const B=m[k];D=x.call(w,B),m.splice(k,1),k--}return D}),t.formatArgs.call(w,m),a?.onLog!=null&&a.onLog(...m),(w.log||t.log).apply(w,m)}return g.namespace=f,g.useColors=t.useColors(),g.color=t.selectColor(f),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(p!==t.namespaces&&(p=t.namespaces,y=t.enabled(f)),y),set:m=>{h=m}}),typeof t.init=="function"&&t.init(g),g}function n(f,a){const u=t(this.namespace+(typeof a>"u"?":":a)+f);return u.log=this.log,u}function s(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];let a;const u=(typeof f=="string"?f:"").split(/[\s,]+/),h=u.length;for(a=0;a<h;a++)u[a]&&(f=u[a].replace(/\*/g,".*?"),f[0]==="-"?t.skips.push(new RegExp("^"+f.substr(1)+"$")):t.names.push(new RegExp("^"+f+"$")))}function i(){const f=[...t.names.map(l),...t.skips.map(l).map(a=>"-"+a)].join(",");return t.enable(""),f}function o(f){if(f[f.length-1]==="*")return!0;let a,u;for(a=0,u=t.skips.length;a<u;a++)if(t.skips[a].test(f))return!1;for(a=0,u=t.names.length;a<u;a++)if(t.names[a].test(f))return!0;return!1}function l(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function c(f){return f instanceof Error?f.stack??f.message:f}function d(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var WE={};const Oa=JE(),GE=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function YE(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function XE(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Em(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}const ZE=console.debug??console.log??(()=>{});function jE(r){try{r?Oa?.setItem("debug",r):Oa?.removeItem("debug")}catch{}}function QE(){let r;try{r=Oa?.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=WE.DEBUG),r}function JE(){try{return localStorage}catch{}}function ex(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Jt=zE({formatArgs:XE,save:jE,load:QE,useColors:YE,setupFormatters:ex,colors:GE,storage:Oa,log:ZE});Jt.formatters.b=r=>r==null?"undefined":Pe.baseEncode(r);Jt.formatters.t=r=>r==null?"undefined":Rn.baseEncode(r);Jt.formatters.m=r=>r==null?"undefined":Do.baseEncode(r);Jt.formatters.p=r=>r==null?"undefined":r.toString();Jt.formatters.c=r=>r==null?"undefined":r.toString();Jt.formatters.k=r=>r==null?"undefined":r.toString();Jt.formatters.a=r=>r==null?"undefined":r.toString();function sh(r,e=""){const t=ih(r.message),n=ih(r.stack);return t!=null&&n!=null?n.includes(t)?`${n.split(`
`).join(`
${e}`)}`:`${t}
${e}${n.split(`
`).join(`
${e}`)}`:n!=null?`${n.split(`
`).join(`
${e}`)}`:t!=null?`${t}`:`${r.toString()}`}function tx(r){return r instanceof AggregateError||r?.name==="AggregateError"&&Array.isArray(r.errors)}function xm(r,e=""){if(tx(r)){let t=sh(r,e);return r.errors.length>0?(e=`${e}    `,t+=`
${e}${r.errors.map(n=>`${xm(n,`${e}`)}`).join(`
${e}`)}`):t+=`
${e}[Error list was empty]`,t.trim()}return sh(r,e)}Jt.formatters.e=r=>r==null?"undefined":xm(r);function rx(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function cd(r){return{forComponent(e){return ud(e,r)}}}function ud(r,e){let t=rx(`${r}:trace`);return Jt.enabled(`${r}:trace`)&&Jt.names.map(n=>n.toString()).find(n=>n.includes(":trace"))!=null&&(t=Jt(`${r}:trace`,e)),Object.assign(Jt(r,e),{error:Jt(`${r}:error`,e),trace:t,newScope:n=>ud(`${r}:${n}`,e)})}function ih(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}ud("datastore:core:tiered");const lu=(r,e)=>e.some(t=>r instanceof t);let oh,ah;function nx(){return oh||(oh=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function sx(){return ah||(ah=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const cu=new WeakMap,ic=new WeakMap,Ll=new WeakMap;function ix(r){const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("success",i),r.removeEventListener("error",o)},i=()=>{t(Nn(r.result)),s()},o=()=>{n(r.error),s()};r.addEventListener("success",i),r.addEventListener("error",o)});return Ll.set(e,r),e}function ox(r){if(cu.has(r))return;const e=new Promise((t,n)=>{const s=()=>{r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)});cu.set(r,e)}let uu={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return cu.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return Nn(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function Am(r){uu=r(uu)}function ax(r){return sx().includes(r)?function(...e){return r.apply(du(this),e),Nn(this.request)}:function(...e){return Nn(r.apply(du(this),e))}}function lx(r){return typeof r=="function"?ax(r):(r instanceof IDBTransaction&&ox(r),lu(r,nx())?new Proxy(r,uu):r)}function Nn(r){if(r instanceof IDBRequest)return ix(r);if(ic.has(r))return ic.get(r);const e=lx(r);return e!==r&&(ic.set(r,e),Ll.set(e,r)),e}const du=r=>Ll.get(r);function cx(r,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){const o=indexedDB.open(r,e),l=Nn(o);return n&&o.addEventListener("upgradeneeded",c=>{n(Nn(o.result),c.oldVersion,c.newVersion,Nn(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),l.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}function ux(r,{blocked:e}={}){const t=indexedDB.deleteDatabase(r);return e&&t.addEventListener("blocked",n=>e(n.oldVersion,n)),Nn(t).then(()=>{})}const dx=["get","getKey","getAll","getAllKeys","count"],fx=["put","add","delete","clear"],oc=new Map;function lh(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(oc.get(e))return oc.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,s=fx.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||dx.includes(t)))return;const i=async function(o,...l){const c=this.transaction(o,s?"readwrite":"readonly");let d=c.store;return n&&(d=d.index(l.shift())),(await Promise.all([d[t](...l),s&&c.done]))[0]};return oc.set(e,i),i}Am(r=>({...r,get:(e,t,n)=>lh(e,t)||r.get(e,t,n),has:(e,t)=>!!lh(e,t)||r.has(e,t)}));const hx=["continue","continuePrimaryKey","advance"],ch={},fu=new WeakMap,Im=new WeakMap,px={get(r,e){if(!hx.includes(e))return r[e];let t=ch[e];return t||(t=ch[e]=function(...n){fu.set(this,Im.get(this)[e](...n))}),t}};async function*gx(...r){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...r)),!e)return;e=e;const t=new Proxy(e,px);for(Im.set(t,e),Ll.set(t,du(e));e;)yield t,e=await(fu.get(t)||e.continue()),fu.delete(t)}function uh(r,e){return e===Symbol.asyncIterator&&lu(r,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&lu(r,[IDBIndex,IDBObjectStore])}Am(r=>({...r,get(e,t,n){return uh(e,t)?gx:r.get(e,t,n)},has(e,t){return uh(e,t)||r.has(e,t)}}));class km extends _m{location;version;db;constructor(e,t={}){super(),this.location=`${t.prefix??""}${e}`,this.version=t.version??1}async open(){try{const e=this.location;this.db=await cx(e,this.version,{upgrade(t){t.createObjectStore(e)}})}catch(e){throw new Ba(String(e))}}async close(){this.db?.close()}async put(e,t,n){if(this.db==null)throw new Error("Datastore needs to be opened.");try{n?.signal?.throwIfAborted(),await Tt(this.db.put(this.location,t,e.toString()),n?.signal)}catch(s){throw new Na(String(s))}return e}async get(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");let n;try{t?.signal?.throwIfAborted(),n=await Tt(this.db.get(this.location,e.toString()),t?.signal)}catch(s){throw new oo(String(s))}if(n===void 0)throw new Sm;return n}async has(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return t?.signal?.throwIfAborted(),!!await Tt(this.db.getKey(this.location,e.toString()))}catch(n){throw new oo(String(n))}}async delete(e,t){if(this.db==null)throw new Error("Datastore needs to be opened.");try{t?.signal?.throwIfAborted(),await Tt(this.db.delete(this.location,e.toString()),t?.signal)}catch(n){throw new Ma(String(n))}}batch(){const e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{if(this.db==null)throw new Error("Datastore needs to be opened.");n?.signal?.throwIfAborted();const s=this.db.transaction(this.location,"readwrite");try{const i=e.filter(({key:o})=>t.find(l=>l.toString()===o.toString())==null).map(o=>async()=>{await s.store.put(o.value,o.key.toString())}).concat(t.map(o=>async()=>{await s.store.delete(o.toString())})).concat(async()=>{await s.done});n?.signal?.throwIfAborted(),await Tt(Promise.all(i.map(async o=>{await o()})),n?.signal)}catch{s.abort()}}}}async*query(e,t){let n=this.#e(e,(s,i)=>({key:s,value:i}),t);Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),yield*n}async*queryKeys(e,t){let n=this.#e(e,s=>s,t);Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>xn(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Ra(s,i),n)),yield*n}async*#e(e,t,n){if(this.db==null)throw new Error("Datastore needs to be opened.");let s=0,i=-1;n?.signal?.throwIfAborted();for(const o of await this.db.getAllKeys(this.location)){if(n?.signal?.throwIfAborted(),e.prefix!=null&&!o.toString().startsWith(e.prefix))continue;if(e.limit!=null&&s===e.limit)return;if(i++,e.offset!=null&&i<e.offset)continue;const l=new je(o.toString());let c;try{c=await this.get(l,n)}catch(d){if(d.name!=="NotFoundError")throw d;continue}c!=null&&(yield t(l,c),n?.signal?.throwIfAborted(),s++)}}async destroy(){await ux(this.location)}}function Ro(r,e,t=s=>{const i=localStorage.getItem(r);return i?JSON.parse(i):s},n=s=>{localStorage.setItem(r,JSON.stringify(s))}){const s=ir(t(e)||e);return{get(){return Si(s)},set(i){n(i),s.set(i)},update(i){this.set(i(this.get()))},subscribe:s.subscribe}}async function mx(r){const e=new km(r);return await e.open().catch(()=>{}),async function(n,s,i=async l=>{const c=await e.get(n).catch(()=>l);return c===void 0&&l!==void 0?(await e.put(n,l),l):c},o=async l=>{await e.put(n,l).catch(()=>{})}){const l=ir(await i(s).catch(()=>s));return{get(){return Si(l)},set(c){o(c).then(()=>l.set(c))},update(c){this.set(c(this.get()))},subscribe:l.subscribe}}}function Kn(r){let e=ir(r);return e.get=()=>Si(e),e}function Rl(r=[],e=()=>{}){let t=i1(r,e);return t.get=()=>Si(t),t}const Cm=Kn(De.cards),Bl=Kn(De.energy),Bo=Kn(De.log),Tm=Kn(De.matchedIndexes),yx=Ro(U.moves,De.moves),bt=Ro(U.options,De.options),pn=Kn(De.phase),hu=Kn(De.plusIndex),No=Ro(U.records,De.records),Nl=Kn(De.score),dd=Ro(U.timestamp,Date.now()),Mo=Rl([bt,dd],([{playerName:r},e])=>um({playerName:r,timestamp:e})),Lt=Rl([Bo,bt,Mo],([r,{rapid:e},t])=>{if(!e)return[];if(t!==Lt.seed&&(Lt.seed=t,Lt.prev=[],Lt.rows=[]),r.length===0){const n=cm(Lt.prev);n&&(Lt.rows=[...Lt.rows,{combo:n,key:performance.now()}],zr(vm),Lt.rows.length>7&&(Lt.rows=Lt.rows.slice(-7)),Lt.prev=[])}else Lt.prev=r;return Lt.rows}),pu=Ro(U.relays,De.relays,function(e){const t=localStorage.getItem(U.relays),n=t?JSON.parse(t):null;if(!n)return e;const s=new Set(n.active??[]),i=new Set(n.applied??[]),o=new Set(ri);for(const l of ri)i.has(l)||(s.add(l),i.add(l));for(const l of[...i])o.has(l)||(s.delete(l),i.delete(l));return{active:[...s],applied:[...i]}}),xi=Rl([pu],([{active:r}])=>r),fd=Rl([xi],([r])=>r.map(e=>{const t=e.match(/\/p2p\/([a-zA-Z0-9]+)$/);return t?t[1]:null}).filter(Boolean)),Xe=Kn(De.overlay),bs={cardsStore:Cm,energyStore:Bl,logStore:Bo,matchedIndexesStore:Tm,movesStore:yx,optionsStore:bt,phaseStore:pn,plusIndexStore:hu,recordsStore:No,scoreStore:Nl,seedStore:Mo,timestampStore:dd,ready:!0};function Pi(r,e=0){return hr(bs,r,e)}function zr(r,{muteRapid:e=!1}={}){return Nr(bs,r,{muteRapid:e})}function hd(r){Xe.set(null),oE(bs,r)}var bx=se('<div tabindex="0" role="button"><!> <div></div> <div></div></div>');function vx(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",d),n=()=>fe(pn,"$phaseStore",d),s=()=>fe(Tm,"$matchedIndexesStore",d),i=()=>fe(Bo,"$logStore",d),o=()=>fe(hu,"$plusIndexStore",d),l=()=>fe(Cm,"$cardsStore",d),c=()=>fe(Mo,"$seedStore",d),[d,f]=tr();let a=null,u=null,h=null,p=le(null),y=null,g=le(null),m=le(null),w=ie(()=>t().rapid),v=ie(()=>n()===te.idle),_=ie(()=>s().size>0&&i().length===1),k=ie(()=>!b(v)&&!b(_)),P=ie(()=>!b(v)||o()!==null),D=ie(()=>l()[o()]),I=ie(()=>!!(b(D)||b(p)||b(_))),x=ie(()=>Pl(l()));st(()=>{const Y=b(D)||b(p);Y&&X(g,Y,!0)}),st(()=>{s().size>0&&E({muteSound:!0})}),st(()=>{c()&&ct(()=>E({muteSound:!0}))});function B(){return!!b(p)}function Q({x:Y=0,y:oe=0}={}){if(!b(v))return{};if(S(),b(p)){y=b(p),Y+=b(p).x,oe+=b(p).y;const be=Y<0?Le.columns-1:Y%Le.columns,gt=oe<0?Le.rows-1:oe%Le.rows;return A({x:be,y:gt,topEdge:gt===0&&y&&y.y===Le.rows-1,bottomEdge:gt===Le.rows-1&&y&&y.y===0})}if(Y!==0)return y?(newValue={x:Y>0?0:Le.columns-1,y:y.y},y=null,A(newValue)):A({x:Math.round(Le.columns/2)+Y+(Y>0?-1:0),y:Math.round(Le.rows/2)+(Y>0?0:-1)});if(oe!==0){if(y){const be={x:y.x,y:oe>0?0:Le.rows-1};return y=null,A(be)}return A({x:Math.round(Le.columns/2)+(oe>0?-1:0),y:Math.round(Le.rows/2)+oe+(oe>0?-1:0)})}return b(p)||{}}function M(){if(!B())return;y=null;const Y=l().findIndex(({x:oe,y:be})=>oe===b(p).x&&be===b(p).y);Y!==-1&&(Nt(hu,Y),!b(P)&&zr(mm,{muteRapid:!0}))}function A(Y){B()||zr(nu);const oe=b(x)[Y.x][Y.y];return zr(()=>su(l()[oe].value)),X(p,Y,!0)}function E({savePrev:Y=!1,muteSound:oe=!1}={}){B()&&(y=Y?b(p):null,X(p,null),oe||zr(bm))}function S(){u.style.animation="none",u.offsetHeight,u.style.animation=null,h.style.animation="none",h.offsetHeight,h.style.animation=null}function T(Y){if(b(P)||b(m)!==null)return;B()||zr(nu);const oe=l()[Y];oe&&(b(p)&&b(p).x===oe.x&&b(p).y===oe.y||(S(),zr(()=>su(oe.value)),y=b(p),X(p,oe,!0)))}function C(Y){if(Y===a)return null;if(Y.classList.contains("card"))return Y;const oe=Y.querySelector(".card");if(oe)return oe;let be=Y.parentElement;for(;be;){if(be.classList.contains("card"))return be;be=be.parentElement}return null}function L(Y){const oe=C(Y.target);if(!oe||!oe.dataset.index)return null;const be=Number(oe.dataset.index);return isNaN(be)?null:be}function R(Y){if(!bs.ready)return;const oe=L(Y);oe!==null&&oe>=0&&T(oe)}function N(Y){E({muteSound:n()!==te.idle})}function $(Y){if(b(P))return;const oe=L(Y.detail);oe!==null&&(T(oe),b(w)||X(m,oe,!0),Y.detail.type==="mousedown"&&(zr(()=>ym(l()[oe].value),{}),b(w)&&M()))}function q(Y){b(w)||L(Y.detail)!==b(m)||(X(m,null),M(),E())}function F(Y){b(w)||X(m,null)}function H(Y){Y.preventDefault()}function G(Y,{duration:oe=400}={}){let be;st(()=>{const gt=(gr={})=>{Y.dispatchEvent(new CustomEvent("longpressstart",{bubbles:!0,detail:gr})),be=window.setTimeout(()=>{Y.dispatchEvent(new CustomEvent("longpressfire",{bubbles:!0,detail:gr}))},oe)},nr=(gr={})=>{clearTimeout(be),Y.dispatchEvent(new CustomEvent("longpressend",{bubbles:!0,detail:gr}))};return Y.addEventListener("mousedown",gt,{passive:!0}),Y.addEventListener("touchstart",gt,{passive:!0}),Y.addEventListener("touchend",nr,{passive:!0}),window.addEventListener("mouseup",nr,{passive:!0}),()=>{clearTimeout(be),Y.removeEventListener("mousedown",gt),Y.removeEventListener("touchstart",gt),Y.removeEventListener("touchend",nr),window.removeEventListener("mouseup",nr)}})}var re={isFocused:B,shiftFocus:Q,plusFocusedCard:M,focusCard:A,blur:E,longpress:G},ne=bx();let K;ne.__mousemove=R,ne.__dblclick=H;let ee;var ge=O(ne);Dn(ge,1,l,ti,(Y,oe,be)=>{const gt=ie(()=>b(oe).x===(b(p)&&b(p).x)&&b(oe).y===(b(p)&&b(p).y));{let nr=ie(()=>s().has(be)),gr=ie(()=>be===b(m)),Gn=ie(()=>be===o());lE(Y,{get card(){return b(oe)},index:be,get focus(){return b(gt)},get blink(){return b(nr)},get longpress(){return b(gr)},get plus(){return b(Gn)}})}});var Me=z(ge,2);let tt;Ze(Me,Y=>u=Y,()=>u);var Oe=z(Me,2);let pt;Ze(Oe,Y=>h=Y,()=>h),Ze(ne,Y=>a=Y,()=>a),zg(ne,Y=>G?.(Y)),Te(()=>{K=Ue(ne,1,"board svelte-nytrg3",null,K,{overflow:b(k),progress:b(P)}),ee=Ct(ne,"",ee,{"--focus-x":b(g)&&b(g).x,"--focus-y":b(g)&&b(g).y}),tt=Ue(Me,1,"slider horizontal svelte-nytrg3",null,tt,{blink:b(_),focus:b(I)}),pt=Ue(Oe,1,"slider vertical svelte-nytrg3",null,pt,{blink:b(_),focus:b(I)})}),_r("mouseleave",ne,N),_r("longpressstart",ne,$),_r("longpressfire",ne,q),_r("longpressend",ne,F),J(r,ne);var Ur=ht(re);return f(),Ur}$r(["mousemove","dblclick"]);var wx=se('<span class="back svelte-5x6s5r">O</span>'),_x=se("<span> </span>"),Sx=se('<span class="energy-out svelte-5x6s5r"></span>'),Ex=se('<div class="energy svelte-5x6s5r"><div><span> </span></div> <div><span><span class="front svelte-5x6s5r"> </span> <!></span></div> <!></div>');function Pm(r,e){ft(e,!0);const t=()=>fe(Bl,"$energyStore",s),n=()=>fe(pn,"$phaseStore",s),[s,i]=tr();let o=Qr(e,"gameOver",3,!1),l=le(!1),c=ie(()=>t().value),d=ie(()=>b(c)>100),f=ie(()=>b(c)<20&&n()===te.idle),a=ie(()=>`
    z-index: ${b(d)?0:1};
    flex: ${(b(d)?200-b(c):b(c))/100};
  `),u=ie(()=>`
    position: ${b(d)?"absolute":"relative"};
  `),h=ie(()=>`
    z-index: ${b(d)?1:0};
    flex: ${b(d)?(b(c)-100)/100:0};
  `),p=ie(()=>`
    position: ${b(d)?"relative":"absolute"};
    left: ${b(d)?`calc(${b(c)>119?0:(b(c)-120)/100} * 128rem)`:0};
  `);st(()=>{b(f)&&zr(gm)}),st(()=>{o()&&!b(l)&&setTimeout(()=>X(l,!0))});var y=Ex(),g=O(y);let m;var w=O(g);let v;var _=O(w),k=z(g,2);let P;var D=O(k);let I;var x=O(D),B=O(x),Q=z(x,2);{var M=S=>{var T=wx();J(S,T)};we(Q,S=>{o()&&S(M)})}var A=z(k,2);{var E=S=>{var T=Sx();Dn(T,20,()=>"ut of energy",ti,(C,L,R)=>{var N=_x();Ct(N,"",{},{"animation-delay":`${400+R*100}ms`});var $=O(N);Te(()=>{Ue(N,1,Gg(L===" "?"space":"letter"),"svelte-5x6s5r"),He($,L)}),J(C,N)}),J(S,T)};we(A,S=>{o()&&S(E)})}Te(()=>{m=Ue(g,1,"left-bar svelte-5x6s5r",null,m,{warning:b(f)}),Ct(g,b(a)),v=Ue(w,1,"left-value svelte-5x6s5r",null,v,{warning:b(f)}),Ct(w,b(u)),He(_,b(c)),P=Ue(k,1,"right-bar svelte-5x6s5r",null,P,{extra:b(d)}),Ct(k,b(h)),I=Ue(D,1,"right-value svelte-5x6s5r",null,I,{warning:b(f),flip:b(l)}),Ct(D,b(p)),He(B,b(c))}),J(r,y),ht(),i()}o_();const xx=r=>r;function Dm(r){const e=r-1;return e*e*e+1}function Ax(r){return r<.5?4*r*r*r:.5*Math.pow(2*r-2,3)+1}function gu(r){const e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}function Lr(r,{delay:e=0,duration:t=400,easing:n=Ax,amount:s=5,opacity:i=0}={}){const o=getComputedStyle(r),l=+o.opacity,c=o.filter==="none"?"":o.filter,d=l*(1-i),[f,a]=gu(s);return{delay:e,duration:t,easing:n,css:(u,h)=>`opacity: ${l-d*h}; filter: ${c} blur(${h*f}${a});`}}function ga(r,{delay:e=0,duration:t=400,easing:n=xx}={}){const s=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:n,css:i=>`opacity: ${i*s}`}}function Ht(r,{delay:e=0,duration:t=400,easing:n=Dm,x:s=0,y:i=0,opacity:o=0}={}){const l=getComputedStyle(r),c=+l.opacity,d=l.transform==="none"?"":l.transform,f=c*(1-o),[a,u]=gu(s),[h,p]=gu(i);return{delay:e,duration:t,easing:n,css:(y,g)=>`
			transform: ${d} translate(${(1-y)*a}${u}, ${(1-y)*h}${p});
			opacity: ${c-f*g}`}}function dh(r,{delay:e=0,duration:t=400,easing:n=Dm,axis:s="y"}={}){const i=getComputedStyle(r),o=+i.opacity,l=s==="y"?"height":"width",c=parseFloat(i[l]),d=s==="y"?["top","bottom"]:["left","right"],f=d.map(m=>`${m[0].toUpperCase()}${m.slice(1)}`),a=parseFloat(i[`padding${f[0]}`]),u=parseFloat(i[`padding${f[1]}`]),h=parseFloat(i[`margin${f[0]}`]),p=parseFloat(i[`margin${f[1]}`]),y=parseFloat(i[`border${f[0]}Width`]),g=parseFloat(i[`border${f[1]}Width`]);return{delay:e,duration:t,easing:n,css:m=>`overflow: hidden;opacity: ${Math.min(m*20,1)*o};${l}: ${m*c}px;padding-${d[0]}: ${m*a}px;padding-${d[1]}: ${m*u}px;margin-${d[0]}: ${m*h}px;margin-${d[1]}: ${m*p}px;border-${d[0]}-width: ${m*y}px;border-${d[1]}-width: ${m*g}px;min-${l}: 0`}}var Ix=se('<span class="plus svelte-zkpbwt">+</span>'),kx=se('<span class="value svelte-zkpbwt"> </span> <!>',1),Cx=se('<span class="counts svelte-zkpbwt"> </span>'),Tx=se('<span class="svelte-zkpbwt">]</span> <!> <span class="svelte-zkpbwt">=</span> <span class="sum svelte-zkpbwt"> </span>',1),Px=se('<span class="extra svelte-zkpbwt"> </span> <span class="svelte-zkpbwt">]=</span> <span class="sum svelte-zkpbwt"> </span>',1),Dx=se('<li class="row svelte-zkpbwt"><span class="svelte-zkpbwt"></span> <span class="svelte-zkpbwt">[</span> <!> <!></li>'),Lx=se('<span class="svelte-zkpbwt"> </span>'),Rx=se('<li><!> <span class="sum svelte-zkpbwt"> </span></li>'),Bx=se('<span class="combo svelte-zkpbwt"> </span>'),Nx=se('<ol class="log svelte-zkpbwt"><!> <!> <!></ol>');function Mx(r,e){ft(e,!1);const t=()=>fe(pn,"$phaseStore",o),n=()=>fe(Bo,"$logStore",o),s=()=>fe(Nl,"$scoreStore",o),i=()=>fe(Lt,"$combosStore",o),[o,l]=tr();function c(y=[]){let{length:g}=y;return g<1?"":(g>4&&(g=4),y.reduce((m,w,v)=>m+`--clr-${v+1}: var(--color-${w});`,`animation: colors-${g} ${200+200*g}ms steps(2, end) infinite;`))}s1();var d=Nx(),f=O(d);{var a=y=>{var g=Yr(),m=rt(g);Dn(m,1,n,ti,(w,v,_)=>{let k=()=>b(v).digits,P=()=>b(v).counts,D=()=>b(v).extra,I=()=>b(v).sum,x=()=>R_(b(v),["digits","counts","extra","sum"]);const B=ro(()=>Object.keys(x()));var Q=Dx(),M=O(Q);M.textContent=_+1;var A=z(M,4);Dn(A,1,()=>b(B),ti,(C,L,R)=>{var N=kx(),$=rt(N);let q;var F=O($),H=z($,2);{var G=re=>{var ne=Ix();J(re,ne)};we(H,re=>{R<b(B).length-1&&re(G)})}Te(()=>{q=Ct($,"",q,{color:`var(--color-${b(L)??""})`}),He(F,x()[b(L)])}),J(C,N)});var E=z(A,2);{var S=C=>{var L=Tx(),R=z(rt(L),2);{var N=F=>{var H=Cx(),G=O(H);Te(re=>{Ct(H,re),He(G,P())},[()=>c(k())]),J(F,H)};we(R,F=>{P()>1&&F(N)})}var $=z(R,4),q=O($);Te(()=>He(q,(_+1)*I()*P())),J(C,L)},T=C=>{var L=Px(),R=rt(L),N=O(R),$=z(R,4),q=O($);Te(()=>{He(N,D()),He(q,(_+1)*D())}),J(C,L)};we(E,C=>{D()===void 0?C(S):C(T,!1)})}xe(1,Q,()=>dh,()=>Pi({duration:100})),xe(2,Q,()=>ga,()=>Pi({duration:200})),J(w,Q)}),J(y,g)};we(f,y=>{t()!==te.score&&y(a)})}var u=z(f,2);{var h=y=>{const g=ro(()=>n().length===1);var m=Rx();let w;var v=O(m);{var _=D=>{var I=Lx(),x=O(I);Te(()=>He(x,b(g)?"":"combo:")),xe(2,I,()=>ga,()=>Pi({duration:200})),J(D,I)};we(v,D=>{t()===te.combo&&D(_)})}var k=z(v,2),P=O(k);Te(()=>{w=Ue(m,1,"svelte-zkpbwt",null,w,{collapse:b(g)}),He(P,`${t()===te.score&&s().buffer>0?"+":""}${s().buffer??""}`)}),xe(1,m,()=>dh,()=>Pi({duration:b(g)?0:100})),xe(2,m,()=>ga,()=>Pi({duration:200})),J(y,m)};we(u,y=>{(t()===te.combo||t()===te.score)&&y(h)})}var p=z(u,2);Dn(p,1,i,({combo:y,key:g})=>g,(y,g)=>{let m=()=>b(g).combo;var w=Bx(),v=O(w);Te(()=>He(v,`+${m()??""}`)),J(y,w)}),J(r,d),ht(),l()}var Ox=se('<span class="value"> </span>'),$x=se('<span tabindex="0" role="button"><span> </span> <!></span>');function Lm(r,e){ft(e,!0);const t=()=>fe(Nl,"$scoreStore",i),n=()=>fe(No,"$recordsStore",i),s=()=>fe(pn,"$phaseStore",i),[i,o]=tr(),l={[U.highCombo]:"hi-combo",[U.highScore]:"hi-score",[U.score]:"score"};let c=le(jr(U.score)),d=le(null),f=le(!1),a=le(!1),u=ie(()=>b(c)===U.score?t().value:n()[b(c)][U.value]),h=ie(()=>"score: "+b(u)+`
high score: `+n()[U.highScore][U.value]+`
high combo: `+n()[U.highCombo][U.value]);st(()=>{e.newRecord&&(X(c,e.newRecordHighScore?U.highScore:U.highCombo,!0),X(f,!0))});function p(){return b(a)}function y(){X(a,!0)}function g(){X(a,!1)}function m(x){x.preventDefault(),X(c,v(b(c)),!0),_()}function w(){X(c,v(b(c),!0),!0),_()}function v(x,B=!1){return e.newRecord?{[U.highScore]:e.newRecordHighCombo?U.highCombo:U.highScore,[U.highCombo]:e.newRecordHighScore?U.highScore:U.highCombo}[x]:B?{[U.score]:U.highCombo,[U.highScore]:U.score,[U.highCombo]:U.highScore}[x]:{[U.score]:U.highScore,[U.highScore]:U.highCombo,[U.highCombo]:U.score}[x]}function _(){X(f,!0),clearTimeout(b(d)),!e.newRecord&&X(d,setTimeout(()=>{X(c,U.score,!0),X(f,e.newRecord,!0)},3200),!0)}var k={isFocused:p,focus:y,blur:g,nextType:m,prevType:w},P=Yr(),D=rt(P);K_(D,()=>b(c),x=>{var B=$x();let Q;B.__click=m;var M=O(B);let A;var E=O(M),S=z(M,2);{var T=C=>{var L=Ox(),R=O(L);Te(()=>He(R,b(u))),J(C,L)};we(S,C=>{(e.overlaid||s()!==te.gameOver)&&C(T)})}Te(()=>{Q=Ue(B,1,"score",null,Q,{focus:b(a)}),Ln(B,"title",b(h)),A=Ue(M,1,"type",null,A,{visible:b(f)}),He(E,`${l[b(c)]??""}:`)}),xe(1,B,()=>Lr),J(x,B)}),J(r,P);var I=ht(k);return o(),I}$r(["click"]);var Fx=se('<span class="rapid">rapid</span>'),Ux=se('<div class="section-1"><button title="[open menu]"><h1>digifall <!></h1> <!></button></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div>',1),Vx=se('<div><div class="seedground"></div> <div class="content"><!></div></div>');function Kx(r,e){ft(e,!0);const t=()=>fe(Bo,"$logStore",l),n=()=>fe(Lt,"$combosStore",l),s=()=>fe(Xe,"$overlayStore",l),i=()=>fe(Mo,"$seedStore",l),o=()=>fe(bt,"$optionsStore",l),[l,c]=tr();let d=le(null),f=le(null),a=le(null),u=ie(()=>t().length>0||n().length>0);st(()=>{b(d)&&(b(d).isFocused=()=>b(d).classList.contains("focus"),b(d).focus=()=>b(d).classList.add("focus"),b(d).blur=()=>b(d).classList.remove("focus"))});function h(){b(d).isFocused()?(b(d).blur(),b(a).shiftFocus({y:1})):b(f).isFocused()?(b(f).blur(),b(d).focus()):b(a).shiftFocus({y:1}).topEdge&&(b(a).blur({savePrev:!0}),b(f).focus())}function p(){b(d).isFocused()?(b(d).blur(),b(f).focus()):b(f).isFocused()?(b(f).blur(),b(a).shiftFocus({y:-1})):b(a).shiftFocus({y:-1}).bottomEdge&&(b(a).blur({savePrev:!0}),b(d).focus())}function y(){b(d).isFocused()||(b(f).isFocused()?b(f).prevType():b(a).shiftFocus({x:-1}))}function g(){b(d).isFocused()||(b(f).isFocused()?b(f).nextType():b(a).shiftFocus({x:1}))}function m(){b(d).isFocused()?(b(d).click(),b(d).blur(),b(a).blur({savePrev:!0})):b(f).isFocused()?b(f).nextType():b(a).plusFocusedCard()}function w(){b(d).blur(),b(f).blur(),b(a).blur()}function v(M){if(!M)return;const A=()=>M=Da(M),E=(q=13)=>`hsl(${A()%360},50%,${q}%)`,S=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149];let T=4;const C=[];for(;T--;){const[q]=S.splice(A()%S.length,1);C.push(q)}const[L,R,N,$]=C;return`
      background-color: var(--color-dark);
      background-image:
        linear-gradient(90deg, ${E()} 50%, transparent 50%),
        linear-gradient(90deg, ${E()} 50%, transparent 50%),
        linear-gradient(90deg, transparent 50%, ${E()} 50%),
        linear-gradient(90deg, transparent 50%, ${E()} 50%);
      background-size: ${L}rem, ${R}rem, ${N}rem, ${$}rem;`}var _={moveUp:h,moveDown:p,moveLeft:y,moveRight:g,perfomAction:m,blur:w},k=Vx();let P;var D=O(k),I=z(D,2),x=O(I);{var B=M=>{var A=Ux(),E=rt(A),S=O(E);let T;S.__click=()=>Nt(Xe,de.menu);var C=O(S),L=z(O(C));{var R=ne=>{var K=Fx();J(ne,K)};we(L,ne=>{o().rapid&&ne(R)})}var N=z(C,2);Mx(N,{}),Ze(S,ne=>X(d,ne),()=>b(d));var $=z(E,2),q=O($);Ze(Lm(q,{}),ne=>X(f,ne,!0),()=>b(f));var F=z($,2),H=O(F);Ze(vx(H,{}),ne=>X(a,ne,!0),()=>b(a));var G=z(F,2),re=O(G);Pm(re,{}),Te(()=>T=Ue(S,1,"digifall",null,T,{screen:b(u)})),J(M,A)};we(x,M=>{i()&&M(B)})}Te(M=>{P=Ue(k,1,"game",null,P,{blur:s()}),Ct(D,M)},[()=>v(i())]),J(r,k);var Q=ht(_);return c(),Q}$r(["click"]);var qx=se("<h1> </h1>"),Hx=se("<button>p2p leaderboard</button>"),zx=se('<div class="col"><button>new game</button> <!> <button>options</button></div>'),Wx=se('<div><div class="section-1"><!></div> <div class="section-2"><!></div> <div class="section-3"><!></div> <div class="section-4"><!></div></div>');function Gx(r,e){ft(e,!0);const t=()=>fe(Bl,"$energyStore",o),n=()=>fe(No,"$recordsStore",o),s=()=>fe(Nl,"$scoreStore",o),i=()=>fe(bt,"$optionsStore",o),[o,l]=tr();let c=Qr(e,"scoreComponent",15,null),d=ie(()=>t().value===0),f=ie(()=>b(d)&&t().buffer===0),a=ie(()=>n()[U.highCombo][U.value]),u=ie(()=>b(f)&&b(a)>bs[U.highComboPrev]),h=ie(()=>b(f)&&s().value>bs[U.highScorePrev]),p=ie(()=>b(u)||b(h));function y(){hd()}function g(){Xe.set(de.leaderboard)}function m(){Xe.set(de.options)}var w=Wx();let v;var _=O(w),k=O(_);{var P=E=>{var S=qx(),T=O(S);Te(()=>He(T,b(p)?"new record!":"game over")),xe(5,S,()=>Ht,()=>({delay:600,y:-48})),J(E,S)};we(k,E=>{b(f)&&E(P)})}var D=z(_,2),I=O(D);Ze(Lm(I,{get newRecordHighCombo(){return b(u)},get newRecordHighScore(){return b(h)},get newRecord(){return b(p)},overlaid:!0}),E=>c(E),()=>c());var x=z(D,2),B=O(x);{var Q=E=>{var S=zx(),T=O(S);T.__click=y;var C=z(T,2);{var L=N=>{var $=Hx();$.__click=g,J(N,$)};we(C,N=>{i()[U.leaderboard]&&N(L)})}var R=z(C,2);R.__click=m,xe(5,S,()=>Ht,()=>({delay:600,y:24})),J(E,S)};we(B,E=>{b(f)&&E(Q)})}var M=z(x,2),A=O(M);Pm(A,{get gameOver(){return b(f)}}),Te(()=>v=Ue(w,1,"game-over content",null,v,{"new-record":b(p)})),xe(1,w,()=>Lr),J(r,w),ht(),l()}$r(["click"]);var Yx=se('<div class="virtual-item svelte-a5i8l1"><!></div>'),Xx=se('<div class="virtual-scroll svelte-a5i8l1"><div class="virtual-list"></div></div>');function Zx(r,e){ft(e,!0);let t=Qr(e,"bufferSize",3,16),n=Qr(e,"startIndex",15,0),s=Qr(e,"endIndex",15,0),i=Qr(e,"keyFn",3,(k,P)=>P),o=le(null),l=le(0),c=le(0),d=le(0),f=ie(()=>Math.max(0,n()-t())),a=ie(()=>Math.min(s()+t(),e.items.length)),u=ie(()=>e.items.slice(b(f),b(a))),h=ie(()=>b(f)*b(c)),p=ie(()=>e.items.length*b(c));st(()=>{b(c)&&(n(Math.floor(b(d)/b(c))),s(n()+Math.ceil(b(l)/b(c))))});function y(k){X(d,k.target.scrollTop)}function g(k,P=!1){k<0||k>=e.items.length||requestAnimationFrame(()=>{b(o)?.scrollTo({top:k*b(c),behavior:P?"smooth":"instant"})})}var m={scrollToIndex:g},w=Xx(),v=O(w);let _;return Dn(v,23,()=>b(u),(k,P)=>i()(k,b(f)+P),(k,P,D)=>{var I=Yx(),x=O(I);qg(x,()=>e.children??Kt,()=>b(P),()=>b(f)+b(D)),Kf(I,"offsetHeight",B=>X(c,B)),J(k,I)}),Ze(w,k=>X(o,k),()=>b(o)),Te(()=>_=Ct(v,"",_,{height:`${b(p)??""}px`,"padding-top":`${b(h)??""}px`})),_r("scroll",w,y),Kf(w,"offsetHeight",k=>X(l,k)),J(r,w),ht(m)}const jx=Symbol.for("@libp2p/connection"),fh=Symbol.for("@libp2p/content-routing");let co=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class Qx extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}class hh extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}}let V=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class Rm extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class Bm extends Error{static name="InvalidPrivateKeyError";constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}class mu extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class Jx extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class Ki extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class eA extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class Di extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}class ph extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}}class $a extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}}class Nm extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let pd=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class Oo extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class qn extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class tA extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class $e extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}let ac=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},rA=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class uo extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class ma extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class yu extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class gh extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class nA extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class Mm extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class Ir extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class sA extends Event{data;constructor(e,t){super("message",t),this.data=e}}class Ml extends Event{error;local;constructor(e,t,n){super("close",n),this.error=t,this.local=e}}class iA extends Ml{constructor(e,t){super(!0,e,t)}}class oA extends Ml{constructor(e,t){super(!1,e,t)}}const Fa=Symbol.for("@libp2p/peer-discovery"),ot=Symbol.for("@libp2p/peer-id");function Yi(r){return!!r?.[ot]}const mh=Symbol.for("@libp2p/peer-routing"),gd="keep-alive";function md(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Om(...r){const e=[];for(const t of r)md(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function $m(...r){const e=[];for(const t of r)md(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const Fm=Symbol.for("@libp2p/transport");var Ua;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Ua||(Ua={}));class Dt extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}const xr=Symbol.for("@libp2p/service-capabilities"),Va=Symbol.for("@libp2p/service-dependencies");class yh extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class bh extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class aA extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Ot={get(r=globalThis){const e=r.crypto;if(e?.subtle==null)throw new aA("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};function pe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function an(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));const t=on(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return t}const Um=Symbol.for("@achingbrain/uint8arraylist");function vh(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function Zo(r){return!!r?.[Um]}class Ne{bufs;length;[Um]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Zo(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Zo(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=vh(this.bufs,e);return t.buf[t.index]}set(e,t){const n=vh(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Zo(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return an(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:an(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new Ne;return i.length=s,i.bufs=[...n],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],l=s,c=l+o.byteLength;if(s=c,e>=c)continue;const d=e>=l&&e<c,f=t>l&&t<=c;if(d&&f){if(e===l&&t===c){n.push(o);break}const a=e-l;n.push(o.subarray(a,a+(t-e)));break}if(d){if(e===0){n.push(o);continue}n.push(o.subarray(e-l));continue}if(f){if(t===c){n.push(o);break}n.push(o.subarray(0,t-l));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Zo(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let a=0;a<i;a++)o[a]=-1;for(let a=0;a<s;a++)o[n[a]]=a;const l=o,c=this.byteLength-n.byteLength,d=n.byteLength-1;let f;for(let a=t;a<=c;a+=f){f=0;for(let u=d;u>=0;u--){const h=this.get(a+u);if(n[u]!==h){f=Math.max(1,u-l[h]);break}}if(f===0)return a}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=on(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=on(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=Ke(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=Ke(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=Ke(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof Ne)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!pe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Ne;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}const lA=parseInt("11111",2),bu=parseInt("10000000",2),cA=parseInt("01111111",2),wh={0:Li,1:Li,2:uA,3:hA,4:pA,5:fA,6:dA,16:Li,22:Li,48:Li};function Hn(r,e={offset:0}){const t=r[e.offset]&lA;if(e.offset++,wh[t]!=null)return wh[t](r,e);throw new Error("No decoder for tag "+t)}function $o(r,e){let t=0;if((r[e.offset]&bu)===bu){const n=r[e.offset]&cA;let s="0x";e.offset++;for(let i=0;i<n;i++,e.offset++)s+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=r[e.offset],e.offset++;return t}function Li(r,e){$o(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Hn(r,e);if(n===null)break;t.push(n)}return t}function uA(r,e){const t=$o(r,e),n=e.offset,s=e.offset+t,i=[];for(let o=n;o<s;o++)o===n&&r[o]===0||i.push(r[o]);return e.offset+=t,Uint8Array.from(i)}function dA(r,e){const t=$o(r,e),n=e.offset+t,s=r[e.offset];e.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let l=`${i}.${o}`,c=[];for(;e.offset<n;){const d=r[e.offset];if(e.offset++,c.push(d&127),d<128){c.reverse();let f=0;for(let a=0;a<c.length;a++)f+=c[a]<<a*7;l+=`.${f}`,c=[]}}return l}function fA(r,e){return e.offset++,null}function hA(r,e){const t=$o(r,e),n=r[e.offset];e.offset++;const s=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function pA(r,e){const t=$o(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function gA(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ne;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function Ol(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=gA(r.byteLength);return new Ne(Uint8Array.from([e.byteLength|bu]),e)}function Xt(r){const e=new Ne,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ne(Uint8Array.from([2]),Ol(e),e)}function yd(r){const e=Uint8Array.from([0]),t=new Ne(e,r);return new Ne(Uint8Array.from([3]),Ol(t),t)}function mA(r){return new Ne(Uint8Array.from([4]),Ol(r),r)}function rn(r,e=48){const t=new Ne;for(const n of r)t.append(n);return new Ne(Uint8Array.from([e]),Ol(t),t)}const Vm="1.2.840.10045.3.1.7",Km="1.3.132.0.34",qm="1.3.132.0.35";async function yA(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function bA(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]);t?.signal?.throwIfAborted();const s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},n,e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function vA(r,e,t,n){const s=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return n?.signal?.throwIfAborted(),i}const wA=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),_A=Uint8Array.from([6,5,43,129,4,0,34]),SA=Uint8Array.from([6,5,43,129,4,0,35]),Hm={ext:!0,kty:"EC",crv:"P-256"},zm={ext:!0,kty:"EC",crv:"P-384"},Wm={ext:!0,kty:"EC",crv:"P-521"},zs=32,Ws=48,Gs=66;function EA(r){const e=Hn(r);return Gm(e)}function Gm(r){const e=r[1],t=W(e,"base64url"),n=r[2][1][0],s=1;let i,o;if(e.byteLength===zs)return i=W(n.subarray(s,s+zs),"base64url"),o=W(n.subarray(s+zs),"base64url"),new ba({...Hm,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Ws)return i=W(n.subarray(s,s+Ws),"base64url"),o=W(n.subarray(s+Ws),"base64url"),new ba({...zm,key_ops:["sign"],d:t,x:i,y:o});if(e.byteLength===Gs)return i=W(n.subarray(s,s+Gs),"base64url"),o=W(n.subarray(s+Gs),"base64url"),new ba({...Wm,key_ops:["sign"],d:t,x:i,y:o});throw new V(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function Ym(r){const e=Hn(r);return Xm(e)}function Xm(r){const e=r[1][1][0],t=1;let n,s;if(e.byteLength===zs*2+1)return n=W(e.subarray(t,t+zs),"base64url"),s=W(e.subarray(t+zs),"base64url"),new ya({...Hm,key_ops:["verify"],x:n,y:s});if(e.byteLength===Ws*2+1)return n=W(e.subarray(t,t+Ws),"base64url"),s=W(e.subarray(t+Ws),"base64url"),new ya({...zm,key_ops:["verify"],x:n,y:s});if(e.byteLength===Gs*2+1)return n=W(e.subarray(t,t+Gs),"base64url"),s=W(e.subarray(t+Gs),"base64url"),new ya({...Wm,key_ops:["verify"],x:n,y:s});throw new V(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function xA(r){return rn([Xt(Uint8Array.from([1])),mA(j(r.d??"","base64url")),rn([Zm(r.crv)],160),rn([yd(new Ne(Uint8Array.from([4]),j(r.x??"","base64url"),j(r.y??"","base64url")))],161)]).subarray()}function AA(r){return rn([Xt(Uint8Array.from([1])),rn([Zm(r.crv)],160),rn([yd(new Ne(Uint8Array.from([4]),j(r.x??"","base64url"),j(r.y??"","base64url")))],161)]).subarray()}function Zm(r){if(r==="P-256")return wA;if(r==="P-384")return _A;if(r==="P-521")return SA;throw new V(`Invalid curve ${r}`)}async function IA(r="P-256"){const e=await yA(r);return new ba(e.privateKey)}class ya{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=AA(this.jwk)),this._raw}toMultihash(){return it.digest(Sr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async verify(e,t,n){return vA(this.jwk,t,e,n)}}class ba{type="ECDSA";jwk;publicKey;_raw;constructor(e){this.jwk=e,this.publicKey=new ya({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=xA(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}async sign(e,t){return bA(this.jwk,e,t)}}function $l(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Rr(r,e=""){if(!Number.isSafeInteger(r)||r<0){const t=e&&`"${e}" `;throw new Error(`${t}expected integer >= 0, got ${r}`)}}function ve(r,e,t=""){const n=$l(r),s=r?.length,i=e!==void 0;if(!n||i&&s!==e){const o=t&&`"${t}" `,l=i?` of length ${e}`:"",c=n?`length=${s}`:`type=${typeof r}`;throw new Error(o+"expected Uint8Array"+l+", got "+c)}return r}function bd(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash must wrapped by utils.createHasher");Rr(r.outputLen),Rr(r.blockLen)}function Ka(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function kA(r,e){ve(r,void 0,"digestInto() output");const t=e.outputLen;if(r.length<t)throw new Error('"digestInto() output" expected to be of length >='+t)}function ln(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function Xi(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function kr(r,e){return r<<32-e|r>>>e}function lc(r,e){return r<<e|r>>>32-e>>>0}const jm=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",CA=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Fo(r){if(ve(r),jm)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=CA[r[t]];return e}const Vr={_0:48,_9:57,A:65,F:70,a:97,f:102};function _h(r){if(r>=Vr._0&&r<=Vr._9)return r-Vr._0;if(r>=Vr.A&&r<=Vr.F)return r-(Vr.A-10);if(r>=Vr.a&&r<=Vr.f)return r-(Vr.a-10)}function fo(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(jm)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const o=_h(r.charCodeAt(i)),l=_h(r.charCodeAt(i+1));if(o===void 0||l===void 0){const c=r[i]+r[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}n[s]=o*16+l}return n}const TA=async()=>{};async function PA(r,e,t){let n=Date.now();for(let s=0;s<r;s++){t(s);const i=Date.now()-n;i>=0&&i<e||(await TA(),n+=i)}}function DA(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function Sh(r,e=""){return typeof r=="string"?DA(r):ve(r,void 0,e)}function Dr(...r){let e=0;for(let n=0;n<r.length;n++){const s=r[n];ve(s),e+=s.length}const t=new Uint8Array(e);for(let n=0,s=0;n<r.length;n++){const i=r[n];t.set(i,s),s+=i.length}return t}function LA(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options must be object or undefined");return Object.assign(r,e)}function vd(r,e={}){const t=(s,i)=>r(i).update(s).digest(),n=r(void 0);return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>r(s),Object.assign(t,e),Object.freeze(t)}function Fl(r=32){const e=typeof globalThis=="object"?globalThis.crypto:null;if(typeof e?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return e.getRandomValues(new Uint8Array(r))}const Qm=r=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,r])});function Jm(r,e,t){return r&e^~r&t}function ey(r,e,t){return r&e^r&t^e&t}class wd{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,n,s){this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Xi(this.buffer)}update(e){Ka(this),ve(e);const{view:t,buffer:n,blockLen:s}=this,i=e.length;for(let o=0;o<i;){const l=Math.min(s-this.pos,i-o);if(l===s){const c=Xi(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+l),this.pos),this.pos+=l,o+=l,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ka(this),kA(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:i}=this;let{pos:o}=this;t[o++]=128,ln(this.buffer.subarray(o)),this.padOffset>s-o&&(this.process(n,0),o=0);for(let a=o;a<s;a++)t[a]=0;n.setBigUint64(s-8,BigInt(this.length*8),i),this.process(n,0);const l=Xi(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const d=c/4,f=this.get();if(d>f.length)throw new Error("_sha2: outputLen bigger than state");for(let a=0;a<d;a++)l.setUint32(4*a,f[a],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:l}=this;return e.destroyed=o,e.finished=i,e.length=s,e.pos=l,s%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const bn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Et=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),jo=BigInt(2**32-1),Eh=BigInt(32);function RA(r,e=!1){return e?{h:Number(r&jo),l:Number(r>>Eh&jo)}:{h:Number(r>>Eh&jo)|0,l:Number(r&jo)|0}}function BA(r,e=!1){const t=r.length;let n=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:o,l}=RA(r[i],e);[n[i],s[i]]=[o,l]}return[n,s]}const xh=(r,e,t)=>r>>>t,Ah=(r,e,t)=>r<<32-t|e>>>t,Rs=(r,e,t)=>r>>>t|e<<32-t,Bs=(r,e,t)=>r<<32-t|e>>>t,Qo=(r,e,t)=>r<<64-t|e>>>t-32,Jo=(r,e,t)=>r>>>t-32|e<<64-t;function Kr(r,e,t,n){const s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}const NA=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),MA=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,OA=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),$A=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,FA=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),UA=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0,VA=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),vn=new Uint32Array(64);class KA extends wd{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i,F:o,G:l,H:c}=this;return[e,t,n,s,i,o,l,c]}set(e,t,n,s,i,o,l,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=l|0,this.H=c|0}process(e,t){for(let a=0;a<16;a++,t+=4)vn[a]=e.getUint32(t,!1);for(let a=16;a<64;a++){const u=vn[a-15],h=vn[a-2],p=kr(u,7)^kr(u,18)^u>>>3,y=kr(h,17)^kr(h,19)^h>>>10;vn[a]=y+vn[a-7]+p+vn[a-16]|0}let{A:n,B:s,C:i,D:o,E:l,F:c,G:d,H:f}=this;for(let a=0;a<64;a++){const u=kr(l,6)^kr(l,11)^kr(l,25),h=f+u+Jm(l,c,d)+VA[a]+vn[a]|0,y=(kr(n,2)^kr(n,13)^kr(n,22))+ey(n,s,i)|0;f=d,d=c,c=l,l=o+h|0,o=i,i=s,s=n,n=h+y|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,l=l+this.E|0,c=c+this.F|0,d=d+this.G|0,f=f+this.H|0,this.set(n,s,i,o,l,c,d,f)}roundClean(){ln(vn)}destroy(){this.set(0,0,0,0,0,0,0,0),ln(this.buffer)}}class qA extends KA{A=bn[0]|0;B=bn[1]|0;C=bn[2]|0;D=bn[3]|0;E=bn[4]|0;F=bn[5]|0;G=bn[6]|0;H=bn[7]|0;constructor(){super(32)}}const ty=BA(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),HA=ty[0],zA=ty[1],wn=new Uint32Array(80),_n=new Uint32Array(80);class WA extends wd{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:l,Dl:c,Eh:d,El:f,Fh:a,Fl:u,Gh:h,Gl:p,Hh:y,Hl:g}=this;return[e,t,n,s,i,o,l,c,d,f,a,u,h,p,y,g]}set(e,t,n,s,i,o,l,c,d,f,a,u,h,p,y,g){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=l|0,this.Dl=c|0,this.Eh=d|0,this.El=f|0,this.Fh=a|0,this.Fl=u|0,this.Gh=h|0,this.Gl=p|0,this.Hh=y|0,this.Hl=g|0}process(e,t){for(let v=0;v<16;v++,t+=4)wn[v]=e.getUint32(t),_n[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const _=wn[v-15]|0,k=_n[v-15]|0,P=Rs(_,k,1)^Rs(_,k,8)^xh(_,k,7),D=Bs(_,k,1)^Bs(_,k,8)^Ah(_,k,7),I=wn[v-2]|0,x=_n[v-2]|0,B=Rs(I,x,19)^Qo(I,x,61)^xh(I,x,6),Q=Bs(I,x,19)^Jo(I,x,61)^Ah(I,x,6),M=OA(D,Q,_n[v-7],_n[v-16]),A=$A(M,P,B,wn[v-7],wn[v-16]);wn[v]=A|0,_n[v]=M|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:l,Cl:c,Dh:d,Dl:f,Eh:a,El:u,Fh:h,Fl:p,Gh:y,Gl:g,Hh:m,Hl:w}=this;for(let v=0;v<80;v++){const _=Rs(a,u,14)^Rs(a,u,18)^Qo(a,u,41),k=Bs(a,u,14)^Bs(a,u,18)^Jo(a,u,41),P=a&h^~a&y,D=u&p^~u&g,I=FA(w,k,D,zA[v],_n[v]),x=UA(I,m,_,P,HA[v],wn[v]),B=I|0,Q=Rs(n,s,28)^Qo(n,s,34)^Qo(n,s,39),M=Bs(n,s,28)^Jo(n,s,34)^Jo(n,s,39),A=n&i^n&l^i&l,E=s&o^s&c^o&c;m=y|0,w=g|0,y=h|0,g=p|0,h=a|0,p=u|0,{h:a,l:u}=Kr(d|0,f|0,x|0,B|0),d=l|0,f=c|0,l=i|0,c=o|0,i=n|0,o=s|0;const S=NA(B,M,E);n=MA(S,x,Q,A),s=S|0}({h:n,l:s}=Kr(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=Kr(this.Bh|0,this.Bl|0,i|0,o|0),{h:l,l:c}=Kr(this.Ch|0,this.Cl|0,l|0,c|0),{h:d,l:f}=Kr(this.Dh|0,this.Dl|0,d|0,f|0),{h:a,l:u}=Kr(this.Eh|0,this.El|0,a|0,u|0),{h,l:p}=Kr(this.Fh|0,this.Fl|0,h|0,p|0),{h:y,l:g}=Kr(this.Gh|0,this.Gl|0,y|0,g|0),{h:m,l:w}=Kr(this.Hh|0,this.Hl|0,m|0,w|0),this.set(n,s,i,o,l,c,d,f,a,u,h,p,y,g,m,w)}roundClean(){ln(wn,_n)}destroy(){ln(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class GA extends WA{Ah=Et[0]|0;Al=Et[1]|0;Bh=Et[2]|0;Bl=Et[3]|0;Ch=Et[4]|0;Cl=Et[5]|0;Dh=Et[6]|0;Dl=Et[7]|0;Eh=Et[8]|0;El=Et[9]|0;Fh=Et[10]|0;Fl=Et[11]|0;Gh=Et[12]|0;Gl=Et[13]|0;Hh=Et[14]|0;Hl=Et[15]|0;constructor(){super(64)}}const Uo=vd(()=>new qA,Qm(1)),Ul=vd(()=>new GA,Qm(3));const _d=BigInt(0),vu=BigInt(1);function vs(r,e=""){if(typeof r!="boolean"){const t=e&&`"${e}" `;throw new Error(t+"expected boolean, got type="+typeof r)}return r}function ry(r){if(typeof r=="bigint"){if(!va(r))throw new Error("positive bigint expected, got "+r)}else Rr(r);return r}function ea(r){const e=ry(r).toString(16);return e.length&1?"0"+e:e}function ny(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?_d:BigInt("0x"+r)}function Vl(r){return ny(Fo(r))}function ho(r){return ny(Fo(wu(ve(r)).reverse()))}function Sd(r,e){Rr(e),r=ry(r);const t=fo(r.toString(16).padStart(e*2,"0"));if(t.length!==e)throw new Error("number too large");return t}function sy(r,e){return Sd(r,e).reverse()}function wu(r){return Uint8Array.from(r)}const va=r=>typeof r=="bigint"&&_d<=r;function YA(r,e,t){return va(r)&&va(e)&&va(t)&&e<=r&&r<t}function _u(r,e,t,n){if(!YA(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function XA(r){let e;for(e=0;r>_d;r>>=vu,e+=1);return e}const Ed=r=>(vu<<BigInt(r))-vu;function ZA(r,e,t){if(Rr(r,"hashLen"),Rr(e,"qByteLen"),typeof t!="function")throw new Error("hmacFn must be a function");const n=g=>new Uint8Array(g),s=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1),l=1e3;let c=n(r),d=n(r),f=0;const a=()=>{c.fill(1),d.fill(0),f=0},u=(...g)=>t(d,Dr(c,...g)),h=(g=s)=>{d=u(i,g),c=u(),g.length!==0&&(d=u(o,g),c=u())},p=()=>{if(f++>=l)throw new Error("drbg: tried max amount of iterations");let g=0;const m=[];for(;g<e;){c=u();const w=c.slice();m.push(w),g+=c.length}return Dr(...m)};return(g,m)=>{a(),h(g);let w;for(;!(w=m(p()));)h();return a(),w}}function Vo(r,e={},t={}){if(!r||typeof r!="object")throw new Error("expected valid options object");function n(i,o,l){const c=r[i];if(l&&c===void 0)return;const d=typeof c;if(d!==o||c===null)throw new Error(`param "${i}" is invalid: expected ${o}, got ${d}`)}const s=(i,o)=>Object.entries(i).forEach(([l,c])=>n(l,c,o));s(e,!1),s(t,!0)}function qa(r){const e=new WeakMap;return(t,...n)=>{const s=e.get(t);if(s!==void 0)return s;const i=r(t,...n);return e.set(t,i),i}}const zt=BigInt(0),wt=BigInt(1),es=BigInt(2),iy=BigInt(3),oy=BigInt(4),ay=BigInt(5),jA=BigInt(7),ly=BigInt(8),QA=BigInt(9),cy=BigInt(16);function Je(r,e){const t=r%e;return t>=zt?t:e+t}function Ge(r,e,t){let n=r;for(;e-- >zt;)n*=n,n%=t;return n}function Ih(r,e){if(r===zt)throw new Error("invert: expected non-zero number");if(e<=zt)throw new Error("invert: expected positive modulus, got "+e);let t=Je(r,e),n=e,s=zt,i=wt;for(;t!==zt;){const l=n/t,c=n%t,d=s-i*l;n=t,t=c,s=i,i=d}if(n!==wt)throw new Error("invert: does not exist");return Je(s,e)}function xd(r,e,t){if(!r.eql(r.sqr(e),t))throw new Error("Cannot find square root")}function uy(r,e){const t=(r.ORDER+wt)/oy,n=r.pow(e,t);return xd(r,n,e),n}function JA(r,e){const t=(r.ORDER-ay)/ly,n=r.mul(e,es),s=r.pow(n,t),i=r.mul(e,s),o=r.mul(r.mul(i,es),s),l=r.mul(i,r.sub(o,r.ONE));return xd(r,l,e),l}function e2(r){const e=Kl(r),t=dy(r),n=t(e,e.neg(e.ONE)),s=t(e,n),i=t(e,e.neg(n)),o=(r+jA)/cy;return(l,c)=>{let d=l.pow(c,o),f=l.mul(d,n);const a=l.mul(d,s),u=l.mul(d,i),h=l.eql(l.sqr(f),c),p=l.eql(l.sqr(a),c);d=l.cmov(d,f,h),f=l.cmov(u,a,p);const y=l.eql(l.sqr(f),c),g=l.cmov(d,f,y);return xd(l,g,c),g}}function dy(r){if(r<iy)throw new Error("sqrt is not defined for small field");let e=r-wt,t=0;for(;e%es===zt;)e/=es,t++;let n=es;const s=Kl(r);for(;kh(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return uy;let i=s.pow(n,e);const o=(e+wt)/es;return function(c,d){if(c.is0(d))return d;if(kh(c,d)!==1)throw new Error("Cannot find square root");let f=t,a=c.mul(c.ONE,i),u=c.pow(d,e),h=c.pow(d,o);for(;!c.eql(u,c.ONE);){if(c.is0(u))return c.ZERO;let p=1,y=c.sqr(u);for(;!c.eql(y,c.ONE);)if(p++,y=c.sqr(y),p===f)throw new Error("Cannot find square root");const g=wt<<BigInt(f-p-1),m=c.pow(a,g);f=p,a=c.sqr(m),u=c.mul(u,a),h=c.mul(h,m)}return h}}function t2(r){return r%oy===iy?uy:r%ly===ay?JA:r%cy===QA?e2(r):dy(r)}const r2=(r,e)=>(Je(r,e)&wt)===wt,n2=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function s2(r){const e={ORDER:"bigint",BYTES:"number",BITS:"number"},t=n2.reduce((n,s)=>(n[s]="function",n),e);return Vo(r,t),r}function i2(r,e,t){if(t<zt)throw new Error("invalid exponent, negatives unsupported");if(t===zt)return r.ONE;if(t===wt)return e;let n=r.ONE,s=e;for(;t>zt;)t&wt&&(n=r.mul(n,s)),s=r.sqr(s),t>>=wt;return n}function fy(r,e,t=!1){const n=new Array(e.length).fill(t?r.ZERO:void 0),s=e.reduce((o,l,c)=>r.is0(l)?o:(n[c]=o,r.mul(o,l)),r.ONE),i=r.inv(s);return e.reduceRight((o,l,c)=>r.is0(l)?o:(n[c]=r.mul(o,n[c]),r.mul(o,l)),i),n}function kh(r,e){const t=(r.ORDER-wt)/es,n=r.pow(e,t),s=r.eql(n,r.ONE),i=r.eql(n,r.ZERO),o=r.eql(n,r.neg(r.ONE));if(!s&&!i&&!o)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function o2(r,e){e!==void 0&&Rr(e);const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}class a2{ORDER;BITS;BYTES;isLE;ZERO=zt;ONE=wt;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=zt)throw new Error("invalid field: expected ORDER > 0, got "+e);let n;this.isLE=!1,t!=null&&typeof t=="object"&&(typeof t.BITS=="number"&&(n=t.BITS),typeof t.sqrt=="function"&&(this.sqrt=t.sqrt),typeof t.isLE=="boolean"&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),typeof t.modFromBytes=="boolean"&&(this._mod=t.modFromBytes));const{nBitLength:s,nByteLength:i}=o2(e,n);if(i>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=s,this.BYTES=i,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return Je(e,this.ORDER)}isValid(e){if(typeof e!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof e);return zt<=e&&e<this.ORDER}is0(e){return e===zt}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&wt)===wt}neg(e){return Je(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return Je(e*e,this.ORDER)}add(e,t){return Je(e+t,this.ORDER)}sub(e,t){return Je(e-t,this.ORDER)}mul(e,t){return Je(e*t,this.ORDER)}pow(e,t){return i2(this,e,t)}div(e,t){return Je(e*Ih(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return Ih(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=t2(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?sy(e,this.BYTES):Sd(e,this.BYTES)}fromBytes(e,t=!1){ve(e);const{_lengths:n,BYTES:s,isLE:i,ORDER:o,_mod:l}=this;if(n){if(!n.includes(e.length)||e.length>s)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+e.length);const d=new Uint8Array(s);d.set(e,i?0:d.length-e.length),e=d}if(e.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);let c=i?ho(e):Vl(e);if(l&&(c=Je(c,o)),!t&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(e){return fy(this,e)}cmov(e,t,n){return n?t:e}}function Kl(r,e={}){return new a2(r,e)}function hy(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function py(r){const e=hy(r);return e+Math.ceil(e/2)}function l2(r,e,t=!1){ve(r);const n=r.length,s=hy(e),i=py(e);if(n<16||n<i||n>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+n);const o=t?ho(r):Vl(r),l=Je(o,e-wt)+wt;return t?sy(l,s):Sd(l,s)}const ai=BigInt(0),ts=BigInt(1);function Ha(r,e){const t=e.negate();return r?t:e}function Zi(r,e){const t=fy(r.Fp,e.map(n=>n.Z));return e.map((n,s)=>r.fromAffine(n.toAffine(t[s])))}function gy(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function cc(r,e){gy(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),s=2**r,i=Ed(r),o=BigInt(r);return{windows:t,windowSize:n,mask:i,maxNumber:s,shiftBy:o}}function Ch(r,e,t){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=t;let l=Number(r&s),c=r>>o;l>n&&(l-=i,c+=ts);const d=e*n,f=d+Math.abs(l)-1,a=l===0,u=l<0,h=e%2!==0;return{nextN:c,offset:f,isZero:a,isNeg:u,isNegF:h,offsetF:d}}const uc=new WeakMap,my=new WeakMap;function dc(r){return my.get(r)||1}function Th(r){if(r!==ai)throw new Error("invalid wNAF")}class yy{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,n=this.ZERO){let s=e;for(;t>ai;)t&ts&&(n=n.add(s)),s=s.double(),t>>=ts;return n}precomputeWindow(e,t){const{windows:n,windowSize:s}=cc(t,this.bits),i=[];let o=e,l=o;for(let c=0;c<n;c++){l=o,i.push(l);for(let d=1;d<s;d++)l=l.add(o),i.push(l);o=l.double()}return i}wNAF(e,t,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const o=cc(e,this.bits);for(let l=0;l<o.windows;l++){const{nextN:c,offset:d,isZero:f,isNeg:a,isNegF:u,offsetF:h}=Ch(n,l,o);n=c,f?i=i.add(Ha(u,t[h])):s=s.add(Ha(a,t[d]))}return Th(n),{p:s,f:i}}wNAFUnsafe(e,t,n,s=this.ZERO){const i=cc(e,this.bits);for(let o=0;o<i.windows&&n!==ai;o++){const{nextN:l,offset:c,isZero:d,isNeg:f}=Ch(n,o,i);if(n=l,!d){const a=t[c];s=s.add(f?a.negate():a)}}return Th(n),s}getPrecomputes(e,t,n){let s=uc.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof n=="function"&&(s=n(s)),uc.set(t,s))),s}cached(e,t,n){const s=dc(e);return this.wNAF(s,this.getPrecomputes(s,e,n),t)}unsafe(e,t,n,s){const i=dc(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,n),t,s)}createCache(e,t){gy(t,this.bits),my.set(e,t),uc.delete(e)}hasCache(e){return dc(e)!==1}}function c2(r,e,t,n){let s=e,i=r.ZERO,o=r.ZERO;for(;t>ai||n>ai;)t&ts&&(i=i.add(s)),n&ts&&(o=o.add(s)),s=s.double(),t>>=ts,n>>=ts;return{p1:i,p2:o}}function Ph(r,e,t){if(e){if(e.ORDER!==r)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return s2(e),e}else return Kl(r,{isLE:t})}function by(r,e,t={},n){if(n===void 0&&(n=r==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${r} CURVE object`);for(const c of["p","n","h"]){const d=e[c];if(!(typeof d=="bigint"&&d>ai))throw new Error(`CURVE.${c} must be positive bigint`)}const s=Ph(e.p,t.Fp,n),i=Ph(e.n,t.Fn,n),l=["Gx","Gy","a",r==="weierstrass"?"b":"d"];for(const c of l)if(!s.isValid(e[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}function vy(r,e){return function(n){const s=r(n);return{secretKey:s,publicKey:e(s)}}}const Sn=BigInt(0),lt=BigInt(1),fc=BigInt(2),u2=BigInt(8);function d2(r,e,t,n){const s=r.sqr(t),i=r.sqr(n),o=r.add(r.mul(e.a,s),i),l=r.add(r.ONE,r.mul(e.d,r.mul(s,i)));return r.eql(o,l)}function f2(r,e={}){const t=by("edwards",r,e,e.FpFnLE),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o}=i;Vo(e,{},{uvRatio:"function"});const l=fc<<BigInt(s.BYTES*8)-lt,c=g=>n.create(g),d=e.uvRatio||((g,m)=>{try{return{isValid:!0,value:n.sqrt(n.div(g,m))}}catch{return{isValid:!1,value:Sn}}});if(!d2(n,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function f(g,m,w=!1){const v=w?lt:Sn;return _u("coordinate "+g,m,v,l),m}function a(g){if(!(g instanceof p))throw new Error("EdwardsPoint expected")}const u=qa((g,m)=>{const{X:w,Y:v,Z:_}=g,k=g.is0();m==null&&(m=k?u2:n.inv(_));const P=c(w*m),D=c(v*m),I=n.mul(_,m);if(k)return{x:Sn,y:lt};if(I!==lt)throw new Error("invZ was invalid");return{x:P,y:D}}),h=qa(g=>{const{a:m,d:w}=i;if(g.is0())throw new Error("bad point: ZERO");const{X:v,Y:_,Z:k,T:P}=g,D=c(v*v),I=c(_*_),x=c(k*k),B=c(x*x),Q=c(D*m),M=c(x*c(Q+I)),A=c(B+c(w*c(D*I)));if(M!==A)throw new Error("bad point: equation left != right (1)");const E=c(v*_),S=c(k*P);if(E!==S)throw new Error("bad point: equation left != right (2)");return!0});class p{static BASE=new p(i.Gx,i.Gy,lt,c(i.Gx*i.Gy));static ZERO=new p(Sn,lt,lt,Sn);static Fp=n;static Fn=s;X;Y;Z;T;constructor(m,w,v,_){this.X=f("x",m),this.Y=f("y",w),this.Z=f("z",v,!0),this.T=f("t",_),Object.freeze(this)}static CURVE(){return i}static fromAffine(m){if(m instanceof p)throw new Error("extended point not allowed");const{x:w,y:v}=m||{};return f("x",w),f("y",v),new p(w,v,lt,c(w*v))}static fromBytes(m,w=!1){const v=n.BYTES,{a:_,d:k}=i;m=wu(ve(m,v,"point")),vs(w,"zip215");const P=wu(m),D=m[v-1];P[v-1]=D&-129;const I=ho(P),x=w?l:n.ORDER;_u("point.y",I,Sn,x);const B=c(I*I),Q=c(B-lt),M=c(k*B-_);let{isValid:A,value:E}=d(Q,M);if(!A)throw new Error("bad point: invalid y coordinate");const S=(E&lt)===lt,T=(D&128)!==0;if(!w&&E===Sn&&T)throw new Error("bad point: x=0 and x_0=1");return T!==S&&(E=c(-E)),p.fromAffine({x:E,y:I})}static fromHex(m,w=!1){return p.fromBytes(fo(m),w)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(m=8,w=!0){return y.createCache(this,m),w||this.multiply(fc),this}assertValidity(){h(this)}equals(m){a(m);const{X:w,Y:v,Z:_}=this,{X:k,Y:P,Z:D}=m,I=c(w*D),x=c(k*_),B=c(v*D),Q=c(P*_);return I===x&&B===Q}is0(){return this.equals(p.ZERO)}negate(){return new p(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:m}=i,{X:w,Y:v,Z:_}=this,k=c(w*w),P=c(v*v),D=c(fc*c(_*_)),I=c(m*k),x=w+v,B=c(c(x*x)-k-P),Q=I+P,M=Q-D,A=I-P,E=c(B*M),S=c(Q*A),T=c(B*A),C=c(M*Q);return new p(E,S,C,T)}add(m){a(m);const{a:w,d:v}=i,{X:_,Y:k,Z:P,T:D}=this,{X:I,Y:x,Z:B,T:Q}=m,M=c(_*I),A=c(k*x),E=c(D*v*Q),S=c(P*B),T=c((_+k)*(I+x)-M-A),C=S-E,L=S+E,R=c(A-w*M),N=c(T*C),$=c(L*R),q=c(T*R),F=c(C*L);return new p(N,$,F,q)}subtract(m){return this.add(m.negate())}multiply(m){if(!s.isValidNot0(m))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:w,f:v}=y.cached(this,m,_=>Zi(p,_));return Zi(p,[w,v])[0]}multiplyUnsafe(m,w=p.ZERO){if(!s.isValid(m))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return m===Sn?p.ZERO:this.is0()||m===lt?this:y.unsafe(this,m,v=>Zi(p,v),w)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return y.unsafe(this,i.n).is0()}toAffine(m){return u(this,m)}clearCofactor(){return o===lt?this:this.multiplyUnsafe(o)}toBytes(){const{x:m,y:w}=this.toAffine(),v=n.toBytes(w);return v[v.length-1]|=m&lt?128:0,v}toHex(){return Fo(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const y=new yy(p,s.BITS);return p.BASE.precompute(8),p}function h2(r,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');Vo(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=t,{BASE:s,Fp:i,Fn:o}=r,l=t.randomBytes||Fl,c=t.adjustScalarBytes||(I=>I),d=t.domain||((I,x,B)=>{if(vs(B,"phflag"),x.length||B)throw new Error("Contexts/pre-hash are not supported");return I});function f(I){return o.create(ho(I))}function a(I){const x=v.secretKey;ve(I,v.secretKey,"secretKey");const B=ve(e(I),2*x,"hashedSecretKey"),Q=c(B.slice(0,x)),M=B.slice(x,2*x),A=f(Q);return{head:Q,prefix:M,scalar:A}}function u(I){const{head:x,prefix:B,scalar:Q}=a(I),M=s.multiply(Q),A=M.toBytes();return{head:x,prefix:B,scalar:Q,point:M,pointBytes:A}}function h(I){return u(I).pointBytes}function p(I=Uint8Array.of(),...x){const B=Dr(...x);return f(e(d(B,ve(I,void 0,"context"),!!n)))}function y(I,x,B={}){I=ve(I,void 0,"message"),n&&(I=n(I));const{prefix:Q,scalar:M,pointBytes:A}=u(x),E=p(B.context,Q,I),S=s.multiply(E).toBytes(),T=p(B.context,S,A,I),C=o.create(E+T*M);if(!o.isValid(C))throw new Error("sign failed: invalid s");const L=Dr(S,o.toBytes(C));return ve(L,v.signature,"result")}const g={zip215:!0};function m(I,x,B,Q=g){const{context:M,zip215:A}=Q,E=v.signature;I=ve(I,E,"signature"),x=ve(x,void 0,"message"),B=ve(B,v.publicKey,"publicKey"),A!==void 0&&vs(A,"zip215"),n&&(x=n(x));const S=E/2,T=I.subarray(0,S),C=ho(I.subarray(S,E));let L,R,N;try{L=r.fromBytes(B,A),R=r.fromBytes(T,A),N=s.multiplyUnsafe(C)}catch{return!1}if(!A&&L.isSmallOrder())return!1;const $=p(M,R.toBytes(),L.toBytes(),x);return R.add(L.multiplyUnsafe($)).subtract(N).clearCofactor().is0()}const w=i.BYTES,v={secretKey:w,publicKey:w,signature:2*w,seed:w};function _(I=l(v.seed)){return ve(I,v.seed,"seed")}function k(I){return $l(I)&&I.length===o.BYTES}function P(I,x){try{return!!r.fromBytes(I,x)}catch{return!1}}const D={getExtendedPublicKey:u,randomSecretKey:_,isValidSecretKey:k,isValidPublicKey:P,toMontgomery(I){const{y:x}=r.fromBytes(I),B=v.publicKey,Q=B===32;if(!Q&&B!==57)throw new Error("only defined for 25519 and 448");const M=Q?i.div(lt+x,lt-x):i.div(x-lt,x+lt);return i.toBytes(M)},toMontgomerySecret(I){const x=v.secretKey;ve(I,x);const B=e(I.subarray(0,x));return c(B).subarray(0,x)}};return Object.freeze({keygen:vy(_,h),getPublicKey:h,sign:y,verify:m,utils:D,Point:r,lengths:v})}const p2=BigInt(1),Dh=BigInt(2),g2=BigInt(5),m2=BigInt(8),Ad=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),y2={p:Ad,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:m2,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function b2(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),s=BigInt(80),i=Ad,l=r*r%i*r%i,c=Ge(l,Dh,i)*l%i,d=Ge(c,p2,i)*r%i,f=Ge(d,g2,i)*d%i,a=Ge(f,e,i)*f%i,u=Ge(a,t,i)*a%i,h=Ge(u,n,i)*u%i,p=Ge(h,s,i)*h%i,y=Ge(p,s,i)*h%i,g=Ge(y,e,i)*f%i;return{pow_p_5_8:Ge(g,Dh,i)*r%i,b2:l}}function v2(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}const Lh=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function w2(r,e){const t=Ad,n=Je(e*e*e,t),s=Je(n*n*e,t),i=b2(r*s).pow_p_5_8;let o=Je(r*n*i,t);const l=Je(e*o*o,t),c=o,d=Je(o*Lh,t),f=l===r,a=l===Je(-r,t),u=l===Je(-r*Lh,t);return f&&(o=c),(a||u)&&(o=d),r2(o,t)&&(o=Je(-o,t)),{isValid:f||a,value:o}}const _2=f2(y2,{uvRatio:w2});function S2(r){return h2(_2,Ul,Object.assign({adjustScalarBytes:v2},r))}const za=S2({}),po=32,Tr=64,Su=32;let Ys;const wy=(async()=>{try{return await Ot.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function E2(){const r=za.utils.randomSecretKey(),e=za.getPublicKey(r);return{privateKey:P2(r,e),publicKey:e}}async function x2(r,e){let t;r.length===Tr?t=r.subarray(0,32):t=r;const n={crv:"Ed25519",kty:"OKP",x:W(r.subarray(32),"base64url"),d:W(t,"base64url"),ext:!0,key_ops:["sign"]},s=await Ot.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await Ot.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function A2(r,e){const t=r.subarray(0,Su);return za.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function I2(r,e){return Ys==null&&(Ys=await wy),Ys?x2(r,e):A2(r,e)}async function k2(r,e,t){if(r.buffer instanceof ArrayBuffer){const n=await Ot.get().subtle.importKey("raw",r.buffer,{name:"Ed25519"},!1,["verify"]);return await Ot.get().subtle.verify({name:"Ed25519"},n,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function C2(r,e,t){return za.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}async function T2(r,e,t){return Ys==null&&(Ys=await wy),Ys?k2(r,e,t):C2(r,e,t)}function P2(r,e){const t=new Uint8Array(Tr);for(let n=0;n<Su;n++)t[n]=r[n],t[Su+n]=e[n];return t}function ql(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class _y{type="Ed25519";raw;constructor(e){this.raw=go(e,po)}toMultihash(){return it.digest(Sr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){n?.signal?.throwIfAborted();const s=T2(this.raw,t,e);return ql(s)?s.then(i=>(n?.signal?.throwIfAborted(),i)):s}}class Eu{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=go(e,Tr),this.publicKey=new _y(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const n=I2(this.raw,e);return ql(n)?n.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),n)}}function Sy(r){if(r.length>Tr){r=go(r,Tr+po);const n=r.subarray(0,Tr),s=r.subarray(Tr,r.length);return new Eu(n,s)}r=go(r,Tr);const e=r.subarray(0,Tr),t=r.subarray(po);return new Eu(e,t)}function Id(r){return r=go(r,po),new _y(r)}async function D2(){const{privateKey:r,publicKey:e}=E2();return new Eu(r,e)}function go(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new V(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const L2=Math.pow(2,7),R2=Math.pow(2,14),B2=Math.pow(2,21),kd=Math.pow(2,28),Cd=Math.pow(2,35),Td=Math.pow(2,42),Pd=Math.pow(2,49),Ee=128,At=127;function Ar(r){if(r<L2)return 1;if(r<R2)return 2;if(r<B2)return 3;if(r<kd)return 4;if(r<Cd)return 5;if(r<Td)return 6;if(r<Pd)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Wa(r,e,t=0){switch(Ar(r)){case 8:e[t++]=r&255|Ee,r/=128;case 7:e[t++]=r&255|Ee,r/=128;case 6:e[t++]=r&255|Ee,r/=128;case 5:e[t++]=r&255|Ee,r/=128;case 4:e[t++]=r&255|Ee,r>>>=7;case 3:e[t++]=r&255|Ee,r>>>=7;case 2:e[t++]=r&255|Ee,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function N2(r,e,t=0){switch(Ar(r)){case 8:e.set(t++,r&255|Ee),r/=128;case 7:e.set(t++,r&255|Ee),r/=128;case 6:e.set(t++,r&255|Ee),r/=128;case 5:e.set(t++,r&255|Ee),r/=128;case 4:e.set(t++,r&255|Ee),r>>>=7;case 3:e.set(t++,r&255|Ee),r>>>=7;case 2:e.set(t++,r&255|Ee),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Ey(r,e){let t=r[e],n=0;if(n+=t&At,t<Ee||(t=r[e+1],n+=(t&At)<<7,t<Ee)||(t=r[e+2],n+=(t&At)<<14,t<Ee)||(t=r[e+3],n+=(t&At)<<21,t<Ee)||(t=r[e+4],n+=(t&At)*kd,t<Ee)||(t=r[e+5],n+=(t&At)*Cd,t<Ee)||(t=r[e+6],n+=(t&At)*Td,t<Ee)||(t=r[e+7],n+=(t&At)*Pd,t<Ee))return n;throw new RangeError("Could not decode varint")}function M2(r,e){let t=r.get(e),n=0;if(n+=t&At,t<Ee||(t=r.get(e+1),n+=(t&At)<<7,t<Ee)||(t=r.get(e+2),n+=(t&At)<<14,t<Ee)||(t=r.get(e+3),n+=(t&At)<<21,t<Ee)||(t=r.get(e+4),n+=(t&At)*kd,t<Ee)||(t=r.get(e+5),n+=(t&At)*Cd,t<Ee)||(t=r.get(e+6),n+=(t&At)*Td,t<Ee)||(t=r.get(e+7),n+=(t&At)*Pd,t<Ee))return n;throw new RangeError("Could not decode varint")}function ji(r,e,t=0){return e==null&&(e=on(Ar(r))),e instanceof Uint8Array?Wa(r,e,t):N2(r,e,t)}function Dd(r,e=0){return r instanceof Uint8Array?Ey(r,e):M2(r,e)}const Ld=new Float32Array([-0]),In=new Uint8Array(Ld.buffer);function O2(r,e,t){Ld[0]=r,e[t]=In[0],e[t+1]=In[1],e[t+2]=In[2],e[t+3]=In[3]}function $2(r,e){return In[0]=r[e],In[1]=r[e+1],In[2]=r[e+2],In[3]=r[e+3],Ld[0]}const Rd=new Float64Array([-0]),It=new Uint8Array(Rd.buffer);function F2(r,e,t){Rd[0]=r,e[t]=It[0],e[t+1]=It[1],e[t+2]=It[2],e[t+3]=It[3],e[t+4]=It[4],e[t+5]=It[5],e[t+6]=It[6],e[t+7]=It[7]}function U2(r,e){return It[0]=r[e],It[1]=r[e+1],It[2]=r[e+2],It[3]=r[e+3],It[4]=r[e+4],It[5]=r[e+5],It[6]=r[e+6],It[7]=r[e+7],Rd[0]}const V2=BigInt(Number.MAX_SAFE_INTEGER),K2=BigInt(Number.MIN_SAFE_INTEGER);class kt{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return ds;if(e<V2&&e>K2)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,s=e-(n<<32n);return t&&(n=~n|0n,s=~s|0n,++s>Rh&&(s=0n,++n>Rh&&(n=0n))),new kt(Number(s),Number(n))}static fromNumber(e){if(e===0)return ds;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new kt(n,s)}static from(e){return typeof e=="number"?kt.fromNumber(e):typeof e=="bigint"?kt.fromBigInt(e):typeof e=="string"?kt.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new kt(e.low>>>0,e.high>>>0):ds}}const ds=new kt(0,0);ds.toBigInt=function(){return 0n};ds.zzEncode=ds.zzDecode=function(){return this};ds.length=function(){return 1};const Rh=4294967296n;function q2(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function H2(r,e,t){if(t-e<1)return"";let s;const i=[];let o=0,l;for(;e<t;)l=r[e++],l<128?i[o++]=l:l>191&&l<224?i[o++]=(l&31)<<6|r[e++]&63:l>239&&l<365?(l=((l&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,i[o++]=55296+(l>>10),i[o++]=56320+(l&1023)):i[o++]=(l&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function xy(r,e,t){const n=t;let s,i;for(let o=0;o<r.length;++o)s=r.charCodeAt(o),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=r.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-n}function mr(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function ta(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class z2{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,mr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw mr(this,4);return ta(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw mr(this,4);return ta(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw mr(this,4);const e=$2(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw mr(this,4);const e=U2(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw mr(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return H2(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw mr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw mr(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new kt(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw mr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw mr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw mr(this,8);const e=ta(this.buf,this.pos+=4),t=ta(this.buf,this.pos+=4);return new kt(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=Ey(this.buf,this.pos);return this.pos+=Ar(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function W2(r){return new z2(r instanceof Uint8Array?r:r.subarray())}function Ie(r,e,t){const n=W2(r);return e.decode(n,void 0,t)}function G2(r){let n,s=8192;return function(o){if(o<1||o>4096)return on(o);s+o>8192&&(n=on(8192),s=0);const l=n.subarray(s,s+=o);return(s&7)!==0&&(s=(s|7)+1),l}}class qi{fn;len;next;val;constructor(e,t,n){this.fn=e,this.len=t,this.next=void 0,this.val=n}}function hc(){}class Y2{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const X2=G2();function Z2(r){return globalThis.Buffer!=null?on(r):X2(r)}class xu{len;head;tail;states;constructor(){this.len=0,this.head=new qi(hc,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new qi(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Q2((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(ra,10,kt.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=kt.fromBigInt(e);return this._push(ra,t.length(),t)}uint64Number(e){return this._push(Wa,Ar(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=kt.fromBigInt(e).zzEncode();return this._push(ra,t.length(),t)}sint64Number(e){const t=kt.fromNumber(e).zzEncode();return this._push(ra,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(pc,1,e?1:0)}fixed32(e){return this._push(Ri,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=kt.fromBigInt(e);return this._push(Ri,4,t.lo)._push(Ri,4,t.hi)}fixed64Number(e){const t=kt.fromNumber(e);return this._push(Ri,4,t.lo)._push(Ri,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(O2,4,e)}double(e){return this._push(F2,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(pc,1,0):this.uint32(t)._push(J2,t,e)}string(e){const t=q2(e);return t!==0?this.uint32(t)._push(xy,t,e):this._push(pc,1,0)}fork(){return this.states=new Y2(this),this.head=this.tail=new qi(hc,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new qi(hc,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=Z2(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function pc(r,e,t){e[t]=r&255}function j2(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class Q2 extends qi{next;constructor(e,t){super(j2,e,t),this.next=void 0}}function ra(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function Ri(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function J2(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(xu.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(eI,e,r),this},xu.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(tI,e,r),this});function eI(r,e,t){e.set(r,t)}function tI(r,e,t){r.length<40?xy(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(j(r),t)}function rI(){return new xu}function ke(r,e){const t=rI();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Ga;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Ga||(Ga={}));function Ay(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function Ko(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const l=e(i);o.int32(l)},n=function(i){const o=i.int32();return e(o)};return Ay("enum",Ga.VARINT,t,n)}function Ce(r,e){return Ay("message",Ga.LENGTH_DELIMITED,r,e)}class vt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class Bh extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var ze;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(ze||(ze={}));var Au;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Au||(Au={}));(function(r){r.codec=()=>Ko(Au)})(ze||(ze={}));var Fn;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ze.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=ze.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Fn||(Fn={}));var Ya;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ze.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=ze.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Ya||(Ya={}));function li(r){if(isNaN(r)||r<=0)throw new V("random bytes length must be a Number bigger than 0");return Fl(r)}class Bd{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=Md(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return ue.createV1(114,this._multihash)}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return mI(this.jwk,t,e,n)}}class Iy{type="RSA";jwk;_raw;publicKey;constructor(e,t){this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=oI(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return gI(this.jwk,e,t)}}const ky=8192,Nd=18,nI=1062,sI=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function iI(r){return{n:W(r[1],"base64url"),e:W(r[2],"base64url"),d:W(r[3],"base64url"),p:W(r[4],"base64url"),q:W(r[5],"base64url"),dp:W(r[6],"base64url"),dq:W(r[7],"base64url"),qi:W(r[8],"base64url"),kty:"RSA"}}function oI(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new V("JWK was missing components");return rn([Xt(Uint8Array.from([0])),Xt(j(r.n,"base64url")),Xt(j(r.e,"base64url")),Xt(j(r.d,"base64url")),Xt(j(r.p,"base64url")),Xt(j(r.q,"base64url")),Xt(j(r.dp,"base64url")),Xt(j(r.dq,"base64url")),Xt(j(r.qi,"base64url"))]).subarray()}function aI(r){const e=Hn(r[1],{offset:0});return{kty:"RSA",n:W(e[0],"base64url"),e:W(e[1],"base64url")}}function Md(r){if(r.n==null||r.e==null)throw new V("JWK was missing components");return rn([sI,yd(rn([Xt(j(r.n,"base64url")),Xt(j(r.e,"base64url"))]))]).subarray()}function lI(r){const e=Hn(r);return Cy(e)}function Cy(r){const e=iI(r);return uI(e)}function cI(r,e){if(r.byteLength>=nI)throw new Rm("Key size is too large");const t=Hn(r,{offset:0});return Ty(t,r,e)}function Ty(r,e,t){const n=aI(r);if(t==null){const s=Uo(Fn.encode({Type:ze.RSA,Data:e}));t=Ei(Nd,s)}return new Bd(n,t)}function uI(r){if(bI(r)>ky)throw new V("Key size is too large");const e=fI(r),t=Uo(Fn.encode({Type:ze.RSA,Data:Md(e.publicKey)})),n=Ei(Nd,t);return new Iy(e.privateKey,new Bd(e.publicKey,n))}async function dI(r){if(r>ky)throw new V("Key size is too large");const e=await pI(r),t=Uo(Fn.encode({Type:ze.RSA,Data:Md(e.publicKey)})),n=Ei(Nd,t);return new Iy(e.privateKey,new Bd(e.publicKey,n))}function fI(r){if(r==null)throw new V("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const hI="1.2.840.113549.1.1.1";async function pI(r,e){const t=await Ot.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await yI(t);return{privateKey:n[0],publicKey:n[1]}}async function gI(r,e,t){const n=await Ot.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]);t?.signal?.throwIfAborted();const s=await Ot.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,e instanceof Uint8Array?e:e.subarray());return t?.signal?.throwIfAborted(),new Uint8Array(s,0,s.byteLength)}async function mI(r,e,t,n){const s=await Ot.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await Ot.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return n?.signal?.throwIfAborted(),i}async function yI(r,e){if(r.privateKey==null||r.publicKey==null)throw new V("Private and public key are required");return await Promise.all([Ot.get().subtle.exportKey("jwk",r.privateKey),Ot.get().subtle.exportKey("jwk",r.publicKey)])}function bI(r){if(r.kty!=="RSA")throw new V("invalid key type");if(r.n==null)throw new V("invalid key modulus");return j(r.n,"base64url").length*8}class Py{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(bd(e),ve(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(t.length>n?e.create().update(t).digest():t);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),ln(s)}update(e){return Ka(this),this.iHash.update(e),this}digestInto(e){Ka(this),ve(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:l}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=l,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Od=(r,e,t)=>new Py(r,e).update(t).digest();Od.create=(r,e)=>new Py(r,e);const Nh=(r,e)=>(r+(r>=0?e:-e)/Dy)/e;function vI(r,e,t){const[[n,s],[i,o]]=e,l=Nh(o*r,t),c=Nh(-s*r,t);let d=r-l*n-c*i,f=-l*s-c*o;const a=d<Jr,u=f<Jr;a&&(d=-d),u&&(f=-f);const h=Ed(Math.ceil(XA(t)/2))+Xs;if(d<Jr||d>=h||f<Jr||f>=h)throw new Error("splitScalar (endomorphism): failed, k="+r);return{k1neg:a,k1:d,k2neg:u,k2:f}}function Iu(r){if(!["compact","recovered","der"].includes(r))throw new Error('Signature format must be "compact", "recovered", or "der"');return r}function gc(r,e){const t={};for(let n of Object.keys(e))t[n]=r[n]===void 0?e[n]:r[n];return vs(t.lowS,"lowS"),vs(t.prehash,"prehash"),t.format!==void 0&&Iu(t.format),t}class wI extends Error{constructor(e=""){super(e)}}const An={Err:wI,_tlv:{encode:(r,e)=>{const{Err:t}=An;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,s=ea(n);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=n>127?ea(s.length/2|128):"";return ea(r)+i+s+e},decode(r,e){const{Err:t}=An;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const s=e[n++],i=!!(s&128);let o=0;if(!i)o=s;else{const c=s&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const d=e.subarray(n,n+c);if(d.length!==c)throw new t("tlv.decode: length bytes not complete");if(d[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const f of d)o=o<<8|f;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const l=e.subarray(n,n+o);if(l.length!==o)throw new t("tlv.decode: wrong value length");return{v:l,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=An;if(r<Jr)throw new e("integer: negative integers are not allowed");let t=ea(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=An;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Vl(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=An,s=ve(r,void 0,"signature"),{v:i,l:o}=n.decode(48,s);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:l,l:c}=n.decode(2,i),{v:d,l:f}=n.decode(2,c);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(l),s:t.decode(d)}},hexFromSig(r){const{_tlv:e,_int:t}=An,n=e.encode(2,t.encode(r.r)),s=e.encode(2,t.encode(r.s)),i=n+s;return e.encode(48,i)}},Jr=BigInt(0),Xs=BigInt(1),Dy=BigInt(2),na=BigInt(3),_I=BigInt(4);function SI(r,e={}){const t=by("weierstrass",r,e),{Fp:n,Fn:s}=t;let i=t.CURVE;const{h:o,n:l}=i;Vo(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=e;if(c&&(!n.is0(i.a)||typeof c.beta!="bigint"||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const d=Ry(n,s);function f(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function a(M,A,E){const{x:S,y:T}=A.toAffine(),C=n.toBytes(S);if(vs(E,"isCompressed"),E){f();const L=!n.isOdd(T);return Dr(Ly(L),C)}else return Dr(Uint8Array.of(4),C,n.toBytes(T))}function u(M){ve(M,void 0,"Point");const{publicKey:A,publicKeyUncompressed:E}=d,S=M.length,T=M[0],C=M.subarray(1);if(S===A&&(T===2||T===3)){const L=n.fromBytes(C);if(!n.isValid(L))throw new Error("bad point: is not on curve, wrong x");const R=y(L);let N;try{N=n.sqrt(R)}catch(F){const H=F instanceof Error?": "+F.message:"";throw new Error("bad point: is not on curve, sqrt error"+H)}f();const $=n.isOdd(N);return(T&1)===1!==$&&(N=n.neg(N)),{x:L,y:N}}else if(S===E&&T===4){const L=n.BYTES,R=n.fromBytes(C.subarray(0,L)),N=n.fromBytes(C.subarray(L,L*2));if(!g(R,N))throw new Error("bad point: is not on curve");return{x:R,y:N}}else throw new Error(`bad point: got length ${S}, expected compressed=${A} or uncompressed=${E}`)}const h=e.toBytes||a,p=e.fromBytes||u;function y(M){const A=n.sqr(M),E=n.mul(A,M);return n.add(n.add(E,n.mul(M,i.a)),i.b)}function g(M,A){const E=n.sqr(A),S=y(M);return n.eql(E,S)}if(!g(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const m=n.mul(n.pow(i.a,na),_I),w=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(m,w)))throw new Error("bad curve params: a or b");function v(M,A,E=!1){if(!n.isValid(A)||E&&n.is0(A))throw new Error(`bad point coordinate ${M}`);return A}function _(M){if(!(M instanceof x))throw new Error("Weierstrass Point expected")}function k(M){if(!c||!c.basises)throw new Error("no endo");return vI(M,c.basises,s.ORDER)}const P=qa((M,A)=>{const{X:E,Y:S,Z:T}=M;if(n.eql(T,n.ONE))return{x:E,y:S};const C=M.is0();A==null&&(A=C?n.ONE:n.inv(T));const L=n.mul(E,A),R=n.mul(S,A),N=n.mul(T,A);if(C)return{x:n.ZERO,y:n.ZERO};if(!n.eql(N,n.ONE))throw new Error("invZ was invalid");return{x:L,y:R}}),D=qa(M=>{if(M.is0()){if(e.allowInfinityPoint&&!n.is0(M.Y))return;throw new Error("bad point: ZERO")}const{x:A,y:E}=M.toAffine();if(!n.isValid(A)||!n.isValid(E))throw new Error("bad point: x or y not field elements");if(!g(A,E))throw new Error("bad point: equation left != right");if(!M.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function I(M,A,E,S,T){return E=new x(n.mul(E.X,M),E.Y,E.Z),A=Ha(S,A),E=Ha(T,E),A.add(E)}class x{static BASE=new x(i.Gx,i.Gy,n.ONE);static ZERO=new x(n.ZERO,n.ONE,n.ZERO);static Fp=n;static Fn=s;X;Y;Z;constructor(A,E,S){this.X=v("x",A),this.Y=v("y",E,!0),this.Z=v("z",S),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){const{x:E,y:S}=A||{};if(!A||!n.isValid(E)||!n.isValid(S))throw new Error("invalid affine point");if(A instanceof x)throw new Error("projective point not allowed");return n.is0(E)&&n.is0(S)?x.ZERO:new x(E,S,n.ONE)}static fromBytes(A){const E=x.fromAffine(p(ve(A,void 0,"point")));return E.assertValidity(),E}static fromHex(A){return x.fromBytes(fo(A))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,E=!0){return Q.createCache(this,A),E||this.multiply(na),this}assertValidity(){D(this)}hasEvenY(){const{y:A}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(A)}equals(A){_(A);const{X:E,Y:S,Z:T}=this,{X:C,Y:L,Z:R}=A,N=n.eql(n.mul(E,R),n.mul(C,T)),$=n.eql(n.mul(S,R),n.mul(L,T));return N&&$}negate(){return new x(this.X,n.neg(this.Y),this.Z)}double(){const{a:A,b:E}=i,S=n.mul(E,na),{X:T,Y:C,Z:L}=this;let R=n.ZERO,N=n.ZERO,$=n.ZERO,q=n.mul(T,T),F=n.mul(C,C),H=n.mul(L,L),G=n.mul(T,C);return G=n.add(G,G),$=n.mul(T,L),$=n.add($,$),R=n.mul(A,$),N=n.mul(S,H),N=n.add(R,N),R=n.sub(F,N),N=n.add(F,N),N=n.mul(R,N),R=n.mul(G,R),$=n.mul(S,$),H=n.mul(A,H),G=n.sub(q,H),G=n.mul(A,G),G=n.add(G,$),$=n.add(q,q),q=n.add($,q),q=n.add(q,H),q=n.mul(q,G),N=n.add(N,q),H=n.mul(C,L),H=n.add(H,H),q=n.mul(H,G),R=n.sub(R,q),$=n.mul(H,F),$=n.add($,$),$=n.add($,$),new x(R,N,$)}add(A){_(A);const{X:E,Y:S,Z:T}=this,{X:C,Y:L,Z:R}=A;let N=n.ZERO,$=n.ZERO,q=n.ZERO;const F=i.a,H=n.mul(i.b,na);let G=n.mul(E,C),re=n.mul(S,L),ne=n.mul(T,R),K=n.add(E,S),ee=n.add(C,L);K=n.mul(K,ee),ee=n.add(G,re),K=n.sub(K,ee),ee=n.add(E,T);let ge=n.add(C,R);return ee=n.mul(ee,ge),ge=n.add(G,ne),ee=n.sub(ee,ge),ge=n.add(S,T),N=n.add(L,R),ge=n.mul(ge,N),N=n.add(re,ne),ge=n.sub(ge,N),q=n.mul(F,ee),N=n.mul(H,ne),q=n.add(N,q),N=n.sub(re,q),q=n.add(re,q),$=n.mul(N,q),re=n.add(G,G),re=n.add(re,G),ne=n.mul(F,ne),ee=n.mul(H,ee),re=n.add(re,ne),ne=n.sub(G,ne),ne=n.mul(F,ne),ee=n.add(ee,ne),G=n.mul(re,ee),$=n.add($,G),G=n.mul(ge,ee),N=n.mul(K,N),N=n.sub(N,G),G=n.mul(K,re),q=n.mul(ge,q),q=n.add(q,G),new x(N,$,q)}subtract(A){return this.add(A.negate())}is0(){return this.equals(x.ZERO)}multiply(A){const{endo:E}=e;if(!s.isValidNot0(A))throw new Error("invalid scalar: out of range");let S,T;const C=L=>Q.cached(this,L,R=>Zi(x,R));if(E){const{k1neg:L,k1:R,k2neg:N,k2:$}=k(A),{p:q,f:F}=C(R),{p:H,f:G}=C($);T=F.add(G),S=I(E.beta,q,H,L,N)}else{const{p:L,f:R}=C(A);S=L,T=R}return Zi(x,[S,T])[0]}multiplyUnsafe(A){const{endo:E}=e,S=this;if(!s.isValid(A))throw new Error("invalid scalar: out of range");if(A===Jr||S.is0())return x.ZERO;if(A===Xs)return S;if(Q.hasCache(this))return this.multiply(A);if(E){const{k1neg:T,k1:C,k2neg:L,k2:R}=k(A),{p1:N,p2:$}=c2(x,S,C,R);return I(E.beta,N,$,T,L)}else return Q.unsafe(S,A)}toAffine(A){return P(this,A)}isTorsionFree(){const{isTorsionFree:A}=e;return o===Xs?!0:A?A(x,this):Q.unsafe(this,l).is0()}clearCofactor(){const{clearCofactor:A}=e;return o===Xs?this:A?A(x,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(A=!0){return vs(A,"isCompressed"),this.assertValidity(),h(x,this,A)}toHex(A=!0){return Fo(this.toBytes(A))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const B=s.BITS,Q=new yy(x,e.endo?Math.ceil(B/2):B);return x.BASE.precompute(8),x}function Ly(r){return Uint8Array.of(r?2:3)}function Ry(r,e){return{secretKey:e.BYTES,publicKey:1+r.BYTES,publicKeyUncompressed:1+2*r.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function EI(r,e={}){const{Fn:t}=r,n=e.randomBytes||Fl,s=Object.assign(Ry(r.Fp,t),{seed:py(t.ORDER)});function i(h){try{const p=t.fromBytes(h);return t.isValidNot0(p)}catch{return!1}}function o(h,p){const{publicKey:y,publicKeyUncompressed:g}=s;try{const m=h.length;return p===!0&&m!==y||p===!1&&m!==g?!1:!!r.fromBytes(h)}catch{return!1}}function l(h=n(s.seed)){return l2(ve(h,s.seed,"seed"),t.ORDER)}function c(h,p=!0){return r.BASE.multiply(t.fromBytes(h)).toBytes(p)}function d(h){const{secretKey:p,publicKey:y,publicKeyUncompressed:g}=s;if(!$l(h)||"_lengths"in t&&t._lengths||p===y)return;const m=ve(h,void 0,"key").length;return m===y||m===g}function f(h,p,y=!0){if(d(h)===!0)throw new Error("first arg must be private key");if(d(p)===!1)throw new Error("second arg must be public key");const g=t.fromBytes(h);return r.fromBytes(p).multiply(g).toBytes(y)}const a={isValidSecretKey:i,isValidPublicKey:o,randomSecretKey:l},u=vy(l,c);return Object.freeze({getPublicKey:c,getSharedSecret:f,keygen:u,Point:r,utils:a,lengths:s})}function xI(r,e,t={}){bd(e),Vo(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"}),t=Object.assign({},t);const n=t.randomBytes||Fl,s=t.hmac||((E,S)=>Od(e,E,S)),{Fp:i,Fn:o}=r,{ORDER:l,BITS:c}=o,{keygen:d,getPublicKey:f,getSharedSecret:a,utils:u,lengths:h}=EI(r,t),p={prehash:!0,lowS:typeof t.lowS=="boolean"?t.lowS:!0,format:"compact",extraEntropy:!1},y=l*Dy<i.ORDER;function g(E){const S=l>>Xs;return E>S}function m(E,S){if(!o.isValidNot0(S))throw new Error(`invalid signature ${E}: out of range 1..Point.Fn.ORDER`);return S}function w(){if(y)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function v(E,S){Iu(S);const T=h.signature,C=S==="compact"?T:S==="recovered"?T+1:void 0;return ve(E,C)}class _{r;s;recovery;constructor(S,T,C){if(this.r=m("r",S),this.s=m("s",T),C!=null){if(w(),![0,1,2,3].includes(C))throw new Error("invalid recovery id");this.recovery=C}Object.freeze(this)}static fromBytes(S,T=p.format){v(S,T);let C;if(T==="der"){const{r:$,s:q}=An.toSig(ve(S));return new _($,q)}T==="recovered"&&(C=S[0],T="compact",S=S.subarray(1));const L=h.signature/2,R=S.subarray(0,L),N=S.subarray(L,L*2);return new _(o.fromBytes(R),o.fromBytes(N),C)}static fromHex(S,T){return this.fromBytes(fo(S),T)}assertRecovery(){const{recovery:S}=this;if(S==null)throw new Error("invalid recovery id: must be present");return S}addRecoveryBit(S){return new _(this.r,this.s,S)}recoverPublicKey(S){const{r:T,s:C}=this,L=this.assertRecovery(),R=L===2||L===3?T+l:T;if(!i.isValid(R))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const N=i.toBytes(R),$=r.fromBytes(Dr(Ly((L&1)===0),N)),q=o.inv(R),F=P(ve(S,void 0,"msgHash")),H=o.create(-F*q),G=o.create(C*q),re=r.BASE.multiplyUnsafe(H).add($.multiplyUnsafe(G));if(re.is0())throw new Error("invalid recovery: point at infinify");return re.assertValidity(),re}hasHighS(){return g(this.s)}toBytes(S=p.format){if(Iu(S),S==="der")return fo(An.hexFromSig(this));const{r:T,s:C}=this,L=o.toBytes(T),R=o.toBytes(C);return S==="recovered"?(w(),Dr(Uint8Array.of(this.assertRecovery()),L,R)):Dr(L,R)}toHex(S){return Fo(this.toBytes(S))}}const k=t.bits2int||function(S){if(S.length>8192)throw new Error("input is too large");const T=Vl(S),C=S.length*8-c;return C>0?T>>BigInt(C):T},P=t.bits2int_modN||function(S){return o.create(k(S))},D=Ed(c);function I(E){return _u("num < 2^"+c,E,Jr,D),o.toBytes(E)}function x(E,S){return ve(E,void 0,"message"),S?ve(e(E),void 0,"prehashed message"):E}function B(E,S,T){const{lowS:C,prehash:L,extraEntropy:R}=gc(T,p);E=x(E,L);const N=P(E),$=o.fromBytes(S);if(!o.isValidNot0($))throw new Error("invalid private key");const q=[I($),I(N)];if(R!=null&&R!==!1){const re=R===!0?n(h.secretKey):R;q.push(ve(re,void 0,"extraEntropy"))}const F=Dr(...q),H=N;function G(re){const ne=k(re);if(!o.isValidNot0(ne))return;const K=o.inv(ne),ee=r.BASE.multiply(ne).toAffine(),ge=o.create(ee.x);if(ge===Jr)return;const Me=o.create(K*o.create(H+ge*$));if(Me===Jr)return;let tt=(ee.x===ge?0:2)|Number(ee.y&Xs),Oe=Me;return C&&g(Me)&&(Oe=o.neg(Me),tt^=1),new _(ge,Oe,y?void 0:tt)}return{seed:F,k2sig:G}}function Q(E,S,T={}){const{seed:C,k2sig:L}=B(E,S,T);return ZA(e.outputLen,o.BYTES,s)(C,L).toBytes(T.format)}function M(E,S,T,C={}){const{lowS:L,prehash:R,format:N}=gc(C,p);if(T=ve(T,void 0,"publicKey"),S=x(S,R),!$l(E)){const $=E instanceof _?", use sig.toBytes()":"";throw new Error("verify expects Uint8Array signature"+$)}v(E,N);try{const $=_.fromBytes(E,N),q=r.fromBytes(T);if(L&&$.hasHighS())return!1;const{r:F,s:H}=$,G=P(S),re=o.inv(H),ne=o.create(G*re),K=o.create(F*re),ee=r.BASE.multiplyUnsafe(ne).add(q.multiplyUnsafe(K));return ee.is0()?!1:o.create(ee.x)===F}catch{return!1}}function A(E,S,T={}){const{prehash:C}=gc(T,p);return S=x(S,C),_.fromBytes(E,"recovered").recoverPublicKey(S).toBytes()}return Object.freeze({keygen:d,getPublicKey:f,getSharedSecret:a,utils:u,lengths:h,Point:r,sign:Q,verify:M,recoverPublicKey:A,Signature:_,hash:e})}const $d={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},AI={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Mh=BigInt(2);function II(r){const e=$d.p,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),l=BigInt(44),c=BigInt(88),d=r*r*r%e,f=d*d*r%e,a=Ge(f,t,e)*f%e,u=Ge(a,t,e)*f%e,h=Ge(u,Mh,e)*d%e,p=Ge(h,s,e)*h%e,y=Ge(p,i,e)*p%e,g=Ge(y,l,e)*y%e,m=Ge(g,c,e)*g%e,w=Ge(m,l,e)*y%e,v=Ge(w,t,e)*f%e,_=Ge(v,o,e)*p%e,k=Ge(_,n,e)*d%e,P=Ge(k,Mh,e);if(!ku.eql(ku.sqr(P),r))throw new Error("Cannot find square root");return P}const ku=Kl($d.p,{sqrt:II}),kI=SI($d,{Fp:ku,endo:AI}),cn=xI(kI,Uo),CI=33,TI=32;function PI(r,e,t){const n=pr.digest(e instanceof Uint8Array?e:e.subarray());if(ql(n))return n.then(({digest:s})=>(t?.signal?.throwIfAborted(),cn.sign(s,r,{prehash:!1,format:"der"}))).catch(s=>{throw s.name==="AbortError"?s:new yh(String(s))});try{return cn.sign(n.digest,r,{prehash:!1,format:"der"})}catch(s){throw new yh(String(s))}}function DI(r,e,t,n){const s=pr.digest(t instanceof Uint8Array?t:t.subarray());if(ql(s))return s.then(({digest:i})=>(n?.signal?.throwIfAborted(),cn.verify(e,i,r,{prehash:!1,format:"der"}))).catch(i=>{throw i.name==="AbortError"?i:new bh(String(i))});try{return n?.signal?.throwIfAborted(),cn.verify(e,s.digest,r,{prehash:!1,format:"der"})}catch(i){throw new bh(String(i))}}class By{type="secp256k1";raw;_key;constructor(e){this._key=NI(e),this.raw=RI(this._key)}toMultihash(){return it.digest(Sr(this))}toCID(){return ue.createV1(114,this.toMultihash())}toString(){return Pe.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}verify(e,t,n){return DI(this._key,t,e,n)}}class Ny{type="secp256k1";raw;publicKey;constructor(e,t){this.raw=BI(e),this.publicKey=new By(t??MI(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:pe(this.raw,e.raw)}sign(e,t){return PI(this.raw,e,t)}}function My(r){return new Ny(r)}function Fd(r){return new By(r)}async function LI(){const r=OI();return new Ny(r)}function RI(r){return cn.Point.fromBytes(r).toBytes()}function BI(r){try{return cn.getPublicKey(r,!0),r}catch(e){throw new Bm(String(e))}}function NI(r){try{return cn.Point.fromBytes(r),r}catch(e){throw new Rm(String(e))}}function MI(r){try{return cn.getPublicKey(r,!0)}catch(e){throw new Bm(String(e))}}function OI(){return cn.utils.randomSecretKey()}async function Oy(r,e){if(r==="Ed25519")return D2();if(r==="secp256k1")return LI();if(r==="RSA")return dI(VI());if(r==="ECDSA")return IA(KI());throw new Ir}function zn(r,e){const{Type:t,Data:n}=Fn.decode(r),s=n??new Uint8Array;switch(t){case ze.RSA:return cI(s,e);case ze.Ed25519:return Id(s);case ze.secp256k1:return Fd(s);case ze.ECDSA:return Ym(s);default:throw new Ir}}function $I(r){if(r.byteLength===po)return Id(r);if(r.byteLength===CI)return Fd(r);const e=Hn(r),t=e[1]?.[0];if(t===Vm||t===Km||t===qm)return Xm(e);if(e[0]?.[0]===hI)return Ty(e,r);throw new V("Could not extract public key from raw bytes")}function Wn(r){const{Type:e,Data:t}=Fn.decode(r.digest),n=t??new Uint8Array;switch(e){case ze.Ed25519:return Id(n);case ze.secp256k1:return Fd(n);case ze.ECDSA:return Ym(n);default:throw new Ir}}function Sr(r){return Fn.encode({Type:ze[r.type],Data:r.raw})}function FI(r){const e=Ya.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case ze.RSA:return lI(t);case ze.Ed25519:return Sy(t);case ze.secp256k1:return My(t);case ze.ECDSA:return EA(t);default:throw new Ir}}function UI(r){if(r.byteLength===Tr)return Sy(r);if(r.byteLength===TI)return My(r);const e=Hn(r),t=e[2]?.[0];if(t===Vm||t===Km||t===qm)return Gm(e);if(e.length>8)return Cy(e);throw new V("Could not extract private key from raw bytes")}function qo(r){return Ya.encode({Type:ze[r.type],Data:r.raw})}function VI(r){return 2048}function KI(r){return"P-256"}const Bi=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),En=new Uint32Array(80);class qI extends wd{A=Bi[0]|0;B=Bi[1]|0;C=Bi[2]|0;D=Bi[3]|0;E=Bi[4]|0;constructor(){super(64,20,8,!1)}get(){const{A:e,B:t,C:n,D:s,E:i}=this;return[e,t,n,s,i]}set(e,t,n,s,i){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0}process(e,t){for(let c=0;c<16;c++,t+=4)En[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)En[c]=lc(En[c-3]^En[c-8]^En[c-14]^En[c-16],1);let{A:n,B:s,C:i,D:o,E:l}=this;for(let c=0;c<80;c++){let d,f;c<20?(d=Jm(s,i,o),f=1518500249):c<40?(d=s^i^o,f=1859775393):c<60?(d=ey(s,i,o),f=2400959708):(d=s^i^o,f=3395469782);const a=lc(n,5)+d+l+f+En[c]|0;l=o,o=i,i=lc(s,30),s=n,n=a}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,l=l+this.E|0,this.set(n,s,i,o,l)}roundClean(){ln(En)}destroy(){this.set(0,0,0,0,0),ln(this.buffer)}}const HI=vd(()=>new qI);function $y(r,e,t,n){bd(r);const s=LA({dkLen:32,asyncTick:10},n),{c:i,dkLen:o,asyncTick:l}=s;if(Rr(i,"c"),Rr(o,"dkLen"),Rr(l,"asyncTick"),i<1)throw new Error("iterations (c) must be >= 1");const c=Sh(e,"password"),d=Sh(t,"salt"),f=new Uint8Array(o),a=Od.create(r,c),u=a._cloneInto().update(d);return{c:i,dkLen:o,asyncTick:l,DK:f,PRF:a,PRFSalt:u}}function Fy(r,e,t,n,s){return r.destroy(),e.destroy(),n&&n.destroy(),ln(s),t}function zI(r,e,t,n){const{c:s,dkLen:i,DK:o,PRF:l,PRFSalt:c}=$y(r,e,t,n);let d;const f=new Uint8Array(4),a=Xi(f),u=new Uint8Array(l.outputLen);for(let h=1,p=0;p<i;h++,p+=l.outputLen){const y=o.subarray(p,p+l.outputLen);a.setInt32(0,h,!1),(d=c._cloneInto(d)).update(f).digestInto(u),y.set(u.subarray(0,y.length));for(let g=1;g<s;g++){l._cloneInto(d).update(u).digestInto(u);for(let m=0;m<y.length;m++)y[m]^=u[m]}}return Fy(l,c,o,d,u)}async function Uy(r,e,t,n){const{c:s,dkLen:i,asyncTick:o,DK:l,PRF:c,PRFSalt:d}=$y(r,e,t,n);let f;const a=new Uint8Array(4),u=Xi(a),h=new Uint8Array(c.outputLen);for(let p=1,y=0;y<i;p++,y+=c.outputLen){const g=l.subarray(y,y+c.outputLen);u.setInt32(0,p,!1),(f=d._cloneInto(f)).update(a).digestInto(h),g.set(h.subarray(0,g.length)),await PA(s-1,o,()=>{c._cloneInto(f).update(h).digestInto(h);for(let m=0;m<g.length;m++)g[m]^=h[m]})}return Fy(c,d,l,f,h)}const Oh={sha1:HI,"sha2-256":Uo,"sha2-512":Ul};function $h(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const l=Object.keys(Oh).join(" / ");throw new V(`Hash '${s}' is unknown or not supported. Must be ${l}`)}const i=Oh[s],o=zI(i,r,e,{c:t,dkLen:n});return Do.encode(o).substring(1)}const Ud={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Vy={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Ky=new globalThis.TextEncoder;function WI(r,e){const t=Ud[e];let n=Vy[e];for(let s=0;s<r.length;s++)n^=BigInt(r[s]),n=BigInt.asUintN(e,n*t);return n}function GI(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=Ud[e];let s=Vy[e],i=r;for(;i.length>0;){const o=Ky.encodeInto(i,t);i=i.slice(o.read);for(let l=0;l<o.written;l++)s^=BigInt(t[l]),s=BigInt.asUintN(e,s*n)}return s}function YI(r,{size:e=32,utf8Buffer:t}={}){if(!Ud[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return GI(r,e,t);r=Ky.encode(r)}return WI(r,e)}const Vd={hash:r=>Number(YI(r,{size:32})),hashV:(r,e)=>XI(Vd.hash(r,e))};function XI(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),j(e,"base16")}const qy=64;class rs{fp;h;seed;constructor(e,t,n,s=2){if(s>qy)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,n),o=Ke(s);for(let l=0;l<o.length;l++)o[l]=i[l];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?pe(this.fp,e.fp):!1}}function Xa(r,e){return Math.floor(Math.random()*(e-r))+r}class sa{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof rs))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof rs))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof rs))throw new TypeError("Invalid Fingerprint");const t=Xa(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof rs))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const ZI=500;class Fh{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Vd,this.seed=e.seed??Xa(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=j(e));const t=new rs(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new sa(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new sa(this.bucketSize)),this.buckets[n].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[n,s];let o=i[Xa(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new sa(this.bucketSize));for(let l=0;l<ZI;l++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new sa(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=j(e));const t=new rs(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.has(t)??!1;if(s)return s;const i=(n^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=j(e));const t=new rs(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[n]?.remove(t)??!1;if(s)return this.count--,s;const i=(n^t.hash())%this.filterSize,o=this.buckets[i]?.remove(t)??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const jI={1:.5,2:.84,4:.95,8:.98};function QI(r=.001){return r>.002?2:r>1e-5?4:8}function JI(r,e=.001){const t=QI(e),n=jI[t],s=Math.round(r/n),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),qy);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class ek{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Vd,this.seed=e.seed??Xa(0,Math.pow(2,10)),this.filterSeries=[new Fh({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=j(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Fh({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=j(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=j(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function mo(r,e=.001,t){return new ek({...JI(r,e)})}function qe(r){const e=r.getComponents(),t={};let n=0;if(e[n]?.name==="ip6zone"&&(t.zone=`${e[n].value}`,n++),e[n].name==="ip4"||e[n].name==="ip6"||e[n].name==="dns"||e[n].name==="dns4"||e[n].name==="dns6"?(t.type=e[n].name,t.host=e[n].value,n++):e[n].name==="dnsaddr"&&(t.type=e[n].name,t.host=`_dnsaddr.${e[n].value}`,n++),(e[n]?.name==="tcp"||e[n]?.name==="udp")&&(t.protocol=e[n].name==="tcp"?"tcp":"udp",t.port=parseInt(`${e[n].value}`),n++),e[n]?.name==="ipcidr"&&(t.type==="ip4"?t.cidr=parseInt(`${e[n].value}`):t.type==="ip6"&&(t.cidr=`${e[n].value}`),n++),t.type==null||t.host==null)throw new V(`Multiaddr ${r} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return e[n]?.name==="tls"&&e[n+1]?.name==="sni"&&(t.sni=e[n+1].value,n+=2),t}class tk{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const l=this.peekChar();if(l===void 0)return;const c=l==="0",d=2**(8*s)-1;for(;;){const f=this.readAtomically(()=>{const a=this.readChar();if(a===void 0)return;const u=Number.parseInt(a,e);if(!Number.isNaN(u))return u});if(f===void 0)break;if(i*=e,i+=f,i>d||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[l]=e(i.subarray(0,o));return t.set(i.subarray(0,l),16-l),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const Hy=45,rk=15,ci=new tk;function zy(r){if(!(r.length>rk))return ci.new(r).parseWith(()=>ci.readIPv4Addr())}function Wy(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Hy))return ci.new(r).parseWith(()=>ci.readIPv6Addr())}function Cu(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>Hy)return;const t=ci.new(r).parseWith(()=>ci.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function nk(r,e,t){let n=0;for(const s of r)if(!(n<e)){if(n>t)break;if(s!==255)return!1;n++}return!0}function sk(r,e,t,n){let s=0;for(const i of r)if(!(s<t)){if(s>n)break;if(i!==e[s])return!1;s++}return!0}function ik(r){switch(r.length){case yo:return r.join(".");case bo:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function ok(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;(n&128)!=0;)e++,n=n<<1;if((n&128)!=0)return-1;for(let s=t+1;s<r.length;s++)if(r[s]!=0)return-1;break}return e}function ak(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const yo=4,bo=16,lk=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Gy(r,e){e.length===bo&&r.length===yo&&nk(e,0,11)&&(e=e.slice(12)),e.length===yo&&r.length===bo&&sk(r,lk,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=r[s]&e[s];return n}function ck(r,e){if(typeof e=="string"&&(e=Cu(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function uk(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=yo,s=zy(e);if(s==null&&(n=bo,s=Wy(e),s==null))throw new Error("Failed to parse given CIDR: "+r);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=Yy(i,8*n);return{network:Gy(s,o),mask:o}}function Yy(r,e){if(e!==8*yo&&e!==8*bo)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let s=0;s<t;s++){if(r>=8){n[s]=255,r-=8;continue}n[s]=255-(255>>r),r=0}return n}class Xy{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=uk(e));else{const n=Cu(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n.length*8){const i=Cu(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=Yy(s,8*n.length);this.network=Gy(n,this.mask)}}contains(e){return ck({network:this.network,mask:this.mask},e)}toString(){const e=ok(this.mask),t=e!==-1?String(e):ak(this.mask);return ik(this.network)+"/"+t}}function dk(r,e){return new Xy(r).contains(e)}function fk(r){try{const e=qe(r);return e.type==="ip6"?dk("2000::/3",e.host):!1}catch{return!1}}function hk(r){try{const e=qe(r);switch(e.type){case"ip4":return e.host.startsWith("169.254.");case"ip6":return e.host.toLowerCase().startsWith("fe80");default:return!1}}catch{return!1}}function pk(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function Tu(r){try{const e=qe(r);switch(e.type){case"ip4":case"ip6":return pk(e.host);default:return!1}}catch{return!1}}function Er(r){try{return qe(r),!0}catch{return!1}}function ui(r){return!!zy(r)}function Zy(r){return!!Wy(r)}var Ns={},Uh;function gk(){return Uh||(Uh=1,(function(){var r,e,t,n,s,i,o,l;l=function(c){var d,f,a,u;return d=(c&255<<24)>>>24,f=(c&255<<16)>>>16,a=(c&65280)>>>8,u=c&255,[d,f,a,u].join(".")},o=function(c){var d,f,a,u,h,p;for(d=[],a=u=0;u<=3&&c.length!==0;a=++u){if(a>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),h=p[0],f=p[1],c=c.substring(f),d.push(h)}if(c.length!==0)throw new Error("Invalid IP");switch(d.length){case 1:if(d[0]>4294967295)throw new Error("Invalid IP");return d[0]>>>0;case 2:if(d[0]>255||d[1]>16777215)throw new Error("Invalid IP");return(d[0]<<24|d[1])>>>0;case 3:if(d[0]>255||d[1]>255||d[2]>65535)throw new Error("Invalid IP");return(d[0]<<24|d[1]<<16|d[2])>>>0;case 4:if(d[0]>255||d[1]>255||d[2]>255||d[3]>255)throw new Error("Invalid IP");return(d[0]<<24|d[1]<<16|d[2]<<8|d[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var d,f,a,u,h;for(u=0,d=10,f="9",a=0,c.length>1&&c[a]==="0"&&(c[a+1]==="x"||c[a+1]==="X"?(a+=2,d=16):"0"<=c[a+1]&&c[a+1]<="9"&&(a++,d=8,f="7")),h=a;a<c.length;){if("0"<=c[a]&&c[a]<=f)u=u*d+(t(c[a])-n)>>>0;else if(d===16)if("a"<=c[a]&&c[a]<="f")u=u*d+(10+t(c[a])-i)>>>0;else if("A"<=c[a]&&c[a]<="F")u=u*d+(10+t(c[a])-s)>>>0;else break;else break;if(u>4294967295)throw new Error("too large");a++}if(a===h)throw new Error("empty octet");return[u,a]},r=(function(){function c(d,f){var a,u,h;if(typeof d!="string")throw new Error("Missing `net' parameter");if(f||(h=d.split("/",2),d=h[0],f=h[1]),f||(f=32),typeof f=="string"&&f.indexOf(".")>-1){try{this.maskLong=o(f)}catch{throw new Error("Invalid mask: "+f)}for(a=u=32;u>=0;a=--u)if(this.maskLong===4294967295<<32-a>>>0){this.bitmask=a;break}}else if(f||f===0)this.bitmask=parseInt(f,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(d)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+d)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+f);this.size=Math.pow(2,32-this.bitmask),this.base=l(this.netLong),this.mask=l(this.maskLong),this.hostmask=l(~this.maskLong),this.first=this.bitmask<=30?l(this.netLong+1):this.base,this.last=this.bitmask<=30?l(this.netLong+this.size-2):l(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?l(this.netLong+this.size-1):void 0}return c.prototype.contains=function(d){return typeof d=="string"&&(d.indexOf("/")>0||d.split(".").length!==4)&&(d=new c(d)),d instanceof c?this.contains(d.base)&&this.contains(d.broadcast||d.last):(o(d)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(d){return d==null&&(d=1),new c(l(this.netLong+this.size*d),this.mask)},c.prototype.forEach=function(d){var f,a,u;for(u=o(this.first),a=o(this.last),f=0;u<=a;)d(l(u),u,f),f++,u++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c})(),Ns.ip2long=o,Ns.long2ip=l,Ns.Netmask=r}).call(Ns)),Ns}var mk=gk();const yk=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],bk=yk.map(r=>new mk.Netmask(r));function Kd(r){for(const e of bk)if(e.contains(r))return!0;return!1}function vk(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function wk(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),s=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return Kd(s)}function _k(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function Sk(r){const e=r.split(":"),t=e[e.length-1];return Kd(t)}function Ek(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function qd(r){if(ui(r))return Kd(r);if(vk(r))return wk(r);if(_k(r))return Sk(r);if(Zy(r))return Ek(r)}function di(r){try{const e=qe(r);switch(e.type){case"ip4":case"ip6":return qd(e.host)??!1;default:return e.host==="localhost"}}catch{return!1}}let xk=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Ak=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const Vh=r=>globalThis.DOMException===void 0?new Ak(r):new DOMException(r),Kh=r=>{const e=r.reason===void 0?Vh("This operation was aborted."):r.reason;return e instanceof Error?e:Vh(e)};function Ik(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o,l;const d=new Promise((f,a)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:h}=e;h.aborted&&a(Kh(h)),l=()=>{a(Kh(h))},h.addEventListener("abort",l,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(f,a);return}const u=new xk;o=i.setTimeout.call(void 0,()=>{if(n){try{f(n())}catch(h){a(h)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?f():s instanceof Error?a(s):(u.message=s??`Promise timed out after ${t} milliseconds`,a(u))},t),(async()=>{try{f(await r)}catch(h){a(h)}})()}).finally(()=>{d.clear(),l&&e.signal&&e.signal.removeEventListener("abort",l)});return d.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},d}const kk=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function Ck(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const l=[e].flat(),c=[],{addListener:d,removeListener:f}=kk(r),a=async(...h)=>{const p=t.multiArgs?h:h[0];if(t.filter)try{if(!await t.filter(p))return}catch(y){n(),o(y);return}c.push(p),t.count===c.length&&(n(),i(c))},u=(...h)=>{n(),o(t.rejectionMultiArgs?h:h[0])};n=()=>{for(const h of l)f(h,a);for(const h of t.rejectionEvents)l.includes(h)||f(h,u)};for(const h of l)d(h,a);for(const h of t.rejectionEvents)l.includes(h)||d(h,u);t.signal&&t.signal.addEventListener("abort",()=>{u(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=Ik(s,{milliseconds:t.timeout});return i.cancel=()=>{n(),i.clear()},i}return s}function fr(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=Ck(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}function Za(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Tk extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let Pk=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};class ja extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"}class Dk extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"}class Lk extends Error{static name="StreamClosedError";name="StreamClosedError"}let Rk=class{deferred;signal;constructor(e){this.signal=e,this.deferred=lr(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new co)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Bk(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let Nk=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Bk(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new co),this.cleanup())}async join(e={}){const t=new Rk(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Tt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},jy=class extends Dt{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Za(this.emitEmpty.bind(this),1),this.emitIdle=Za(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Pk;const n=new Nk(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new co)}),this.clear()}async onEmpty(e){this.size!==0&&await fr(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await fr(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await fr(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ld({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail)},i=c=>{n(c.detail.error)},o=()=>{n()},l=()=>{n(new co("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",l),n()}}};const Mk=Math.pow(2,20)*4;class Qy extends Dt{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??Mk,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new Ne,this.writeBuffer=new Ne,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);const t=()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()};this.addEventListener("drain",t);const n=s=>{this.onDrainPromise?.reject(s.error??new Lk)};this.addEventListener("close",n)}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return this.writableNeedsDrain!==!0?Promise.resolve():(this.onDrainPromise==null&&(this.onDrainPromise=Promise.withResolvers()),Tt(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if(this.readStatus!=="readable"&&this.readStatus!=="paused")return;const e=ld(),t=i=>{e.push(i.data)};this.addEventListener("message",t);const n=i=>{e.end(i.error)};this.addEventListener("close",n);const s=()=>{e.end()};this.addEventListener("remoteCloseWrite",s);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",n),this.removeEventListener("remoteCloseWrite",s)}}isReadable(){return this.status==="open"}send(e){if(this.writeStatus==="closed"||this.writeStatus==="closing")throw new Di(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if(!(this.status==="aborted"||this.status==="reset"||this.status==="closed")){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(t){this.log("failed to send reset to remote - %e",t)}this.dispatchEvent(new iA(e))}}pause(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di("Cannot pause a stream that is closing/closed");this.readStatus!=="paused"&&(this.readStatus="paused",this.sendPause())}resume(){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di("Cannot resume a stream that is closing/closed");this.readStatus!=="readable"&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.append(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}unshift(e){if(this.readStatus==="closed"||this.readStatus==="closing")throw new Di(`Cannot push data onto a stream that is ${this.readStatus}`);if(e.byteLength!==0){if(this.readBuffer.prepend(e),this.readStatus==="paused"||this.listenerCount("message")===0){this.checkReadBufferLength();return}setTimeout(()=>{this.dispatchReadBuffer()},0)}}onData(e){if(e.byteLength!==0){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("ignoring data - read status %s",this.readStatus);return}this.readBuffer.append(e),this.dispatchReadBuffer()}}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="message"&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),this.readBuffer.byteLength===0&&(this.readStatus="closed");const e=new eA;this.dispatchEvent(new oA(e))}onTransportClosed(e){this.log("transport closed"),this.readStatus==="readable"&&this.readBuffer.byteLength===0&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),this.remoteReadStatus!=="closed"&&(this.remoteReadStatus="closed"),this.remoteWriteStatus!=="closed"&&(this.remoteWriteStatus="closed"),this.writeStatus!=="closed"&&(this.writeStatus="closed"),e!=null?this.abort(e):(this.status==="open"||this.status==="closing")&&(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Ml))}onRemoteCloseWrite(){this.remoteWriteStatus!=="closed"&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),this.writeStatus==="closed"&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(this.writeBuffer.byteLength===0)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let n=0;for(;this.writeBuffer.byteLength>0;){const s=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(s===0){e=!1;break}const i=this.writeBuffer.sublist(0,s),o=new Ne(i);this.writeBuffer.consume(i.byteLength);const l=this.sendData(i);if(e=l.canSendMore,n+=l.sentBytes,l.sentBytes!==o.byteLength&&(o.consume(l.sentBytes),this.writeBuffer.prepend(o)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",n,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),this.writeBuffer.byteLength===0&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(this.listenerCount("message")===0){this.log.trace("not dispatching pause buffer as there are no listeners for the message event");return}if(this.readBuffer.byteLength===0){this.log.trace("not dispatching pause buffer as there is no data to dispatch");return}if(this.readStatus==="paused"){this.log.trace("not dispatching pause buffer we are paused");return}if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),this.readBuffer.consume(this.readBuffer.byteLength);return}const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new sA(e))}finally{this.readBuffer.byteLength===0&&this.remoteWriteStatus==="closed"&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new ph(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){this.maxWriteBufferLength!=null&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new ph(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}}class Jy extends Qy{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",t=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),t.error!=null?t.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):t.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){this.status==="open"&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}}function Ok(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class $k extends Dt{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;const n=o=>{try{this.onData(o.data)}catch(l){this.abort(l),this.maConn.abort(l)}};this.maConn.addEventListener("message",n);const s=()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(o=>{o.onMuxerDrain()})};this.maConn.addEventListener("drain",s);const i=()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()};this.maConn.addEventListener("close",i)}send(e){const t=this.maConn.send(e);return t===!1&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(n=>{n.onMuxerNeedsDrain()})),t}async close(e){this.status==="closed"||this.status==="closing"||(this.status="closing",await Tt(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){this.status!=="closed"&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(t){this.abort(t)}this.status="closed"}async createStream(e){if(this.status!=="open")throw new Ki;let t=this.onCreateStream({...this.streamOptions,...e});return Ok(t)&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),this.listenerCount("stream")===0){this.earlyStreams.push(e),this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new Dk(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`));return}this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){const t=n=>{const s=this.streams.findIndex(i=>i===e);s!==-1&&this.streams.splice(s,1),n.error!=null?n.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})};e.addEventListener("close",t),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),e[0]==="stream"&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(t=>{this.safeDispatchEvent("stream",{detail:t})}),this.earlyStreams=[]})}}class Fk extends Qy{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await fr(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await fr(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),this.remoteWriteStatus==="closed"&&this.onTransportClosed())}async closeRead(e){this.readStatus==="closing"||this.readStatus==="closed"||(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}}function ws(r){const e=new globalThis.AbortController;function t(){const i=r.filter(o=>o?.aborted===!0).map(o=>o?.reason).pop();e.abort(i);for(const o of r)o?.removeEventListener!=null&&o.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}class mc{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=n*s;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=e;this.previousTime=t}}const Uk=1.2,Vk=2,Kk=5e3,qk=6e4,Hk=5e3;class zk{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??Hk;this.success=new mc(t),this.failure=new mc(t),this.next=new mc(t),this.failureMultiplier=e.failureMultiplier??Vk,this.timeoutMultiplier=e.timeoutMultiplier??Uk,this.minTimeout=e.minTimeout??Kk,this.maxTimeout=e.maxTimeout??qk,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const n=AbortSignal.timeout(t),s=ws([e.signal,n]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class cr extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class vo extends Error{static name="ValidationError";name="ValidationError"}class Wk extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class Gk extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}const Qa=4,fs=6,eb=273,Yk=33,_s=41,Hd=42,zd=43,Wd=53,Gd=54,Yd=55,Xd=56,Xk=132,Zk=301,jk=302,tb=400,ce=421,Qk=444,Jk=445,eC=446,tC=447,hs=448,Ja=449,rC=454,rb=460,nb=461,sb=465,wo=466,Zs=480,nC=481,Pu=443,Zd=477,ib=478,sC=479,iC=277,oC=275,aC=276,ob=280,Qi=281,Ho=290,ab=777;function qh(r){return e=>W(e,r)}function Hh(r){return e=>j(e,r)}function Hi(r){return new DataView(r.buffer).getUint16(r.byteOffset).toString()}function Us(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof r=="string"?parseInt(r):r),new Uint8Array(e)}function lC(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=j(e[0],"base32"),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Us(n);return an([t,s],t.length+s.length)}function cC(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Rn.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Us(n);return an([t,s],t.length+s.length)}function zh(r){const e=r.subarray(0,r.length-2),t=r.subarray(r.length-2),n=W(e,"base32"),s=Hi(t);return`${n}:${s}`}const lb=function(r){r=r.toString().trim();const e=new Uint8Array(4);return r.split(/\./g).forEach((t,n)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new cr("Invalid byte value in IP address");e[n]=s}),e},uC=function(r){let e=0;r=r.toString().trim();const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=ui(t[n]);let o;i&&(o=lb(t[n]),t[n]=W(o.subarray(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,W(o.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){t[n]===""&&(t[n]="0");const i=parseInt(t[n],16);if(isNaN(i)||i<0||i>65535)throw new cr("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},dC=function(r){if(r.byteLength!==4)throw new cr("IPv4 address was incorrect length");const e=[];for(let t=0;t<r.byteLength;t++)e.push(r[t]);return e.join(".")},fC=function(r){if(r.byteLength!==16)throw new cr("IPv6 address was incorrect length");const e=[];for(let n=0;n<r.byteLength;n+=2){const s=r[n],i=r[n+1],o=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(o)}const t=e.join(":");try{const n=new URL(`http://[${t}]`);return n.hostname.substring(1,n.hostname.length-1)}catch{throw new cr(`Invalid IPv6 address "${t}"`)}};function hC(r){try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new cr(`Invalid IPv6 address "${r}"`)}}const yc=Object.values(eu).map(r=>r.decoder),pC=(function(){let r=yc[0].or(yc[1]);return yc.slice(2).forEach(e=>r=r.or(e)),r})();function gC(r){return pC.decode(r)}function mC(r){return e=>r.encoder.encode(e)}function yC(r){if(parseInt(r).toString()!==r)throw new vo("Value must be an integer")}function bC(r){if(r<0)throw new vo("Value must be a positive integer, or zero")}function vC(r){return e=>{if(e>r)throw new vo(`Value must be smaller than or equal to ${r}`)}}function wC(...r){return e=>{for(const t of r)t(e)}}const ia=wC(yC,bC,vC(65535)),xt=-1;class _C{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new Gk(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(n=>{this.protocolsByName.delete(n)}))}}const Ai=new _C,SC=[{code:Qa,name:"ip4",size:32,valueToBytes:lb,bytesToValue:dC,validate:r=>{if(!ui(r))throw new vo(`Invalid IPv4 address "${r}"`)}},{code:fs,name:"tcp",size:16,valueToBytes:Us,bytesToValue:Hi,validate:ia},{code:eb,name:"udp",size:16,valueToBytes:Us,bytesToValue:Hi,validate:ia},{code:Yk,name:"dccp",size:16,valueToBytes:Us,bytesToValue:Hi,validate:ia},{code:_s,name:"ip6",size:128,valueToBytes:uC,bytesToValue:fC,stringToValue:hC,validate:r=>{if(!Zy(r))throw new vo(`Invalid IPv6 address "${r}"`)}},{code:Hd,name:"ip6zone",size:xt},{code:zd,name:"ipcidr",size:8,bytesToValue:qh("base10"),valueToBytes:Hh("base10")},{code:Wd,name:"dns",size:xt},{code:Gd,name:"dns4",size:xt},{code:Yd,name:"dns6",size:xt},{code:Xd,name:"dnsaddr",size:xt},{code:Xk,name:"sctp",size:16,valueToBytes:Us,bytesToValue:Hi,validate:ia},{code:Zk,name:"udt"},{code:jk,name:"utp"},{code:tb,name:"unix",size:xt,stringToValue:r=>decodeURIComponent(r),valueToString:r=>encodeURIComponent(r)},{code:ce,name:"p2p",aliases:["ipfs"],size:xt,bytesToValue:qh("base58btc"),valueToBytes:r=>r.startsWith("Q")||r.startsWith("1")?Hh("base58btc")(r):ue.parse(r).multihash.bytes},{code:Qk,name:"onion",size:96,bytesToValue:zh,valueToBytes:lC},{code:Jk,name:"onion3",size:296,bytesToValue:zh,valueToBytes:cC},{code:eC,name:"garlic64",size:xt},{code:tC,name:"garlic32",size:xt},{code:hs,name:"tls"},{code:Ja,name:"sni",size:xt},{code:rC,name:"noise"},{code:rb,name:"quic"},{code:nb,name:"quic-v1"},{code:sb,name:"webtransport"},{code:wo,name:"certhash",size:xt,bytesToValue:mC(Zg),valueToBytes:gC},{code:Zs,name:"http"},{code:nC,name:"http-path",size:xt,stringToValue:r=>`/${decodeURIComponent(r)}`,valueToString:r=>encodeURIComponent(r.substring(1))},{code:Pu,name:"https"},{code:Zd,name:"ws"},{code:ib,name:"wss"},{code:sC,name:"p2p-websocket-star"},{code:iC,name:"p2p-stardust"},{code:oC,name:"p2p-webrtc-star"},{code:aC,name:"p2p-webrtc-direct"},{code:ob,name:"webrtc-direct"},{code:Qi,name:"webrtc"},{code:Ho,name:"p2p-circuit"},{code:ab,name:"memory",size:xt}];SC.forEach(r=>{Ai.addProtocol(r)});function EC(r){const e=[];let t=0;for(;t<r.length;){const n=Dd(r,t),s=Ai.getProtocol(n),i=Ar(n),o=kC(s,r,t+i);let l=0;o>0&&s.size===xt&&(l=Ar(o));const c=i+l+o,d={code:n,name:s.name,bytes:r.subarray(t,t+c)};if(o>0){const f=t+i+l,a=r.subarray(f,f+o);d.value=s.bytesToValue?.(a)??W(a)}e.push(d),t+=c}return e}function xC(r){let e=0;const t=[];for(const n of r){if(n.bytes==null){const s=Ai.getProtocol(n.code),i=Ar(n.code);let o,l=0,c=0;n.value!=null&&(o=s.valueToBytes?.(n.value)??j(n.value),l=o.byteLength,s.size===xt&&(c=Ar(l)));const d=new Uint8Array(i+c+l);let f=0;Wa(n.code,d,f),f+=i,o!=null&&(s.size===xt&&(Wa(l,d,f),f+=c),d.set(o,f)),n.bytes=d}t.push(n.bytes),e+=n.bytes.byteLength}return an(t,e)}function AC(r){if(r.charAt(0)!=="/")throw new cr('String multiaddr must start with "/"');const e=[];let t="protocol",n="",s="";for(let i=1;i<r.length;i++){const o=r.charAt(i);o!=="/"&&(t==="protocol"?s+=r.charAt(i):n+=r.charAt(i));const l=i===r.length-1;if(o==="/"||l){const c=Ai.getProtocol(s);if(t==="protocol"){if(c.size==null||c.size===0){e.push({code:c.code,name:c.name}),n="",s="",t="protocol";continue}else if(l)throw new cr(`Component ${s} was missing value`);t="value"}else if(t==="value"){const d={code:c.code,name:c.name};if(c.size!=null&&c.size!==0){if(n==="")throw new cr(`Component ${s} was missing value`);d.value=c.stringToValue?.(n)??n}e.push(d),n="",s="",t="protocol"}}}if(s!==""&&n!=="")throw new cr("Incomplete multiaddr");return e}function IC(r){return`/${r.flatMap(e=>{if(e.value==null)return e.name;const t=Ai.getProtocol(e.code);if(t==null)throw new cr(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function kC(r,e,t){return r.size==null||r.size===0?0:r.size>0?r.size/8:Dd(e,t)}const CC=Symbol.for("nodejs.util.inspect.custom"),cb=Symbol.for("@multiformats/multiaddr");function TC(r){if(r==null&&(r="/"),Hl(r))return r.getComponents();if(r instanceof Uint8Array)return EC(r);if(typeof r=="string")return r=r.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),r===""&&(r="/"),AC(r);if(Array.isArray(r))return r;throw new cr("Must be a string, Uint8Array, Component[], or another Multiaddr")}class Vs{[cb]=!0;#e;#r;#t;constructor(e="/",t={}){this.#e=TC(e),t.validate!==!1&&PC(this)}get bytes(){return this.#t==null&&(this.#t=xC(this.#e)),this.#t}toString(){return this.#r==null&&(this.#r=IC(this.#e)),this.#r}toJSON(){return this.toString()}getComponents(){return[...this.#e.map(e=>({...e}))]}encapsulate(e){const t=new Vs(e);return new Vs([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Wk(`Address ${this.toString()} does not contain subaddress: ${t}`);return new Vs(n.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let n=this.#e.length-1;n>-1;n--)if(this.#e[n].code===e){t=n;break}return new Vs(this.#e.slice(0,t),{validate:!1})}equals(e){return pe(this.bytes,e.bytes)}[CC](){return`Multiaddr(${this.toString()})`}}function PC(r){r.getComponents().forEach(e=>{const t=Ai.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function Hl(r){return!!r?.[cb]}function he(r){return new Vs(r)}const DC=4194304;class Wh extends Error{static name="UnwrappedError";name="UnwrappedError"}class LC extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}let RC=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"};class BC extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function NC(r){return typeof r?.closeRead=="function"}function MC(r){return typeof r?.close=="function"}function bc(r){return NC(r)?r.remoteWriteStatus!=="writable"&&r.readBufferLength===0:MC(r)?r.status!=="open":!1}function OC(r){return r?.addEventListener!=null&&r?.removeEventListener!=null&&r?.send!=null&&r?.push!=null&&r?.log!=null}function ub(r,e){const t=e?.maxBufferSize??DC,n=new Ne;let s,i=!1;if(!OC(r))throw new V("Argument should be a Stream or a Multiaddr");const o=f=>{if(n.append(f.data),n.byteLength>t){const a=n.byteLength;n.consume(n.byteLength),s?.reject(new Error(`Read buffer overflow - ${a} > ${t}`))}s?.resolve()};r.addEventListener("message",o);const l=f=>{f.error!=null?s?.reject(f.error):s?.resolve()};r.addEventListener("close",l);const c=()=>{s?.resolve()};r.addEventListener("remoteCloseWrite",c);const d={readBuffer:n,async read(f){if(i===!0)throw new Wh("Stream was unwrapped");if(bc(r)){if(f?.bytes==null)return null;if(n.byteLength<f.bytes)throw r.log.error("closed after reading %d/%d bytes",n.byteLength,f.bytes),new ja(`Unexpected EOF - stream closed after reading ${n.byteLength}/${f.bytes} bytes`)}const a=f?.bytes??1;for(s=Promise.withResolvers();;){if(n.byteLength>=a){s.resolve();break}if(await Tt(s.promise,f?.signal),bc(r)){if(n.byteLength===0&&f?.bytes==null)return null;break}s=Promise.withResolvers()}const u=f?.bytes??n.byteLength;if(n.byteLength<u){if(bc(r))throw r.log.error("closed while reading %d/%d bytes",n.byteLength,u),new ja(`Unexpected EOF - stream closed while reading ${n.byteLength}/${u} bytes`);return d.read(f)}const h=n.sublist(0,u);return n.consume(u),h},async write(f,a){if(i===!0)throw new Wh("Stream was unwrapped");r.send(f)||await fr(r,"drain",{signal:a?.signal,rejectionEvents:["close"]})},unwrap(){return i||(i=!0,r.removeEventListener("message",o),r.removeEventListener("close",l),r.removeEventListener("remoteCloseWrite",c),n.byteLength>0&&(r.log("stream unwrapped with %d unread bytes",n.byteLength),r.push(n))),r}};return d}function jd(r,e={}){const t=ub(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ar(e.maxDataLength));const n=e?.lengthDecoder??Dd,s=e?.lengthEncoder??ji;return{async read(o){let l=-1;const c=new Ne;for(;;){const f=await t.read({...o,bytes:1});if(f==null)break;c.append(f);try{l=n(c)}catch(a){if(a instanceof RangeError)continue;throw a}if(l<0)throw new LC("Invalid message length");if(e?.maxLengthLength!=null&&c.byteLength>e.maxLengthLength)throw new BC(`Message length length too long - ${c.byteLength} > ${e.maxLengthLength}`);if(l>-1)break}if(e?.maxDataLength!=null&&l>e.maxDataLength)throw new RC(`Message length too long - ${l} > ${e.maxDataLength}`);const d=await t.read({...o,bytes:l});if(d==null)throw r.log.error("tried to read %d bytes but the stream closed",l),new ja(`Unexpected EOF - tried to read ${l} bytes but the stream closed`);if(d.byteLength!==l)throw r.log.error("read %d/%d bytes before the stream closed",d.byteLength,l),new ja(`Unexpected EOF - read ${d.byteLength}/${l} bytes before the stream closed`);return d},async write(o,l){await t.write(new Ne(s(o.byteLength),o),l)},async writeV(o,l){const c=new Ne(...o.flatMap(d=>[s(d.byteLength),d]));await t.write(c,l)},unwrap(){return t.unwrap()}}}function Un(r,e){const t=jd(r,e),n={read:async(s,i)=>{const o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},writeV:async(s,i,o)=>{await t.writeV(s.map(l=>i.encode(l)),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),writeV:async(i,o)=>n.writeV(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class Qd extends jy{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}let $C=class extends jy{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}};class FC{memoryStorage;points;duration;blockDuration;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new UC}consume(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(s,t,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new Tk("Rate limit exceeded",o);return o}penalty(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const s=this.getKey(e),i=this._getKeySecDuration(n),o=this.memoryStorage.incrby(s,-t,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:s,isFirstInDuration:!1}}set(e,t,n=0){const s=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class UC{storage;constructor(){this.storage=new Map}incrby(e,t,n){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const o={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function db(r,e,t){let n,s,i=!1;function o(){const d={signal:s.signal};if(t?.timeout!=null){const f=ws([s.signal,AbortSignal.timeout(t.timeout)]);d.signal=f}i=!0,Promise.resolve().then(async()=>{await r(d)}).catch(()=>{}).finally(()=>{i=!1,!s.signal.aborted&&(n=setTimeout(o,e))})}const l=Za(o,t?.debounce??100);let c=!1;return{setInterval:d=>{e!==d&&(e=d,n!=null&&(clearTimeout(n),n=setTimeout(o,e)))},setTimeout:d=>{t??={},t.timeout=d},run:()=>{i||(clearTimeout(n),l())},start:()=>{c||(c=!0,s=new AbortController,s.signal,t?.runImmediately===!0?queueMicrotask(()=>{o()}):n=setTimeout(o,e))},stop:()=>{clearTimeout(n),s?.abort(),c=!1}}}class VC extends Map{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function un(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new VC({name:e,metrics:t}):n=new Map,n}var Qe;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(Qe||(Qe={}));var Se;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Se||(Se={}));Object.values(Se).filter(r=>typeof r!="string");const KC=0;var Zt;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Zt||(Zt={}));const ns=12;class zl extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}}function qC(r){return r?.reason!==null}class Ks extends zl{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,Zt.ProtocolError),this.name="InvalidFrameError"}}class HC extends zl{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,Zt.ProtocolError),this.name="UnRequestedPingError"}}class zC extends zl{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,Zt.ProtocolError),this.name="NotMatchingPingError"}}class WC extends zl{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,Zt.ProtocolError),this.name="ReceiveWindowExceededError"}}const fb=256*1024,GC=16*1024*1024,oa={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3};function YC(r){if(r.keepAliveInterval!=null&&r.keepAliveInterval<=0)throw new V("keep-alive interval must be positive");if(r.maxInboundStreams!=null&&r.maxInboundStreams<0)throw new V("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams!=null&&r.maxOutboundStreams<0)throw new V("max outbound streams must be larger or equal 0");if(r.maxMessageSize!=null&&r.maxMessageSize<1024)throw new V("MaxMessageSize must be greater than a kilobyte");if(r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize<fb)throw new V("InitialStreamWindowSize must be larger or equal 256 kB");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.initialStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize<r.streamOptions?.initialStreamWindowSize)throw new V("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.streamOptions?.maxStreamWindowSize!=null&&r.streamOptions?.maxStreamWindowSize>2**32-1)throw new V("MaxStreamWindowSize must be less than equal MAX_UINT32")}function XC(r){return r.header.type===Qe.Data&&r.data!==null}const Gh=2**24;function ZC(r){if(r[0]!==KC)throw new Ks("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*Gh+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*Gh+(r[9]<<16)+(r[10]<<8)+r[11]}}class jC{buffer;constructor(){this.buffer=new Ne}*emitFrames(e){for(this.buffer.append(e);;){const t=this.readFrame();if(t===void 0)break;yield t}}readFrame(){let e=ns;if(this.buffer.byteLength<ns)return;const t=ZC(this.buffer.subarray(0,ns));if(t.type===Qe.Data){if(e+=t.length,this.buffer.byteLength<e)return;const n=this.buffer.sublist(ns,e);return this.buffer.consume(e),{header:t,data:n}}return this.buffer.consume(e),{header:t}}}function Yh(r){const e=new Uint8Array(ns);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var Vt;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished",r[r.Paused=5]="Paused"})(Vt||(Vt={}));class QC extends Fk{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){const t=e.initialStreamWindowSize??fb;super({...e,maxMessageSize:t-ns}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??GC,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;const n=()=>{this.state=Vt.Finished};this.addEventListener("close",n)}sendData(e){const t=e.byteLength;let n=0,s=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(this.sendWindowCapacity===0){s=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",n,t);break}const i=Math.min(this.sendWindowCapacity,e.byteLength),o=this.getSendFlags(),l=e.sublist(0,i);e.consume(i);const c=this.sendFrame({type:Qe.Data,flag:o,streamID:this.streamId,length:i},l);if(this.sendWindowCapacity-=i,n+=i,!c){s=c,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",n,t);break}}return{sentBytes:n,canSendMore:s}}sendReset(){this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Se.FIN;this.sendFrame({type:Qe.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=Vt.Paused}sendResume(){this.state=Vt.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-ns,this.maxMessageSize<0&&(this.maxMessageSize=0),this.maxMessageSize!==0&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!XC(e))throw new Ks("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new WC("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&Se.ACK)===Se.ACK&&this.state===Vt.SYNSent&&(this.state=Vt.Established),(e&Se.FIN)===Se.FIN&&this.onRemoteCloseWrite(),(e&Se.RST)===Se.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case Vt.Init:return this.state=Vt.SYNSent,Se.SYN;case Vt.SYNReceived:return this.state=Vt.Established,Se.ACK;default:return 0}}sendWindowUpdate(){if(this.state===Vt.Paused){this.epochStart=Date.now();return}const e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>-1&&t-this.epochStart<=n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:Qe.WindowUpdate,flag:e,streamID:this.streamId,length:s})}}function Xh(r){return{type:Qe[r.type],flags:[(r.flag&Se.SYN)===Se.SYN?"SYN":void 0,(r.flag&Se.ACK)===Se.ACK?"ACK":void 0,(r.flag&Se.FIN)===Se.FIN?"FIN":void 0,(r.flag&Se.RST)===Se.RST?"RST":void 0].filter(Boolean),streamID:r.streamID,length:r.length}}const hb="/yamux/1.0.0";class JC{protocol=hb;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[xr]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new eT(e,{...this._init})}}class eT extends $k{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:hb,name:"yamux"}),this.client=e.direction==="outbound",YC(t),this.enableKeepAlive=t.enableKeepAlive??oa.enableKeepAlive,this.keepAliveInterval=t.keepAliveInterval??oa.keepAliveInterval,this.maxInboundStreams=t.maxInboundStreams??oa.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??oa.maxOutboundStreams,this.decoder=new jC,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=db(async n=>{try{await this.ping(n)}catch(s){this.log.error("ping error: %s",s)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(const t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(this.remoteGoAway!==void 0)throw new Ki("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Ki("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new Mm("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);const t=this._newStream(e,Vt.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(this.remoteGoAway!==void 0)throw new Ki("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Ki("Muxer closed locally");if(this.activePing!=null)return Tt(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await Tt(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.status==="open")try{const t=e?.reason??Zt.NormalTermination;this.log.trace("muxer close reason=%s",Zt[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if(this.status==="open")try{super.abort(e);let t=Zt.InternalError;qC(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,n){if(this.streams.find(i=>i.streamId===e)!=null)throw new V("Stream already exists with that id");const s=new QC({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:n,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${n}:${e}`),getRTT:this.getRTT.bind(this)});return s.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){const{streamID:t,type:n,length:s}=e.header;if(this.log.trace("received frame %o",Xh(e.header)),t===0)switch(n){case Qe.Ping:{this.handlePing(e.header);return}case Qe.GoAway:{this.handleGoAway(s);return}default:throw new Ks("Invalid frame type")}else switch(e.header.type){case Qe.Data:case Qe.WindowUpdate:{this.handleStreamMessage(e);return}default:throw new Ks("Invalid frame type")}}handlePing(e){if(e.flag===Se.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Se.ACK);else if(e.flag===Se.ACK)this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Ks("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new HC("ping not requested");if(this.activePing.id!==e)throw new zC("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",Zt[e]??"unknown"),this.remoteGoAway=e,e===Zt.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){const{streamID:t,flag:n,type:s}=e.header;(n&Se.SYN)===Se.SYN&&this.incomingStream(t);const i=this.streams.find(o=>o.streamId===t);if(i===void 0){this.log.trace("frame for missing stream id=%s",t);return}switch(s){case Qe.WindowUpdate:{i.handleWindowUpdate(e);return}case Qe.Data:{i.handleData(e);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new V("Both endpoints are clients");if(this.streams.find(n=>n.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.maxInboundStreams){this.log("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Qe.WindowUpdate,flag:Se.RST,streamID:e,length:0});return}const t=this._newStream(e,Vt.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let n;if(e.type===Qe.Data){if(t==null)throw new Ks("Invalid frame");n=new Ne(Yh(e),t)}else n=Yh(e);return this.log.trace("sending frame %o",Xh(e)),this.send(n)}sendPing(e,t=Se.SYN){t===Se.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:Qe.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Zt.NormalTermination){this.log("sending GoAway reason=%s",Zt[e]),this.localGoAway=e,this.sendFrame({type:Qe.GoAway,flag:0,streamID:0,length:e})}}function tT(r={}){return()=>new JC(r)}const pb=Symbol.for("nodejs.util.inspect.custom"),rT=114;let Jd=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(rT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[pb](){return`PeerId(${this.toString()})`}},nT=class extends Jd{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},sT=class extends Jd{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},iT=class extends Jd{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const oT=2336;let gb=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[pb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(oT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const aT=114,Zh=2336;function lT(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=hn(Pe.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return cT(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return mb(t)}function mb(r){if(dT(r))return new nT({multihash:r});if(uT(r))try{const e=Wn(r);if(e.type==="Ed25519")return new sT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new iT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new gb(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function cT(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==aT&&r.code!==Zh)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Zh){const e=W(r.multihash.digest);return new gb(new URL(e))}return mb(r.multihash)}function uT(r){return r.code===it.code}function dT(r){return r.code===pr.code}const Fe=r=>({match:e=>{const t=e[0];return t==null||t.code!==r||t.value!=null?!1:e.slice(1)}}),ae=(r,e)=>({match:t=>{const n=t[0];return n?.code!==r||n.value==null||e!=null&&n.value!==e?!1:t.slice(1)}}),fT=r=>({match:e=>r.match(e)===!1?e:!1}),ye=r=>({match:e=>{const t=r.match(e);return t===!1?e:t}}),$t=(...r)=>({match:e=>{let t;for(const n of r){const s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),Ae=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e}});function Ve(...r){function e(s){if(s==null)return!1;let i=s.getComponents();for(const o of r){const l=o.match(i);if(l===!1)return!1;i=l}return i}function t(s){return e(s)!==!1}function n(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:r,matches:t,exactMatch:n}}const hT=ae(ce),pT=Ve(hT),Wl=ae(Gd),Gl=ae(Yd),Yl=ae(Xd),ef=ae(Wd);Ve(Wl,ye(ae(ce)));Ve(Gl,ye(ae(ce)));Ve(Yl,ye(ae(ce)));Ve($t(ef,Yl,Wl,Gl),ye(ae(ce)));const yb=Ae(ae(Qa),ye(ae(zd))),bb=Ae(ye(ae(Hd)),ae(_s),ye(ae(zd))),tf=$t(yb,bb),Ss=$t(tf,ef,Wl,Gl,Yl),gT=Ve($t(tf,Ae($t(ef,Yl,Wl,Gl),ye(ae(ce))))),jh=Ve(yb),Qh=Ve(bb);Ve(tf);const rf=Ae(Ss,ae(fs)),zo=Ae(Ss,ae(eb)),el=Ve(Ae(rf,ye(ae(ce))));Ve(zo);const nf=Ae(zo,Fe(rb),ye(ae(ce))),Xl=Ae(zo,Fe(nb),ye(ae(ce))),mT=$t(nf,Xl);Ve(nf);const yT=Ve(Xl),Du=$t(Ss,rf,zo,nf,Xl),vb=$t(Ae(Du,Fe(Zd),ye(ae(ce)))),_o=Ve(vb),wb=$t(Ae(Du,Fe(ib),ye(ae(ce))),Ae(Du,Fe(hs),ye(ae(Ja)),Fe(Zd),ye(ae(ce)))),tl=Ve(wb),_b=Ae(zo,Fe(ob),ye(ae(wo)),ye(ae(wo)),ye(ae(ce))),Jh=Ve(_b),Sb=Ae(Xl,Fe(sb),ye(ae(wo)),ye(ae(wo)),ye(ae(ce))),ep=Ve(Sb),rl=$t(vb,wb,Ae(rf,ye(ae(ce))),Ae(mT,ye(ae(ce))),Ae(Ss,ye(ae(ce))),_b,Sb,ae(ce)),Eb=Ve(rl),bT=Ae(ye(rl),Fe(Ho),fT(Fe(Qi)),ye(ae(ce))),fi=Ve(bT),vT=$t(Ae(rl,Fe(Ho),Fe(Qi),ye(ae(ce))),Ae(rl,Fe(Qi),ye(ae(ce))),Ae(Fe(Qi),ye(ae(ce)))),tp=Ve(vT),wT=$t(Ae(Ss,ae(fs),Fe(Zs),ye(ae(ce))),Ae(Ss,Fe(Zs),ye(ae(ce))));Ve(wT);const _T=Ae(Ss,$t(Ae(ae(fs,"443"),Fe(Zs)),Ae(ae(fs),Fe(Pu)),Ae(ae(fs),Fe(hs),Fe(Zs)),Ae(Fe(hs),Fe(Zs)),Fe(hs),Fe(Pu)),ye(ae(ce)));Ve(_T);const ST=$t(Ae(ae(ab),ye(ae(ce))));Ve(ST);const ET=$t(Ae(ae(tb),ye(ae(ce))));Ve(ET);const xT="bootstrap",AT=50,IT=1e3;class kT extends Dt{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??IT,this.list=t.list.map(n=>he(n)).filter(n=>Eb.matches(n)?n.getComponents().findLast(i=>i.code===ce)?.value==null?(this.log.error("invalid bootstrap multiaddr without peer id"),!1):!0:(this.log.error("invalid multiaddr %a",n),!1)).map(n=>({id:lT(n.getComponents().findLast(s=>s.code===ce)?.value??""),multiaddrs:[n]})),this._init=t}[Fa]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[xr]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??xT]:{value:this._init.tagValue??AT,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function CT(r){return e=>new kT(e,r)}const xb=Symbol.for("nodejs.util.inspect.custom"),TT=114;let sf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(TT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[xb](){return`PeerId(${this.toString()})`}},PT=class extends sf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},DT=class extends sf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},LT=class extends sf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const RT=2336;let Ab=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[xb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(RT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const BT=114,rp=2336;function np(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=hn(Pe.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return NT(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return of(t)}function of(r){if(OT(r))return new PT({multihash:r});if(MT(r))try{const e=Wn(r);if(e.type==="Ed25519")return new DT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new LT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new Ab(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function NT(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==BT&&r.code!==rp)throw new Oo("Supplied PeerID CID is invalid");if(r.code===rp){const e=W(r.multihash.digest);return new Ab(new URL(e))}return of(r.multihash)}function MT(r){return r.code===it.code}function OT(r){return r.code===pr.code}var nl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),payload:Ke(0),signature:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(nl||(nl={}));class $T extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class nn{static createFromProtobuf=e=>{const t=nl.decode(e),n=zn(t.publicKey);return new nn({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,n)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,o=e.marshal(),l=sp(s,i,o),c=await t.sign(l.subarray(),n);return new nn({publicKey:t.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(e,t,n)=>{const s=nn.createFromProtobuf(e);if(!await s.validate(t,n))throw new $T("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:n,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=nl.encode({publicKey:Sr(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:pe(this.marshal(),e.marshal())}async validate(e,t){const n=sp(e,this.payloadType,this.payload);return this.publicKey.verify(n.subarray(),this.signature,t)}}const sp=(r,e,t)=>{const n=j(r),s=ji(n.byteLength),i=ji(e.length),o=ji(t.length);return new Ne(s,n,i,e,o,t)},Ib=Symbol.for("nodejs.util.inspect.custom"),FT=114;let af=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(FT,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Ib](){return`PeerId(${this.toString()})`}},UT=class extends af{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},VT=class extends af{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},KT=class extends af{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const qT=2336;let HT=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Ib](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(qT,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function zT(r){if(GT(r))return new UT({multihash:r});if(WT(r))try{const e=Wn(r);if(e.type==="Ed25519")return new VT({multihash:r,publicKey:e});if(e.type==="secp256k1")return new KT({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new HT(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function WT(r){return r.code===it.code}function GT(r){return r.code===pr.code}const YT="libp2p-peer-record",XT=Uint8Array.from([3,1]);var sl;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={multiaddr:Ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();d>>>3===1?l.multiaddr=s.bytes():s.skipType(d&7)}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peerId:Ke(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new vt('Decode error - map field "addresses" had too many elements');i.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(sl||(sl={}));function ZT(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}class ur{static createFromProtobuf=e=>{const t=sl.decode(e),n=zT(hn(t.peerId)),s=(t.addresses??[]).map(o=>he(o.multiaddr)),i=t.seq;return new ur({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=YT;static CODEC=XT;peerId;multiaddrs;seqNumber;domain=ur.DOMAIN;codec=ur.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=sl.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof ur)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!ZT(this.multiaddrs,e.multiaddrs))}}const jT=1,kb=5e3,QT=100,aa=`${gd}-circuit-relay`;BigInt(1<<17);const il="/libp2p/circuit/relay/0.2.0/hop",ip="/libp2p/circuit/relay/0.2.0/stop",op=300,JT=4096,eP=.001;var hi;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),(function(n){n.codec=()=>Ko(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),pi.codec().encode(n.peer,s)),n.reservation!=null&&(s.uint32(26),ol.codec().encode(n.reservation,s)),n.limit!=null&&(s.uint32(34),gi.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(40),Bt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},l=s==null?n.len:n.pos+s;for(;n.pos<l;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=pi.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.reservation=ol.codec().decode(n,n.uint32(),{limits:i.limits?.reservation});break}case 4:{o.limit=gi.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 5:{o.status=Bt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,s)=>Ie(n,r.codec(),s)})(hi||(hi={}));var Wr;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),(function(n){n.codec=()=>Ko(e)})(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=Ce((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.type!=null&&(s.uint32(8),r.Type.codec().encode(n.type,s)),n.peer!=null&&(s.uint32(18),pi.codec().encode(n.peer,s)),n.limit!=null&&(s.uint32(26),gi.codec().encode(n.limit,s)),n.status!=null&&(s.uint32(32),Bt.codec().encode(n.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(n,s,i={})=>{const o={},l=s==null?n.len:n.pos+s;for(;n.pos<l;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=pi.codec().decode(n,n.uint32(),{limits:i.limits?.peer});break}case 3:{o.limit=gi.codec().decode(n,n.uint32(),{limits:i.limits?.limit});break}case 4:{o.status=Bt.codec().decode(n);break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>ke(n,r.codec()),r.decode=(n,s)=>Ie(n,r.codec(),s)})(Wr||(Wr={}));var pi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={id:Ke(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new vt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(pi||(pi={}));var ol;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),ll.codec().encode(t.voucher,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new vt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=ll.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ol||(ol={}));var gi;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(gi||(gi={}));var Bt;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Bt||(Bt={}));var Lu;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Lu||(Lu={}));(function(r){r.codec=()=>Ko(Lu)})(Bt||(Bt={}));var al;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={relay:Ke(0),peer:Ke(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(al||(al={}));var ll;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),al.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),payloadType:Ke(0),signature:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=al.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ll||(ll={}));class ap extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class tP extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class rP extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function lp(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class cp{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const Cb=Ve(Ae(Eb.matchers[0],Fe(Ho))),Tb=Ve(Fe(Ho)),Pb=Symbol.for("nodejs.util.inspect.custom"),nP=114;let lf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(nP,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Pb](){return`PeerId(${this.toString()})`}},sP=class extends lf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},iP=class extends lf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},oP=class extends lf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const aP=2336;let lP=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Pb](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(aP,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function cP(r){if(dP(r))return new sP({multihash:r});if(uP(r))try{const e=Wn(r);if(e.type==="Ed25519")return new iP({multihash:r,publicKey:e});if(e.type==="secp256k1")return new oP({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new lP(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function uP(r){return r.code===it.code}function dP(r){return r.code===pr.code}function Ji(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function vc(r){const e=hn(Pe.decode(`z${r}`));return cP(e)}class ks{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Ji(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Ji(this.map.values(),e=>e.key)}values(){return Ji(this.map.values(),e=>e.value)}get size(){return this.map.size}}class ps{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Ji(this.set.entries(),e=>{const t=vc(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=vc(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Ji(this.set.values(),e=>vc(e))}intersection(e){const t=new ps;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ps;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ps;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}class fP{filter;constructor(e,t){this.filter=mo(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function hP(r,e=.001){return new fP(r,e)}class pP extends ks{metric;constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function gP(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new pP({name:e,metrics:t}):n=new ks,n}class nt extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class mP extends Dt{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(il,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[n=>n.protocols.includes(il)],orders:[()=>Math.random()<.5?1:-1,(n,s)=>{const i=up(n),o=up(s);return i>o?-1:o>i?1:0}]});for(const n of e)this.log.trace("found relay peer %p in peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new Qd({concurrency:5});this.log("start random walk");for await(const n of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",n.id),t.has(n.id)){this.log.trace("random peer %p was already in queue",n.id);continue}if(this.components.connectionManager.getConnections(n.id)?.length>0){this.log.trace("random peer %p was already connected",n.id);continue}if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable",n.id,n.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",n.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",n.id,t.size,t.running),t.add(this.dialPeer,{peerId:n.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p - %e",n.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,n=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(n)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const n=ws([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:n})}finally{n.clear()}}}function up(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(W(e)).getTime()}class yP extends Dt{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??kb,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(Tb.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(Cb.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),n=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(n,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new yu(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>he(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function bP(r){return new yP(r)}const vP="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let wP=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=vP[t[r]&63];return e};const _P=60*1e3*10,SP=60*1e3*5,EP=30*1e3;class xP extends Dt{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new ks,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??QT,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??kb,this.started=!1,this.relayFilter=mo(100),this.reserveQueue=new Qd({concurrency:t?.reservationConcurrency??jT,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",n=>{[...this.reservations.values()].find(i=>i.connection===n.detail.id)!=null&&this.#r(n.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",n.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(aa)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[aa]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#t()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=wP();return this.pendingReservations.push(e),this.#t(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new yu("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new rP("The reservation queue is full");const n=this.reserveQueue.find(e);if(n!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),n.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new yu("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const p=this.connectionManager.getConnections(e);let y=!1;if(p.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),p.map(g=>g.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),y=!0),y&&lp(i.reservation.expire)>_P)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#r(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new ap("Not making reservation on discovered relay because we do not need any more relays");const o=AbortSignal.timeout(this.reservationCompletionTimeout);const l=await this.connectionManager.openConnection(e,{signal:o});if(fi.matches(l.remoteAddr))throw new tP("not creating reservation over relayed connection");const c=await this.#e(l,{signal:o}),d=lp(c.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+d).toString());const f=Math.min(Math.max(d-SP,EP),Math.pow(2,31)-1),a=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async p=>{this.log.error("could not refresh reservation to relay %p - %e",e,p),await this.#r(e)}).catch(p=>{this.log.error("could not remove expired reservation to relay %p - %e",e,p)})},f);let u;if(t==="discovered"){const p=this.pendingReservations.pop();if(p==null)throw new ap("Made reservation on relay but did not need any more discovered relays");u={timeout:a,reservation:c,type:t,connection:l.id,id:p}}else u={timeout:a,reservation:c,type:t,connection:l.id};this.reservations.set(e,u),await this.peerStore.merge(e,{tags:{[aa]:{value:1,ttl:d}}}),this.#t();const h={relay:e,details:u};return this.safeDispatchEvent("relay:created-reservation",{detail:h}),h}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#r(e).catch(o=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,o)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,n)=>(n.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const n=await e.newStream(il,t),i=Un(n).pb(hi);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:hi.Type.RESERVE},t);let o;try{this.log.trace("reading response from %p",e.remotePeer),o=await i.read(t)}catch(c){throw n.abort(c),c}finally{n.status!=="closed"&&await n.close(t)}if(this.log.trace("read response %s",o.status),o.status===Bt.OK&&o.reservation!=null){const c=new Set;c.add(e.remoteAddr.toString());for(const d of o.reservation.addrs){let f=he(d);f.getComponents().find(a=>a.code===ce)==null&&(f=f.encapsulate(`/p2p/${e.remotePeer}`)),f=he(f.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),c.add(f.toString())}return o.reservation.addrs=[...c].map(d=>he(d).bytes),o.reservation}const l=`reservation failed with status ${o.status??"undefined"}`;throw this.log.error(l),new Error(l)}async#r(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[aa]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#t())}#t(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=mo(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}class AP extends Jy{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",t=>{this.onTransportClosed(t.error)}),this.stream.addEventListener("remoteCloseWrite",t=>{this.onRemoteCloseWrite(),this.close().catch(n=>{this.abort(n)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}}function dp(r){return new AP(r)}const IP=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(he)}catch{return!1}return!0},fp={maxInboundStopStreams:op,maxOutboundStopStreams:op};class kP{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??fp.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??fp.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new mP(e,{filter:t.discoveryFilter??hP(JT,eP)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p - %e",n.detail,s)})}),this.reservationStore=new xP(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[xr]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Va](){return this.discovery!=null?["@libp2p/identify"]:[]}[Fm]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(ip,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Om(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await $m(this.discovery,this.reservationStore),await this.components.registrar.unhandle(ip),this.started=!1}async dial(e,t){const n=e.toString().split("/p2p-circuit"),s=he(n[0]),i=he(n[n.length-1]),o=s.getComponents().find(h=>h.code===ce)?.value,l=i.getComponents().find(h=>h.code===ce)?.value;if(o==null||l==null){const h=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${h}`),new ma(`C${h}`)}const c=np(o),d=np(l);let a=this.components.connectionManager.getConnections(c)[0];a==null?(await this.components.peerStore.merge(c,{multiaddrs:[s]}),t.onProgress?.(new nt("circuit-relay:open-connection")),a=await this.components.connectionManager.openConnection(c,t)):t.onProgress?.(new nt("circuit-relay:reuse-connection"));let u;try{t.onProgress?.(new nt("circuit-relay:open-hop-stream")),u=await a.newStream(il,t);const h=Un(u).pb(hi);t.onProgress?.(new nt("circuit-relay:write-connect-message")),await h.write({type:hi.Type.CONNECT,peer:{id:d.toMultihash().bytes,addrs:[he(i).bytes]}},t),t.onProgress?.(new nt("circuit-relay:read-connect-response"));const p=await h.read(t);if(p.status!==Bt.OK)throw new $e(`failed to connect via relay with status ${p?.status?.toString()??"undefined"}`);const y=new cp(p.limit),g=dp({stream:h.unwrap().unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:y.onData,onDataWrite:y.onData,log:u.log.newScope("circuit-relay:connection")}),m=await this.components.upgrader.upgradeOutbound(g,{...t,limits:y.getLimits()});return m.log("outbound relayed connection established to %p with limits %o, over connection %s",m.remotePeer,p.limit??"none",a.id),m}catch(h){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",d,c,h),u?.abort(h),h}}createListener(e){return bP({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Cb.exactMatch(t)||Tb.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>fi.exactMatch(t))}async onStop(e,t){const n=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(a){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",a)}const s=Un(e).pb(Wr),i=await s.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(i.type!==Wr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.UNEXPECTED_MESSAGE},{signal:n}),await e.close({signal:n});return}if(!IP(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.MALFORMED_MESSAGE},{signal:n}),await e.close({signal:n});return}const o=of(hn(i.peer.id));if(await this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,o)===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.PERMISSION_DENIED},{signal:n}),await e.close({signal:n});return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:Wr.Type.STATUS,status:Bt.OK},{signal:n});const l=new cp(i.limit),c=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),d=this.components.addressManager.getAddresses()[0],f=dp({stream:s.unwrap().unwrap(),remoteAddr:c,localAddr:d,onDataRead:l.onData,onDataWrite:l.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(f,{limits:l.getLimits(),signal:n}),f.log("inbound relayed connection established to %p with limits %o, over connection %s",o,i.limit??"none",t.id)}finally{n?.clear()}}}function CP(r={}){return e=>new kP(e,r)}var wc,hp;function TP(){if(hp)return wc;hp=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return wc=function(n,s,i){if(typeof s!="string")throw new Error("Input must be string");for(var o=s.length,l=0,c,d,f=0;f<o;f+=1){if(c=s.charCodeAt(f),d=s[f],r(c)&&e(s.charCodeAt(f+1))&&(f+=1,d+=s[f]),l+=n(d),l===i)return s.slice(0,f+1);if(l>i)return s.slice(0,f-d.length+1)}return s},wc}var _c,pp;function PP(){if(pp)return _c;pp=1;function r(t){return t>=55296&&t<=56319}function e(t){return t>=56320&&t<=57343}return _c=function(n){if(typeof n!="string")throw new Error("Input must be string");for(var s=n.length,i=0,o=null,l=null,c=0;c<s;c++)o=n.charCodeAt(c),e(o)?l!=null&&r(l)?i+=1:i+=3:o<=127?i+=1:o>=128&&o<=2047?i+=2:o>=2048&&o<=65535&&(i+=3),l=o;return i},_c}var Sc,gp;function DP(){if(gp)return Sc;gp=1;var r=TP(),e=PP();return Sc=r.bind(null,e),Sc}var Ec,mp;function LP(){if(mp)return Ec;mp=1;var r=DP(),e=/[\/\?<>\\:\*\|"]/g,t=/[\x00-\x1f\x80-\x9f]/g,n=/^\.+$/,s=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=/[\. ]+$/;function o(l,c){if(typeof l!="string")throw new Error("Input must be string");var d=l.replace(e,c).replace(t,c).replace(n,c).replace(s,c).replace(i,c);return r(d,255)}return Ec=function(l,c){var d=c&&c.replacement||"",f=o(l,d);return d===""?f:o(f,"")},Ec}var RP=LP();const BP=ad(RP),yp={keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"},xc={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Db(r){const e="AES-GCM";let t=16;const n=12,s="SHA-256",i=16,o=32767,l=Ot.get();t*=8;async function c(a,u){const h=l.getRandomValues(new Uint8Array(i)),p=l.getRandomValues(new Uint8Array(n)),y={name:e,iv:p};typeof u=="string"&&(u=j(u));let g;if(u.length===0){g=await l.subtle.importKey("jwk",xc,{name:"AES-GCM"},!0,["encrypt"]);try{const w={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},v=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);g=await l.subtle.deriveKey(w,v,{name:e,length:t},!0,["encrypt"])}catch{g=await l.subtle.importKey("jwk",xc,{name:"AES-GCM"},!0,["encrypt"])}}else{const w={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},v=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);g=await l.subtle.deriveKey(w,v,{name:e,length:t},!0,["encrypt"])}const m=await l.subtle.encrypt(y,g,a);return an([h,y.iv,new Uint8Array(m)])}async function d(a,u){const h=a.subarray(0,i),p=a.subarray(i,i+n),y=a.subarray(i+n),g={name:e,iv:p};typeof u=="string"&&(u=j(u));let m;if(u.length===0)try{const v={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},_=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);m=await l.subtle.deriveKey(v,_,{name:e,length:t},!0,["decrypt"])}catch{m=await l.subtle.importKey("jwk",xc,{name:"AES-GCM"},!0,["decrypt"])}else{const v={name:"PBKDF2",salt:h,iterations:o,hash:{name:s}},_=await l.subtle.importKey("raw",u,{name:"PBKDF2"},!1,["deriveKey"]);m=await l.subtle.deriveKey(v,_,{name:e,length:t},!0,["decrypt"])}const w=await l.subtle.decrypt(g,m,y);return new Uint8Array(w)}return{encrypt:c,decrypt:d}}const NP="[object ArrayBuffer]";class Be{static isArrayBuffer(e){return Object.prototype.toString.call(e)===NP}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=Be.toUint8Array(e),s=Be.toUint8Array(t);if(n.length!==s.byteLength)return!1;for(let i=0;i<n.length;i++)if(n[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const s=new Uint8Array(n);let i=0;for(const o of t){const l=this.toUint8Array(o);s.set(l,i),i+=l.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const Ac="string",MP=/^[0-9a-f\s]+$/i,OP=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,$P=/^[a-zA-Z0-9-_]+$/;class bp{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n.buffer}static toString(e){const t=Be.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return decodeURIComponent(escape(n))}}class Cr{static toString(e,t=!1){const n=Be.toArrayBuffer(e),s=new DataView(n);let i="";for(let o=0;o<n.byteLength;o+=2){const l=s.getUint16(o,t);i+=String.fromCharCode(l)}return i}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),s=new DataView(n);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return n}}class Ye{static isHex(e){return typeof e===Ac&&MP.test(e)}static isBase64(e){return typeof e===Ac&&OP.test(e)}static isBase64Url(e){return typeof e===Ac&&$P.test(e)}static ToString(e,t="utf8"){const n=Be.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return Cr.toString(n,!0);case"utf16":case"utf16be":return Cr.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Cr.fromString(e,!0);case"utf16":case"utf16be":return Cr.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=Be.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=Ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return bp.fromString(e);case"utf16":case"utf16be":return Cr.fromString(e);case"utf16le":case"usc2":return Cr.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=Ye.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return bp.toString(e);case"utf16":case"utf16be":return Cr.toString(e);case"utf16le":case"usc2":return Cr.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);return n.buffer}static ToBinary(e){const t=Be.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return n}static ToHex(e){const t=Be.toUint8Array(e);let n="";const s=t.length;for(let i=0;i<s;i++){const o=t[i];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ye.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);n[s/2]=parseInt(i,16)}return n.buffer}static ToUtf16String(e,t=!1){return Cr.toString(e,t)}static FromUtf16String(e,t=!1){return Cr.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}Ye.DEFAULT_UTF8_ENCODING="utf8";function mi(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Es(r,e,t=-1){const n=t;let s=r,i=0,o=Math.pow(2,e);for(let l=1;l<8;l++){if(r<o){let c;if(n<0)c=new ArrayBuffer(l),i=l;else{if(n<l)return new ArrayBuffer(0);c=new ArrayBuffer(n),i=n}const d=new Uint8Array(c);for(let f=l-1;f>=0;f--){const a=Math.pow(2,f*e);d[i-f-1]=Math.floor(s/a),s-=d[i-f-1]*a}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function Ru(...r){let e=0,t=0;for(const i of r)e+=i.length;const n=new ArrayBuffer(e),s=new Uint8Array(n);for(const i of r)s.set(i,t),t+=i.length;return s}function Lb(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const l=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(l||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let l=0;l<this.valueHex.byteLength;l++)t[l]=0;t[0]=r[0]&128;const n=mi(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let l=0;l<this.valueHex.byteLength;l++)i[l]=r[l];return i[0]&=127,mi(i,8)-n}function FP(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,l=Es(o,8,n),c=new Uint8Array(l);return c[0]|=128,l}let s=Es(e,8,n),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),l=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=l[c];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function UP(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==n[s])return!1;return!0}function jt(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,s=new Array(n);for(let o=0;o<n;o++)s[o]="0";return s.join("").concat(t)}function cl(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function cf(r){let e=0,t=0;for(let s=0;s<r.length;s++){const i=r[s];e+=i.byteLength}const n=new Uint8Array(e);for(let s=0;s<r.length;s++){const i=r[s];n.set(new Uint8Array(i),t),t+=i.byteLength}return n.buffer}function gn(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class uf{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return cf(this.items)}}const Ni=[new Uint8Array([1])],vp="0123456789",Ii="",Fr=new ArrayBuffer(0),df=new Uint8Array(0),So="EndOfContent",Rb="OCTET STRING",Bb="BIT STRING";function mn(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var s;super(...n);const i=n[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?Be.toUint8Array(i.valueHex):df}fromBER(n,s,i){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!gn(this,o,s,i))return-1;const l=s+i;return this.valueHexView=o.subarray(s,l),this.valueHexView.length?(this.blockLength=i,l):(this.warnings.push("Zero buffer length"),s)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Fr)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Ye.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Cs{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=Ii,warnings:n=[],valueBeforeDecode:s=df}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=Be.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Ye.ToHex(this.valueBeforeDecodeView)}}}Cs.NAME="baseBlock";class Gt extends Cs{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Gt.NAME="valueBlock";class Nb extends mn(Cs){constructor({idBlock:e={}}={}){var t,n,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Be.toUint8Array(e.valueHex):df,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Fr}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=Es(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,l=new Uint8Array(o+1);if(l[0]=t|31,!e){for(let c=0;c<o-1;c++)l[c+1]=i[c]|128;l[o]=i[o-1]}return l.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)n[i+1]=s[i]|128;n[this.valueHexView.byteLength]=s[s.length-1]}return n.buffer}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const l=i[0]&31;if(l!==31)this.tagNumber=l,this.blockLength=1;else{let c=1,d=this.valueHexView=new Uint8Array(255),f=255;for(;i[c]&128;){if(d[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===f){f+=255;const u=new Uint8Array(f);for(let h=0;h<d.length;h++)u[h]=d[h];d=this.valueHexView=new Uint8Array(f)}}this.blockLength=c+1,d[c-1]=i[c]&127;const a=new Uint8Array(c);for(let u=0;u<c;u++)a[u]=d[u];d=this.valueHexView=new Uint8Array(c),d.set(a),this.blockLength<=9?this.tagNumber=mi(d,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}Nb.NAME="identificationBlock";class Mb extends Cs{constructor({lenBlock:e={}}={}){var t,n,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const l=t+1,c=s.subarray(l,l+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=mi(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const s=Es(this.length,8);if(s.byteLength>127)return this.error="Too big length",Fr;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);n=new Uint8Array(t),n[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)n[o+1]=i[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}Mb.NAME="lengthBlock";const Z={};class Ft extends Cs{constructor({name:e=Ii,optional:t=!1,primitiveSchema:n,...s}={},i){super(s),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new Nb(s),this.lenBlock=new Mb(s),this.valueBlock=i?new i(s):new Gt(s)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const n=t||new uf;t||Ob(this);const s=this.idBlock.toBER(e);if(n.write(s),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(i)}return t?Fr:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Ye.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=Ye.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return UP(t,n)}}Ft.NAME="BaseBlock";function Ob(r){var e;if(r instanceof Z.Constructed)for(const t of r.valueBlock.value)Ob(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class $b extends Ft{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=Ii,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}$b.NAME="BaseStringBlock";class Fb extends mn(Gt){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}Fb.NAME="PrimitiveValueBlock";var Ub;class Vb extends Ft{constructor(e={}){super(e,Fb),this.idBlock.isConstructed=!1}}Ub=Vb;Z.Primitive=Ub;Vb.NAME="PRIMITIVE";function VP(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function Zl(r,e=0,t=r.length){const n=e;let s=new Ft({},Gt);const i=new Cs;if(!gn(i,r,e,t))return s.error=i.error,{offset:-1,result:s};if(!r.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let l=s.idBlock.fromBER(r,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),l===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=l,t-=s.idBlock.blockLength,l=s.lenBlock.fromBER(r,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),l===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=l,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=Ft;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=Z.EndOfContent;break;case 1:c=Z.Boolean;break;case 2:c=Z.Integer;break;case 3:c=Z.BitString;break;case 4:c=Z.OctetString;break;case 5:c=Z.Null;break;case 6:c=Z.ObjectIdentifier;break;case 10:c=Z.Enumerated;break;case 12:c=Z.Utf8String;break;case 13:c=Z.RelativeObjectIdentifier;break;case 14:c=Z.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=Z.Sequence;break;case 17:c=Z.Set;break;case 18:c=Z.NumericString;break;case 19:c=Z.PrintableString;break;case 20:c=Z.TeletexString;break;case 21:c=Z.VideotexString;break;case 22:c=Z.IA5String;break;case 23:c=Z.UTCTime;break;case 24:c=Z.GeneralizedTime;break;case 25:c=Z.GraphicString;break;case 26:c=Z.VisibleString;break;case 27:c=Z.GeneralString;break;case 28:c=Z.UniversalString;break;case 29:c=Z.CharacterString;break;case 30:c=Z.BmpString;break;case 31:c=Z.DATE;break;case 32:c=Z.TimeOfDay;break;case 33:c=Z.DateTime;break;case 34:c=Z.Duration;break;default:{const d=s.idBlock.isConstructed?new Z.Constructed:new Z.Primitive;d.idBlock=s.idBlock,d.lenBlock=s.lenBlock,d.warnings=s.warnings,s=d}}break;default:c=s.idBlock.isConstructed?Z.Constructed:Z.Primitive}return s=VP(s,c),l=s.fromBER(r,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=r.subarray(n,n+s.blockLength),{offset:l,result:s}}function Ic(r){if(!r.byteLength){const e=new Ft({},Gt);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Zl(Be.toUint8Array(r).slice(),0,r.byteLength)}function KP(r,e){return r?1:e}class Mn extends Gt{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;KP(this.isIndefiniteForm,n)>0;){const o=Zl(s,i,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===So)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===So?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const n=t||new uf;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,n);return t?Fr:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}Mn.NAME="ConstructedValueBlock";var Kb;class ki extends Ft{constructor(e={}){super(e,Mn),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}Kb=ki;Z.Constructed=Kb;ki.NAME="CONSTRUCTED";class qb extends Gt{fromBER(e,t,n){return t}toBER(e){return Fr}}qb.override="EndOfContentValueBlock";var Hb;class zb extends Ft{constructor(e={}){super(e,qb),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}Hb=zb;Z.EndOfContent=Hb;zb.NAME=So;var Wb;class ul extends Ft{constructor(e={}){super(e,Gt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const s=new Uint8Array(n);s[0]=5,s[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}Wb=ul;Z.Null=Wb;ul.NAME="NULL";class Gb extends mn(Gt){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Be.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const s=Be.toUint8Array(e);return gn(this,s,t,n)?(this.valueHexView=s.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,Lb.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}Gb.NAME="BooleanValueBlock";var Yb;let Xb=class extends Ft{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,Gb),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};Yb=Xb;Z.Boolean=Yb;Xb.NAME="BOOLEAN";class Zb extends mn(Mn){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Mn.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===So){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==Rb)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,n),this.blockLength=n;return s}toBER(e,t){return this.isConstructed?Mn.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}Zb.NAME="OctetStringValueBlock";var ff;class qs extends Ft{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},Zb),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(i.byteLength){const o=Zl(i,0,i.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return ki.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=Ye.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof ff&&e.push(t.valueBlock.valueHexView);return Be.concat(e)}}ff=qs;Z.OctetString=ff;qs.NAME=Rb;class jb extends mn(Mn){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let s=-1;if(this.isConstructed){if(s=Mn.prototype.fromBER.call(this,e,t,n),s===-1)return s;for(const l of this.value){const c=l.constructor.NAME;if(c===So){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==Bb)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const d=l.valueBlock;if(this.unusedBits>0&&d.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=d.unusedBits}return s}const i=Be.toUint8Array(e);if(!gn(this,i,t,n))return-1;const o=i.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const l=o.subarray(1);try{if(l.byteLength){const c=Zl(l,0,l.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return Mn.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength){const s=new Uint8Array(1);return s[0]=0,s.buffer}const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}jb.NAME="BitStringValueBlock";var Qb;class Jb extends Ft{constructor({idBlock:e={},lenBlock:t={},...n}={}){var s,i;(s=n.isConstructed)!==null&&s!==void 0||(n.isConstructed=!!(!((i=n.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},jb),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return ki.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),s=this.constructor.NAME,i=n.substring(0,n.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}}Qb=Jb;Z.BitString=Qb;Jb.NAME=Bb;var ev;function qP(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),s=new Uint8Array(e);let i=n.slice(0);const o=i.length-1,l=s.slice(0),c=l.length-1;let d=0;const f=c<o?o:c;let a=0;for(let u=f;u>=0;u--,a++)!0===a<l.length?d=i[o-a]+l[c-a]+t[0]:d=i[o-a]+t[0],t[0]=d/10,!0===a>=i.length?i=Ru(new Uint8Array([d%10]),i):i[o-a]=d%10;return t[0]>0&&(i=Ru(t,i)),i}function wp(r){if(r>=Ni.length)for(let e=Ni.length;e<=r;e++){const t=new Uint8Array([0]);let n=Ni[e-1].slice(0);for(let s=n.length-1;s>=0;s--){const i=new Uint8Array([(n[s]<<1)+t[0]]);t[0]=i[0]/10,n[s]=i[0]%10}t[0]>0&&(n=Ru(t,n)),Ni.push(n)}return Ni[r]}function HP(r,e){let t=0;const n=new Uint8Array(r),s=new Uint8Array(e),i=n.slice(0),o=i.length-1,l=s.slice(0),c=l.length-1;let d,f=0;for(let a=c;a>=0;a--,f++)d=i[o-f]-l[c-f]-t,!0===d<0?(t=1,i[o-f]=d+10):(t=0,i[o-f]=d);if(t>0)for(let a=o-c+1;a>=0;a--,f++)if(d=i[o-f]-t,d<0)t=1,i[o-f]=d+10;else{t=0,i[o-f]=d;break}return i.slice()}class hf extends mn(Gt){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=Lb.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(FP(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,s=0){const i=this.fromBER(e,t,n);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&(o[1]&128)!==0?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const s=super.fromBER(e,t,n);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,s;const i=this.valueHexView;let o="",l=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let d=0;d<8;d++)(s&1)===1&&(n===e?(t=HP(wp(n),t),o="-"):t=qP(t,wp(n))),n++,s>>=1}for(let c=0;c<t.length;c++)t[c]&&(l=!0),l&&(o+=vp.charAt(t[c]));return l===!1&&(o+=vp.charAt(0)),o}}ev=hf;hf.NAME="IntegerValueBlock";Object.defineProperty(ev.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var eo;class js extends Ft{constructor(e={}){super(e,hf),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return cl(),BigInt(this.valueBlock.toString())}static fromBigInt(e){cl();const t=BigInt(e),n=new uf,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(Ye.FromHex(s));if(t<0){const l=new Uint8Array(i.length+(i[0]&128?1:0));l[0]|=128;const d=BigInt(`0x${Ye.ToHex(l)}`)+t,f=Be.toUint8Array(Ye.FromHex(d.toString(16)));f[0]|=128,n.write(f)}else i[0]&128&&n.write(new Uint8Array([0])),n.write(i);return new eo({valueHex:n.final()})}convertToDER(){const e=new eo({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new eo({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}eo=js;Z.Integer=eo;js.NAME="INTEGER";var tv;class rv extends js{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}tv=rv;Z.Enumerated=tv;rv.NAME="ENUMERATED";class Bu extends mn(Gt){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let l=0;l<n&&(this.valueHexView[l]=i[l]&127,this.blockLength++,(i[l]&128)!==0);l++);const o=new Uint8Array(this.blockLength);for(let l=0;l<this.blockLength;l++)o[l]=this.valueHexView[l];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=mi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){cl();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let s=0;s<n.length;s++)n[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Es(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Fr;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n}toString(){let e="";if(this.isHexOnly)e=Ye.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Bu.NAME="sidBlock";class nv extends Gt{constructor({value:e=Ii,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new Bu;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const s=this.value[n].toBER(e);if(s.byteLength===0)return this.error=this.value[n].error,Fr;t.push(s)}return cf(t)}fromString(e){this.value=[];let t=0,n=0,s="",i=!1;do if(n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1,i){const o=this.value[0];let l=0;switch(o.valueDec){case 0:break;case 1:l=40;break;case 2:l=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+l,i=!1}else{const o=new Bu;if(s>Number.MAX_SAFE_INTEGER){cl();const l=BigInt(s);o.valueBigInt=l}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[n].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}nv.NAME="ObjectIdentifierValueBlock";var sv;class Qn extends Ft{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,nv),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}sv=Qn;Z.ObjectIdentifier=sv;Qn.NAME="OBJECT IDENTIFIER";class Nu extends mn(Cs){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const s=Be.toUint8Array(e);if(!gn(this,s,t,n))return-1;const i=s.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let l=0;l<n&&(this.valueHexView[l]=i[l]&127,this.blockLength++,(i[l]&128)!==0);l++);const o=new Uint8Array(this.blockLength);for(let l=0;l<this.blockLength;l++)o[l]=this.valueHexView[l];return this.valueHexView=o,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=mi(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=Es(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Fr;const n=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let o=0;o<i;o++)n[o]=s[o]|128;n[i]=s[i]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Ye.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Nu.NAME="relativeSidBlock";class iv extends Gt{constructor({value:e=Ii,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let s=t;for(;n>0;){const i=new Nu;if(s=i.fromBER(e,s,n),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,n-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const n=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,Fr;n.push(i)}return cf(n)}fromString(e){this.value=[];let t=0,n=0,s="";do{n=e.indexOf(".",t),n===-1?s=e.substring(t):s=e.substring(t,n),t=n+1;const i=new Nu;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let s=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}iv.NAME="RelativeObjectIdentifierValueBlock";var ov;class av extends Ft{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,iv),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}ov=av;Z.RelativeObjectIdentifier=ov;av.NAME="RelativeObjectIdentifier";var lv;class br extends ki{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}lv=br;Z.Sequence=lv;br.NAME="SEQUENCE";var cv;let uv=class extends ki{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};cv=uv;Z.Set=cv;uv.NAME="SET";class dv extends mn(Gt){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=Ii}toJSON(){return{...super.toJSON(),value:this.value}}}dv.NAME="StringValueBlock";class fv extends dv{}fv.NAME="SimpleStringValueBlock";class rr extends $b{constructor({...e}={}){super(e,fv)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Be.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)n[s]=e.charCodeAt(s);this.valueBlock.value=e}}rr.NAME="SIMPLE STRING";class hv extends rr{fromBuffer(e){this.valueBlock.valueHexView=Be.toUint8Array(e);try{this.valueBlock.value=Ye.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Ye.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Ye.FromUtf8String(e)),this.valueBlock.value=e}}hv.NAME="Utf8StringValueBlock";var pv;class Ts extends hv{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}pv=Ts;Z.Utf8String=pv;Ts.NAME="UTF8String";class gv extends rr{fromBuffer(e){this.valueBlock.value=Ye.ToUtf16String(e),this.valueBlock.valueHexView=Be.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Ye.FromUtf16String(e))}}gv.NAME="BmpStringValueBlock";var mv;class yv extends gv{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}mv=yv;Z.BmpString=mv;yv.NAME="BMPString";class bv extends rr{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let s=0;s<n.length;s+=4)n[s]=n[s+3],n[s+1]=n[s+2],n[s+2]=0,n[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=Es(e.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const l=4-o.length;for(let c=o.length-1;c>=0;c--)n[s*4+c+l]=o[c]}this.valueBlock.value=e}}bv.NAME="UniversalStringValueBlock";var vv;class wv extends bv{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}vv=wv;Z.UniversalString=vv;wv.NAME="UniversalString";var _v;class Sv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}_v=Sv;Z.NumericString=_v;Sv.NAME="NumericString";var Ev;class xv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}Ev=xv;Z.PrintableString=Ev;xv.NAME="PrintableString";var Av;class Iv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}Av=Iv;Z.TeletexString=Av;Iv.NAME="TeletexString";var kv;class Cv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}kv=Cv;Z.VideotexString=kv;Cv.NAME="VideotexString";var Tv;class Pv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}Tv=Pv;Z.IA5String=Tv;Pv.NAME="IA5String";var Dv;class Lv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}Dv=Lv;Z.GraphicString=Dv;Lv.NAME="GraphicString";var Rv;class pf extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}Rv=pf;Z.VisibleString=Rv;pf.NAME="VisibleString";var Bv;class Nv extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}Bv=Nv;Z.GeneralString=Bv;Nv.NAME="GeneralString";var Mv;class Ov extends rr{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}Mv=Ov;Z.CharacterString=Mv;Ov.NAME="CharacterString";var $v;class gf extends pf{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Be.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const s=parseInt(n[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=jt(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=jt(this.month,2),t[2]=jt(this.day,2),t[3]=jt(this.hour,2),t[4]=jt(this.minute,2),t[5]=jt(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}$v=gf;Z.UTCTime=$v;gf.NAME="UTCTime";var Fv;class Uv extends gf{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",s="",i=0,o,l=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const a=new Number(e[e.length-1]);if(isNaN(a.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let a=1,u=n.indexOf("+"),h="";if(u===-1&&(u=n.indexOf("-"),a=-1),u!==-1){if(h=n.substring(u+1),n=n.substring(0,u),h.length!==2&&h.length!==4)throw new Error("Wrong input string for conversion");let p=parseInt(h.substring(0,2),10);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");if(l=a*p,h.length===4){if(p=parseInt(h.substring(2,4),10),isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");c=a*p}}}let d=n.indexOf(".");if(d===-1&&(d=n.indexOf(",")),d!==-1){const a=new Number(`0${n.substring(d)}`);if(isNaN(a.valueOf()))throw new Error("Wrong input string for conversion");i=a.valueOf(),s=n.substring(0,d)}else s=n;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,d!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,d!==-1){let a=60*i;this.minute=Math.floor(a),a=60*(a-this.minute),this.second=Math.floor(a),a=1e3*(a-this.second),this.millisecond=Math.floor(a)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,d!==-1){let a=60*i;this.second=Math.floor(a),a=1e3*(a-this.second),this.millisecond=Math.floor(a)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,d!==-1){const a=1e3*i;this.millisecond=Math.floor(a)}break;default:throw new Error("Wrong input string for conversion")}const f=o.exec(s);if(f===null)throw new Error("Wrong input string for conversion");for(let a=1;a<f.length;a++)switch(a){case 1:this.year=parseInt(f[a],10);break;case 2:this.month=parseInt(f[a],10);break;case 3:this.day=parseInt(f[a],10);break;case 4:this.hour=parseInt(f[a],10)+l;break;case 5:this.minute=parseInt(f[a],10)+c;break;case 6:this.second=parseInt(f[a],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const a=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=a.getUTCFullYear(),this.month=a.getUTCMonth(),this.day=a.getUTCDay(),this.hour=a.getUTCHours(),this.minute=a.getUTCMinutes(),this.second=a.getUTCSeconds(),this.millisecond=a.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(jt(this.year,4)),t.push(jt(this.month,2)),t.push(jt(this.day,2)),t.push(jt(this.hour,2)),t.push(jt(this.minute,2)),t.push(jt(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(jt(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}Fv=Uv;Z.GeneralizedTime=Fv;Uv.NAME="GeneralizedTime";var Vv;class Kv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}Vv=Kv;Z.DATE=Vv;Kv.NAME="DATE";var qv;class Hv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}qv=Hv;Z.TimeOfDay=qv;Hv.NAME="TimeOfDay";var zv;class Wv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}zv=Wv;Z.DateTime=zv;Wv.NAME="DateTime";var Gv;class Yv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}Gv=Yv;Z.Duration=Gv;Yv.NAME="Duration";var Xv;class Zv extends Ts{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}Xv=Zv;Z.TIME=Xv;Zv.NAME="TIME";const zP=16,Mu=32,Ou=1e4;async function jl(r,e){const n=await Db().encrypt(r,e);return Do.encode(n)}async function _p(r,e,t){if(r.type==="RSA")return XP(r,e,t);if(r.type==="Ed25519")return WP(r,e,t);if(r.type==="secp256k1")return GP(r,e,t);if(r.type==="ECDSA")return YP(r,e,t);throw new Ir}async function WP(r,e,t="libp2p-key"){if(t==="libp2p-key")return jl(qo(r),e);throw new V(`export format '${t}' is not supported`)}async function GP(r,e,t="libp2p-key"){if(t==="libp2p-key")return jl(qo(r),e);throw new V("Export format is not supported")}async function YP(r,e,t="libp2p-key"){if(t==="libp2p-key")return jl(qo(r),e);throw new V(`export format '${t}' is not supported`)}async function XP(r,e,t="pkcs-8"){if(t==="pkcs-8")return ZP(r,e);if(t==="libp2p-key")return jl(qo(r),e);throw new V("Export format is not supported")}async function ZP(r,e){const t=Ot.get(),s=new br({value:[new js({value:0}),new br({value:[new Qn({value:"1.2.840.113549.1.1.1"}),new ul]}),new qs({valueHex:r.raw})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=li(zP),l=await Uy(Ul,e,o,{c:Ou,dkLen:Mu}),c=li(16),d=await t.subtle.importKey("raw",l,"AES-CBC",!1,["encrypt"]),f=await t.subtle.encrypt({name:"AES-CBC",iv:c},d,i),a=new br({value:[new qs({valueHex:o}),new js({value:Ou}),new js({value:Mu}),new br({value:[new Qn({value:"1.2.840.113549.2.11"}),new ul]})]}),u=new br({value:[new Qn({value:"1.2.840.113549.1.5.13"}),new br({value:[new br({value:[new Qn({value:"1.2.840.113549.1.5.12"}),a]}),new br({value:[new Qn({value:"2.16.840.1.101.3.4.1.42"}),new qs({valueHex:c})]})]})]}),p=new br({value:[u,new qs({valueHex:f})]}).toBER(),y=new Uint8Array(p,0,p.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...W(y,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Sp(r,e){try{const t=await jP(r,e);return FI(t)}catch{}if(!r.includes("BEGIN"))throw new V("Encrypted key was not a libp2p-key or a PEM file");return QP(r,e)}async function jP(r,e){const t=Do.decode(r);return Db().decrypt(t,e)}async function QP(r,e){const t=Ot.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const i=j(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ic(i),{iv:l,salt:c,iterations:d,keySize:f,cipherText:a}=JP(o),u=await Uy(Ul,e,c,{c:d,dkLen:f}),h=await t.subtle.importKey("raw",u,"AES-CBC",!1,["decrypt"]),p=to(await t.subtle.decrypt({name:"AES-CBC",iv:l},h,a)),{result:y}=Ic(p);n=Ep(y)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const i=j(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=Ic(i);n=Ep(o)}else throw new V("Could not parse private key from PEM data");const s=UI(n);if(s.type!=="RSA")throw new V("Could not parse RSA private key from PEM data");return s}function JP(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new V("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new V("Only pkcs5PBKDF2 key derivation functions are supported");const i=n.valueBlock.value[1],o=to(i.valueBlock.value[0].getValue());let l=Ou,c=Mu;if(i.valueBlock.value.length===3)l=Number(i.valueBlock.value[1].toBigInt()),c=Number(i.valueBlock.value[2].toBigInt());else if(i.valueBlock.value.length===2)throw new V("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const d=e.valueBlock.value[1].valueBlock.value[1],f=d.valueBlock.value[0].toString();if(f!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(f!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(f!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new V("Only AES-CBC encryption schemes are supported")}}}}const a=to(d.valueBlock.value[1].getValue());return{cipherText:to(r.valueBlock.value[1].getValue()),salt:o,iterations:l,keySize:c,iv:a}}function Ep(r){return to(r.valueBlock.value[2].getValue())}function to(r){return new Uint8Array(r,0,r.byteLength)}const eD="/pkcs8/",$u="/info/",Mi=new WeakMap,Xn={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3};function Ms(r){return r==null||typeof r!="string"?!1:r===BP(r.trim())&&r.length>0}async function mt(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Zn(r){return new je(eD+r)}function Os(r){return new je($u+r)}async function tD(r){const e=qo(r),t=await pr.digest(e);return Pe.encode(t.bytes).substring(1)}class rD{components;init;log;self;constructor(e,t){if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init={...t,dek:{...yp,...t.dek}},this.self=t.selfKey??"self",this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Xn.minKeyLength)throw new Error(`dek.keyLength must be least ${Xn.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Xn.minSaltLength)throw new Error(`dek.saltLength must be least ${Xn.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Xn.minIterationCount)throw new Error(`dek.iterationCount must be least ${Xn.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?$h(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Mi.set(this,{dek:n})}[Symbol.toStringTag]="@libp2p/keychain";[xr]=["@libp2p/keychain"];static generateOptions(){const e=Object.assign({},this.options),t=Math.ceil(Xn.minSaltLength/3)*3;return e.dek!=null&&(e.dek.salt=W(li(t),"base64")),e}static get options(){return{dek:{...yp}}}async findKeyByName(e){if(!Ms(e))throw await mt(),new V(`Invalid key name '${e}'`);const t=Os(e);try{const n=await this.components.datastore.get(t);return JSON.parse(W(n))}catch(n){throw await mt(),this.log.error("could not read key from datastore - %e",n),new $a(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:$u};for await(const n of this.components.datastore.query(t)){const s=JSON.parse(W(n.value));if(s.id===e)return s}throw new V(`Key with id '${e}' does not exist.`)}catch(t){throw await mt(),t}}async importKey(e,t){if(!Ms(e))throw await mt(),new V(`Invalid key name '${e}'`);if(t==null)throw await mt(),new V("Key is required");const n=Zn(e);if(await this.components.datastore.has(n))throw await mt(),new V(`Key '${e}' already exists`);let i,o;try{i=await tD(t);const d=Mi.get(this);if(d==null)throw new V("dek missing");const f=d.dek;o=await _p(t,f,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(d){throw await mt(),d}const l={name:e,id:i},c=this.components.datastore.batch();return c.put(n,j(o)),c.put(Os(e),j(JSON.stringify(l))),await c.commit(),l}async exportKey(e){if(!Ms(e))throw await mt(),new V(`Invalid key name '${e}'`);const t=Zn(e);try{const n=await this.components.datastore.get(t),s=W(n),i=Mi.get(this);if(i==null)throw new V("dek missing");const o=i.dek;return await Sp(s,o)}catch(n){throw await mt(),n}}async removeKey(e){if(!Ms(e)||e===this.self)throw await mt(),new V(`Invalid key name '${e}'`);const t=Zn(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Os(e)),await s.commit(),n}async listKeys(){const e={prefix:$u},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(W(n.value)));return t}async renameKey(e,t){if(!Ms(e)||e===this.self)throw await mt(),new V(`Invalid old key name '${e}'`);if(!Ms(t)||t===this.self)throw await mt(),new V(`Invalid new key name '${t}'`);const n=Zn(e),s=Zn(t),i=Os(e),o=Os(t);if(await this.components.datastore.has(s))throw await mt(),new V(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),d=await this.components.datastore.get(i),f=JSON.parse(W(d));f.name=t;const a=this.components.datastore.batch();return a.put(s,c),a.put(o,j(JSON.stringify(f))),a.delete(n),a.delete(i),await a.commit(),f}catch(c){throw await mt(),c}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await mt(),new V(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await mt(),new V(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await mt(),new V(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=Mi.get(this);if(n==null)throw new V("dek missing");const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?$h(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Mi.set(this,{dek:i});const o=await this.listKeys();for(const l of o){const c=await this.components.datastore.get(Zn(l.name)),d=W(c),f=await Sp(d,s),a=i.toString(),u=await _p(f,a,f.type==="RSA"?"pkcs-8":"libp2p-key"),h=this.components.datastore.batch(),p={name:l.name,id:l.id};h.put(Zn(l.name),j(u)),h.put(Os(l.name),j(JSON.stringify(p))),await h.commit()}this.log("keychain reconstructed")}}function jv(r={}){return e=>new rD(e,r)}async function nD(r,e={}){const t=e.selfKey??"self",n=jv(e)({datastore:r,logger:cd()});let s;return await r.has(new je(`/pkcs8/${t}`))?s=await n.exportKey(t):(s=await Oy(e.keyType??"Ed25519"),await n.importKey(t,s)),s}const sD=Symbol.for("@libp2p/pubsub");var kc={exports:{}},xp;function iD(){return xp||(xp=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(c,d,f){this.fn=c,this.context=d,this.once=f||!1}function i(c,d,f,a,u){if(typeof f!="function")throw new TypeError("The listener must be a function");var h=new s(f,a||c,u),p=t?t+d:d;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],h]:c._events[p].push(h):(c._events[p]=h,c._eventsCount++),c}function o(c,d){--c._eventsCount===0?c._events=new n:delete c._events[d]}function l(){this._events=new n,this._eventsCount=0}l.prototype.eventNames=function(){var d=[],f,a;if(this._eventsCount===0)return d;for(a in f=this._events)e.call(f,a)&&d.push(t?a.slice(1):a);return Object.getOwnPropertySymbols?d.concat(Object.getOwnPropertySymbols(f)):d},l.prototype.listeners=function(d){var f=t?t+d:d,a=this._events[f];if(!a)return[];if(a.fn)return[a.fn];for(var u=0,h=a.length,p=new Array(h);u<h;u++)p[u]=a[u].fn;return p},l.prototype.listenerCount=function(d){var f=t?t+d:d,a=this._events[f];return a?a.fn?1:a.length:0},l.prototype.emit=function(d,f,a,u,h,p){var y=t?t+d:d;if(!this._events[y])return!1;var g=this._events[y],m=arguments.length,w,v;if(g.fn){switch(g.once&&this.removeListener(d,g.fn,void 0,!0),m){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,f),!0;case 3:return g.fn.call(g.context,f,a),!0;case 4:return g.fn.call(g.context,f,a,u),!0;case 5:return g.fn.call(g.context,f,a,u,h),!0;case 6:return g.fn.call(g.context,f,a,u,h,p),!0}for(v=1,w=new Array(m-1);v<m;v++)w[v-1]=arguments[v];g.fn.apply(g.context,w)}else{var _=g.length,k;for(v=0;v<_;v++)switch(g[v].once&&this.removeListener(d,g[v].fn,void 0,!0),m){case 1:g[v].fn.call(g[v].context);break;case 2:g[v].fn.call(g[v].context,f);break;case 3:g[v].fn.call(g[v].context,f,a);break;case 4:g[v].fn.call(g[v].context,f,a,u);break;default:if(!w)for(k=1,w=new Array(m-1);k<m;k++)w[k-1]=arguments[k];g[v].fn.apply(g[v].context,w)}}return!0},l.prototype.on=function(d,f,a){return i(this,d,f,a,!1)},l.prototype.once=function(d,f,a){return i(this,d,f,a,!0)},l.prototype.removeListener=function(d,f,a,u){var h=t?t+d:d;if(!this._events[h])return this;if(!f)return o(this,h),this;var p=this._events[h];if(p.fn)p.fn===f&&(!u||p.once)&&(!a||p.context===a)&&o(this,h);else{for(var y=0,g=[],m=p.length;y<m;y++)(p[y].fn!==f||u&&!p[y].once||a&&p[y].context!==a)&&g.push(p[y]);g.length?this._events[h]=g.length===1?g[0]:g:o(this,h)}return this},l.prototype.removeAllListeners=function(d){var f;return d?(f=t?t+d:d,this._events[f]&&o(this,f)):(this._events=new n,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=t,l.EventEmitter=l,r.exports=l})(kc)),kc.exports}var oD=iD();const aD=ad(oD);class mf extends Error{name="TimeoutError";constructor(e,t){super(e,t),Error.captureStackTrace?.(this,mf)}}const Ap=r=>r.reason??new DOMException("This operation was aborted.","AbortError");function lD(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout},signal:o}=e;let l,c;const f=new Promise((a,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(o?.aborted){u(Ap(o));return}if(o&&(c=()=>{u(Ap(o))},o.addEventListener("abort",c,{once:!0})),r.then(a,u),t===Number.POSITIVE_INFINITY)return;const h=new mf;l=i.setTimeout.call(void 0,()=>{if(n){try{a(n())}catch(p){u(p)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?a():s instanceof Error?u(s):(h.message=s??`Promise timed out after ${t} milliseconds`,u(h))},t)}).finally(()=>{f.clear(),c&&o&&o.removeEventListener("abort",c)});return f.clear=()=>{i.clearTimeout.call(void 0,l),l=void 0},f}function cD(r,e,t){let n=0,s=r.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}class uD{#e=[];enqueue(e,t){const{priority:n=0,id:s}=t??{},i={priority:n,id:s,run:e};if(this.size===0||this.#e[this.size-1].priority>=n){this.#e.push(i);return}const o=cD(this.#e,i,(l,c)=>c.priority-l.priority);this.#e.splice(o,0,i)}setPriority(e,t){const n=this.#e.findIndex(i=>i.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(n,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}}class Qv extends aD{#e;#r;#t=0;#n;#i=!1;#a=!1;#s;#h=0;#p=0;#d;#g;#f;#l=[];#c=0;#o;#m;#u=0;#_;#b;#E=1n;#y=new Map;timeout;constructor(e){if(super(),e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:uD,strict:!1,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(e.strict&&e.interval===0)throw new TypeError("The `strict` option requires a non-zero `interval`");if(e.strict&&e.intervalCap===Number.POSITIVE_INFINITY)throw new TypeError("The `strict` option requires a finite `intervalCap`");if(this.#e=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#r=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#n=e.intervalCap,this.#s=e.interval,this.#f=e.strict,this.#o=new e.queueClass,this.#m=e.queueClass,this.concurrency=e.concurrency,e.timeout!==void 0&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#b=e.autoStart===!1,this.#U()}#v(e){for(;this.#c<this.#l.length;){const n=this.#l[this.#c];if(n!==void 0&&e-n>=this.#s)this.#c++;else break}(this.#c>100&&this.#c>this.#l.length/2||this.#c===this.#l.length)&&(this.#l=this.#l.slice(this.#c),this.#c=0)}#x(e){this.#f?this.#l.push(e):this.#t++}#B(){this.#f?this.#l.length>this.#c&&this.#l.pop():this.#t>0&&this.#t--}#A(){return this.#l.length-this.#c}get#N(){return this.#r?!0:this.#f?this.#A()<this.#n:this.#t<this.#n}get#M(){return this.#u<this.#_}#O(){this.#u--,this.#u===0&&this.emit("pendingZero"),this.#C(),this.emit("next")}#$(){this.#g=void 0,this.#L(),this.#D()}#F(e){if(this.#f){if(this.#v(e),this.#A()>=this.#n){const n=this.#l[this.#c],s=this.#s-(e-n);return this.#I(s),!0}return!1}if(this.#d===void 0){const t=this.#h-e;if(t<0){if(this.#p>0){const n=e-this.#p;if(n<this.#s)return this.#I(this.#s-n),!0}this.#t=this.#e?this.#u:0}else return this.#I(t),!0}return!1}#I(e){this.#g===void 0&&(this.#g=setTimeout(()=>{this.#$()},e))}#k(){this.#d&&(clearInterval(this.#d),this.#d=void 0)}#P(){this.#g&&(clearTimeout(this.#g),this.#g=void 0)}#C(){if(this.#o.size===0){if(this.#k(),this.emit("empty"),this.#u===0){if(this.#P(),this.#f&&this.#c>0){const t=Date.now();this.#v(t)}this.emit("idle")}return!1}let e=!1;if(!this.#b){const t=Date.now(),n=!this.#F(t);if(this.#N&&this.#M){const s=this.#o.dequeue();this.#r||(this.#x(t),this.#S()),this.emit("active"),s(),n&&this.#D(),e=!0}}return e}#D(){this.#r||this.#d!==void 0||this.#f||(this.#d=setInterval(()=>{this.#L()},this.#s),this.#h=Date.now()+this.#s)}#L(){this.#f||(this.#t===0&&this.#u===0&&this.#d&&this.#k(),this.#t=this.#e?this.#u:0),this.#T(),this.#S()}#T(){for(;this.#C(););}get concurrency(){return this.#_}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#_=e,this.#T()}setPriority(e,t){if(typeof t!="number"||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#o.setPriority(e,t)}async add(e,t={}){return t={timeout:this.timeout,...t,id:t.id??(this.#E++).toString()},new Promise((n,s)=>{const i=Symbol(`task-${t.id}`);this.#o.enqueue(async()=>{this.#u++,this.#y.set(i,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});let o;try{try{t.signal?.throwIfAborted()}catch(d){throw this.#V(),this.#y.delete(i),d}this.#p=Date.now();let l=e({signal:t.signal});if(t.timeout&&(l=lD(Promise.resolve(l),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#u} running, ${this.#o.size} waiting)`})),t.signal){const{signal:d}=t;l=Promise.race([l,new Promise((f,a)=>{o=()=>{a(d.reason)},d.addEventListener("abort",o,{once:!0})})])}const c=await l;n(c),this.emit("completed",c)}catch(l){s(l),this.emit("error",l)}finally{o&&t.signal?.removeEventListener("abort",o),this.#y.delete(i),queueMicrotask(()=>{this.#O()})}},t),this.emit("add"),this.#C()})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return this.#b?(this.#b=!1,this.#T(),this):this}pause(){this.#b=!0}clear(){this.#o=new this.#m,this.#k(),this.#R(),this.emit("empty"),this.#u===0&&(this.#P(),this.emit("idle")),this.emit("next")}async onEmpty(){this.#o.size!==0&&await this.#w("empty")}async onSizeLessThan(e){this.#o.size<e||await this.#w("next",()=>this.#o.size<e)}async onIdle(){this.#u===0&&this.#o.size===0||await this.#w("idle")}async onPendingZero(){this.#u!==0&&await this.#w("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#w("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#w("rateLimitCleared")}onError(){return new Promise((e,t)=>{const n=s=>{this.off("error",n),t(s)};this.on("error",n)})}async#w(e,t){return new Promise(n=>{const s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})}get size(){return this.#o.size}sizeBy(e){return this.#o.filter(e).length}get pending(){return this.#u}get isPaused(){return this.#b}#U(){this.#r||(this.on("add",()=>{this.#o.size>0&&this.#S()}),this.on("next",()=>{this.#S()}))}#S(){this.#r||this.#a||(this.#a=!0,queueMicrotask(()=>{this.#a=!1,this.#R()}))}#V(){this.#r||(this.#B(),this.#S())}#R(){const e=this.#i;if(this.#r||this.#o.size===0){e&&(this.#i=!1,this.emit("rateLimitCleared"));return}let t;if(this.#f){const s=Date.now();this.#v(s),t=this.#A()}else t=this.#t;const n=t>=this.#n;n!==e&&(this.#i=n,this.emit(n?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#i}get isSaturated(){return this.#u===this.#_&&this.#o.size>0||this.isRateLimited&&this.#o.size>0}get runningTasks(){return[...this.#y.values()].map(e=>({...e}))}}class dD{entries;validityMs;lastPruneTime=0;constructor(e){this.entries=new Map,this.validityMs=e.validityMs}put(e,t){this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),this.prune()}prune(){const e=Date.now();if(!(e-this.lastPruneTime<200)){this.lastPruneTime=e;for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries=new Map,this.lastPruneTime=0}}var Eo;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.subscribe=s.bool();break}case 2:{l.topic=s.string();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.SubOpts||(r.SubOpts={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.sequenceNumber!=null&&(i.uint32(26),i.bytes(s.sequenceNumber)),s.topic!=null&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.from=s.bytes();break}case 2:{l.data=s.bytes();break}case 3:{l.sequenceNumber=s.bytes();break}case 4:{l.topic=s.string();break}case 5:{l.signature=s.bytes();break}case 6:{l.key=s.bytes();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Message||(r.Message={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const i of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(i,n);if(t.messages!=null)for(const i of t.messages)n.uint32(18),r.Message.codec().encode(i,n);t.control!=null&&(n.uint32(26),dl.codec().encode(t.control,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.subscriptions!=null&&i.subscriptions.length===s.limits.subscriptions)throw new vt('Decode error - map field "subscriptions" had too many elements');i.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:s.limits?.subscriptions$}));break}case 2:{if(s.limits?.messages!=null&&i.messages.length===s.limits.messages)throw new vt('Decode error - map field "messages" had too many elements');i.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:s.limits?.messages$}));break}case 3:{i.control=dl.codec().decode(t,t.uint32(),{limits:s.limits?.control});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Eo||(Eo={}));var dl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.ihave!=null)for(const i of t.ihave)n.uint32(10),fl.codec().encode(i,n);if(t.iwant!=null)for(const i of t.iwant)n.uint32(18),hl.codec().encode(i,n);if(t.graft!=null)for(const i of t.graft)n.uint32(26),pl.codec().encode(i,n);if(t.prune!=null)for(const i of t.prune)n.uint32(34),gl.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={ihave:[],iwant:[],graft:[],prune:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.ihave!=null&&i.ihave.length===s.limits.ihave)throw new vt('Decode error - map field "ihave" had too many elements');i.ihave.push(fl.codec().decode(t,t.uint32(),{limits:s.limits?.ihave$}));break}case 2:{if(s.limits?.iwant!=null&&i.iwant.length===s.limits.iwant)throw new vt('Decode error - map field "iwant" had too many elements');i.iwant.push(hl.codec().decode(t,t.uint32(),{limits:s.limits?.iwant$}));break}case 3:{if(s.limits?.graft!=null&&i.graft.length===s.limits.graft)throw new vt('Decode error - map field "graft" had too many elements');i.graft.push(pl.codec().decode(t,t.uint32(),{limits:s.limits?.graft$}));break}case 4:{if(s.limits?.prune!=null&&i.prune.length===s.limits.prune)throw new vt('Decode error - map field "prune" had too many elements');i.prune.push(gl.codec().decode(t,t.uint32(),{limits:s.limits?.prune$}));break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(dl||(dl={}));var fl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),t.messageIDs!=null)for(const i of t.messageIDs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={messageIDs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.topic=t.string();break}case 2:{if(s.limits?.messageIDs!=null&&i.messageIDs.length===s.limits.messageIDs)throw new vt('Decode error - map field "messageIDs" had too many elements');i.messageIDs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(fl||(fl={}));var hl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.messageIDs!=null)for(const i of t.messageIDs)n.uint32(10),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={messageIDs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.messageIDs!=null&&i.messageIDs.length===s.limits.messageIDs)throw new vt('Decode error - map field "messageIDs" had too many elements');i.messageIDs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(hl||(hl={}));var pl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();l>>>3===1?i.topic=t.string():t.skipType(l&7)}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(pl||(pl={}));var gl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.topic!=null&&(n.uint32(10),n.string(t.topic)),t.peers!=null)for(const i of t.peers)n.uint32(18),ml.codec().encode(i,n);t.backoff!=null&&(n.uint32(24),n.uint64(t.backoff)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={peers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.topic=t.string();break}case 2:{if(s.limits?.peers!=null&&i.peers.length===s.limits.peers)throw new vt('Decode error - map field "peers" had too many elements');i.peers.push(ml.codec().decode(t,t.uint32(),{limits:s.limits?.peers$}));break}case 3:{i.backoff=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(gl||(gl={}));var ml;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.peerID!=null&&(n.uint32(10),n.bytes(t.peerID)),t.signedPeerRecord!=null&&(n.uint32(18),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.peerID=t.bytes();break}case 2:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(ml||(ml={}));class fD extends Dt{peerId;shutDownController;inboundPb;outboundPb;constructor(e){super(),this.peerId=e,this.shutDownController=new AbortController}attachInboundStream(e,t){this.inboundPb=Un(e,t).pb(Eo),Promise.resolve().then(async()=>{for(;;){if(this.inboundPb==null)return;const n=await this.inboundPb.read({signal:this.shutDownController.signal});this.safeDispatchEvent("message",{detail:n})}}).catch(n=>{this.inboundPb?.unwrap().unwrap().abort(n)})}attachOutboundStream(e,t){this.outboundPb=Un(e,t).pb(Eo)}write(e){this.outboundPb!=null&&this.outboundPb.write(e,{signal:this.shutDownController.signal}).catch(t=>{this.outboundPb?.unwrap().unwrap().abort(t)})}close(){this.shutDownController.abort(),Promise.all([this.inboundPb?.unwrap().unwrap().close().catch(e=>{this.inboundPb?.unwrap().unwrap().abort(e)}),this.outboundPb?.unwrap().unwrap().close().catch(e=>{this.inboundPb?.unwrap().unwrap().abort(e)})]).finally(()=>{this.safeDispatchEvent("close")})}}const Jv=Symbol.for("nodejs.util.inspect.custom"),hD=114;let yf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(hD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Jv](){return`PeerId(${this.toString()})`}},ew=class extends yf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},tw=class extends yf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},rw=class extends yf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const pD=2336;let gD=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[Jv](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(pD,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};function nw(r){if(r.type==="Ed25519")return new tw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new rw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new ew({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function mD(r){return nw(r.publicKey)}function sw(r){if(bD(r))return new ew({multihash:r});if(yD(r))try{const e=Wn(r);if(e.type==="Ed25519")return new tw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new rw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new gD(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function yD(r){return r.code===it.code}function bD(r){return r.code===pr.code}function vD(){return BigInt(`0x${W(li(8),"base16")}`)}const wD=(r,e)=>{const t=j(e.toString(16).padStart(16,"0"),"base16"),n=Sr(r),s=new Uint8Array(n.byteLength+t.length);return s.set(n,0),s.set(t,n.byteLength),s},_D=r=>pr.encode(r),SD=async r=>{if(r.sequenceNumber==null||r.from==null||r.signature==null)return!1;const e=sw(hn(r.from));if(e.publicKey!=null)return!0;if(r.key!=null){const t=r.key;return nw(zn(t)).equals(e)}return!1},ED=async r=>{if(r.from==null)throw new $e("RPC message was missing from");if(!await SD(r))return{type:"unsigned",topic:r.topic??"",data:r.data??new Uint8Array(0)};const e=sw(hn(r.from)),t=r.key??e.publicKey;if(t==null)throw new $e("RPC message was missing public key");return{type:"signed",from:e,topic:r.topic??"",sequenceNumber:AD(r.sequenceNumber??new Uint8Array(0)),data:r.data??new Uint8Array(0),signature:r.signature??new Uint8Array(0),key:t instanceof Uint8Array?zn(t):t}},bf=r=>r.type==="signed"?{from:r.from.toMultihash().bytes,data:r.data,sequenceNumber:xD(r.sequenceNumber),topic:r.topic,signature:r.signature,key:r.key?Sr(r.key):void 0}:{data:r.data,topic:r.topic},xD=r=>{let e=r.toString(16);return e.length%2!==0&&(e=`0${e}`),j(e,"base16")},AD=r=>BigInt(`0x${W(r,"base16")}`),iw=j("libp2p-pubsub:");async function ID(r,e,t){const n={type:"signed",topic:e.topic,data:e.data,sequenceNumber:e.sequenceNumber,from:mD(r)},s=an([iw,t(bf(n)).subarray()]);return n.signature=await r.sign(s),n.key=r.publicKey,n}async function kD(r,e){if(r.type!=="signed")throw new Error('Message type must be "signed" to be verified');if(r.signature==null)throw new Error("Message must contain a signature to be verified");if(r.from==null)throw new Error("Message must contain a from property to be verified");const t=an([iw,e({...bf(r),signature:void 0,key:void 0}).subarray()]);return CD(r).verify(t,r.signature)}function CD(r){if(r.type!=="signed")throw new Error('Message type must be "signed" to have a public key');if(r.from==null)throw new Error("Could not get the public key from the originator id");if(r.key!=null)return r.key;if(r.from.publicKey!=null)return r.from.publicKey;throw new Error("Could not get the public key from the originator id")}class TD extends Dt{log;started;topics;subscriptions;peers;globalSignaturePolicy;canRelayMessage;emitSelf;topicValidators;queue;protocol;components;_registrarTopologyId;maxInboundStreams;maxOutboundStreams;seenCache;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:floodsub"),this.components=e,this.protocol=t.protocol??PD,this.started=!1,this.topics=new Map,this.subscriptions=new Set,this.peers=new ks,this.globalSignaturePolicy=t.globalSignaturePolicy==="StrictNoSign"?"StrictNoSign":"StrictSign",this.canRelayMessage=t.canRelayMessage??!0,this.emitSelf=t.emitSelf??!1,this.topicValidators=new Map,this.queue=new Qv({concurrency:t.messageProcessingConcurrency??10}),this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.seenCache=new dD({validityMs:t?.seenTTL??3e4}),this._onIncomingStream=this._onIncomingStream.bind(this),this._onPeerConnected=this._onPeerConnected.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this)}[sD]=!0;[Symbol.toStringTag]="@libp2p/floodsub";[xr]=["@libp2p/pubsub"];[Va]=["@libp2p/identify"];async start(){this.started||(this.log("starting"),await this.components.registrar.handle(this.protocol,this._onIncomingStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this._registrarTopologyId=await this.components.registrar.register(this.protocol,{onConnect:this._onPeerConnected,onDisconnect:this._onPeerDisconnected}),this.log("started"),this.started=!0)}async stop(){if(!this.started)return;const e=this.components.registrar;this._registrarTopologyId!=null&&e.unregister(this._registrarTopologyId),await e.unhandle(this.protocol),this.log("stopping");for(const t of this.peers.values())t.close();this.peers.clear(),this.subscriptions=new Set,this.started=!1,this.log("stopped")}isStarted(){return this.started}_onIncomingStream(e,t){this.addPeer(t.remotePeer,e).attachInboundStream(e)}async _onPeerConnected(e,t){if(this.log("connected %p",e),t.streams.find(i=>i.direction==="outbound"&&i.protocol===this.protocol)){this.log("outbound pubsub stream already present on connection from %p",e);return}const n=await t.newStream(this.protocol);this.addPeer(e,n).attachOutboundStream(n),this.send(e,{subscriptions:Array.from(this.subscriptions).map(i=>i.toString()),subscribe:!0})}_onPeerDisconnected(e,t){this.log("connection ended %p",e),this._removePeer(e)}addPeer(e,t){const n=this.peers.get(e);if(n!=null)return n;this.log("new peer %p",e);const s=new fD(e);return this.peers.set(e,s),s.addEventListener("message",i=>{const o=i.detail,l=[];for(const c of o.messages??[]){if(c.from==null||c.data==null||c.topic==null){this.log("message from %p was missing from, data or topic fields, dropping",e);continue}l.push({from:c.from,data:c.data,topic:c.topic,sequenceNumber:c.sequenceNumber??void 0,signature:c.signature??void 0,key:c.key??void 0})}this.processRpc(s,{subscriptions:(o.subscriptions??[]).map(c=>({subscribe:!!c.subscribe,topic:c.topic??""})),messages:l}).catch(c=>{this.log(c)})}),s.addEventListener("close",()=>this._removePeer(e),{once:!0}),s}_removePeer(e){const t=this.peers.get(e);if(t!=null){t.close(),this.log("delete peer %p",e),this.peers.delete(e);for(const n of this.topics.values())n.delete(e)}}async processRpc(e,t){this.log("rpc from %p",e.peerId);const{subscriptions:n,messages:s}=t;return n!=null&&n.length>0&&(this.log("subscription update from %p",e.peerId),n.forEach(i=>{this.processRpcSubOpt(e.peerId,i)}),super.dispatchEvent(new CustomEvent("subscription-change",{detail:{peerId:e.peerId,subscriptions:n.map(({topic:i,subscribe:o})=>({topic:`${i??""}`,subscribe:!!o}))}}))),s!=null&&s.length>0&&(this.log("messages from %p",e.peerId),this.queue.addAll(s.map(i=>async()=>{if(i.topic==null||!this.subscriptions.has(i.topic)&&!this.canRelayMessage)return this.log("received message we didn't subscribe to. Dropping."),!1;try{const o=await ED(i);await this.processMessage(e.peerId,o)}catch(o){this.log.error("failed to queue messages from %p - %e",e.peerId,o)}})).catch(i=>{this.log(i)})),!0}processRpcSubOpt(e,t){const n=t.topic;if(n==null)return;let s=this.topics.get(n);s==null&&(s=new ps,this.topics.set(n,s)),t.subscribe===!0?s.add(e):s.delete(e)}async processMessage(e,t){if(this.components.peerId.equals(e)&&!this.emitSelf)return;const n=await this.getMsgId(t),s=W(n,"base64");if(!this.seenCache.has(s)){this.seenCache.put(s,!0);try{await this.validate(e,t)}catch(i){this.log("Message is invalid, dropping it. %O",i);return}this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.emitSelf)&&super.dispatchEvent(new CustomEvent("message",{detail:t})),await this.publishMessage(e,t)}}getMsgId(e){switch(this.globalSignaturePolicy){case"StrictSign":if(e.type!=="signed")throw new $e('Message type should be "signed" when signature policy is StrictSign but it was not');if(e.sequenceNumber==null)throw new $e("Need sequence number when signature policy is StrictSign but it was missing");if(e.key==null)throw new $e("Need key when signature policy is StrictSign but it was missing");return wD(e.key,e.sequenceNumber);case"StrictNoSign":return _D(e.data);default:throw new $e("Cannot get message id: unhandled signature policy")}}encodeMessage(e){return Eo.Message.encode(e)}send(e,t){const{messages:n,subscriptions:s,subscribe:i}=t;this.sendRpc(e,{subscriptions:(s??[]).map(o=>({topic:o,subscribe:!!i})),messages:(n??[]).map(bf)})}sendRpc(e,t){const n=this.peers.get(e);if(n==null){this.log.error("cannot send RPC to %p as there are no streams to it available",e);return}n.write(t)}async validate(e,t){switch(this.globalSignaturePolicy){case"StrictNoSign":if(t.type!=="unsigned")throw new $e('Message type should be "unsigned" when signature policy is StrictNoSign but it was not');if(t.signature!=null)throw new $e("StrictNoSigning: signature should not be present");if(t.key!=null)throw new $e("StrictNoSigning: key should not be present");if(t.sequenceNumber!=null)throw new $e("StrictNoSigning: seqno should not be present");break;case"StrictSign":if(t.type!=="signed")throw new $e('Message type should be "signed" when signature policy is StrictSign but it was not');if(t.signature==null)throw new $e("StrictSigning: Signing required and no signature was present");if(t.sequenceNumber==null)throw new $e("StrictSigning: Signing required and no sequenceNumber was present");if(!await kD(t,this.encodeMessage.bind(this)))throw new $e("StrictSigning: Invalid message signature");break;default:throw new $e("Cannot validate message: unhandled signature policy")}const s=this.topicValidators.get(t.topic);if(s!=null){const i=await s(e,t);if(i===yl.Reject||i===yl.Ignore)throw new $e("Message validation failed")}}async buildMessage(e){switch(this.globalSignaturePolicy){case"StrictSign":return ID(this.components.privateKey,e,this.encodeMessage.bind(this));case"StrictNoSign":return Promise.resolve({type:"unsigned",...e});default:throw new $e("Cannot build message: unhandled signature policy")}}getSubscribers(e){if(!this.started)throw new uo("not started yet");if(e==null)throw new V("Topic is required");const t=this.topics.get(e.toString());return t==null?[]:Array.from(t.values())}async publish(e,t){if(!this.started)throw new Error("Pubsub has not started");const n={from:this.components.peerId,topic:e,data:t??new Uint8Array(0),sequenceNumber:vD()};this.log("publish topic: %s from: %p data: %m",e,n.from,n.data);const s=await this.buildMessage(n);let i=!1;this.emitSelf&&this.subscriptions.has(e)&&(i=!0,super.dispatchEvent(new CustomEvent("message",{detail:s})));const o=await this.publishMessage(this.components.peerId,s);return i&&(o.recipients=[...o.recipients,this.components.peerId]),o}async publishMessage(e,t){const n=this.getSubscribers(t.topic),s=[];return n==null||n.length===0?(this.log("no peers are subscribed to topic %s",t.topic),{recipients:s}):(n.forEach(i=>{if(this.components.peerId.equals(i)){this.log("not sending message on topic %s to myself",t.topic);return}if(i.equals(e)){this.log("not sending message on topic %s to sender %p",t.topic,i);return}this.log("publish msgs on topics %s %p",t.topic,i),s.push(i),this.send(i,{messages:[t]})}),{recipients:s})}subscribe(e){if(!this.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.log("subscribe to topic: %s",e),this.subscriptions.add(e);for(const t of this.peers.keys())this.send(t,{subscriptions:[e],subscribe:!0})}}unsubscribe(e){if(!this.started)throw new Error("Pubsub is not started");if(this.subscriptions.has(e)){this.log("unsubscribe from %s",e),this.subscriptions.delete(e);for(const t of this.peers.keys())this.send(t,{subscriptions:[e],subscribe:!1})}}getTopics(){if(!this.started)throw new Error("Pubsub is not started");return Array.from(this.subscriptions)}getPeers(){if(!this.started)throw new Error("Pubsub is not started");return Array.from(this.peers.keys())}}const PD="/floodsub/1.0.0";var yl;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(yl||(yl={}));function DD(r={}){return e=>new TD(e,r)}const la=globalThis.CustomEvent??Event;async function*LD(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,s=new EventTarget,i=[];let o=lr(),l=lr(),c=!1,d,f=!1;s.addEventListener("task-complete",()=>{l.resolve()}),Promise.resolve().then(async()=>{try{for await(const p of r){if(i.length===t&&(o=lr(),await o.promise),f)break;const y={done:!1};i.push(y),p().then(g=>{y.done=!0,y.ok=!0,y.value=g,s.dispatchEvent(new la("task-complete"))},g=>{y.done=!0,y.err=g,s.dispatchEvent(new la("task-complete"))})}c=!0,s.dispatchEvent(new la("task-complete"))}catch(p){d=p,s.dispatchEvent(new la("task-complete"))}});function a(){return n?i[0]?.done:!!i.find(p=>p.done)}function*u(){for(;i.length>0&&i[0].done;){const p=i[0];if(i.shift(),p.ok)yield p.value;else throw f=!0,o.resolve(),p.err;o.resolve()}}function*h(){for(;a();)for(let p=0;p<i.length;p++)if(i[p].done){const y=i[p];if(i.splice(p,1),p--,y.ok)yield y.value;else throw f=!0,o.resolve(),y.err;o.resolve()}}for(;;){if(a()||(l=lr(),await l.promise),d!=null||(n?yield*u():yield*h(),d!=null))throw d;if(c&&i.length===0)break}}const RD="0.1.0",BD="id",ND="1.0.0",MD=1024*8;var bl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new vt('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new vt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(bl||(bl={}));const ow=Symbol.for("nodejs.util.inspect.custom"),OD=114;let vf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(OD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[ow](){return`PeerId(${this.toString()})`}},aw=class extends vf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},lw=class extends vf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},cw=class extends vf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const $D=2336;let uw=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[ow](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1($D,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const FD=114,Ip=2336;function UD(r){if(r.type==="Ed25519")return new lw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new cw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new aw({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function VD(r){if(qD(r))return new aw({multihash:r});if(KD(r))try{const e=Wn(r);if(e.type==="Ed25519")return new lw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new cw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new uw(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function dw(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==FD&&r.code!==Ip)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Ip){const e=W(r.multihash.digest);return new uw(new URL(e))}return VD(r.multihash)}function KD(r){return r.code===it.code}function qD(r){return r.code===pr.code}const Gr={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:MD,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function HD(r){if(r!=null&&r.length>0)try{return he(r)}catch{}}async function zD(r,e,t,n,s){if(t("received identify from %p",n.remotePeer),s==null)throw new $e("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:he(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const c=zn(s.publicKey);if(!UD(c).equals(n.remotePeer))throw new $e("public key did not match remote PeerId");i.publicKey=c}let o;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=s.signedPeerRecord;const d=await nn.openAndCertify(c,ur.DOMAIN);let f=ur.createFromProtobuf(d.payload);const a=dw(d.publicKey.toCID());if(!f.peerId.equals(a))throw new $e("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(f.peerId))throw new $e("signing key does not match remote PeerId");let u;try{u=await r.get(f.peerId)}catch(h){if(h.name!=="NotFoundError")throw h}if(u!=null&&(i.metadata=u.metadata,u.peerRecordEnvelope!=null)){const h=nn.createFromProtobuf(u.peerRecordEnvelope),p=ur.createFromProtobuf(h.payload);p.seqNumber>=f.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,f.seqNumber),f=p,c=u.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=f.multiaddrs.map(h=>({isCertified:!0,multiaddr:h})),o={seq:f.seqNumber,addresses:f.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,i),await r.patch(n.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=j(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=j(s.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const l={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>he(c)),observedAddr:s.observedAddr==null?void 0:he(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:l}),l}class WD{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??Gr.timeout,this.maxInboundStreams=t.maxInboundStreams??Gr.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Gr.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Gr.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Gr.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Gr.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Gr.protocolPrefix}/${RD}`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:j(this.host.agentVersion),ProtocolVersion:j(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}}class GD extends WD{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??Gr.protocolPrefix}/${BD}/${ND}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??Gr.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{const s=n.detail;this.identify(s).catch(()=>{})})}[xr]=["@libp2p/identify"];async _identify(e,t={}){let n,s;if(t.signal==null){const i=AbortSignal.timeout(this.timeout);t={...t,signal:i}}this.log("run identify on new connection %a",e.remoteAddr);try{n=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),s=n.log.newScope("identify");const i=Un(n,{maxDataLength:this.maxMessageSize}).pb(bl),o=await i.read(t);return await i.unwrap().unwrap().close(t),o}catch(i){throw s?.error("identify failed - %e",i),n?.abort(i),i}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new $e("Public key was missing from identify message");const l=zn(s),c=dw(l.toCID());if(!e.remotePeer.equals(c))throw new $e("Identified peer does not match the expected peer");if(this.components.peerId.equals(c))throw new $e("Identified peer is our own peer id?");return this.maybeAddObservedAddress(o),this.log("completed for peer %p and protocols %o",c,i),zD(this.components.peerStore,this.components.events,this.log,e,n)}maybeAddObservedAddress(e){const t=HD(e);if(t==null||(this.log.trace("our observed address was %a",t),di(t)))return;const n=t.getComponents();if((n[0].code===_s||n[0].code===Hd&&n[1].code===_s)&&!fk(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}el.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t))}async handleProtocol(e,t){const n=e.log.newScope("identify");n("responding to identify");const s=AbortSignal.timeout(this.timeout),i=await this.components.peerStore.get(this.components.peerId,{signal:s}),o=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(ce));let l=i.peerRecordEnvelope;if(o.length>0&&l==null){const f=new ur({peerId:this.components.peerId,multiaddrs:o});l=(await nn.seal(f,this.components.privateKey,{signal:s})).marshal().subarray()}let c=t.remoteAddr.bytes;gT.matches(t.remoteAddr)||(c=void 0);const d=Un(e).pb(bl);n("send response"),await d.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Sr(this.components.privateKey.publicKey),listenAddrs:o.map(f=>f.bytes),signedPeerRecord:l,observedAddr:c,protocols:i.protocols},{signal:s}),n("close write"),await d.unwrap().unwrap().close({signal:s})}}function YD(r={}){return e=>new GD(e,r)}const XD=Symbol.for("nodejs.util.inspect.custom"),ZD=114;let wf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(ZD,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[XD](){return`PeerId(${this.toString()})`}},jD=class extends wf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},QD=class extends wf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},JD=class extends wf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function eL(r){if(r.type==="Ed25519")return new QD({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new JD({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new jD({multihash:r.toCID().multihash,publicKey:r});throw new Ir}var Fu;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubkey!=null&&(n.uint32(18),vl.codec().encode(t.pubkey,n)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.id=t.bytes();break}case 2:{i.pubkey=vl.codec().decode(t,t.uint32(),{limits:s.limits?.pubkey});break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Fu||(Fu={}));var xs;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(xs||(xs={}));var Uu;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Uu||(Uu={}));(function(r){r.codec=()=>Ko(Uu)})(xs||(xs={}));var vl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),xs.codec().encode(t.Type,n)),t.Data!=null&&t.Data.byteLength>0&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={Data:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.Type=xs.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(vl||(vl={}));const tL="/plaintext/2.0.0";class rL{protocol=tL;privateKey;log;constructor(e){this.privateKey=e.privateKey,this.log=e.logger.forComponent("libp2p:plaintext")}[Symbol.toStringTag]="@libp2p/plaintext";[xr]=["@libp2p/connection-encryption"];async secureInbound(e,t){return this._encrypt(e,t)}async secureOutbound(e,t){return this._encrypt(e,t)}async _encrypt(e,t){const n=e.log?.newScope("plaintext")??this.log,s=Un(e).pb(Fu);n("write pubkey exchange to peer %p",t?.remotePeer);const i=this.privateKey.publicKey;await s.write({id:i.toMultihash().bytes,pubkey:{Type:xs[i.type],Data:i.raw}},t);const o=await s.read(t);let l;try{if(o.pubkey==null)throw new ac("Public key missing");if(o.pubkey.Data.byteLength===0)throw new ac("Public key data too short");if(o.id==null)throw new ac("Remote id missing");const c=$I(o.pubkey.Data);if(l=eL(c),!pe(l.toMultihash().bytes,o.id))throw new hh("Public key did not match id")}catch(c){throw n.error("invalid public key - %e",c),new hh(`Invalid public key - ${c.message}`)}if(t?.remotePeer!=null&&!l.equals(t?.remotePeer))throw new Qx;return n("plaintext key exchange completed successfully with peer %p",l),{connection:s.unwrap().unwrap(),remotePeer:l}}}function nL(){return r=>new rL(r)}const sL=Symbol.for("nodejs.util.inspect.custom"),iL=114;let _f=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(iL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[sL](){return`PeerId(${this.toString()})`}},oL=class extends _f{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},aL=class extends _f{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},lL=class extends _f{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function cL(r){if(r.type==="Ed25519")return new aL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new lL({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new oL({multihash:r.toCID().multihash,publicKey:r});throw new Ir}var wl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.addrs!=null)for(const i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={publicKey:Ke(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new vt('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(wl||(wl={}));const uL="_peer-discovery._p2p._pubsub";class dL extends Dt{[Fa]=!0;[Symbol.toStringTag]="@libp2p/pubsub-peer-discovery";interval;listenOnly;topics;intervalId;components;log;constructor(e,t={}){super();const{interval:n,topics:s,listenOnly:i}=t;this.components=e,this.interval=n??1e4,this.listenOnly=i??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(s)&&s.length>0?this.topics=s:this.topics=[uL],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.subscribe(t),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const t of this.topics)e.unsubscribe(t),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const t={publicKey:Sr(e.publicKey),addrs:this.components.addressManager.getAddresses().map(i=>i.bytes)},n=wl.encode(t),s=this.components.pubsub;if(s==null)throw new Error("PubSub not configured");for(const i of this.topics){if(s.getSubscribers(i).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",i);continue}this.log("broadcasting our peer data on topic %s",i),s.publish(i,n)}}_onMessage(e){if(!this.isStarted())return;const t=e.detail;if(this.topics.includes(t.topic))try{const n=wl.decode(t.data),s=zn(n.publicKey),i=cL(s);if(i.equals(this.components.peerId))return;this.log("discovered peer %p on %s",i,t.topic),this.safeDispatchEvent("peer",{detail:{id:i,multiaddrs:n.addrs.map(o=>he(o))}})}catch(n){this.log.error("error handling incoming message",n)}}}function fL(r={}){return e=>new dL(e,r)}const hL=[fs,Wd,Xd,Gd,Yd];function kp(r){return fw("sni",r)?.value}function Cp(r){const e=fw("tcp",r)?.value;return e==null?"":`:${e}`}function fw(r,e){return e.find(t=>t.name===r)}function Tp(r){return r.some(({code:e})=>e===hs)}function yr(r,e){const t=hw[r.name];if(t==null)throw new Error(`Can't interpret protocol ${r.name}`);const n=t(r,e);return r.code===_s?`[${n}]`:n}const hw={ip4:(r,e)=>r.value,ip6:(r,e)=>e.length===0?r.value:`[${r.value}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${yr(t,e)}:${r.value}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${yr(t,e)}:${r.value}`},dnsaddr:(r,e)=>r.value,dns4:(r,e)=>r.value,dns6:(r,e)=>r.value,dns:(r,e)=>r.value,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${yr(t,e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${yr(t,e)}`},http:(r,e)=>{const t=Tp(e),n=kp(e),s=Cp(e);if(t&&n!=null)return`https://${n}${s}`;const i=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let l=yr(o,e);return l=l?.replace("tcp://",""),`${i}${l}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=yr(t,e),s=decodeURIComponent(r.value??"");return`${n}${s}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return yr(t,e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return yr(t,e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=yr(t,e);return n=n?.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=Tp(e),n=kp(e),s=Cp(e);if(t&&n!=null)return`wss://${n}${s}`;const i=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let l=yr(o,e);return l=l?.replace("tcp://",""),`${i}${l}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=yr(t,e);return n=n?.replace("tcp://",""),`wss://${n}`}};function pL(r,e){const n=he(r).getComponents(),s=n.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=hw[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let o=i(s,n)??"";return hL.includes(s.code)&&(o=o.replace(/^.*:\/\//,""),s.value==="443"?o=`https://${o}`:o=`http://${o}`),(o.startsWith("http://")||o.startsWith("https://")||o.startsWith("ws://")||o.startsWith("wss://"))&&(o=new URL(o).toString(),o.endsWith("/")&&(o=o.substring(0,o.length-1))),o}function gL(){throw new Error("WebSocket Servers can not be created in the browser!")}const mL=1024*1024*4,yL=10;class bL extends Jy{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??mL,this.checkBufferedAmountTask=db(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??yL),this.websocket.addEventListener("close",t=>{if(this.log('closed - code %d, reason "%s", wasClean %s',t.code,t.reason,t.wasClean),this.checkBufferedAmountTask.stop(),!t.wasClean){this.onRemoteReset();return}this.onTransportClosed()},{once:!0}),this.websocket.addEventListener("message",t=>{try{let n;if(typeof t.data=="string")n=j(t.data);else if(t.data instanceof ArrayBuffer)n=new Uint8Array(t.data,0,t.data.byteLength);else{this.abort(new Error("Incorrect binary type"));return}this.onData(n)}catch(n){this.log.error("error receiving data - %e",n)}})}sendData(e){for(const n of e)this.websocket.send(n);const t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),this.websocket.bufferedAmount===0&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}}function vL(r){return new bL(r)}class wL{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Fm]=!0;[Symbol.toStringTag]="@libp2p/websockets";[xr]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const n=vL({websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval});this.log("new outbound connection %s",n.remoteAddr);const s=await t.upgrader.upgradeOutbound(n,t);return this.log("outbound connection %s upgraded",n.remoteAddr),s}async _connect(e,t){t?.signal?.throwIfAborted();const n=pL(e);this.log("create websocket connection to %s",n);const s=new WebSocket(n);s.binaryType="arraybuffer";try{t.onProgress?.(new nt("websockets:open-connection")),await fr(s,"open",t)}catch(i){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new Jx(`Could not connect to ${n}`);this.metrics?.dialerEvents.increment({error:!0});try{s.close()}catch{}throw i}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),s}createListener(e){return gL({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e.filter(t=>_o.exactMatch(t)||tl.exactMatch(t))}dialFilter(e){return this.listenFilter(e)}}function _L(r={}){return e=>new wL(e,r)}const pw=Symbol.for("nodejs.util.inspect.custom"),SL=114;let Sf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(SL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[pw](){return`PeerId(${this.toString()})`}},gw=class extends Sf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},mw=class extends Sf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},yw=class extends Sf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};const EL=2336;let bw=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[pw](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(EL,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}};const xL=114,Pp=2336;function yi(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=hn(Pe.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return kL(ue.parse(r));throw new V('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return vw(t)}function AL(r){if(r.type==="Ed25519")return new mw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new yw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new gw({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function IL(r){return AL(r.publicKey)}function vw(r){if(TL(r))return new gw({multihash:r});if(CL(r))try{const e=Wn(r);if(e.type==="Ed25519")return new mw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new yw({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new bw(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function kL(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==xL&&r.code!==Pp)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Pp){const e=W(r.multihash.digest);return new bw(new URL(e))}return vw(r.multihash)}function CL(r){return r.code===it.code}function TL(r){return r.code===pr.code}var PL={};async function DL(r){if(r.connectionProtector===null&&PL?.LIBP2P_FORCE_PNET!=null)throw new V("Private network is enforced, but no protector was provided");return r}const ww=Symbol.for("nodejs.util.inspect.custom"),LL=114;class Ef{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[ot]=!0;toString(){return this.string==null&&(this.string=Pe.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return ue.createV1(LL,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return pe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return pe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[ww](){return`PeerId(${this.toString()})`}}class _w extends Ef{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class Sw extends Ef{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class Ew extends Ef{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const RL=2336;class xw{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=it.digest(j(this.url))}[ww](){return`PeerId(${this.url})`}[ot]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return ue.createV1(RL,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=W(e)),e.toString()===this.toString())}}const BL=114,Dp=2336;function NL(r){if(r.type==="Ed25519")return new Sw({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new Ew({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new _w({multihash:r.toCID().multihash,publicKey:r});throw new Ir}function ML(r){if($L(r))return new _w({multihash:r});if(OL(r))try{const e=Wn(r);if(e.type==="Ed25519")return new Sw({multihash:r,publicKey:e});if(e.type==="secp256k1")return new Ew({multihash:r,publicKey:e})}catch{const t=W(r.digest);return new xw(new URL(t))}throw new qn("Supplied PeerID Multihash is invalid")}function Aw(r){if(r?.multihash==null||r.version==null||r.version===1&&r.code!==BL&&r.code!==Dp)throw new Oo("Supplied PeerID CID is invalid");if(r.code===Dp){const e=W(r.multihash.digest);return new xw(new URL(e))}return ML(r.multihash)}function OL(r){return r.code===it.code}function $L(r){return r.code===pr.code}let bi=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Cc(r,e,t,n){const s=new bi(n?.errorMessage);n?.errorCode!=null&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((o,l)=>{function c(){Pc(t,"abort",a),Pc(r,e,d),Pc(r,i,f)}const d=u=>{try{if(n?.filter?.(u)===!1)return}catch(h){c(),l(h);return}c(),o(u)},f=u=>{if(c(),u instanceof Error){l(u);return}l(u.detail??n?.error??new Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},a=()=>{c(),l(s)};Tc(t,"abort",a),Tc(r,e,d),Tc(r,i,f)})}function Tc(r,e,t){r!=null&&(Iw(r)?r.addEventListener(e,t):r.addListener(e,t))}function Pc(r,e,t){r!=null&&(Iw(r)?r.removeEventListener(e,t):r.removeListener(e,t))}function Iw(r){return typeof r.addEventListener=="function"&&typeof r.removeEventListener=="function"}class FL extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class UL{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new bi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function VL(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class KL{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=VL(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>t&&n.signal?.aborted===!0,!0)&&(this.controller.abort(new bi),this.cleanup())}async join(e={}){const t=new UL(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Tt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}function Lp(r,e){let t;const n=function(){const s=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(s,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}class Rp extends Dt{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=Lp(this.emitEmpty.bind(this),1),this.emitIdle=Lp(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new FL;const n=new KL(e,t);return this.enqueue(n),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),n.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:n,result:s}}),s)).catch(s=>{if(n.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===n){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:n,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new bi)}),this.clear()}async onEmpty(e){this.size!==0&&await Cc(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Cc(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Cc(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=ld({objectMode:!0}),n=c=>{c!=null?this.abort():this.clear(),t.end(c)},s=c=>{c.detail!=null&&t.push(c.detail.result)},i=c=>{n(c.detail.error)},o=()=>{n()},l=()=>{n(new bi("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",l),n()}}}const kw="lock:worker:request-read",Cw="lock:worker:abort-read-request",Tw="lock:worker:release-read",Pw="lock:master:grant-read",Dw="lock:master:error-read",Lw="lock:worker:request-write",Rw="lock:worker:abort-write-request",Bw="lock:worker:release-write",Nw="lock:master:grant-write",Mw="lock:master:error-write",Ow="lock:worker:finalize",$w="mortice",qL={singleProcess:!1},Bp=(r,e,t,n,s,i,o,l,c)=>d=>{if(d.data==null)return;const f={type:d.data.type,name:d.data.name,identifier:d.data.identifier};f.type===s&&r.safeDispatchEvent(t,{detail:{name:f.name,identifier:f.identifier,handler:async()=>{e.postMessage({type:c,name:f.name,identifier:f.identifier}),await new Promise(a=>{const u=h=>{if(h?.data==null)return;const p={type:h.data.type,name:h.data.name,identifier:h.data.identifier};p.type===l&&p.identifier===f.identifier&&(e.removeEventListener("message",u),a())};e.addEventListener("message",u)})},onError:a=>{e.postMessage({type:o,name:f.name,identifier:f.identifier,error:{message:a.message,name:a.name,stack:a.stack}})}}}),f.type===i&&r.safeDispatchEvent(n,{detail:{name:f.name,identifier:f.identifier}}),f.type===Ow&&r.safeDispatchEvent("finalizeRequest",{detail:{name:f.name}})},HL=(r=10)=>Math.random().toString().substring(2,r+2);class zL{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel($w)}readLock(e){return this.sendRequest(kw,Cw,Pw,Dw,Tw,e)}writeLock(e){return this.sendRequest(Lw,Rw,Nw,Mw,Bw,e)}finalize(){this.channel.postMessage({type:Ow,name:this.name}),this.channel.close()}async sendRequest(e,t,n,s,i,o){o?.signal?.throwIfAborted();const l=HL();return this.channel.postMessage({type:e,identifier:l,name:this.name}),new Promise((c,d)=>{const f=()=>{this.channel.postMessage({type:t,identifier:l,name:this.name})};o?.signal?.addEventListener("abort",f,{once:!0});const a=u=>{if(u.data?.identifier===l&&(u.data?.type===n&&(this.channel.removeEventListener("message",a),o?.signal?.removeEventListener("abort",f),c(()=>{this.channel.postMessage({type:i,identifier:l,name:this.name})})),u.data.type===s)){this.channel.removeEventListener("message",a),o?.signal?.removeEventListener("abort",f);const h=new Error;u.data.error!=null&&(h.message=u.data.error.message,h.name=u.data.error.name,h.stack=u.data.error.stack),d(h)}};this.channel.addEventListener("message",a)})}}const WL=r=>{if(r=Object.assign({},qL,r),!!globalThis.document||r.singleProcess){const t=new BroadcastChannel($w),n=new Dt;return t.addEventListener("message",Bp(n,t,"requestReadLock","abortReadLockRequest",kw,Cw,Dw,Tw,Pw)),t.addEventListener("message",Bp(n,t,"requestWriteLock","abortWriteLockRequest",Lw,Rw,Mw,Bw,Nw)),n}return new zL(r.name)},ss=new Map;let Oi;function Fw(r){return typeof r?.readLock=="function"&&typeof r?.writeLock=="function"}function GL(r){if(Oi==null&&(Oi=WL(r),!Fw(Oi))){const e=Oi;e.addEventListener("requestReadLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=ss.get(n);if(i==null)return;const o=new AbortController,l=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortReadLockRequest",l),i.readLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortReadLockRequest",l)})}),e.addEventListener("requestWriteLock",t=>{const n=t.detail.name,s=t.detail.identifier,i=ss.get(n);if(i==null)return;const o=new AbortController,l=c=>{c.detail.name!==n||c.detail.identifier!==s||o.abort()};e.addEventListener("abortWriteLockRequest",l),i.writeLock({signal:o.signal}).then(async c=>{await t.detail.handler().finally(()=>{c()})}).catch(c=>{t.detail.onError(c)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",l)})}),e.addEventListener("finalizeRequest",t=>{const n=t.detail.name,s=ss.get(n);s?.finalize()})}return Oi}async function Dc(r,e){let t,n;const s=new Promise((o,l)=>{t=o,n=l}),i=()=>{n(new bi)};return e?.signal?.addEventListener("abort",i,{once:!0}),r.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",i),o()})})},{signal:e?.signal}).catch(o=>{n(o)}),s}const YL=(r,e)=>{let t=ss.get(r);if(t!=null)return t;const n=GL(e);if(Fw(n))return t=n,ss.set(r,t),t;const s=new Rp({concurrency:1});let i;return t={async readLock(o){if(i!=null)return Dc(i,o);i=new Rp({concurrency:e.concurrency,autoStart:!1});const l=i,c=Dc(i,o);return s.add(async()=>{l.start(),await l.onIdle().then(()=>{i===l&&(i=null)})}),c},async writeLock(o){return i=null,Dc(s,o)},finalize:()=>{ss.delete(r)},queue:s},ss.set(r,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},XL={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function ZL(r){const e=Object.assign({},XL,r);return YL(e.name,e)}const jL=36e5,QL=216e5;var is;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={key:"",value:Ke(0)},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.key=s.string();break}case 2:{l.value=s.bytes();break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),(function(t){let n;t.codec=()=>(n==null&&(n=Ce((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Sl.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const l={key:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const d=s.uint32();switch(d>>>3){case 1:{l.key=s.string();break}case 2:{l.value=Sl.codec().decode(s,s.uint32(),{limits:o.limits?.value});break}default:{s.skipType(d&7);break}}}return l})),n),t.encode=s=>ke(s,t.codec()),t.decode=(s,i)=>Ie(s,t.codec(),i)})(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),_l.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[i,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:i,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new vt('Decode error - map field "addresses" had too many elements');i.addresses.push(_l.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new vt('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new Bh('Decode error - map field "metadata" had too many elements');const c=r.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(c.key,c.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new Bh('Decode error - map field "tags" had too many elements');const c=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(c.key,c.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(is||(is={}));var _l;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={multiaddr:Ke(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(_l||(_l={}));var Sl;(function(r){let e;r.codec=()=>(e==null&&(e=Ce((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n,s={})=>{const i={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(l&7);break}}}return i})),e),r.encode=t=>ke(t,r.codec()),r.decode=(t,n)=>Ie(t,r.codec(),n)})(Sl||(Sl={}));function JL(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;r.type==="RSA"&&(t=r.toMultihash());const n=zn(e.publicKey,t);return NL(n)}function eR(r,e,t){const n=is.decode(e);return zi(r,n,t)}function zi(r,e,t){const n=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...e,id:JL(r,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:o})=>({multiaddr:he(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function tR(r,e){return rR(r.addresses,e.addresses)&&nR(r.protocols,e.protocols)&&sR(r.publicKey,e.publicKey)&&iR(r.peerRecordEnvelope,e.peerRecordEnvelope)&&oR(r.metadata,e.metadata)&&aR(r.tags,e.tags)}function rR(r,e){return Vw(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!pe(t.multiaddr,n.multiaddr)))}function nR(r,e){return Vw(r,e,(t,n)=>t===n)}function sR(r,e){return Uw(r,e)}function iR(r,e){return Uw(r,e)}function oR(r,e){return Kw(r,e,(t,n)=>pe(t,n))}function aR(r,e){return Kw(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function Uw(r,e){return r==null&&e==null?!0:r!=null&&e!=null?pe(r,e):!1}function Vw(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function Kw(r,e,t){if(r.size!==e.size)return!1;for(const[n,s]of r.entries()){const i=e.get(n);if(i==null||!t(s,i))return!1}return!0}const qw="/peers/";function ca(r){if(!Yi(r)||r.type==null)throw new V("Invalid PeerId");const e=r.toCID().toString();return new je(`${qw}${e}`)}async function lR(r,e,t,n,s){const i=new Map;for(const o of t){if(o==null)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=he(o.multiaddr)),!Hl(o.multiaddr))throw new V("Multiaddr was invalid");if(!await e(r,o.multiaddr,s))continue;const l=o.isCertified??!1,c=o.multiaddr.toString(),d=i.get(c);d!=null?o.isCertified=d.isCertified||l:i.set(c,{multiaddr:o.multiaddr,isCertified:l})}return[...i.values()].sort((o,l)=>o.multiaddr.toString().localeCompare(l.multiaddr.toString())).map(({isCertified:o,multiaddr:l})=>{const c=l.getComponents().find(d=>d.code===ce)?.value;return r.equals(c)&&(l=l.decapsulate(he(`/p2p/${r}`))),{isCertified:o,multiaddr:l.bytes}})}async function Lc(r,e,t,n){if(e==null)throw new V("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new V("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(s!=null&&!r.equals(s.id))throw new V("peer id did not match existing peer id");let i=s?.addresses??[],o=new Set(s?.protocols??[]),l=s?.metadata??new Map,c=s?.tags??new Map,d=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(u=>({isCertified:!1,multiaddr:u}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const u=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);l=ua(u,{validate:Np})}if(e.tags!=null){const u=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=ua(u,{validate:Mp,map:Op})}e.peerRecordEnvelope!=null&&(d=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(u=>({isCertified:!1,multiaddr:u}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const u=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[h,p]of u)p==null?l.delete(h):l.set(h,p);l=ua([...l.entries()],{validate:Np})}if(e.tags!=null){const u=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(const[p,y]of u)y==null?h.delete(p):h.set(p,y);c=ua([...h.entries()],{validate:Mp,map:Op})}e.peerRecordEnvelope!=null&&(d=e.peerRecordEnvelope)}let f;s?.id.publicKey!=null?f=Sr(s.id.publicKey):e.publicKey!=null?f=Sr(e.publicKey):r.publicKey!=null&&(f=Sr(r.publicKey));const a={addresses:await lR(r,n.addressFilter??(async()=>!0),i,n.existingPeer?.peerPB.addresses,n),protocols:[...o.values()].sort((u,h)=>u.localeCompare(h)),metadata:l,tags:c,publicKey:f,peerRecordEnvelope:d};return a.addresses.forEach(u=>{u.observed=n.existingPeer?.peerPB.addresses?.find(h=>pe(h.multiaddr,h.multiaddr))?.observed??Date.now()}),r.type!=="RSA"&&delete a.publicKey,a}function ua(r,e){const t=new Map;for(const[n,s]of r)s!=null&&e.validate(n,s);for(const[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function Np(r,e){if(typeof r!="string")throw new V("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new V("Metadata value must be a Uint8Array")}function Mp(r,e){if(typeof r!="string")throw new V("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new V("Tag value must be an integer");if(e.value<0||e.value>100)throw new V("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new V("Tag ttl must be an integer");if(e.ttl<0)throw new V("Tag ttl must be between greater than 0")}}function Op(r,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const n={value:e.value??0};return t!=null&&(n.expiry=t),n}function Hw(r){const e=r.toString().split("/")[2],t=ue.parse(e,Rn);return Aw(t)}function Rc(r,e,t){const n=Hw(r);return eR(n,e,t)}function cR(r,e){return{prefix:qw,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(Rc(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(Rc(n.key,n.value,e),Rc(s.key,s.value,e)))}}class uR{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=gP({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??jL,this.maxPeerAge=t.maxPeerAge??QL}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:ZL({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const n=this.getLock(e);try{const s=await n.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async getWriteLock(e,t){const n=this.getLock(e);try{const s=await n.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,n)}}catch(s){throw this.maybeRemoveLock(e,n),s}}async has(e,t){try{return await this.load(e,t),!0}catch(n){if(n.name!=="NotFoundError")throw n}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(ca(e),t)}async load(e,t){const n=ca(e),s=await this.datastore.get(n,t),i=is.decode(s);if(this.#t(e,i))throw await this.datastore.delete(n,t),new $a;return zi(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,n){const s=await this.#e(e,n),i=await Lc(e,t,"patch",{...n,addressFilter:this.addressFilter});return this.#r(e,i,s)}async patch(e,t,n){const s=await this.#e(e,n),i=await Lc(e,t,"patch",{...n,addressFilter:this.addressFilter,existingPeer:s});return this.#r(e,i,s)}async merge(e,t,n){const s=await this.#e(e,n),i=await Lc(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#r(e,i,s)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(cR(e??{},this.maxAddressAge),e)){const s=Hw(t);if(s.equals(this.peerId))continue;const i=is.decode(n);if(this.#t(s,i)){await this.datastore.delete(t,e);continue}yield zi(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const n=ca(e),s=await this.datastore.get(n,t),i=is.decode(s);if(this.#t(e,i))throw await this.datastore.delete(n,t),new $a;return{peerPB:i,peer:zi(e,i,this.maxAddressAge)}}catch(n){n.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",n)}}async#r(e,t,n,s){t.updated=Date.now();const i=is.encode(t);return await this.datastore.put(ca(e),i,s),{peer:zi(e,t,this.maxAddressAge),previous:n?.peer,updated:n==null||!tR(t,n.peerPB)}}#t(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(o=>o.observed!=null&&o.observed>s);return n&&i.length===0}}class dR{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new uR(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const n of this.store.all(t))e(n)}async all(e){return iu(this.store.all(e))}async delete(e,t){const n=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{n()}}async has(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),n?.()}}async get(e,t){const n=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{n?.()}}async getInfo(e,t){const n=await this.get(e,t);return{id:n.id,multiaddrs:n.addresses.map(({multiaddr:s})=>s)}}async save(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.save(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.patch(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,n){const s=await this.store.getWriteLock(e,n);try{const i=await this.store.merge(e,t,n);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,n){const s=Yi(t)?t:Yi(t?.expectedPeer)?t.expectedPeer:void 0,i=Yi(t)||t===void 0?n:t,o=await nn.openAndCertify(e,ur.DOMAIN,i),l=Aw(o.publicKey.toCID());if(s?.equals(l)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,l),!1;const c=ur.createFromProtobuf(o.payload);let d;try{d=await this.get(l,i)}catch(f){if(f.name!=="NotFoundError")throw f}if(d?.peerRecordEnvelope!=null){const f=nn.createFromProtobuf(d.peerRecordEnvelope),a=ur.createFromProtobuf(f.payload);if(a.seqNumber>=c.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,c.seqNumber),!1}return await this.patch(c.peerId,{peerRecordEnvelope:e,addresses:c.multiaddrs.map(f=>({isCertified:!0,multiaddr:f}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function fR(r,e={}){return new dR(r,e)}const $p=864e13;class hR{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=un({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=qe(e);let n=t.host;(t.type==="ip4"||t.type==="ip6")&&t.sni!=null&&(n=t.sni);for(const s of this.mappings.values())if(s.domain===n)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const s=qd(n)===!0;this.mappings.set(n,{domain:e,verified:s,expires:s?$p-Date.now():0,lastVerified:s?$p-Date.now():void 0})})}remove(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[s,i]of this.mappings.entries())i.domain===t.sni&&(this.log("removing %s to %s DNS mapping %e",s,i.domain),this.mappings.delete(s),n=n||i.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const s=e[n].multiaddr;if(!Er(s))continue;const i=qe(s);for(const[o,l]of this.mappings.entries()){if(i.host!==o)continue;const c=this.maybeAddSNIComponent(s,l.domain);c!=null&&(e.splice(n,1),n--,t.push({multiaddr:c,verified:l.verified,type:"dns-mapping",expires:l.expires,lastVerified:l.lastVerified}))}}return t}maybeAddSNIComponent(e,t){const n=e.getComponents();for(let s=0;s<n.length;s++)if(n[s].code===hs&&n[s+1]?.code!==Ja)return n.splice(s+1,0,{name:"sni",code:Ja,value:t}),he(n)}confirm(e,t){const n=qe(e);let s=n.host;(n.type==="ip4"||n.type==="ip6")&&n.sni!=null&&(s=n.sni);let i=!1;for(const[o,l]of this.mappings.entries())l.domain===s&&(this.log("marking %s to %s DNS mapping as verified",o,l.domain),i=l.verified,l.verified=!0,l.expires=Date.now()+t,l.lastVerified=Date.now());return i}unconfirm(e,t){const n=qe(e);if(n.type!=="ip4"&&n.type!=="ip6")return!1;const s=n.sni??n.host;let i=!1;for(const[o,l]of this.mappings.entries())l.domain===s&&(this.log("removing verification of %s to %s DNS mapping",o,l.domain),i=i||l.verified,l.verified=!1,l.expires=Date.now()+t);return i}}class pR{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=un({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;for(const n of this.mappings.values())for(const s of n)if(s.externalIp===t.host)return!0;return!1}add(e,t,n,s=t,i="tcp"){const o=`${e}-${t}-${i}`,l=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:s,externalFamily:ui(n)?4:6,protocol:i,verified:!1,expires:0};l.push(c),this.mappings.set(o,l)}remove(e){const t=qe(e);if(t.type!=="ip4"&&t.type!=="ip6")return!1;let n=!1;for(const[s,i]of this.mappings.entries()){for(let o=0;o<i.length;o++){const l=i[o];l.externalIp===t.host&&l.externalPort===t.port&&l.protocol===t.protocol&&(this.log("removing %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,t.host,t.port,t.protocol),n=n||l.verified,i.splice(o,1),o--)}i.length===0&&this.mappings.delete(s)}return n}getAll(e){const t=[];for(const{multiaddr:n}of e){if(!Er(n))continue;const s=qe(n);if(s.type!=="ip4"&&s.type!=="ip6")continue;let i;if(s.protocol==="tcp"?i=`${s.host}-${s.port}-tcp`:s.protocol==="udp"&&(i=`${s.host}-${s.port}-udp`),i==null)continue;const o=this.mappings.get(i);if(o!=null)for(const l of o)t.push({multiaddr:this.maybeOverrideIp(n,l.externalIp,l.externalFamily,l.protocol,l.externalPort),verified:l.verified,type:"ip-mapping",expires:l.expires,lastVerified:l.lastVerified})}return t}maybeOverrideIp(e,t,n,s,i){const o=e.getComponents(),l=o.findIndex(d=>d.code===Qa||d.code===_s),c=o.findIndex(d=>d.name===s);return l>-1&&c>-1?(o[l].value=t,o[l].code=n===4?Qa:_s,o[c].value=`${i}`,he(o)):e}confirm(e,t){if(!Er(e))return!1;const n=qe(e);let s=!1;for(const i of this.mappings.values())for(const o of i)o.externalIp===n.host&&(this.log("marking %s to %s IP mapping as verified",o.internalIp,o.externalIp),s=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return s}unconfirm(e,t){if(!Er(e))return!1;const n=qe(e);let s=!1;for(const i of this.mappings.values())for(let o=0;o<i.length;o++){const l=i[o];l.externalIp===n.host&&l.externalPort===n.port&&l.protocol===n.protocol&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",l.externalIp,l.externalPort,n.host,n.port,n.protocol),s=s||l.verified,l.verified=!1,l.expires=Date.now()+t)}return s}}const gR={maxObservedAddresses:10};class mR{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=un({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??gR.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(di(e)||hk(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:he(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),s=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,s),i}}const yR={maxObservedAddresses:10};class bR{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=un({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??yR.maxObservedAddresses}get(e,t){if(di(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let s=this.addresses.get(n);return s==null&&(s={verified:!Er(e),expires:0},this.addresses.set(n,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),n=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(n,s),i}unconfirm(e,t){const n=this.toKey(e),s=this.addresses.get(n)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(n,s),i}toKey(e){if(!Er(e))return e.toString();const t=qe(e);return`${t.host}-${t.port}-${t.protocol}`}}const Fp=6e4,Up={addressVerificationTTL:Fp*10,addressVerificationRetry:Fp*5},vR=r=>r;function Bc(r,e){const t=r.getComponents().findLast(n=>n.code===ce)?.value;return t!=null&&yi(t).equals(e)&&(r=r.decapsulate(he(`/p2p/${e.toString()}`))),r}class wR{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:n=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(s.map(o=>o.toString())),this.appendAnnounce=new Set(i.map(o=>o.toString())),this.observed=new mR(e,t),this.dnsMappings=new hR(e,t),this.ipMappings=new pR(e,t),this.transportAddresses=new bR(e,t),this.announceFilter=t.announceFilter??vR,this.observedAddressFilter=mo(1024),this.addressVerificationTTL=t.addressVerificationTTL??Up.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??Up.addressVerificationRetry,this._updatePeerStoreAddresses=Za(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getComponents().findLast(n=>n.code===ce)?.value===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses - %e",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>he(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>he(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>he(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=qe(e);let n;switch(t.type){case"ip4":{n=`${t.host}:${t.port}`;break}case"ip6":{n=`[${t.host}]:${t.port}`;break}default:return}this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=Bc(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=Bc(e,this.components.peerId);let n=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Bc(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const s=n.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{const s=he(n);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(n)}),t=t.concat(n.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(he(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.add(e,t,n,s,i),this.observed.removePrefixed(`/ip${ui(n)?4:6}/${n}/${i}/${s}`)}removePublicAddressMapping(e,t,n,s=t,i="tcp"){this.ipMappings.remove(he(`/ip${ui(n)?4:6}/${n}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e)||!Er(e))return!1;const t=qe(e);if(t.type!=="ip4"||qd(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),s=[i=>_o.exactMatch(i)||tl.exactMatch(i),i=>el.exactMatch(i),i=>yT.exactMatch(i)];for(const i of s){if(!i(e))continue;const o=n.filter(d=>d.getAddrs().filter(f=>qe(f).type==="ip4"&&i(f)).length>0);if(o.length!==1)continue;const l=o[0].getAddrs().filter(d=>!Tu(d)).pop();if(l==null)continue;const c=qe(l);return c.port==null?!1:(this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.protocol),!0)}return!1}}var Vp;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(Vp||(Vp={}));class _R extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class SR extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Nc extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class Kp extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class ER extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class xR extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class AR extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class qp extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class IR extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class kR extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class CR extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class TR extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class PR extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class wa extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class da extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class DR extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class LR extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class RR{components={};_started=!1;constructor(e={}){this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=cd())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>md(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const BR=["metrics","connectionProtector","dns"],NR=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function MR(r={}){const e=new RR(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!NR.includes(s)){const o=e.components[s];if(o==null&&!BR.includes(s))throw new _R(`${s} not set`);return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}function OR(r){const e={};for(const t of Object.values(r.components))for(const n of $R(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of FR(t))if(e[n]!==!0)throw new SR(`Service "${UR(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function $R(r){return Array.isArray(r?.[xr])?r[xr]:[]}function FR(r){return Array.isArray(r?.[Va])?r[Va]:[]}function UR(r){return r?.[Symbol.toStringTag]??r?.toString()??"unknown"}function VR(r={}){return r.denyDialMultiaddr==null&&(r.denyDialMultiaddr=e=>_o.matches(e)?!0:di(e)),r}function zw(r){if(Yi(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getComponents().findLast(s=>s.code===ce)?.value;t=n==null?void 0:yi(n),e.forEach(s=>{if(!Hl(s))throw new pd("Invalid multiaddr");const i=s.getComponents().findLast(o=>o.code===ce)?.value;if(i==null){if(t!=null)throw new V("Multiaddrs must all have the same peer id or have no peer id")}else{const o=yi(i);if(t?.equals(o)!==!0)throw new V("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!pT.exactMatch(n)),{peerId:t,multiaddrs:e}}const KR=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function qR(r,e){const t=r?.streams?.map(s=>s.protocol)??[],n=e?.closableProtocols??KR;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await r?.close(e)}catch(s){r?.abort(s)}}function Vu(r){const e=qe(r);let t=e.cidr;if(e.type!=="ip4"&&e.type!=="ip6")throw new V(`Multiaddr ${r} was not an IPv4 or IPv6 address`);if(t==null)switch(e.type){case"ip4":{t=32;break}case"ip6":{t=128;break}default:throw new V(`Multiaddr ${r} was not an IPv4 or IPv6 address`)}return new Xy(e.host,t)}function Ww(r){return!fi.exactMatch(r)}function Gw(r,e,t){if(r==null||e==null)return;const n=e.sort((i,o)=>i.direct?-1:o.direct?1:0).find(i=>i.limits==null);if(n==null||n.direct||t==null)return n;if(!t.some(i=>Ww(i)))return n}class HR{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(n=>Vu(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections - %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,n),t<=n)return;const s=new ks;for(const c of e){const d=c.remotePeer;if(!s.has(d)){s.set(d,0);try{const f=await this.peerStore.get(d);s.set(d,[...f.tags.values()].reduce((a,u)=>a+u.value,0))}catch(f){f.name!=="NotFoundError"&&this.log.error("error loading peer tags - %e",f)}}}const i=this.sortConnections(e,s),o=Math.max(t-n,0),l=[];for(const c of i)if(this.log("too many connections open - closing a connection to %p",c.remotePeer),this.allow.some(f=>{if(Er(c.remoteAddr)){const a=qe(c.remoteAddr);return f.contains(a.host)}return!0})||l.push(c),l.length===o)break;await Promise.all(l.map(async c=>{await qR(c,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:l})}sortConnections(e,t){return e.sort((n,s)=>{const i=n.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((n,s)=>n.direction==="outbound"&&s.direction==="inbound"?1:n.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((n,s)=>n.streams.length>s.streams.length?1:n.streams.length<s.streams.length?-1:0).sort((n,s)=>{const i=t.get(n.remotePeer)??0,o=t.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}const Yw=1e4,Xw=1e3,zR=1e4,El=1e4,Zw=25,WR=5,GR=10,YR=5,XR="last-dial-failure",ZR="last-dial-success",jw=500,jR=32,QR=100,Qw=50;function JR(r,e){const t=el.exactMatch(r.multiaddr),n=el.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const s=tl.exactMatch(r.multiaddr),i=tl.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=_o.exactMatch(r.multiaddr),l=_o.exactMatch(e.multiaddr);if(o&&!l)return-1;if(!o&&l)return 1;const c=tp.exactMatch(r.multiaddr),d=tp.exactMatch(e.multiaddr);if(c&&!d)return-1;if(!c&&d)return 1;const f=Jh.exactMatch(r.multiaddr),a=Jh.exactMatch(e.multiaddr);if(f&&!a)return-1;if(!f&&a)return 1;const u=ep.exactMatch(r.multiaddr),h=ep.exactMatch(e.multiaddr);return u&&!h?-1:!u&&h?1:0}function eB(r,e){const t=Tu(r.multiaddr),n=Tu(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function tB(r,e){const t=di(r.multiaddr),n=di(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function rB(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function nB(r,e){const t=fi.exactMatch(r.multiaddr),n=fi.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function sB(r){return r.sort(JR).sort(rB).sort(nB).sort(tB).sort(eB)}class iB extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"}function Jw(r){const e=[Vn.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const e0=60;function t0(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Vn[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Vn[e.type],TTL:e.TTL??e.ttl??e0,data:e.data instanceof Uint8Array?W(e.data):e.data}))}}const oB=4;function Hp(r,e={}){const t=new Qv({concurrency:e.queryConcurrency??oB});return async(n,s={})=>{const i=new URLSearchParams;i.set("name",n),Jw(s.types).forEach(l=>{i.append("type",Vn[l])}),s.onProgress?.(new nt("dns:query",n));const o=await t.add(async()=>{const l=await fetch(`${r}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(l.status!==200)throw new Error(`Unexpected HTTP status: ${l.status} - ${l.statusText}`);const c=t0(await l.json());return s.onProgress?.(new nt("dns:response",c)),c},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function aB(){return[Hp("https://cloudflare-dns.com/dns-query"),Hp("https://dns.google/resolve")]}var Mc,zp;function lB(){return zp||(zp=1,Mc=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}),Mc}var cB=lB();const uB=ad(cB);class dB{lru;constructor(e){this.lru=uB(e)}get(e,t){let n=!0;const s=[];for(const i of t){const o=this.getAnswers(e,i);if(o.length===0){n=!1;break}s.push(...o)}if(n)return t0({answers:s})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,s=this.lru.get(n);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:l})=>({...l,TTL:Math.round((o-Date.now())/1e3),type:Vn[l.type]}));return i.length===0&&this.lru.remove(n),i}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(n)??[];s.push({expires:Date.now()+(t.TTL??e0)*1e3,value:t}),this.lru.set(n,s)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function fB(r){return new dB(r)}const hB=1e3;class pB{resolvers;cache;constructor(e){this.resolvers={},this.cache=fB(e.cacheSize??hB),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=aB())}async query(e,t={}){const n=Jw(t.types),s=t.cached!==!1?this.cache.get(e,n):void 0;if(s!=null)return t.onProgress?.(new nt("dns:cache",s)),s;const i=`${e.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),l=[];for(const c of o){if(t.signal?.aborted===!0)break;try{const d=await c(e,{...t,types:n});for(const f of d.Answer)this.cache.add(e,f);return d}catch(d){l.push(d),t.onProgress?.(new nt("dns:error",d))}}throw new iB(l,`DNS lookup of ${e} ${n} failed`)}}var Vn;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Vn||(Vn={}));function gB(r={}){return new pB(r)}class mB{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const n=e.getComponents().find(c=>c.name==="dnsaddr")?.value;if(n==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${n}`,{signal:t?.signal,types:[Vn.TXT]}),o=e.getComponents().find(c=>c.name==="p2p")?.value,l=[];for(const c of i.Answer){const d=c.data.replace(/["']/g,"").trim().split("=")[1];d!=null&&(o!=null&&!d.includes(o)||l.push(he(d)))}return l}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=gB()),this.dns)}}const r0=new mB;async function n0(r,e,t){const n=t.depth??0;if(n>(t.maxRecursiveDepth??jR))throw new LR("Max recursive depth reached");let s=!1;const i=[];for(const o of Object.values(e))if(o.canResolve(r)){s=!0;const l=await o.resolve(r,t);for(const c of l)i.push(...await n0(c,e,{...t,depth:n+1}))}return s===!1&&i.push(r),i}const $i={maxParallelDials:Qw,maxDialQueueLength:jw,maxPeerAddrsToDial:Zw,dialTimeout:Yw,resolvers:{dnsaddr:r0}};class yB{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??$i.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??$i.maxDialQueueLength,this.dialTimeout=t.dialTimeout??$i.dialTimeout,this.connections=t.connections??new ks,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??$i.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new $C({concurrency:t.maxParallelDials??$i.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("failure",n=>{n.detail?.error.name!==co.name&&this.log.error("error in dial queue - %e",n.detail.error)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:n,multiaddrs:s}=zw(e);if(n!=null&&t.force!==!0){const o=Gw(n,this.connections.get(n),s);if(o!=null)return this.log("already connected to %a",o.remoteAddr),t.onProgress?.(new nt("dial-queue:already-connected")),o}const i=this.queue.queue.find(o=>{if(n?.equals(o.options.peerId)===!0)return!0;const l=o.options.multiaddrs;if(l==null)return!1;for(const c of s)if(l.has(c.toString()))return!0;return!1});if(i!=null){this.log("joining existing dial target for %p",n);for(const o of s)i.options.multiaddrs.add(o.toString());return t.onProgress?.(new nt("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ma("Dial queue is full");return this.log("creating dial target for %p",n,s.map(o=>o.toString())),t.onProgress?.(new nt("dial-queue:add-to-dial-queue")),this.queue.add(async o=>{o.onProgress?.(new nt("dial-queue:start-dial"));const l=ws([this.shutDownController.signal,o.signal]);try{return await this.dialPeer(o,l)}finally{l.clear()}},{peerId:n,priority:t.priority??s0,multiaddrs:new Set(s.map(o=>o.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const n=e.peerId,s=e.multiaddrs,i=new Set;let o=e.multiaddrs.size===0,l=0,c=0;const d=[];for(this.log("starting dial to %p",n);o||s.size>0;){c++,o=!1;const f=[],a=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",n,[...a]);const u=await this.calculateMultiaddrs(n,a,{...e,signal:t});for(const h of u){if(i.has(h.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",h.multiaddr,n);continue}f.push(h)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,f.map(h=>h.multiaddr.toString())),e?.onProgress?.(new nt("dial-queue:calculated-addresses",f));for(const h of f){if(l===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",l,e.peerId),new ma("Peer had more than maxPeerAddrsToDial");l++;try{const p=await this.components.transportManager.dial(h.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",h.multiaddr);try{await this.components.peerStore.merge(p.remotePeer,{multiaddrs:[p.remoteAddr],metadata:{[ZR]:j(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}return p}catch(p){if(this.log.error("dial failed to %a - %e",h.multiaddr,p),i.add(h.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[XR]:j(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p - %e",n,y)}if(t.aborted)throw new rA(p.message);d.push(p)}}}throw d.length===1?d[0]:new AggregateError(d,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){const s=[...t].map(a=>({multiaddr:he(a),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new ma("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new qp("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const a=await this.components.peerStore.get(e);s.push(...a.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:u})=>u.toString()))}catch(a){if(a.name!=="NotFoundError")throw a}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const a=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:u})=>u.toString())),s.push(...a.multiaddrs.map(u=>({multiaddr:u,isCertified:!1})))}catch(a){a.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,a)}}}let i=(await Promise.all(s.map(async a=>{const u=await n0(a.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...n});return u.length===1&&u[0].equals(a.multiaddr)?a:u.map(h=>({multiaddr:h,isCertified:!1}))}))).flat();if(e!=null){const a=`/p2p/${e.toString()}`;i=i.map(u=>u.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:u.multiaddr.encapsulate(a),isCertified:u.isCertified}:u)}const o=i.filter(a=>{if(this.components.transportManager.dialTransportForMultiaddr(a.multiaddr)==null)return!1;const u=a.multiaddr.getComponents().findLast(h=>h.code===ce)?.value;return e!=null&&u!=null?e.equals(u):!0}),l=new Map;for(const a of o){const u=a.multiaddr.toString(),h=l.get(u);if(h!=null){h.isCertified=h.isCertified||a.isCertified||!1;continue}l.set(u,a)}const c=[...l.values()];if(c.length===0)throw new CR("The dial request has no valid addresses");const d=[];for(const a of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(a.multiaddr)||d.push(a);const f=this.addressSorter==null?sB(d):d.sort(this.addressSorter);if(f.length===0)throw new qp("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:a})=>a.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",f.map(({multiaddr:a})=>a.toString())),f}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?n.find(s=>!fi.matches(s.multiaddr))!=null:!0}catch{}return!1}}const bB=Object.prototype.toString,vB=r=>bB.call(r)==="[object Error]",wB=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function _B(r){if(!(r&&vB(r)&&r.name==="TypeError"&&typeof r.message=="string"))return!1;const{message:t,stack:n}=r;return t==="Load failed"?n===void 0||"__sentry_captured__"in r:t.startsWith("error sending request for url")?!0:wB.has(t)}function SB(r){if(typeof r=="number"){if(r<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(r))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(r!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function fa(r,e,{min:t=0,allowInfinity:n=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${r}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(e))throw new TypeError(`Expected \`${r}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${r}\` to be â‰¥ ${t}.`)}}class EB extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function xB(r,e){const t=Math.max(1,r+1),n=e.randomize?Math.random()+1:1;let s=Math.round(n*e.minTimeout*e.factor**(t-1));return s=Math.min(s,e.maxTimeout),s}function Wp(r,e){return Number.isFinite(e)?e-(performance.now()-r):e}async function AB({error:r,attemptNumber:e,retriesConsumed:t,startTime:n,options:s}){const i=r instanceof Error?r:new TypeError(`Non-error was thrown: "${r}". You should only throw errors.`);if(i instanceof EB)throw i.originalError;const o=Number.isFinite(s.retries)?Math.max(0,s.retries-t):s.retries,l=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:i,attemptNumber:e,retriesLeft:o,retriesConsumed:t});if(await s.onFailedAttempt(c),Wp(n,l)<=0)throw i;const d=await s.shouldConsumeRetry(c),f=Wp(n,l);if(f<=0||o<=0)throw i;if(i instanceof TypeError&&!_B(i)){if(d)throw i;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw i;if(!d)return s.signal?.throwIfAborted(),!1;const a=xB(t,s),u=Math.min(a,f);return s.signal?.throwIfAborted(),u>0&&await new Promise((h,p)=>{const y=()=>{clearTimeout(g),s.signal?.removeEventListener("abort",y),p(s.signal.reason)},g=setTimeout(()=>{s.signal?.removeEventListener("abort",y),h()},u);s.unref&&g.unref?.(),s.signal?.addEventListener("abort",y,{once:!0})}),s.signal?.throwIfAborted(),!0}async function IB(r,e={}){if(e={...e},SB(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,fa("factor",e.factor,{min:0,allowInfinity:!1}),fa("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),fa("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),fa("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,n=0;const s=performance.now();for(;!Number.isFinite(e.retries)||n<=e.retries;){t++;try{e.signal?.throwIfAborted();const i=await r(t);return e.signal?.throwIfAborted(),i}catch(i){await AB({error:i,attemptNumber:t,retriesConsumed:n,startTime:s,options:e})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}class kB{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Qd({concurrency:t.maxParallelReconnects??YR,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Gp(t)&&(this.queue.has(e)||this.queue.add(async n=>{await IB(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:n?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(gd)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>Gp(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not open connection to keepalive peer - %e",n)})}))}).catch(e=>{this.log.error("error reconnect to peers after start - %e",e)})}stop(){this.started=!1,this.queue.abort()}}function Gp(r){for(const e of r.tags.keys())if(e.startsWith(gd))return!0;return!1}const s0=50,Oc={maxConnections:QR,inboundConnectionThreshold:WR,maxIncomingPendingConnections:GR};class CB{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??Oc.maxConnections,this.maxConnections<1)throw new V("Connection Manager maxConnections must be greater than 0");this.connections=new ks,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(n=>Vu(he(n))),this.deny=(t.deny??[]).map(n=>Vu(he(n))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Oc.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new FC({points:t.inboundConnectionThreshold??Oc.inboundConnectionThreshold,duration:1}),this.connectionPruner=new HR({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(n=>he(n))}),this.dialQueue=new yB(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??Qw,maxDialQueueLength:t.maxDialQueueLength??jw,maxPeerAddrsToDial:t.maxPeerAddrsToDial??Zw,dialTimeout:t.dialTimeout??Yw,resolvers:t.resolvers??{dnsaddr:r0},connections:this.connections}),this.reconnectQueue=new kB({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const n of t)e[n.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const l=`${o.direction} ${o.protocol??"unnegotiated"}`;i[l]=(i[l]??0)+1}for(const[o,l]of Object.entries(i))e[o]=e[o]??[],e[o].push(l)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,l)=>o-l);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Om(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await $m(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push(Promise.all([fr(n,"close",{signal:AbortSignal.timeout(500)}),n.close({signal:AbortSignal.timeout(500)})]).catch(s=>{n.abort(s)}));this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new V("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error("could not connect - %e",t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,s=!this.connections.has(n),i=this.connections.get(n)??[];i.push(t),this.connections.set(n,i),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,i=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,i),i.length===0&&(this.log.trace("peer %p disconnected, removing connection map entry",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:n}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new uo("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:n,multiaddrs:s}=zw(e);if(this.peerId.equals(n))throw new Nm("Can not dial self");if(n!=null&&t.force!==!0){this.log("dial %p",n);const c=Gw(n,this.getConnections(n),s);if(c!=null)return this.log("had an existing connection to %p as %a",n,c.remoteAddr),t.onProgress?.(new nt("dial-queue:already-connected")),c}const i=await this.dialQueue.dial(e,{...t,priority:t.priority??s0});if(i.status!=="open")throw new mu("Remote closed connection during opening");let o=this.connections.get(i.remotePeer);o==null&&(o=[],this.connections.set(i.remotePeer,o));let l=!1;for(const c of o)if(c.id===i.id&&(l=!0),t.force!==!0&&c.id!==i.id&&c.remoteAddr.equals(i.remoteAddr))return i.abort(new pd("Duplicate multiaddr connection")),c;return l||o.push(i),i}finally{this.outboundPendingConnections--}}async openStream(e,t,n={}){return(await this.openConnection(e,n)).newStream(t,n)}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await Promise.all([fr(s,"close",t),s.close(t)])}catch(i){s.abort(i)}}))}acceptIncomingConnection(e){if(this.deny.some(s=>{if(Er(e.remoteAddr)){const i=qe(e.remoteAddr);return s.contains(i.host)}return!1}))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>{if(Er(e.remoteAddr)){const i=qe(e.remoteAddr);return s.contains(i.host)}return!0}))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(Er(e.remoteAddr)){const s=qe(e.remoteAddr);try{this.inboundConnectionRateLimiter.consume(s.host,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s.host),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>he(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const TB=1e4,PB="1.0.0",DB="ping",LB="ipfs",Yp=32,RB=!0;class BB{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??LB}/${DB}/${PB}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??TB,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??RB,this.timeout=new zk({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[xr]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const n=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:n,runOnLimitedConnection:!0}),i=ub(s);t=Date.now(),await Promise.all([i.write(li(Yp),{signal:n}),i.read({bytes:Yp,signal:n})]),e.rtt=Date.now()-t,await s.close({signal:n})}catch(n){if(n.name!=="UnsupportedProtocolError")throw n;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat - %e",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}class NB{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()}),getAttributesFromYieldedValue:(n,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],n.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,cid:n.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([n])=>({key:W(n,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new Nc("No content routers available");const n=this,s=new ps;for await(const i of au(...n.routers.filter(o=>o.findProviders instanceof Function).map(o=>o.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new Nc("No content routers available");await Promise.all(this.routers.filter(n=>n.provide instanceof Function).map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new Nc("No content routers available");await Promise.all(this.routers.filter(n=>n.cancelReprovide instanceof Function).map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new uo;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new uo;return Promise.any(this.routers.filter(n=>n.get instanceof Function).map(async n=>n.get(e,t)))}}class MB{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,peer:n.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([n],s)=>({...s,key:W(n,"base36")}),getAttributesFromYieldedValue:(n,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],n.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new Kp("No peer routers available");if(e.toString()===this.peerId.toString())throw new ER("Should not try to find self");const n=this,s=au(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>(async function*(){try{yield await i.findPeer(e,t)}catch(o){n.log.error("router failed to find peer - %e",o)}})()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new $a}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Kp("No peer routers available");const n=this,s=mo(1024);for await(const i of LD((async function*(){const o=au(...n.routers.filter(l=>l.getClosestPeers instanceof Function).map(l=>l.getClosestPeers(e,t)));for await(let l of o)yield async()=>{if(l.multiaddrs.length===0)try{l=await n.findPeer(l.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs - %e",c);return}return l}})()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class OB extends Dt{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=ws([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=lr(),yield(await fr(this,"walk:peer",{signal:t,rejectionEvents:["walk:error"]})).detail}catch(n){throw n.detail!=null?n.detail:n}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=ws([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let n=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=li(32);let i=Date.now();for await(const o of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",o.id,Date.now()-i,this.walkers),n++,this.safeDispatchEvent("walk:peer",{detail:o}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Tt(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,n)}catch(s){this.log.error("random walk errored - %e",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored - %e",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",n,Date.now()-t),this.walking=!1})}}const i0=32,o0=64;class $B{log;topologies;handlers;components;middleware;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.middleware=new Map,this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[n,s]of this.topologies)t[n]=s.size;return t}}),this.handlers=un({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new xR(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&n?.force!==!0)throw new AR(`Handler already registered for protocol ${e}`);this.handlers.set(e,{handler:t,options:{maxInboundStreams:i0,maxOutboundStreams:o0,...n}}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},n)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new V("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}use(e,t){this.middleware.set(e,t)}unuse(e){this.middleware.delete(e)}getMiddleware(e){return this.middleware.get(e)??[]}async _onDisconnect(e){const t=e.detail,n={signal:AbortSignal.timeout(5e3)};try{const s=await this.components.peerStore.get(t,n);for(const i of s.protocols){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{l.filter?.has(t)!==!1&&(l.filter?.remove(t),await l.onDisconnect?.(t))}))}}catch(s){if(s.name==="NotFoundError")return;this.log.error("could not inform topologies of disconnecting peer %p - %e",t,s)}}async _onPeerUpdate(e){const{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(i=>!t.protocols.includes(i));try{for(const i of s){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{l.filter?.has(t.id)!==!1&&(l.filter?.remove(t.id),await l.onDisconnect?.(t.id))}))}}catch(i){this.log.error("could not inform topologies of updated peer %p - %e",t.id,i)}}async _onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,s=e.detail.peerId;try{for(const i of t){const o=this.topologies.get(i);o!=null&&await Promise.all([...o.values()].map(async l=>{n.limits!=null&&l.notifyOnLimitedConnection!==!0||l.filter?.has(s)!==!0&&(l.filter?.add(s),await l.onConnect?.(s,n))}))}}catch(i){this.log.error("could not inform topologies of updated peer after identify %p - %e",s,i)}}}class FB{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=un({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=un({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Ua.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new V("Transport must have a valid tag");if(this.transports.has(t))throw new V(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.dialTransportForMultiaddr(e);if(n==null)throw new DR(`No transport available for address ${String(e)}`);return t?.onProgress?.(new nt("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new uo("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new IR)});const n=[];for(const[i,o]of this.transports.entries()){const l=o.listenFilter(e);for(const c of l){this.log("creating listener for %s on %a",i,c);const d=o.createListener({upgrader:this.components.upgrader});let f=this.listeners.get(i)??[];f==null&&(f=[],this.listeners.set(i,f)),f.push(d),d.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:d})}),d.addEventListener("close",()=>{const a=f.findIndex(u=>u===d);f.splice(a,1),this.components.events.safeDispatchEvent("transport:close",{detail:d})}),jh.matches(c)?t.ipv4.attempts++:Qh.matches(c)&&t.ipv6.attempts++,n.push(d.listen(c).then(()=>{t.errors.delete(c.toString()),jh.matches(c)&&t.ipv4.success++,Qh.matches(c)&&t.ipv6.success++},a=>{throw this.log.error("transport %s could not listen on address %a - %e",i,c,a),t.errors.set(c.toString(),a),a}))}}const s=await Promise.allSettled(n);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Ua.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new kR(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,o])=>`
  ${i}: ${`${UB(o)}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&n.push(s.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}function UB(r){return r.stack!=null&&r.stack.trim()!==""?r.stack:r.message!=null?r.message:r.toString()}const os="/multistream/1.0.0",a0=1024,VB=j(`
`);async function Ku(r,e){const n=(await r.read(e)).subarray();if(n.byteLength===0||n[n.length-1]!==VB[0])throw new $e("Missing newline");return W(n).trimEnd()}async function qu(r,e,t={}){if(e=Array.isArray(e)?[...e]:[e],e.length===0)throw new Error("At least one protocol must be specified");const n=r.log.newScope("mss:select"),s=jd(r,{...t,maxDataLength:a0});for(let i=0;i<e.length;i++){const o=e[i];let l;if(i===0){n.trace('write ["%s", "%s"]',os,o);const c=j(`${os}
`),d=j(`${o}
`);if(await s.writeV([c,d],t),n.trace("reading multistream-select header"),l=await Ku(s,t),n.trace('read "%s"',l),l!==os){n.error("did not read multistream-select header from response");break}}else n.trace('write "%s"',o),await s.write(j(`${o}
`),t);if(n.trace("reading protocol response"),l=await Ku(s,t),n.trace('read "%s"',l),l===o)return n.trace('selected "%s" after negotiation',l),s.unwrap(),o}throw new tA(`Protocol selection failed - could not negotiate ${e}`)}const l0=1024*1024*4;class KB extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}function qB(r){return r[Symbol.asyncIterator]!=null}function c0(r,e){if(r.byteLength>e)throw new KB("Message length too long")}const Ql=r=>{const e=Ar(r),t=on(e);return ji(r,t),Ql.bytes=e,t};Ql.bytes=0;function u0(r,e){e=e??{};const t=e.lengthEncoder??Ql,n=e?.maxDataLength??l0;function*s(i){c0(i,n);const o=t(i.byteLength);o instanceof Uint8Array?yield o:yield*o,i instanceof Uint8Array?yield i:yield*i}return qB(r)?(async function*(){for await(const i of r)yield*s(i)})():(function*(){for(const i of r)yield*s(i)})()}u0.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Ql,n=e?.maxDataLength??l0;return c0(r,n),new Ne(t(r.byteLength),r)};var Xp;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Xp||(Xp={}));async function Hu(r,e,t={}){e=Array.isArray(e)?e:[e];const n=r.log.newScope("mss:handle"),s=jd(r,{...t,maxDataLength:a0,maxLengthLength:2});for(;;){n.trace("reading incoming string");const i=await Ku(s,t);if(n.trace('read "%s"',i),i===os){n.trace('respond with "%s" for "%s"',os,i),await s.write(j(`${os}
`),t),n.trace('responded with "%s" for "%s"',os,i);continue}if(e.includes(i))return n.trace('respond with "%s" for "%s"',i,i),await s.write(j(`${i}
`),t),n.trace('responded with "%s" for "%s"',i,i),s.unwrap(),i;if(i==="ls"){const o=new Ne(...e.map(l=>u0.single(j(`${l}
`))),j(`
`));n.trace('respond with "%s" for %s',e,i),await s.write(o,t),n.trace('responded with "%s" for %s',e,i);continue}n.trace('respond with "na" for "%s"',i),await s.write(j(`na
`),t),n('responded with "na" for "%s"',i)}}class HB extends Dt{id;remoteAddr;remotePeer;direction;timeline;direct;multiplexer;encryption;limits;log;maConn;muxer;components;outboundStreamProtocolNegotiationTimeout;inboundStreamProtocolNegotiationTimeout;closeTimeout;constructor(e,t){super(),this.components=e,this.id=t.id,this.remoteAddr=t.maConn.remoteAddr,this.remotePeer=t.remotePeer,this.direction=t.direction??"outbound",this.timeline=t.maConn.timeline,this.encryption=t.cryptoProtocol,this.limits=t.limits,this.maConn=t.maConn,this.log=t.maConn.log,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??El,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??El,this.closeTimeout=t.closeTimeout??Xw,this.direct=Ww(t.maConn.remoteAddr),this.onIncomingStream=this.onIncomingStream.bind(this),this.remoteAddr.getComponents().find(n=>n.code===ce)==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),t.muxer!=null&&(this.multiplexer=t.muxer.protocol,this.muxer=t.muxer,this.muxer.addEventListener("stream",this.onIncomingStream)),this.maConn.addEventListener("close",n=>{this.dispatchEvent(new Ml(n.local,n.error))})}[Symbol.toStringTag]="Connection";[jx]=!0;get streams(){return this.muxer?.streams??[]}get status(){return this.maConn.status}newStream=async(e,t={})=>{if(this.muxer==null)throw new wa("Connection is not multiplexed");if(this.muxer.status!=="open")throw new mu(`The connection muxer is "${this.muxer.status}" and not "open"`);if(this.maConn.status!=="open")throw new mu(`The connection is "${this.status}" and not "open"`);if(this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new gh("Cannot open protocol stream on limited connection");Array.isArray(e)||(e=[e]),this.log.trace("starting new stream for protocols %s",e);const n=await this.muxer.createStream({...t,protocol:e.length===1?e[0]:void 0});this.log.trace("started new stream %s for protocols %s",n.id,e);try{if(t.signal==null){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const l=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);t={...t,signal:l}}n.protocol===""?(n.log.trace("selecting protocol from protocols %s",e),n.protocol=await qu(n,e,t),n.log("negotiated protocol %s",n.protocol)):n.log("pre-negotiated protocol %s",n.protocol);const s=GB(n.protocol,this.components.registrar,t),i=Zp(n.protocol,"outbound",this);if(i>s){const l=new Mm(`Too many outbound protocol streams for protocol "${n.protocol}" - ${i}/${s}`);throw n.abort(l),l}await this.components.peerStore.merge(this.remotePeer,{protocols:[n.protocol]}),this.components.metrics?.trackProtocolStream(n);const o=this.components.registrar.getMiddleware(n.protocol);return await this.runMiddlewareChain(n,this,o)}catch(s){throw n.status==="open"?n.abort(s):this.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",this.direction==="inbound"?"from":"to",this.remoteAddr,e,s),s}};async onIncomingStream(e){const t=e.detail,n=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);t.log("start protocol negotiation, timing out after %dms",this.inboundStreamProtocolNegotiationTimeout);try{if(t.protocol===""){const d=this.components.registrar.getProtocols();t.log.trace("selecting protocol from protocols %s",d),t.protocol=await Hu(t,d,{signal:n}),t.log("negotiated protocol %s",t.protocol)}else t.log("pre-negotiated protocol %s",t.protocol);const s=WB(t.protocol,this.components.registrar);if(Zp(t.protocol,"inbound",this)>s)throw new nA(`Too many inbound protocol streams for protocol "${t.protocol}" - limit ${s}`);await this.components.peerStore.merge(this.remotePeer,{protocols:[t.protocol]},{signal:n}),this.components.metrics?.trackProtocolStream(t);const{handler:o,options:l}=this.components.registrar.getHandler(t.protocol);if(this.limits!=null&&l.runOnLimitedConnection!==!0)throw new gh("Cannot open protocol stream on limited connection");const c=this.components.registrar.getMiddleware(t.protocol);c.push(async(d,f,a)=>{await o(d,f),a(d,f)}),await this.runMiddlewareChain(t,this,c)}catch(s){t.abort(s)}}async runMiddlewareChain(e,t,n){for(let s=0;s<n.length;s++){const i=n[s];e.log.trace("running middleware",s,i),await new Promise((o,l)=>{try{const c=i(e,t,(d,f)=>{e=d,t=f,o()});c instanceof Promise&&c.catch(l)}catch(c){l(c)}}),e.log.trace("ran middleware",s,i)}return e}async close(e={}){if(this.log("closing connection to %a",this.remoteAddr),e.signal==null){const t=AbortSignal.timeout(this.closeTimeout);e={...e,signal:t}}await this.muxer?.close(e),await this.maConn.close(e)}abort(e){this.muxer?.abort(e),this.maConn.abort(e)}}function zB(r,e){return new HB(r,e)}function WB(r,e){try{const{options:t}=e.getHandler(r);if(t.maxInboundStreams!=null)return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return i0}function GB(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??o0}function Zp(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}class YB{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;connectionCloseTimeout;constructor(e,t){this.components=e,this.connectionEncrypters=un({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(n=>{this.connectionEncrypters.set(n.protocol,n)}),this.streamMuxers=un({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(n=>{this.streamMuxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??zR,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??El,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??El,this.connectionCloseTimeout=t.connectionCloseTimeout??Xw,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new TR(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return ws([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let n=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),n=this.components.connectionManager.acceptIncomingConnection(e),!n)throw new PR("Connection denied");await Tt(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const n=e.remoteAddr.getComponents().findLast(o=>o.code===ce)?.value;let s;n!=null&&(s=yi(n),await Tt(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(n){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[n.name??"Error"]:!0}),n}}async _performUpgrade(e,t,n){let s=e,i,o,l,c;const d=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`;if(e.log=e.log.newScope(`${t}:${d}`),this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t),n?.skipProtection!==!0){const a=this.components.connectionProtector;a!=null&&(e.log("protecting the %s connection",t),s=await a.protect(s,n))}try{if(XB(n)){if(n.remotePeer==null)throw new pd(`${t} connection that skipped encryption must have a peer id`);c="native",i=n.remotePeer}else{const a=e.remoteAddr.getComponents().findLast(h=>h.code===ce)?.value;let u;a!=null&&(u=yi(a)),n?.onProgress?.(new nt(`upgrader:encrypt-${t}-connection`)),{connection:s,remotePeer:i,protocol:c,streamMuxer:o}=await(t==="inbound"?this._encryptInbound(s,{...n,remotePeer:u}):this._encryptOutbound(s,{...n,remotePeer:u}))}if(i.equals(this.components.peerId)){const a=new Nm("Can not dial self");throw e.abort(a),a}await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,e),n?.muxerFactory!=null?o=n.muxerFactory:o==null&&this.streamMuxers.size>0&&(n?.onProgress?.(new nt(`upgrader:multiplex-${t}-connection`)),o=await(t==="inbound"?this._multiplexInbound(s,this.streamMuxers,n):this._multiplexOutbound(s,this.streamMuxers,n)))}catch(a){throw e.log.error("failed to upgrade %s connection %s %a - %e",t,t==="inbound"?"from":"to",e.remoteAddr,a),a}o!=null&&(e.log("create muxer %s",o.protocol),l=o.createStreamMuxer(s)),await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e);const f=this._createConnection({id:d,cryptoProtocol:c,direction:t,maConn:e,stream:s,muxer:l,remotePeer:i,limits:n?.limits,closeTimeout:this.connectionCloseTimeout});return f.log("successfully upgraded connection"),f}_createConnection(e){const t=zB(this.components,{...e,outboundStreamProtocolNegotiationTimeout:this.outboundStreamProtocolNegotiationTimeout,inboundStreamProtocolNegotiationTimeout:this.inboundStreamProtocolNegotiationTimeout});return t.addEventListener("close",()=>{this.events.safeDispatchEvent("connection:close",{detail:t})}),this.events.safeDispatchEvent("connection:open",{detail:t}),t}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const s=await Hu(e,n,t),i=this.connectionEncrypters.get(s);if(i==null)throw new da(`no crypto module found for ${s}`);return e.log("encrypting inbound connection using %s",s),{...await i.secureInbound(e,t),protocol:s}}catch(s){throw new da(s.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const s=await qu(e,n,t),i=this.connectionEncrypters.get(s);if(i==null)throw new da(`no crypto module found for ${s}`);return e.log("encrypting outbound connection using %s",s),{...await i.secureOutbound(e,t),protocol:s}}catch(s){throw new da(s.message)}}async _multiplexOutbound(e,t,n){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const i=await qu(e,s,n),o=t.get(i);if(o==null)throw new wa(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),o}catch(i){throw e.log.error("error multiplexing outbound connection - %e",i),new wa(String(i))}}async _multiplexInbound(e,t,n){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{e.log.trace("selecting stream muxer from %s",s);const i=await Hu(e,s,n),o=t.get(i);if(o==null)throw new wa(`No muxer configured for protocol "${i}"`);return e.log("selected %s as muxer protocol",i),o}catch(i){throw e.log.error("error multiplexing inbound connection - %e",i),i}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}function XB(r){return r.skipEncryption===!0}const d0="3.1.2",f0="js-libp2p";function ZB(r,e){return`${r??f0}/${e??d0} browser/${globalThis.navigator.userAgent}`}class jB extends Dt{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new Dt,n=t.dispatchEvent.bind(t);t.dispatchEvent=d=>{const f=n(d),a=this.dispatchEvent(new CustomEvent(d.type,{detail:d.detail}));return f||a},this.peerId=e.peerId,this.logger=e.logger??cd(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??f0,i=e.nodeInfo?.version??d0,o=this.components=MR({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??ZB(s,i)},logger:this.logger,events:t,datastore:e.datastore??new PE,connectionGater:VR(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",fR(o,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),o.events.addEventListener("peer:update",d=>{if(d.detail.previous==null){const f={id:d.detail.peer.id,multiaddrs:d.detail.peer.addresses.map(a=>a.multiaddr)};o.events.safeDispatchEvent("peer:discovery",{detail:f})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(o)),this.components.upgrader=new YB(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((d,f)=>this.configureComponent(`connection-encryption-${f}`,d(this.components))),streamMuxers:(e.streamMuxers??[]).map((d,f)=>this.configureComponent(`stream-muxers-${f}`,d(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout,connectionCloseTimeout:e.connectionManager?.connectionCloseTimeout}),this.configureComponent("transportManager",new FB(this.components,e.transportManager)),this.configureComponent("connectionManager",new CB(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new BB(this.components,e.connectionMonitor)),this.configureComponent("registrar",new $B(this.components)),this.configureComponent("addressManager",new wR(this.components,e.addresses));const l=(e.peerRouters??[]).map((d,f)=>this.configureComponent(`peer-router-${f}`,d(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new MB(this.components,{routers:l}));const c=(e.contentRouters??[]).map((d,f)=>this.configureComponent(`content-router-${f}`,d(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new NB(this.components,{routers:c})),this.configureComponent("randomWalk",new OB(this.components)),(e.peerDiscovery??[]).forEach((d,f)=>{this.configureComponent(`peer-discovery-${f}`,d(this.components)).addEventListener("peer",u=>{this.#e(u)})}),e.transports?.forEach((d,f)=>{this.components.transportManager.add(this.configureComponent(`transport-${f}`,d(this.components)))}),e.services!=null)for(const d of Object.keys(e.services)){const f=e.services[d],a=f(this.components);if(a==null){this.log.error("service factory %s returned null or undefined instance",d);continue}this.services[d]=a,this.configureComponent(d,a),a[fh]!=null&&(this.log("registering service %s for content routing",d),c.push(a[fh])),a[mh]!=null&&(this.log("registering service %s for peer routing",d),l.push(a[mh])),a[Fa]!=null&&(this.log("registering service %s for peer discovery",d),a[Fa].addEventListener?.("peer",u=>{this.#e(u)}))}OR(o)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started with peer id %p",this.peerId)}catch(e){throw this.log.error("an error occurred starting libp2p - %e",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new ps;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,n={}){if(t==null)throw new V("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new V("no protocols were provided to open a stream");return this.components.connectionManager.openStream(e,t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Hl(e)&&(e=yi(e.getComponents().findLast(n=>n.code===ce)?.value??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e,t);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.name!=="NotFoundError")throw o}const n=an([j("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(n,t),i=zn(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async n=>{await this.components.registrar.unhandle(n,t)}))}async register(e,t,n){return this.components.registrar.register(e,t,n)}unregister(e){this.components.registrar.unregister(e)}use(e,t){this.components.registrar.use(e,Array.isArray(t)?t:[t])}unuse(e){this.components.registrar.unuse(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(n=>{this.log.error("could not update multiaddrs of discovered peer - %e",n)})}}async function QB(r={}){r.privateKey??=await Oy("Ed25519");const e=new jB({...await DL(r),peerId:IL(r.privateKey)});return r.start!==!1&&await e.start(),e}function h0(r){return r.toLowerCase().replace(/[^a-z0-9@&$!?\-+=.:/_]/g,"")}function jp(r){return r.replace(/[^a-z0-9./:_-]/gi,"")}function $c(r){try{const t=he(r).toString();return t.includes("/p2p/")?t:null}catch{return null}}async function p0(r={}){const{type:e,moves:t,playerName:n,timestamp:s,value:i}=r;if(!e||typeof e!="string")throw new Error(["RECORD VALIDATION: BAD TYPE!",r]);if(!t||!(Array.isArray(t)||typeof t=="string"))throw new Error(["RECORD VALIDATION: BAD MOVES!",r]);if(t.length>NS)throw new Error(["RECORD VALIDATION: MOVES TOO LONG!",r]);if(!n||typeof n!="string")throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",r]);if(h0(n)!==n)throw new Error(["RECORD VALIDATION: BAD PLAYER NAME!",r]);if(typeof s!="number"||!Number.isFinite(s))throw new Error(["RECORD VALIDATION: BAD TIMESTAMP!",r]);if(typeof i!="number"||!(i>0))throw new Error(["RECORD VALIDATION: BAD VALUE!",r]);return new Promise((o,l)=>{let c=null;const d=setTimeout(()=>{c&&c(),l(["RECORD VALIDATION: TIMEOUT!",r])},3e3),f=u=>(u.get=()=>Si(u),u),a=fm({cardsStore:f(ir(De.cards)),energyStore:f(ir(De.energy)),logStore:f(ir(De.log)),matchedIndexesStore:f(ir(De.matchedIndexes)),movesStore:f(Vi(t)),optionsStore:f(Vi({playerName:n,cluster:!1,rapid:!0})),phaseStore:f(ir(De.phase)),plusIndexStore:f(ir(De.plusIndex)),recordsStore:f(ir({...De.records})),scoreStore:f(ir(De.score)),seedStore:f(Vi(um(r))),timestampStore:f(Vi(s))});c=a.recordsStore.subscribe(u=>{const{movesInitial:h,phaseStore:p}=a;if(h!==null&&p.get()!==te.gameOver)return;clearTimeout(d),c&&c();const y=u[e][U.value];let g={type:e,moves:t,playerName:n,timestamp:s,value:i};y>=i?(g.value=y,o(g)):l(["RECORD VALIDATION: WRONG VALUE!",g,y])})})}let kn=-1,Re;const g0=new Set,_a=new Set,JB=await mx(U.leaderboard),Jl=Object.fromEntries(await Promise.all(Lo.map(async r=>[r,await JB(r,[])]))),Qt=new RS({recordTypes:Lo,maxRecords:at,debug:Bn,validateRecord:p0,onUpdate:(r,e)=>{Jl[r].set(e)}});async function m0(r){try{const e=tu(r);if(Bn&&console.log("handleRecordMessage:",e?.type,e?.playerName,e?.value),e){const t=await Qt.handleRecordWithValidation(e);Bn&&console.log("Record validation result:",t)}}catch(e){Bn&&console.error("handleRecordMessage error:",e)}}const eN=Qt.createPushPreview(m0),y0=Qt.createPushRoot(m0),tN=Qt.createRootHandler(eN),rN=Qt.createPreviewHandler();function nN(){const r=fd.get();return r.length===0?null:((kn===-1||kn>=r.length)&&(kn=Math.floor(Math.random()*r.length)),r[kn])}async function sN({detail:r}){const e=r.remotePeer.toString();if(Bn&&console.log("connection:open",e),g0.has(e)||r.status!=="open"||xi.get().some(s=>s.includes(e)))return;(await y0(r))?.error?.name==="UnsupportedProtocolError"&&r.close()}async function iN({detail:{from:r}}){if(Bn&&console.log("pubsub:message",r.toString(),r.equals(Re.peerId)?"local":"remote"),Re.getConnections(r).length>0)return;const e=r.toString();_a.has(e)||(_a.add(e),Re.dial(r).catch(()=>{}).finally(()=>{_a.delete(e)}))}async function oN(){if(Re?.status!=="started"||Re.getConnections().length>0)return;const r=xi.get();if(r.length!==0)return Bn&&console.log("restoreRelay"),kn=(kn+1)%r.length,Re.dial(he(r[kn])).catch(e=>{console.error("Failed to restore relay",e)})}async function b0(){Re&&await Re.stop();const r=new km("keystore");await r.open();const e=await nD(r);Re=await QB({privateKey:e,addresses:{listen:["/p2p-circuit"]},transports:[_L(),CP()],connectionEncrypters:[nL()],streamMuxers:[tT()],peerDiscovery:[CT({list:xi.get()}),fL({interval:13e3,topics:["digifall._peer-discovery"],listenOnly:!1})],connectionGater:{denyDialMultiaddr:()=>!1,denyDialPeer(t){const n=t.toString();return g0.has(n)||_a.has(n)||Re.getConnections().length>=3||Re.getConnections().some(({remotePeer:i,status:o})=>i.toString()===n&&o!=="closed")?!0:BS?!1:fd.get().includes(n)?n!==nN():!1},denyInboundConnection(){return Re.getConnections().length>=5}},services:{identify:YD({protocolPrefix:"digifall"}),pubsub:DD({emitSelf:!0}),keychain:jv()}}),Re.services.pubsub.addEventListener("message",iN),Re.addEventListener("connection:open",sN),Re.handle(Fs.root,tN,{runOnLimitedConnection:!0}),Re.handle(Fs.preview,rN,{runOnLimitedConnection:!0}),Bn&&(window.libp2p=Re),bt.get().leaderboard&&await Re.start()}setInterval(()=>oN().catch(()=>{}),73e3);const aN=v0(()=>{if(!Re)return;const r=fd.get();r.length!==0&&Re.getConnections().filter(({remotePeer:e,status:t})=>t==="open"&&!r.includes(e.toString())).forEach(y0)},5e3);Lo.forEach(r=>{const e=Jl[r];e.subscribe(async t=>{if(!(!t||t.length===0)){if(Qt.getData(r).length>0){const n=Qt.getRoots()[r];return Qt.updateRoot(r),n!==Qt.getRoots()[r]&&Re&&aN()}Promise.allSettled(t.map(n=>p0(n).then(s=>Qt.handleRecord(s)))).then(()=>e.set(Qt.getData(r)))}})});No.subscribe(r=>{const e=pn.get();e!==te.idle&&e!==te.gameOver||Lo.forEach(t=>{const n=r[t];n[U.value]!==0&&(n[U.type]=t,Qt.handleRecord(n),Jl[t].set(Qt.getData(t)))})});let Qp=!1;const lN=w0(()=>b0(),3e3);xi.subscribe(()=>{if(!Qp){Qp=!0,b0().catch(console.error);return}kn=-1,lN()});let Jp=bt.get().leaderboard;const cN=w0(async r=>{r&&Re&&Re.status!=="started"&&await Re.start(),!r&&Re&&Re.status==="started"&&await Re.stop()},3e3);bt.subscribe(({leaderboard:r})=>{r!==Jp&&(Jp=r,cN(r))});function v0(r,e){let t=0,n=null;return((...s)=>{const i=Date.now();if(i-t>=e)return t=i,clearTimeout(n),n=null,r(...s);clearTimeout(n),n=setTimeout(()=>{t=Date.now(),n=null,r(...s)},e-(i-t))})}function w0(r,e){let t;return((...n)=>{clearTimeout(t),t=setTimeout(()=>r(...n),e)})}var uN=se("<li> </li>"),dN=se('<div><div class="place svelte-fan1x6"> </div> <div> </div> <div></div> <div> </div></div>'),fN=se('<div class="leaderboard content"><div class="section-1"><div class="types svelte-fan1x6" title="[switch leaderboard]" tabindex="0" role="button"><span>combos</span> <span class="high svelte-fan1x6">high &gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span> <span>scores</span></div></div> <div class="section-2"><ul class="pages svelte-fan1x6" title="[select page]" tabindex="0" role="button"></ul></div> <div class="section-3 board svelte-fan1x6" tabindex="-1"><!></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>');function hN(r,e){ft(e,!0);const t=()=>fe(b(h),"$leaderboardStore",s),n=()=>fe(bt,"$optionsStore",s),[s,i]=tr(),o=100,l=Math.ceil(at/o)+1;let c=le(0),d=le(jr(U.highScore)),f=le(0),a=le(0),u=le(null),h=ie(()=>Jl[b(d)]),p=ie(()=>t().slice().sort((K,ee)=>id(ee,K)).slice(0,at)),y=ie(()=>[...b(p).map((K,ee)=>({place:ee===999?0:ee+1,...K})),...Array.from({length:at-b(p).length}).map((K,ee,ge)=>({place:ee===ge.length-1?0:ee+b(p).length+1,playerName:"",value:0}))]),g=ie(()=>b(p).findIndex(({playerName:K})=>K===n()[U.playerName])),m=ie(()=>b(u)?v0(b(u).scrollToIndex,250):()=>{});st(()=>{D(b(a))}),st(()=>{Q()});function w(K){X(d,b(d)===U.highScore?U.highCombo:U.highScore,!0)}function v(K){if(K)return X(c,b(c)<1?l-1:b(c)-1,!0),b(u).scrollToIndex(Math.max(b(c)*o-1,0)),b(c);b(m)(Math.max(b(f)-8,0),!0)}function _(K){if(K)return X(c,b(c)<l-1?b(c)+1:0,!0),b(u).scrollToIndex(Math.max(b(c)*o-1,0)),b(c);b(m)(Math.min(b(f)+8,at-1),!0)}function k(K){const ee=K.composedPath().find(({dataset:Me})=>Me&&Me.index);if(ee===void 0)return;X(c,Number(ee.dataset.index),!0);const ge=b(c)===0?0:b(c)===10?at-1:ee.dataset.index*100-1;b(u).scrollToIndex(ge)}function P(){Nt(Xe,de.menu)}function D(K){return K>=at-2?X(c,10):X(c,I(K),!0)}function I(K){return K>0&&K<at*.1?0:K>=100&&K<at*.2?1:K>=200&&K<at*.3?2:K>=300&&K<at*.4?3:K>=400&&K<at*.5?4:K>=500&&K<at*.6?5:K>=600&&K<at*.7?6:K>=700&&K<at*.8?7:K>=800&&K<at*.9?8:K>=900&&K<at?9:0}function x(K){return K===0&&b(g)===-1?"???":Array.from({length:3-K?.toString().length}).map(()=>"0").join("")+K}function B(K,ee){return ee===0&&b(g)===-1?n()[U.playerName]:K}function Q(){b(u).scrollToIndex(b(g)===-1?at-1:Math.max(b(g)-7,0))}var M={prevPage:v,nextPage:_},A=fN(),E=O(A),S=O(E);S.__click=w;var T=O(S);let C;var L=z(T,4);let R;var N=z(E,2),$=O(N);$.__click=k,Dn($,21,()=>Array.from({length:l}),ti,(K,ee,ge)=>{const Me=ie(()=>ge>9?0:ge);var tt=uN();let Oe;Ln(tt,"data-index",ge);let pt;var Ur=O(tt);Te(()=>{Oe=Ue(tt,1,"page svelte-fan1x6",null,Oe,{active:ge===b(c)}),pt=Ct(tt,"",pt,{"--color":`var(--color-${b(Me)??""})`}),He(Ur,b(Me))}),J(K,tt)});var q=z(N,2),F=O(q);Ze(Zx(F,{get items(){return b(y)},get startIndex(){return b(f)},set startIndex(ee){X(f,ee,!0)},get endIndex(){return b(a)},set endIndex(ee){X(a,ee,!0)},children:(ee,ge)=>{let Me=()=>ge?.().place,tt=()=>ge?.().playerName,Oe=()=>ge?.().value;const pt=ie(()=>tt()===n()[U.playerName]),Ur=ie(()=>"place: "+Me()+`
name: `+tt()?.toUpperCase()+`
score: `+Oe());var Y=dN(),oe=O(Y);let be;var gt=O(oe),nr=z(oe,2);let gr;var Gn=O(nr),Af=z(nr,2);let If;var kf=z(Af,2);let Cf;var S0=O(kf);Te((E0,x0,A0)=>{Ue(Y,1,Gg(["grid",{first:Me()===1,second:Me()===2,third:Me()===3}]),"svelte-fan1x6"),Ln(Y,"title",b(Ur)),be=Ct(oe,"",be,E0),He(gt,x0),gr=Ue(nr,1,"player-name svelte-fan1x6",null,gr,{self:b(pt)}),He(Gn,A0),If=Ue(Af,1,"bar svelte-fan1x6",null,If,{self:b(pt)}),Cf=Ue(kf,1,"record svelte-fan1x6",null,Cf,{self:b(pt)}),He(S0,Oe())},[()=>({color:`var(--color-${I(Me())??""})`}),()=>x(Me()),()=>B(tt(),Me())]),J(ee,Y)},$$slots:{default:!0}}),ee=>X(u,ee,!0),()=>b(u));var H=z(q,2),G=O(H),re=O(G);re.__click=P,Te(()=>{C=Ue(T,1,"type svelte-fan1x6",null,C,{active:b(d)===U.highCombo}),R=Ue(L,1,"type svelte-fan1x6",null,R,{active:b(d)===U.highScore})}),xe(5,S,()=>Ht,()=>({y:-48})),xe(1,re,()=>Ht,()=>({y:48})),xe(1,A,()=>Lr),J(r,A);var ne=ht(M);return i(),ne}$r(["click"]);var pN=se('<span class="title"> </span>'),gN=se('<div class="dialog content"><div class="section-1"><!></div> <div class="section-2"></div> <div class="section-3"><!></div> <div class="section-4"></div></div>');function xf(r,e){ft(e,!0);let t=Qr(e,"title",3,""),n=Qr(e,"visible",15,!1);function s(){n(!0)}function i(){n(!1)}var o={open:s,close:i},l=Yr(),c=rt(l);{var d=f=>{var a=gN(),u=O(a),h=O(u);{var p=m=>{var w=pN(),v=O(w);Te(()=>He(v,t())),xe(1,w,()=>Ht,()=>({y:-48})),J(m,w)};we(h,m=>{t()&&m(p)})}var y=z(u,4),g=O(y);qg(g,()=>e.children,()=>({visible:n(),open:s,close:i})),xe(1,y,()=>Ht,()=>({y:24})),xe(1,a,()=>Lr),J(f,a)};we(c,f=>{n()&&f(d)})}return J(r,l),ht(o)}const mN="0.13.0";var yN=se('<span class="rapid svelte-p9o308">rapid</span>'),bN=se('<button class="svelte-p9o308">new game</button>'),vN=se('<button class="svelte-p9o308">resume</button> <button class="svelte-p9o308">new game</button>',1),wN=se('<button class="svelte-p9o308">p2p leaderboard</button>'),_N=se('<div class="menu content svelte-p9o308"><div class="section-1 svelte-p9o308"><h1 class="svelte-p9o308">digifall <!></h1></div> <div class="section-2 svelte-p9o308"></div> <div class="section-3 svelte-p9o308"><div class="col svelte-p9o308"><!> <!> <button class="svelte-p9o308">options</button></div></div> <div class="section-4 svelte-p9o308"></div></div> <span class="version svelte-p9o308"> </span> <a href="https://github.com/llblab/digifall" class="github-corner svelte-p9o308" aria-label="View source on GitHub"><svg viewBox="0 0 250 250" aria-hidden="true" class="svelte-p9o308"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" class="svelte-p9o308"></path><path class="octo-arm svelte-p9o308" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor"></path><path class="octo-body svelte-p9o308" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor"></path></svg></a>',1),SN=se('<div class="col svelte-p9o308"><p class="svelte-p9o308">start a new game?</p> <div class="row svelte-p9o308"><button class="svelte-p9o308">yes</button> <button class="svelte-p9o308">no</button></div></div>'),EN=se("<!> <!>",1);function xN(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",s),n=()=>fe(pn,"$phaseStore",s),[s,i]=tr();let o=le(null),l=le(!1);st(()=>{t().playerName===""&&Nt(Xe,de.wellcome)});function c(){return b(o).visible}function d(){b(o).close()}function f(){Nt(Xe,null)}function a(){b(o).close(),hd()}function u(){Nt(Xe,de.leaderboard)}function h(){Nt(Xe,de.options)}var p={isNewGameDialog:c,closeNewGameDialog:d},y=EN(),g=rt(y);{var m=_=>{var k=_N(),P=rt(k),D=O(P),I=O(D),x=z(O(I));{var B=q=>{var F=yN();J(q,F)};we(x,q=>{t().rapid&&q(B)})}var Q=z(D,4),M=O(Q),A=O(M);{var E=q=>{var F=bN();F.__click=a,J(q,F)},S=q=>{var F=vN(),H=rt(F);H.__click=f;var G=z(H,2);G.__click=function(...re){b(o)?.open?.apply(this,re)},J(q,F)};we(A,q=>{n()===te.gameOver?q(E):q(S,!1)})}var T=z(A,2);{var C=q=>{var F=wN();F.__click=u,J(q,F)};we(T,q=>{t()[U.leaderboard]&&q(C)})}var L=z(T,2);L.__click=h;var R=z(P,2),N=O(R),$=z(R,2);Te(()=>He(N,mN)),xe(5,P,()=>Lr),xe(5,R,()=>Lr),xe(5,$,()=>Lr),J(_,k)};we(g,_=>{b(l)||_(m)})}var w=z(g,2);Ze(xf(w,{get visible(){return b(l)},set visible(_){X(l,_,!0)},children:(_,k)=>{var P=SN(),D=z(O(P),2),I=O(D);I.__click=a;var x=z(I,2);x.__click=function(...B){b(o).close?.apply(this,B)},J(_,P)},$$slots:{default:!0}}),_=>X(o,_,!0),()=>b(o)),J(r,y);var v=ht(p);return i(),v}$r(["click"]);var AN=se('<span class="symbols">a-z 0-9 @&$!?-+=.:/_</span> <input class="player-name" type="text" inputmode="url" placeholder="player name" spellcheck="false" maxlength="42"/>',1);function _0(r,e){ft(e,!0);let t=Qr(e,"value",15,""),n=le(null),s=le("hidden"),i=ie(()=>"player name: "+t().toUpperCase());st(()=>{t()===""&&b(n)?.focus()});function o(h){const p=h.target.value,y=h0(p);X(s,p===y?"hidden":"visible",!0),h.target.value=y,t(y)}function l(h=400){X(s,"hidden"),b(n)&&(b(n).classList.toggle("blink"),setTimeout(()=>b(n).classList.toggle("blink"),h))}var c={blink:l},d=AN(),f=rt(d);let a;var u=z(f,2);return u.__input=o,Ze(u,h=>X(n,h),()=>b(n)),Te(()=>{a=Ct(f,"",a,{visibility:b(s)}),Ln(u,"title",b(i)),Xc(u,t())}),J(r,d),ht(c)}$r(["input"]);var IN=se('<div class="options content"><div class="section-1"><span>options</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <input type="checkbox" id="rapid" class="svelte-awxzgh"/> <label for="rapid" tabindex="0" role="button" class="svelte-awxzgh">rapid mode</label> <input type="checkbox" id="sound" class="svelte-awxzgh"/> <label for="sound" tabindex="0" role="button" class="svelte-awxzgh">sound effects</label> <input type="checkbox" id="leaderboard" class="svelte-awxzgh"/> <label for="leaderboard" tabindex="0" role="button" class="svelte-awxzgh">p2p leaderboard</label> <button class="suboption svelte-awxzgh">relays</button></div></div> <div class="section-4"><div class="col"><button title="[open menu]">menu</button></div></div></div>'),kN=se('<div class="col exclam-fix"><p>new name detected!</p> <p>progress will be lost!</p> <div class="row"><button>accept</button> <button>reject</button></div></div>'),CN=se("<!> <!>",1);function TN(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",n),[n,s]=tr();let i=le(null),o=le(!1),l=le(null),c=ie(()=>t().playerName);function d(){return b(o)}function f(){b(i).close(),Nt(No,De.records),hd(b(c))}function a(){b(i).close(),X(c,t().playerName)}function u(){if(b(c)==="")return b(l).blink();if(b(c)!==t().playerName)return b(i).open();Nt(Xe,de.menu)}function h(){Nt(Xe,de.relays)}var p={isDialogVisible:d},y=CN(),g=rt(y);{var m=_=>{var k=IN(),P=O(k),D=O(P),I=z(P,4),x=O(I),B=O(x);Ze(_0(B,{get value(){return b(c)},set value($){X(c,$)}}),$=>X(l,$,!0),()=>b(l));var Q=z(B,2),M=z(Q,2),A=z(M,2);A.__click=()=>ha(bt,ct(t).sound=!t().sound,ct(t));var E=z(A,2),S=z(E,2),T=z(S,2),C=z(T,2);C.__click=h;var L=z(I,2),R=O(L),N=O(R);N.__click=u,Te(()=>{Ln(M,"title",`boring animations ${t().rapid?"disabled":"enabled"}`),t1(A,t().sound),Ln(E,"title",`making sounds ${t().sound?"enabled":"disabled"}`),Ln(T,"title",`sharing records ${t().leaderboard?"enabled":"disabled"}`),C.disabled=!t().leaderboard}),xe(5,D,()=>Ht,()=>({y:-48})),Vf(Q,()=>t().rapid,$=>ha(bt,ct(t).rapid=$,ct(t))),Vf(S,()=>t().leaderboard,$=>ha(bt,ct(t).leaderboard=$,ct(t))),xe(5,C,()=>Ht,()=>({x:20})),xe(5,I,()=>Ht,()=>({y:24})),xe(5,N,()=>Ht,()=>({y:48})),xe(5,k,()=>Lr),J(_,k)};we(g,_=>{b(o)||_(m)})}var w=z(g,2);Ze(xf(w,{get title(){return b(c)},get visible(){return b(o)},set visible(_){X(o,_,!0)},children:(_,k)=>{var P=kN(),D=z(O(P),4),I=O(D);I.__click=f;var x=z(I,2);x.__click=a,J(_,P)},$$slots:{default:!0}}),_=>X(i,_,!0),()=>b(i)),J(r,y);var v=ht(p);return s(),v}$r(["click"]);var PN=se('<span class="error-msg svelte-16oz979"> </span>'),DN=se('<div class="relay-row svelte-16oz979"><div class="textarea-wrap svelte-16oz979"><textarea rows="3"></textarea> <!></div> <button class="remove-btn svelte-16oz979" title="remove"><span class="icon-remove svelte-16oz979">+</span></button></div>'),LN=se('<span class="error-msg svelte-16oz979"> </span>'),RN=se('<div class="relays content"><div class="section-1"><span>relays</span></div> <div class="section-2"></div> <div class="section-3"><div class="col"><div class="list svelte-16oz979"><!> <div class="relay-row new-row svelte-16oz979"><div class="textarea-wrap svelte-16oz979"><textarea placeholder="/dns4/example.com/tcp/443/wss/p2p/12D3KooW..." rows="3"></textarea> <!></div> <button class="add-btn svelte-16oz979" title="add relay">+</button></div></div></div></div> <div class="section-4 svelte-16oz979"><div class="row svelte-16oz979"><button title="[reset relays]">reset</button> <button title="[options]">back</button></div></div></div>');function BN(r,e){ft(e,!0);const t=()=>fe(xi,"$activeRelaysStore",n),[n,s]=tr();let i=le(jr([...t()])),o=le("");const l=F=>{const H=F.trim();return H?$c(H)?"":"invalid multiaddr":""};let c=ie(()=>b(i).map(l)),d=ie(()=>l(b(o)));st(()=>{X(i,[...t()],!0)});function f(F){pu.update(H=>({...H,active:F(H.active)}))}function a(){pu.set({active:[...ri],applied:[...ri]})}function u(F,H){const G=jp(F.target.value);F.target.value=G,b(i)[H]=G}function h(F){const H=jp(F.target.value);F.target.value=H,X(o,H,!0)}function p(F){const H=b(i)[F].trim();if(!H){f(re=>re.filter((ne,K)=>K!==F));return}if(b(c)[F])return;const G=$c(H);G!==t()[F]&&f(re=>re.map((ne,K)=>K===F?G:ne))}function y(){const F=b(o).trim();if(!F||b(d))return;const H=$c(F);f(G=>[...G,H]),X(o,"")}function g(F){f(H=>H.filter((G,re)=>re!==F))}function m(){const F=document.activeElement;if(F?.tagName!=="TEXTAREA")return;const H=F.closest(".relay-row"),G=Array.from(document.querySelectorAll(".relays .relay-row")),re=G.indexOf(H);re!==-1&&(re===G.length-1?y():p(re))}function w(){Nt(Xe,de.options)}var v={saveCurrentRelay:m},_=RN(),k=O(_),P=O(k),D=z(k,4),I=O(D),x=O(I),B=O(x);Dn(B,17,()=>b(i),ti,(F,H,G)=>{var re=DN(),ne=O(re),K=O(ne);K.__input=Oe=>u(Oe,G);let ee;var ge=z(K,2);{var Me=Oe=>{var pt=PN(),Ur=O(pt);Te(()=>He(Ur,b(c)[G])),J(Oe,pt)};we(ge,Oe=>{b(c)[G]&&Oe(Me)})}var tt=z(ne,2);tt.__click=()=>g(G),Te(Oe=>{Xc(K,b(H)),ee=Ue(K,1,"svelte-16oz979",null,ee,Oe)},[()=>({error:b(c)[G],valid:!b(c)[G]&&b(H).trim()})]),_r("blur",K,()=>p(G)),J(F,re)});var Q=z(B,2),M=O(Q),A=O(M);A.__input=h;let E;var S=z(A,2);{var T=F=>{var H=LN(),G=O(H);Te(()=>He(G,b(d))),J(F,H)};we(S,F=>{b(d)&&F(T)})}var C=z(M,2);C.__click=y;var L=z(D,2),R=O(L),N=O(R);N.__click=a;var $=z(N,2);$.__click=w,Te(F=>{Xc(A,b(o)),E=Ue(A,1,"svelte-16oz979",null,E,F)},[()=>({error:b(d),valid:!b(d)&&b(o).trim()})]),xe(5,P,()=>Ht,()=>({y:-48})),xe(5,D,()=>Ht,()=>({y:24})),xe(5,N,()=>Ht,()=>({y:48})),xe(5,$,()=>Ht,()=>({y:48})),xe(5,_,()=>Lr),J(r,_);var q=ht(v);return s(),q}$r(["input","click"]);var NN=se('<form class="wellcome content"><div class="section-1"><h1>digifall</h1></div> <div class="section-2"></div> <div class="section-3"><div class="col"><!> <button type="submit">start</button></div></div> <div class="section-4"></div></form>'),MN=se(`<div class="col"><p>Game doesn't contain tutorial mode!</p> <p>Target: understand how to play it</p> <button>continue</button></div>`),ON=se("<!> <!>",1);function $N(r,e){ft(e,!0);const t=()=>fe(bt,"$optionsStore",n),[n,s]=tr();let i=ie(()=>null),o=ie(()=>!0),l=ie(()=>null),c=ie(()=>t().playerName);function d(){b(c)!==t().playerName&&(ha(bt,ct(t).playerName=b(c),ct(t)),Nt(dd,Date.now()))}function f(y){if(y.preventDefault(),b(c)==="")return b(l).blink();Nt(Xe,null)}var a=ON(),u=rt(a);{var h=y=>{var g=NN();g.__input=d;var m=z(O(g),4),w=O(m),v=O(w);Ze(_0(v,{get value(){return b(c)},set value(_){X(c,_)}}),_=>X(l,_),()=>b(l)),_r("submit",g,f),xe(5,g,()=>Lr),J(y,g)};we(u,y=>{b(o)||y(h)})}var p=z(u,2);Ze(xf(p,{title:"heads up!",get visible(){return b(o)},set visible(y){X(o,y)},children:(y,g)=>{var m=MN(),w=z(O(m),4);w.__click=function(...v){b(i).close?.apply(this,v)},J(y,m)},$$slots:{default:!0}}),y=>X(i,y),()=>b(i)),J(r,a),ht(),s()}$r(["input","click"]);var FN=se('<div class="overlay"><!></div>');function UN(r,e){ft(e,!0);const t=()=>fe(Xe,"$overlayStore",s),n=()=>fe(pn,"$phaseStore",s),[s,i]=tr();let o=le(null),l=le(null),c=le(null),d=le(null),f=le(null),a=le(null);async function u(){if(await L_(),b(l)&&b(l).isNewGameDialog())return b(l).closeNewGameDialog();Nt(Xe,currentOverlay===null||currentOverlay===de.leaderboard||currentOverlay===de.options||currentOverlay===de.relays?de.menu:null)}function h(){if(t()===de.relays)return k()?void 0:D(-2);P(-1)}function p(){if(t()===de.relays)return k()?void 0:D(2);P(1)}function y(){if(t()===de.relays)return k()?void 0:D(-1);if(t()===de.leaderboard)return b(a)?b(a).classList.contains("types")?b(a).click():b(o).prevPage(b(a).classList.contains("pages")):void 0;(t()!==de.options||b(c).isDialogVisible())&&P(-1)}function g(){if(t()===de.relays)return k()?void 0:D(1);if(t()===de.leaderboard)return b(a)?b(a).classList.contains("types")?b(a).click():b(o).nextPage(b(a).classList.contains("pages")):void 0;(t()!==de.options||b(c).isDialogVisible())&&P(-1)}function m(){if(t()===de.relays&&b(a)?.tagName==="TEXTAREA"){k()?(b(d)?.saveCurrentRelay(),b(a).blur()):b(a).focus();return}b(a)&&(b(f)&&b(f).isFocused()?b(f).nextType():b(a).classList.contains("focus")&&b(a).click())}function w(){if(b(a)&&b(a).blur(),t()===de.options||t()===de.leaderboard||t()===de.gameOver)return Xe.set(de.menu);if(t()===de.relays)return Xe.set(de.options);if(t()===de.menu&&n()!==te.gameOver)return Xe.set(null)}function v({node:A,selectors:E,shift:S=0}={}){if(!E||E.length<1)return;const T=E.map(N=>".overlay "+N).join(", "),C=Array.from(document.querySelectorAll(T));if(!A)return S<0?C[C.length+S]:C[0];if(S===0)return A;const L=C.indexOf(A);if(L===-1)return S<0?C[C.length+S]:C[0];let R=L+S;return R<0&&(R=C.length+R),R>C.length-1&&(R=R-C.length),C[R]}function _(A,E=!1){if(A){if(b(f)&&b(f).isFocused()&&b(f).blur(),b(a)&&(b(a).classList.remove("focus"),b(a).blur()),A.classList.contains("score"))return b(f)&&b(f).focus();X(a,A,!0),b(a).classList.add("focus"),E||b(a).focus()}}function k(){return b(a)?.tagName==="TEXTAREA"&&document.activeElement===b(a)}function P(A){const E=["button:not(.digifall)","[role='button']","input:not([type='checkbox'])","[tabindex='-1']"],S=E.map(L=>".overlay "+L+".focus").join(", "),T=document.querySelector(S),C=v({node:T,selectors:E,shift:A});_(C)}function D(A){const E=["textarea","button:not(.digifall)"],S=E.map(R=>".overlay "+R+".focus").join(", "),T=document.querySelector(S),C=v({node:T,selectors:E,shift:A}),L=C?.tagName==="TEXTAREA";_(C,L)}var I={switchOverlay:u,moveUp:h,moveDown:p,moveLeft:y,moveRight:g,perfomAction:m,blur:w},x=Yr(),B=rt(x);{var Q=A=>{var E=FN(),S=O(E);{var T=L=>{Gx(L,{get scoreComponent(){return b(f)},set scoreComponent(R){X(f,R,!0)}})},C=L=>{var R=Yr(),N=rt(R);{var $=F=>{Ze(hN(F,{}),H=>X(o,H,!0),()=>b(o))},q=F=>{var H=Yr(),G=rt(H);{var re=K=>{Ze(xN(K,{}),ee=>X(l,ee,!0),()=>b(l))},ne=K=>{var ee=Yr(),ge=rt(ee);{var Me=Oe=>{Ze(TN(Oe,{}),pt=>X(c,pt,!0),()=>b(c))},tt=Oe=>{var pt=Yr(),Ur=rt(pt);{var Y=be=>{Ze(BN(be,{}),gt=>X(d,gt,!0),()=>b(d))},oe=be=>{var gt=Yr(),nr=rt(gt);{var gr=Gn=>{$N(Gn,{})};we(nr,Gn=>{t()===de.wellcome&&Gn(gr)},!0)}J(be,gt)};we(Ur,be=>{t()===de.relays?be(Y):be(oe,!1)},!0)}J(Oe,pt)};we(ge,Oe=>{t()===de.options?Oe(Me):Oe(tt,!1)},!0)}J(K,ee)};we(G,K=>{t()===de.menu?K(re):K(ne,!1)},!0)}J(F,H)};we(N,F=>{t()===de.leaderboard?F($):F(q,!1)},!0)}J(L,R)};we(S,L=>{t()===de.gameOver?L(T):L(C,!1)})}xe(3,E,()=>ga,()=>({duration:200})),J(A,E)};we(B,A=>{t()&&A(Q)})}J(r,x);var M=ht(I);return i(),M}var VN=se('<div class="app"><!> <!></div>');function KN(r,e){ft(e,!0);const t=()=>fe(pn,"$phaseStore",o),n=()=>fe(Xe,"$overlayStore",o),s=()=>fe(Bl,"$energyStore",o),i=()=>fe(Mo,"$seedStore",o),[o,l]=tr();let c=le(null),d=le(null);st(()=>{Jf>0&&setTimeout(()=>location=location,Jf*1e3)}),st(()=>{t()===te.gameOver&&Nt(Xe,de.gameOver)}),st(()=>{document.documentElement.classList[s().value>100||t()===te.extra||t()===te.combo||n()===de.leaderboard||n()===de.gameOver?"add":"remove"]("random-color")});function f(g){const m=n()===null?b(c):b(d);switch(g.code){case"Escape":return g.preventDefault(),m.blur();case"Tab":return g.preventDefault(),!i()||n()===de.wellcome||n()===de.gameOver?void 0:b(d).switchOverlay();case"ArrowUp":return m.moveUp();case"ArrowDown":return m.moveDown();case"ArrowLeft":return m.moveLeft();case"ArrowRight":return m.moveRight();case"Enter":case"Space":return g.preventDefault(),m.perfomAction();case"KeyF":case"KeyJ":return m.perfomAction()}}function a(){document.hasFocus()||(document.location=document.location)}function u(){const{style:g,offsetHeight:m,offsetWidth:w}=document.documentElement,k=m/w<1.5?m/192:w/128,P=k%.25;g.setProperty("font-size",k-P+"px")}var h=VN();_r("keydown",jn,f),_r("storage",jn,a),_r("resize",jn,u),_r("visibilitychange",jn,u),zg(jn,g=>u?.());var p=O(h);Ze(Kx(p,{}),g=>X(c,g,!0),()=>b(c));var y=z(p,2);Ze(UN(y,{}),g=>X(d,g,!0),()=>b(d)),J(r,h),ht(),l()}fm(bs,vE);F_(KN,{target:document.body});
